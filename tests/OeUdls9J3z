#! /bin/sh
# Generated from testsuite.at by GNU Autoconf 2.71.
#
# Copyright (C) 2009-2017, 2020-2021 Free Software Foundation, Inc.
#
# This test suite is free software; the Free Software Foundation gives
# unlimited permission to copy, distribute and modify it.
#
# Copyright (c) 2009, 2010, 2011, 2012, 2013, 2014, 2015 Nicira, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at:
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
## -------------------- ##
## M4sh Initialization. ##
## -------------------- ##

# Be more Bourne compatible
DUALCASE=1; export DUALCASE # for MKS sh
as_nop=:
if test ${ZSH_VERSION+y} && (emulate sh) >/dev/null 2>&1
then :
  emulate sh
  NULLCMD=:
  # Pre-4.2 versions of Zsh do word splitting on ${1+"$@"}, which
  # is contrary to our usage.  Disable this feature.
  alias -g '${1+"$@"}'='"$@"'
  setopt NO_GLOB_SUBST
else $as_nop
  case `(set -o) 2>/dev/null` in #(
  *posix*) :
    set -o posix ;; #(
  *) :
     ;;
esac
fi



# Reset variables that may have inherited troublesome values from
# the environment.

# IFS needs to be set, to space, tab, and newline, in precisely that order.
# (If _AS_PATH_WALK were called with IFS unset, it would have the
# side effect of setting IFS to empty, thus disabling word splitting.)
# Quoting is to prevent editors from complaining about space-tab.
as_nl='
'
export as_nl
IFS=" ""	$as_nl"

PS1='$ '
PS2='> '
PS4='+ '

# Ensure predictable behavior from utilities with locale-dependent output.
LC_ALL=C
export LC_ALL
LANGUAGE=C
export LANGUAGE

# We cannot yet rely on "unset" to work, but we need these variables
# to be unset--not just set to an empty or harmless value--now, to
# avoid bugs in old shells (e.g. pre-3.0 UWIN ksh).  This construct
# also avoids known problems related to "unset" and subshell syntax
# in other old shells (e.g. bash 2.01 and pdksh 5.2.14).
for as_var in BASH_ENV ENV MAIL MAILPATH CDPATH
do eval test \${$as_var+y} \
  && ( (unset $as_var) || exit 1) >/dev/null 2>&1 && unset $as_var || :
done

# Ensure that fds 0, 1, and 2 are open.
if (exec 3>&0) 2>/dev/null; then :; else exec 0</dev/null; fi
if (exec 3>&1) 2>/dev/null; then :; else exec 1>/dev/null; fi
if (exec 3>&2)            ; then :; else exec 2>/dev/null; fi

# The user is always right.
if ${PATH_SEPARATOR+false} :; then
  PATH_SEPARATOR=:
  (PATH='/bin;/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 && {
    (PATH='/bin:/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 ||
      PATH_SEPARATOR=';'
  }
fi


# Find who we are.  Look in the path if we contain no directory separator.
as_myself=
case $0 in #((
  *[\\/]* ) as_myself=$0 ;;
  *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
for as_dir in $PATH
do
  IFS=$as_save_IFS
  case $as_dir in #(((
    '') as_dir=./ ;;
    */) ;;
    *) as_dir=$as_dir/ ;;
  esac
    test -r "$as_dir$0" && as_myself=$as_dir$0 && break
  done
IFS=$as_save_IFS

     ;;
esac
# We did not find ourselves, most probably we were run as `sh COMMAND'
# in which case we are not to be found in the path.
if test "x$as_myself" = x; then
  as_myself=$0
fi
if test ! -f "$as_myself"; then
  printf "%s\n" "$as_myself: error: cannot find myself; rerun with an absolute file name" >&2
  exit 1
fi


if test "x$CONFIG_SHELL" = x; then
  as_bourne_compatible="as_nop=:
if test \${ZSH_VERSION+y} && (emulate sh) >/dev/null 2>&1
then :
  emulate sh
  NULLCMD=:
  # Pre-4.2 versions of Zsh do word splitting on \${1+\"\$@\"}, which
  # is contrary to our usage.  Disable this feature.
  alias -g '\${1+\"\$@\"}'='\"\$@\"'
  setopt NO_GLOB_SUBST
else \$as_nop
  case \`(set -o) 2>/dev/null\` in #(
  *posix*) :
    set -o posix ;; #(
  *) :
     ;;
esac
fi
"
  as_required="as_fn_return () { (exit \$1); }
as_fn_success () { as_fn_return 0; }
as_fn_failure () { as_fn_return 1; }
as_fn_ret_success () { return 0; }
as_fn_ret_failure () { return 1; }

exitcode=0
as_fn_success || { exitcode=1; echo as_fn_success failed.; }
as_fn_failure && { exitcode=1; echo as_fn_failure succeeded.; }
as_fn_ret_success || { exitcode=1; echo as_fn_ret_success failed.; }
as_fn_ret_failure && { exitcode=1; echo as_fn_ret_failure succeeded.; }
if ( set x; as_fn_ret_success y && test x = \"\$1\" )
then :

else \$as_nop
  exitcode=1; echo positional parameters were not saved.
fi
test x\$exitcode = x0 || exit 1
blah=\$(echo \$(echo blah))
test x\"\$blah\" = xblah || exit 1
test -x / || exit 1"
  as_suggested="  as_lineno_1=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_1a=\$LINENO
  as_lineno_2=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_2a=\$LINENO
  eval 'test \"x\$as_lineno_1'\$as_run'\" != \"x\$as_lineno_2'\$as_run'\" &&
  test \"x\`expr \$as_lineno_1'\$as_run' + 1\`\" = \"x\$as_lineno_2'\$as_run'\"' || exit 1
test \$(( 1 + 1 )) = 2 || exit 1"
  if (eval "$as_required") 2>/dev/null
then :
  as_have_required=yes
else $as_nop
  as_have_required=no
fi
  if test x$as_have_required = xyes && (eval "$as_suggested") 2>/dev/null
then :

else $as_nop
  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
as_found=false
for as_dir in /bin$PATH_SEPARATOR/usr/bin$PATH_SEPARATOR$PATH
do
  IFS=$as_save_IFS
  case $as_dir in #(((
    '') as_dir=./ ;;
    */) ;;
    *) as_dir=$as_dir/ ;;
  esac
  as_found=:
  case $as_dir in #(
	 /*)
	   for as_base in sh bash ksh sh5; do
	     # Try only shells that exist, to save several forks.
	     as_shell=$as_dir$as_base
	     if { test -f "$as_shell" || test -f "$as_shell.exe"; } &&
		    as_run=a "$as_shell" -c "$as_bourne_compatible""$as_required" 2>/dev/null
then :
  CONFIG_SHELL=$as_shell as_have_required=yes
		   if as_run=a "$as_shell" -c "$as_bourne_compatible""$as_suggested" 2>/dev/null
then :
  break 2
fi
fi
	   done;;
       esac
  as_found=false
done
IFS=$as_save_IFS
if $as_found
then :

else $as_nop
  if { test -f "$SHELL" || test -f "$SHELL.exe"; } &&
	      as_run=a "$SHELL" -c "$as_bourne_compatible""$as_required" 2>/dev/null
then :
  CONFIG_SHELL=$SHELL as_have_required=yes
fi
fi


      if test "x$CONFIG_SHELL" != x
then :
  export CONFIG_SHELL
             # We cannot yet assume a decent shell, so we have to provide a
# neutralization value for shells without unset; and this also
# works around shells that cannot unset nonexistent variables.
# Preserve -v and -x to the replacement shell.
BASH_ENV=/dev/null
ENV=/dev/null
(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
case $- in # ((((
  *v*x* | *x*v* ) as_opts=-vx ;;
  *v* ) as_opts=-v ;;
  *x* ) as_opts=-x ;;
  * ) as_opts= ;;
esac
exec $CONFIG_SHELL $as_opts "$as_myself" ${1+"$@"}
# Admittedly, this is quite paranoid, since all the known shells bail
# out after a failed `exec'.
printf "%s\n" "$0: could not re-execute with $CONFIG_SHELL" >&2
exit 255
fi

    if test x$as_have_required = xno
then :
  printf "%s\n" "$0: This script requires a shell more modern than all"
  printf "%s\n" "$0: the shells that I found on your system."
  if test ${ZSH_VERSION+y} ; then
    printf "%s\n" "$0: In particular, zsh $ZSH_VERSION has bugs and should"
    printf "%s\n" "$0: be upgraded to zsh 4.3.4 or later."
  else
    printf "%s\n" "$0: Please tell bug-autoconf@gnu.org about your system,
$0: including any error possibly output before this
$0: message. Then install a modern shell, or manually run
$0: the script under such a shell if you do have one."
  fi
  exit 1
fi
fi
fi
SHELL=${CONFIG_SHELL-/bin/sh}
export SHELL
# Unset more variables known to interfere with behavior of common tools.
CLICOLOR_FORCE= GREP_OPTIONS=
unset CLICOLOR_FORCE GREP_OPTIONS

## --------------------- ##
## M4sh Shell Functions. ##
## --------------------- ##
# as_fn_unset VAR
# ---------------
# Portably unset VAR.
as_fn_unset ()
{
  { eval $1=; unset $1;}
}
as_unset=as_fn_unset


# as_fn_set_status STATUS
# -----------------------
# Set $? to STATUS, without forking.
as_fn_set_status ()
{
  return $1
} # as_fn_set_status

# as_fn_exit STATUS
# -----------------
# Exit the shell with STATUS, even in a "trap 0" or "set -e" context.
as_fn_exit ()
{
  set +e
  as_fn_set_status $1
  exit $1
} # as_fn_exit
# as_fn_nop
# ---------
# Do nothing but, unlike ":", preserve the value of $?.
as_fn_nop ()
{
  return $?
}
as_nop=as_fn_nop

# as_fn_mkdir_p
# -------------
# Create "$as_dir" as a directory, including parents if necessary.
as_fn_mkdir_p ()
{

  case $as_dir in #(
  -*) as_dir=./$as_dir;;
  esac
  test -d "$as_dir" || eval $as_mkdir_p || {
    as_dirs=
    while :; do
      case $as_dir in #(
      *\'*) as_qdir=`printf "%s\n" "$as_dir" | sed "s/'/'\\\\\\\\''/g"`;; #'(
      *) as_qdir=$as_dir;;
      esac
      as_dirs="'$as_qdir' $as_dirs"
      as_dir=`$as_dirname -- "$as_dir" ||
$as_expr X"$as_dir" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
	 X"$as_dir" : 'X\(//\)[^/]' \| \
	 X"$as_dir" : 'X\(//\)$' \| \
	 X"$as_dir" : 'X\(/\)' \| . 2>/dev/null ||
printf "%s\n" X"$as_dir" |
    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
	    s//\1/
	    q
	  }
	  /^X\(\/\/\)[^/].*/{
	    s//\1/
	    q
	  }
	  /^X\(\/\/\)$/{
	    s//\1/
	    q
	  }
	  /^X\(\/\).*/{
	    s//\1/
	    q
	  }
	  s/.*/./; q'`
      test -d "$as_dir" && break
    done
    test -z "$as_dirs" || eval "mkdir $as_dirs"
  } || test -d "$as_dir" || as_fn_error $? "cannot create directory $as_dir"


} # as_fn_mkdir_p

# as_fn_executable_p FILE
# -----------------------
# Test if FILE is an executable regular file.
as_fn_executable_p ()
{
  test -f "$1" && test -x "$1"
} # as_fn_executable_p
# as_fn_append VAR VALUE
# ----------------------
# Append the text in VALUE to the end of the definition contained in VAR. Take
# advantage of any shell optimizations that allow amortized linear growth over
# repeated appends, instead of the typical quadratic growth present in naive
# implementations.
if (eval "as_var=1; as_var+=2; test x\$as_var = x12") 2>/dev/null
then :
  eval 'as_fn_append ()
  {
    eval $1+=\$2
  }'
else $as_nop
  as_fn_append ()
  {
    eval $1=\$$1\$2
  }
fi # as_fn_append

# as_fn_arith ARG...
# ------------------
# Perform arithmetic evaluation on the ARGs, and store the result in the
# global $as_val. Take advantage of shells that can avoid forks. The arguments
# must be portable across $(()) and expr.
if (eval "test \$(( 1 + 1 )) = 2") 2>/dev/null
then :
  eval 'as_fn_arith ()
  {
    as_val=$(( $* ))
  }'
else $as_nop
  as_fn_arith ()
  {
    as_val=`expr "$@" || test $? -eq 1`
  }
fi # as_fn_arith


# as_fn_error STATUS ERROR [LINENO LOG_FD]
# ----------------------------------------
# Output "`basename $0`: error: ERROR" to stderr. If LINENO and LOG_FD are
# provided, also output the error to LOG_FD, referencing LINENO. Then exit the
# script with STATUS, using 1 if that was 0.
as_fn_error ()
{
  as_status=$1; test $as_status -eq 0 && as_status=1
  if test "$4"; then
    as_lineno=${as_lineno-"$3"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
    printf "%s\n" "$as_me:${as_lineno-$LINENO}: error: $2" >&$4
  fi
  printf "%s\n" "$as_me: error: $2" >&2
  as_fn_exit $as_status
} # as_fn_error

if expr a : '\(a\)' >/dev/null 2>&1 &&
   test "X`expr 00001 : '.*\(...\)'`" = X001; then
  as_expr=expr
else
  as_expr=false
fi

if (basename -- /) >/dev/null 2>&1 && test "X`basename -- / 2>&1`" = "X/"; then
  as_basename=basename
else
  as_basename=false
fi

as_me=`$as_basename -- "$0" ||
$as_expr X/"$0" : '.*/\([^/][^/]*\)/*$' \| \
	 X"$0" : 'X\(//\)$' \| \
	 X"$0" : 'X\(/\)' \| . 2>/dev/null ||
printf "%s\n" X/"$0" |
    sed '/^.*\/\([^/][^/]*\)\/*$/{
	    s//\1/
	    q
	  }
	  /^X\/\(\/\/\)$/{
	    s//\1/
	    q
	  }
	  /^X\/\(\/\).*/{
	    s//\1/
	    q
	  }
	  s/.*/./; q'`

if (as_dir=`dirname -- /` && test "X$as_dir" = X/) >/dev/null 2>&1; then
  as_dirname=dirname
else
  as_dirname=false
fi

# Avoid depending upon Character Ranges.
as_cr_letters='abcdefghijklmnopqrstuvwxyz'
as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
as_cr_Letters=$as_cr_letters$as_cr_LETTERS
as_cr_digits='0123456789'
as_cr_alnum=$as_cr_Letters$as_cr_digits


  as_lineno_1=$LINENO as_lineno_1a=$LINENO
  as_lineno_2=$LINENO as_lineno_2a=$LINENO
  eval 'test "x$as_lineno_1'$as_run'" != "x$as_lineno_2'$as_run'" &&
  test "x`expr $as_lineno_1'$as_run' + 1`" = "x$as_lineno_2'$as_run'"' || {
  # Blame Lee E. McMahon (1931-1989) for sed's syntax.  :-)
  sed -n '
    p
    /[$]LINENO/=
  ' <$as_myself |
    sed '
      s/[$]LINENO.*/&-/
      t lineno
      b
      :lineno
      N
      :loop
      s/[$]LINENO\([^'$as_cr_alnum'_].*\n\)\(.*\)/\2\1\2/
      t loop
      s/-\n.*//
    ' >$as_me.lineno &&
  chmod +x "$as_me.lineno" ||
    { printf "%s\n" "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2; as_fn_exit 1; }

  # If we had to re-execute with $CONFIG_SHELL, we're ensured to have
  # already done that, so ensure we don't try to do so again and fall
  # in an infinite loop.  This has already happened in practice.
  _as_can_reexec=no; export _as_can_reexec
  # Don't try to exec as it changes $[0], causing all sort of problems
  # (the dirname of $[0] is not the place where we might find the
  # original and so on.  Autoconf is especially sensitive to this).
  . "./$as_me.lineno"
  # Exit status is that of the last command.
  exit
}


# Determine whether it's possible to make 'echo' print without a newline.
# These variables are no longer used directly by Autoconf, but are AC_SUBSTed
# for compatibility with existing Makefiles.
ECHO_C= ECHO_N= ECHO_T=
case `echo -n x` in #(((((
-n*)
  case `echo 'xy\c'` in
  *c*) ECHO_T='	';;	# ECHO_T is single tab character.
  xy)  ECHO_C='\c';;
  *)   echo `echo ksh88 bug on AIX 6.1` > /dev/null
       ECHO_T='	';;
  esac;;
*)
  ECHO_N='-n';;
esac

# For backward compatibility with old third-party macros, we provide
# the shell variables $as_echo and $as_echo_n.  New code should use
# AS_ECHO(["message"]) and AS_ECHO_N(["message"]), respectively.
as_echo='printf %s\n'
as_echo_n='printf %s'


rm -f conf$$ conf$$.exe conf$$.file
if test -d conf$$.dir; then
  rm -f conf$$.dir/conf$$.file
else
  rm -f conf$$.dir
  mkdir conf$$.dir 2>/dev/null
fi
if (echo >conf$$.file) 2>/dev/null; then
  if ln -s conf$$.file conf$$ 2>/dev/null; then
    as_ln_s='ln -s'
    # ... but there are two gotchas:
    # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
    # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
    # In both cases, we have to default to `cp -pR'.
    ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
      as_ln_s='cp -pR'
  elif ln conf$$.file conf$$ 2>/dev/null; then
    as_ln_s=ln
  else
    as_ln_s='cp -pR'
  fi
else
  as_ln_s='cp -pR'
fi
rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
rmdir conf$$.dir 2>/dev/null

if mkdir -p . 2>/dev/null; then
  as_mkdir_p='mkdir -p "$as_dir"'
else
  test -d ./-p && rmdir ./-p
  as_mkdir_p=false
fi

as_test_x='test -x'
as_executable_p=as_fn_executable_p

# Sed expression to map a string onto a valid CPP name.
as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"

# Sed expression to map a string onto a valid variable name.
as_tr_sh="eval sed 'y%*+%pp%;s%[^_$as_cr_alnum]%_%g'"





SHELL=${CONFIG_SHELL-/bin/sh}

# How were we run?
at_cli_args="$@"


# Not all shells have the 'times' builtin; the subshell is needed to make
# sure we discard the 'times: not found' message from the shell.
at_times_p=false
(times) >/dev/null 2>&1 && at_times_p=:

# CLI Arguments to pass to the debugging scripts.
at_debug_args=
# -e sets to true
at_errexit_p=false
# Shall we be verbose?  ':' means no, empty means yes.
at_verbose=:
at_quiet=
# Running several jobs in parallel, 0 means as many as test groups.
at_jobs=1
at_traceon=:
at_trace_echo=:
at_check_filter_trace=:

# Shall we keep the debug scripts?  Must be `:' when the suite is
# run by a debug script, so that the script doesn't remove itself.
at_debug_p=false
# Display help message?
at_help_p=false
# Display the version message?
at_version_p=false
# List test groups?
at_list_p=false
# --clean
at_clean=false
# Test groups to run
at_groups=
# Whether to rerun failed tests.
at_recheck=
# Whether a write failure occurred
at_write_fail=0

# The directory we run the suite in.  Default to . if no -C option.
at_dir=`pwd`
# An absolute reference to this testsuite script.
case $as_myself in
  [\\/]* | ?:[\\/]* ) at_myself=$as_myself ;;
  * ) at_myself=$at_dir/$as_myself ;;
esac
# Whether -C is in effect.
at_change_dir=false

# Whether to enable colored test results.
at_color=auto
# As many question marks as there are digits in the last test group number.
# Used to normalize the test group numbers so that `ls' lists them in
# numerical order.
at_format='????'
# Description of all the test groups.
at_help_all="1;network-functions.at:14;ip_to_hex;network-functions;
2;network-functions.at:43;ip_csum;network-functions;
3;network-functions.at:66;ip4_csum_inplace;;
4;network-functions.at:87;ip6_pseudoheader;network-functions;
5;network-functions.at:112;icmp6_csum;network-functions;
6;network-functions.at:187;tcpdump_hex;network-functions;
7;ovn-ipam.at:3;unit test -- init_ipam_ipv4;;
8;ovn-ipam.at:92;unit test -- init_ipam_ipv6_prefix;;
9;ovn-ipam.at:148;unit test -- ipam_get_unused_ip;;
10;ovn.at:3;lexer;;
11;ovn.at:109;registers;;
12;ovn.at:132;conntrack fields;;
13;ovn.at:161;composition;;
14;ovn.at:165;expression parser;;
15;ovn.at:349;expression annotation;;
16;ovn.at:391;1-term expression conversion;;
17;ovn.at:397;2-term expression conversion;;
18;ovn.at:403;3-term expression conversion;;
19;ovn.at:409;3-term numeric expression simplification;slowtest;
20;ovn.at:416;4-term string expression simplification;;
21;ovn.at:422;3-term mixed expression simplification;;
22;ovn.at:428;simplification special cases;;
23;ovn.at:450;is_chassis_resident simplification;;
24;ovn.at:464;4-term numeric expression normalization;slowtest;
25;ovn.at:471;4-term string expression normalization;;
26;ovn.at:477;4-term mixed expression normalization;;
27;ovn.at:483;5-term numeric expression normalization;slowtest;
28;ovn.at:490;5-term string expression normalization;;
29;ovn.at:496;5-term mixed expression normalization;;
30;ovn.at:502;4-term numeric expressions to flows;expression;
31;ovn.at:509;4-term string expressions to flows;expression;
32;ovn.at:516;4-term mixed expressions to flows;slowtest expression;
33;ovn.at:524;3-term numeric expressions to flows;expression;
34;ovn.at:531;converting expressions to flows -- string fields;expression;
35;ovn.at:568;converting expressions to flows -- address sets;expression;
36;ovn.at:674;converting expressions to flows -- port groups;expression;
37;ovn.at:692;converting expressions to flows -- conjunction;conjunction;
38;ovn.at:793;action parsing;;
39;ovn.at:2309;ovn -- enables vlan-limit=0 -- parallelization=yes -- ovn_monitor_all=yes;;
40;ovn.at:2309;ovn -- enables vlan-limit=0 -- parallelization=yes -- ovn_monitor_all=no;;
41;ovn.at:2328;ovn -- allows ACLs to match against vlan-transparent double tagged traffic L3 fields -- parallelization=yes -- ovn_monitor_all=yes;;
42;ovn.at:2328;ovn -- allows ACLs to match against vlan-transparent double tagged traffic L3 fields -- parallelization=yes -- ovn_monitor_all=no;;
43;ovn.at:2412;3 HVs, 1 LS, 3 lports/HV -- parallelization=yes -- ovn_monitor_all=yes;ovnarp slowtest;
44;ovn.at:2412;3 HVs, 1 LS, 3 lports/HV -- parallelization=yes -- ovn_monitor_all=no;ovnarp slowtest;
45;ovn.at:2689;2 HVs, 1 LS, 2 lports/HV -- parallelization=yes -- ovn_monitor_all=yes;ovnarp;
46;ovn.at:2689;2 HVs, 1 LS, 2 lports/HV -- parallelization=yes -- ovn_monitor_all=no;ovnarp;
47;ovn.at:2856;trace 1 LS, 3 LSPs -- parallelization=yes -- ovn_monitor_all=yes;;
48;ovn.at:2856;trace 1 LS, 3 LSPs -- parallelization=yes -- ovn_monitor_all=no;;
49;ovn.at:3092;2 HVs, 4 lports/HV, localnet ports -- parallelization=yes -- ovn_monitor_all=yes;;
50;ovn.at:3092;2 HVs, 4 lports/HV, localnet ports -- parallelization=yes -- ovn_monitor_all=no;;
51;ovn.at:3289;2 HVs, 2 LS, routing works for multiple collocated segments attached to different switches -- parallelization=yes -- ovn_monitor_all=yes;;
52;ovn.at:3289;2 HVs, 2 LS, routing works for multiple collocated segments attached to different switches -- parallelization=yes -- ovn_monitor_all=no;;
53;ovn.at:3432;2 HVs, 2 LS, broadcast traffic with multiple localnet ports per switch -- parallelization=yes -- ovn_monitor_all=yes;;
54;ovn.at:3432;2 HVs, 2 LS, broadcast traffic with multiple localnet ports per switch -- parallelization=yes -- ovn_monitor_all=no;;
55;ovn.at:3583;2 HVs, 2 LS, switching between multiple localnet ports with same tags -- parallelization=yes -- ovn_monitor_all=yes;;
56;ovn.at:3583;2 HVs, 2 LS, switching between multiple localnet ports with same tags -- parallelization=yes -- ovn_monitor_all=no;;
57;ovn.at:3710;VLAN transparency, passthru=true, ARP responder disabled -- parallelization=yes -- ovn_monitor_all=yes;;
58;ovn.at:3710;VLAN transparency, passthru=true, ARP responder disabled -- parallelization=yes -- ovn_monitor_all=no;;
59;ovn.at:3790;VLAN transparency, passthru=true, ND/NA responder disabled -- parallelization=yes -- ovn_monitor_all=yes;;
60;ovn.at:3790;VLAN transparency, passthru=true, ND/NA responder disabled -- parallelization=yes -- ovn_monitor_all=no;;
61;ovn.at:3852;VLAN transparency, passthru=true, multiple hosts -- parallelization=yes -- ovn_monitor_all=yes;;
62;ovn.at:3852;VLAN transparency, passthru=true, multiple hosts -- parallelization=yes -- ovn_monitor_all=no;;
63;ovn.at:3919;VLAN transparency, passthru=true, multiple hosts, custom ethtype -- parallelization=yes -- ovn_monitor_all=yes;;
64;ovn.at:3919;VLAN transparency, passthru=true, multiple hosts, custom ethtype -- parallelization=yes -- ovn_monitor_all=no;;
65;ovn.at:4007;VLAN transparency, passthru=true, multiple hosts, flat/untagged -- parallelization=yes -- ovn_monitor_all=yes;;
66;ovn.at:4007;VLAN transparency, passthru=true, multiple hosts, flat/untagged -- parallelization=yes -- ovn_monitor_all=no;;
67;ovn.at:4079;VLAN transparency, passthru=true -- parallelization=yes -- ovn_monitor_all=yes;;
68;ovn.at:4079;VLAN transparency, passthru=true -- parallelization=yes -- ovn_monitor_all=no;;
69;ovn.at:4127;VLAN transparency, passthru=false -- parallelization=yes -- ovn_monitor_all=yes;;
70;ovn.at:4127;VLAN transparency, passthru=false -- parallelization=yes -- ovn_monitor_all=no;;
71;ovn.at:4174;VXLAN check port/datapath key space limits -- parallelization=yes -- ovn_monitor_all=yes;;
72;ovn.at:4174;VXLAN check port/datapath key space limits -- parallelization=yes -- ovn_monitor_all=no;;
73;ovn.at:4224;2 HVs, 1 LS, no switching between multiple localnet ports with different tags -- parallelization=yes -- ovn_monitor_all=yes;;
74;ovn.at:4224;2 HVs, 1 LS, no switching between multiple localnet ports with different tags -- parallelization=yes -- ovn_monitor_all=no;;
75;ovn.at:4341;vtep: 3 HVs, 1 VIFs/HV, 1 GW, 1 LS -- parallelization=yes -- ovn_monitor_all=yes;vtep;
76;ovn.at:4341;vtep: 3 HVs, 1 VIFs/HV, 1 GW, 1 LS -- parallelization=yes -- ovn_monitor_all=no;vtep;
77;ovn.at:4677;3 HVs, 1 VIFs/HV, 1 software GW, 1 LS -- parallelization=yes -- ovn_monitor_all=yes;;
78;ovn.at:4677;3 HVs, 1 VIFs/HV, 1 software GW, 1 LS -- parallelization=yes -- ovn_monitor_all=no;;
79;ovn.at:4836;3 HVs, 3 LS, 3 lports/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=yes;slowtest;
80;ovn.at:4836;3 HVs, 3 LS, 3 lports/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=no;slowtest;
81;ovn.at:5273;IP relocation using GARP request -- parallelization=yes -- ovn_monitor_all=yes;;
82;ovn.at:5273;IP relocation using GARP request -- parallelization=yes -- ovn_monitor_all=no;;
83;ovn.at:5534;portsecurity : 3 HVs, 1 LS, 3 lports/HV -- parallelization=yes -- ovn_monitor_all=yes;;
84;ovn.at:5534;portsecurity : 3 HVs, 1 LS, 3 lports/HV -- parallelization=yes -- ovn_monitor_all=no;;
85;ovn.at:5945;2 HVs, 2 LS, 1 lport/LS, 2 peer LRs -- parallelization=yes -- ovn_monitor_all=yes;;
86;ovn.at:5945;2 HVs, 2 LS, 1 lport/LS, 2 peer LRs -- parallelization=yes -- ovn_monitor_all=no;;
87;ovn.at:6091;1 HV, 1 LS, 2 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=yes;router-admin-state;
88;ovn.at:6091;1 HV, 1 LS, 2 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=no;router-admin-state;
89;ovn.at:6200;1 HV, 2 LSs, 1 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=yes;router-admin-state unstable;
90;ovn.at:6200;1 HV, 2 LSs, 1 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=no;router-admin-state unstable;
91;ovn.at:6293;2 HVs, 3 LS, 1 lport/LS, 2 peer LRs, static routes -- parallelization=yes -- ovn_monitor_all=yes;;
92;ovn.at:6293;2 HVs, 3 LS, 1 lport/LS, 2 peer LRs, static routes -- parallelization=yes -- ovn_monitor_all=no;;
93;ovn.at:6436;send gratuitous arp on localnet -- parallelization=yes -- ovn_monitor_all=yes;;
94;ovn.at:6436;send gratuitous arp on localnet -- parallelization=yes -- ovn_monitor_all=no;;
95;ovn.at:6496;2 HVs, 3 LRs connected via LS, static routes -- parallelization=yes -- ovn_monitor_all=yes;;
96;ovn.at:6496;2 HVs, 3 LRs connected via LS, static routes -- parallelization=yes -- ovn_monitor_all=no;;
97;ovn.at:6679;dhcpv4 : 1 HV, 2 LS, 2 LSPs/LS -- parallelization=yes -- ovn_monitor_all=yes;slowtest;
98;ovn.at:6679;dhcpv4 : 1 HV, 2 LS, 2 LSPs/LS -- parallelization=yes -- ovn_monitor_all=no;slowtest;
99;ovn.at:7396;dhcpv6 : 1 HV, 2 LS, 5 LSPs -- parallelization=yes -- ovn_monitor_all=yes;;
100;ovn.at:7396;dhcpv6 : 1 HV, 2 LS, 5 LSPs -- parallelization=yes -- ovn_monitor_all=no;;
101;ovn.at:7733;2 HVs, 2 LRs connected via LS, gateway router -- parallelization=yes -- ovn_monitor_all=yes;;
102;ovn.at:7733;2 HVs, 2 LRs connected via LS, gateway router -- parallelization=yes -- ovn_monitor_all=no;;
103;ovn.at:7917;spine-leaf: 1 HV, 3 LSs, connected via spine switch -- parallelization=yes -- ovn_monitor_all=yes;spine leaf;
104;ovn.at:7917;spine-leaf: 1 HV, 3 LSs, connected via spine switch -- parallelization=yes -- ovn_monitor_all=no;spine leaf;
105;ovn.at:8114;spine-leaf: 3 HVs, 3 LSs, connected via distributed spine switch -- parallelization=yes -- ovn_monitor_all=yes;spine leaf;
106;ovn.at:8114;spine-leaf: 3 HVs, 3 LSs, connected via distributed spine switch -- parallelization=yes -- ovn_monitor_all=no;spine leaf;
107;ovn.at:8358;icmp_reply: 1 HVs, 2 LSs, 1 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=yes;router-icmp-reply;
108;ovn.at:8358;icmp_reply: 1 HVs, 2 LSs, 1 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=no;router-icmp-reply;
109;ovn.at:8488;policy-based routing: 1 HVs, 2 LSs, 1 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=yes;policy-based-routing unstable;
110;ovn.at:8488;policy-based routing: 1 HVs, 2 LSs, 1 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=no;policy-based-routing unstable;
111;ovn.at:8754;policy-based routing IPv6: 1 HVs, 3 LSs, 1 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=yes;policy-based-routing unstable;
112;ovn.at:8754;policy-based routing IPv6: 1 HVs, 3 LSs, 1 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=no;policy-based-routing unstable;
113;ovn.at:8925;port state up and down -- parallelization=yes -- ovn_monitor_all=yes;;
114;ovn.at:8925;port state up and down -- parallelization=yes -- ovn_monitor_all=no;;
115;ovn.at:8954;datapath rules added/removed -- parallelization=yes -- ovn_monitor_all=yes;cleanup;
116;ovn.at:8954;datapath rules added/removed -- parallelization=yes -- ovn_monitor_all=no;cleanup;
117;ovn.at:9024;nd_na  -- parallelization=yes -- ovn_monitor_all=yes;;
118;ovn.at:9024;nd_na  -- parallelization=yes -- ovn_monitor_all=no;;
119;ovn.at:9090;address sets modification/removal smoke test -- parallelization=yes -- ovn_monitor_all=yes;;
120;ovn.at:9090;address sets modification/removal smoke test -- parallelization=yes -- ovn_monitor_all=no;;
121;ovn.at:9117;ipam -- parallelization=yes -- ovn_monitor_all=yes;slowtest;
122;ovn.at:9117;ipam -- parallelization=yes -- ovn_monitor_all=no;slowtest;
123;ovn.at:9443;ipam connectivity -- parallelization=yes -- ovn_monitor_all=yes;;
124;ovn.at:9443;ipam connectivity -- parallelization=yes -- ovn_monitor_all=no;;
125;ovn.at:9569;ovs-vswitchd restart -- parallelization=yes -- ovn_monitor_all=yes;vswitchd;
126;ovn.at:9569;ovs-vswitchd restart -- parallelization=yes -- ovn_monitor_all=no;vswitchd;
127;ovn.at:9667;send arp for nexthop -- parallelization=yes -- ovn_monitor_all=yes;;
128;ovn.at:9667;send arp for nexthop -- parallelization=yes -- ovn_monitor_all=no;;
129;ovn.at:9749;send gratuitous arp for nat ips in localnet -- parallelization=yes -- ovn_monitor_all=yes;;
130;ovn.at:9749;send gratuitous arp for nat ips in localnet -- parallelization=yes -- ovn_monitor_all=no;;
131;ovn.at:9823;send gratuitous arp for l3gateway only on selected chassis -- parallelization=yes -- ovn_monitor_all=yes;;
132;ovn.at:9823;send gratuitous arp for l3gateway only on selected chassis -- parallelization=yes -- ovn_monitor_all=no;;
133;ovn.at:9939;send gratuitous arp with nat-addresses router in localnet -- parallelization=yes -- ovn_monitor_all=yes;;
134;ovn.at:9939;send gratuitous arp with nat-addresses router in localnet -- parallelization=yes -- ovn_monitor_all=no;;
135;ovn.at:10029;send reverse arp for router without ipv4 address -- parallelization=yes -- ovn_monitor_all=yes;;
136;ovn.at:10029;send reverse arp for router without ipv4 address -- parallelization=yes -- ovn_monitor_all=no;;
137;ovn.at:10099;delete mac bindings -- parallelization=yes -- ovn_monitor_all=yes;;
138;ovn.at:10099;delete mac bindings -- parallelization=yes -- ovn_monitor_all=no;;
139;ovn.at:10133;conntrack zone allocation -- parallelization=yes -- ovn_monitor_all=yes;;
140;ovn.at:10133;conntrack zone allocation -- parallelization=yes -- ovn_monitor_all=no;;
141;ovn.at:10188;tag allocation -- parallelization=yes -- ovn_monitor_all=yes;;
142;ovn.at:10188;tag allocation -- parallelization=yes -- ovn_monitor_all=no;;
143;ovn.at:10306;lsp deletion and broadcast-flow deletion on localnet -- parallelization=yes -- ovn_monitor_all=yes;;
144;ovn.at:10306;lsp deletion and broadcast-flow deletion on localnet -- parallelization=yes -- ovn_monitor_all=no;;
145;ovn.at:10377;ACL logging -- parallelization=yes -- ovn_monitor_all=yes;ovn;
146;ovn.at:10377;ACL logging -- parallelization=yes -- ovn_monitor_all=no;ovn;
147;ovn.at:10527;ACL rate-limited logging -- parallelization=yes -- ovn_monitor_all=yes;ovn;
148;ovn.at:10527;ACL rate-limited logging -- parallelization=yes -- ovn_monitor_all=no;ovn;
149;ovn.at:10619;same meter used by multiple logical flows -- parallelization=yes -- ovn_monitor_all=yes;ovn;
150;ovn.at:10619;same meter used by multiple logical flows -- parallelization=yes -- ovn_monitor_all=no;ovn;
151;ovn.at:10676;DSCP marking and meter check -- parallelization=yes -- ovn_monitor_all=yes;ovn;
152;ovn.at:10676;DSCP marking and meter check -- parallelization=yes -- ovn_monitor_all=no;ovn;
153;ovn.at:10811;read-only sb db:ptcp access;;
154;ovn.at:10846;read-only sb db:pssl access;;
155;ovn.at:10902;nb connection - ssl commands;;
156;ovn.at:10953;sb connection/ssl commands;;
157;ovn.at:11004;nested containers -- parallelization=yes -- ovn_monitor_all=yes;;
158;ovn.at:11004;nested containers -- parallelization=yes -- ovn_monitor_all=no;;
159;ovn.at:11296;3 HVs, 3 LRs connected via LS, source IP based routes -- parallelization=yes -- ovn_monitor_all=yes;;
160;ovn.at:11296;3 HVs, 3 LRs connected via LS, source IP based routes -- parallelization=yes -- ovn_monitor_all=no;;
161;ovn.at:11491;dns lookup : 1 HV, 2 LS, 2 LSPs/LS -- parallelization=yes -- ovn_monitor_all=yes;;
162;ovn.at:11491;dns lookup : 1 HV, 2 LS, 2 LSPs/LS -- parallelization=yes -- ovn_monitor_all=no;;
163;ovn.at:12059;dns lookup : EDNS -- parallelization=yes -- ovn_monitor_all=yes;;
164;ovn.at:12059;dns lookup : EDNS -- parallelization=yes -- ovn_monitor_all=no;;
165;ovn.at:12119;4 HV, 1 LS, 1 LR, packet test with HA distributed router gateway port -- parallelization=yes -- ovn_monitor_all=yes;;
166;ovn.at:12119;4 HV, 1 LS, 1 LR, packet test with HA distributed router gateway port -- parallelization=yes -- ovn_monitor_all=no;;
167;ovn.at:12358;4 HV, 3 LS, 2 LR, packet test with HA distributed router gateway port -- parallelization=yes -- ovn_monitor_all=yes;;
168;ovn.at:12358;4 HV, 3 LS, 2 LR, packet test with HA distributed router gateway port -- parallelization=yes -- ovn_monitor_all=no;;
169;ovn.at:12586;1 LR with distributed router gateway port -- parallelization=yes -- ovn_monitor_all=yes;;
170;ovn.at:12586;1 LR with distributed router gateway port -- parallelization=yes -- ovn_monitor_all=no;;
171;ovn.at:12927;send gratuitous arp for NAT rules on distributed router -- parallelization=yes -- ovn_monitor_all=yes;;
172;ovn.at:12927;send gratuitous arp for NAT rules on distributed router -- parallelization=yes -- ovn_monitor_all=no;;
173;ovn.at:13043;vlan traffic for external network with distributed router gateway port -- parallelization=yes -- ovn_monitor_all=yes;;
174;ovn.at:13043;vlan traffic for external network with distributed router gateway port -- parallelization=yes -- ovn_monitor_all=no;;
175;ovn.at:13361;IPv6 ND Router Solicitation responder -- parallelization=yes -- ovn_monitor_all=yes;ovn-nd_ra;
176;ovn.at:13361;IPv6 ND Router Solicitation responder -- parallelization=yes -- ovn_monitor_all=no;ovn-nd_ra;
177;ovn.at:13618;/32 router IP address -- parallelization=yes -- ovn_monitor_all=yes;;
178;ovn.at:13618;/32 router IP address -- parallelization=yes -- ovn_monitor_all=no;;
179;ovn.at:13716;2 HVs, 1 lport/HV, localport ports -- parallelization=yes -- ovn_monitor_all=yes;;
180;ovn.at:13716;2 HVs, 1 lport/HV, localport ports -- parallelization=yes -- ovn_monitor_all=no;;
181;ovn.at:13867;localport suppress gARP -- parallelization=yes -- ovn_monitor_all=yes;;
182;ovn.at:13867;localport suppress gARP -- parallelization=yes -- ovn_monitor_all=no;;
183;ovn.at:13935;localport doesn't suppress ARP directed to external port -- parallelization=yes -- ovn_monitor_all=yes;;
184;ovn.at:13935;localport doesn't suppress ARP directed to external port -- parallelization=yes -- ovn_monitor_all=no;;
185;ovn.at:14037;localport takes part in broadcast ARP delivery -- parallelization=yes -- ovn_monitor_all=yes;;
186;ovn.at:14037;localport takes part in broadcast ARP delivery -- parallelization=yes -- ovn_monitor_all=no;;
187;ovn.at:14091;1 LR with HA distributed router gateway port -- parallelization=yes -- ovn_monitor_all=yes;;
188;ovn.at:14091;1 LR with HA distributed router gateway port -- parallelization=yes -- ovn_monitor_all=no;;
189;ovn.at:14584;send gratuitous ARP for NAT rules on HA distributed router -- parallelization=yes -- ovn_monitor_all=yes;;
190;ovn.at:14584;send gratuitous ARP for NAT rules on HA distributed router -- parallelization=yes -- ovn_monitor_all=no;;
191;ovn.at:14731;ensure one gw controller restart in HA doesn't bounce the active chassis -- parallelization=yes -- ovn_monitor_all=yes;;
192;ovn.at:14731;ensure one gw controller restart in HA doesn't bounce the active chassis -- parallelization=yes -- ovn_monitor_all=no;;
193;ovn.at:14832;allow IPv6 RA / NA / MLD by default -- parallelization=yes -- ovn_monitor_all=yes;;
194;ovn.at:14832;allow IPv6 RA / NA / MLD by default -- parallelization=yes -- ovn_monitor_all=no;;
195;ovn.at:14959;IPv6 Neighbor Solicitation for unknown MAC -- parallelization=yes -- ovn_monitor_all=yes;ovn-nd_ns for unknown mac;
196;ovn.at:14959;IPv6 Neighbor Solicitation for unknown MAC -- parallelization=yes -- ovn_monitor_all=no;ovn-nd_ns for unknown mac;
197;ovn.at:15168;options:multiple requested-chassis for logical port -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis unstable;
198;ovn.at:15168;options:multiple requested-chassis for logical port -- parallelization=yes -- ovn_monitor_all=no;multi-chassis unstable;
199;ovn.at:15302;options:multiple requested-chassis for logical port: change chassis role -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis unstable;
200;ovn.at:15302;options:multiple requested-chassis for logical port: change chassis role -- parallelization=yes -- ovn_monitor_all=no;multi-chassis unstable;
201;ovn.at:15353;options:multiple requested-chassis for logical port: unclaimed behavior -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis unstable;
202;ovn.at:15353;options:multiple requested-chassis for logical port: unclaimed behavior -- parallelization=yes -- ovn_monitor_all=no;multi-chassis unstable;
203;ovn.at:15439;basic connectivity with multiple requested-chassis -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis slowtest;
204;ovn.at:15439;basic connectivity with multiple requested-chassis -- parallelization=yes -- ovn_monitor_all=no;multi-chassis slowtest;
205;ovn.at:15790;localnet connectivity with multiple requested-chassis -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis;
206;ovn.at:15790;localnet connectivity with multiple requested-chassis -- parallelization=yes -- ovn_monitor_all=no;multi-chassis;
207;ovn.at:16518;localnet connectivity with multiple requested-chassis, path mtu discovery (ip=ipv4, tunnel=geneve, mtu=1424) -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis;
208;ovn.at:16518;localnet connectivity with multiple requested-chassis, path mtu discovery (ip=ipv4, tunnel=geneve, mtu=1424) -- parallelization=yes -- ovn_monitor_all=no;multi-chassis;
209;ovn.at:16519;localnet connectivity with multiple requested-chassis, path mtu discovery (ip=ipv6, tunnel=geneve, mtu=1404) -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis;
210;ovn.at:16519;localnet connectivity with multiple requested-chassis, path mtu discovery (ip=ipv6, tunnel=geneve, mtu=1404) -- parallelization=yes -- ovn_monitor_all=no;multi-chassis;
211;ovn.at:16520;localnet connectivity with multiple requested-chassis, path mtu discovery (ip=ipv4, tunnel=vxlan, mtu=1432) -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis;
212;ovn.at:16520;localnet connectivity with multiple requested-chassis, path mtu discovery (ip=ipv4, tunnel=vxlan, mtu=1432) -- parallelization=yes -- ovn_monitor_all=no;multi-chassis;
213;ovn.at:16521;localnet connectivity with multiple requested-chassis, path mtu discovery (ip=ipv6, tunnel=vxlan, mtu=1412) -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis;
214;ovn.at:16521;localnet connectivity with multiple requested-chassis, path mtu discovery (ip=ipv6, tunnel=vxlan, mtu=1412) -- parallelization=yes -- ovn_monitor_all=no;multi-chassis;
215;ovn.at:16747;options:activation-strategy=rarp for logical port -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis slowtest;
216;ovn.at:16747;options:activation-strategy=rarp for logical port -- parallelization=yes -- ovn_monitor_all=no;multi-chassis slowtest;
217;ovn.at:16748;options:activation-strategy=garp for logical port -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis slowtest;
218;ovn.at:16748;options:activation-strategy=garp for logical port -- parallelization=yes -- ovn_monitor_all=no;multi-chassis slowtest;
219;ovn.at:16749;options:activation-strategy=na for logical port -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis slowtest;
220;ovn.at:16749;options:activation-strategy=na for logical port -- parallelization=yes -- ovn_monitor_all=no;multi-chassis slowtest;
221;ovn.at:16751;options:activation-strategy=rarp is not waiting for southbound db -- parallelization=yes -- ovn_monitor_all=yes;multi-chassis;
222;ovn.at:16751;options:activation-strategy=rarp is not waiting for southbound db -- parallelization=yes -- ovn_monitor_all=no;multi-chassis;
223;ovn.at:16915;options:requested-chassis for logical port -- parallelization=yes -- ovn_monitor_all=yes;;
224;ovn.at:16915;options:requested-chassis for logical port -- parallelization=yes -- ovn_monitor_all=no;;
225;ovn.at:17008;tug-of-war between two chassis for the same port -- parallelization=yes -- ovn_monitor_all=yes;unstable;
226;ovn.at:17008;tug-of-war between two chassis for the same port -- parallelization=yes -- ovn_monitor_all=no;unstable;
227;ovn.at:17062;No fight between two chassis for the same port -- parallelization=yes -- ovn_monitor_all=yes;;
228;ovn.at:17062;No fight between two chassis for the same port -- parallelization=yes -- ovn_monitor_all=no;;
229;ovn.at:17225;options:requested-chassis with hostname -- parallelization=yes -- ovn_monitor_all=yes;;
230;ovn.at:17225;options:requested-chassis with hostname -- parallelization=yes -- ovn_monitor_all=no;;
231;ovn.at:17269;IPv6 periodic RA -- parallelization=yes -- ovn_monitor_all=yes;;
232;ovn.at:17269;IPv6 periodic RA -- parallelization=yes -- ovn_monitor_all=no;;
233;ovn.at:17452;garps disabled when port no longer bound to chassis -- parallelization=yes -- ovn_monitor_all=yes;;
234;ovn.at:17452;garps disabled when port no longer bound to chassis -- parallelization=yes -- ovn_monitor_all=no;;
235;ovn.at:17539;IPv6 periodic RA disabled for localnet adjacent switch ports -- parallelization=yes -- ovn_monitor_all=yes;;
236;ovn.at:17539;IPv6 periodic RA disabled for localnet adjacent switch ports -- parallelization=yes -- ovn_monitor_all=no;;
237;ovn.at:17693;IPv6 periodic gateway RA enabled for localnet adjacent switch ports -- parallelization=yes -- ovn_monitor_all=yes;;
238;ovn.at:17693;IPv6 periodic gateway RA enabled for localnet adjacent switch ports -- parallelization=yes -- ovn_monitor_all=no;;
239;ovn.at:17797;ACL reject rule test -- parallelization=yes -- ovn_monitor_all=yes;acl-reject;
240;ovn.at:17797;ACL reject rule test -- parallelization=yes -- ovn_monitor_all=no;acl-reject;
241;ovn.at:17981;ACL Reject ping pong -- parallelization=yes -- ovn_monitor_all=yes;acl reject ping pong;
242;ovn.at:17981;ACL Reject ping pong -- parallelization=yes -- ovn_monitor_all=no;acl reject ping pong;
243;ovn.at:18089;Mirror - remote -- parallelization=yes -- ovn_monitor_all=yes;mirror;
244;ovn.at:18089;Mirror - remote -- parallelization=yes -- ovn_monitor_all=no;mirror;
245;ovn.at:18347;Mirror - local -- parallelization=yes -- ovn_monitor_all=yes;mirror;
246;ovn.at:18347;Mirror - local -- parallelization=yes -- ovn_monitor_all=no;mirror;
247;ovn.at:18449;Mirror test bulk updates -- parallelization=yes -- ovn_monitor_all=yes;mirror test bulk updates;
248;ovn.at:18449;Mirror test bulk updates -- parallelization=yes -- ovn_monitor_all=no;mirror test bulk updates;
249;ovn.at:18745;Port Groups -- parallelization=yes -- ovn_monitor_all=yes;ovnpg slowtest;
250;ovn.at:18745;Port Groups -- parallelization=yes -- ovn_monitor_all=no;ovnpg slowtest;
251;ovn.at:18965;ACLs on Port Groups -- parallelization=yes -- ovn_monitor_all=yes;ovnpg_acl slowtest;
252;ovn.at:18965;ACLs on Port Groups -- parallelization=yes -- ovn_monitor_all=no;ovnpg_acl slowtest;
253;ovn.at:19239;Address Set generation from Port Groups (static addressing) -- parallelization=yes -- ovn_monitor_all=yes;;
254;ovn.at:19239;Address Set generation from Port Groups (static addressing) -- parallelization=yes -- ovn_monitor_all=no;;
255;ovn.at:19279;Address Set generation from Port Groups (dynamic addressing) -- parallelization=yes -- ovn_monitor_all=yes;;
256;ovn.at:19279;Address Set generation from Port Groups (dynamic addressing) -- parallelization=yes -- ovn_monitor_all=no;;
257;ovn.at:19345;ACL conjunction -- parallelization=yes -- ovn_monitor_all=yes;;
258;ovn.at:19345;ACL conjunction -- parallelization=yes -- ovn_monitor_all=no;;
259;ovn.at:19562;ACL conjunction append and reprocess -- parallelization=yes -- ovn_monitor_all=yes;;
260;ovn.at:19562;ACL conjunction append and reprocess -- parallelization=yes -- ovn_monitor_all=no;;
261;ovn.at:19646;Superseding ACLs with conjunction -- parallelization=yes -- ovn_monitor_all=yes;;
262;ovn.at:19646;Superseding ACLs with conjunction -- parallelization=yes -- ovn_monitor_all=no;;
263;ovn.at:19920;n_conjs change -- parallelization=yes -- ovn_monitor_all=yes;;
264;ovn.at:19920;n_conjs change -- parallelization=yes -- ovn_monitor_all=no;;
265;ovn.at:19987;L2 Drop and Allow ACL w/ Stateful ACL -- parallelization=yes -- ovn_monitor_all=yes;;
266;ovn.at:19987;L2 Drop and Allow ACL w/ Stateful ACL -- parallelization=yes -- ovn_monitor_all=no;;
267;ovn.at:20199;TTL exceeded -- parallelization=yes -- ovn_monitor_all=yes;ttl-exceeded;
268;ovn.at:20199;TTL exceeded -- parallelization=yes -- ovn_monitor_all=no;ttl-exceeded;
269;ovn.at:20313;router port unreachable -- parallelization=yes -- ovn_monitor_all=yes;router-port-unreachable;
270;ovn.at:20313;router port unreachable -- parallelization=yes -- ovn_monitor_all=no;router-port-unreachable;
271;ovn.at:20535;ovn-controller exit -- parallelization=yes -- ovn_monitor_all=yes;;
272;ovn.at:20535;ovn-controller exit -- parallelization=yes -- ovn_monitor_all=no;;
273;ovn.at:20635;external logical port -- parallelization=yes -- ovn_monitor_all=yes;;
274;ovn.at:20635;external logical port -- parallelization=yes -- ovn_monitor_all=no;;
275;ovn.at:21326;Address Set Incremental Processing -- parallelization=yes -- ovn_monitor_all=yes;ovn_as_inc;
276;ovn.at:21326;Address Set Incremental Processing -- parallelization=yes -- ovn_monitor_all=no;ovn_as_inc;
277;ovn.at:21411;ovn-controller restart -- parallelization=yes -- ovn_monitor_all=yes;;
278;ovn.at:21411;ovn-controller restart -- parallelization=yes -- ovn_monitor_all=no;;
279;ovn.at:21507;ovn-nbctl duplicate addresses -- parallelization=yes -- ovn_monitor_all=yes;;
280;ovn.at:21507;ovn-nbctl duplicate addresses -- parallelization=yes -- ovn_monitor_all=no;;
281;ovn.at:21565;router - check packet length - icmp defrag -- parallelization=yes -- ovn_monitor_all=yes;check packet length slowtest;
282;ovn.at:21565;router - check packet length - icmp defrag -- parallelization=yes -- ovn_monitor_all=no;check packet length slowtest;
283;ovn.at:21993;IP packet buffering -- parallelization=yes -- ovn_monitor_all=yes;ip-buffering;
284;ovn.at:21993;IP packet buffering -- parallelization=yes -- ovn_monitor_all=no;ip-buffering;
285;ovn.at:22188;neighbor update on same HV -- parallelization=yes -- ovn_monitor_all=yes;;
286;ovn.at:22188;neighbor update on same HV -- parallelization=yes -- ovn_monitor_all=no;;
287;ovn.at:22319;ipam to non-ipam -- parallelization=yes -- ovn_monitor_all=yes;;
288;ovn.at:22319;ipam to non-ipam -- parallelization=yes -- ovn_monitor_all=no;;
289;ovn.at:22342;ipam router ports -- parallelization=yes -- ovn_monitor_all=yes;;
290;ovn.at:22342;ipam router ports -- parallelization=yes -- ovn_monitor_all=no;;
291;ovn.at:22365;test transport zones -- parallelization=yes -- ovn_monitor_all=yes;;
292;ovn.at:22365;test transport zones -- parallelization=yes -- ovn_monitor_all=no;;
293;ovn.at:22528;2 HVs, 2 lports/HV, localnet ports, DVR chassis mac -- parallelization=yes -- ovn_monitor_all=yes;;
294;ovn.at:22528;2 HVs, 2 lports/HV, localnet ports, DVR chassis mac -- parallelization=yes -- ovn_monitor_all=no;;
295;ovn.at:22740;virtual ports -- parallelization=yes -- ovn_monitor_all=yes;virtual ports;
296;ovn.at:22740;virtual ports -- parallelization=yes -- ovn_monitor_all=no;virtual ports;
297;ovn.at:23299;can't write to a backup database server instance -- parallelization=yes -- ovn_monitor_all=yes;;
298;ovn.at:23299;can't write to a backup database server instance -- parallelization=yes -- ovn_monitor_all=no;;
299;ovn.at:23322;controller event -- parallelization=yes -- ovn_monitor_all=yes;ovn_controller_event;
300;ovn.at:23322;controller event -- parallelization=yes -- ovn_monitor_all=no;ovn_controller_event;
301;ovn.at:23469;IGMP snoop/querier/relay -- parallelization=yes -- ovn_monitor_all=yes;ip-multicast snoop query querier relay slowtest;
302;ovn.at:23469;IGMP snoop/querier/relay -- parallelization=yes -- ovn_monitor_all=no;ip-multicast snoop query querier relay slowtest;
303;ovn.at:24055;IGMP relay - distributed gateway port -- parallelization=yes -- ovn_monitor_all=yes;ip-multicast snoop relay;
304;ovn.at:24055;IGMP relay - distributed gateway port -- parallelization=yes -- ovn_monitor_all=no;ip-multicast snoop relay;
305;ovn.at:24194;MLD snoop/querier/relay -- parallelization=yes -- ovn_monitor_all=yes;ip-multicast snoop query querier relay slowtest;
306;ovn.at:24194;MLD snoop/querier/relay -- parallelization=yes -- ovn_monitor_all=no;ip-multicast snoop query querier relay slowtest;
307;ovn.at:24798;IGMP external querier -- parallelization=yes -- ovn_monitor_all=yes;ip-multicast;
308;ovn.at:24798;IGMP external querier -- parallelization=yes -- ovn_monitor_all=no;ip-multicast;
309;ovn.at:24960;unixctl socket -- parallelization=yes -- ovn_monitor_all=yes;;
310;ovn.at:24960;unixctl socket -- parallelization=yes -- ovn_monitor_all=no;;
311;ovn.at:25261;2 HVs, 2 lports/HV, localnet ports, DVR N-S ARP handling, encap geneve -- parallelization=yes -- ovn_monitor_all=yes;;
312;ovn.at:25261;2 HVs, 2 lports/HV, localnet ports, DVR N-S ARP handling, encap geneve -- parallelization=yes -- ovn_monitor_all=no;;
313;ovn.at:25262;2 HVs, 2 lports/HV, localnet ports, DVR N-S ARP handling, encap vxlan -- parallelization=yes -- ovn_monitor_all=yes;;
314;ovn.at:25262;2 HVs, 2 lports/HV, localnet ports, DVR N-S ARP handling, encap vxlan -- parallelization=yes -- ovn_monitor_all=no;;
315;ovn.at:25571;2 HVs, 2 lports/HV, localnet ports, DVR N-S Ping, encap geneve -- parallelization=yes -- ovn_monitor_all=yes;geneve;
316;ovn.at:25571;2 HVs, 2 lports/HV, localnet ports, DVR N-S Ping, encap geneve -- parallelization=yes -- ovn_monitor_all=no;geneve;
317;ovn.at:25572;2 HVs, 2 lports/HV, localnet ports, DVR N-S Ping, encap vxlan -- parallelization=yes -- ovn_monitor_all=yes;vxlan;
318;ovn.at:25572;2 HVs, 2 lports/HV, localnet ports, DVR N-S Ping, encap vxlan -- parallelization=yes -- ovn_monitor_all=no;vxlan;
319;ovn.at:25574;ARP lookup before learning -- parallelization=yes -- ovn_monitor_all=yes;virtual ports;
320;ovn.at:25574;ARP lookup before learning -- parallelization=yes -- ovn_monitor_all=no;virtual ports;
321;ovn.at:25804;1 HVs, 1 lport/HV, localnet ports, RARP -- parallelization=yes -- ovn_monitor_all=yes;;
322;ovn.at:25804;1 HVs, 1 lport/HV, localnet ports, RARP -- parallelization=yes -- ovn_monitor_all=no;;
323;ovn.at:25867;Disabling RARP/GARP announcements -- parallelization=yes -- ovn_monitor_all=yes;;
324;ovn.at:25867;Disabling RARP/GARP announcements -- parallelization=yes -- ovn_monitor_all=no;;
325;ovn.at:25935;Stateless Floating IP -- parallelization=yes -- ovn_monitor_all=yes;;
326;ovn.at:25935;Stateless Floating IP -- parallelization=yes -- ovn_monitor_all=no;;
327;ovn.at:26251;Load balancer health checks - IPv4 -- parallelization=yes -- ovn_monitor_all=yes;lb;
328;ovn.at:26251;Load balancer health checks - IPv4 -- parallelization=yes -- ovn_monitor_all=no;lb;
329;ovn.at:26457;Load balancer health checks - IPv6 -- parallelization=yes -- ovn_monitor_all=yes;lb;
330;ovn.at:26457;Load balancer health checks - IPv6 -- parallelization=yes -- ovn_monitor_all=no;lb;
331;ovn.at:26660;SCTP Load balancer health checks -- parallelization=yes -- ovn_monitor_all=yes;lb sctp;
332;ovn.at:26660;SCTP Load balancer health checks -- parallelization=yes -- ovn_monitor_all=no;lb sctp;
333;ovn.at:26783;ARP/ND request broadcast limiting -- parallelization=yes -- ovn_monitor_all=yes;;
334;ovn.at:26783;ARP/ND request broadcast limiting -- parallelization=yes -- ovn_monitor_all=no;;
335;ovn.at:27264;trace when flow cookie updated -- parallelization=yes -- ovn_monitor_all=yes;cookie;
336;ovn.at:27264;trace when flow cookie updated -- parallelization=yes -- ovn_monitor_all=no;cookie;
337;ovn.at:27302;ECMP static routes -- parallelization=yes -- ovn_monitor_all=yes;;
338;ovn.at:27302;ECMP static routes -- parallelization=yes -- ovn_monitor_all=no;;
339;ovn.at:27408;ECMP static routes - custom hash -- parallelization=yes -- ovn_monitor_all=yes;;
340;ovn.at:27408;ECMP static routes - custom hash -- parallelization=yes -- ovn_monitor_all=no;;
341;ovn.at:27639;route tables -- <main> route table routes -- parallelization=yes -- ovn_monitor_all=yes;;
342;ovn.at:27639;route tables -- <main> route table routes -- parallelization=yes -- ovn_monitor_all=no;;
343;ovn.at:27813;route tables -- directly connected routes -- parallelization=yes -- ovn_monitor_all=yes;;
344;ovn.at:27813;route tables -- directly connected routes -- parallelization=yes -- ovn_monitor_all=no;;
345;ovn.at:27945;route tables -- overlapping subnets -- parallelization=yes -- ovn_monitor_all=yes;;
346;ovn.at:27945;route tables -- overlapping subnets -- parallelization=yes -- ovn_monitor_all=no;;
347;ovn.at:28057;route tables IPv6 -- overlapping subnets -- parallelization=yes -- ovn_monitor_all=yes;;
348;ovn.at:28057;route tables IPv6 -- overlapping subnets -- parallelization=yes -- ovn_monitor_all=no;;
349;ovn.at:28172;forwarding group: 3 HVs, 1 LR, 2 LS -- parallelization=yes -- ovn_monitor_all=yes;forwarding-group;
350;ovn.at:28172;forwarding group: 3 HVs, 1 LR, 2 LS -- parallelization=yes -- ovn_monitor_all=no;forwarding-group;
351;ovn.at:28301;Load Balancer LS hairpin -- parallelization=yes -- ovn_monitor_all=yes;;
352;ovn.at:28301;Load Balancer LS hairpin -- parallelization=yes -- ovn_monitor_all=no;;
353;ovn.at:28730;Big Load Balancer -- parallelization=yes -- ovn_monitor_all=yes;;
354;ovn.at:28730;Big Load Balancer -- parallelization=yes -- ovn_monitor_all=no;;
355;ovn.at:28761;Bind existing VIF -- parallelization=yes -- ovn_monitor_all=yes;;
356;ovn.at:28761;Bind existing VIF -- parallelization=yes -- ovn_monitor_all=no;;
357;ovn.at:28796;Release stale port binding -- parallelization=yes -- ovn_monitor_all=yes;;
358;ovn.at:28796;Release stale port binding -- parallelization=yes -- ovn_monitor_all=no;;
359;ovn.at:28827;Logical router policy packet marking -- parallelization=yes -- ovn_monitor_all=yes;;
360;ovn.at:28827;Logical router policy packet marking -- parallelization=yes -- ovn_monitor_all=no;;
361;ovn.at:29131;normalized lrp-add -- parallelization=yes -- ovn_monitor_all=yes;;
362;ovn.at:29131;normalized lrp-add -- parallelization=yes -- ovn_monitor_all=no;;
363;ovn.at:29142;normalized lr-nat-add -- parallelization=yes -- ovn_monitor_all=yes;;
364;ovn.at:29142;normalized lr-nat-add -- parallelization=yes -- ovn_monitor_all=no;;
365;ovn.at:29155;normalized lr-nat-del -- parallelization=yes -- ovn_monitor_all=yes;;
366;ovn.at:29155;normalized lr-nat-del -- parallelization=yes -- ovn_monitor_all=no;;
367;ovn.at:29168;Load balancer selection fields -- parallelization=yes -- ovn_monitor_all=yes;lb;
368;ovn.at:29168;Load balancer selection fields -- parallelization=yes -- ovn_monitor_all=no;lb;
369;ovn.at:29323;controller I-P handling with monitoring disabled -- parallelization=yes -- ovn_monitor_all=yes;;
370;ovn.at:29323;controller I-P handling with monitoring disabled -- parallelization=yes -- ovn_monitor_all=no;;
371;ovn.at:29461;controller I-P handling when lrp added last -- parallelization=yes -- ovn_monitor_all=yes;;
372;ovn.at:29461;controller I-P handling when lrp added last -- parallelization=yes -- ovn_monitor_all=no;;
373;ovn.at:29540;Test clear flows in physical tables -- parallelization=yes -- ovn_monitor_all=yes;;
374;ovn.at:29540;Test clear flows in physical tables -- parallelization=yes -- ovn_monitor_all=no;;
375;ovn.at:29647;Symmetric ECMP reply flows -- parallelization=yes -- ovn_monitor_all=yes;;
376;ovn.at:29647;Symmetric ECMP reply flows -- parallelization=yes -- ovn_monitor_all=no;;
377;ovn.at:29782;Symmetric IPv6 ECMP reply flows -- parallelization=yes -- ovn_monitor_all=yes;;
378;ovn.at:29782;Symmetric IPv6 ECMP reply flows -- parallelization=yes -- ovn_monitor_all=no;;
379;ovn.at:29913;Dynamic neighbor between LRs -- parallelization=yes -- ovn_monitor_all=yes;;
380;ovn.at:29913;Dynamic neighbor between LRs -- parallelization=yes -- ovn_monitor_all=no;;
381;ovn.at:30024;lflow cache operations -- parallelization=yes -- ovn_monitor_all=yes;;
382;ovn.at:30024;lflow cache operations -- parallelization=yes -- ovn_monitor_all=no;;
383;ovn.at:30104;Delete Port_Binding and OVS port Incremental Processing -- parallelization=yes -- ovn_monitor_all=yes;;
384;ovn.at:30104;Delete Port_Binding and OVS port Incremental Processing -- parallelization=yes -- ovn_monitor_all=no;;
385;ovn.at:30146;Multiple OVS port changes Incremental Processing;;
386;ovn.at:30218;Container port Incremental Processing;;
387;ovn.at:30432;gateway router drop traffic for own IPs -- parallelization=yes -- ovn_monitor_all=yes;;
388;ovn.at:30432;gateway router drop traffic for own IPs -- parallelization=yes -- ovn_monitor_all=no;;
389;ovn.at:30438;distributed gateway port drop traffic for own IPs -- parallelization=yes -- ovn_monitor_all=yes;;
390;ovn.at:30438;distributed gateway port drop traffic for own IPs -- parallelization=yes -- ovn_monitor_all=no;;
391;ovn.at:30444;nb_cfg timestamp -- parallelization=yes -- ovn_monitor_all=yes;unstable;
392;ovn.at:30444;nb_cfg timestamp -- parallelization=yes -- ovn_monitor_all=no;unstable;
393;ovn.at:30545;ARP replies for SNAT external ips -- parallelization=yes -- ovn_monitor_all=yes;slowtest unstable;
394;ovn.at:30545;ARP replies for SNAT external ips -- parallelization=yes -- ovn_monitor_all=no;slowtest unstable;
395;ovn.at:30816;conflict or duplicate ACLs resulting in same OVS match -- parallelization=yes -- ovn_monitor_all=yes;;
396;ovn.at:30816;conflict or duplicate ACLs resulting in same OVS match -- parallelization=yes -- ovn_monitor_all=no;;
397;ovn.at:30930;conflict ACLs with address set;unstable;
398;ovn.at:31022;port bind/unbind change handling with conj flows - IPv6 -- parallelization=yes -- ovn_monitor_all=yes;;
399;ovn.at:31022;port bind/unbind change handling with conj flows - IPv6 -- parallelization=yes -- ovn_monitor_all=no;;
400;ovn.at:31072;I-P of OVS interface changes which belong to non integration bridge -- parallelization=yes -- ovn_monitor_all=yes;;
401;ovn.at:31072;I-P of OVS interface changes which belong to non integration bridge -- parallelization=yes -- ovn_monitor_all=no;;
402;ovn.at:31127;multi-vtep SB Chassis encap updates -- parallelization=yes -- ovn_monitor_all=yes;unstable;
403;ovn.at:31127;multi-vtep SB Chassis encap updates -- parallelization=yes -- ovn_monitor_all=no;unstable;
404;ovn.at:31172;multiple encap ips selection based on VIF's encap_ip - L2 -- parallelization=yes -- ovn_monitor_all=yes;;
405;ovn.at:31172;multiple encap ips selection based on VIF's encap_ip - L2 -- parallelization=yes -- ovn_monitor_all=no;;
406;ovn.at:31268;multiple encap ips selection based on VIF's encap_ip - L3 -- parallelization=yes -- ovn_monitor_all=yes;;
407;ovn.at:31268;multiple encap ips selection based on VIF's encap_ip - L3 -- parallelization=yes -- ovn_monitor_all=no;;
408;ovn.at:31382;multiple encap ips selection for localnet packets -- parallelization=yes -- ovn_monitor_all=yes;;
409;ovn.at:31382;multiple encap ips selection for localnet packets -- parallelization=yes -- ovn_monitor_all=no;;
410;ovn.at:31487;Load Balancer LS hairpin OF flows -- parallelization=yes -- ovn_monitor_all=yes;;
411;ovn.at:31487;Load Balancer LS hairpin OF flows -- parallelization=yes -- ovn_monitor_all=no;;
412;ovn.at:32019;check ovn-northd and ovn-controller version pinning -- parallelization=yes -- ovn_monitor_all=yes;;
413;ovn.at:32019;check ovn-northd and ovn-controller version pinning -- parallelization=yes -- ovn_monitor_all=no;;
414;ovn.at:32165;propagate Port_Binding.up to NB and OVS -- parallelization=yes -- ovn_monitor_all=yes;;
415;ovn.at:32165;propagate Port_Binding.up to NB and OVS -- parallelization=yes -- ovn_monitor_all=no;;
416;ovn.at:32253;No ovn-controller assert for port group updates -- parallelization=yes -- ovn_monitor_all=yes;;
417;ovn.at:32253;No ovn-controller assert for port group updates -- parallelization=yes -- ovn_monitor_all=no;;
418;ovn.at:32337;No ovn-controller assert when generating conjunction flows -- parallelization=yes -- ovn_monitor_all=yes;;
419;ovn.at:32337;No ovn-controller assert when generating conjunction flows -- parallelization=yes -- ovn_monitor_all=no;;
420;ovn.at:32442;OVN FDB (MAC learning) - 3 HVs, 2 LS, 1 LR ;;
421;ovn.at:32909;container port changed to normal port and then deleted -- parallelization=yes -- ovn_monitor_all=yes;;
422;ovn.at:32909;container port changed to normal port and then deleted -- parallelization=yes -- ovn_monitor_all=no;;
423;ovn.at:33069;container port changed from one parent to another -- parallelization=yes -- ovn_monitor_all=yes;;
424;ovn.at:33069;container port changed from one parent to another -- parallelization=yes -- ovn_monitor_all=no;;
425;ovn.at:33126;container port use-after-free test -- parallelization=yes -- ovn_monitor_all=yes;;
426;ovn.at:33126;container port use-after-free test -- parallelization=yes -- ovn_monitor_all=no;;
427;ovn.at:33170;Non-VIF ports incremental processing -- parallelization=yes -- ovn_monitor_all=yes;;
428;ovn.at:33170;Non-VIF ports incremental processing -- parallelization=yes -- ovn_monitor_all=no;;
429;ovn.at:33253;ovn-controller local bindings -- parallelization=yes -- ovn_monitor_all=yes;;
430;ovn.at:33253;ovn-controller local bindings -- parallelization=yes -- ovn_monitor_all=no;;
431;ovn.at:33582;ACL with Port Group conjunction flow efficiency -- parallelization=yes -- ovn_monitor_all=yes;unstable;
432;ovn.at:33582;ACL with Port Group conjunction flow efficiency -- parallelization=yes -- ovn_monitor_all=no;unstable;
433;ovn.at:33701;ACL with Port Group including router ports -- parallelization=yes -- ovn_monitor_all=yes;;
434;ovn.at:33701;ACL with Port Group including router ports -- parallelization=yes -- ovn_monitor_all=no;;
435;ovn.at:33748;Static route with discard nexthop -- parallelization=yes -- ovn_monitor_all=yes;;
436;ovn.at:33748;Static route with discard nexthop -- parallelization=yes -- ovn_monitor_all=no;;
437;ovn.at:33843;proxy-arp: 1 HVs, 1 LSs, 1 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=yes;proxy-arp;
438;ovn.at:33843;proxy-arp: 1 HVs, 1 LSs, 1 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=no;proxy-arp;
439;ovn.at:34070;ACL referencing lport before creation -- parallelization=yes -- ovn_monitor_all=yes;;
440;ovn.at:34070;ACL referencing lport before creation -- parallelization=yes -- ovn_monitor_all=no;;
441;ovn.at:34143;ovn -- lr multiple gw ports -- parallelization=yes -- ovn_monitor_all=yes;multiple-l3dgw-ports;
442;ovn.at:34143;ovn -- lr multiple gw ports -- parallelization=yes -- ovn_monitor_all=no;multiple-l3dgw-ports;
443;ovn.at:34495;Dont flood fill local datapaths beyond distributed gateway port -- parallelization=yes -- ovn_monitor_all=yes;;
444;ovn.at:34495;Dont flood fill local datapaths beyond distributed gateway port -- parallelization=yes -- ovn_monitor_all=no;;
445;ovn.at:34556;ovn-controller port binding with iface-id-ver -- parallelization=yes -- ovn_monitor_all=yes;;
446;ovn.at:34556;ovn-controller port binding with iface-id-ver -- parallelization=yes -- ovn_monitor_all=no;;
447;ovn.at:34698;ovn-controller ct zone I-P handling -- parallelization=yes -- ovn_monitor_all=yes;;
448;ovn.at:34698;ovn-controller ct zone I-P handling -- parallelization=yes -- ovn_monitor_all=no;;
449;ovn.at:34781;ovn-controller requested-chassis localport -- parallelization=yes -- ovn_monitor_all=yes;;
450;ovn.at:34781;ovn-controller requested-chassis localport -- parallelization=yes -- ovn_monitor_all=no;;
451;ovn.at:34848;ovn-controller - requested-chassis claim lport on startup -- parallelization=yes -- ovn_monitor_all=yes;;
452;ovn.at:34848;ovn-controller - requested-chassis claim lport on startup -- parallelization=yes -- ovn_monitor_all=no;;
453;ovn.at:34900;ovn-controller - VIF plugging -- parallelization=yes -- ovn_monitor_all=yes;vif-plug;
454;ovn.at:34900;ovn-controller - VIF plugging -- parallelization=yes -- ovn_monitor_all=no;vif-plug;
455;ovn.at:35027;ovn-controller - check meters update -- parallelization=yes -- ovn_monitor_all=yes;meters-update;
456;ovn.at:35027;ovn-controller - check meters update -- parallelization=yes -- ovn_monitor_all=no;meters-update;
457;ovn.at:35105;ovn -- lr static_mac_binding;static_mac_binding;
458;ovn.at:35195;ovn -- lr mac_binding I-P update -- parallelization=yes -- ovn_monitor_all=yes;mac_binding;
459;ovn.at:35195;ovn -- lr mac_binding I-P update -- parallelization=yes -- ovn_monitor_all=no;mac_binding;
460;ovn.at:35285;ovn-controller port security OF flows -- parallelization=yes -- ovn_monitor_all=yes;;
461;ovn.at:35285;ovn-controller port security OF flows -- parallelization=yes -- ovn_monitor_all=no;;
462;ovn.at:35578;snat-ct-zone with common NAT zone;;
463;ovn.at:35663;OVN FDB (MAC learning) - Localnet -- parallelization=yes -- ovn_monitor_all=yes;;
464;ovn.at:35663;OVN FDB (MAC learning) - Localnet -- parallelization=yes -- ovn_monitor_all=no;;
465;ovn.at:35732;MAC binding aging -- parallelization=yes -- ovn_monitor_all=yes;;
466;ovn.at:35732;MAC binding aging -- parallelization=yes -- ovn_monitor_all=no;;
467;ovn.at:36012;MAC binding aging - port deletion -- parallelization=yes -- ovn_monitor_all=yes;;
468;ovn.at:36012;MAC binding aging - port deletion -- parallelization=yes -- ovn_monitor_all=no;;
469;ovn.at:36112;MAC binding aging - persistence of the active entry -- parallelization=yes -- ovn_monitor_all=yes;;
470;ovn.at:36112;MAC binding aging - persistence of the active entry -- parallelization=yes -- ovn_monitor_all=no;;
471;ovn.at:36195;MAC binding aging - probing -- parallelization=yes -- ovn_monitor_all=yes;;
472;ovn.at:36195;MAC binding aging - probing -- parallelization=yes -- ovn_monitor_all=no;;
473;ovn.at:36364;MAC binding aging - probing GW router Dynamic Neigh -- parallelization=yes -- ovn_monitor_all=yes;;
474;ovn.at:36364;MAC binding aging - probing GW router Dynamic Neigh -- parallelization=yes -- ovn_monitor_all=no;;
475;ovn.at:36511;router port type update and then remove -- parallelization=yes -- ovn_monitor_all=yes;;
476;ovn.at:36511;router port type update and then remove -- parallelization=yes -- ovn_monitor_all=no;;
477;ovn.at:36555;recomputes -- parallelization=yes -- ovn_monitor_all=yes;unstable;
478;ovn.at:36555;recomputes -- parallelization=yes -- ovn_monitor_all=no;unstable;
479;ovn.at:36611;router port add then remove - lsp first -- parallelization=yes -- ovn_monitor_all=yes;;
480;ovn.at:36611;router port add then remove - lsp first -- parallelization=yes -- ovn_monitor_all=no;;
481;ovn.at:36643;router port add then remove - distributed router gateway port -- parallelization=yes -- ovn_monitor_all=yes;;
482;ovn.at:36643;router port add then remove - distributed router gateway port -- parallelization=yes -- ovn_monitor_all=no;;
483;ovn.at:36703;ovn-controller: deleting a port being claimed -- parallelization=yes -- ovn_monitor_all=yes;;
484;ovn.at:36703;ovn-controller: deleting a port being claimed -- parallelization=yes -- ovn_monitor_all=no;;
485;ovn.at:36740;ovn-controller: checking flows after delaying port claims -- parallelization=yes -- ovn_monitor_all=yes;;
486;ovn.at:36740;ovn-controller: checking flows after delaying port claims -- parallelization=yes -- ovn_monitor_all=no;;
487;ovn.at:36795;ovn-controller: batch add port and delete port in same IDL -- parallelization=yes -- ovn_monitor_all=yes;;
488;ovn.at:36795;ovn-controller: batch add port and delete port in same IDL -- parallelization=yes -- ovn_monitor_all=no;;
489;ovn.at:36986;ovn-controller: Multiple OVS interfaces bound to same logical port (localport) -- parallelization=yes -- ovn_monitor_all=yes;;
490;ovn.at:36986;ovn-controller: Multiple OVS interfaces bound to same logical port (localport) -- parallelization=yes -- ovn_monitor_all=no;;
491;ovn.at:36987;ovn-controller: Multiple OVS interfaces bound to same logical port () -- parallelization=yes -- ovn_monitor_all=yes;;
492;ovn.at:36987;ovn-controller: Multiple OVS interfaces bound to same logical port () -- parallelization=yes -- ovn_monitor_all=no;;
493;ovn.at:36989;Check default openflow flows -- parallelization=yes -- ovn_monitor_all=yes;unstable;
494;ovn.at:36989;Check default openflow flows -- parallelization=yes -- ovn_monitor_all=no;unstable;
495;ovn.at:37225;Logical flows with Chassis_Template_Var references -- parallelization=yes -- ovn_monitor_all=yes;templates;
496;ovn.at:37225;Logical flows with Chassis_Template_Var references -- parallelization=yes -- ovn_monitor_all=no;templates;
497;ovn.at:37313;Load balancers with Chassis_Template_Var references -- parallelization=yes -- ovn_monitor_all=yes;templates;
498;ovn.at:37313;Load balancers with Chassis_Template_Var references -- parallelization=yes -- ovn_monitor_all=no;templates;
499;ovn.at:37488;ovn-chassis-idx maintenance in ovsdb -- parallelization=yes -- ovn_monitor_all=yes;;
500;ovn.at:37488;ovn-chassis-idx maintenance in ovsdb -- parallelization=yes -- ovn_monitor_all=no;;
501;ovn.at:37521;chassis-specific configuration options -- parallelization=yes -- ovn_monitor_all=yes;;
502;ovn.at:37521;chassis-specific configuration options -- parallelization=yes -- ovn_monitor_all=no;;
503;ovn.at:37556;chassis name override via file -- parallelization=yes -- ovn_monitor_all=yes;;
504;ovn.at:37556;chassis name override via file -- parallelization=yes -- ovn_monitor_all=no;;
505;ovn.at:37592;chassis name override via CLI -- parallelization=yes -- ovn_monitor_all=yes;;
506;ovn.at:37592;chassis name override via CLI -- parallelization=yes -- ovn_monitor_all=no;;
507;ovn.at:37631;controllers don't touch tunnels that are not on br-int -- parallelization=yes -- ovn_monitor_all=yes;;
508;ovn.at:37631;controllers don't touch tunnels that are not on br-int -- parallelization=yes -- ovn_monitor_all=no;;
509;ovn.at:37690;ovn-controller deletes OVN patch ports for its integration bridge only -- parallelization=yes -- ovn_monitor_all=yes;;
510;ovn.at:37690;ovn-controller deletes OVN patch ports for its integration bridge only -- parallelization=yes -- ovn_monitor_all=no;;
511;ovn.at:37742;ovn-controller update network_name option for localnet port -- parallelization=yes -- ovn_monitor_all=yes;;
512;ovn.at:37742;ovn-controller update network_name option for localnet port -- parallelization=yes -- ovn_monitor_all=no;;
513;ovn.at:37856;multiple controllers on the same host can talk to each other -- parallelization=yes -- ovn_monitor_all=yes;;
514;ovn.at:37856;multiple controllers on the same host can talk to each other -- parallelization=yes -- ovn_monitor_all=no;;
515;ovn.at:37957;CT flush load balancer backends -- parallelization=yes -- ovn_monitor_all=yes;;
516;ovn.at:37957;CT flush load balancer backends -- parallelization=yes -- ovn_monitor_all=no;;
517;ovn.at:38046;Re-create encap tunnels during integration bridge migration -- parallelization=yes -- ovn_monitor_all=yes;;
518;ovn.at:38046;Re-create encap tunnels during integration bridge migration -- parallelization=yes -- ovn_monitor_all=no;;
519;ovn.at:38145;Encaps tunnel cleanup does not interfere with multiple controller on the same host -- parallelization=yes -- ovn_monitor_all=yes;;
520;ovn.at:38145;Encaps tunnel cleanup does not interfere with multiple controller on the same host -- parallelization=yes -- ovn_monitor_all=no;;
521;ovn.at:38227;OVN QoS -- parallelization=yes -- ovn_monitor_all=yes;;
522;ovn.at:38227;OVN QoS -- parallelization=yes -- ovn_monitor_all=no;;
523;ovn.at:38422;FDB aging -- parallelization=yes -- ovn_monitor_all=yes;;
524;ovn.at:38422;FDB aging -- parallelization=yes -- ovn_monitor_all=no;;
525;ovn.at:38502;FDB aging - persistence of the active entry -- parallelization=yes -- ovn_monitor_all=yes;;
526;ovn.at:38502;FDB aging - persistence of the active entry -- parallelization=yes -- ovn_monitor_all=no;;
527;ovn.at:38584;DNAT_SNAT and LB traffic -- parallelization=yes -- ovn_monitor_all=yes;dnat-snat-lb;
528;ovn.at:38584;DNAT_SNAT and LB traffic -- parallelization=yes -- ovn_monitor_all=no;dnat-snat-lb;
529;ovn.at:38703;OVN QoS port deletion -- parallelization=yes -- ovn_monitor_all=yes;;
530;ovn.at:38703;OVN QoS port deletion -- parallelization=yes -- ovn_monitor_all=no;;
531;ovn.at:38773;ovn-install and recomputes -- parallelization=yes -- ovn_monitor_all=yes;ovn-install;
532;ovn.at:38773;ovn-install and recomputes -- parallelization=yes -- ovn_monitor_all=no;ovn-install;
533;ovn.at:38843;Add and delete port -- parallelization=yes -- ovn_monitor_all=yes;;
534;ovn.at:38843;Add and delete port -- parallelization=yes -- ovn_monitor_all=no;;
535;ovn.at:38870;Migration of CT zone from UUID to name -- parallelization=yes -- ovn_monitor_all=yes;;
536;ovn.at:38870;Migration of CT zone from UUID to name -- parallelization=yes -- ovn_monitor_all=no;;
537;ovn.at:39034;multicast group buffer split -- parallelization=yes -- ovn_monitor_all=yes;ovn-mc-split;
538;ovn.at:39034;multicast group buffer split -- parallelization=yes -- ovn_monitor_all=no;ovn-mc-split;
539;ovn.at:39093;virtual port claim race condition -- parallelization=yes -- ovn_monitor_all=yes;virtual ports;
540;ovn.at:39093;virtual port claim race condition -- parallelization=yes -- ovn_monitor_all=no;virtual ports;
541;ovn.at:39176;pod to pod with localnet_learn_fdb -- parallelization=yes -- ovn_monitor_all=yes;;
542;ovn.at:39176;pod to pod with localnet_learn_fdb -- parallelization=yes -- ovn_monitor_all=no;;
543;ovn.at:39476;port up with slow northd -- parallelization=yes;;
544;ovn.at:39521;gratuitous arp max timeout -- parallelization=yes -- ovn_monitor_all=yes;slowtest unstable;
545;ovn.at:39521;gratuitous arp max timeout -- parallelization=yes -- ovn_monitor_all=no;slowtest unstable;
546;ovn.at:39585;Changing tunnel_key -- parallelization=yes -- ovn_monitor_all=yes;;
547;ovn.at:39585;Changing tunnel_key -- parallelization=yes -- ovn_monitor_all=no;;
548;ovn.at:39680;read-only sb db:pssl access with ssl-ciphers/uites and ssl-protocols;;
549;ovn.at:39748;nb connection/ssl commands with ssl-ciphers/uites and ssl-protocols;;
550;ovn.at:39815;sb connection/ssl commands with ssl-ciphers/uites and ssl-protocols;;
551;ovn.at:39882;QoS packet marking -- parallelization=yes -- ovn_monitor_all=yes;ovn-qos-pkt-marking;
552;ovn.at:39882;QoS packet marking -- parallelization=yes -- ovn_monitor_all=no;ovn-qos-pkt-marking;
553;ovn.at:39965;ovn-controller - cleanup VIF/CIF related flows/fields when updating requested-chassis -- parallelization=yes -- ovn_monitor_all=yes;;
554;ovn.at:39965;ovn-controller - cleanup VIF/CIF related flows/fields when updating requested-chassis -- parallelization=yes -- ovn_monitor_all=no;;
555;ovn.at:40031;DHCP RELAY -- parallelization=yes -- ovn_monitor_all=yes;;
556;ovn.at:40031;DHCP RELAY -- parallelization=yes -- ovn_monitor_all=no;;
557;ovn.at:40355;Provider network - always tunnel -- parallelization=yes -- ovn_monitor_all=yes;;
558;ovn.at:40355;Provider network - always tunnel -- parallelization=yes -- ovn_monitor_all=no;;
559;ovn.at:40512;Delete parent of container port -- parallelization=yes -- ovn_monitor_all=yes;;
560;ovn.at:40512;Delete parent of container port -- parallelization=yes -- ovn_monitor_all=no;;
561;ovn.at:40546;Deleting vif while controller fight for port claim -- parallelization=yes -- ovn_monitor_all=yes;;
562;ovn.at:40546;Deleting vif while controller fight for port claim -- parallelization=yes -- ovn_monitor_all=no;;
563;ovn.at:40604;IPv6 switching - megaflow check for IPv6 src/dst matches -- parallelization=yes -- ovn_monitor_all=yes;;
564;ovn.at:40604;IPv6 switching - megaflow check for IPv6 src/dst matches -- parallelization=yes -- ovn_monitor_all=no;;
565;ovn.at:40770;Multichassis port I-P processing -- parallelization=yes -- ovn_monitor_all=yes;;
566;ovn.at:40770;Multichassis port I-P processing -- parallelization=yes -- ovn_monitor_all=no;;
567;ovn.at:40839;ct_zones -- parallelization=yes -- ovn_monitor_all=yes;ct_zones;
568;ovn.at:40839;ct_zones -- parallelization=yes -- ovn_monitor_all=no;ct_zones;
569;ovn.at:40981;ovn-controller - vif-plug transaction failures -- parallelization=yes -- ovn_monitor_all=yes;vif-plug;
570;ovn.at:40981;ovn-controller - vif-plug transaction failures -- parallelization=yes -- ovn_monitor_all=no;vif-plug;
571;ovn.at:41034;Patch ports not owned by OVN;ovn;
572;ovn.at:41148;Multiple localnet ports without vlans -- parallelization=yes -- ovn_monitor_all=yes;localnet;
573;ovn.at:41148;Multiple localnet ports without vlans -- parallelization=yes -- ovn_monitor_all=no;localnet;
574;ovn.at:41207;Multichassis port with remote chassis -- parallelization=yes -- ovn_monitor_all=yes;;
575;ovn.at:41207;Multichassis port with remote chassis -- parallelization=yes -- ovn_monitor_all=no;;
576;ovn.at:41259;Port Deleted and added back -- parallelization=yes -- ovn_monitor_all=yes;;
577;ovn.at:41259;Port Deleted and added back -- parallelization=yes -- ovn_monitor_all=no;;
578;ovn.at:41302;Remote port with explicit SB chassis -- parallelization=yes -- ovn_monitor_all=yes;;
579;ovn.at:41302;Remote port with explicit SB chassis -- parallelization=yes -- ovn_monitor_all=no;;
580;ovn.at:41334;2 HVs, 2 LS, 1 lport/LS, 2 peer LRs, IPv4 over IPv6 -- parallelization=yes -- ovn_monitor_all=yes;;
581;ovn.at:41334;2 HVs, 2 LS, 1 lport/LS, 2 peer LRs, IPv4 over IPv6 -- parallelization=yes -- ovn_monitor_all=no;;
582;ovn.at:41454;2 HVs, 2 LS, 1 lport/LS, LRs connected via LS, IPv4 over IPv6 -- parallelization=yes -- ovn_monitor_all=yes;;
583;ovn.at:41454;2 HVs, 2 LS, 1 lport/LS, LRs connected via LS, IPv4 over IPv6 -- parallelization=yes -- ovn_monitor_all=no;;
584;ovn.at:41582;2 HVs, 2 LS, 1 lport/LS, LRs connected via LS, IPv4 over IPv6, static mac -- parallelization=yes -- ovn_monitor_all=yes;;
585;ovn.at:41582;2 HVs, 2 LS, 1 lport/LS, LRs connected via LS, IPv4 over IPv6, static mac -- parallelization=yes -- ovn_monitor_all=no;;
586;ovn.at:41716;2 HVs, 2 LS, 1 lport/LS, LRs connected via LS, IPv4 over IPv6, dynamic -- parallelization=yes -- ovn_monitor_all=yes;;
587;ovn.at:41716;2 HVs, 2 LS, 1 lport/LS, LRs connected via LS, IPv4 over IPv6, dynamic -- parallelization=yes -- ovn_monitor_all=no;;
588;ovn.at:41846;2 HVs, 2 LS, 1 lport/LS, LRs connected via LS, IPv6 over IPv4, dynamic -- parallelization=yes -- ovn_monitor_all=yes;;
589;ovn.at:41846;2 HVs, 2 LS, 1 lport/LS, LRs connected via LS, IPv6 over IPv4, dynamic -- parallelization=yes -- ovn_monitor_all=no;;
590;ovn.at:41976;2 HVs, 2 LS, 1 lport/LS, LRs connected via LS, IPv4 over IPv6, ECMP -- parallelization=yes -- ovn_monitor_all=yes;;
591;ovn.at:41976;2 HVs, 2 LS, 1 lport/LS, LRs connected via LS, IPv4 over IPv6, ECMP -- parallelization=yes -- ovn_monitor_all=no;;
592;ovn.at:42119;2 HVs, 2 LS, 1 lport/LS, 2 peer LRs, IPv6 over IPv4 -- parallelization=yes -- ovn_monitor_all=yes;;
593;ovn.at:42119;2 HVs, 2 LS, 1 lport/LS, 2 peer LRs, IPv6 over IPv4 -- parallelization=yes -- ovn_monitor_all=no;;
594;ovn.at:42239;DNS reply packet with ACL to drop it -- parallelization=yes -- ovn_monitor_all=yes;;
595;ovn.at:42239;DNS reply packet with ACL to drop it -- parallelization=yes -- ovn_monitor_all=no;;
596;ovn.at:42327;localnet port flows after deletion -- parallelization=yes -- ovn_monitor_all=yes;;
597;ovn.at:42327;localnet port flows after deletion -- parallelization=yes -- ovn_monitor_all=no;;
598;ovn.at:42384;Switch from Distributed Router to Gateway Router -- parallelization=yes;;
599;ovn.at:42414;requested-tnl-key-recompute -- parallelization=yes -- ovn_monitor_all=yes;requested-tnl-key-recompute;
600;ovn.at:42414;requested-tnl-key-recompute -- parallelization=yes -- ovn_monitor_all=no;requested-tnl-key-recompute;
601;ovn.at:42461;ACL Conntrack ID propagation -- parallelization=yes -- ovn_monitor_all=yes;;
602;ovn.at:42461;ACL Conntrack ID propagation -- parallelization=yes -- ovn_monitor_all=no;;
603;ovn.at:42504;Load balancer hairpin flows -- parallelization=yes -- ovn_monitor_all=yes;lb;
604;ovn.at:42504;Load balancer hairpin flows -- parallelization=yes -- ovn_monitor_all=no;lb;
605;ovn.at:42588;lb_force_snat_ip=router_ip select correct network for snat -- parallelization=yes -- ovn_monitor_all=yes;;
606;ovn.at:42588;lb_force_snat_ip=router_ip select correct network for snat -- parallelization=yes -- ovn_monitor_all=no;;
607;ovn-performance.at:227;ovn-controller incremental processing;unstable;
608;ovn-northd.at:120;check from NBDB to SBDB -- parallelization=yes;;
609;ovn-northd.at:191;check up state of VIF LSP -- parallelization=yes;;
610;ovn-northd.at:206;check up state of switch-switch LSP -- parallelization=yes;;
611;ovn-northd.at:223;check up state of router LSP linked to a distributed LR -- parallelization=yes;;
612;ovn-northd.at:240;check up state of router LSP linked to a gateway LR -- parallelization=yes;;
613;ovn-northd.at:261;check up state of router LSP linked to an LRP with set Gateway Chassis -- parallelization=yes;;
614;ovn-northd.at:281;check Logical Router Port hosting-chassis status -- parallelization=yes;;
615;ovn-northd.at:327;check LRP external id propagation to SBDB -- parallelization=yes;;
616;ovn-northd.at:339;check IPv6 RA config propagation to SBDB -- parallelization=yes;;
617;ovn-northd.at:451;test unixctl -- parallelization=yes;;
618;ovn-northd.at:492;check HA_Chassis_Group propagation from NBDB to SBDB -- parallelization=yes;;
619;ovn-northd.at:849;ovn-northd pause and resume -- parallelization=yes;;
620;ovn-northd.at:926;ovn-northd restart -- parallelization=yes;;
621;ovn-northd.at:953;northbound database reconnection -- parallelization=yes;;
622;ovn-northd.at:989;southbound database reconnection -- parallelization=yes;;
623;ovn-northd.at:1023;check Redirect Chassis propagation from NB to SB -- parallelization=yes;;
624;ovn-northd.at:1048;check stateless dnat_and_snat rule -- parallelization=yes;;
625;ovn-northd.at:1132;check portrange dnat, snat and dnat_and_snat rules -- parallelization=yes;;
626;ovn-northd.at:1184;check allowed/disallowed external dnat, snat and dnat_and_snat rules -- parallelization=yes;;
627;ovn-northd.at:1430;check Load balancer health check and Service Monitor sync -- parallelization=yes;;
628;ovn-northd.at:1694;Load balancer VIP in NAT entries -- parallelization=yes;;
629;ovn-northd.at:1763;LRP same IP as VIP or SNAT -- parallelization=yes;;
630;ovn-northd.at:1849;DNAT force snat IP -- parallelization=yes;;
631;ovn-northd.at:1870;check reconcile stale Datapath_Binding -- parallelization=yes;;
632;ovn-northd.at:1898;check reconcile stale tunnel keys -- parallelization=yes;;
633;ovn-northd.at:1922;check reconcile stale Ha_Chassis_Group -- parallelization=yes;;
634;ovn-northd.at:1950;check NB/SB Port_Group translation (lsp add/del) -- parallelization=yes;;
635;ovn-northd.at:2000;check NB/SB Port_Group translation (ls del) -- parallelization=yes;;
636;ovn-northd.at:2027;check router ARP/NS responder -- parallelization=yes;;
637;ovn-northd.at:2270;Load balancer - missing ls_out_pre_lb flows -- parallelization=yes;;
638;ovn-northd.at:2371;ignore_lsp_down -- parallelization=yes;;
639;ovn-northd.at:2388;ovn-northd -- reject ACL -- parallelization=yes;;
640;ovn-northd.at:2462;ACL fair Meters -- parallelization=yes;acl log meter fair;
641;ovn-northd.at:2593;Check NB-SB mirrors sync -- parallelization=yes;mirrors;
642;ovn-northd.at:2698;ACL skip hints for stateless config -- parallelization=yes;acl;
643;ovn-northd.at:2816;datapath requested-tnl-key -- parallelization=yes;requested tnl tunnel key keys;
644;ovn-northd.at:2863;LR requested-tnl-key -- parallelization=yes;;
645;ovn-northd.at:2883;port requested-tnl-key -- parallelization=yes;requested tnl tunnel key keys;
646;ovn-northd.at:2941;check VXLAN mode disabling -- parallelization=yes;;
647;ovn-northd.at:2975;check datapath tunnel ids exhaustion -- parallelization=yes;;
648;ovn-northd.at:3005;check port tunnel ids exhaustion; vxlan chassis pops up midflight -- parallelization=yes;;
649;ovn-northd.at:3036;check VXLAN encap in IC-mode -- parallelization=yes;;
650;ovn-northd.at:3060;Logical Flow Datapath Groups -- parallelization=yes;;
651;ovn-northd.at:3135;NB to SB load balancer sync -- parallelization=yes;;
652;ovn-northd.at:3402;LS load balancer hairpin logical flows -- parallelization=yes;;
653;ovn-northd.at:3474;Router policies - ECMP reroute -- parallelization=yes;router policies ecmp reroute;
654;ovn-northd.at:3613;Router policies - chains -- parallelization=yes;;
655;ovn-northd.at:3640;ACL allow-stateless omit conntrack - Logical_Switch -- parallelization=yes;;
656;ovn-northd.at:3773;ACL allow-stateless omit conntrack - Port_Group -- parallelization=yes;;
657;ovn-northd.at:3909;ACL allow-stateless overrides stateful rules with higher priority - Logical_Switch -- parallelization=yes;;
658;ovn-northd.at:3964;check BFD config propagation to SBDB -- parallelization=yes;northd-bfd;
659;ovn-northd.at:4113;ovn -- check CoPP config -- parallelization=yes;northd-copp;
660;ovn-northd.at:4296;check LSP attached to multiple LS -- parallelization=yes;;
661;ovn-northd.at:4314;check LRP attached to multiple LR -- parallelization=yes;;
662;ovn-northd.at:4332;check duplicate LSP/LRP -- parallelization=yes;;
663;ovn-northd.at:4347;Load Balancers and lb_force_snat_ip for Gateway Routers -- parallelization=yes;;
664;ovn-northd.at:4347;Load Balancers and lb_force_snat_ip for Gateway Routers -- parallelization=no;;
665;ovn-northd.at:4630;HA chassis group cleanup for external port  -- parallelization=yes;;
666;ovn-northd.at:4672;FDB cleanup -- parallelization=yes;;
667;ovn-northd.at:4734;LS load balancer logical flows -- parallelization=yes;;
668;ovn-northd.at:4901;ovn -- ACL label usage -- parallelization=yes;;
669;ovn-northd.at:4901;ovn -- ACL label usage -- parallelization=no;;
670;ovn-northd.at:4994;ovn -- ACL label commit - load balancers -- parallelization=yes;;
671;ovn-northd.at:5039;ovn -- ct.inv usage -- parallelization=yes;;
672;ovn-northd.at:5039;ovn -- ct.inv usage -- parallelization=no;;
673;ovn-northd.at:5122;northd ssl/tls file change -- parallelization=yes;unstable;
674;ovn-northd.at:5176;trace with IPv4 dnat -- parallelization=yes;dnat;
675;ovn-northd.at:5215;trace with IPv6 dnat -- parallelization=yes;dnat;
676;ovn-northd.at:5254;DHCP options -- parallelization=yes;dnat;
677;ovn-northd.at:5301;ovn -- NAT and Load Balancer flows -- parallelization=yes;;
678;ovn-northd.at:5573;ovn -- ARP flows for unreachable addresses - NAT and LB -- parallelization=yes;;
679;ovn-northd.at:5573;ovn -- ARP flows for unreachable addresses - NAT and LB -- parallelization=no;;
680;ovn-northd.at:5792;ovn -- LR NAT flows -- parallelization=yes;;
681;ovn-northd.at:5792;ovn -- LR NAT flows -- parallelization=no;;
682;ovn-northd.at:6612;Load Balancer SB duplicates -- parallelization=yes;;
683;ovn-northd.at:6612;Load Balancer SB duplicates -- parallelization=no;;
684;ovn-northd.at:6630;ovn -- Add tags to logical flows -- parallelization=yes;;
685;ovn-northd.at:6657;ovn -- gateway mtu check pkt larger flows -- parallelization=yes;;
686;ovn-northd.at:6951;ovn -- static routes flows -- parallelization=yes;static-routes-flows;
687;ovn-northd.at:7107;ovn -- static routes multiple address families flows -- parallelization=yes;static-routes-flows;
688;ovn-northd.at:7167;ovn-northd -- lr multiple gw ports -- parallelization=yes;multiple-l3dgw-ports;
689;ovn-northd.at:7252;ovn-northd -- lrp with chassis-redirect and ls with vtep lport -- parallelization=yes;multiple-l3dgw-ports;
690;ovn-northd.at:7348;check options:requested-chassis fills requested_chassis col -- parallelization=yes;;
691;ovn-northd.at:7394;check options: force_fdb_lookup for LSP -- parallelization=yes;;
692;ovn-northd.at:7432;check options:pkt_clone_type for LSP -- parallelization=yes;;
693;ovn-northd.at:7471;implicit unknown addresses on switch-switch LSPs -- parallelization=yes;;
694;ovn-northd.at:7549;handling duplicated datapaths -- parallelization=yes;;
695;ovn-northd.at:7566;conntrack nat implies conntrack -- parallelization=yes;;
696;ovn-northd.at:7606;route tables -- flows -- parallelization=yes;route-tables-flows;
697;ovn-northd.at:7606;route tables -- flows -- parallelization=no;route-tables-flows;
698;ovn-northd.at:7673;check exclude-lb-vips-from-garp option -- parallelization=yes;;
699;ovn-northd.at:7706;check broadcast-arps-to-all-routers option -- parallelization=yes;;
700;ovn-northd.at:7738;ACL log replies -- flows -- parallelization=yes;;
701;ovn-northd.at:7989;Static IP multicast report forwarding -- parallelization=yes;;
702;ovn-northd.at:8033;ACLs after lb -- parallelization=yes;acl;
703;ovn-northd.at:8033;ACLs after lb -- parallelization=no;acl;
704;ovn-northd.at:8222;ovn-northd -- lr multiple gw ports NAT -- parallelization=yes;multiple-l3dgw-ports;
705;ovn-northd.at:8222;ovn-northd -- lr multiple gw ports NAT -- parallelization=no;multiple-l3dgw-ports;
706;ovn-northd.at:8426;LR NB Static_MAC_Binding table -- parallelization=yes;;
707;ovn-northd.at:8454;LR NB Static_MAC_Binding garbage collection -- parallelization=yes;;
708;ovn-northd.at:8467;LR neighbor lookup and learning flows -- parallelization=yes;;
709;ovn-northd.at:8494;LS default ACL drop -- parallelization=yes;acl;
710;ovn-northd.at:8494;LS default ACL drop -- parallelization=no;acl;
711;ovn-northd.at:9193;northd-parallelization unixctl -- parallelization=yes;;
712;ovn-northd.at:9237;northd-parallelization runtime -- parallelization=yes;;
713;ovn-northd.at:9305;Port security lflows -- parallelization=yes;;
714;ovn-northd.at:9512;Localnet MAC learning option -- parallelization=yes;;
715;ovn-northd.at:9549;check install_ls_lb_from_router option -- parallelization=yes;lb-ls-install-from-lrouter;
716;ovn-northd.at:9643;check fip flows with redirect-type bridged -- parallelization=yes;fip-redirect-type-bridged;
717;ovn-northd.at:9681;check lb-affinity flows -- parallelization=yes;lb-affinity-flows;
718;ovn-northd.at:9871;check options:disable_arp_nd_rsp for LSP -- parallelization=yes;;
719;ovn-northd.at:9902;Address set incremental processing -- parallelization=yes;;
720;ovn-northd.at:10006;Port group incremental processing -- parallelization=yes;;
721;ovn-northd.at:10368;Check default drop -- parallelization=yes -- ovn_monitor_all=yes;drop;
722;ovn-northd.at:10368;Check default drop -- parallelization=yes -- ovn_monitor_all=no;drop;
723;ovn-northd.at:10499;NB to SB Chassis_Template_Var propagation -- parallelization=yes;templates;
724;ovn-northd.at:10544;Chassis-feature compatibitility - remote chassis -- parallelization=yes;;
725;ovn-northd.at:10572;check OVN QoS -- parallelization=yes;ovn-qos;
726;ovn-northd.at:10594;check OVN QoS mark/meter logical flows -- parallelization=yes;ovn-qos;
727;ovn-northd.at:10629;Tiered ACL logical flows;acl;
728;ovn-northd.at:10755;ACL \"pass\" logical flows -- parallelization=yes;acl;
729;ovn-northd.at:10801;ACL - ct state clear on router ports -- parallelization=yes;acl;
730;ovn-northd.at:10867;Localnet ports on LS with LB;;
731;ovn-northd.at:10928;sync_to_sb_lb incremental processing -- parallelization=yes;;
732;ovn-northd.at:10949;LSP incremental processing -- parallelization=yes;;
733;ovn-northd.at:11065;LSP incremental processing with only router ports before and after adding a VIF -- parallelization=yes;;
734;ovn-northd.at:11107;LSP incremental processing fallback to recompute -- parallelization=yes;;
735;ovn-northd.at:11156;SB Port binding incremental processing -- parallelization=yes;;
736;ovn-northd.at:11281;ACL/Meter incremental processing - no northd recompute -- parallelization=yes;;
737;ovn-northd.at:11316;check fip and lb flows -- parallelization=yes;fip-lb-flows;
738;ovn-northd.at:11366;Remote port binding -- parallelization=yes;remote-port-binding;
739;ovn-northd.at:11433;Load balancer incremental processing -- parallelization=yes;;
740;ovn-northd.at:12075;Load balancer incremental processing - batched updates -- parallelization=yes;;
741;ovn-northd.at:12128;Distributed gw port enable conntrack option -- parallelization=yes;;
742;ovn-northd.at:12256;Load balancer incremental processing with stateless ACLs -- parallelization=yes;;
743;ovn-northd.at:12298;Load balancer incremental processing for multiple LBs with same VIPs -- parallelization=yes;;
744;ovn-northd.at:12519;Logical router incremental processing for NAT -- parallelization=yes;;
745;ovn-northd.at:12767;check QoS table configuration -- parallelization=yes;;
746;ovn-northd.at:12813;check DHCP RELAY -- parallelization=yes;;
747;ovn-northd.at:12885;check for flow_desc -- parallelization=yes;;
748;ovn-northd.at:12900;NB_Global and SB_Global incremental processing;;
749;ovn-northd.at:13075;Sampling_App incremental processing -- parallelization=yes;;
750;ovn-northd.at:13094;Sampling_App override debug_drop_domain_id -- parallelization=yes;;
751;ovn-northd.at:13118;ACL Sampling -- parallelization=yes;acl;
752;ovn-northd.at:13337;ACL Sampling - Generic sample -- parallelization=yes;acl;
753;ovn-northd.at:13611;ACL Sampling - same collector set id, multiple probabilities -- parallelization=yes;acl;
754;ovn-northd.at:13671;NAT with match -- parallelization=yes;;
755;ovn-northd.at:13726;NAT on a provider network with no localnet ports -- parallelization=yes;nat;
756;ovn-northd.at:14185;Routing protocol control plane redirect -- parallelization=yes;;
757;ovn-northd.at:14278;Load balancer with Distributed Gateway Ports (LB + DGP + NAT Stateless) -- parallelization=yes;;
758;ovn-northd.at:14278;Load balancer with Distributed Gateway Ports (LB + DGP + NAT Stateless) -- parallelization=no;;
759;ovn-northd.at:14392;Load balancer with Distributed Gateway Ports (LB + DGP + NAT Stateless) - IPv6 -- parallelization=yes;;
760;ovn-northd.at:14392;Load balancer with Distributed Gateway Ports (LB + DGP + NAT Stateless) - IPv6 -- parallelization=no;;
761;ovn-northd.at:14506;Load balancer with Distributed Gateway Ports (DGP) -- parallelization=yes;;
762;ovn-northd.at:14506;Load balancer with Distributed Gateway Ports (DGP) -- parallelization=no;;
763;ovn-northd.at:14598;RBAC -- Recover builtin role and permissions;;
764;ovn-northd.at:14679;ACL mismatched tiers -- parallelization=yes;;
765;ovn-northd.at:14741;IGMP incremental processing -- parallelization=yes;;
766;ovn-northd.at:14829;Transit router - remote ports -- parallelization=yes;;
767;ovn-northd.at:14880;ACL persistent ID - Logical Flows -- parallelization=yes;;
768;ovn-northd.at:15020;dynamic-routing - sync to sb -- parallelization=yes;dynamic-routing;
769;ovn-northd.at:15081;dynamic-routing - sync to sb filtering -- parallelization=yes;dynamic-routing;
770;ovn-northd.at:15148;dynamic-routing - learning routes from sb -- parallelization=yes;dynamic-routing;
771;ovn-northd.at:15316;dynamic-routing - route learning ecmp -- parallelization=yes;dynamic-routing;
772;ovn-northd.at:15447;dynamic-routing - host routes -- parallelization=yes;dynamic-routing;
773;ovn-northd.at:15548;dynamic-routing - lrp options -- parallelization=yes;dynamic-routing;
774;ovn-northd.at:15581;dynamic-routing incremental processing -- parallelization=yes;dynamic-routing;
775;ovn-northd.at:15810;ovn -- LR ct-commit-all -- parallelization=yes;;
776;ovn-northd.at:15810;ovn -- LR ct-commit-all -- parallelization=no;;
777;ovn-northd.at:16078;dynamic-routing - nat sync to sb IPv4 -- parallelization=yes;dynamic-routing;
778;ovn-northd.at:16258;dynamic-routing - nat sync to sb IPv6 -- parallelization=yes;dynamic-routing;
779;ovn-northd.at:16438;dynamic-routing - LB sync to sb IPv4 -- parallelization=yes;dynamic-routing;
780;ovn-northd.at:16572;dynamic-routing - LB sync to sb IPv6 -- parallelization=yes;dynamic-routing;
781;ovn-northd.at:16706;configure LRP peers strange -- parallelization=yes;;
782;ovn-northd.at:16753;LSP using LRP with peer -- parallelization=yes;;
783;ovn-northd.at:16772;lb_force_snat_ip=router_ip generate flags.network_id flows -- parallelization=yes;;
784;ovn-northd.at:16885;lb_force_snat_ip=router_ip one IPv6 address -- parallelization=yes;;
785;ovn-nbctl.at:56;ovn-nbctl - basic switch commands - direct;ovn;
786;ovn-nbctl.at:56;ovn-nbctl - basic switch commands - daemon;ovn;
787;ovn-nbctl.at:109;ovn-nbctl - basic logical switch port commands - direct;ovn;
788;ovn-nbctl.at:109;ovn-nbctl - basic logical switch port commands - daemon;ovn;
789;ovn-nbctl.at:156;ovn-nbctl - lsp get ls - direct;ovn;
790;ovn-nbctl.at:156;ovn-nbctl - lsp get ls - daemon;ovn;
791;ovn-nbctl.at:170;ovn-nbctl - lport addresses - direct;ovn;
792;ovn-nbctl.at:170;ovn-nbctl - lport addresses - daemon;ovn;
793;ovn-nbctl.at:198;ovn-nbctl - port security - direct;ovn;
794;ovn-nbctl.at:198;ovn-nbctl - port security - daemon;ovn;
795;ovn-nbctl.at:216;ovn-nbctl - ACLs - direct;ovn;
796;ovn-nbctl.at:216;ovn-nbctl - ACLs - daemon;ovn;
797;ovn-nbctl.at:311;ovn-nbctl - QoS - direct;ovn;
798;ovn-nbctl.at:311;ovn-nbctl - QoS - daemon;ovn;
799;ovn-nbctl.at:387;ovn-nbctl - meters - direct;ovn;
800;ovn-nbctl.at:387;ovn-nbctl - meters - daemon;ovn;
801;ovn-nbctl.at:451;ovn-nbctl - mirrors - direct;ovn;
802;ovn-nbctl.at:451;ovn-nbctl - mirrors - daemon;ovn;
803;ovn-nbctl.at:562;ovn-nbctl - NATs - direct;ovn;
804;ovn-nbctl.at:562;ovn-nbctl - NATs - daemon;ovn;
805;ovn-nbctl.at:1044;ovn-nbctl - LBs - direct;ovn;
806;ovn-nbctl.at:1044;ovn-nbctl - LBs - daemon;ovn;
807;ovn-nbctl.at:1301;ovn-nbctl - LBs IPv6 - direct;ovn;
808;ovn-nbctl.at:1301;ovn-nbctl - LBs IPv6 - daemon;ovn;
809;ovn-nbctl.at:1588;ovn-nbctl - Template LBs - direct;ovn;
810;ovn-nbctl.at:1588;ovn-nbctl - Template LBs - daemon;ovn;
811;ovn-nbctl.at:1618;ovn-nbctl - basic logical router commands - direct;ovn;
812;ovn-nbctl.at:1618;ovn-nbctl - basic logical router commands - daemon;ovn;
813;ovn-nbctl.at:1671;ovn-nbctl - basic logical router port commands - direct;ovn;
814;ovn-nbctl.at:1671;ovn-nbctl - basic logical router port commands - daemon;ovn;
815;ovn-nbctl.at:1755;ovn-nbctl - logical router port gateway chassis - direct;ovn;
816;ovn-nbctl.at:1755;ovn-nbctl - logical router port gateway chassis - daemon;ovn;
817;ovn-nbctl.at:1821;ovn-nbctl - logical router port redirect type - direct;ovn;
818;ovn-nbctl.at:1821;ovn-nbctl - logical router port redirect type - daemon;ovn;
819;ovn-nbctl.at:1846;ovn-nbctl - logical router port enable and disable - direct;ovn;
820;ovn-nbctl.at:1846;ovn-nbctl - logical router port enable and disable - daemon;ovn;
821;ovn-nbctl.at:1866;ovn-nbctl - routes - direct;ovn;
822;ovn-nbctl.at:1866;ovn-nbctl - routes - daemon;ovn;
823;ovn-nbctl.at:2322;ovn-nbctl - policies - direct;ovn;
824;ovn-nbctl.at:2322;ovn-nbctl - policies - daemon;ovn;
825;ovn-nbctl.at:2449;ovn-nbctl - lsp types - direct;ovn;
826;ovn-nbctl.at:2449;ovn-nbctl - lsp types - daemon;ovn;
827;ovn-nbctl.at:2536;ovn-nbctl - connection - direct;ovn;
828;ovn-nbctl.at:2536;ovn-nbctl - connection - daemon;ovn;
829;ovn-nbctl.at:2545;ovn-nbctl - dry run mode - direct;ovn;
830;ovn-nbctl.at:2545;ovn-nbctl - dry run mode - daemon;ovn;
831;ovn-nbctl.at:2561;ovn-nbctl - oneline output - direct;ovn;
832;ovn-nbctl.at:2561;ovn-nbctl - oneline output - daemon;ovn;
833;ovn-nbctl.at:2577;ovn-nbctl - commands parser error paths - direct;ovn;
834;ovn-nbctl.at:2577;ovn-nbctl - commands parser error paths - daemon;ovn;
835;ovn-nbctl.at:2648;ovn-nbctl - port groups - direct;ovn;
836;ovn-nbctl.at:2648;ovn-nbctl - port groups - daemon;ovn;
837;ovn-nbctl.at:2655;ovn-nbctl - extra newlines - direct;ovn;
838;ovn-nbctl.at:2655;ovn-nbctl - extra newlines - daemon;ovn;
839;ovn-nbctl.at:2667;ovn-nbctl - table formatting - direct;ovn;
840;ovn-nbctl.at:2667;ovn-nbctl - table formatting - daemon;ovn;
841;ovn-nbctl.at:2677;ovn-nbctl - port group commands - direct;ovn;
842;ovn-nbctl.at:2677;ovn-nbctl - port group commands - daemon;ovn;
843;ovn-nbctl.at:2710;ovn-nbctl - fwd groups - direct;ovn;
844;ovn-nbctl.at:2710;ovn-nbctl - fwd groups - daemon;ovn;
845;ovn-nbctl.at:2748;ovn-nbctl - lr static_mac_binding - direct;ovn;
846;ovn-nbctl.at:2748;ovn-nbctl - lr static_mac_binding - daemon;ovn;
847;ovn-nbctl.at:2817;ovn-nbctl - basic negative tests - direct;ovn;
848;ovn-nbctl.at:2817;ovn-nbctl - basic negative tests - daemon;ovn;
849;ovn-nbctl.at:2827;ovn-nbctl - ACL tier operations - direct;ovn;
850;ovn-nbctl.at:2827;ovn-nbctl - ACL tier operations - daemon;ovn;
851;ovn-nbctl.at:2904;ovn-nbctl - ACL sampling operations - direct;ovn;
852;ovn-nbctl.at:2904;ovn-nbctl - ACL sampling operations - daemon;ovn;
853;ovn-nbctl.at:2940;ovn-nbctl - daemon retry connection;ovn;
854;ovn-nbctl.at:2950;ovn-nbctl - daemon ssl/tls files change;;
855;ovn-nbctl.at:2999;ovn-nbctl - ha-chassis-group-list group;ovn;
856;ovn-features.at:6;unit test -- OVS feature detection tests;;
857;ovn-lflow-cache.at:6;unit test -- lflow-cache single add/lookup;;
858;ovn-lflow-cache.at:48;unit test -- lflow-cache single add/lookup/del;;
859;ovn-lflow-cache.at:96;unit test -- lflow-cache disabled single add/lookup/del;;
860;ovn-lflow-cache.at:134;unit test -- lflow-cache disable/enable/flush;;
861;ovn-lflow-cache.at:253;unit test -- lflow-cache set limit;;
862;ovn-lflow-cache.at:398;ovn -- unit test -- lflow-cache trimming;;
863;ovn-lflow-cache.at:557;unit test -- lflow-cache negative tests;;
864;ovn-lflow-conj-ids.at:6;unit test -- lflow-conj-ids basic-alloc;;
865;ovn-lflow-conj-ids.at:27;unit test -- lflow-conj-ids alloc-with-conflict;;
866;ovn-lflow-conj-ids.at:100;unit test -- lflow-conj-ids rewind;;
867;ovn-lflow-conj-ids.at:119;unit test -- lflow-conj-ids alloc-specified;;
868;ovn-ofctrl-seqno.at:6;unit test -- ofctrl-seqno add-type;;
869;ovn-ofctrl-seqno.at:22;unit test -- ofctrl-seqno ack-seqnos;;
870;ovn-sbctl.at:70;ovn-sbctl - ovn-sbctl - chassis commands - direct;ovn;
871;ovn-sbctl.at:70;ovn-sbctl - ovn-sbctl - chassis commands - daemon;ovn;
872;ovn-sbctl.at:121;ovn-sbctl - ovn-sbctl - direct;ovn;
873;ovn-sbctl.at:121;ovn-sbctl - ovn-sbctl - daemon;ovn;
874;ovn-sbctl.at:186;ovn-sbctl - ovn-sbctl - connection - direct;ovn;
875;ovn-sbctl.at:186;ovn-sbctl - ovn-sbctl - connection - daemon;ovn;
876;ovn-sbctl.at:194;ovn-sbctl - invalid 0x flow - direct;ovn;
877;ovn-sbctl.at:194;ovn-sbctl - invalid 0x flow - daemon;ovn;
878;ovn-sbctl.at:200;ovn-sbctl - ovn-sbctl - count-flows - direct;ovn;
879;ovn-sbctl.at:200;ovn-sbctl - ovn-sbctl - count-flows - daemon;ovn;
880;ovn-ic-nbctl.at:25;ovn-ic-nbctl;ic_nbctl;
881;ovn-ic-sbctl.at:25;ovn-ic-sbctl;ic_sbctl;
882;ovn-controller.at:51;ovn-controller - ovn-bridge-mappings -- parallelization=yes -- ovn_monitor_all=yes;ovn;
883;ovn-controller.at:51;ovn-controller - ovn-bridge-mappings -- parallelization=yes -- ovn_monitor_all=no;ovn;
884;ovn-controller.at:180;ovn-controller - Chassis other_config -- parallelization=yes -- ovn_monitor_all=yes;ovn;
885;ovn-controller.at:180;ovn-controller - Chassis other_config -- parallelization=yes -- ovn_monitor_all=no;ovn;
886;ovn-controller.at:321;ovn-controller - change Encap properties -- parallelization=yes -- ovn_monitor_all=yes;ovn;
887;ovn-controller.at:321;ovn-controller - change Encap properties -- parallelization=yes -- ovn_monitor_all=no;ovn;
888;ovn-controller.at:383;ovn-controller - check sbdb connection -- parallelization=yes -- ovn_monitor_all=yes;ovn;
889;ovn-controller.at:383;ovn-controller - check sbdb connection -- parallelization=yes -- ovn_monitor_all=no;ovn;
890;ovn-controller.at:421;ovn-controller - Chassis self record -- parallelization=yes -- ovn_monitor_all=yes;ovn;
891;ovn-controller.at:421;ovn-controller - Bump Chassis_Private nb_cfg value -- parallelization=yes -- ovn_monitor_all=yes;ovn;
892;ovn-controller.at:421;ovn-controller - Chassis self record -- parallelization=yes -- ovn_monitor_all=no;ovn;
893;ovn-controller.at:421;ovn-controller - Bump Chassis_Private nb_cfg value -- parallelization=yes -- ovn_monitor_all=no;ovn;
894;ovn-controller.at:483;ovn-controller - Chassis_Private processing with conditional monitoring disabled;ovn;
895;ovn-controller.at:530;ovn-controller - overflow the nb_cfg value across the tables;ovn;
896;ovn-controller.at:561;ovn-controller - debug/delay-nb-cfg-report -- parallelization=yes -- ovn_monitor_all=yes;ovn;
897;ovn-controller.at:561;ovn-controller - debug/delay-nb-cfg-report -- parallelization=yes -- ovn_monitor_all=no;ovn;
898;ovn-controller.at:595;nb_cfg sync to OVS -- parallelization=yes -- ovn_monitor_all=yes;;
899;ovn-controller.at:595;nb_cfg sync to OVS -- parallelization=yes -- ovn_monitor_all=no;;
900;ovn-controller.at:630;features -- parallelization=yes -- ovn_monitor_all=yes;features;
901;ovn-controller.at:630;features -- parallelization=yes -- ovn_monitor_all=no;features;
902;ovn-controller.at:655;ovn-controller - port binding type change handling;ovn slowtest;
903;ovn-controller.at:769;ovn-controller - ssl/tls files change when using command line options;ovn;
904;ovn-controller.at:835;ovn-controller - ovn action metering -- parallelization=yes -- ovn_monitor_all=yes;action-metering;
905;ovn-controller.at:835;ovn-controller - ovn action metering -- parallelization=yes -- ovn_monitor_all=no;action-metering;
906;ovn-controller.at:895;ovn-controller - change Encap ToS option -- parallelization=yes -- ovn_monitor_all=yes;ovn;
907;ovn-controller.at:895;ovn-controller - change Encap ToS option -- parallelization=yes -- ovn_monitor_all=no;ovn;
908;ovn-controller.at:971;ovn-controller - ovn IP check path ports -- parallelization=yes -- ovn_monitor_all=yes;ovn-ip-patch-ports;
909;ovn-controller.at:971;ovn-controller - ovn IP check path ports -- parallelization=yes -- ovn_monitor_all=no;ovn-ip-patch-ports;
910;ovn-controller.at:1023;ovn-controller - I-P for address set update: no conjunction;as-i-p;
911;ovn-controller.at:1200;ovn-controller - I-P for address set update: with conjunction;as-i-p;
912;ovn-controller.at:1398;ovn-controller - I-P for address set update: multiple ASes used by same lflow;as-i-p;
913;ovn-controller.at:1558;ovn-controller - I-P for address set update: OR on multiple ASes, different fields;as-i-p;
914;ovn-controller.at:1658;ovn-controller - I-P for address set update: OR on multiple ASes, same field;as-i-p;
915;ovn-controller.at:1766;ovn-controller - I-P for address set update: same AS used twice in same lflow;as-i-p;
916;ovn-controller.at:1953;ovn-controller - I-P for address set update: conjunctions overlaping with other lflows;as-i-p;
917;ovn-controller.at:2078;ovn-controller - I-P for address set update: mac;as-i-p;
918;ovn-controller.at:2163;ovn-controller - I-P for address set update: ipv6;as-i-p;
919;ovn-controller.at:2247;ovn-controller - address set del-and-add;;
920;ovn-controller.at:2303;ovn-controller - I-P handle arp_ns_explicit_output change;;
921;ovn-controller.at:2352;ovn-controller - ofctrl wait before clearing flows;;
922;ovn-controller.at:2459;ovn-controller - check ovn-chassis-mac-mappings;;
923;ovn-controller.at:2488;ovn-controller - localport can be recreated;;
924;ovn-controller.at:2544;ovn-controller - restart should not delete patch ports;;
925;ovn-controller.at:2615;ovn-controller - resolve CT zone conflicts from ovsdb;;
926;ovn-controller.at:2726;ovn-controller - Local Chassis_Template_Var updates -- parallelization=yes -- ovn_monitor_all=yes;templates;
927;ovn-controller.at:2726;ovn-controller - Local Chassis_Template_Var updates -- parallelization=yes -- ovn_monitor_all=no;templates;
928;ovn-controller.at:2776;ovn-controller - Requested SNAT Zone in router creation transaction -- parallelization=yes -- ovn_monitor_all=yes;;
929;ovn-controller.at:2776;ovn-controller - Requested SNAT Zone in router creation transaction -- parallelization=yes -- ovn_monitor_all=no;;
930;ovn-controller.at:2802;ovn-controller - check unsupported chassis options removal -- parallelization=yes -- ovn_monitor_all=yes;;
931;ovn-controller.at:2802;ovn-controller - check unsupported chassis options removal -- parallelization=yes -- ovn_monitor_all=no;;
932;ovn-controller.at:2830;ovn-controller - ovs iface change ofport -- parallelization=yes -- ovn_monitor_all=yes;ovn;
933;ovn-controller.at:2830;ovn-controller - ovs iface change ofport -- parallelization=yes -- ovn_monitor_all=no;ovn;
934;ovn-controller.at:2875;ovn-controller - multicast group buffer split -- parallelization=yes -- ovn_monitor_all=yes;ovn;
935;ovn-controller.at:2875;ovn-controller - multicast group buffer split -- parallelization=yes -- ovn_monitor_all=no;ovn;
936;ovn-controller.at:2926;ovn-controller - ssl/tls ciphers using command line options;ovn;
937;ovn-controller.at:2946;ovn-controller - tunnel chassis id backward compatibility -- parallelization=yes -- ovn_monitor_all=yes;;
938;ovn-controller.at:2946;ovn-controller - tunnel chassis id backward compatibility -- parallelization=yes -- ovn_monitor_all=no;;
939;ovn-controller.at:2990;Encap enforce local_ip -- parallelization=yes -- ovn_monitor_all=yes;;
940;ovn-controller.at:2990;Encap enforce local_ip -- parallelization=yes -- ovn_monitor_all=no;;
941;ovn-controller.at:3021;ovn-controller - AS I-P and recompute consistency;as-i-p;
942;ovn-controller.at:3086;ovn-controller - LB remove after disconnect;;
943;ovn-controller.at:3124;ovn-controller - pmtud flows -- parallelization=yes -- ovn_monitor_all=yes;pmtud;
944;ovn-controller.at:3124;ovn-controller - pmtud flows -- parallelization=yes -- ovn_monitor_all=no;pmtud;
945;ovn-controller.at:3194;ovn-controller - br-int remote;ovn;
946;ovn-controller.at:3239;ovn-controller - br-int flow table prefixes;ovn-controller prefixes;
947;ovn-controller.at:3289;ovn-controller - CT zone min/max boundaries -- parallelization=yes -- ovn_monitor_all=yes;;
948;ovn-controller.at:3289;ovn-controller - CT zone min/max boundaries -- parallelization=yes -- ovn_monitor_all=no;;
949;ovn-controller.at:3409;ovn-controller - CT zone limit -- parallelization=yes -- ovn_monitor_all=yes;;
950;ovn-controller.at:3409;ovn-controller - CT zone limit -- parallelization=yes -- ovn_monitor_all=no;;
951;ovn-controller.at:3508;ovn-controller - I-P different port types;ovn;
952;ovn-controller.at:3579;ovn-controller - Start controller with empty db;ovn;
953;ovn-controller.at:3604;ovn-controller - LR peer ports combination;ovn;
954;ovn-controller.at:3697;Remote chassis flood flows;;
955;ovn-controller.at:3760;ovn-cntroller exit - Cleanup;;
956;ovn-controller-vtep.at:92;ovn-controller-vtep - chassis;ovn;
957;ovn-controller-vtep.at:169;ovn-controller-vtep - binding 1;ovn;
958;ovn-controller-vtep.at:245;ovn-controller-vtep - binding 2;ovn;
959;ovn-controller-vtep.at:286;ovn-controller-vtep - vtep-lswitch;ovn;
960;ovn-controller-vtep.at:340;ovn-controller-vtep - vtep-macs 1;ovn;
961;ovn-controller-vtep.at:444;ovn-controller-vtep - vtep-macs 2;ovn;
962;ovn-controller-vtep.at:513;ovn-controller-vtep - vtep-Mcast_Macs_Remote;ovn;
963;ovn-controller-vtep.at:572;ovn-controller-vtep - hv flows -- parallelization=yes -- ovn_monitor_all=yes;ovn;
964;ovn-controller-vtep.at:572;ovn-controller-vtep - hv flows -- parallelization=yes -- ovn_monitor_all=no;ovn;
965;ovn-controller-vtep.at:635;ovn -- check ovn-northd and ovn-controller-vtep version pinning;ovn;
966;ovn-ic.at:2;ovn-ic -- AZ register -- parallelization=yes -- ovn_monitor_all=yes;;
967;ovn-ic.at:2;ovn-ic -- AZ register -- parallelization=yes -- ovn_monitor_all=no;;
968;ovn-ic.at:36;ovn-ic -- AZ update in GW -- parallelization=yes -- ovn_monitor_all=yes;;
969;ovn-ic.at:36;ovn-ic -- AZ update in GW -- parallelization=yes -- ovn_monitor_all=no;;
970;ovn-ic.at:62;ovn-ic -- transit switch handling -- parallelization=yes -- ovn_monitor_all=yes;;
971;ovn-ic.at:62;ovn-ic -- transit switch handling -- parallelization=yes -- ovn_monitor_all=no;;
972;ovn-ic.at:97;ovn-ic -- VXLAN tunnel key -- parallelization=yes -- ovn_monitor_all=yes;;
973;ovn-ic.at:97;ovn-ic -- VXLAN tunnel key -- parallelization=yes -- ovn_monitor_all=no;;
974;ovn-ic.at:129;ovn-ic -- port-bindings deletion upon TS deletion -- parallelization=yes -- ovn_monitor_all=yes;;
975;ovn-ic.at:129;ovn-ic -- port-bindings deletion upon TS deletion -- parallelization=yes -- ovn_monitor_all=no;;
976;ovn-ic.at:183;ovn-ic -- route deletion upon TS deletion -- parallelization=yes -- ovn_monitor_all=yes;;
977;ovn-ic.at:183;ovn-ic -- route deletion upon TS deletion -- parallelization=yes -- ovn_monitor_all=no;;
978;ovn-ic.at:257;ovn-ic -- duplicate NB route adv/learn -- parallelization=yes -- ovn_monitor_all=yes;;
979;ovn-ic.at:257;ovn-ic -- duplicate NB route adv/learn -- parallelization=yes -- ovn_monitor_all=no;;
980;ovn-ic.at:317;ovn-ic -- local duplicate connected route -- parallelization=yes -- ovn_monitor_all=yes;;
981;ovn-ic.at:317;ovn-ic -- local duplicate connected route -- parallelization=yes -- ovn_monitor_all=no;;
982;ovn-ic.at:378;ovn-ic -- gateway sync -- parallelization=yes -- ovn_monitor_all=yes;;
983;ovn-ic.at:378;ovn-ic -- gateway sync -- parallelization=yes -- ovn_monitor_all=no;;
984;ovn-ic.at:435;ovn-ic -- port sync -- parallelization=yes -- ovn_monitor_all=yes;;
985;ovn-ic.at:435;ovn-ic -- port sync -- parallelization=yes -- ovn_monitor_all=no;;
986;ovn-ic.at:505;ovn-ic -- route sync -- parallelization=yes -- ovn_monitor_all=yes;;
987;ovn-ic.at:505;ovn-ic -- route sync -- parallelization=yes -- ovn_monitor_all=no;;
988;ovn-ic.at:755;ovn-ic -- route sync -- IPv6 route tables -- parallelization=yes -- ovn_monitor_all=yes;ipv6-route-sync;
989;ovn-ic.at:755;ovn-ic -- route sync -- IPv6 route tables -- parallelization=yes -- ovn_monitor_all=no;ipv6-route-sync;
990;ovn-ic.at:803;ovn-ic -- route sync -- route tables -- parallelization=yes -- ovn_monitor_all=yes;;
991;ovn-ic.at:803;ovn-ic -- route sync -- route tables -- parallelization=yes -- ovn_monitor_all=no;;
992;ovn-ic.at:988;ovn-ic -- route sync -- multiple route tables -- parallelization=yes -- ovn_monitor_all=yes;;
993;ovn-ic.at:988;ovn-ic -- route sync -- multiple route tables -- parallelization=yes -- ovn_monitor_all=no;;
994;ovn-ic.at:1115;ovn-ic -- route sync -- multiple route tables IPv6 -- parallelization=yes -- ovn_monitor_all=yes;;
995;ovn-ic.at:1115;ovn-ic -- route sync -- multiple route tables IPv6 -- parallelization=yes -- ovn_monitor_all=no;;
996;ovn-ic.at:1249;ovn-ic -- same routes destination -- parallelization=yes -- ovn_monitor_all=yes;;
997;ovn-ic.at:1249;ovn-ic -- same routes destination -- parallelization=yes -- ovn_monitor_all=no;;
998;ovn-ic.at:1301;ovn-ic -- route sync -- multiple logical routers -- parallelization=yes -- ovn_monitor_all=yes;;
999;ovn-ic.at:1301;ovn-ic -- route sync -- multiple logical routers -- parallelization=yes -- ovn_monitor_all=no;;
1000;ovn-ic.at:1390;ovn-ic -- sync ISB status to INB -- parallelization=yes -- ovn_monitor_all=yes;;
1001;ovn-ic.at:1390;ovn-ic -- sync ISB status to INB -- parallelization=yes -- ovn_monitor_all=no;;
1002;ovn-ic.at:1433;ovn-ic -- route sync -- IPv6 denylist filter -- parallelization=yes -- ovn_monitor_all=yes;ipv6-route-sync-denylist;
1003;ovn-ic.at:1433;ovn-ic -- route sync -- IPv6 denylist filter -- parallelization=yes -- ovn_monitor_all=no;ipv6-route-sync-denylist;
1004;ovn-ic.at:1537;interconnection -- parallelization=yes -- ovn_monitor_all=yes;slowtest;
1005;ovn-ic.at:1537;interconnection -- parallelization=yes -- ovn_monitor_all=no;slowtest;
1006;ovn-ic.at:1752;interconnection - static multicast -- parallelization=yes -- ovn_monitor_all=yes;;
1007;ovn-ic.at:1752;interconnection - static multicast -- parallelization=yes -- ovn_monitor_all=no;;
1008;ovn-ic.at:1976;interconnection - IGMP/MLD multicast -- parallelization=yes -- ovn_monitor_all=yes;ip-multicast;
1009;ovn-ic.at:1976;interconnection - IGMP/MLD multicast -- parallelization=yes -- ovn_monitor_all=no;ip-multicast;
1010;ovn-ic.at:2230;interconnection - IGMP/MLD multicast - TS flood -- parallelization=yes -- ovn_monitor_all=yes;ip-multicast;
1011;ovn-ic.at:2230;interconnection - IGMP/MLD multicast - TS flood -- parallelization=yes -- ovn_monitor_all=no;ip-multicast;
1012;ovn-ic.at:2477;ovn-ic -- route tag -- tagging and filtering routes -- parallelization=yes -- ovn_monitor_all=yes;;
1013;ovn-ic.at:2477;ovn-ic -- route tag -- tagging and filtering routes -- parallelization=yes -- ovn_monitor_all=no;;
1014;ovn-ic.at:2677;spine-leaf: 3 AZs, 3 HVs, 3 LSs, connected via transit spine switch -- parallelization=yes -- ovn_monitor_all=yes;spine leaf;
1015;ovn-ic.at:2677;spine-leaf: 3 AZs, 3 HVs, 3 LSs, connected via transit spine switch -- parallelization=yes -- ovn_monitor_all=no;spine leaf;
1016;ovn-ic.at:3006;ovn-ic -- Delete route lsp orphan -- parallelization=yes -- ovn_monitor_all=yes;;
1017;ovn-ic.at:3006;ovn-ic -- Delete route lsp orphan -- parallelization=yes -- ovn_monitor_all=no;;
1018;ovn-ic.at:3071;ovn-ic -- Delete route lrp orphan -- parallelization=yes -- ovn_monitor_all=yes;;
1019;ovn-ic.at:3071;ovn-ic -- Delete route lrp orphan -- parallelization=yes -- ovn_monitor_all=no;;
1020;ovn-ic.at:3136;ovn-ic -- Check loop with lsp orphan in same subnet of new lsp in other TS -- parallelization=yes -- ovn_monitor_all=yes;;
1021;ovn-ic.at:3136;ovn-ic -- Check loop with lsp orphan in same subnet of new lsp in other TS -- parallelization=yes -- ovn_monitor_all=no;;
1022;checkpatch.at:44;checkpatch - sign-offs;;
1023;checkpatch.at:184;checkpatch - parenthesized constructs;slowtest;
1024;checkpatch.at:246;checkpatch - catastrophic backtracking;;
1025;checkpatch.at:262;checkpatch - parenthesized constructs - for;;
1026;checkpatch.at:322;checkpatch - comments;;
1027;checkpatch.at:344;checkpatch - whitespace around operator;;
1028;checkpatch.at:362;checkpatch - line too long;;
1029;checkpatch.at:374;checkpatch - check misuse APIs;;
1030;checkpatch.at:393;checkpatch - check egrep / fgrep;;
1031;checkpatch.at:419;checkpatch - whitespace around cast;;
1032;checkpatch.at:436;checkpatch - malformed tags;;
1033;checkpatch.at:496;checkpatch - Unicode code;;
1034;checkpatch.at:525;checkpatch - Fixes tag;;
1035;checkpatch.at:587;checkpatch - subject;;
1036;checkpatch.at:609;checkpatch - hardcoded table numbers;;
1037;checkpatch.at:648;checkpatch - check and check_uuid;;
1038;ovn-ipsec.at:3;ipsec -- basic configuration;;
1039;ovn-vif-plug.at:6;unit test -- plugging infrastructure tests;;
1040;ovn-util.at:1;ovn-detrace - simple scenario;;
"
# List of the all the test groups.
at_groups_all=`printf "%s\n" "$at_help_all" | sed 's/;.*//'`

# at_fn_validate_ranges NAME...
# -----------------------------
# Validate and normalize the test group number contained in each variable
# NAME. Leading zeroes are treated as decimal.
at_fn_validate_ranges ()
{
  for at_grp
  do
    eval at_value=\$$at_grp
    if test $at_value -lt 1 || test $at_value -gt 1040; then
      printf "%s\n" "invalid test group: $at_value" >&2
      exit 1
    fi
    case $at_value in
      0*) # We want to treat leading 0 as decimal, like expr and test, but
	  # AS_VAR_ARITH treats it as octal if it uses $(( )).
	  # With XSI shells, ${at_value#${at_value%%[1-9]*}} avoids the
	  # expr fork, but it is not worth the effort to determine if the
	  # shell supports XSI when the user can just avoid leading 0.
	  eval $at_grp='`expr $at_value + 0`' ;;
    esac
  done
}
# List of the tested programs.
at_tested='"ovs-vswitchd"
"ovs-vsctl"'


at_prev=
for at_option
do
  # If the previous option needs an argument, assign it.
  if test -n "$at_prev"; then
    at_option=$at_prev=$at_option
    at_prev=
  fi

  case $at_option in
  *=?*) at_optarg=`expr "X$at_option" : '[^=]*=\(.*\)'` ;;
  *)    at_optarg= ;;
  esac

  case $at_option in
    --help | -h )
	at_help_p=:
	;;

    --list | -l )
	at_list_p=:
	;;

    --version | -V )
	at_version_p=:
	;;

    --clean | -c )
	at_clean=:
	;;

    --color )
	at_color=always
	;;
    --color=* )
	case $at_optarg in
	no | never | none) at_color=never ;;
	auto | tty | if-tty) at_color=auto ;;
	always | yes | force) at_color=always ;;
	*) at_optname=`echo " $at_option" | sed 's/^ //; s/=.*//'`
	   as_fn_error $? "unrecognized argument to $at_optname: $at_optarg" ;;
	esac
	;;

    --debug | -d )
	at_debug_p=:
	;;

    --errexit | -e )
	at_debug_p=:
	at_errexit_p=:
	;;

    --verbose | -v )
	at_verbose=; at_quiet=:
	;;

    --trace | -x )
	at_traceon='set -x'
	at_trace_echo=echo
	at_check_filter_trace=at_fn_filter_trace
	;;

    [0-9] | [0-9][0-9] | [0-9][0-9][0-9] | [0-9][0-9][0-9][0-9])
	at_fn_validate_ranges at_option
	as_fn_append at_groups "$at_option$as_nl"
	;;

    # Ranges
    [0-9]- | [0-9][0-9]- | [0-9][0-9][0-9]- | [0-9][0-9][0-9][0-9]-)
	at_range_start=`echo $at_option |tr -d X-`
	at_fn_validate_ranges at_range_start
	at_range=`printf "%s\n" "$at_groups_all" | \
	  sed -ne '/^'$at_range_start'$/,$p'`
	as_fn_append at_groups "$at_range$as_nl"
	;;

    -[0-9] | -[0-9][0-9] | -[0-9][0-9][0-9] | -[0-9][0-9][0-9][0-9])
	at_range_end=`echo $at_option |tr -d X-`
	at_fn_validate_ranges at_range_end
	at_range=`printf "%s\n" "$at_groups_all" | \
	  sed -ne '1,/^'$at_range_end'$/p'`
	as_fn_append at_groups "$at_range$as_nl"
	;;

    [0-9]-[0-9] | [0-9]-[0-9][0-9] | [0-9]-[0-9][0-9][0-9] | \
    [0-9]-[0-9][0-9][0-9][0-9] | [0-9][0-9]-[0-9][0-9] | \
    [0-9][0-9]-[0-9][0-9][0-9] | [0-9][0-9]-[0-9][0-9][0-9][0-9] | \
    [0-9][0-9][0-9]-[0-9][0-9][0-9] | \
    [0-9][0-9][0-9]-[0-9][0-9][0-9][0-9] | \
    [0-9][0-9][0-9][0-9]-[0-9][0-9][0-9][0-9] )
	at_range_start=`expr $at_option : '\(.*\)-'`
	at_range_end=`expr $at_option : '.*-\(.*\)'`
	if test $at_range_start -gt $at_range_end; then
	  at_tmp=$at_range_end
	  at_range_end=$at_range_start
	  at_range_start=$at_tmp
	fi
	at_fn_validate_ranges at_range_start at_range_end
	at_range=`printf "%s\n" "$at_groups_all" | \
	  sed -ne '/^'$at_range_start'$/,/^'$at_range_end'$/p'`
	as_fn_append at_groups "$at_range$as_nl"
	;;

    # Directory selection.
    --directory | -C )
	at_prev=--directory
	;;
    --directory=* )
	at_change_dir=:
	at_dir=$at_optarg
	if test x- = "x$at_dir" ; then
	  at_dir=./-
	fi
	;;

    # Parallel execution.
    --jobs | -j )
	at_jobs=0
	;;
    --jobs=* | -j[0-9]* )
	if test -n "$at_optarg"; then
	  at_jobs=$at_optarg
	else
	  at_jobs=`expr X$at_option : 'X-j\(.*\)'`
	fi
	case $at_jobs in *[!0-9]*)
	  at_optname=`echo " $at_option" | sed 's/^ //; s/[0-9=].*//'`
	  as_fn_error $? "non-numeric argument to $at_optname: $at_jobs" ;;
	esac
	;;

    # Keywords.
    --keywords | -k )
	at_prev=--keywords
	;;
    --keywords=* )
	at_groups_selected=$at_help_all
	at_save_IFS=$IFS
	IFS=,
	set X $at_optarg
	shift
	IFS=$at_save_IFS
	for at_keyword
	do
	  at_invert=
	  case $at_keyword in
	  '!'*)
	    at_invert="-v"
	    at_keyword=`expr "X$at_keyword" : 'X!\(.*\)'`
	    ;;
	  esac
	  # It is on purpose that we match the test group titles too.
	  at_groups_selected=`printf "%s\n" "$at_groups_selected" |
	      grep -i $at_invert "^[1-9][^;]*;.*[; ]$at_keyword[ ;]"`
	done
	# Smash the keywords.
	at_groups_selected=`printf "%s\n" "$at_groups_selected" | sed 's/;.*//'`
	as_fn_append at_groups "$at_groups_selected$as_nl"
	;;
    --recheck)
	at_recheck=:
	;;

    *=*)
	at_envvar=`expr "x$at_option" : 'x\([^=]*\)='`
	# Reject names that are not valid shell variable names.
	case $at_envvar in
	  '' | [0-9]* | *[!_$as_cr_alnum]* )
	    as_fn_error $? "invalid variable name: \`$at_envvar'" ;;
	esac
	at_value=`printf "%s\n" "$at_optarg" | sed "s/'/'\\\\\\\\''/g"`
	# Export now, but save eval for later and for debug scripts.
	export $at_envvar
	as_fn_append at_debug_args " $at_envvar='$at_value'"
	;;

     *) printf "%s\n" "$as_me: invalid option: $at_option" >&2
	printf "%s\n" "Try \`$0 --help' for more information." >&2
	exit 1
	;;
  esac
done

# Verify our last option didn't require an argument
if test -n "$at_prev"
then :
  as_fn_error $? "\`$at_prev' requires an argument"
fi

# The file containing the suite.
at_suite_log=$at_dir/$as_me.log

# Selected test groups.
if test -z "$at_groups$at_recheck"; then
  at_groups=$at_groups_all
else
  if test -n "$at_recheck" && test -r "$at_suite_log"; then
    at_oldfails=`sed -n '
      /^Failed tests:$/,/^Skipped tests:$/{
	s/^[ ]*\([1-9][0-9]*\):.*/\1/p
      }
      /^Unexpected passes:$/,/^## Detailed failed tests/{
	s/^[ ]*\([1-9][0-9]*\):.*/\1/p
      }
      /^## Detailed failed tests/q
      ' "$at_suite_log"`
    as_fn_append at_groups "$at_oldfails$as_nl"
  fi
  # Sort the tests, removing duplicates.
  at_groups=`printf "%s\n" "$at_groups" | sort -nu | sed '/^$/d'`
fi

if test x"$at_color" = xalways \
   || { test x"$at_color" = xauto && test -t 1; }; then
  at_red=`printf '\033[0;31m'`
  at_grn=`printf '\033[0;32m'`
  at_lgn=`printf '\033[1;32m'`
  at_blu=`printf '\033[1;34m'`
  at_std=`printf '\033[m'`
else
  at_red= at_grn= at_lgn= at_blu= at_std=
fi

# Help message.
if $at_help_p; then
  cat <<_ATEOF || at_write_fail=1
Usage: $0 [OPTION]... [VARIABLE=VALUE]... [TESTS]

Run all the tests, or the selected TESTS, given by numeric ranges, and
save a detailed log file.  Upon failure, create debugging scripts.

Do not change environment variables directly.  Instead, set them via
command line arguments.  Set \`AUTOTEST_PATH' to select the executables
to exercise.  Each relative directory is expanded as build and source
directories relative to the top level of this distribution.
E.g., from within the build directory /tmp/foo-1.0, invoking this:

  $ $0 AUTOTEST_PATH=bin

is equivalent to the following, assuming the source directory is /src/foo-1.0:

  PATH=/tmp/foo-1.0/bin:/src/foo-1.0/bin:\$PATH $0
_ATEOF
cat <<_ATEOF || at_write_fail=1

Operation modes:
  -h, --help     print the help message, then exit
  -V, --version  print version number, then exit
  -c, --clean    remove all the files this test suite might create and exit
  -l, --list     describes all the tests, or the selected TESTS
_ATEOF
cat <<_ATEOF || at_write_fail=1

Execution tuning:
  -C, --directory=DIR
                 change to directory DIR before starting
      --color[=never|auto|always]
                 disable colored test results, or enable even without terminal
  -j, --jobs[=N]
                 Allow N jobs at once; infinite jobs with no arg (default 1)
  -k, --keywords=KEYWORDS
                 select the tests matching all the comma-separated KEYWORDS
                 multiple \`-k' accumulate; prefixed \`!' negates a KEYWORD
      --recheck  select all tests that failed or passed unexpectedly last time
  -e, --errexit  abort as soon as a test fails; implies --debug
  -v, --verbose  force more detailed output
                 default for debugging scripts
  -d, --debug    inhibit clean up and top-level logging
                 default for debugging scripts
  -x, --trace    enable tests shell tracing
_ATEOF
cat <<_ATEOF || at_write_fail=1

Report bugs to <bugs@openvswitch.org>.
_ATEOF
  exit $at_write_fail
fi

# List of tests.
if $at_list_p; then
  cat <<_ATEOF || at_write_fail=1
ovn 25.03.90 test suite test groups:

 NUM: FILE-NAME:LINE     TEST-GROUP-NAME
      KEYWORDS

_ATEOF
  # Pass an empty line as separator between selected groups and help.
  printf "%s\n" "$at_groups$as_nl$as_nl$at_help_all" |
    awk 'NF == 1 && FS != ";" {
	   selected[$ 1] = 1
	   next
	 }
	 /^$/ { FS = ";" }
	 NF > 0 {
	   if (selected[$ 1]) {
	     printf " %3d: %-18s %s\n", $ 1, $ 2, $ 3
	     if ($ 4) {
	       lmax = 79
	       indent = "     "
	       line = indent
	       len = length (line)
	       n = split ($ 4, a, " ")
	       for (i = 1; i <= n; i++) {
		 l = length (a[i]) + 1
		 if (i > 1 && len + l > lmax) {
		   print line
		   line = indent " " a[i]
		   len = length (line)
		 } else {
		   line = line " " a[i]
		   len += l
		 }
	       }
	       if (n)
		 print line
	     }
	   }
	 }' || at_write_fail=1
  exit $at_write_fail
fi
if $at_version_p; then
  printf "%s\n" "$as_me (ovn 25.03.90)" &&
  cat <<\_ATEOF || at_write_fail=1

Copyright (C) 2021 Free Software Foundation, Inc.
This test suite is free software; the Free Software Foundation gives
unlimited permission to copy, distribute and modify it.

Copyright (c) 2009, 2010, 2011, 2012, 2013, 2014, 2015 Nicira, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at:

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
_ATEOF
  exit $at_write_fail
fi

# Should we print banners?  Yes if more than one test is run.
case $at_groups in #(
  *$as_nl* )
      at_print_banners=: ;; #(
  * ) at_print_banners=false ;;
esac
# Text for banner N, set to a single space once printed.
# Banner 1. network-functions.at:1
# Category starts at test group 1.
at_banner_text_1="test library internal helpers"
# Banner 2. ovn-ipam.at:1
# Category starts at test group 7.
at_banner_text_2="OVN unit tests - IPAM"
# Banner 3. ovn.at:1
# Category starts at test group 10.
at_banner_text_3="OVN components"
# Banner 4. ovn.at:2307
# Category starts at test group 39.
at_banner_text_4="OVN end-to-end tests"
# Banner 5. ovn-northd.at:1
# Category starts at test group 608.
at_banner_text_5="OVN northd"
# Banner 6. ovn-nbctl.at:1
# Category starts at test group 785.
at_banner_text_6="ovn-nbctl"
# Banner 7. ovn-features.at:4
# Category starts at test group 856.
at_banner_text_7="OVN unit tests - features"
# Banner 8. ovn-lflow-cache.at:4
# Category starts at test group 857.
at_banner_text_8="OVN unit tests - lflow-cache"
# Banner 9. ovn-lflow-conj-ids.at:4
# Category starts at test group 864.
at_banner_text_9="OVN unit tests - lflow-conj-ids"
# Banner 10. ovn-ofctrl-seqno.at:4
# Category starts at test group 868.
at_banner_text_10="OVN unit tests - ofctrl-seqno"
# Banner 11. ovn-sbctl.at:1
# Category starts at test group 870.
at_banner_text_11="ovn-sbctl"
# Banner 12. ovn-ic-nbctl.at:1
# Category starts at test group 880.
at_banner_text_12="ovn-ic-nbctl"
# Banner 13. ovn-ic-sbctl.at:1
# Category starts at test group 881.
at_banner_text_13="ovn-ic-sbctl"
# Banner 14. ovn-controller.at:1
# Category starts at test group 882.
at_banner_text_14="ovn-controller"
# Banner 15. ovn-controller-vtep.at:1
# Category starts at test group 956.
at_banner_text_15="ovn_controller_vtep"
# Banner 16. ovn-ic.at:1
# Category starts at test group 966.
at_banner_text_16="OVN Interconnection Controller"
# Banner 17. checkpatch.at:1
# Category starts at test group 1022.
at_banner_text_17="checkpatch"
# Banner 18. ovn-ipsec.at:1
# Category starts at test group 1038.
at_banner_text_18="OVN - IPsec"
# Banner 19. ovn-vif-plug.at:4
# Category starts at test group 1039.
at_banner_text_19="OVN unit tests - vif-plug"

# Take any -C into account.
if $at_change_dir ; then
  test x != "x$at_dir" && cd "$at_dir" \
    || as_fn_error $? "unable to change directory"
  at_dir=`pwd`
fi

# Load the config files for any default variable assignments.
for at_file in atconfig atlocal
do
  test -r $at_file || continue
  . ./$at_file || as_fn_error $? "invalid content: $at_file"
done

# Autoconf <=2.59b set at_top_builddir instead of at_top_build_prefix:
: "${at_top_build_prefix=$at_top_builddir}"

# Perform any assignments requested during argument parsing.
eval "$at_debug_args"

# atconfig delivers names relative to the directory the test suite is
# in, but the groups themselves are run in testsuite-dir/group-dir.
if test -n "$at_top_srcdir"; then
  builddir=../..
  for at_dir_var in srcdir top_srcdir top_build_prefix
  do
    eval at_val=\$at_$at_dir_var
    case $at_val in
      [\\/$]* | ?:[\\/]* ) at_prefix= ;;
      *) at_prefix=../../ ;;
    esac
    eval "$at_dir_var=\$at_prefix\$at_val"
  done
fi

## -------------------- ##
## Directory structure. ##
## -------------------- ##

# This is the set of directories and files used by this script
# (non-literals are capitalized):
#
# TESTSUITE         - the testsuite
# TESTSUITE.log     - summarizes the complete testsuite run
# TESTSUITE.dir/    - created during a run, remains after -d or failed test
# + at-groups/      - during a run: status of all groups in run
# | + NNN/          - during a run: meta-data about test group NNN
# | | + check-line  - location (source file and line) of current AT_CHECK
# | | + status      - exit status of current AT_CHECK
# | | + stdout      - stdout of current AT_CHECK
# | | + stder1      - stderr, including trace
# | | + stderr      - stderr, with trace filtered out
# | | + test-source - portion of testsuite that defines group
# | | + times       - timestamps for computing duration
# | | + pass        - created if group passed
# | | + xpass       - created if group xpassed
# | | + fail        - created if group failed
# | | + xfail       - created if group xfailed
# | | + skip        - created if group skipped
# + at-stop         - during a run: end the run if this file exists
# + at-source-lines - during a run: cache of TESTSUITE line numbers for extraction
# + 0..NNN/         - created for each group NNN, remains after -d or failed test
# | + TESTSUITE.log - summarizes the group results
# | + ...           - files created during the group

# The directory the whole suite works in.
# Should be absolute to let the user `cd' at will.
at_suite_dir=$at_dir/$as_me.dir
# The file containing the suite ($at_dir might have changed since earlier).
at_suite_log=$at_dir/$as_me.log
# The directory containing helper files per test group.
at_helper_dir=$at_suite_dir/at-groups
# Stop file: if it exists, do not start new jobs.
at_stop_file=$at_suite_dir/at-stop
# The fifo used for the job dispatcher.
at_job_fifo=$at_suite_dir/at-job-fifo

if $at_clean; then
  test -d "$at_suite_dir" &&
    find "$at_suite_dir" -type d ! -perm -700 -exec chmod u+rwx \{\} \;
  rm -f -r "$at_suite_dir" "$at_suite_log"
  exit $?
fi

# Don't take risks: use only absolute directories in PATH.
#
# For stand-alone test suites (ie. atconfig was not found),
# AUTOTEST_PATH is relative to `.'.
#
# For embedded test suites, AUTOTEST_PATH is relative to the top level
# of the package.  Then expand it into build/src parts, since users
# may create executables in both places.
AUTOTEST_PATH=`printf "%s\n" "$AUTOTEST_PATH" | sed "s|:|$PATH_SEPARATOR|g"`
at_path=
as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
for as_dir in $AUTOTEST_PATH $PATH
do
  IFS=$as_save_IFS
  case $as_dir in #(((
    '') as_dir=./ ;;
    */) ;;
    *) as_dir=$as_dir/ ;;
  esac
    test -n "$at_path" && as_fn_append at_path $PATH_SEPARATOR
case $as_dir in
  [\\/]* | ?:[\\/]* )
    as_fn_append at_path "$as_dir"
    ;;
  * )
    if test -z "$at_top_build_prefix"; then
      # Stand-alone test suite.
      as_fn_append at_path "$as_dir"
    else
      # Embedded test suite.
      as_fn_append at_path "$at_top_build_prefix$as_dir$PATH_SEPARATOR"
      as_fn_append at_path "$at_top_srcdir/$as_dir"
    fi
    ;;
esac
  done
IFS=$as_save_IFS


# Now build and simplify PATH.
#
# There might be directories that don't exist, but don't redirect
# builtins' (eg., cd) stderr directly: Ultrix's sh hates that.
at_new_path=
as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
for as_dir in $at_path
do
  IFS=$as_save_IFS
  case $as_dir in #(((
    '') as_dir=./ ;;
    */) ;;
    *) as_dir=$as_dir/ ;;
  esac
    test -d "$as_dir" || continue
case $as_dir in
  [\\/]* | ?:[\\/]* ) ;;
  * ) as_dir=`(cd "$as_dir" && pwd) 2>/dev/null` ;;
esac
case $PATH_SEPARATOR$at_new_path$PATH_SEPARATOR in
  *$PATH_SEPARATOR$as_dir$PATH_SEPARATOR*) ;;
  $PATH_SEPARATOR$PATH_SEPARATOR) at_new_path=$as_dir ;;
  *) as_fn_append at_new_path "$PATH_SEPARATOR$as_dir" ;;
esac
  done
IFS=$as_save_IFS

PATH=$at_new_path
export PATH

# Setting up the FDs.



# 5 is the log file.  Not to be overwritten if `-d'.
if $at_debug_p; then
  at_suite_log=/dev/null
else
  : >"$at_suite_log"
fi
exec 5>>"$at_suite_log"

# Banners and logs.
printf "%s\n" "## ------------------------ ##
## ovn 25.03.90 test suite. ##
## ------------------------ ##"
{
  printf "%s\n" "## ------------------------ ##
## ovn 25.03.90 test suite. ##
## ------------------------ ##"
  echo

  printf "%s\n" "$as_me: command line was:"
  printf "%s\n" "  \$ $0 $at_cli_args"
  echo

  # If ChangeLog exists, list a few lines in case it might help determining
  # the exact version.
  if test -n "$at_top_srcdir" && test -f "$at_top_srcdir/ChangeLog"; then
    printf "%s\n" "## ---------- ##
## ChangeLog. ##
## ---------- ##"
    echo
    sed 's/^/| /;10q' "$at_top_srcdir/ChangeLog"
    echo
  fi

  {
cat <<_ASUNAME
## --------- ##
## Platform. ##
## --------- ##

hostname = `(hostname || uname -n) 2>/dev/null | sed 1q`
uname -m = `(uname -m) 2>/dev/null || echo unknown`
uname -r = `(uname -r) 2>/dev/null || echo unknown`
uname -s = `(uname -s) 2>/dev/null || echo unknown`
uname -v = `(uname -v) 2>/dev/null || echo unknown`

/usr/bin/uname -p = `(/usr/bin/uname -p) 2>/dev/null || echo unknown`
/bin/uname -X     = `(/bin/uname -X) 2>/dev/null     || echo unknown`

/bin/arch              = `(/bin/arch) 2>/dev/null              || echo unknown`
/usr/bin/arch -k       = `(/usr/bin/arch -k) 2>/dev/null       || echo unknown`
/usr/convex/getsysinfo = `(/usr/convex/getsysinfo) 2>/dev/null || echo unknown`
/usr/bin/hostinfo      = `(/usr/bin/hostinfo) 2>/dev/null      || echo unknown`
/bin/machine           = `(/bin/machine) 2>/dev/null           || echo unknown`
/usr/bin/oslevel       = `(/usr/bin/oslevel) 2>/dev/null       || echo unknown`
/bin/universe          = `(/bin/universe) 2>/dev/null          || echo unknown`

_ASUNAME

as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
for as_dir in $PATH
do
  IFS=$as_save_IFS
  case $as_dir in #(((
    '') as_dir=./ ;;
    */) ;;
    *) as_dir=$as_dir/ ;;
  esac
    printf "%s\n" "PATH: $as_dir"
  done
IFS=$as_save_IFS

}
  echo

  # Contents of the config files.
  for at_file in atconfig atlocal
  do
    test -r $at_file || continue
    printf "%s\n" "$as_me: $at_file:"
    sed 's/^/| /' $at_file
    echo
  done
} >&5


## ------------------------- ##
## Autotest shell functions. ##
## ------------------------- ##

# at_fn_banner NUMBER
# -------------------
# Output banner NUMBER, provided the testsuite is running multiple groups and
# this particular banner has not yet been printed.
at_fn_banner ()
{
  $at_print_banners || return 0
  eval at_banner_text=\$at_banner_text_$1
  test "x$at_banner_text" = "x " && return 0
  eval "at_banner_text_$1=\" \""
  if test -z "$at_banner_text"; then
    $at_first || echo
  else
    printf "%s\n" "$as_nl$at_banner_text$as_nl"
  fi
} # at_fn_banner

# at_fn_check_prepare_notrace REASON LINE
# ---------------------------------------
# Perform AT_CHECK preparations for the command at LINE for an untraceable
# command; REASON is the reason for disabling tracing.
at_fn_check_prepare_notrace ()
{
  $at_trace_echo "Not enabling shell tracing (command contains $1)"
  printf "%s\n" "$2" >"$at_check_line_file"
  at_check_trace=: at_check_filter=:
  : >"$at_stdout"; : >"$at_stderr"
}

# at_fn_check_prepare_trace LINE
# ------------------------------
# Perform AT_CHECK preparations for the command at LINE for a traceable
# command.
at_fn_check_prepare_trace ()
{
  printf "%s\n" "$1" >"$at_check_line_file"
  at_check_trace=$at_traceon at_check_filter=$at_check_filter_trace
  : >"$at_stdout"; : >"$at_stderr"
}

# at_fn_check_prepare_dynamic COMMAND LINE
# ----------------------------------------
# Decide if COMMAND at LINE is traceable at runtime, and call the appropriate
# preparation function.
at_fn_check_prepare_dynamic ()
{
  case $1 in
    *$as_nl*)
      at_fn_check_prepare_notrace 'an embedded newline' "$2" ;;
    *)
      at_fn_check_prepare_trace "$2" ;;
  esac
}

# at_fn_filter_trace
# ------------------
# Remove the lines in the file "$at_stderr" generated by "set -x" and print
# them to stderr.
at_fn_filter_trace ()
{
  mv "$at_stderr" "$at_stder1"
  grep '^ *+' "$at_stder1" >&2
  grep -v '^ *+' "$at_stder1" >"$at_stderr"
}

# at_fn_log_failure FILE-LIST
# ---------------------------
# Copy the files in the list on stdout with a "> " prefix, and exit the shell
# with a failure exit code.
at_fn_log_failure ()
{
  for file
    do printf "%s\n" "$file:"; sed 's/^/> /' "$file"; done
  echo 1 > "$at_status_file"
  exit 1
}

# at_fn_check_skip EXIT-CODE LINE
# -------------------------------
# Check whether EXIT-CODE is a special exit code (77 or 99), and if so exit
# the test group subshell with that same exit code. Use LINE in any report
# about test failure.
at_fn_check_skip ()
{
  case $1 in
    99) echo 99 > "$at_status_file"; at_failed=:
	printf "%s\n" "$2: hard failure"; exit 99;;
    77) echo 77 > "$at_status_file"; exit 77;;
  esac
}

# at_fn_check_status EXPECTED EXIT-CODE LINE
# ------------------------------------------
# Check whether EXIT-CODE is the EXPECTED exit code, and if so do nothing.
# Otherwise, if it is 77 or 99, exit the test group subshell with that same
# exit code; if it is anything else print an error message referring to LINE,
# and fail the test.
at_fn_check_status ()
{
  case $2 in
    $1 ) ;;
    77) echo 77 > "$at_status_file"; exit 77;;
    99) echo 99 > "$at_status_file"; at_failed=:
	printf "%s\n" "$3: hard failure"; exit 99;;
    *) printf "%s\n" "$3: exit code was $2, expected $1"
      at_failed=:;;
  esac
}

# at_fn_diff_devnull FILE
# -----------------------
# Emit a diff between /dev/null and FILE. Uses "test -s" to avoid useless diff
# invocations.
at_fn_diff_devnull ()
{
  test -s "$1" || return 0
  $at_diff "$at_devnull" "$1"
}

# at_fn_test NUMBER
# -----------------
# Parse out test NUMBER from the tail of this file.
at_fn_test ()
{
  eval at_sed=\$at_sed$1
  sed "$at_sed" "$at_myself" > "$at_test_source"
}

# at_fn_create_debugging_script
# -----------------------------
# Create the debugging script $at_group_dir/run which will reproduce the
# current test group.
at_fn_create_debugging_script ()
{
  {
    echo "#! /bin/sh" &&
    echo 'test ${ZSH_VERSION+y} && alias -g '\''${1+"$@"}'\''='\''"$@"'\''' &&
    printf "%s\n" "cd '$at_dir'" &&
    printf "%s\n" "exec \${CONFIG_SHELL-$SHELL} \"$at_myself\" -v -d $at_debug_args $at_group \${1+\"\$@\"}" &&
    echo 'exit 1'
  } >"$at_group_dir/run" &&
  chmod +x "$at_group_dir/run"
}

## -------------------------------- ##
## End of autotest shell functions. ##
## -------------------------------- ##


# Set ovs_base to the base directory in which the test is running and
# initialize the OVS_*DIR environment variables to point to this
# directory.
ovs_init() {
    ovs_base=`pwd`
    trap ovs_on_exit 0
    : > cleanup
    ovs_setenv
}

# Catch testsuite error condition and cleanup test environment by tearing down
# all interfaces and processes spawned.
# User has an option to leave the test environment in error state so that system
# can be poked around to get more information. User can enable this option by setting
# environment variable OVS_PAUSE_TEST=1. User needs to press CTRL-D to resume the
# cleanup operation.
ovs_pause() {
    echo "====================================================="
    echo "Set following environment variable to use various ovs utilities"
    echo "export OVS_RUNDIR=$ovs_base"
    echo "Press ENTER to continue: "
    read
}

ovs_on_exit () {
    rv=$?
    if [ ! -z "${OVS_PAUSE_TEST}" ] && [ -z $at_verbose ] && [ $rv != 0 ]; then
        trap '' INT
        ovs_pause
    fi
    . "$ovs_base/cleanup"
}

# With no parameter or an empty parameter, sets the OVS_*DIR
# environment variables to point to $ovs_base, the base directory in
# which the test is running.
#
# With a parameter, sets them to $ovs_base/$1.
ovs_setenv() {
    sandbox=$1
    ovs_dir=$ovs_base${1:+/$1}
    OVS_RUNDIR=$ovs_dir; export OVS_RUNDIR
    OVN_RUNDIR=$ovs_dir; export OVN_RUNDIR
    OVS_LOGDIR=$ovs_dir; export OVS_LOGDIR
    OVS_DBDIR=$ovs_dir; export OVS_DBDIR
    OVS_SYSCONFDIR=$ovs_dir; export OVS_SYSCONFDIR
    OVN_SYSCONFDIR=$ovs_dir; export OVN_SYSCONFDIR
    OVS_PKGDATADIR=$ovs_dir; export OVS_PKGDATADIR
    OVN_PKGDATADIR=$ovs_dir; export OVN_PKGDATADIR
}

# Prints the integers from $1 to $2, increasing by $3 (default 1) on stdout.
seq () {
    if test $# = 1; then
        set 1 $1
    fi
    while test $1 -le $2; do
        echo $1
        set `expr $1 + ${3-1}` $2 $3
    done
}

if test "$IS_WIN32" = "yes"; then
    pwd () {
        command pwd -W "$@"
    }

    diff () {
        command diff --strip-trailing-cr "$@"
    }

    # tskill is more effective than taskkill but it isn't always installed.
    if (tskill //?) >/dev/null 2>&1; then :; else
        tskill () { taskkill //F //PID $1 >/dev/null; }
    fi

    kill () {
        signal=
        retval=0
        for arg; do
            case $arg in
            -*) signal=$arg ;;
            [1-9][0-9]*)
                # tasklist always returns 0.
                # If pid does exist, there will be a line with the pid.
                if tasklist //fi "PID eq $arg" | grep $arg >/dev/null; then
                    if test "X$signal" != "X-0"; then
                        tskill $arg
                    fi
                else
                    retval=1
                fi
                ;;
            esac
        done
        return $retval
    }
fi

# parent_pid PID
#
# Prints the PID of the parent of process PID.
parent_pid () {
    # Using "ps" is portable to any POSIX system, but busybox "ps" (used in
    # e.g. Alpine Linux) is noncompliant, so we use a Linux-specific approach
    # when it's available.  We check the format of the status file to avoid
    # the NetBSD file with the same name but different contents.
    if egrep '^PPid:[[:space:]]*[0-9]*$' /proc/$1/status > /dev/null 2>&1; then
        sed -n 's/^PPid:	\([0-9]*\)/\1/p' /proc/$1/status
    else
        ps -o ppid= -p $1
    fi
}

# kill_ovs_vswitchd [PID]
#
# Signal the ovs-vswitchd daemon to exit gracefully and wait for it to
# terminate or kill it if that takes too long.
#
# It is used to cleanup all sorts of tests and results. It can't assume
# any state, including the availability of PID file which can be provided.
kill_ovs_vswitchd () {
    # Use provided PID or save the current PID if available.
    TMPPID=$1
    if test -z "$TMPPID"; then
        TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid 2>/dev/null)
    fi

    # Tell the daemon to terminate gracefully
    ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup 2>/dev/null

    # Nothing else to be done if there is no PID
    test -z "$TMPPID" && return

    for i in 1 2 3 4 5 6 7 8 9; do
        # Check if the daemon is alive.
        kill -0 $TMPPID 2>/dev/null || return

        # Fallback to whole number since POSIX doesn't require
        # fractional times to work.
        sleep 0.1 || sleep 1
    done

    # Make sure it is terminated.
    kill $TMPPID
}

# Normalize the output of 'wc' to match POSIX.
# POSIX says 'wc' should print "%d %d %d", but GNU prints "%7d %7d %7d".
# POSIX says 'wc -l' should print "%d %s", but BSD prints "%8d".
#
# This fixes all of those (it will screw up filenames that contain
# multiple sequential spaces, but that doesn't really matter).
wc () {
   command wc "$@" | tr -s ' ' ' ' | sed 's/^ *//'
}

uuidfilt () {
    $PYTHON "$top_srcdir"/tests/uuidfilt.py "$@"
}

# run_as PROGRAM_NAME COMMAND [ARG...]
#
# Runs a command with argv[0] set to PROGRAM_NAME, if possible, in a
# subshell.  Most utilities print argc[0] as part of their messages,
# so this makes it easier to figure out which particular utility
# prints a message if a bunch of identical processes are running.
#
# Not all shells support "exec -a NAME", so test for it.
if (exec -a myname true 2>/dev/null); then
    run_as () {
        (exec -a "$@")
    }
else
    run_as () {
        shift
        (exec "$@")
    }
fi


ovs_cleanup() {
    if test "$(echo sanitizers.*)" != 'sanitizers.*'; then
        echo "Undefined Behavior Sanitizer or Address Sanitizer reported errors in:" sanitizers.*
        cat sanitizers.*
        printf "%s\n" "ovs-macros.at:231" >"$at_check_line_file"
at_fn_check_skip 99 "$at_srcdir/ovs-macros.at:231"
    fi
}

ovs_wait () {
    echo "$1: waiting $2..." >&5

    # First try the condition without waiting.
    if ovs_wait_cond; then echo "$1: wait succeeded immediately" >&5; return 0; fi

    # Try a quick sleep, so that the test completes very quickly
    # in the normal case.  POSIX doesn't require fractional times to
    # work, so this might not work.
    sleep 0.1
    if ovs_wait_cond; then echo "$1: wait succeeded quickly" >&5; return 0; fi

    # Then wait up to OVS_CTL_TIMEOUT seconds.
    local timer
    for timer in `seq 1 "$OVS_CTL_TIMEOUT"`; do
        sleep 1
        if ovs_wait_cond; then echo "$1: wait succeeded after $timer seconds" >&5; return 0; fi
    done

    echo "$1: wait failed after $timer seconds" >&5
    ovs_wait_failed
    printf "%s\n" "ovs-macros.at:256" >"$at_check_line_file"
at_fn_check_skip 99 "$at_srcdir/ovs-macros.at:256"
}

check_ovs_wait_until_args() {
   printf "%s\n" "ovs-macros.at:260" >"$at_check_line_file"
(test $1 -ge 3) \
  && at_fn_check_skip 99 "$at_srcdir/ovs-macros.at:260"
      printf "%s\n" "ovs-macros.at:262" >"$at_check_line_file"
(test $1 -eq 2 && test "$2" -eq "$2" 2>/dev/null) \
  && at_fn_check_skip 99 "$at_srcdir/ovs-macros.at:262"
}


   on_exit () {
    (echo "$1"; cat cleanup) > cleanup.tmp
    mv cleanup.tmp cleanup
}


ovsdb_client_wait() {
    ovsdb-client -vconsole:warn -vreconnect:err -vjsonrpc:err -vtimeval:off -vfile -vsyslog:off -vvlog:off --timeout=30 wait "$@"
}



# Strips 'n_packets=...' from ovs-ofctl output.
strip_n_packets () {
    sed 's/ n_packets=[0-9]*,//'
}

# Strips 'n_bytes=...' from ovs-ofctl output.
strip_n_bytes () {
    sed 's/ n_bytes=[0-9]*,//'
}

# Strips 'cookie=...' from ovs-ofctl output.
strip_cookie () {
    sed '
s/ cookie=0x[0-9a-fA-F]*,//
s/cookie=0x[0-9a-fA-F]*,//
'
}

# Strips 'nw_frag=yes|no' from ovs-ofctl (or similar) output.
strip_nw_frag () {
    sed '
s/nw_frag=yes,//
s/nw_frag=no,//
'
}

# Strips out uninteresting parts of ovs-ofctl output, as well as parts
# that vary from one run to another.
ofctl_strip () {
    sed '
s/ (xid=0x[0-9a-fA-F]*)//
s/ duration=[0-9.]*s,//
s/ cookie=0,//
s/ table=0,//
s/ n_packets=0,//
s/ n_bytes=0,//
s/ idle_age=[0-9]*,//
s/ hard_age=[0-9]*,//
s/dp_hash=0x[0-9a-f]*\//dp_hash=0x0\//
s/recirc_id=0x[0-9a-f]*,/recirc_id=0x0,/
s/[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]T[0-9][0-9]:[0-9][0-9]:[0-9][0-9]Z|//
s/dir\/[0-9]*\/br0.mgmt/dir\/XXXX\/br0.mgmt/
'
}

# Strips out uninteresting parts of ovs-ofctl output, including n_packets=..
# n_bytes=..
ofctl_strip_all () {
    ofctl_strip | strip_n_packets | strip_n_bytes | strip_cookie | sort
}

# Filter (multiline) vconn debug messages from ovs-vswitchd.log.
# Use with vconn_sub() and ofctl_strip()
print_vconn_debug () { awk -F\| < ovs-vswitchd.log '
BEGIN { prt=0 }
/\|vconn\|DBG\|/ { sub(/[ \t]*$/, ""); print $3 "|" $4 "|" $5; prt=1; next }
$4 != "" { prt=0; next }
prt==1 { sub(/[ \t]*$/, ""); print $0 }
'
}

vconn_sub() {
    sed '
s/tcp:127.0.0.1:[0-9][0-9]*:/unix:/
s/unix#[0-9]*:/unix:/
'
}


# PARSE_LISTENING_PORT LOGFILE VARIABLE
#
# Parses the TCP or SSL/TLS port on which a server is listening from
# LOGFILE, given that the server was told to listen on a kernel-chosen
# port, and assigns the port number to shell VARIABLE.  You should
# specify the listening remote as ptcp:0:127.0.0.1 or
# pssl:0:127.0.0.1, or the equivalent with [::1] instead of 127.0.0.1.
#
# Here's an example of how to use this with ovsdb-server:
#
#    ovsdb-server --log-file --remote=ptcp:0:127.0.0.1 ...
#    PARSE_LISTENING_PORT([ovsdb-server.log], [TCP_PORT])
#    # Now $TCP_PORT holds the listening port.


start_daemon () {
    set "$@" -vconsole:off --detach --no-chdir --pidfile --log-file
    echo "$@"
    "$@"
    pidfile="$OVS_RUNDIR"/$1.pid
    on_exit "test -e \"$pidfile\" && kill \`cat \"$pidfile\"\`"
}

# sim_add SANDBOX
#
# Starts a new simulated Open vSwitch instance named SANDBOX.  Files related to
# the instance, such as logs, databases, sockets, and pidfiles, are created in
# a subdirectory of the main test directory also named SANDBOX.  Afterward, the
# "as" command (see below) can be used to run Open vSwitch utilities in the
# context of the new sandbox.
#
# The new sandbox starts out without any bridges.  Use ovs-vsctl in the context
# of the new sandbox to create a bridge, e.g.:
#
#     sim_add hv0           # Create sandbox hv0.
#     as hv0                # Set hv0 as default sandbox.
#     ovs-vsctl add-br br0  # Add bridge br0 inside hv0.
#
# or:
#
#     sim_add hv0
#     as hv0 ovs-vsctl add-br br0
PKIDIR="$(cd $abs_top_builddir/tests && pwd)"
sims=
sim_add () {
   echo "adding simulator '$1'"

   sims="$sims $1"

   # Create sandbox.
   local d="$ovs_base"/$1
   mkdir "$d" || return 1
   ovs_setenv $1

   # Create database and start ovsdb-server.
   : > "$d"/.conf.db.~lock~
   as $1 ovsdb-tool create "$d"/conf.db "$ovs_srcdir"/vswitchd/vswitch.ovsschema || return 1
   as $1 start_daemon ovsdb-server --remote=punix:"$d"/db.sock || return 1

   # Initialize database.
   as $1 ovs-vsctl --no-wait -- init || return 1

   # Start ovs-vswitchd
   as $1 start_daemon ovs-vswitchd --enable-dummy=system -vvconn -vofproto_dpif -vunixctl
   as $1 ovs-appctl vlog/disable-rate-limit vconn
   if test X$HAVE_OPENSSL = Xyes; then
      if test -f $PKIDIR/testpki-$1-privkey.pem; then
         as $1 ovs-vsctl set-ssl \
            $PKIDIR/testpki-$1-privkey.pem \
            $PKIDIR/testpki-$1-cert.pem \
            $PKIDIR/testpki-cacert.pem \
            || return 1
      else
         echo "WARNING: No certificate created for sim '$1', check TESTPKI_CNS variable in tests/automake.mk"
      fi
   fi
}

# "as $1" sets the OVS_*DIR environment variables to point to $ovs_base/$1.
#
# "as $1 COMMAND..." sets those variables in a subshell and invokes COMMAND
# there.
as() {
    if test "X$2" != X; then
        (ovs_setenv $1; shift; "$@")
    else
        ovs_setenv $1
    fi
}

# Strips 'xid=0x1234' from ovs-ofctl output.
strip_xids () {
    sed 's/ (xid=0x[0-9a-fA-F]*)//'
}

# Changes all 'used:...' to say 'used:0.0', to make output easier to compare.
strip_used () {
    sed 's/used:[0-9]\.[0-9]*/used:0.0/'
}

# Removes all 'duration=...' to make output easier to compare.
strip_duration () {
    sed 's/duration=[0-9]*\.[0-9]*s,//'
}

# Strips 'ufid:...' from output, to make it easier to compare.
# (ufids are random.)
strip_ufid () {
    sed 's/ufid:[-0-9a-f]* //'
}

check_logs () {
    local logs
    for log in ./$2/*.log; do
        case ${log} in # (
            '*.log'|*testsuite.log) ;; # (
            *) logs="${logs} ${log}" ;;
        esac
    done

    # We most notably ignore 'Broken pipe' warnings.  These often and
    # intermittently appear in ovsdb-server.log, because *ctl commands
    # (e.g. ovs-vsctl, ovn-nbctl) exit right after committing a change to the
    # database.  However, in reaction, some daemon may immediately update the
    # database, and this later update may cause database sending update back to
    # *ctl command if *ctl has not exited yet.  If *ctl command exits before
    # the database calls send, the send fails with 'Broken pipe' or
    # 'not connected' depending on system.  Also removes all 'connection reset'
    # warning logs for similar reasons (EPIPE, ENOTCONN or ECONNRESET can be
    # returned on a send depending on whether the peer had unconsumed data
    # when it closed the socket).
    #
    # We also ignore "Dropped # log messages..." messages.  Otherwise, even if
    # we ignore the messages that were rate-limited, we can end up failing just
    # because of the announcement that rate-limiting happened (and in a racy,
    # timing-dependent way, too).
    sed -n "$1
/reset by peer/d
/Broken pipe/d
/is not connected/d
/timeval.*Unreasonably long [0-9]*ms poll interval/d
/timeval.*faults: [0-9]* minor, [0-9]* major/d
/timeval.*disk: [0-9]* reads, [0-9]* writes/d
/timeval.*context switches: [0-9]* voluntary, [0-9]* involuntary/d
/ovs_rcu.*blocked [0-9]* ms waiting for .* to quiesce/d
/Dropped [0-9]* log messages/d
/.*Trying to release unknown interface.*/d
/setting extended ack support failed/d
/|WARN|/p
/|ERR|/p
/|EMER|/p" ${logs}
}

# add_of_br BRNUM [ARG...]
add_of_br () {
    local brnum=$1; shift
    local br=br$brnum
    local dpid=fedcba987654321$brnum
    local mac=aa:55:aa:55:00:0$brnum
    ovs-vsctl --timeout=20 \
        -- add-br $br \
        -- set bridge $br datapath-type=dummy \
                          fail-mode=secure \
                          other-config:datapath-id=$dpid \
                          other-config:hwaddr=$mac \
                          protocols="[OpenFlow10,OpenFlow11,OpenFlow12,\
                                       OpenFlow13,OpenFlow14,OpenFlow15]" \
        -- "$@"
}

# add_of_ports__ PORT_TYPE [--pcap] BRIDGE PNUM...
#
# Creates PORT_TYPE interfaces in BRIDGE named pPNUM, OpenFlow port number
# PNUM, and datapath port number PNUM (the latter is a consequence of
# the dummy implementation, which tries to assign datapath port
# numbers based on port names).
#
# If --pcap is supplied then packets received from the interface will
# be written to $port-rx.pcap and those sent to it to $port-tx.pcap.
add_of_ports__ () {
    local args
    local pcap=false
    local ptype=$1
    shift
    if test "$1" = --pcap; then
        pcap=:
    shift
    fi
    local br=$1; shift
    for pnum; do
        as_fn_append args " -- add-port $br p$pnum -- set Interface p$pnum type=$ptype ofport_request=$pnum"
    if $pcap; then
        as_fn_append args " -- set Interface p$pnum options:rxq_pcap=p$pnum-rx.pcap options:tx_pcap=p$pnum-tx.pcap"
    fi
    done
    echo ovs-vsctl $args
    ovs-vsctl $args
}

# add_of_ports [--pcap] BRIDGE PNUM...
#
add_of_ports () {
    add_of_ports__ dummy $@
}

# add_pmd_of_ports [--pcap] BRIDGE PNUM...
#
add_pmd_of_ports () {
    add_of_ports__ dummy-pmd $@
}

dump_diff__ () {
     local rcv_pcap=$1 exp_text=$2
     rcv_text=`echo "$rcv_pcap.packets" | sed 's/\.pcap//'`
     echo "Expected:"
     sort $exp_text
     echo "Received:"
     sort $rcv_text
     sort $exp_text -o $exp_text.sorted
     sort $rcv_text -o $rcv_text.sorted
     echo "Diff:"
     diff -u $exp_text.sorted $rcv_text.sorted
   }
   ovn_check_packets__ () {
     rcv_pcap=$1
     exp_text=$2
     cmd=${4-cat}
     echo "$3: checking packets in $1 against $2:"
     rcv_text=`echo "$rcv_pcap.packets" | sed 's/\.pcap//'`
     exp_n=`wc -l < "$exp_text"`
     check_ovs_wait_until_args "2" "dump_diff__ "$rcv_pcap" "$exp_text""
   ovs_wait_cond () {
    $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" $rcv_pcap > rcv_tmp
        rcv_n=`wc -l < rcv_tmp`
        echo "rcv_n=$rcv_n exp_n=$exp_n"
        test $rcv_n -ge $exp_n
}
ovs_wait_failed () {
    :
    dump_diff__ "$rcv_pcap" "$exp_text"
}
ovs_wait "ovn-macros.at:12" "until \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" \$rcv_pcap > rcv_tmp
        rcv_n=\`wc -l < rcv_tmp\`
        echo \"rcv_n=\$rcv_n exp_n=\$exp_n\"
        test \$rcv_n -ge \$exp_n"

     sort $exp_text | $cmd > expout
     cat rcv_tmp | $cmd > $rcv_text
   }
   ovn_check_packets_remove_broadcast__ () {
     rcv_pcap=$1
     exp_text=$2
     cmd=${4-cat}
     echo "$3: checking packets in $1 against $2:"
     rcv_text=`echo "$rcv_pcap.packets" | sed 's/\.pcap//'`
     exp_n=`wc -l < "$exp_text"`
     check_ovs_wait_until_args "2" "dump_diff__ "$rcv_pcap" "$exp_text""
   ovs_wait_cond () {
    $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" $rcv_pcap > rcv_tmp
        sed -i '/ffffffffffff/d' rcv_tmp
        rcv_n=`wc -l < rcv_tmp`
        echo "rcv_n=$rcv_n exp_n=$exp_n"
        test $rcv_n -ge $exp_n
}
ovs_wait_failed () {
    :
    dump_diff__ "$rcv_pcap" "$exp_text"
}
ovs_wait "ovn-macros.at:12" "until \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" \$rcv_pcap > rcv_tmp
        sed -i '/ffffffffffff/d' rcv_tmp
        rcv_n=\`wc -l < rcv_tmp\`
        echo \"rcv_n=\$rcv_n exp_n=\$exp_n\"
        test \$rcv_n -ge \$exp_n"

     sort $exp_text | $cmd > expout
     cat rcv_tmp | $cmd > $rcv_text
   }
   ovn_wait_packets__ () {
     rcv_pcap=$1
     exp_text=$2
     cmd=${4-cat}
     echo "$3: waiting packets from $2 at $1:"
     rcv_text=`echo "$rcv_pcap.packets" | sed 's/\.pcap//'`
     check_ovs_wait_until_args "2" "dump_diff__ "$rcv_pcap" "$exp_text""
   ovs_wait_cond () {
    $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" $rcv_pcap > rcv_tmp
        sort $exp_text | $cmd > expout
        cat rcv_tmp | $cmd > $rcv_text
        test x"$(sort $rcv_text | comm -2 -3 expout -)" = "x"
}
ovs_wait_failed () {
    :
    dump_diff__ "$rcv_pcap" "$exp_text"
}
ovs_wait "ovn-macros.at:12" "until \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" \$rcv_pcap > rcv_tmp
        sort \$exp_text | \$cmd > expout
        cat rcv_tmp | \$cmd > \$rcv_text
        test x\"\$(sort \$rcv_text | comm -2 -3 expout -)\" = \"x\""

   }

   ovn_wait_packets_uniq__ () {
     rcv_pcap=$1
     exp_text=$2
     cmd=${4-cat}
     echo "$3: waiting for packets from $2 at $1:"
     rcv_text=`echo "$rcv_pcap.packets" | sed 's/\.pcap//'`
     check_ovs_wait_until_args "2" "dump_diff__ "$rcv_pcap" "$exp_text""
   ovs_wait_cond () {
    $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" $rcv_pcap > $rcv_text
        sort $exp_text | $cmd > expout
        test x"$(sort $rcv_text | $cmd | uniq | comm -3 expout -)" = "x"
}
ovs_wait_failed () {
    :
    dump_diff__ "$rcv_pcap" "$exp_text"
}
ovs_wait "ovn-macros.at:12" "until \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" \$rcv_pcap > \$rcv_text
        sort \$exp_text | \$cmd > expout
        test x\"\$(sort \$rcv_text | \$cmd | uniq | comm -3 expout -)\" = \"x\""

   }

   ovn_wait_patch_port_flows () {
     for localnet in $1; do
       patch_port="patch-br-int-to-$localnet"
       for hv in $2; do
         echo "$3: waiting for flows for $patch_port on $hv"
         # Patch port might be created after ports are reported up
         check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {

             test 1 = $(as $hv ovs-vsctl show | grep "Port \b$patch_port\b" | wc -l)

}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-macros.at:12" "until
             test 1 = \$(as \$hv ovs-vsctl show | grep \"Port \\b\$patch_port\\b\" | wc -l)
         "

         # Wait for a flow outputing to patch port
         check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {

             hv_patch_ofport=$(as $hv ovs-vsctl --bare --columns ofport find Interface name=$patch_port)
             echo "$patch_port=$hv_patch_ofport"
             test -n "$hv_patch_ofport" && test 1 -le $(as $hv ovs-ofctl dump-flows br-int | grep -c "output:\b$hv_patch_ofport\b")

}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-macros.at:12" "until
             hv_patch_ofport=\$(as \$hv ovs-vsctl --bare --columns ofport find Interface name=\$patch_port)
             echo \"\$patch_port=\$hv_patch_ofport\"
             test -n \"\$hv_patch_ofport\" && test 1 -le \$(as \$hv ovs-ofctl dump-flows br-int | grep -c \"output:\\b\$hv_patch_ofport\\b\")
         "

       done
     done
   }

   ovn_wait_remote_output_flows () {
     hv1=$1
     hv2=$2
     echo "$3: waiting for flows for remote output on $hv1"
     # Wait for a flow outputing  to remote output
     check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {

         ofport=$(as $hv1 ovs-vsctl --bare --columns ofport find Interface name=ovn-${hv2}-0)
         echo "tunnel port=$ofport"
         test -n "$ofport" && test 1 -le $(as $hv1 ovs-ofctl dump-flows br-int | grep -c "output:$ofport")

}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-macros.at:12" "until
         ofport=\$(as \$hv1 ovs-vsctl --bare --columns ofport find Interface name=ovn-\${hv2}-0)
         echo \"tunnel port=\$ofport\"
         test -n \"\$ofport\" && test 1 -le \$(as \$hv1 ovs-ofctl dump-flows br-int | grep -c \"output:\$ofport\")
     "

   }

   ovn_wait_remote_input_flows () {
     hv1=$1
     hv2=$2
     echo "$3: waiting for flows for remote input on $hv1"
     # Wait for a flow outputing  to remote input
     check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {

         ofport=$(as $hv1 ovs-vsctl --bare --columns ofport find Interface name=ovn-${hv2}-0)
         echo "tunnel port=$ofport"
         test -n "$ofport" && test 1 -le $(as $hv1 ovs-ofctl dump-flows br-int | grep -c "in_port=$ofport")

}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-macros.at:12" "until
         ofport=\$(as \$hv1 ovs-vsctl --bare --columns ofport find Interface name=ovn-\${hv2}-0)
         echo \"tunnel port=\$ofport\"
         test -n \"\$ofport\" && test 1 -le \$(as \$hv1 ovs-ofctl dump-flows br-int | grep -c \"in_port=\$ofport\")
     "

   }

   # ovn_wait_for_bfd_up HV
   # BFD might be quite slow. While BFD is not up, all chassis will fight to claim the port
   # Wait for BFD between different chassis to be up
   ovn_wait_for_bfd_up() {
     for hv; do
       as $hv
       for chassis; do
         if test $hv != $chassis; then
             echo "checking bdf_status for $hv -> $chassis"
             check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {

                 bfd_status=$(as $hv ovs-vsctl get interface ovn-$chassis-0 bfd_status:state)
                 echo "bfd status = $bfd_status"
                 test "$bfd_status" = "up"

}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-macros.at:12" "until
                 bfd_status=\$(as \$hv ovs-vsctl get interface ovn-\$chassis-0 bfd_status:state)
                 echo \"bfd status = \$bfd_status\"
                 test \"\$bfd_status\" = \"up\"
             "

         fi
       done
     done
   }



# ovn_init_db DATABASE [AZ]
#
# Creates and initializes the given DATABASE (one of "ovn-sb" or "ovn-nb"),
# starts its ovsdb-server instance, and sets the appropriate environment
# variable (OVN_SB_DB or OVN_NB_DB) so that ovn-sbctl or ovn-nbctl uses the
# database by default.
#
# Usually invoked from ovn_start.
ovn_init_db () {
    echo "${AZ:+$AZ: }creating $1 database"
    local as_d=$1
    if test -n "$2"; then
        as_d=$2/$as_d
    fi
    local d=$ovs_base/$as_d
    mkdir "$d" || return 1
    : > "$d"/.$1.db.~lock~
    as $as_d ovsdb-tool create "$d"/$1.db "$abs_top_srcdir"/$1.ovsschema

    local remote_in_db=
    if test X$HAVE_OPENSSL = Xyes -a X"$1" = X"ovn-sb"; then
        remote_in_db="--remote=db:OVN_Southbound,SB_Global,connections --private-key=$PKIDIR/testpki-test-privkey.pem --certificate=$PKIDIR/testpki-test-cert.pem --ca-cert=$PKIDIR/testpki-cacert.pem"
    fi

    as $as_d start_daemon ovsdb-server \
        -vjsonrpc \
        --remote=punix:"$d"/$1.sock \
        $remote_in_db \
        "$d"/$1.db

    local var=`echo $1_db | tr a-z- A-Z_`
    eval "$var=unix:\"\$d\"/\$1.sock"; export $var
}

# ovn_init_ic_db
#
# Creates and initializes ovn-ic-nb and ovn-ic-sb databases and starts their
# ovsdb-server instances, for OVN interconnection.
ovn_init_ic_db () {
    ovn_init_db ovn-ic-nb
    ovn_init_db ovn-ic-sb
}

# ovn_start_northd [--paused] (primary|backup) [AZ]
ovn_start_northd() {
    local northd_args=
    case $1 in
        --paused) northd_args=--dry-run; shift ;;
    esac
    local priority=$1
    local AZ=$2
    local msg_prefix=${AZ:+$AZ: }
    local d_prefix=${AZ:+$AZ/}

    local suffix=
    case $priority in
        backup) suffix=-backup ;;
    esac

    if test X$NORTHD_USE_PARALLELIZATION = Xyes; then
        northd_args="$northd_args --n-threads=4"
    fi

    local name=${d_prefix}northd${suffix}
    echo "${prefix}starting $name"
    test -d "$ovs_base/$name" || mkdir "$ovs_base/$name"
    as $name start_daemon ovn-northd $northd_args -vjsonrpc \
               --ovnnb-db=$OVN_NB_DB --ovnsb-db=$OVN_SB_DB
}

# ovn_start [--backup-northd=none|paused] [AZ]
#
# Creates and initializes ovn-sb and ovn-nb databases and starts their
# ovsdb-server instance, sets appropriate environment variables so that
# ovn-sbctl and ovn-nbctl use them by default, and starts ovn-northd running
# against them.
#
# Normally this starts only an active northd and no backup northd.  The following
# options are accepted to adjust that:
#   --backup-northd         Start a backup northd.
#   --backup-northd=paused  Start the backup northd in the paused state.
#   --use-tcp-to-sb         Use tcp to connect to sb.
ovn_start () {
    local backup_northd=false
    local backup_northd_options=
    case $1 in
        --backup-northd) backup_northd=true; shift ;;
        --backup-northd=paused) backup_northd=true; backup_northd_options=--paused; shift ;;
        --use-tcp-to-sb) use_tcp=true; shift ;;
    esac
    local AZ=$1
    local msg_prefix=${AZ:+$AZ: }
    local d_prefix=${AZ:+$AZ/}

    if test -n "$AZ"; then
        mkdir "$ovs_base"/$AZ
    fi

    ovn_init_db ovn-sb $1; ovn-sbctl init
    ovn_init_db ovn-nb $1; ovn-nbctl init
    if test -n "$1"; then
        check ovn-nbctl set NB_Global . name=$1
    fi

    ovn_start_northd primary $AZ
    if $backup_northd; then
        ovn_start_northd $backup_northd_options backup $AZ
    fi

    if test $use_tcp; then
        # Create the SB DB ptcp connection.
        ovn-sbctl \
            -- --id=@c create connection \
                target=\"ptcp:0:127.0.0.1\" \
            -- add SB_Global . connections @c
    elif test X$HAVE_OPENSSL = Xyes; then
        # Create the SB DB pssl+RBAC connection.
        ovn-sbctl \
            -- --id=@c create connection \
                target=\"pssl:0:127.0.0.1\" role=ovn-controller \
            -- add SB_Global . connections @c
        local d=$ovs_base
        if test -n "$AZ"; then
            d=$d/$AZ
        fi
        check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    TCP_PORT=`sed -n 's/.*0:.*: listening on port \([0-9]*\)$/\1/p' "$d/ovn-sb/ovsdb-server.log"` && test X != X"$TCP_PORT"
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-macros.at:630" "until TCP_PORT=\`sed -n 's/.*0:.*: listening on port \\([0-9]*\\)\$/\\1/p' \"\$d/ovn-sb/ovsdb-server.log\"\` && test X != X\"\$TCP_PORT\""

        var="SSL_OVN_SB_DB"
        eval "$var=ssl:127.0.0.1:\$TCP_PORT"; export $var
    fi

    if test -n "$AZ"; then
        check ovn-nbctl --wait=sb sync || exit $?

        echo "${msg_prefix}starting ovn-ic"
        mkdir "$ovs_base"/$d_prefix/ic
        as $d_prefix/ic start_daemon ovn-ic -v \
               --ovnnb-db=$OVN_NB_DB --ovnsb-db=$OVN_SB_DB \
               --ic-nb-db=unix:"$ovs_base"/ovn-ic-nb/ovn-ic-nb.sock \
               --ic-sb-db=unix:"$ovs_base"/ovn-ic-sb/ovn-ic-sb.sock
    fi
}

# Interconnection networks.
#
# When multiple sandboxed Open vSwitch instances exist, one will inevitably
# want to connect them together.  These commands allow for that.  Conceptually,
# an interconnection network is a switch for which these functions make it easy
# to plug into other switches in other sandboxed Open vSwitch instances.
# Interconnection networks are implemented as bridges in a switch named "main",
# so to use interconnection networks please avoid working with that switch
# directly.

# net_add NETWORK
#
# Creates a new interconnection network named NETWORK.
net_add () {
    test -d "$ovs_base"/main || sim_add main || return 1
    as main ovs-vsctl add-br "$1"
}

# net_attach NETWORK BRIDGE
#
# Adds a new port to BRIDGE in the default sandbox (as set with as()) and plugs
# it into the NETWORK interconnection network.  NETWORK must already have been
# created by a previous invocation of net_add.  The default sandbox must not be
# "main".
net_attach () {
    local net=$1 bridge=$2

    local port=${sandbox}_$bridge
    as main ovs-vsctl \
        -- add-port $net $port \
        -- set Interface $port options:pstream="punix:$ovs_base/main/$port.sock" options:rxq_pcap="$ovs_base/main/$port-rx.pcap" options:tx_pcap="$ovs_base/main/$port-tx.pcap" \
        || return 1

    ovs-vsctl \
        -- set Interface $bridge options:tx_pcap="$ovs_base/$sandbox/$bridge-tx.pcap" options:rxq_pcap="$ovs_base/$sandbox/$bridge-rx.pcap" \
        -- add-port $bridge ${bridge}_$net \
        -- set Interface ${bridge}_$net options:stream="unix:$ovs_base/main/$port.sock" options:rxq_pcap="$ovs_base/$sandbox/${bridge}_$net-rx.pcap" options:tx_pcap="$ovs_base/$sandbox/${bridge}_$net-tx.pcap" \
        || return 1
}

ovn_wait_for_encaps() {
    local systemid=$1

    if [ -f "${OVN_SYSCONFDIR}/system-id-override" ]; then
        systemid=$(cat ${OVN_SYSCONFDIR}/system-id-override)
    fi

    local encap=$(ovs-vsctl get Open_vSwitch . external_ids:ovn-encap-type-$systemid)
    if [ -z "$encap" ]; then
        encap=$(ovs-vsctl get Open_vSwitch . external_ids:ovn-encap-type)
    fi
    encap=$(tr -d '"' <<< $encap)

    local ip=$(ovs-vsctl get Open_vSwitch . external_ids:ovn-encap-ip-$systemid)
    if [ -z "$ip" ]; then
        ip=$(ovs-vsctl get Open_vSwitch . external_ids:ovn-encap-ip)
    fi
    ip=$(tr -d '"' <<< $ip)

    IFS="," read -r -a encap_types <<< "$encap"
    for e in "${encap_types[@]}"; do
        wait_column "$ip" sb:Encap ip chassis_name="$systemid" type="$e"
    done
}

# ovn_az_attach AZ NETWORK BRIDGE IP [MASKLEN] [ENCAP]
ovn_az_attach() {
    local az=$1 net=$2 bridge=$3 ip=$4 masklen=${5-24} encap=${6-geneve,vxlan}
    local systemid=${7-$sandbox} systemid_override=$8
    net_attach $net $bridge || return 1

    local expected_encap_id=$systemid
    local cli_args=""
    if [ -n "$systemid_override" ]; then
        cli_args="-n $systemid_override"
        expected_encap_id=$systemid_override
    fi

    mac=`ovs-vsctl get Interface $bridge mac_in_use | sed s/\"//g`
    arp_table="$arp_table $sandbox,$bridge,$ip,$mac"
    if test -z $(echo $ip | sed '/:/d'); then
        ipversion="6"
    else
        ipversion="4"
    fi
    ovs-appctl netdev-dummy/ip${ipversion}addr $bridge $ip/$masklen >/dev/null || return 1
    ovs-appctl ovs/route/add $ip/$masklen $bridge >/dev/null || return 1

    local ovn_remote
    if test X"$az" = XNONE; then
        if test X$HAVE_OPENSSL = Xyes; then
            ovn_remote=$SSL_OVN_SB_DB
        else
            ovn_remote=unix:$ovs_base/ovn-sb/ovn-sb.sock
        fi
    else
        ovn_remote=unix:$ovs_base/$az/ovn-sb/ovn-sb.sock
    fi
    ovs-vsctl \
        -- set Open_vSwitch . external-ids:hostname=$sandbox \
        -- set Open_vSwitch . external-ids:system-id=$systemid \
        -- set Open_vSwitch . external-ids:ovn-remote=$ovn_remote \
        -- set Open_vSwitch . external-ids:ovn-encap-type=$encap \
        -- set Open_vSwitch . external-ids:ovn-encap-ip=$ip \
        -- --may-exist add-br br-int \
        -- set bridge br-int fail-mode=secure other-config:disable-in-band=true \
        || return 1

    # currently this is the optimal place to add the ovn-monitor-all=true option,
    # this can be implemented in a different way by redefining the sim-add function
    # to add the ovn-related external-ids when we add a new simulated node via sim-add.
    #
    if test X$OVN_MONITOR_ALL = Xyes; then
        ovs-vsctl set open . external_ids:ovn-monitor-all=true
    fi

    start_daemon ovn-controller --enable-dummy-vif-plug ${cli_args} || return 1
    if test X"$az" = XNONE; then
        ovn_wait_for_encaps $expected_encap_id
    else
        ovn_as $az ovn_wait_for_encaps $expected_encap_id
    fi
}

# ovn_attach NETWORK BRIDGE IP [MASKLEN] [ENCAP]
#
# First, this command attaches BRIDGE to interconnection network NETWORK, just
# like "net_attach NETWORK BRIDGE".  Second, it configures (simulated) IP
# address IP (with network mask length MASKLEN, which defaults to 24) on
# BRIDGE.  Finally, it configures the Open vSwitch database to work with OVN
# and starts ovn-controller.
ovn_attach() {
    ovn_az_attach NONE $@
}

# This function is similar to ovn_attach but makes sure it doesn't
# mess with another controller settings
start_virtual_controller() {
    local net=$1 bridge=$2 int_bridge=$3 ip=$4 masklen=${5-24} encap=${6-geneve,vxlan} systemid=${7-$sandbox} cli_args=${@:8}
    net_attach $net $bridge || return 1

    mac=`ovs-vsctl get Interface $bridge mac_in_use | sed s/\"//g`
    arp_table="$arp_table $sandbox,$bridge,$ip,$mac"
    ovs-appctl netdev-dummy/ip4addr $bridge $ip/$masklen >/dev/null || return 1
    ovs-appctl ovs/route/add $ip/$masklen $bridge >/dev/null || return 1

    local ovn_remote
    if test X$HAVE_OPENSSL = Xyes; then
        ovn_remote=$SSL_OVN_SB_DB
    else
        ovn_remote=unix:$ovs_base/ovn-sb/ovn-sb.sock
    fi
    ovs-vsctl \
        -- set Open_vSwitch . external-ids:ovn-remote-$systemid=$ovn_remote \
        -- set Open_vSwitch . external-ids:ovn-encap-type-$systemid=$encap \
        -- set Open_vSwitch . external-ids:ovn-encap-ip-$systemid=$ip \
        -- set Open_vSwitch . external-ids:ovn-bridge-$systemid=$int_bridge \
        -- --may-exist add-br $int_bridge \
        -- set bridge $int_bridge fail-mode=secure other-config:disable-in-band=true \
        || return 1

    ovn-controller --enable-dummy-vif-plug ${cli_args} -vconsole:off --detach --no-chdir
    ovn_wait_for_encaps $systemid
}

# ovn_setenv AZ
ovn_setenv () {
    local d=$ovs_base/$1
    AZ_DIR="$d"/; export $var
    OVN_NB_DB=unix:"$d"/ovn-nb/ovn-nb.sock; export $var
    OVN_SB_DB=unix:"$d"/ovn-sb/ovn-sb.sock; export $var
}

# ovs_as AZ
ovn_as() {
    if test "X$2" != X; then
        (ovn_setenv $1; shift; "$@")
    else
        ovn_setenv $1
    fi
}

# OVN_POPULATE_ARP
#
# This pre-populates the ARP tables of all of the OVN instances that have been
# started with ovn_attach().  That means that packets sent from one hypervisor
# to another never get dropped or delayed by ARP resolution, which makes
# testing easier.
ovn_populate_arp__() {
    for e1 in $arp_table; do
        set `echo $e1 | sed 's/,/ /g'`; sb1=$1 br1=$2 ip=$3 mac=$4
        for e2 in $arp_table; do
            set `echo $e2 | sed 's/,/ /g'`; sb2=$1 br2=$2
            if test $sb1,$br1 != $sb2,$br2; then
                as $sb2 ovs-appctl tnl/neigh/set $br2 $ip $mac || return 1
            fi
        done
    done
}

# check COMMAND...
#
# Runs COMMAND and checks that it succeeds without any output.
check() {
    echo "$@"
    { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:854: \"\$@\""
at_fn_check_prepare_dynamic "\"$@\"" "ovn-macros.at:854"
( $at_check_trace; "$@"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:854"
$at_failed && at_fn_log_failure
$at_traceon; }

}

# Runs COMMAND and checks that it does not print anything else than uuid as output.
# It also fails if the output is empty.
check_uuid() {
    echo "$@"
    output=$("${@}")
    { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:862: echo \"\$output\" | grep ."
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-macros.at:862"
( $at_check_trace; echo "$output" | grep .
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:862"
if $at_failed
then :
  echo "Unexpected empty output: check_uuid is expecting a UUID"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

    { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:863: echo \"\$output\" | grep -vE '^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}\$'"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-macros.at:863"
( $at_check_trace; echo "$output" | grep -vE '^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-macros.at:863"
$at_failed && at_fn_log_failure
$at_traceon; }

}

parse_db() {
    case $1 in
        (*:*) echo ${1%%:*} ;;
        (*) echo sb ;;
    esac
}

parse_table() {
    case $1 in
        (*:*) echo ${1##*:} ;;
        (*) echo $1 ;;
    esac
}

# count_rows TABLE [CONDITION...]
#
# Prints the number of rows in TABLE (that satisfy CONDITION).
# Uses the southbound db by default; set DB=nb for the northbound database.
count_rows() {
    local db=$(parse_db $1) table=$(parse_table $1); shift
    ovn-${db}ctl --format=table --no-headings find $table "$@" | wc -l
}

# check_row_count [DATABASE:]TABLE COUNT [CONDITION...]
#
# Checks that TABLE contains COUNT rows (that satisfy CONDITION).
# The default DATABASE is "sb".
check_row_count() {
    local db=$(parse_db $1) table=$(parse_table $1); shift
    local count=$1; shift
    local found=$(count_rows $db:$table "$@")
    echo
    echo "Checking for $count rows in $db $table${1+ with $*}... found $found"
    if test "$count" != "$found"; then
        ovn-${db}ctl list $table
        printf "%s\n" "ovn-macros.at:901" >"$at_check_line_file"
at_fn_check_skip 99 "$at_srcdir/ovn-macros.at:901"
    fi
}

# wait_row_count [DATABASE:]TABLE COUNT [CONDITION...]
#
# Waits until TABLE contains COUNT rows (that satisfy CONDITION).
# The default DATABASE is "sb".
wait_row_count() {
    local db=$(parse_db $1) table=$(parse_table $1); shift
    local count=$1; shift
    local a=$1 b=$2 c=$3 d=$4 e=$5
    echo "Waiting until $count rows in $db $table${1+ with $*}..."
    check_ovs_wait_until_args "2" "
      echo "$db table $table has the following rows. $(count_rows $db:$table $a $b $c $d $e) rows match instead of expected $count:"
      ovn-${db}ctl list $table"
   ovs_wait_cond () {
    test $count = $(count_rows $db:$table $a $b $c $d $e)
}
ovs_wait_failed () {
    :

      echo "$db table $table has the following rows. $(count_rows $db:$table $a $b $c $d $e) rows match instead of expected $count:"
      ovn-${db}ctl list $table
}
ovs_wait "ovn-macros.at:914" "until test \$count = \$(count_rows \$db:\$table \$a \$b \$c \$d \$e)"

}

# fetch_column [DATABASE:]TABLE COLUMN [CONDITION...]
#
# Fetches and prints all the values of COLUMN in the rows of TABLE
# (that satisfy CONDITION), sorting the results lexicographically.
# The default DATABASE is "sb".
fetch_column() {
    local db=$(parse_db $1) table=$(parse_table $1) column=${2-_uuid}; shift; shift
    # Using "echo" removes spaces and newlines.
    echo $(ovn-${db}ctl --bare --columns $column find $table "$@" | sort)
}

# check_column EXPECTED [DATABASE:]TABLE COLUMN [CONDITION...]
#
# Fetches all of the values of COLUMN in the rows of TABLE (that
# satisfy CONDITION), and compares them against EXPECTED (ignoring
# order).
#
# The default DATABASE is "sb".
check_column() {
    local expected=$1 db=$(parse_db $2) table=$(parse_table $2) column=${3-_uuid}; shift; shift; shift
    local found=$(ovn-${db}ctl --bare --columns $column find $table "$@")

    # Sort the expected and found values.
    local found=$(for d in $found; do echo $d; done | sort)
    local expected=$(for d in $expected; do echo $d; done | sort)

    echo
    echo "Checking values in $db $table${1+ with $*} against $expected... found $found"
    if test "$found" != "$expected"; then
        ovn-${db}ctl list $table
        printf "%s\n" "ovn-macros.at:949" >"$at_check_line_file"
at_fn_check_skip 99 "$at_srcdir/ovn-macros.at:949"
    fi
}

# wait_column EXPECTED [DATABASE:]TABLE [COLUMN [CONDITION...]]
#
# Wait until all of the values of COLUMN in the rows of TABLE (that
# satisfy CONDITION) equal EXPECTED (ignoring order).
#
# The default DATABASE is "sb".
#
# COLUMN defaults to _uuid if unspecified.
wait_column() {
    local expected=$(for d in $1; do echo $d; done | sort)
    local db=$(parse_db $2) table=$(parse_table $2) column=${3-_uuid}; shift; shift; shift
    local a=$1 b=$2 c=$3 d=$4 e=$5

    echo
    echo "Waiting until $column in $db $table${1+ with $*} is $expected..."
    check_ovs_wait_until_args "2" "
      echo "$column in $db table $table has value $found, from the following rows:"
      ovn-${db}ctl list $table"
   ovs_wait_cond () {

      found=$(ovn-${db}ctl --bare --columns $column find $table $a $b $c $d $e)
      found=$(for d in $found; do echo $d; done | sort)
      test "$expected" = "$found"

}
ovs_wait_failed () {
    :

      echo "$column in $db table $table has value $found, from the following rows:"
      ovn-${db}ctl list $table
}
ovs_wait "ovn-macros.at:968" "until
      found=\$(ovn-\${db}ctl --bare --columns \$column find \$table \$a \$b \$c \$d \$e)
      found=\$(for d in \$found; do echo \$d; done | sort)
      test \"\$expected\" = \"\$found\"
    "

}

# wait_for_ports_up [PORT...]
#
# With arguments, waits for specified Logical_Switch_Ports to come up.
# Without arguments, waits for all "plain" and router
# Logical_Switch_Ports to come up.
wait_for_ports_up() {
    if test $# = 0; then
        wait_row_count nb:Logical_Switch_Port 0 up!=true type='""'
        wait_row_count nb:Logical_Switch_Port 0 up!=true type=router
    else
        for port; do
            wait_row_count nb:Logical_Switch_Port 1 up=true name=$port
        done
    fi
}

# reset_pcap_file iface pcap_file
# Resets the pcap file associates with OVS interface.  should be used
# with dummy datapath.
reset_pcap_file() {
    local iface=$1
    local pcap_file=$2
    check rm -f dummy-*.pcap
    check ovs-vsctl -- set Interface $iface options:tx_pcap=dummy-tx.pcap \
options:rxq_pcap=dummy-rx.pcap
    check rm -f ${pcap_file}*.pcap
    check ovs-vsctl -- set Interface $iface options:tx_pcap=${pcap_file}-tx.pcap \
options:rxq_pcap=${pcap_file}-rx.pcap
}

# Receive a packet on a dummy netdev interface. If we expect packets to be
# recorded, then wait until the pcap file reflects the change.
netdev_dummy_receive() {
    local interface="$1"
    local packet="$2"
    local hv="$3"
    local pcap_file="$4"

    if test -n "pcap_file" ; then
        ts_old=$(stat -c %y "$pcap_file")
    fi
    if test -n "$hv" ; then
        as "$hv" ovs-appctl netdev-dummy/receive "$interface" "$packet"
    else
        ovs-appctl netdev-dummy/receive "$interface" "$packet"
    fi
    if test -n "$pcap_file" ; then
        ovs_wait_cond () {
    if ts_new=$(stat -c %y "$pcap_file")
           test "$ts_new" = "$ts_old"; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-macros.at:1024" "while ts_new=\$(stat -c %y \"\$pcap_file\")
           test \"\$ts_new\" = \"\$ts_old\""

    fi
}

# send_igmp_v3_report INPORT HV ETH_SRC IP_SRC IP_CSUM GROUP REC_TYPE
#                     IGMP_CSUM OUTFILE
#
# This shell function causes an IGMPv3 report to be received on INPORT of HV.
# The packet's content has Ethernet destination 01:00:5E:00:00:22 and source
# ETH_SRC (exactly 12 hex digits). Ethernet type is set to IP.
# GROUP is the IP multicast group to be joined/to leave (based on REC_TYPE).
# REC_TYPE == 04: join GROUP
# REC_TYPE == 03: leave GROUP
# The packet hexdump is also stored in OUTFILE.
#
send_igmp_v3_report() {
    local inport=$1 hv=$2 eth_src=$3 ip_src=$4 ip_chksum=$5 group=$6
    local rec_type=$7 igmp_chksum=$8 outfile=$9

    local eth_dst=01005e000016
    local ip_dst=$(ip_to_hex 224 0 0 22)
    local ip_ttl=01
    local ip_ra_opt=94040000

    local igmp_type=2200
    local num_rec=00000001
    local aux_dlen=00
    local num_src=0000

    local eth=${eth_dst}${eth_src}0800
    local ip=46c0002800004000${ip_ttl}02${ip_chksum}${ip_src}${ip_dst}${ip_ra_opt}
    local igmp=${igmp_type}${igmp_chksum}${num_rec}${rec_type}${aux_dlen}${num_src}${group}
    local packet=${eth}${ip}${igmp}

    echo ${packet} >> ${outfile}
    check as $hv ovs-appctl netdev-dummy/receive ${inport} ${packet}
}

# store_igmp_v3_query ETH_SRC IP_SRC IP_CSUM OUTFILE
#
# This shell function builds an IGMPv3 general query from ETH_SRC and IP_SRC
# and stores the hexdump of the packet in OUTFILE.
#
store_igmp_v3_query() {
    local eth_src=$1 ip_src=$2 ip_chksum=$3 outfile=$4

    local eth_dst=01005e000001
    local ip_dst=$(ip_to_hex 224 0 0 1)
    local ip_ttl=01
    local igmp_type=11
    local max_resp=0a
    local igmp_chksum=eeeb
    local addr=00000000

    local eth=${eth_dst}${eth_src}0800
    local ip=4500002000004000${ip_ttl}02${ip_chksum}${ip_src}${ip_dst}
    local igmp=${igmp_type}${max_resp}${igmp_chksum}${addr}000a0000
    local packet=${eth}${ip}${igmp}

    echo ${packet} >> ${outfile}
}

# send_igmp_v3_query INPORT HV ETH_SRC IP_SRC IP_CSUM OUTFILE
#
# This shell function builds and sends an IGMPv3 general query from
# ETH_SRC and IP_SRC and stores the hexdump of the packet in OUTFILE.
#
send_igmp_v3_query() {
    local inport=$1 hv=$2 eth_src=$3 ip_src=$4 ip_chksum=$5 outfile=$6

    local eth_dst=01005e000001
    local ip_dst=$(ip_to_hex 224 0 0 1)
    local ip_ttl=01
    local igmp_type=11
    local max_resp=0a
    local igmp_chksum=eeeb
    local addr=00000000

    local eth=${eth_dst}${eth_src}0800
    local ip=4500002000004000${ip_ttl}02${ip_chksum}${ip_src}${ip_dst}
    local igmp=${igmp_type}${max_resp}${igmp_chksum}${addr}000a0000
    local packet=${eth}${ip}${igmp}

    echo ${packet} >> ${outfile}
    check as $hv ovs-appctl netdev-dummy/receive ${inport} ${packet}
}

# send_ip_multicast_pkt INPORT HV ETH_SRC ETH_DST IP_SRC IP_DST IP_LEN TTL
#    IP_CHKSUM IP_PROTO DATA
#
# This shell function causes an IP multicast packet to be received on INPORT
# of HV.
# The hexdump of the packet is stored in OUTFILE.
#
send_ip_multicast_pkt() {
    local inport=$1 hv=$2 eth_src=$3 eth_dst=$4
    local ip_src=$5 ip_dst=$6 ip_len=$7 ip_ttl=$8 ip_chksum=$9 proto=${10}
    local data=${11}

    local eth=${eth_dst}${eth_src}0800
    local ip=450000${ip_len}95f14000${ip_ttl}${proto}${ip_chksum}${ip_src}${ip_dst}
    local packet=${eth}${ip}${data}

    check as $hv ovs-appctl netdev-dummy/receive ${inport} ${packet}
}

# store_ip_multicast_pkt ETH_SRC ETH_DST IP_SRC IP_DST IP_LEN TTL
#    IP_CHKSUM IP_PROTO DATA OUTFILE
#
# This shell function builds an IP multicast packet and stores the hexdump of
# the packet in OUTFILE.
#
store_ip_multicast_pkt() {
    local eth_src=$1 eth_dst=$2
    local ip_src=$3 ip_dst=$4 ip_len=$5 ip_ttl=$6 ip_chksum=$7 proto=$8
    local data=$9 outfile=${10}

    local eth=${eth_dst}${eth_src}0800
    local ip=450000${ip_len}95f14000${ip_ttl}${proto}${ip_chksum}${ip_src}${ip_dst}
    local packet=${eth}${ip}${data}

    echo ${packet} >> ${outfile}
}

# send_mld_v2_report INPORT HV ETH_SRC IP_SRC GROUP REC_TYPE
#                    MLD_CSUM OUTFILE
#
# This shell function causes an MLDv2 report to be received on INPORT of HV.
# The packet's content has Ethernet destination 33:33:00:00:00:16 and source
# ETH_SRC (exactly 12 hex digits). Ethernet type is set to IPv6.
# GROUP is the IPv6 multicast group to be joined/to leave (based on REC_TYPE).
# REC_TYPE == 04: join GROUP
# REC_TYPE == 03: leave GROUP
# The packet hexdump is also stored in OUTFILE.
#
send_mld_v2_report() {
    local inport=$1 hv=$2 eth_src=$3 ip_src=$4 group=$5
    local rec_type=$6 mld_chksum=$7 outfile=$8

    local eth_dst=333300000016
    local ip_dst=ff020000000000000000000000000016
    local ip_ttl=01
    local ip_ra_opt=3a00050200000100

    local mld_type=8f
    local mld_code=00
    local num_rec=0001
    local aux_dlen=00
    local num_src=0000

    local eth=${eth_dst}${eth_src}86dd
    local ip=60000000002400${ip_ttl}${ip_src}${ip_dst}${ip_ra_opt}
    local mld=${mld_type}${mld_code}${mld_chksum}0000${num_rec}${rec_type}${aux_dlen}${num_src}${group}
    local packet=${eth}${ip}${mld}

    echo ${packet} >> ${outfile}
    check as $hv ovs-appctl netdev-dummy/receive ${inport} ${packet}
}

# store_mld_query ETH_SRC IP_SRC OUTFILE
#
# This shell function builds an MLD general query from ETH_SRC and IP_SRC
# and stores the hexdump of the packet in OUTFILE.
#
store_mld_query() {
    local eth_src=$1 ip_src=$2 outfile=$3

    local eth_dst=333300000000
    local ip_dst=ff020000000000000000000000000001
    local ip_ttl=01
    local ip_ra_opt=3a00050200000000

    local mld_type=82
    local mld_code=00
    local max_resp=03e8
    local mld_chksum=7b3d
    local addr=00000000000000000000000000000000

    local eth=${eth_dst}${eth_src}86dd
    local ip=60000000002400${ip_ttl}${ip_src}${ip_dst}${ip_ra_opt}
    local mld=${mld_type}${mld_code}${mld_chksum}${max_resp}0000${addr}00010000
    local packet=${eth}${ip}${mld}

    echo ${packet} >> ${outfile}
}

# send_ip6_multicast_pkt INPORT HV ETH_SRC ETH_DST IP_SRC IP_DST IP_LEN TTL
#    IP_PROTO DATA
#
# This shell function causes an IP multicast packet to be received on INPORT
# of HV.
#
send_ip6_multicast_pkt() {
    local inport=$1 hv=$2 eth_src=$3 eth_dst=$4
    local ip_src=$5 ip_dst=$6 ip_len=$7 ip_ttl=$8 proto=$9
    local data=${10}

    local eth=${eth_dst}${eth_src}86dd
    local ip=60000000${ip_len}${proto}${ip_ttl}${ip_src}${ip_dst}
    local packet=${eth}${ip}${data}

    check as $hv ovs-appctl netdev-dummy/receive ${inport} ${packet}
}

# store_ip6_multicast_pkt ETH_SRC ETH_DST IP_SRC IP_DST IP_LEN TTL
#    IP_PROTO DATA OUTFILE
#
# This shell function builds an IP multicast packet and stores the hexdump of
# the packet in OUTFILE.
#
store_ip6_multicast_pkt() {
    local eth_src=$1 eth_dst=$2
    local ip_src=$3 ip_dst=$4 ip_len=$5 ip_ttl=$6 proto=$7
    local data=$8 outfile=$9

    local eth=${eth_dst}${eth_src}86dd
    local ip=60000000${ip_len}${proto}${ip_ttl}${ip_src}${ip_dst}
    local packet=${eth}${ip}${data}

    echo ${packet} >> ${outfile}
}

hex_to_mac() {
    mac_hex=$1
    echo $mac_hex | sed 's/../&:/g;s/:$//'
}

send_garp() {
    local hv=$1 inport=$2 op=$3 eth_src=$4 eth_dst=$5 spa=$6 tpa=$7

    local packet=$(fmt_pkt "Ether(dst='${eth_dst}', src='${eth_src}')/ \
                      ARP(op=$op, hwsrc='${eth_src}', hwdst='${eth_src}', \
                      psrc='${spa}', pdst='${tpa}')")
    echo "Sending GARP($op) $eth_src $eth_dst $spa $tpa packet=$packet on $hv"
    check as $hv ovs-appctl netdev-dummy/receive $inport $packet
}

# Wrapper on top of ovn-trace, stripping some things and storing the trace
# output to a file called 'trace'.  For now it strips the rows starting
# with a '#'.  This should correspond to the flow key and might be displayed
# differently by different OVS library versions.
ovn_trace() {

    ovn-trace "$@" | tee trace | sed '/^# /d'
}

# Same as ovn_trace() except that it connects to an ovn-trace daemon.
ovn_trace_client() {
    target=$1; shift

    ovn-appctl -t $target trace "$@" | tee trace | sed '/^# /d'
}

# Receives a string with scapy python code that represents a packet.
# Returns a hex-string that contains bytes that reflect the packet symbolic
# description.
#
# Scapy docs: https://scapy.readthedocs.io/en/latest/usage.html
#
# Example of usage:
#
# packet=$(fmt_pkt "
#     Ether(dst='ff:ff:ff:ff:ff:ff', src='50:64:00:00:00:01') /
#     IPv6(src='abed::1', dst='ff02::1:ff00:2') /
#     ICMPv6ND_NS(tgt='abed::2')
# ")
#
# ovs-appctl netdev-dummy/receive $vif $packet
#
fmt_pkt() {
    ctlfile=$ovs_base/scapy.ctl
    if [ ! -S $ctlfile ]; then
        start_scapy_server
    fi
    while [ ! -S $ctlfile ]; do sleep 0.1; done
    ovs-appctl -t $ctlfile payload "$1"
}

start_scapy_server() {
    pidfile=$ovs_base/scapy.pid
    ctlfile=$ovs_base/scapy.ctl
    logfile=$ovs_base/scapy.log
    lockfile=$ovs_base/scapy.lock

    flock -n $lockfile "$top_srcdir"/tests/scapy-server.py \
        --pidfile=$pidfile --unixctl=$ctlfile --log-file=$logfile --detach \
    && on_exit "test -e \"$pidfile\" && ovs-appctl -t $ctlfile exit"
}

sleep_northd() {
  echo Northd going to sleep
  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1317: kill -STOP \$(cat northd/ovn-northd.pid)"
at_fn_check_prepare_notrace 'a $(...) command substitution' "ovn-macros.at:1317"
( $at_check_trace; kill -STOP $(cat northd/ovn-northd.pid)
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1317"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

  on_exit "test -e northd/ovn-northd.pid && kill -CONT $(cat northd/ovn-northd.pid)"
}

wake_up_northd() {
  echo Northd waking up
  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1323: kill -CONT \$(cat northd/ovn-northd.pid)"
at_fn_check_prepare_notrace 'a $(...) command substitution' "ovn-macros.at:1323"
( $at_check_trace; kill -CONT $(cat northd/ovn-northd.pid)
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1323"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

}

sleep_sb() {
  echo SB going to sleep
  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1328: kill -STOP \$(cat ovn-sb/ovsdb-server.pid)"
at_fn_check_prepare_notrace 'a $(...) command substitution' "ovn-macros.at:1328"
( $at_check_trace; kill -STOP $(cat ovn-sb/ovsdb-server.pid)
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1328"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

  on_exit "test -e ovn-sb/ovsdb-server.pid && kill -CONT $(cat ovn-sb/ovsdb-server.pid)"
}
wake_up_sb() {
  echo SB waking up
  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1333: kill -CONT \$(cat ovn-sb/ovsdb-server.pid)"
at_fn_check_prepare_notrace 'a $(...) command substitution' "ovn-macros.at:1333"
( $at_check_trace; kill -CONT $(cat ovn-sb/ovsdb-server.pid)
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1333"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

}
sleep_controller() {
  hv=$1
  echo Controller $hv going to sleep
  as $hv
  check ovn-appctl debug/pause
  check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x$(ovn-appctl -t ovn-controller debug/status) = "xpaused"
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-macros.at:1340" "until test x\$(ovn-appctl -t ovn-controller debug/status) = \"xpaused\""

}
wake_up_controller() {
  hv=$1
  as $hv
  echo Controller $hv waking up
  ovn-appctl debug/resume
  check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x$(ovn-appctl -t ovn-controller debug/status) = "xrunning"
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-macros.at:1347" "until test x\$(ovn-appctl -t ovn-controller debug/status) = \"xrunning\""

}
sleep_ovs() {
  hv=$1
  echo ovs $hv going to sleep
  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1352: kill -STOP \$(cat \$hv/ovs-vswitchd.pid)"
at_fn_check_prepare_notrace 'a $(...) command substitution' "ovn-macros.at:1352"
( $at_check_trace; kill -STOP $(cat $hv/ovs-vswitchd.pid)
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1352"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

  on_exit "test -e $hv/ovs-vswitchd.pid && kill -CONT $(cat $hv/ovs-vswitchd.pid)"
}

wake_up_ovs() {
  hv=$1
  echo ovs $hv going to wake-up
  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1359: kill -CONT \$(cat \$hv/ovs-vswitchd.pid)"
at_fn_check_prepare_notrace 'a $(...) command substitution' "ovn-macros.at:1359"
( $at_check_trace; kill -CONT $(cat $hv/ovs-vswitchd.pid)
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1359"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

}

sleep_ovsdb() {
  echo OVSDB $1 going to sleep
  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1364: kill -STOP \$(cat \$1/ovsdb-server.pid)"
at_fn_check_prepare_notrace 'a $(...) command substitution' "ovn-macros.at:1364"
( $at_check_trace; kill -STOP $(cat $1/ovsdb-server.pid)
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1364"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

  on_exit "test -e $1/ovsdb-server.pid && kill -CONT $(cat $1/ovsdb-server.pid)"
}
wake_up_ovsdb() {
  echo OVSDB $1 waking up
  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1369: kill -CONT \$(cat \$1/ovsdb-server.pid)"
at_fn_check_prepare_notrace 'a $(...) command substitution' "ovn-macros.at:1369"
( $at_check_trace; kill -CONT $(cat $1/ovsdb-server.pid)
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1369"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

}

stop_ovsdb_controller_updates() {
  TCP_PORT=$1
  echo Stopping updates from ovn-controller to ovsdb using port $TCP_PORT
  on_exit 'nft list tables | grep ovn-test && nft delete table ip ovn-test'
  # Report the test as skipped if proper nft related packages are not installed.
  printf "%s\n" "ovn-macros.at:1377" >"$at_check_line_file"
(! which nft) \
  && at_fn_check_skip 77 "$at_srcdir/ovn-macros.at:1377"
  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1378: nft add table ip ovn-test"
at_fn_check_prepare_trace "ovn-macros.at:1378"
( $at_check_trace; nft add table ip ovn-test
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1378"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1379: nft 'add chain ip ovn-test INPUT { type filter hook input priority 0; policy accept; }'"
at_fn_check_prepare_trace "ovn-macros.at:1379"
( $at_check_trace; nft 'add chain ip ovn-test INPUT { type filter hook input priority 0; policy accept; }'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1379"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1380: nft add rule ip ovn-test INPUT tcp dport \$TCP_PORT counter drop"
at_fn_check_prepare_dynamic "nft add rule ip ovn-test INPUT tcp dport $TCP_PORT counter drop" "ovn-macros.at:1380"
( $at_check_trace; nft add rule ip ovn-test INPUT tcp dport $TCP_PORT counter drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1380"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

}

restart_ovsdb_controller_updates() {
  TCP_PORT=$1
  echo Restarting updates from ovn-controller to ovsdb
  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1386: nft list ruleset | grep \$TCP_PORT"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-macros.at:1386"
( $at_check_trace; nft list ruleset | grep $TCP_PORT
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1386"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

  { set +x
printf "%s\n" "$at_srcdir/ovn-macros.at:1387: nft delete table ip ovn-test"
at_fn_check_prepare_trace "ovn-macros.at:1387"
( $at_check_trace; nft delete table ip ovn-test
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-macros.at:1387"
$at_failed && at_fn_log_failure  \
"trace"
$at_traceon; }

}

trim_zeros() {
    sed 's/\(00\)\{1,\}$//'
}

ovn_strip_lflows() {
     sed 's/table=[0-9]\{1,2\}\s\?/table=??/g' | sort
}

ovn_strip_collector_set() {
    sed 's/collector_set=[0-9]*,\?/collector_set=??,/g'
}



# ip_to_hex 192 168 0 1 -> c0a80001
# ip_to_hex 192.168.0.1 -> c0a80001
ip_to_hex() {
    if test $# = 1; then
        set $(echo $1 | sed 's/\./ /g')
    fi
    printf "%02x%02x%02x%02x" "$@"
}


# ip_csum WORDS
#
# Calculates the IP checksum of the provided 16-bit words, which
# should be provided as a sequence of hex digits (a multiple of 4
# digits in length).  Prints the checksum on stdout as 4 hex digits.
ip_csum() {
    local csum=0
    while test -n "$1"; do
        local head=$(expr "$1" : '\(....\)')
        csum=$(expr $csum + $(printf %u 0x$head))
        set -- "${1##????}"
    done
    while test $csum -gt 65535; do
        local a=$(expr $csum / 65536)
        local b=$(expr $csum % 65536)
        csum=$(expr $a + $b)
    done
    csum=$(expr 65535 - $csum)
    printf "%04x" $csum
}


# ip4_csum_inplace IP4_HEADER
#
# Outputs IP4_HEADER with the checksum filled in properly.
# The checksum must initially be 0000.  IP4_HEADER must be
# 40 hex digits.
ip4_csum_inplace() {
    local csum=$(ip_csum $1)
    echo "$1" | sed "s/^\(....................\)..../\1$csum/"
}


# ip6_pseudoheader IP6_HEADER NEXT_HEADER PAYLOAD_LEN
#
# where:
#   IP6_HEADER is the 40-byte IPv6 header as 80 hex digits
#   NEXT_HEADER is Next Header in the pseudoheader as 2 hex digits
#   PAYLOAD_LEN is the length of everything that follows the IPv6
#     header, as a decimal count of bytes
ip6_pseudoheader() {
    local ip6_srcdst=$(expr "$1" : '................\(................................................................\)')
    local len=$(printf "%08x" $3)
    printf %s "${ip6_srcdst}${len}000000$2"
}


# icmp6_csum ICMP6_AND_PAYLOAD IP6HEADER
#
# Outputs the checksum for ICMP6_AND_PAYLOAD given that it is inside
# IP6HEADER.  Both arguments must be given as hex digits.
icmp6_csum() {
    local payload_len=$(expr ${#1} / 2)
    ip_csum $(ip6_pseudoheader "$2" 3a $payload_len)$1
}
# icmp6_csum_inplace ICMP6_AND_PAYLOAD IP6HEADER
#
# Outputs ICMP6_AND_PAYLOAD with the checksum filled in properly.
icmp6_csum_inplace() {
    local csum=$(icmp6_csum "$@")
    echo "$1" | sed "s/^\(....\)..../\1$csum/"
}


# hex_to_binary HEXDIGITS
#
# Converts the pairs of HEXDIGITS into bytes and prints them on stdout.
if test x$HAVE_XXD = xno; then
    hex_to_binary() {
        printf $(while test -n "$1"; do
                     printf '\\%03o' 0x$(expr "$1" : '\(..\)')
                     set -- "${1##??}"
                 done)
    }
else
    hex_to_binary() {
        echo $1 | xxd -r -p
    }
fi

# tcpdump_hex TITLE PACKET
#
# Passes PACKET, expressed as pairs of hex digits, to tcpdump,
# printing "TITLE: " as a prefix.
#
if test $HAVE_TCPDUMP = yes; then
    tcpdump_hex() {
        if test $# -gt 1; then
            printf "%s: " "$1"
            shift
        fi

        local pkt_len=$(expr ${#1} / 2)
        (# File header
         hex_to_binary a1b2c3d4      # magic number
         printf '\0\2'              # major version 2
         printf '\0\4'              # minor version 4
         printf '\0\0\0\0'          # GMT to local correction
         printf '\0\0\0\0'          # sigfigs
         printf '\0\0\5\356'                # snaplen 1518
         printf '\0\0\0\1'          # Ethernet data link type

         # Packet header
         printf '\0\0\0\0'          # timestamp seconds
         printf '\0\0\0\0'          # timestamp subseconds
         hex_to_binary $(printf "%08x" $pkt_len) # incl_len
         hex_to_binary $(printf "%08x" $pkt_len) # orig_len

         # Packet
         hex_to_binary $1
        ) | tcpdump -vvvve -n -t -r- 2>&1 | grep -v 'reading from file -'
    }
else
    tcpdump_hex() {
        if test $# -gt 1; then
            printf "%s: " "$1"
            shift
        fi
        echo "(cannot print packet because tcpdump is not installed)"
    }
fi



# vec_cmp VALUE_VEC OP-VALUE_VEC
#
# Compares each value from VALUE_VEC to the operator-value pair from the
# OP-VALUE_VEC.
#
# VALUE_VEC must be a list of values separated by a character from $IFS.
# OP-VALUE_VEC must be a list of operator-value expressions separated by a
# character from $IFS.  Operator-value expressions cannot contain any characters
# from $IFS like spaces. '=' is treated as an equality operator ('==') for
# conciseness.
#
# Returns the result of each comparison as a list of boolean values (0 or 1)
# separated by a new-line character.
vec_cmp() {
    local a b i j

    i=0
    for a in $1; do
        j=0
        for b in $2; do
            if test $i -eq $j; then
                # Replace assignment '=' with equality comparison '=='
                case "$b" in
                =[0-9]*) b="=$b" ;;
                esac

                echo $(($a $b))
                break
            fi
            j=$((j + 1))
        done
        i=$((i + 1))
    done
}

# vec_sub VEC_A VEC_B
#
# Subtracts two vectors:
#
#     VEC_A = [a1, a2, ...]
#     VEC_B = [b1, b2, ...]
#     OUT = [(a1 - b1), (a2 - b2), ...]
#
# VEC_A and VEC_B must be lists of values separated by a character from $IFS.
vec_sub() {
    local a b i j

    i=0
    for a in $1; do
        j=0
        for b in $2; do
            if test $i -eq $j; then
                echo $((a - b))
                break
            fi
            j=$((j + 1))
        done
        i=$((i + 1))
    done
}

# vec_fold VEC OP
#
# Reduces a vector to a single value by applying the binary operator OP (i.e.,
# one that requires two arguments) cumulatively to all vector elements from left
# to right:
#
#     VEC = [e1, e2, e3 ...]
#     OUT = (...((e1 OP e2) OP e3) OP ...)
#
# VEC must be a list of values separated by a character from $IFS.
vec_fold() {
    local first op prod

    first=1
    op=$2
    for a in $1; do
        if test $first -eq 1; then
            prod=$a
            first=0
        else
            prod=$((prod $op a))
        fi
    done
    echo $prod
}

# read_counters SANDBOXES TARGET COUNTER
#
# Prints out the coverage COUNTER for the TARGET in each of the SANDBOXES.
#
# SANDBOXES must be a list of strings separated by a character from $IFS.
read_counters() {
    local sims="$1" target="$2" counter="$3"

    for sim in $sims; do
        as $sim ovn-appctl -t "$target" coverage/read-counter "$counter" || return 1
    done
}

# counter_delta_ SANDBOXES TARGET COUNTER COMMAND
#
# Runs the COMMAND and reports the COUNTER change registered during the command
# run for the given TARGET in each of the SANDBOXES.
counter_delta_() {
    local sims="$1" target="$2" counter="$3" cmd="$4"
    local before after

    before=$(read_counters "$sims" "$target" "$counter") || return 1
    eval "$cmd" >/dev/null || return 1
    after=$(read_counters "$sims" "$target" "$counter") || return 1

    vec_sub "$after" "$before"
}

# counter_delta SANDBOXES TARGET COUNTER COMMAND
#
# Same as counter_delta_ but also prints the COUNTER values together with the
# COMMAND to standard error.
counter_delta() {
    local cmd="$4"
    local v

    v=$(counter_delta_ "$@") || return 1

    # Dump the counters and the command for troubleshooting
    echo "$v" | tr '\n' '\t' >&2
    echo "$cmd" >&2

    echo "$v"
}

# vec_cmp_counter_delta SANDBOXES TARGET COUNTER CONDS COMMAND
#
# Check if COUNTER change in the TARGET app in each of the SANDBOXES after
# running the COMMAND meets the conditions listed as operator-value pairs in
# CONDS.
vec_cmp_counter_delta() {
    local v

    v=$(counter_delta "$1" "$2" "$3" "$5") || return 1
    v=$(vec_cmp "$v" "$4") || return 1
    v=$(vec_fold "$v" "&&") || return 1

    echo "$v"
}

# cmp_counter_delta SANDBOXES TARGET COUNTER COND COMMAND
#
# Check if COUNTER change in the TARGET app in each of the SANDBOXES after
# running the COMMAND meets the COND condition given as a operator-value pair.
cmp_counter_delta() {
    local conds=""

    # Use the same condition for each sandbox
    for _ in $1; do
        conds="$conds $4"
    done

    vec_cmp_counter_delta "$1" "$2" "$3" "$conds" "$5"
}


# Checks if the provided engine node recomputed or not
# and if it computed or not.
# 1st argument is the engine node.
# 2nd argument is the expected recompute state.
# Possible values are - "norecompute" and "recompute".
# 3rd argument is the expected compute state.
# Possible values are - "nocompute" and "compute".
#
# Eg. 'check_engine_stats lflow recompute nocompute' will verify
# that if the lflow engine node recompute stat is > 0 and
# compute stat is equal to 0.  It fails otherwise.
check_engine_stats() {
  node=$1
  recompute=$2
  compute=$3

  echo "Checking engine stats for node $node : recompute - \
$recompute : compute - $compute"

  node_stat=$(as northd ovn-appctl -t ovn-northd inc-engine/show-stats $node)
  # node_stat will be of this format :
  #     - Node: lflow - recompute: 3 - compute: 0 - cancel: 0
  node_recompute_ct=$(echo $node_stat | cut -d '-' -f2 | cut -d ':' -f2)
  node_compute_ct=$(echo $node_stat | cut -d '-' -f3 | cut -d ':' -f2)

  if [ "$recompute" == "norecompute" ]; then
    # node should not be recomputed
    echo "Expecting $node recompute count - $node_recompute_ct to be 0"
    check test "$node_recompute_ct" -eq "0"
  else
    echo "Expecting $node recompute count - $node_recompute_ct not to be 0"
    check test "$node_recompute_ct" -ne "0"
  fi

  if [ "$compute" == "nocompute" ]; then
    # node should not be computed
    echo "Expecting $node compute count - $node_compute_ct to be 0"
    check test "$node_compute_ct" -eq "0"
  else
    echo "Expecting $node compute count - $node_compute_ct not to be 0"
    check test "$node_compute_ct" -ne "0"
  fi
}

# Checks if the provided engine node recomputed, computed or is unchanged.
# 1st argument is the engine node.
# 2nd argument is the expected state.
# Possible values are - "recompute", "incremental" and "unchanged".
#
# Eg. 'check_engine_compute lflow incremental' will verify
# that if the lflow engine node recompute stat is equal to 0 and
# compute stat is > 0.  It fails otherwise.
check_engine_compute() {
  node=$1
  state=$2

  echo "Checking engine stats for node $node : goal $state"

  node_stat=$(as northd ovn-appctl -t ovn-northd inc-engine/show-stats $node)
  # node_stat will be of this format :
  #     - Node: lflow - recompute: 3 - compute: 0 - cancel: 0
  node_recompute_ct=$(echo $node_stat | cut -d '-' -f2 | cut -d ':' -f2)
  node_compute_ct=$(echo $node_stat | cut -d '-' -f3 | cut -d ':' -f2)

  if [ "$state" == "recompute" ]; then
    # Node should have recomputed.
    # It is irrelevant if it also computed.
    check test "$node_recompute_ct" -ne "0"
  elif [ "$state" == "incremental" ]; then
    check test "$node_recompute_ct" -eq "0"
    check test "$node_compute_ct" -ne "0"
  else
    check test "$node_recompute_ct" -eq "0"
    check test "$node_compute_ct" -eq "0"
  fi
}

# OVN_NBCTL_TEST_START

ovn_nbctl_test_start() {
      { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:11: ovsdb-tool create ovn-nb.db \$abs_top_srcdir/ovn-nb.ovsschema"
at_fn_check_prepare_dynamic "ovsdb-tool create ovn-nb.db $abs_top_srcdir/ovn-nb.ovsschema" "ovn-nbctl.at:11"
( $at_check_trace; ovsdb-tool create ovn-nb.db $abs_top_srcdir/ovn-nb.ovsschema
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:11"
$at_failed && at_fn_log_failure
$at_traceon; }


      { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:14: ovsdb-server --detach --no-chdir --pidfile --log-file --remote=punix:\$OVS_RUNDIR/ovnnb_db.sock ovn-nb.db"
at_fn_check_prepare_dynamic "ovsdb-server --detach --no-chdir --pidfile --log-file --remote=punix:$OVS_RUNDIR/ovnnb_db.sock ovn-nb.db" "ovn-nbctl.at:14"
( $at_check_trace; ovsdb-server --detach --no-chdir --pidfile --log-file --remote=punix:$OVS_RUNDIR/ovnnb_db.sock ovn-nb.db
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:14"
$at_failed && at_fn_log_failure
$at_traceon; }

   on_exit "kill `cat ovsdb-server.pid`"
   case $1 in #(
  daemon) :
    export OVN_NB_DAEMON=$(ovn-nbctl --pidfile --detach --no-chdir --log-file -vsocket_util:off)
        on_exit "kill `cat ovn-nbctl.pid`" ;; #(
  direct) :
     ;; #(
  *) :
    printf "%s\n" "ovn-nbctl.at:16" >"$at_check_line_file"
at_fn_check_skip 99 "$at_srcdir/ovn-nbctl.at:16" ;; #(
  *) :
     ;;
esac
   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:22: ovn-nbctl init"
at_fn_check_prepare_trace "ovn-nbctl.at:22"
( $at_check_trace; ovn-nbctl init
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:22"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:23: sed < stderr '
/vlog|INFO|opened log file/d
/ovsdb_server|INFO|ovsdb-server (Open vSwitch)/d'"
at_fn_check_prepare_notrace 'an embedded newline' "ovn-nbctl.at:23"
( $at_check_trace; sed < stderr '
/vlog|INFO|opened log file/d
/ovsdb_server|INFO|ovsdb-server (Open vSwitch)/d'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:23"
$at_failed && at_fn_log_failure
$at_traceon; }

}

# OVN_NBCTL_TEST_STOP

ovn_nbctl_test_stop() {
   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:31: check_logs \"\$1\""
at_fn_check_prepare_dynamic "check_logs \"$1\"" "ovn-nbctl.at:31"
( $at_check_trace; check_logs "$1"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:31"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:32: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn-nbctl.at:32"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:32"
$at_failed && at_fn_log_failure
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:32: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn-nbctl.at:32"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:32"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-nbctl.at:32" "while kill -0 \$TMPPID 2>/dev/null"

}


    ovn_nbctl_basic_switch() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl ls-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl ls-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (ls0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl ls-add ls1"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl ls-add ls1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl ls-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl ls-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (ls0)
<1> (ls1)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl ls-del ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl ls-del ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl ls-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl ls-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (ls1)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl show ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl show ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl show ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl show ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "switch <0> (ls0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: ls0: a switch with this name already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl --may-exist ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl --may-exist ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl show ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl show ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "switch <0> (ls0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl --add-duplicate ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl --add-duplicate ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl --may-exist --add-duplicate ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl --may-exist --add-duplicate ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: --may-exist and --add-duplicate may not be used together
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl ls-del ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl ls-del ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Multiple logical switches named 'ls0'.  Use a UUID.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl ls-del ls2"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl ls-del ls2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: ls2: switch name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl --if-exists ls-del ls2"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl --if-exists ls-del ls2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl ls-add"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl ls-add
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl ls-add"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl ls-add
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl --add-duplicate ls-add"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl --add-duplicate ls-add
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: --add-duplicate requires specifying a name
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:56: ovn-nbctl --may-exist ls-add"
at_fn_check_prepare_trace "ovn-nbctl.at:56"
( $at_check_trace; ovn-nbctl --may-exist ls-add
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: --may-exist requires specifying a name
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:56"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_basic_lsp() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl lsp-add ls0 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl lsp-add ls0 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl lsp-add ls0 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl lsp-add ls0 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp0: a port with this name already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl --may-exist lsp-add ls0 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl --may-exist lsp-add ls0 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl lsp-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl lsp-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (lp0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl lsp-add ls0 lp1"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl lsp-add ls0 lp1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl lsp-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl lsp-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (lp0)
<1> (lp1)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl ls-add ls1"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl ls-add ls1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl lsp-add ls0 lp1"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl lsp-add ls0 lp1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp1: a port with this name already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl --may-exist lsp-add ls1 lp1"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl --may-exist lsp-add ls1 lp1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp1: port already exists but in switch ls0
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl --may-exist lsp-add ls0 lp1 lp0 5"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl --may-exist lsp-add ls0 lp1 lp0 5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp1: port already exists but has no parent
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl lsp-del lp1"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl lsp-del lp1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl lsp-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl lsp-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (lp0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl lsp-add ls0 lp2 lp3 5"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl lsp-add ls0 lp2 lp3 5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl --may-exist lsp-add ls0 lp2 lp4 5"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl --may-exist lsp-add ls0 lp2 lp4 5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp2: port already exists with different parent lp3
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl --may-exist lsp-add ls0 lp2 lp3 10"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl --may-exist lsp-add ls0 lp2 lp3 10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp2: port already exists with different tag_request 5
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl clear Logical_Switch_Port lp2 tag_request"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl clear Logical_Switch_Port lp2 tag_request
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:109: ovn-nbctl --may-exist lsp-add ls0 lp2 lp3 5"
at_fn_check_prepare_trace "ovn-nbctl.at:109"
( $at_check_trace; ovn-nbctl --may-exist lsp-add ls0 lp2 lp3 5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp2: port already exists but has no tag_request
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:109"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_lsp_get_ls() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:156: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:156"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:156"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:156: ovn-nbctl lsp-add ls0 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:156"
( $at_check_trace; ovn-nbctl lsp-add ls0 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:156"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:156: ovn-nbctl lsp-get-ls lp0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:156"
( $at_check_trace; ovn-nbctl lsp-get-ls lp0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (ls0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:156"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:156: ovn-nbctl lsp-get-ls lp1"
at_fn_check_prepare_trace "ovn-nbctl.at:156"
( $at_check_trace; ovn-nbctl lsp-get-ls lp1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp1: port name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:156"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_lport_addresses() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lsp-add ls0 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lsp-add ls0 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lsp-get-addresses lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lsp-get-addresses lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lsp-set-addresses lp0 00:11:22:33:44:55 unknown"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lsp-set-addresses lp0 00:11:22:33:44:55 unknown
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lsp-get-addresses lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lsp-get-addresses lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "00:11:22:33:44:55
unknown
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lsp-set-addresses lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lsp-set-addresses lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lsp-get-addresses lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lsp-get-addresses lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lrp-add lr0 rp-ls0 aa:bb:bb:00:00:01 192.168.0.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lrp-add lr0 rp-ls0 aa:bb:bb:00:00:01 192.168.0.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lsp-add ls0 ls0-rp"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lsp-add ls0 ls0-rp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lsp-set-addresses ls0-rp router"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lsp-set-addresses ls0-rp router
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lsp-set-type ls0-rp router"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lsp-set-type ls0-rp router
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lsp-set-options ls0-rp router-port=rp-ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lsp-set-options ls0-rp router-port=rp-ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:170: ovn-nbctl lsp-get-addresses ls0-rp"
at_fn_check_prepare_trace "ovn-nbctl.at:170"
( $at_check_trace; ovn-nbctl lsp-get-addresses ls0-rp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "aa:bb:bb:00:00:01 192.168.0.1/24
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_port_security() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:198: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:198"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:198"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:198: ovn-nbctl lsp-add ls0 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:198"
( $at_check_trace; ovn-nbctl lsp-add ls0 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:198"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:198: ovn-nbctl lsp-get-addresses lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:198"
( $at_check_trace; ovn-nbctl lsp-get-addresses lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:198"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:198: ovn-nbctl lsp-set-port-security lp0 aa:bb:cc:dd:ee:ff 00:11:22:33:44:55"
at_fn_check_prepare_trace "ovn-nbctl.at:198"
( $at_check_trace; ovn-nbctl lsp-set-port-security lp0 aa:bb:cc:dd:ee:ff 00:11:22:33:44:55
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:198"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:198: ovn-nbctl lsp-get-port-security lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:198"
( $at_check_trace; ovn-nbctl lsp-get-port-security lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "00:11:22:33:44:55
aa:bb:cc:dd:ee:ff
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:198"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:198: ovn-nbctl lsp-set-port-security lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:198"
( $at_check_trace; ovn-nbctl lsp-set-port-security lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:198"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:198: ovn-nbctl lsp-get-port-security lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:198"
( $at_check_trace; ovn-nbctl lsp-get-port-security lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:198"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_acls() {

ovn_nbctl_test_acl() {
   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 --log acl-add \$1 from-lport 600 udp drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 --log acl-add $1 from-lport 600 udp drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 --log acl-add $1 from-lport 600 udp drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 --log --name=test --severity=info acl-add \$1 to-lport 500 udp drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 --log --name=test --severity=info acl-add $1 to-lport 500 udp drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 --log --name=test --severity=info acl-add $1 to-lport 500 udp drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-add \$1 from-lport 400 tcp drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-add $1 from-lport 400 tcp drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-add $1 from-lport 400 tcp drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-add \$1 to-lport 300 tcp drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-add $1 to-lport 300 tcp drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-add $1 to-lport 300 tcp drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-add \$1 from-lport 200 ip drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-add $1 from-lport 200 ip drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-add $1 from-lport 200 ip drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-add \$1 to-lport 100 ip drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-add $1 to-lport 100 ip drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-add $1 to-lport 100 ip drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 --label=1234 acl-add \$1 from-lport 70 icmp allow-related"
at_fn_check_prepare_dynamic "ovn-nbctl $2 --label=1234 acl-add $1 from-lport 70 icmp allow-related" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 --label=1234 acl-add $1 from-lport 70 icmp allow-related
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 --label=1235 acl-add \$1 to-lport 70 icmp allow-related"
at_fn_check_prepare_dynamic "ovn-nbctl $2 --label=1235 acl-add $1 to-lport 70 icmp allow-related" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 --label=1235 acl-add $1 to-lport 70 icmp allow-related
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 --apply-after-lb acl-add \$1 from-lport 500 tcp allow"
at_fn_check_prepare_dynamic "ovn-nbctl $2 --apply-after-lb acl-add $1 from-lport 500 tcp allow" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 --apply-after-lb acl-add $1 from-lport 500 tcp allow
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 --apply-after-lb acl-add \$1 from-lport 300 tcp drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 --apply-after-lb acl-add $1 from-lport 300 tcp drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 --apply-after-lb acl-add $1 from-lport 300 tcp drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 --apply-after-lb acl-add \$1 from-lport 300 udp allow"
at_fn_check_prepare_dynamic "ovn-nbctl $2 --apply-after-lb acl-add $1 from-lport 300 udp allow" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 --apply-after-lb acl-add $1 from-lport 300 udp allow
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }


      { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-add \$1 to-lport 100 ip drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-add $1 to-lport 100 ip drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-add $1 to-lport 100 ip drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: grep 'already existed' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; grep 'already existed' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 --may-exist acl-add \$1 to-lport 100 ip drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 --may-exist acl-add $1 to-lport 100 ip drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 --may-exist acl-add $1 to-lport 100 ip drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }


      { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 --label=1234 acl-add \$1 to-lport 50 ip drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 --label=1234 acl-add $1 to-lport 50 ip drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 --label=1234 acl-add $1 to-lport 50 ip drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: grep 'can only be set with actions' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; grep 'can only be set with actions' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }


   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 --label=abcd acl-add \$1 to-lport 50 ip allow-related"
at_fn_check_prepare_dynamic "ovn-nbctl $2 --label=abcd acl-add $1 to-lport 50 ip allow-related" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 --label=abcd acl-add $1 to-lport 50 ip allow-related
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: grep 'label must in range 0...4294967295' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; grep 'label must in range 0...4294967295' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }


   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 --label=-1 acl-add \$1 to-lport 50 ip allow-related"
at_fn_check_prepare_dynamic "ovn-nbctl $2 --label=-1 acl-add $1 to-lport 50 ip allow-related" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 --label=-1 acl-add $1 to-lport 50 ip allow-related
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: grep 'label must in range 0...4294967295' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; grep 'label must in range 0...4294967295' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }


   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 --label=4294967296 acl-add \$1 to-lport 50 ip allow-related"
at_fn_check_prepare_dynamic "ovn-nbctl $2 --label=4294967296 acl-add $1 to-lport 50 ip allow-related" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 --label=4294967296 acl-add $1 to-lport 50 ip allow-related
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: grep 'label must in range 0...4294967295' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; grep 'label must in range 0...4294967295' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }


   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-list \$1"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-list $1" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-list $1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "from-lport   600 (udp) drop log()
from-lport   400 (tcp) drop
from-lport   200 (ip) drop
from-lport    70 (icmp) allow-related label=1234
from-lport   500 (tcp) allow [after-lb]
from-lport   300 (tcp) drop [after-lb]
from-lport   300 (udp) allow [after-lb]
  to-lport   500 (udp) drop log(name=test,severity=info)
  to-lport   300 (tcp) drop
  to-lport   100 (ip) drop
  to-lport    70 (icmp) allow-related label=1235
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }


      { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-del \$1 to-lport"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-del $1 to-lport" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-del $1 to-lport
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-list \$1"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-list $1" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-list $1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "from-lport   600 (udp) drop log()
from-lport   400 (tcp) drop
from-lport   200 (ip) drop
from-lport    70 (icmp) allow-related label=1234
from-lport   500 (tcp) allow [after-lb]
from-lport   300 (tcp) drop [after-lb]
from-lport   300 (udp) allow [after-lb]
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }


      { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-del \$1"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-del $1" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-del $1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-list \$1"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-list $1" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-list $1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }


   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-add \$1 from-lport 600 udp drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-add $1 from-lport 600 udp drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-add $1 from-lport 600 udp drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-add \$1 from-lport 400 tcp drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-add $1 from-lport 400 tcp drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-add $1 from-lport 400 tcp drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-add \$1 from-lport 200 ip drop"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-add $1 from-lport 200 ip drop" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-add $1 from-lport 200 ip drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }


      { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-del \$1 from-lport 400 tcp"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-del $1 from-lport 400 tcp" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-del $1 from-lport 400 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl \$2 acl-list \$1"
at_fn_check_prepare_dynamic "ovn-nbctl $2 acl-list $1" "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl $2 acl-list $1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "from-lport   600 (udp) drop
from-lport   200 (ip) drop
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

}

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

ovn_nbctl_test_acl ls0
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl ls-add ls1"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl ls-add ls1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

ovn_nbctl_test_acl ls1 --type=switch
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl create port_group name=pg0"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl create port_group name=pg0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

ovn_nbctl_test_acl pg0 --type=port-group

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl --type=port-group acl-add pg1 to-lport 100 ip drop"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl --type=port-group acl-add pg1 to-lport 100 ip drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: pg1: port group name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl create port_group name=ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl create port_group name=ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl acl-add ls0 to-lport 100 ip drop"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl acl-add ls0 to-lport 100 ip drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: grep 'exists in both' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; grep 'exists in both' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:216: ovn-nbctl --type=port-group acl-add ls0 to-lport 100 ip drop"
at_fn_check_prepare_trace "ovn-nbctl.at:216"
( $at_check_trace; ovn-nbctl --type=port-group acl-add ls0 to-lport 100 ip drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:216"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_qos() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 from-lport 600 tcp dscp=63"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 from-lport 600 tcp dscp=63
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 from-lport 500 udp rate=100 burst=1000"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 from-lport 500 udp rate=100 burst=1000
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 from-lport 400 tcp dscp=0 rate=300 burst=3000"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 from-lport 400 tcp dscp=0 rate=300 burst=3000
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 to-lport 300 tcp dscp=48"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 to-lport 300 tcp dscp=48
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 to-lport 200 ip rate=101"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 to-lport 200 ip rate=101
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 to-lport 100 ip4 dscp=13 rate=301 burst=30000"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 to-lport 100 ip4 dscp=13 rate=301 burst=30000
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 to-lport 101 ip4 mark=15"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 to-lport 101 ip4 mark=15
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 to-lport 102 ip4 dscp=16 mark=17"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 to-lport 102 ip4 dscp=16 mark=17
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 to-lport 100 ip4 dscp=11 rate=302 burst=30002"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 to-lport 100 ip4 dscp=11 rate=302 burst=30002
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: grep 'already existed' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; grep 'already existed' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl --may-exist qos-add ls0 to-lport 100 ip4 dscp=11 rate=302 burst=30002"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl --may-exist qos-add ls0 to-lport 100 ip4 dscp=11 rate=302 burst=30002
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-list ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-list ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "from-lport   600 (tcp) dscp=63
from-lport   500 (udp) rate=100 burst=1000
from-lport   400 (tcp) rate=300 burst=3000 dscp=0
  to-lport   300 (tcp) dscp=48
  to-lport   200 (ip) rate=101
  to-lport   102 (ip4) dscp=16 mark=17
  to-lport   101 (ip4) mark=15
  to-lport   100 (ip4) rate=301 burst=30000 dscp=13
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-del ls0 to-lport"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-del ls0 to-lport
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-list ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-list ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "from-lport   600 (tcp) dscp=63
from-lport   500 (udp) rate=100 burst=1000
from-lport   400 (tcp) rate=300 burst=3000 dscp=0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-del ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-del ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-list ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-list ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 from-lport 600 ip rate=1000101"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 from-lport 600 ip rate=1000101
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 from-lport 400 tcp dscp=44"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 from-lport 400 tcp dscp=44
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-del ls0 from-lport 400 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-del ls0 from-lport 400 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-list ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-list ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "from-lport   600 (ip) rate=1000101
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-del ls0 \$(ovn-nbctl --bare --column _uuid list qos)"
at_fn_check_prepare_notrace 'a $(...) command substitution' "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-del ls0 $(ovn-nbctl --bare --column _uuid list qos)
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl list qos"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl list qos
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 from-lport 600 ip rate=100010111111"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 from-lport 600 ip rate=100010111111
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 100010111111: rate must be in the range 1...4294967295
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 from-lport 600 ip burst=100010111112 rate=100010"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 from-lport 600 ip burst=100010111112 rate=100010
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 100010111112: burst must be in the range 1...4294967295
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 from-lport 600 ip dscp=-1"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 from-lport 600 ip dscp=-1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: -1: dscp must be in the range 0...63
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 from-lport 600 ip dscpa=-1"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 from-lport 600 ip dscpa=-1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: dscpa=-1: supported arguments are \"dscp=\", \"rate=\", \"burst=\" and \"mark=\"
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:311: ovn-nbctl qos-add ls0 from-lport 600 ip burst=123"
at_fn_check_prepare_trace "ovn-nbctl.at:311"
( $at_check_trace; ovn-nbctl qos-add ls0 from-lport 600 ip burst=123
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Either \"mark\", \"rate\" and/or \"dscp\" must be specified
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:311"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_meters() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-add meter1 drop 10 kbps"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-add meter1 drop 10 kbps
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-add meter2 drop 3 kbps 2"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-add meter2 drop 3 kbps 2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-add meter3 drop 100 kbps 200"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-add meter3 drop 100 kbps 200
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl --fair meter-add meter4 drop 10 pktps 30"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl --fair meter-add meter4 drop 10 pktps 30
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-add meter1 drop 10 kbps"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-add meter1 drop 10 kbps
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: grep 'already exists' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; grep 'already exists' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl --may-exist meter-add meter1 drop 11 kbps"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl --may-exist meter-add meter1 drop 11 kbps
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-add __meter1 drop 10 kbps"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-add __meter1 drop 10 kbps
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: grep 'reserved' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; grep 'reserved' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-add meter5 drop 100010111111 kbps"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-add meter5 drop 100010111111 kbps
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: rate must be in the range 1...4294967295
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-add meter5 drop 100010111111 foo"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-add meter5 drop 100010111111 foo
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: rate must be in the range 1...4294967295
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-add meter5 drop 0 kbps"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-add meter5 drop 0 kbps
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: rate must be in the range 1...4294967295
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-add meter5 drop 10 100010111111 kbps"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-add meter5 drop 10 100010111111 kbps
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: unit must be \"kbps\" or \"pktps\"
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-list"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-list
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "meter1: bands:
  drop: 11 kbps
meter2: bands:
  drop: 3 kbps, 2 kb burst
meter3: bands:
  drop: 100 kbps, 200 kb burst
meter4: (fair) bands:
  drop: 10 pktps, 30 packet burst
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-del meter2"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-del meter2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-list"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-list
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "meter1: bands:
  drop: 11 kbps
meter3: bands:
  drop: 100 kbps, 200 kb burst
meter4: (fair) bands:
  drop: 10 pktps, 30 packet burst
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-del"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-del
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:387: ovn-nbctl meter-list"
at_fn_check_prepare_trace "ovn-nbctl.at:387"
( $at_check_trace; ovn-nbctl meter-list
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:387"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_mirrors() {

check ovn-nbctl mirror-add mirror1 gre 0 from-lport 10.10.10.1
check ovn-nbctl mirror-add mirror2 erspan 1 to-lport 10.10.10.2
check ovn-nbctl mirror-add mirror3 gre 2 to-lport 10.10.10.3
check ovn-nbctl mirror-add mirror-local local both 10.10.10.3
check ovn-nbctl ls-add sw0
check ovn-nbctl lsp-add sw0 sw0-port1
check ovn-nbctl lsp-add sw0 sw0-port2
check ovn-nbctl lsp-add sw0 sw0-port3

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:451: ovn-nbctl mirror-add mirror1 gre 0 from-lport 10.10.10.5"
at_fn_check_prepare_trace "ovn-nbctl.at:451"
( $at_check_trace; ovn-nbctl mirror-add mirror1 gre 0 from-lport 10.10.10.5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:451"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:451: grep 'already exists' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:451"
( $at_check_trace; grep 'already exists' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:451"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:451: ovn-nbctl lsp-attach-mirror sw0-port4 mirror3"
at_fn_check_prepare_trace "ovn-nbctl.at:451"
( $at_check_trace; ovn-nbctl lsp-attach-mirror sw0-port4 mirror3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:451"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:451: grep 'port name not found' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:451"
( $at_check_trace; grep 'port name not found' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:451"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:451: ovn-nbctl lsp-attach-mirror sw0-port3 mirror4"
at_fn_check_prepare_trace "ovn-nbctl.at:451"
( $at_check_trace; ovn-nbctl lsp-attach-mirror sw0-port3 mirror4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:451"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:451: grep 'mirror name not found' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:451"
( $at_check_trace; grep 'mirror name not found' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:451"
$at_failed && at_fn_log_failure
$at_traceon; }


mirror3uuid=$(fetch_column nb:Mirror _uuid name=mirror3)
check ovn-nbctl lsp-attach-mirror sw0-port1 mirror3
check_column "$mirror3uuid" nb:Logical_Switch_Port mirror_rules name=sw0-port1

check ovn-nbctl lsp-attach-mirror sw0-port3 mirror3
check_column "$mirror3uuid" nb:Logical_Switch_Port mirror_rules name=sw0-port3

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:451: ovn-nbctl mirror-list"
at_fn_check_prepare_trace "ovn-nbctl.at:451"
( $at_check_trace; ovn-nbctl mirror-list
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "mirror-local:
  Type     :  local
  Sink     :  10.10.10.3
  Filter   :  both

mirror1:
  Type     :  gre
  Sink     :  10.10.10.1
  Filter   :  from-lport
  Index/Key:  0

mirror2:
  Type     :  erspan
  Sink     :  10.10.10.2
  Filter   :  to-lport
  Index/Key:  1

mirror3:
  Type     :  gre
  Sink     :  10.10.10.3
  Filter   :  to-lport
  Index/Key:  2

" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:451"
$at_failed && at_fn_log_failure
$at_traceon; }


check ovn-nbctl mirror-del mirror-local

check ovn-nbctl lsp-detach-mirror sw0-port3 mirror3

check_column "" nb:Logical_Switch_Port mirror_rules name=sw0-port3

check ovn-nbctl mirror-del mirror3

check_column "" nb:Logical_Switch_Port mirror_rules name=sw0-port1

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:451: ovn-nbctl mirror-list"
at_fn_check_prepare_trace "ovn-nbctl.at:451"
( $at_check_trace; ovn-nbctl mirror-list
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "mirror1:
  Type     :  gre
  Sink     :  10.10.10.1
  Filter   :  from-lport
  Index/Key:  0

mirror2:
  Type     :  erspan
  Sink     :  10.10.10.2
  Filter   :  to-lport
  Index/Key:  1

" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:451"
$at_failed && at_fn_log_failure
$at_traceon; }


check ovn-nbctl mirror-del mirror2

check ovn-nbctl set mirror . sink=192.168.1.13

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:451: ovn-nbctl mirror-list"
at_fn_check_prepare_trace "ovn-nbctl.at:451"
( $at_check_trace; ovn-nbctl mirror-list
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "mirror1:
  Type     :  gre
  Sink     :  192.168.1.13
  Filter   :  from-lport
  Index/Key:  0

" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:451"
$at_failed && at_fn_log_failure
$at_traceon; }


check ovn-nbctl mirror-del
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:451: ovn-nbctl mirror-list"
at_fn_check_prepare_trace "ovn-nbctl.at:451"
( $at_check_trace; ovn-nbctl mirror-list
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:451"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_nats() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snatt 30.0.0.2 192.168.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snatt 30.0.0.2 192.168.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: snatt: type must be one of \"dnat\", \"snat\" and \"dnat_and_snat\".
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0.2a 192.168.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0.2a 192.168.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 30.0.0.2a: Not a valid IPv4 or IPv6 address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0 192.168.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0 192.168.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 30.0.0: Not a valid IPv4 or IPv6 address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0.2/24 192.168.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0.2/24 192.168.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 30.0.0.2/24: Not a valid IPv4 or IPv6 address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0.2:80 192.168.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0.2:80 192.168.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 30.0.0.2:80: Not a valid IPv4 or IPv6 address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0.2 192.168.1.2a"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0.2 192.168.1.2a
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.1.2a: should be an IPv4 address or network.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0.2 192.168.1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0.2 192.168.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.1: should be an IPv4 address or network.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0.2 192.168.1.2:80"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0.2 192.168.1.2:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.1.2:80: should be an IPv4 address or network.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0.2 192.168.1.2/a"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0.2 192.168.1.2/a
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.1.2/a: should be an IPv4 address or network.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat 30.0.0.2 192.168.1.2a"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat 30.0.0.2 192.168.1.2a
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.1.2a: Not a valid IPv4 address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat 30.0.0.2 192.168.1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat 30.0.0.2 192.168.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.1: Not a valid IPv4 address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat 30.0.0.2 192.168.1.2:80"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat 30.0.0.2 192.168.1.2:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.1.2:80: Not a valid IPv4 address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat 30.0.0.2 192.168.1.2/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat 30.0.0.2 192.168.1.2/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.1.2/24: Not a valid IPv4 address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.2/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.2/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.1.2/24: Not a valid IPv4 address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.2 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.2 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lr-nat-add with logical_port must also specify external_mac.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat 30.0.0.2 192.168.1.2 lp0 00:00:00:01:02:03"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat 30.0.0.2 192.168.1.2 lp0 00:00:00:01:02:03
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: logical_port and external_mac are only valid when type is \"dnat_and_snat\".
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0.2 192.168.1.2 lp0 00:00:00:01:02:03"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0.2 192.168.1.2 lp0 00:00:00:01:02:03
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: logical_port and external_mac are only valid when type is \"dnat_and_snat\".
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.2 lp0 00:00:00:01:02:03"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.2 lp0 00:00:00:01:02:03
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp0: port name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lsp-add ls0 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lsp-add ls0 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.2 lp0 00:00:00:01:02"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.2 lp0 00:00:00:01:02
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid mac address 00:00:00:01:02.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --add-route lr-nat-add lr0 snat 30.0.0.2 192.168.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --add-route lr-nat-add lr0 snat 30.0.0.2 192.168.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: routes cannot be added for snat types.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0.1 192.168.1.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0.1 192.168.1.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat fd01::1 fd11::/64"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat fd01::1 fd11::/64
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat 30.0.0.1 192.168.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat 30.0.0.1 192.168.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat fd01::1 fd11::2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat fd01::1 fd11::2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.1 192.168.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.1 192.168.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat_and_snat fd01::1 fd11::2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat_and_snat fd01::1 fd11::2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.3 lp0 00:00:00:01:02:03"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.3 lp0 00:00:00:01:02:03
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat_and_snat fd01::2 fd11::3 lp0 00:00:00:01:02:03"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat_and_snat fd01::2 fd11::3 lp0 00:00:00:01:02:03
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
dnat                                                         30.0.0.1                            192.168.1.2
dnat                                                         fd01::1                             fd11::2
dnat_and_snat                                                30.0.0.1                            192.168.1.2
dnat_and_snat                                                30.0.0.2                            192.168.1.3         00:00:00:01:02:03    lp0
dnat_and_snat                                                fd01::1                             fd11::2
dnat_and_snat                                                fd01::2                             fd11::3             00:00:00:01:02:03    lp0
snat                                                         30.0.0.1                            192.168.1.0/24
snat                                                         fd01::1                             fd11::/64
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0.1 192.168.1.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0.1 192.168.1.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 30.0.0.1, 192.168.1.0/24: a NAT with this external_ip and logical_ip already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0.1 192.168.1.10/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0.1 192.168.1.10/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 30.0.0.1, 192.168.1.0/24: a NAT with this external_ip and logical_ip already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --may-exist lr-nat-add lr0 snat 30.0.0.1 192.168.1.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --may-exist lr-nat-add lr0 snat 30.0.0.1 192.168.1.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 30.0.0.2 192.168.1.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 30.0.0.2 192.168.1.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: a NAT with this type (snat), logical_ip (192.168.1.0/24) already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat 30.0.0.1 192.168.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat 30.0.0.1 192.168.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 30.0.0.1, 192.168.1.2: a NAT with this external_ip and logical_ip already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --may-exist lr-nat-add lr0 dnat 30.0.0.1 192.168.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --may-exist lr-nat-add lr0 dnat 30.0.0.1 192.168.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat 30.0.0.1 192.168.1.3"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat 30.0.0.1 192.168.1.3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: a NAT with this type (dnat), external_ip (30.0.0.1) already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.1 192.168.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.1 192.168.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 30.0.0.1, 192.168.1.2: a NAT with this external_ip and logical_ip already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --may-exist lr-nat-add lr0 dnat_and_snat 30.0.0.1 192.168.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --may-exist lr-nat-add lr0 dnat_and_snat 30.0.0.1 192.168.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.1 192.168.1.3"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat_and_snat 30.0.0.1 192.168.1.3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: a NAT with this type (dnat_and_snat), external_ip (30.0.0.1) already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --may-exist lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.3 lp0 00:00:00:04:05:06"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --may-exist lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.3 lp0 00:00:00:04:05:06
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
dnat                                                         30.0.0.1                            192.168.1.2
dnat                                                         fd01::1                             fd11::2
dnat_and_snat                                                30.0.0.1                            192.168.1.2
dnat_and_snat                                                30.0.0.2                            192.168.1.3         00:00:00:04:05:06    lp0
dnat_and_snat                                                fd01::1                             fd11::2
dnat_and_snat                                                fd01::2                             fd11::3             00:00:00:01:02:03    lp0
snat                                                         30.0.0.1                            192.168.1.0/24
snat                                                         fd01::1                             fd11::/64
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --may-exist lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.3"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --may-exist lr-nat-add lr0 dnat_and_snat 30.0.0.2 192.168.1.3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --may-exist lr-nat-add lr0 dnat_and_snat fd01::2 fd11::3"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --may-exist lr-nat-add lr0 dnat_and_snat fd01::2 fd11::3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
dnat                                                         30.0.0.1                            192.168.1.2
dnat                                                         fd01::1                             fd11::2
dnat_and_snat                                                30.0.0.1                            192.168.1.2
dnat_and_snat                                                30.0.0.2                            192.168.1.3
dnat_and_snat                                                fd01::1                             fd11::2
dnat_and_snat                                                fd01::2                             fd11::3
snat                                                         30.0.0.1                            192.168.1.0/24
snat                                                         fd01::1                             fd11::/64
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


check_row_count nb:NAT 0 options:stateless=true
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --stateless lr-nat-add lr0 dnat_and_snat 40.0.0.2 192.168.1.4"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --stateless lr-nat-add lr0 dnat_and_snat 40.0.0.2 192.168.1.4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

check_row_count nb:NAT 1 options:stateless=true

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --stateless lr-nat-add lr0 dnat_and_snat fd21::1 fd11::2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --stateless lr-nat-add lr0 dnat_and_snat fd21::1 fd11::2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

check_row_count nb:NAT 2 options:stateless=true

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 dnat_and_snat fd21::1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 dnat_and_snat fd21::1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --stateless lr-nat-add lr0 dnat 40.0.0.2 192.168.1.4"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --stateless lr-nat-add lr0 dnat 40.0.0.2 192.168.1.4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: stateless is not applicable to dnat or snat types
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --stateless lr-nat-add lr0 snat 40.0.0.2 192.168.1.4"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --stateless lr-nat-add lr0 snat 40.0.0.2 192.168.1.4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: stateless is not applicable to dnat or snat types
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 40.0.0.2 192.168.1.5"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 40.0.0.2 192.168.1.5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 40.0.0.2, 192.168.1.5: External ip cannot be shared across stateless and stateful NATs
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat 40.0.0.2 192.168.1.5"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat 40.0.0.2 192.168.1.5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 40.0.0.2, 192.168.1.5: External ip cannot be shared across stateless and stateful NATs
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 40.0.0.3 192.168.1.6"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 40.0.0.3 192.168.1.6
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --stateless lr-nat-add lr0 dnat_and_snat 40.0.0.3 192.168.1.7"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --stateless lr-nat-add lr0 dnat_and_snat 40.0.0.3 192.168.1.7
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 40.0.0.3, 192.168.1.7: External ip cannot be shared across stateless and stateful NATs
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --stateless --may-exist lr-nat-add lr0 dnat_and_snat 40.0.0.3 192.168.1.7"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --stateless --may-exist lr-nat-add lr0 dnat_and_snat 40.0.0.3 192.168.1.7
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 dnat_and_snat 30.0.0.3"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 dnat_and_snat 30.0.0.3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 dnat_and_snat 30.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 dnat_and_snat 30.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 dnat_and_snat fd01::1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 dnat_and_snat fd01::1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
dnat                                                         30.0.0.1                            192.168.1.2
dnat                                                         fd01::1                             fd11::2
dnat_and_snat                                                30.0.0.2                            192.168.1.3
dnat_and_snat                                                40.0.0.2                            192.168.1.4
dnat_and_snat                                                fd01::2                             fd11::3
snat                                                         30.0.0.1                            192.168.1.0/24
snat                                                         40.0.0.3                            192.168.1.6
snat                                                         fd01::1                             fd11::/64
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 dnat"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 dnat
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
dnat_and_snat                                                30.0.0.2                            192.168.1.3
dnat_and_snat                                                40.0.0.2                            192.168.1.4
dnat_and_snat                                                fd01::2                             fd11::3
snat                                                         30.0.0.1                            192.168.1.0/24
snat                                                         40.0.0.3                            192.168.1.6
snat                                                         fd01::1                             fd11::/64
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 snat 40.0.0.3 192.168.1.6 21-65535"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 snat 40.0.0.3 192.168.1.6 21-65535
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat 40.0.0.4 192.168.1.7 1-3000"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat 40.0.0.4 192.168.1.7 1-3000
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat 40.0.0.5 192.168.1.10 1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat 40.0.0.5 192.168.1.10 1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.5 192.168.1.8 1-3000"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.5 192.168.1.8 1-3000
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 lp0 00:00:00:04:05:06 1-3000"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 lp0 00:00:00:04:05:06 1-3000
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 lp0 1-3000"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 lp0 1-3000
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lr-nat-add with logical_port must also specify external_mac.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 00:00:00:04:05:06 1-3000"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 00:00:00:04:05:06 1-3000
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lr-nat-add with logical_port must also specify external_mac.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.7 192.168.1.10 0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.7 192.168.1.10 0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid port range 0.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.7 192.168.1.10 1-"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.7 192.168.1.10 1-
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid port range 1-.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 -300"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 -300
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid port range -300.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.7 192.168.1.10 1-2-3"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.7 192.168.1.10 1-2-3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid port range 1-2-3.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 300-300"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 300-300
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid port range 300-300.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 500-300"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 500-300
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid port range 500-300.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 a-300"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 a-300
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid port range a-300.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 100-b"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 100-b
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid port range 100-b.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 0-10"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --portrange lr-nat-add lr0 dnat_and_snat 40.0.0.6 192.168.1.9 0-10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid port range 0-10.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl show lr0 | grep -c 'external port(s): \"1-3000\"'"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl show lr0 | grep -c 'external port(s): "1-3000"'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "3
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl show lr0 | grep -C2 'external port(s): \"21-65535\"' | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl show lr0 | grep -C2 'external port(s): "21-65535"' | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "    nat <0>
        external ip: \"40.0.0.3\"
        external port(s): \"21-65535\"
        logical ip: \"192.168.1.6\"
        type: \"snat\"
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl show lr0 | grep -C2 'external port(s): \"1\"' | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl show lr0 | grep -C2 'external port(s): "1"' | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "    nat <0>
        external ip: \"40.0.0.5\"
        external port(s): \"1\"
        logical ip: \"192.168.1.10\"
        type: \"dnat\"
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
dnat                                                         40.0.0.4           1-3000           192.168.1.7
dnat                                                         40.0.0.5           1                192.168.1.10
dnat_and_snat                                                40.0.0.5           1-3000           192.168.1.8
dnat_and_snat                                                40.0.0.6           1-3000           192.168.1.9         00:00:00:04:05:06    lp0
snat                                                         40.0.0.3           21-65535         192.168.1.6
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 dnat"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 dnat
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


check_uuid ovn-nbctl create Address_Set name=allowed_range addresses=\"1.1.1.1\"
check_uuid ovn-nbctl create Address_Set name=disallowed_range addresses=\"2.2.2.2\"
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 40.0.0.3 192.168.1.6"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 40.0.0.3 192.168.1.6
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-update-ext-ip lr0 snat 192.168.1.6 allowed_range"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-update-ext-ip lr0 snat 192.168.1.6 allowed_range
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --is-exempted lr-nat-update-ext-ip lr0 snat 192.168.1.6 disallowed_range"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --is-exempted lr-nat-update-ext-ip lr0 snat 192.168.1.6 disallowed_range
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-update-ext-ip lr0 snat 192.168.1.6 allowed_range_tmp"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-update-ext-ip lr0 snat 192.168.1.6 allowed_range_tmp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: allowed_range_tmp: Address Set name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --is-exempted lr-nat-update-ext-ip lr0 snat 192.168.1.6 disallowed_range_tmp"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --is-exempted lr-nat-update-ext-ip lr0 snat 192.168.1.6 disallowed_range_tmp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: disallowed_range_tmp: Address Set name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat 40.0.0.4 192.168.1.7"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat 40.0.0.4 192.168.1.7
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-update-ext-ip lr0 dnat 40.0.0.4 allowed_range"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-update-ext-ip lr0 dnat 40.0.0.4 allowed_range
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --is-exempted lr-nat-update-ext-ip lr0 dnat 40.0.0.4 disallowed_range"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --is-exempted lr-nat-update-ext-ip lr0 dnat 40.0.0.4 disallowed_range
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-update-ext-ip lr0 dnat 40.0.0.4 allowed_range_tmp"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-update-ext-ip lr0 dnat 40.0.0.4 allowed_range_tmp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: allowed_range_tmp: Address Set name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --is-exempted lr-nat-update-ext-ip lr0 dnat 40.0.0.4 disallowed_range_tmp"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --is-exempted lr-nat-update-ext-ip lr0 dnat 40.0.0.4 disallowed_range_tmp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: disallowed_range_tmp: Address Set name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat_and_snat 40.0.0.5 192.168.1.8"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat_and_snat 40.0.0.5 192.168.1.8
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-update-ext-ip lr0 dnat_and_snat 40.0.0.5 allowed_range"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-update-ext-ip lr0 dnat_and_snat 40.0.0.5 allowed_range
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --is-exempted lr-nat-update-ext-ip lr0 dnat 40.0.0.4 disallowed_range"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --is-exempted lr-nat-update-ext-ip lr0 dnat 40.0.0.4 disallowed_range
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-update-ext-ip lr0 dnat 40.0.0.4 allowed_range_tmp"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-update-ext-ip lr0 dnat 40.0.0.4 allowed_range_tmp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: allowed_range_tmp: Address Set name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --is-exempted lr-nat-update-ext-ip lr0 dnat 40.0.0.4 disallowed_range_tmp"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --is-exempted lr-nat-update-ext-ip lr0 dnat 40.0.0.4 disallowed_range_tmp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: disallowed_range_tmp: Address Set name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-update-ext-ip lr0 snat 192.168.1.6"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-update-ext-ip lr0 snat 192.168.1.6
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 'lr-nat-update-ext-ip' command requires at least 4 arguments
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-update-ext-ip lr0 snat 192.168.16 allowed_range"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-update-ext-ip lr0 snat 192.168.16 allowed_range
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.16: Invalid IP address or CIDR
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lrp-add lr0 lrp00 00:00:00:01:02:03 172.64.0.10/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lrp-add lr0 lrp00 00:00:00:01:02:03 172.64.0.10/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lrp-add lr0 lrp01 00:00:00:01:02:04 172.64.1.10/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lrp-add lr0 lrp01 00:00:00:01:02:04 172.64.1.10/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lrp-set-gateway-chassis lrp00 chassis1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lrp-set-gateway-chassis lrp00 chassis1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-add lr1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-add lr1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lrp-add lr1 lrp10 00:00:00:01:02:05 172.64.2.10/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lrp-add lr1 lrp10 00:00:00:01:02:05 172.64.2.10/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --gateway-port=lrp01 lr-nat-add lr0 dnat 172.64.1.10 20.0.0.10"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --gateway-port=lrp01 lr-nat-add lr0 dnat 172.64.1.10 20.0.0.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lrp01 is not a distributed gateway router port.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --gateway-port=lrp10 lr-nat-add lr0 dnat_and_snat 172.64.2.10 20.0.0.10"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --gateway-port=lrp10 lr-nat-add lr0 dnat_and_snat 172.64.2.10 20.0.0.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lrp10 is not a router port of logical router: lr0.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lrp-set-gateway-chassis lrp01 chassis2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lrp-set-gateway-chassis lrp01 chassis2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --gateway-port=lrp00 lr-nat-add lr0 snat 172.64.0.10 20.0.0.10"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --gateway-port=lrp00 lr-nat-add lr0 snat 172.64.0.10 20.0.0.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 172.64.1.10 20.0.0.10"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 172.64.1.10 20.0.0.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat 30.0.0.10 20.0.0.10"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat 30.0.0.10 20.0.0.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: logical router: lr0 has multiple distributed gateway ports and gateway_port can not be determined from external IP of NAT rule.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --gateway-port=lrp00 lr-nat-add lr0 dnat 30.0.0.10 20.0.0.10"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --gateway-port=lrp00 lr-nat-add lr0 dnat 30.0.0.10 20.0.0.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --gateway-port=lrp01 lr-nat-add lr0 snat 172.64.1.10 20.0.0.10"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --gateway-port=lrp01 lr-nat-add lr0 snat 172.64.1.10 20.0.0.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 172.64.1.10, 20.0.0.10: a NAT with this external_ip and logical_ip already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --gateway-port=lrp00 lr-nat-add lr0 dnat 30.0.0.10 20.0.0.11"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --gateway-port=lrp00 lr-nat-add lr0 dnat 30.0.0.10 20.0.0.11
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: a NAT with this type (dnat), external_ip (30.0.0.10) already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --gateway-port=lrp01 lr-nat-add lr0 dnat 30.0.0.10 20.0.0.10"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --gateway-port=lrp01 lr-nat-add lr0 dnat 30.0.0.10 20.0.0.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
dnat             lrp00                                       30.0.0.10                           20.0.0.10
dnat             lrp01                                       30.0.0.10                           20.0.0.10
snat                                                         172.64.1.10                         20.0.0.10
snat             lrp00                                       172.64.0.10                         20.0.0.10
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 dnat 30.0.0.10"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 dnat 30.0.0.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
snat                                                         172.64.1.10                         20.0.0.10
snat             lrp00                                       172.64.0.10                         20.0.0.10
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --gateway-port=lrp00 lr-nat-add lr0 snat 30.0.0.10 20.0.0.20"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --gateway-port=lrp00 lr-nat-add lr0 snat 30.0.0.10 20.0.0.20
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
snat                                                         172.64.1.10                         20.0.0.10
snat             lrp00                                       172.64.0.10                         20.0.0.10
snat             lrp00                                       30.0.0.10                           20.0.0.20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 dnat lrp11"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 dnat lrp11
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lrp11: port name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 snat lrp00"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 snat lrp00
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
snat                                                         172.64.1.10                         20.0.0.10
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 snat lrp01"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 snat lrp01
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
snat                                                         172.64.1.10                         20.0.0.10
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 snat 20.0.0 lrp01"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 snat 20.0.0 lrp01
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 20.0.0: Invalid IP address or CIDR
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 snat 20.0.0.10 lrp01"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 snat 20.0.0.10 lrp01
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: no matching NAT with the type (snat), logical_ip (20.0.0.10) and gateway_port (lrp01)
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --if-exists lr-nat-del lr0 snat 20.0.0.10 lrp01"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --if-exists lr-nat-del lr0 snat 20.0.0.10 lrp01
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 snat"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 snat
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lrp-del-gateway-chassis lrp00 chassis1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lrp-del-gateway-chassis lrp00 chassis1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lrp-del-gateway-chassis lrp01 chassis2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lrp-del-gateway-chassis lrp01 chassis2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 snat 10.0.0.1 192.168.0.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 snat 10.0.0.1 192.168.0.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --match=\"tcp\" lr-nat-add lr0 snat 10.0.0.2 192.168.0.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --match="tcp" lr-nat-add lr0 snat 10.0.0.2 192.168.0.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
snat                                                         10.0.0.1                            192.168.0.0/24
snat                                   tcp                   10.0.0.2                            192.168.0.0/24
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --match=\"tcp\" lr-nat-add lr0 snat 10.0.0.3 192.168.0.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --match="tcp" lr-nat-add lr0 snat 10.0.0.3 192.168.0.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: a NAT with this type (snat), logical_ip (192.168.0.0/24) and match \"tcp\" already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --match=\"tcp\" lr-nat-add lr0 snat 10.0.0.2 192.168.0.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --match="tcp" lr-nat-add lr0 snat 10.0.0.2 192.168.0.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 10.0.0.2, 192.168.0.0/24: a NAT with this external_ip and logical_ip already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --may-exist --priority=5 --match=\"udp\" lr-nat-add lr0 snat 10.0.0.2 192.168.0.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --may-exist --priority=5 --match="udp" lr-nat-add lr0 snat 10.0.0.2 192.168.0.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
snat                                                         10.0.0.1                            192.168.0.0/24
snat                                   udp                   10.0.0.2                            192.168.0.0/24
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --match=\"udp\" lr-nat-del lr0 snat 192.168.0.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --match="udp" lr-nat-del lr0 snat 192.168.0.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
snat                                                         10.0.0.1                            192.168.0.0/24
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 snat 192.168.0.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 snat 192.168.0.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat 10.0.0.1 192.168.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat 10.0.0.1 192.168.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --match=\"tcp\" lr-nat-add lr0 dnat 10.0.0.1 192.168.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --match="tcp" lr-nat-add lr0 dnat 10.0.0.1 192.168.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
dnat                                                         10.0.0.1                            192.168.0.1
dnat                                   tcp                   10.0.0.1                            192.168.0.2
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --match=\"tcp\" lr-nat-add lr0 dnat 10.0.0.1 192.168.0.3"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --match="tcp" lr-nat-add lr0 dnat 10.0.0.1 192.168.0.3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: a NAT with this type (dnat), external_ip (10.0.0.1) and match \"tcp\" already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --match=\"tcp\" lr-nat-add lr0 dnat 10.0.0.1 192.168.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --match="tcp" lr-nat-add lr0 dnat 10.0.0.1 192.168.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 10.0.0.1, 192.168.0.2: a NAT with this external_ip and logical_ip already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --may-exist --priority=10 --match=\"udp\" lr-nat-add lr0 dnat 10.0.0.1 192.168.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --may-exist --priority=10 --match="udp" lr-nat-add lr0 dnat 10.0.0.1 192.168.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
dnat                                                         10.0.0.1                            192.168.0.1
dnat                                   udp                   10.0.0.1                            192.168.0.2
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --match=\"udp\" lr-nat-del lr0 dnat 10.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --match="udp" lr-nat-del lr0 dnat 10.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
dnat                                                         10.0.0.1                            192.168.0.1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-del lr0 dnat 10.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-del lr0 dnat 10.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-add lr0 dnat_and_snat 10.0.0.1 192.168.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-add lr0 dnat_and_snat 10.0.0.1 192.168.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --match=\"tcp\" lr-nat-add lr0 dnat_and_snat 10.0.0.1 192.168.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --match="tcp" lr-nat-add lr0 dnat_and_snat 10.0.0.1 192.168.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
dnat_and_snat                                                10.0.0.1                            192.168.0.1
dnat_and_snat                          tcp                   10.0.0.1                            192.168.0.2
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --match=\"tcp\" lr-nat-add lr0 dnat_and_snat 10.0.0.1 192.168.0.3"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --match="tcp" lr-nat-add lr0 dnat_and_snat 10.0.0.1 192.168.0.3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: a NAT with this type (dnat_and_snat), external_ip (10.0.0.1) and match \"tcp\" already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --match=\"tcp\" lr-nat-add lr0 dnat_and_snat 10.0.0.1 192.168.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --match="tcp" lr-nat-add lr0 dnat_and_snat 10.0.0.1 192.168.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 10.0.0.1, 192.168.0.2: a NAT with this external_ip and logical_ip already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --may-exist --priority=10 --match=\"udp\" lr-nat-add lr0 dnat_and_snat 10.0.0.1 192.168.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --may-exist --priority=10 --match="udp" lr-nat-add lr0 dnat_and_snat 10.0.0.1 192.168.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl lr-nat-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl lr-nat-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "TYPE             GATEWAY_PORT          MATCH                 EXTERNAL_IP        EXTERNAL_PORT    LOGICAL_IP          EXTERNAL_MAC         LOGICAL_PORT
dnat_and_snat                                                10.0.0.1                            192.168.0.1
dnat_and_snat                          udp                   10.0.0.1                            192.168.0.2
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:562: ovn-nbctl --priority=5 lr-nat-add lr0 snat 10.0.0.2 192.168.0.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:562"
( $at_check_trace; ovn-nbctl --priority=5 lr-nat-add lr0 snat 10.0.0.2 192.168.0.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: priority can be set only with --match option.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:562"
$at_failed && at_fn_log_failure
$at_traceon; }



    }


    ovn_nbctl_lbs() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.10:80a 192.168.10.10:80,192.168.10.20:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.10:80a 192.168.10.10:80,192.168.10.20:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 30.0.0.10:80a: should be an IP address (or an IP address and a port number with : as a separator).
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.10:a80 192.168.10.10:80,192.168.10.20:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.10:a80 192.168.10.10:80,192.168.10.20:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 30.0.0.10:a80: should be an IP address (or an IP address and a port number with : as a separator).
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.10:80 192.168.10.10:80,192.168.10.20 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.10:80 192.168.10.10:80,192.168.10.20 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.10.20: should be an IP address and a port number with : as a separator.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.1a 192.168.10.10:80,192.168.10.20:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.1a 192.168.10.10:80,192.168.10.20:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 30.0.0.1a: should be an IP address (or an IP address and a port number with : as a separator).
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0 192.168.10.10:80,192.168.10.20:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0 192.168.10.10:80,192.168.10.20:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 30.0.0: should be an IP address (or an IP address and a port number with : as a separator).
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.10 192.168.10.10,192.168.10.20:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.10 192.168.10.10,192.168.10.20:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.10.20:80: should be an IP address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.10 192.168.10.10:a80"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.10 192.168.10.10:a80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.10.10:a80: should be an IP address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.10 192.168.10.1a"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 30.0.0.10 192.168.10.1a
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.10.1a: should be an IP address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb0 30.0.0.10: 192.168.10.10:80,192.168.10.20:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb0 30.0.0.10: 192.168.10.10:80,192.168.10.20:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.10.10:80: should be an IP address, 192.168.10.20:80: should be an IP address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb0 30.0.0.10 192.168.10.10 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb0 30.0.0.10 192.168.10.10 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Protocol is unnecessary when no port of vip is given.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb0 30.0.0.10 192.168.10.10 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb0 30.0.0.10 192.168.10.10 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Protocol is unnecessary when no port of vip is given.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb0 30.0.0.10:80 ,,,192.168.10.10:80,,,,,"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb0 30.0.0.10:80 ,,,192.168.10.10:80,,,,,
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb1 30.0.0.10:80 ,,,192.168.10.10:80,,,,192.168.10.20:80,,,,"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb1 30.0.0.10:80 ,,,192.168.10.10:80,,,,192.168.10.20:80,,,,
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP             IPs
<0>    lb0                 tcp        30.0.0.10:80    192.168.10.10:80
<1>    lb1                 tcp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-del lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-del lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-del lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-del lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb0 30.0.0.10:80 192.168.10.10:80,192.168.10.20:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb0 30.0.0.10:80 192.168.10.10:80,192.168.10.20:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb1 30.0.0.10:80 192.168.10.10:80,192.168.10.20:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb1 30.0.0.10:80 192.168.10.10:80,192.168.10.20:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP             IPs
<0>    lb0                 tcp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
<1>    lb1                 tcp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl --may-exist lb-add lb1 30.0.0.10:80 192.168.10.10:80,192.168.10.20:8080"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl --may-exist lb-add lb1 30.0.0.10:80 192.168.10.10:80,192.168.10.20:8080
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP             IPs
<0>    lb0                 tcp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
<1>    lb1                 tcp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:8080
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl --may-exist lb-add lb1 30.0.0.10:80 192.168.10.10:80,192.168.10.20:8080 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl --may-exist lb-add lb1 30.0.0.10:80 192.168.10.10:80,192.168.10.20:8080 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP             IPs
<0>    lb0                 tcp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
<1>    lb1                 udp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:8080
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb1 30.0.0.20:80 192.168.10.10:80 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb1 30.0.0.20:80 192.168.10.10:80 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP             IPs
<0>    lb0                 tcp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
<1>    lb1                 udp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:8080
                                                            udp        30.0.0.20:80    192.168.10.10:80
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-del lb1 30.0.0.20:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-del lb1 30.0.0.20:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP             IPs
<0>    lb0                 tcp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
<1>    lb1                 udp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:8080
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb2 30.0.0.30 192.168.10.10"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb2 30.0.0.30 192.168.10.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb3 30.0.0.30 192.168.10.10"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb3 30.0.0.30 192.168.10.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP             IPs
<0>    lb0                 tcp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
<1>    lb1                 udp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:8080
<2>    lb2                            30.0.0.30       192.168.10.10
<3>    lb3                            30.0.0.30       192.168.10.10
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-del lb2 30.0.0.30"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-del lb2 30.0.0.30
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-del lb3 30.0.0.30"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-del lb3 30.0.0.30
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb2 30.0.0.10:8080 192.168.10.10:80,192.168.10.20:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb2 30.0.0.10:8080 192.168.10.10:80,192.168.10.20:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl --add-duplicate lb-add lb2 30.0.0.10:8080 192.168.10.10:80,192.168.10.20:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl --add-duplicate lb-add lb2 30.0.0.10:8080 192.168.10.10:80,192.168.10.20:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP               IPs
<0>    lb0                 tcp        30.0.0.10:80      192.168.10.10:80,192.168.10.20:80
<1>    lb1                 udp        30.0.0.10:80      192.168.10.10:80,192.168.10.20:8080
<2>    lb2                 tcp        30.0.0.10:8080    192.168.10.10:80,192.168.10.20:80
<3>    lb2                 tcp        30.0.0.10:8080    192.168.10.10:80,192.168.10.20:80
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb2 30.0.0.10:8080 192.168.10.10:80,192.168.10.20:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb2 30.0.0.10:8080 192.168.10.10:80,192.168.10.20:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Multiple load balancers named 'lb2'.  Use a UUID.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-del lb2"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-del lb2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Multiple load balancers named 'lb2'.  Use a UUID.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl --may-exist lb-add lb1 30.0.0.10:80 192.168.10.10:8080,192.168.10.20:8080 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl --may-exist lb-add lb1 30.0.0.10:80 192.168.10.10:8080,192.168.10.20:8080 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl --may-exist lb-add lb1 30.0.0.10:8080 192.168.10.10:8080,192.168.10.20:8080 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl --may-exist lb-add lb1 30.0.0.10:8080 192.168.10.10:8080,192.168.10.20:8080 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl --may-exist lb-add lb1 30.0.0.10:9090 192.168.10.10:8080,192.168.10.20:8080 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl --may-exist lb-add lb1 30.0.0.10:9090 192.168.10.10:8080,192.168.10.20:8080 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-del lb0 30.0.0.10:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-del lb0 30.0.0.10:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-del lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-del lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP               IPs
<0>    lb2                 tcp        30.0.0.10:8080    192.168.10.10:80,192.168.10.20:80
<1>    lb2                 tcp        30.0.0.10:8080    192.168.10.10:80,192.168.10.20:80
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb0 30.0.0.10:80 192.168.10.10:80,192.168.10.20:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb0 30.0.0.10:80 192.168.10.10:80,192.168.10.20:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb1 30.0.0.10:80 192.168.10.10:80,192.168.10.20:80 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb1 30.0.0.10:80 192.168.10.10:80,192.168.10.20:80 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb3 30.0.0.10 192.168.10.10,192.168.10.20"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb3 30.0.0.10 192.168.10.10,192.168.10.20
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-add ls0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-add ls0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl --may-exist ls-lb-add ls0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl --may-exist ls-lb-add ls0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-add ls0 lb2"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Multiple load balancers named 'lb2'.  Use a UUID.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-add ls0 lb3"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP             IPs
<0>    lb0                 tcp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
<1>    lb1                 udp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
<2>    lb3                            30.0.0.10       192.168.10.10,192.168.10.20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-del ls0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-del ls0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP             IPs
<0>    lb1                 udp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
<1>    lb3                            30.0.0.10       192.168.10.10,192.168.10.20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-del ls0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-del ls0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-del ls0 lb3"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-del ls0 lb3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl --if-exists ls-lb-del ls0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl --if-exists ls-lb-del ls0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb4 40.0.0.10 162.168.10.10,162.168.10.20"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb4 40.0.0.10 162.168.10.10,162.168.10.20
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb5 50.0.0.10 172.168.10.10,172.168.10.20"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb5 50.0.0.10 172.168.10.10,172.168.10.20
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-add lb6 60.0.0.10 182.168.10.10,182.168.10.20"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-add lb6 60.0.0.10 182.168.10.10,182.168.10.20
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


lb4=$(fetch_column nb:load_balancer _uuid name=lb4)
lb5=$(fetch_column nb:load_balancer _uuid name=lb5)
lb6=$(fetch_column nb:load_balancer _uuid name=lb6)

lbg=$(ovn-nbctl create load_balancer_group name=lbg -- \
  add load_balancer_group lbg load_balancer $lb4 -- \
  add load_balancer_group lbg load_balancer $lb5 -- \
  add load_balancer_group lbg load_balancer $lb6)

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl add logical_switch ls0 load_balancer_group \$lbg"
at_fn_check_prepare_dynamic "ovn-nbctl add logical_switch ls0 load_balancer_group $lbg" "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl add logical_switch ls0 load_balancer_group $lbg
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP          IPs
<0>    lb4                            40.0.0.10    162.168.10.10,162.168.10.20
<1>    lb5                            50.0.0.10    172.168.10.10,172.168.10.20
<2>    lb6                            60.0.0.10    182.168.10.10,182.168.10.20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl remove logical_switch ls0 load_balancer_group \$lbg"
at_fn_check_prepare_dynamic "ovn-nbctl remove logical_switch ls0 load_balancer_group $lbg" "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl remove logical_switch ls0 load_balancer_group $lbg
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-add ls0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-add ls0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-add ls0 lb3"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-del ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-del ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-add lr0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-add lr0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl --may-exist lr-lb-add lr0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl --may-exist lr-lb-add lr0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-add lr0 lb2"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Multiple load balancers named 'lb2'.  Use a UUID.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-add lr0 lb3"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP             IPs
<0>    lb0                 tcp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
<1>    lb1                 udp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
<2>    lb3                            30.0.0.10       192.168.10.10,192.168.10.20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-del lr0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-del lr0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP             IPs
<0>    lb1                 udp        30.0.0.10:80    192.168.10.10:80,192.168.10.20:80
<1>    lb3                            30.0.0.10       192.168.10.10,192.168.10.20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-del lr0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-del lr0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-del lr0 lb3"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-del lr0 lb3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl --if-exists lr-lb-del lr0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl --if-exists lr-lb-del lr0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-add lr0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-add lr0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-add lr0 lb3"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-add lr0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-add ls0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-del lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-del lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lb-del lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lb-del lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl ls-lb-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl ls-lb-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl add logical_router lr0 load_balancer_group \$lbg"
at_fn_check_prepare_dynamic "ovn-nbctl add logical_router lr0 load_balancer_group $lbg" "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl add logical_router lr0 load_balancer_group $lbg
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1044: ovn-nbctl lr-lb-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1044"
( $at_check_trace; ovn-nbctl lr-lb-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP          IPs
<0>    lb4                            40.0.0.10    162.168.10.10,162.168.10.20
<1>    lb5                            50.0.0.10    172.168.10.10,172.168.10.20
<2>    lb6                            60.0.0.10    182.168.10.10,182.168.10.20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1044"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_lbs_ipv6() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl -vsocket_util:off lb-add lb0 [ae0f::10]:80a [fd0f::10]:80,[fd0f::20]:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 [ae0f::10]:80a [fd0f::10]:80,[fd0f::20]:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: [ae0f::10]:80a: should be an IP address (or an IP address and a port number with : as a separator).
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }



{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl -vsocket_util:off lb-add lb0 [ae0f::10]:a80 [fd0f::10]:80,[fd0f::20]:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 [ae0f::10]:a80 [fd0f::10]:80,[fd0f::20]:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: [ae0f::10]:a80: should be an IP address (or an IP address and a port number with : as a separator).
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }



{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl -vsocket_util:off lb-add lb0 [ae0f::10]:80 [fd0f::10]:80,fd0f::20 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 [ae0f::10]:80 [fd0f::10]:80,fd0f::20 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: fd0f::20: should be an IP address and a port number with : as a separator.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }



{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl -vsocket_util:off lb-add lb0 ae0f::10fff [fd0f::10]:80,fd0f::20 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 ae0f::10fff [fd0f::10]:80,fd0f::20 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: ae0f::10fff: should be an IP address (or an IP address and a port number with : as a separator).
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }



{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl -vsocket_util:off lb-add lb0 ae0f::10 [fd0f::10]:80,[fd0f::20]:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 ae0f::10 [fd0f::10]:80,[fd0f::20]:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: [fd0f::10]:80: should be an IP address, [fd0f::20]:80: should be an IP address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }



{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl -vsocket_util:off lb-add lb0 ae0f::10 fd0f::10,[fd0f::20]:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 ae0f::10 fd0f::10,[fd0f::20]:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: [fd0f::20]:80: should be an IP address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }



{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl -vsocket_util:off lb-add lb0 ae0f::10 [fd0f::10]:a80"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 ae0f::10 [fd0f::10]:a80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: [fd0f::10]:a80: should be an IP address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }



{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl -vsocket_util:off lb-add lb0 ae0f::10 fd0f::1001a"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 ae0f::10 fd0f::1001a
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: fd0f::1001a: should be an IP address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }



{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl -vsocket_util:off lb-add lb0 [ae0f::10]: [fd0f::10]:80,[fd0f::20]:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl -vsocket_util:off lb-add lb0 [ae0f::10]: [fd0f::10]:80,[fd0f::20]:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: [fd0f::10]:80: should be an IP address, [fd0f::20]:80: should be an IP address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }



{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb0 ae0f::10 fd0f::10 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb0 ae0f::10 fd0f::10 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Protocol is unnecessary when no port of vip is given.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }



{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb0 ae0f::10 [fd0f::10]:900 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb0 ae0f::10 [fd0f::10]:900 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: [fd0f::10]:900: should be an IP address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb0 ae0f::10 192.168.10.10"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb0 ae0f::10 192.168.10.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.10.10: IP address family is different from VIP ae0f::10.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb0 ae0f::10 192.168.10.10"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb0 ae0f::10 192.168.10.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.10.10: IP address family is different from VIP ae0f::10.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb0 [ae0f::10]:80 192.168.10.10:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb0 [ae0f::10]:80 192.168.10.10:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: 192.168.10.10:80: IP address family is different from VIP ae0f::10.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb0 30.0.0.10 ae0f::10"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb0 30.0.0.10 ae0f::10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: ae0f::10: IP address family is different from VIP 30.0.0.10.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb0 30.0.0.10:80 [ae0f::10]:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb0 30.0.0.10:80 [ae0f::10]:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: [ae0f::10]:80: IP address family is different from VIP 30.0.0.10.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb0 ae0f::10 fd0f::10"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb0 ae0f::10 fd0f::10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb0 ae0f:0000:0000:0000:0000:0000:0000:0010 fd0f::20"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb0 ae0f:0000:0000:0000:0000:0000:0000:0010 fd0f::20
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lb0: a load balancer with this vip (ae0f::10) already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-del lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-del lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb0 [ae0f::10]:80 ,,,[fd0f::10]:80,,,,,"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb0 [ae0f::10]:80 ,,,[fd0f::10]:80,,,,,
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb1 [ae0f::10]:80 ,,,[fd0f::10]:80,,,,[fd0f::20]:80,,,,"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb1 [ae0f::10]:80 ,,,[fd0f::10]:80,,,,[fd0f::20]:80,,,,
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb0                 tcp        [ae0f::10]:80    [fd0f::10]:80
<1>    lb1                 tcp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-del lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-del lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-del lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-del lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }



{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb0 [ae0f::10]:80 [fd0f::10]:80,[fd0f::20]:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb0 [ae0f::10]:80 [fd0f::10]:80,[fd0f::20]:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb1 [ae0f::10]:80 [fd0f::10]:80,[fd0f::20]:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb1 [ae0f::10]:80 [fd0f::10]:80,[fd0f::20]:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb0                 tcp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
<1>    lb1                 tcp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl --may-exist lb-add lb1 [ae0f::10]:80 [fd0f::10]:80,[fd0f::20]:8080"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl --may-exist lb-add lb1 [ae0f::10]:80 [fd0f::10]:80,[fd0f::20]:8080
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb0                 tcp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
<1>    lb1                 tcp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:8080
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl --may-exist lb-add lb1 [ae0f::10]:80 [fd0f::10]:80,[fd0f::20]:8080 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl --may-exist lb-add lb1 [ae0f::10]:80 [fd0f::10]:80,[fd0f::20]:8080 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb0                 tcp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
<1>    lb1                 udp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:8080
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb1 [ae0f::20]:80 [fd0f::10]:80 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb1 [ae0f::20]:80 [fd0f::10]:80 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb0                 tcp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
<1>    lb1                 udp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:8080
                                                            udp        [ae0f::20]:80    [fd0f::10]:80
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-del lb1 [ae0f::20]:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-del lb1 [ae0f::20]:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb0                 tcp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
<1>    lb1                 udp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:8080
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb2 ae0f::30 fd0f::10"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb2 ae0f::30 fd0f::10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb3 ae0f::30 fd0f::10"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb3 ae0f::30 fd0f::10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb0                 tcp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
<1>    lb1                 udp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:8080
<2>    lb2                            ae0f::30         fd0f::10
<3>    lb3                            ae0f::30         fd0f::10
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-del lb2 ae0f::30"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-del lb2 ae0f::30
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-del lb3 ae0f::30"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-del lb3 ae0f::30
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb2 [ae0f::10]:8080 [fd0f::10]:80,[fd0f::20]:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb2 [ae0f::10]:8080 [fd0f::10]:80,[fd0f::20]:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl --add-duplicate lb-add lb2 [ae0f::10]:8080 [fd0f::10]:80,[fd0f::20]:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl --add-duplicate lb-add lb2 [ae0f::10]:8080 [fd0f::10]:80,[fd0f::20]:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP                IPs
<0>    lb0                 tcp        [ae0f::10]:80      [fd0f::10]:80,[fd0f::20]:80
<1>    lb1                 udp        [ae0f::10]:80      [fd0f::10]:80,[fd0f::20]:8080
<2>    lb2                 tcp        [ae0f::10]:8080    [fd0f::10]:80,[fd0f::20]:80
<3>    lb2                 tcp        [ae0f::10]:8080    [fd0f::10]:80,[fd0f::20]:80
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb2 [ae0f::10]:8080 [fd0f::10]:80,[fd0f::20]:80 tcp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb2 [ae0f::10]:8080 [fd0f::10]:80,[fd0f::20]:80 tcp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Multiple load balancers named 'lb2'.  Use a UUID.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-del lb2"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-del lb2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Multiple load balancers named 'lb2'.  Use a UUID.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl --may-exist lb-add lb1 [ae0f::10]:80 [fd0f::10]:8080,[fd0f::20]:8080 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl --may-exist lb-add lb1 [ae0f::10]:80 [fd0f::10]:8080,[fd0f::20]:8080 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl --may-exist lb-add lb1 [ae0f::10]:8080 [fd0f::10]:8080,[fd0f::20]:8080 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl --may-exist lb-add lb1 [ae0f::10]:8080 [fd0f::10]:8080,[fd0f::20]:8080 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl --may-exist lb-add lb1 [ae0f::10]:9090 [fd0f::10]:8080,[fd0f::20]:8080 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl --may-exist lb-add lb1 [ae0f::10]:9090 [fd0f::10]:8080,[fd0f::20]:8080 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-del lb0 [ae0f::10]:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-del lb0 [ae0f::10]:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-del lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-del lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP                IPs
<0>    lb2                 tcp        [ae0f::10]:8080    [fd0f::10]:80,[fd0f::20]:80
<1>    lb2                 tcp        [ae0f::10]:8080    [fd0f::10]:80,[fd0f::20]:80
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb0 [ae0f::10]:80 [fd0f::10]:80,[fd0f::20]:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb0 [ae0f::10]:80 [fd0f::10]:80,[fd0f::20]:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb1 [ae0f::10]:80 [fd0f::10]:80,[fd0f::20]:80 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb1 [ae0f::10]:80 [fd0f::10]:80,[fd0f::20]:80 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb3 ae0f::10 fd0f::10,fd0f::20"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb3 ae0f::10 fd0f::10,fd0f::20
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-add ls0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-add ls0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl --may-exist ls-lb-add ls0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl --may-exist ls-lb-add ls0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-add ls0 lb2"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Multiple load balancers named 'lb2'.  Use a UUID.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-add ls0 lb3"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb0                 tcp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
<1>    lb1                 udp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
<2>    lb3                            ae0f::10         fd0f::10,fd0f::20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-del ls0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-del ls0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb1                 udp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
<1>    lb3                            ae0f::10         fd0f::10,fd0f::20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-del ls0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-del ls0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-del ls0 lb3"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-del ls0 lb3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl --if-exists ls-lb-del ls0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl --if-exists ls-lb-del ls0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-add ls0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-add ls0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-add ls0 lb3"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-add ls0 lb3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-del ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-del ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb4 [ae07::10]:80 [fd0f::10]:80,[fd0f::20]:80"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb4 [ae07::10]:80 [fd0f::10]:80,[fd0f::20]:80
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb5 [ae08::10]:80 [fd0f::10]:80,[fd0f::20]:80 udp"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb5 [ae08::10]:80 [fd0f::10]:80,[fd0f::20]:80 udp
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lb-add lb6 ae09::10 fd0f::10,fd0f::20"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lb-add lb6 ae09::10 fd0f::10,fd0f::20
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


lb4=$(fetch_column nb:load_balancer _uuid name=lb4)
lb5=$(fetch_column nb:load_balancer _uuid name=lb5)
lb6=$(fetch_column nb:load_balancer _uuid name=lb6)

lbg=$(ovn-nbctl create load_balancer_group name=lbg -- \
  add load_balancer_group lbg load_balancer $lb4 -- \
  add load_balancer_group lbg load_balancer $lb5 -- \
  add load_balancer_group lbg load_balancer $lb6)

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl add logical_switch ls0 load_balancer_group \$lbg"
at_fn_check_prepare_dynamic "ovn-nbctl add logical_switch ls0 load_balancer_group $lbg" "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl add logical_switch ls0 load_balancer_group $lbg
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl ls-lb-list ls0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl ls-lb-list ls0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb4                 tcp        [ae07::10]:80    [fd0f::10]:80,[fd0f::20]:80
<1>    lb5                 udp        [ae08::10]:80    [fd0f::10]:80,[fd0f::20]:80
<2>    lb6                            ae09::10         fd0f::10,fd0f::20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl remove logical_switch ls0 load_balancer_group \$lbg"
at_fn_check_prepare_dynamic "ovn-nbctl remove logical_switch ls0 load_balancer_group $lbg" "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl remove logical_switch ls0 load_balancer_group $lbg
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-add lr0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-add lr0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl --may-exist lr-lb-add lr0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl --may-exist lr-lb-add lr0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-add lr0 lb2"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Multiple load balancers named 'lb2'.  Use a UUID.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-add lr0 lb3"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb0                 tcp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
<1>    lb1                 udp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
<2>    lb3                            ae0f::10         fd0f::10,fd0f::20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-del lr0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-del lr0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb1                 udp        [ae0f::10]:80    [fd0f::10]:80,[fd0f::20]:80
<1>    lb3                            ae0f::10         fd0f::10,fd0f::20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-del lr0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-del lr0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-del lr0 lb3"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-del lr0 lb3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl --if-exists lr-lb-del lr0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl --if-exists lr-lb-del lr0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-add lr0 lb0"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-add lr0 lb1"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-add lr0 lb3"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-add lr0 lb3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl add logical_router lr0 load_balancer_group \$lbg"
at_fn_check_prepare_dynamic "ovn-nbctl add logical_router lr0 load_balancer_group $lbg" "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl add logical_router lr0 load_balancer_group $lbg
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1301: ovn-nbctl lr-lb-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1301"
( $at_check_trace; ovn-nbctl lr-lb-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP              IPs
<0>    lb4                 tcp        [ae07::10]:80    [fd0f::10]:80,[fd0f::20]:80
<1>    lb5                 udp        [ae08::10]:80    [fd0f::10]:80,[fd0f::20]:80
<2>    lb6                            ae09::10         fd0f::10,fd0f::20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1301"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_template_lbs() {

check ovn-nbctl --template lb-add lb0 ^vip ^backend
check ovn-nbctl --template lb-add lb1 ^vip:^vport ^backend udp
check ovn-nbctl --template lb-add lb2 ^vip:^vport ^backend udp ipv4
check ovn-nbctl --template lb-add lb3 ^vip:^vport ^backend udp ipv6
check ovn-nbctl --template lb-add lb4 ^vip:^vport ^backend:^bport udp ipv4
check ovn-nbctl --template lb-add lb5 ^vip:^vport ^backend:^bport udp ipv6
check ovn-nbctl --template lb-add lb6 ^vip:^vport 1.1.1.1:111 udp ipv4
check ovn-nbctl --template lb-add lb7 ^vip:^vport [1::1]:111 udp ipv6
check ovn-nbctl --template lb-add lb8 ^vip:^vport "^backend,^port,1.1.1.1:111" udp ipv4
check ovn-nbctl --template lb-add lb9 ^vip:^vport "^backend,^port,[1::1]:111" udp ipv6

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1588: ovn-nbctl lb-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1588"
( $at_check_trace; ovn-nbctl lb-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "UUID                                    LB                  PROTO      VIP            IPs
<0>    lb0                 tcp        ^vip           ^backend
<1>    lb1                 udp        ^vip:^vport    ^backend
<2>    lb2                 udp        ^vip:^vport    ^backend
<3>    lb3                 udp        ^vip:^vport    ^backend
<4>    lb4                 udp        ^vip:^vport    ^backend:^bport
<5>    lb5                 udp        ^vip:^vport    ^backend:^bport
<6>    lb6                 udp        ^vip:^vport    1.1.1.1:111
<7>    lb7                 udp        ^vip:^vport    [1::1]:111
<8>    lb8                 udp        ^vip:^vport    ^backend,^port,1.1.1.1:111
<9>    lb9                 udp        ^vip:^vport    ^backend,^port,[1::1]:111
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1588"
$at_failed && at_fn_log_failure
$at_traceon; }



    }


    ovn_nbctl_basic_lr() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl lr-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl lr-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (lr0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl lr-add lr1"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl lr-add lr1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl lr-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl lr-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (lr0)
<1> (lr1)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl lr-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl lr-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl lr-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl lr-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (lr1)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl show lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl show lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl show lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl show lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "router <0> (lr0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lr0: a router with this name already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl --may-exist lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl --may-exist lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl show lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl show lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "router <0> (lr0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl --add-duplicate lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl --add-duplicate lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl --may-exist --add-duplicate lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl --may-exist --add-duplicate lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: --may-exist and --add-duplicate may not be used together
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl lr-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl lr-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Multiple logical routers named 'lr0'.  Use a UUID.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl lr-del lr2"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl lr-del lr2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lr2: router name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl --if-exists lr-del lr2"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl --if-exists lr-del lr2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl lr-add"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl lr-add
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl lr-add"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl lr-add
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl --add-duplicate lr-add"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl --add-duplicate lr-add
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: --add-duplicate requires specifying a name
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1618: ovn-nbctl --may-exist lr-add"
at_fn_check_prepare_trace "ovn-nbctl.at:1618"
( $at_check_trace; ovn-nbctl --may-exist lr-add
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: --may-exist requires specifying a name
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1618"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_basic_lrp() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02 192.168.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02 192.168.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lrp0: invalid mac address 00:00:00:01:02
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02:03:04 192.168.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02:03:04 192.168.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lrp0: invalid mac address 00:00:00:01:02:03:04
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl show lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl show lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "router <0> (lr0)
    port lrp0
        mac: \"00:00:00:01:02:03\"
        ipv6-lla: \"fe80::200:ff:fe01:203\"
        networks: [\"192.168.1.1/24\"]
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lrp0: a port with this name already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl --may-exist lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl --may-exist lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (lrp0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-add lr0 lrp1 00:00:00:01:02:03 192.168.1.1/24 peer=lrp1-peer"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-add lr0 lrp1 00:00:00:01:02:03 192.168.1.1/24 peer=lrp1-peer
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (lrp0)
<1> (lrp1)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-add lr0 lrp2 00:00:00:01:02:03"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-add lr0 lrp2 00:00:00:01:02:03
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (lrp0)
<1> (lrp1)
<2> (lrp2)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-del lrp2"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-del lrp2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (lrp0)
<1> (lrp1)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lr-add lr1"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lr-add lr1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-add lr0 lrp1 00:00:00:01:02:03 192.168.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-add lr0 lrp1 00:00:00:01:02:03 192.168.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lrp1: a port with this name already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl --may-exist lrp-add lr1 lrp1 00:00:00:01:02:03 192.168.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl --may-exist lrp-add lr1 lrp1 00:00:00:01:02:03 192.168.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lrp1: port already exists but in router lr0
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:04:05:06 192.168.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:04:05:06 192.168.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lrp1: port already exists with mac 00:00:00:01:02:03
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:01:02:03 192.168.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:01:02:03 192.168.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lrp1: port already exists with mismatching peer
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:01:02:03 10.0.0.1/24 peer=lrp1-peer"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:01:02:03 10.0.0.1/24 peer=lrp1-peer
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lrp1: port already exists with different network
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:01:02:03 192.168.1.1/24 peer=lrp1-peer"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:01:02:03 192.168.1.1/24 peer=lrp1-peer
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-del lrp1"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-del lrp1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl lrp-list lr0 | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl lrp-list lr0 | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (lrp0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:01:02:03 192.168.1.1/24 10.0.0.1/24 peer=lrp1-peer"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:01:02:03 192.168.1.1/24 10.0.0.1/24 peer=lrp1-peer
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:01:02:03 192.168.1.1/24 172.16.0.1/24 peer=lrp1-peer"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:01:02:03 192.168.1.1/24 172.16.0.1/24 peer=lrp1-peer
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lrp1: port already exists with different network
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1671: ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:01:02:03 10.0.0.1/24 192.168.1.1/24 peer=lrp1-peer"
at_fn_check_prepare_trace "ovn-nbctl.at:1671"
( $at_check_trace; ovn-nbctl --may-exist lrp-add lr0 lrp1 00:00:00:01:02:03 10.0.0.1/24 192.168.1.1/24 peer=lrp1-peer
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1671"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_lrp_gw_chassi() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-get-gateway-chassis lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-get-gateway-chassis lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-set-gateway-chassis lp0 chassis1"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-set-gateway-chassis lp0 chassis1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp0: port name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-get-gateway-chassis lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-get-gateway-chassis lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp0: port name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-del-gateway-chassis lp0 chassis1"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-del-gateway-chassis lp0 chassis1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp0: port name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-del-gateway-chassis lrp0 chassis1"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-del-gateway-chassis lrp0 chassis1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: chassis chassis1 is not added to logical port lrp0
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-set-gateway-chassis lrp0 chassis1"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-set-gateway-chassis lrp0 chassis1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-get-gateway-chassis lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-get-gateway-chassis lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "lrp0-chassis1     0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-set-gateway-chassis lrp0 chassis1 10"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-set-gateway-chassis lrp0 chassis1 10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-get-gateway-chassis lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-get-gateway-chassis lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "lrp0-chassis1    10
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-del lrp0 -- lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24 -- lrp-set-gateway-chassis lrp0 chassis1 10"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-del lrp0 -- lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24 -- lrp-set-gateway-chassis lrp0 chassis1 10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-get-gateway-chassis lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-get-gateway-chassis lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "lrp0-chassis1    10
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-set-gateway-chassis lrp0 chassis1 20"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-set-gateway-chassis lrp0 chassis1 20
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-get-gateway-chassis lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-get-gateway-chassis lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "lrp0-chassis1    20
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-set-gateway-chassis lrp0 chassis2 5"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-set-gateway-chassis lrp0 chassis2 5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-get-gateway-chassis lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-get-gateway-chassis lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "lrp0-chassis1    20
lrp0-chassis2     5
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-del-gateway-chassis lrp0 chassis1"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-del-gateway-chassis lrp0 chassis1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-get-gateway-chassis lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-get-gateway-chassis lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "lrp0-chassis2     5
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-del-gateway-chassis lrp0 chassis2"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-del-gateway-chassis lrp0 chassis2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-get-gateway-chassis lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-get-gateway-chassis lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-set-gateway-chassis lrp0 chassis1 1"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-set-gateway-chassis lrp0 chassis1 1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-set-gateway-chassis lrp0 chassis2 10"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-set-gateway-chassis lrp0 chassis2 10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-set-gateway-chassis lrp0 chassis3 5"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-set-gateway-chassis lrp0 chassis3 5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1755: ovn-nbctl lrp-get-gateway-chassis lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1755"
( $at_check_trace; ovn-nbctl lrp-get-gateway-chassis lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "lrp0-chassis2    10
lrp0-chassis3     5
lrp0-chassis1     1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1755"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_redirect_type() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1821: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1821"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1821"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1821: ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1821"
( $at_check_trace; ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1821"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1821: ovn-nbctl lrp-get-redirect-type lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1821"
( $at_check_trace; ovn-nbctl lrp-get-redirect-type lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "overlay
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1821"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1821: ovn-nbctl lrp-set-redirect-type lp0 bridged"
at_fn_check_prepare_trace "ovn-nbctl.at:1821"
( $at_check_trace; ovn-nbctl lrp-set-redirect-type lp0 bridged
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lp0: port name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1821"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1821: ovn-nbctl lrp-set-redirect-type lrp0 bridged"
at_fn_check_prepare_trace "ovn-nbctl.at:1821"
( $at_check_trace; ovn-nbctl lrp-set-redirect-type lrp0 bridged
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1821"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1821: ovn-nbctl lrp-get-redirect-type lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1821"
( $at_check_trace; ovn-nbctl lrp-get-redirect-type lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "bridged
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1821"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1821: ovn-nbctl lrp-set-redirect-type lrp0 overlay"
at_fn_check_prepare_trace "ovn-nbctl.at:1821"
( $at_check_trace; ovn-nbctl lrp-set-redirect-type lrp0 overlay
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1821"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1821: ovn-nbctl lrp-get-redirect-type lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1821"
( $at_check_trace; ovn-nbctl lrp-get-redirect-type lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "overlay
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1821"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1821: ovn-nbctl lrp-set-redirect-type lrp0 abcd"
at_fn_check_prepare_trace "ovn-nbctl.at:1821"
( $at_check_trace; ovn-nbctl lrp-set-redirect-type lrp0 abcd
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Invalid redirect type: abcd
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1821"
$at_failed && at_fn_log_failure
$at_traceon; }



    }


    ovn_nbctl_lrp_enable() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1846: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1846"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1846"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1846: ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1846"
( $at_check_trace; ovn-nbctl lrp-add lr0 lrp0 00:00:00:01:02:03 192.168.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1846"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1846: ovn-nbctl lrp-get-enabled lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1846"
( $at_check_trace; ovn-nbctl lrp-get-enabled lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "enabled
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1846"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1846: ovn-nbctl lrp-set-enabled lrp0 disabled"
at_fn_check_prepare_trace "ovn-nbctl.at:1846"
( $at_check_trace; ovn-nbctl lrp-set-enabled lrp0 disabled
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1846"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1846: ovn-nbctl lrp-get-enabled lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1846"
( $at_check_trace; ovn-nbctl lrp-get-enabled lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "disabled
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1846"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1846: ovn-nbctl lrp-set-enabled lrp0 enabled"
at_fn_check_prepare_trace "ovn-nbctl.at:1846"
( $at_check_trace; ovn-nbctl lrp-set-enabled lrp0 enabled
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1846"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1846: ovn-nbctl lrp-get-enabled lrp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1846"
( $at_check_trace; ovn-nbctl lrp-get-enabled lrp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "enabled
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1846"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1846: ovn-nbctl lrp-set-enabled lrp0 xyzzy"
at_fn_check_prepare_trace "ovn-nbctl.at:1846"
( $at_check_trace; ovn-nbctl lrp-set-enabled lrp0 xyzzy
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: xyzzy: state must be \"enabled\" or \"disabled\"
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1846"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_routes() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lrp-add lr0 lp0 f0:00:00:00:00:01 10.0.0.254/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lrp-add lr0 lp0 f0:00:00:00:00:01 10.0.0.254/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 0.0.0.0/0 192.168.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 0.0.0.0/0 192.168.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.1.0/24 11.0.1.1 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.1.0/24 11.0.1.1 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.0.1/24 11.0.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.0.1/24 11.0.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.10.0/24 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.10.0/24 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --bfd lr-route-add lr0 10.0.20.0/24 11.0.2.1 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --bfd lr-route-add lr0 10.0.20.0/24 11.0.2.1 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.10.0/24 lp1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.10.0/24 lp1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: bad nexthop argument: lp1
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.0.111/24 11.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.0.111/24 11.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: duplicate prefix: 10.0.0.0/24 (policy: dst-ip). Use option --ecmp to allow this for ECMP routing.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.0.111a/24 11.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.0.111a/24 11.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: bad prefix argument: 10.0.0.111a/24
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.0.111/24a 11.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.0.111/24a 11.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: bad prefix argument: 10.0.0.111/24a
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.0.111/24 11.0.0.1a"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.0.111/24 11.0.0.1a
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: bad nexthop argument: 11.0.0.1a
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.0.111/24 11.0.0.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.0.111/24 11.0.0.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: bad nexthop argument: 11.0.0.1/24
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::1/64"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::1/64
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: bad nexthop argument: 2001:0db8:0:f103::1/64
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp lr-route-add lr0 20.0.0.0/24 discard"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp lr-route-add lr0 20.0.0.0/24 discard
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: ecmp is not valid for discard routes.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp-symmetric-reply lr-route-add lr0 20.0.0.0/24 discard"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp-symmetric-reply lr-route-add lr0 20.0.0.0/24 discard
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: ecmp is not valid for discard routes.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --bfd lr-route-add lr0 20.0.0.0/24 discard lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --bfd lr-route-add lr0 20.0.0.0/24 discard lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: bfd dst_ip cannot be discard.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 20.0.0.0/24 discard lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 20.0.0.0/24 discard lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: outport is not valid for discard routes.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --may-exist lr-route-add lr0 10.0.0.111/24 11.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --may-exist lr-route-add lr0 10.0.0.111/24 11.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --policy=src-ip lr-route-add lr0 9.16.1.0/24 11.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --policy=src-ip lr-route-add lr0 9.16.1.0/24 11.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --policy=src-ip lr-route-add lr0 10.0.0.0/24 11.0.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --policy=src-ip lr-route-add lr0 10.0.0.0/24 11.0.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 20.0.0.0/24 discard"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 20.0.0.0/24 discard
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --policy=src-ip lr-route-add lr0 20.0.0.0/24 discard"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --policy=src-ip lr-route-add lr0 20.0.0.0/24 discard
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp --policy=src-ip lr-route-add lr0 20.0.0.0/24 11.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp --policy=src-ip lr-route-add lr0 20.0.0.0/24 11.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: discard nexthop for the same ECMP route exists.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table <main>:
              10.0.0.0/24                  11.0.0.1 dst-ip
              10.0.1.0/24                  11.0.1.1 dst-ip lp0
             10.0.10.0/24                           dst-ip lp0
             10.0.20.0/24                  11.0.2.1 dst-ip lp0 bfd
              20.0.0.0/24                   discard dst-ip
              9.16.1.0/24                  11.0.0.1 src-ip
              10.0.0.0/24                  11.0.0.2 src-ip
              20.0.0.0/24                   discard src-ip
                0.0.0.0/0               192.168.0.1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


check_row_count nb:BFD 1
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0 10.0.20.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0 10.0.20.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

check_row_count nb:BFD 0

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lrp-add lr0 lp1 f0:00:00:00:00:02 11.0.0.254/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lrp-add lr0 lp1 f0:00:00:00:00:02 11.0.0.254/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --may-exist lr-route-add lr0 10.0.0.111/24 11.0.0.1 lp1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --may-exist lr-route-add lr0 10.0.0.111/24 11.0.0.1 lp1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table <main>:
              10.0.0.0/24                  11.0.0.1 dst-ip lp1
              10.0.1.0/24                  11.0.1.1 dst-ip lp0
             10.0.10.0/24                           dst-ip lp0
              20.0.0.0/24                   discard dst-ip
              9.16.1.0/24                  11.0.0.1 src-ip
              10.0.0.0/24                  11.0.0.2 src-ip
              20.0.0.0/24                   discard src-ip
                0.0.0.0/0               192.168.0.1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --policy=src-ip lr-route-del lr0 20.0.0.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --policy=src-ip lr-route-del lr0 20.0.0.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0 20.0.0.0/24 discard"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0 20.0.0.0/24 discard
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0 10.0.2.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0 10.0.2.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: no matching route: policy 'any', prefix '10.0.2.0/24', nexthop 'any', output_port 'any'.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0 10.0.1.0/24 11.0.1.2"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0 10.0.1.0/24 11.0.1.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: no matching route: policy 'any', prefix '10.0.1.0/24', nexthop '11.0.1.2', output_port 'any'.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0 10.0.1.0/24 11.0.1.1 lp1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0 10.0.1.0/24 11.0.1.1 lp1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: no matching route: policy 'any', prefix '10.0.1.0/24', nexthop '11.0.1.1', output_port 'lp1'.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --if-exists lr-route-del lr0 10.0.2.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --if-exists lr-route-del lr0 10.0.2.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0 10.0.1.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0 10.0.1.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --policy=src-ip lr-route-del lr0 9.16.1.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --policy=src-ip lr-route-del lr0 9.16.1.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table <main>:
              10.0.0.0/24                  11.0.0.1 dst-ip lp1
             10.0.10.0/24                           dst-ip lp0
              10.0.0.0/24                  11.0.0.2 src-ip
                0.0.0.0/0               192.168.0.1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --policy=dst-ip lr-route-del lr0 10.0.0.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --policy=dst-ip lr-route-del lr0 10.0.0.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --policy=src-ip lr-route-del lr0 10.0.0.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --policy=src-ip lr-route-del lr0 10.0.0.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table <main>:
             10.0.10.0/24                           dst-ip lp0
                0.0.0.0/0               192.168.0.1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.0.0/24 11.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.0.0/24 11.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --policy=src-ip lr-route-add lr0 10.0.0.0/24 11.0.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --policy=src-ip lr-route-add lr0 10.0.0.0/24 11.0.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0 10.0.0.0/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0 10.0.0.0/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table <main>:
             10.0.10.0/24                           dst-ip lp0
                0.0.0.0/0               192.168.0.1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.0.0/24 11.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.0.0/24 11.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp lr-route-add lr0 10.0.0.0/24 11.0.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp lr-route-add lr0 10.0.0.0/24 11.0.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp lr-route-add lr0 10.0.0.0/24 11.0.0.3"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp lr-route-add lr0 10.0.0.0/24 11.0.0.3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp lr-route-add lr0 10.0.0.0/24 11.0.0.4 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp lr-route-add lr0 10.0.0.0/24 11.0.0.4 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table <main>:
              10.0.0.0/24                  11.0.0.1 dst-ip ecmp
              10.0.0.0/24                  11.0.0.2 dst-ip ecmp
              10.0.0.0/24                  11.0.0.3 dst-ip ecmp
              10.0.0.0/24                  11.0.0.4 dst-ip lp0 ecmp
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp lr-route-add lr0 10.0.0.0/24 11.0.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp lr-route-add lr0 10.0.0.0/24 11.0.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: duplicate nexthop for the same ECMP route
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --may-exist --ecmp lr-route-add lr0 10.0.0.0/24 11.0.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --may-exist --ecmp lr-route-add lr0 10.0.0.0/24 11.0.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0 10.0.0.0/24 11.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0 10.0.0.0/24 11.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table <main>:
              10.0.0.0/24                  11.0.0.2 dst-ip ecmp
              10.0.0.0/24                  11.0.0.3 dst-ip ecmp
              10.0.0.0/24                  11.0.0.4 dst-ip lp0 ecmp
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0 10.0.0.0/24 11.0.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0 10.0.0.0/24 11.0.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table <main>:
              10.0.0.0/24                  11.0.0.3 dst-ip ecmp
              10.0.0.0/24                  11.0.0.4 dst-ip lp0 ecmp
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0 10.0.0.0/24 11.0.0.4 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0 10.0.0.0/24 11.0.0.4 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table <main>:
              10.0.0.0/24                  11.0.0.3 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0 10.0.0.0/24 11.0.0.3"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0 10.0.0.0/24 11.0.0.3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 0:0:0:0:0:0:0:0/0 2001:0db8:0:f101::1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 0:0:0:0:0:0:0:0/0 2001:0db8:0:f101::1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 2001:0db8:0::/64 2001:0db8:0:f102::1 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 2001:0db8:0::/64 2001:0db8:0:f102::1 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv6 Routes
Route Table <main>:
            2001:db8::/64        2001:db8:0:f102::1 dst-ip lp0
          2001:db8:1::/64        2001:db8:0:f103::1 dst-ip
                     ::/0        2001:db8:0:f101::1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0 2001:0db8:0::/64"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0 2001:0db8:0::/64
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv6 Routes
Route Table <main>:
          2001:db8:1::/64        2001:db8:0:f103::1 dst-ip
                     ::/0        2001:db8:0:f101::1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 0.0.0.0/0 192.168.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 0.0.0.0/0 192.168.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.1.1/24 11.0.1.1 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.1.1/24 11.0.1.1 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.0.1/24 11.0.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.0.1/24 11.0.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 0:0:0:0:0:0:0:0/0 2001:0db8:0:f101::1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 0:0:0:0:0:0:0:0/0 2001:0db8:0:f101::1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 2001:0db8:0::/64 2001:0db8:0:f102::1 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 2001:0db8:0::/64 2001:0db8:0:f102::1 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::2"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::3"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::4"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 2002:0db8:1::/64 2001:0db8:0:f103::5"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 2002:0db8:1::/64 2001:0db8:0:f103::5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp-symmetric-reply lr-route-add lr0 2003:0db8:1::/64 2001:0db8:0:f103::6"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp-symmetric-reply lr-route-add lr0 2003:0db8:1::/64 2001:0db8:0:f103::6
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp-symmetric-reply lr-route-add lr0 2003:0db8:1::/64 2001:0db8:0:f103::6"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp-symmetric-reply lr-route-add lr0 2003:0db8:1::/64 2001:0db8:0:f103::6
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: duplicate nexthop for the same ECMP route
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --may-exist --ecmp-symmetric-reply lr-route-add lr0 2003:0db8:1::/64 2001:0db8:0:f103::6"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --may-exist --ecmp-symmetric-reply lr-route-add lr0 2003:0db8:1::/64 2001:0db8:0:f103::6
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table <main>:
              10.0.0.0/24                  11.0.0.1 dst-ip
              10.0.1.0/24                  11.0.1.1 dst-ip lp0
                0.0.0.0/0               192.168.0.1 dst-ip

IPv6 Routes
Route Table <main>:
            2001:db8::/64        2001:db8:0:f102::1 dst-ip lp0
          2001:db8:1::/64        2001:db8:0:f103::1 dst-ip ecmp
          2001:db8:1::/64        2001:db8:0:f103::2 dst-ip ecmp
          2001:db8:1::/64        2001:db8:0:f103::3 dst-ip ecmp
          2001:db8:1::/64        2001:db8:0:f103::4 dst-ip ecmp
          2002:db8:1::/64        2001:db8:0:f103::5 dst-ip
          2003:db8:1::/64        2001:db8:0:f103::6 dst-ip ecmp-symmetric-reply
                     ::/0        2001:db8:0:f101::1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lrp-add lr0 lr0-p0 00:00:01:01:02:03 192.168.10.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lrp-add lr0 lr0-p0 00:00:01:01:02:03 192.168.10.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

bfd_uuid=$(ovn-nbctl create bfd logical_port=lr0-p0 dst_ip=100.0.0.50 status=down min_tx=250 min_rx=250 detect_mult=10)
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 100.0.0.0/24 192.168.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 100.0.0.0/24 192.168.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

route_uuid=$(fetch_column nb:logical_router_static_route _uuid ip_prefix="100.0.0.0/24")
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl set logical_router_static_route \$route_uuid bfd=\$bfd_uuid"
at_fn_check_prepare_dynamic "ovn-nbctl set logical_router_static_route $route_uuid bfd=$bfd_uuid" "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl set logical_router_static_route $route_uuid bfd=$bfd_uuid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


check ovn-nbctl lr-route-del lr0
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 10.0.0.1/24 2001:0db8:0:f103::10"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 10.0.0.1/24 2001:0db8:0:f103::10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-add lr0 2001:0db8:0::/64 11.0.1.10"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-add lr0 2001:0db8:0::/64 11.0.1.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table <main>:
              10.0.0.0/24       2001:db8:0:f103::10 dst-ip

IPv6 Routes
Route Table <main>:
            2001:db8::/64                 11.0.1.10 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


check ovn-nbctl lr-route-del lr0
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


check ovn-nbctl --route-table=rtb-1 lr-route-add lr0 0.0.0.0/0 192.168.0.1
check ovn-nbctl --route-table=rtb-1 lr-route-add lr0 10.0.1.1/24 11.0.1.1 lp0
check ovn-nbctl --route-table=rtb-1 lr-route-add lr0 10.0.0.1/24 11.0.0.1
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table rtb-1:
              10.0.0.0/24                  11.0.0.1 dst-ip
              10.0.1.0/24                  11.0.1.1 dst-ip lp0
                0.0.0.0/0               192.168.0.1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


check ovn-nbctl lr-route-del lr0
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


check ovn-nbctl --route-table=rtb-1 lr-route-add lr0 0:0:0:0:0:0:0:0/0 2001:0db8:0:f101::1
check ovn-nbctl --route-table=rtb-1 lr-route-add lr0 2001:0db8:0::/64 2001:0db8:0:f102::1 lp0
check ovn-nbctl --route-table=rtb-1 lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::1

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv6 Routes
Route Table rtb-1:
            2001:db8::/64        2001:db8:0:f102::1 dst-ip lp0
          2001:db8:1::/64        2001:db8:0:f103::1 dst-ip
                     ::/0        2001:db8:0:f101::1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


check ovn-nbctl --route-table=rtb-1 lr-route-add lr0 0.0.0.0/0 192.168.0.1
check ovn-nbctl --route-table=rtb-1 lr-route-add lr0 10.0.1.1/24 11.0.1.1 lp0
check ovn-nbctl --route-table=rtb-1 lr-route-add lr0 10.0.0.1/24 11.0.0.1

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table rtb-1:
              10.0.0.0/24                  11.0.0.1 dst-ip
              10.0.1.0/24                  11.0.1.1 dst-ip lp0
                0.0.0.0/0               192.168.0.1 dst-ip

IPv6 Routes
Route Table rtb-1:
            2001:db8::/64        2001:db8:0:f102::1 dst-ip lp0
          2001:db8:1::/64        2001:db8:0:f103::1 dst-ip
                     ::/0        2001:db8:0:f101::1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


# Add routes in another route table
check ovn-nbctl --route-table=rtb-2 lr-route-add lr0 0.0.0.0/0 192.168.0.1
check ovn-nbctl --route-table=rtb-2 lr-route-add lr0 10.0.1.1/24 11.0.1.1 lp0
check ovn-nbctl --route-table=rtb-2 lr-route-add lr0 10.0.0.1/24 11.0.0.1
check ovn-nbctl --route-table=rtb-2 lr-route-add lr0 0:0:0:0:0:0:0:0/0 2001:0db8:0:f101::1
check ovn-nbctl --route-table=rtb-2 lr-route-add lr0 2001:0db8:0::/64 2001:0db8:0:f102::1 lp0
check ovn-nbctl --route-table=rtb-2 lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::1

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table rtb-1:
              10.0.0.0/24                  11.0.0.1 dst-ip
              10.0.1.0/24                  11.0.1.1 dst-ip lp0
                0.0.0.0/0               192.168.0.1 dst-ip

Route Table rtb-2:
              10.0.0.0/24                  11.0.0.1 dst-ip
              10.0.1.0/24                  11.0.1.1 dst-ip lp0
                0.0.0.0/0               192.168.0.1 dst-ip

IPv6 Routes
Route Table rtb-1:
            2001:db8::/64        2001:db8:0:f102::1 dst-ip lp0
          2001:db8:1::/64        2001:db8:0:f103::1 dst-ip
                     ::/0        2001:db8:0:f101::1 dst-ip

Route Table rtb-2:
            2001:db8::/64        2001:db8:0:f102::1 dst-ip lp0
          2001:db8:1::/64        2001:db8:0:f103::1 dst-ip
                     ::/0        2001:db8:0:f101::1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


# Add routes to <main> route table
check ovn-nbctl lr-route-add lr0 0.0.0.0/0 192.168.0.1
check ovn-nbctl lr-route-add lr0 10.0.1.1/24 11.0.1.1 lp0
check ovn-nbctl lr-route-add lr0 10.0.0.1/24 11.0.0.1
check ovn-nbctl lr-route-add lr0 0:0:0:0:0:0:0:0/0 2001:0db8:0:f101::1
check ovn-nbctl lr-route-add lr0 2001:0db8:0::/64 2001:0db8:0:f102::1 lp0
check check ovn-nbctl lr-route-add lr0 2001:0db8:1::/64 2001:0db8:0:f103::1

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table <main>:
              10.0.0.0/24                  11.0.0.1 dst-ip
              10.0.1.0/24                  11.0.1.1 dst-ip lp0
                0.0.0.0/0               192.168.0.1 dst-ip

Route Table rtb-1:
              10.0.0.0/24                  11.0.0.1 dst-ip
              10.0.1.0/24                  11.0.1.1 dst-ip lp0
                0.0.0.0/0               192.168.0.1 dst-ip

Route Table rtb-2:
              10.0.0.0/24                  11.0.0.1 dst-ip
              10.0.1.0/24                  11.0.1.1 dst-ip lp0
                0.0.0.0/0               192.168.0.1 dst-ip

IPv6 Routes
Route Table <main>:
            2001:db8::/64        2001:db8:0:f102::1 dst-ip lp0
          2001:db8:1::/64        2001:db8:0:f103::1 dst-ip
                     ::/0        2001:db8:0:f101::1 dst-ip

Route Table rtb-1:
            2001:db8::/64        2001:db8:0:f102::1 dst-ip lp0
          2001:db8:1::/64        2001:db8:0:f103::1 dst-ip
                     ::/0        2001:db8:0:f101::1 dst-ip

Route Table rtb-2:
            2001:db8::/64        2001:db8:0:f102::1 dst-ip lp0
          2001:db8:1::/64        2001:db8:0:f103::1 dst-ip
                     ::/0        2001:db8:0:f101::1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


# delete IPv4 route from rtb-1
check ovn-nbctl --route-table=rtb-1 lr-route-del lr0 10.0.0.0/24
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --route-table=rtb-1 lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --route-table=rtb-1 lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table rtb-1:
              10.0.1.0/24                  11.0.1.1 dst-ip lp0
                0.0.0.0/0               192.168.0.1 dst-ip

IPv6 Routes
Route Table rtb-1:
            2001:db8::/64        2001:db8:0:f102::1 dst-ip lp0
          2001:db8:1::/64        2001:db8:0:f103::1 dst-ip
                     ::/0        2001:db8:0:f101::1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


# delete IPv6 route from rtb-2
check ovn-nbctl --route-table=rtb-2 lr-route-del lr0 2001:db8::/64
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --route-table=rtb-2 lr-route-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --route-table=rtb-2 lr-route-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "IPv4 Routes
Route Table rtb-2:
              10.0.0.0/24                  11.0.0.1 dst-ip
              10.0.1.0/24                  11.0.1.1 dst-ip lp0
                0.0.0.0/0               192.168.0.1 dst-ip

IPv6 Routes
Route Table rtb-2:
          2001:db8:1::/64        2001:db8:0:f103::1 dst-ip
                     ::/0        2001:db8:0:f101::1 dst-ip
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


check ovn-nbctl lr-route-del lr0

# ECMP route in route table
check ovn-nbctl --route-table=rtb1 lr-route-add lr0 0.0.0.0/0 192.168.0.1
check ovn-nbctl --ecmp --route-table=rtb1 lr-route-add lr0 0.0.0.0/0 192.168.0.2

# Negative route table case: same prefix
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --route-table=rtb1 lr-route-add lr0 0.0.0.0/0 192.168.0.1"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --route-table=rtb1 lr-route-add lr0 0.0.0.0/0 192.168.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: duplicate prefix: 0.0.0.0/0 (policy: dst-ip). Use option --ecmp to allow this for ECMP routing.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


# Negative route table case: same prefix & nexthop with ecmp
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl --ecmp --route-table=rtb1 lr-route-add lr0 0.0.0.0/0 192.168.0.2"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl --ecmp --route-table=rtb1 lr-route-add lr0 0.0.0.0/0 192.168.0.2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: duplicate nexthop for the same ECMP route
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }


# Add routes to <main> route table
check ovn-nbctl lrp-add lr0 lrp0 00:00:00:00:00:01 1.1.1.1/24
check ovn-nbctl lrp-set-options lrp0 route_table=rtb1
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:1866: ovn-nbctl get logical-router-port lrp0 options:route_table"
at_fn_check_prepare_trace "ovn-nbctl.at:1866"
( $at_check_trace; ovn-nbctl get logical-router-port lrp0 options:route_table
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "rtb1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:1866"
$at_failed && at_fn_log_failure
$at_traceon; }

check `ovn-nbctl show lr0 | grep lrp0 -A3 | grep route_table=rtb1`

    }


    ovn_nbctl_policies() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 100 \"ip4.src == 1.1.1.0/24\" drop"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 100 "ip4.src == 1.1.1.0/24" drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 100 \"ip4.src == 1.1.2.0/24\" allow pkt_mark=100,foo=bar"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 100 "ip4.src == 1.1.2.0/24" allow pkt_mark=100,foo=bar
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 101 \"ip4.src == 2.1.1.0/24\" allow"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 101 "ip4.src == 2.1.1.0/24" allow
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 101 \"ip4.src == 2.1.2.0/24\" drop"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 101 "ip4.src == 2.1.2.0/24" drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 101 \"ip6.src == 2002::/64\" drop"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 101 "ip6.src == 2002::/64" drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl --bfd lr-policy-add lr0 103 \"ip4.src == 1.2.3.0/24\" reroute 192.168.1.1"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl --bfd lr-policy-add lr0 103 "ip4.src == 1.2.3.0/24" reroute 192.168.1.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: out lrp not found for 192.168.1.1 nexthop
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl --bfd lr-policy-add lr0 103 \"ip4.src == 1.2.3.0/24\" drop"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl --bfd lr-policy-add lr0 103 "ip4.src == 1.2.3.0/24" drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: BFD is valid only with reroute action.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl --chain=inbound lr-policy-add lr0 100 \"ip4.src == 1.1.1.0/24\" drop"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl --chain=inbound lr-policy-add lr0 100 "ip4.src == 1.1.1.0/24" drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl --chain=outbound lr-policy-add lr0 100 \"ip4.src == 2.1.1.0/24\" jump inbound"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl --chain=outbound lr-policy-add lr0 100 "ip4.src == 2.1.1.0/24" jump inbound
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 200 \"ip4.src == 1.1.4.0/24\" reroute 192.168.0.10 foo"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 200 "ip4.src == 1.1.4.0/24" reroute 192.168.0.10 foo
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: No value specified for the option : foo
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 200 \"ip4.src == 1.1.4.0/24\" allow bar="
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 200 "ip4.src == 1.1.4.0/24" allow bar=
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: No value specified for the option : bar
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl --chain lr-policy-add lr0 100 \"ip4.src == 1.1.1.0/24\" drop"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl --chain lr-policy-add lr0 100 "ip4.src == 1.1.1.0/24" drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: unknown command 'lr0'; use --help for help
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 100 \"ip4.src == 2.1.1.0/24\" jump"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 100 "ip4.src == 2.1.1.0/24" jump
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Chain name is required when action is jump.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 100 \"ip4.src == 1.1.1.0/24\" drop"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 100 "ip4.src == 1.1.1.0/24" drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Same routing policy already existed on the logical router lr0.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl --may-exist lr-policy-add lr0 100 \"ip4.src == 1.1.1.0/24\" drop"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl --may-exist lr-policy-add lr0 100 "ip4.src == 1.1.1.0/24" drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 103 \"ip4.src == 1.1.1.0/24\" deny"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 103 "ip4.src == 1.1.1.0/24" deny
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: deny: action must be one of \"allow\", \"drop\", \"reroute\", \"jump\"
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-del lr0 100 \"ip4.src == 1.1.1.0/24\""
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-del lr0 100 "ip4.src == 1.1.1.0/24"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Routing Policies
Chain <Default>:
       101                              ip4.src == 2.1.1.0/24           allow
       101                              ip4.src == 2.1.2.0/24            drop
       101                               ip6.src == 2002::/64            drop
       100                              ip4.src == 1.1.2.0/24           allow               pkt_mark=100,foo=bar

Chain inbound:
       100                              ip4.src == 1.1.1.0/24            drop

Chain outbound:
       100                              ip4.src == 2.1.1.0/24            jump -> inbound
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl --chain inbound lr-policy-del lr0 100 \"ip4.src == 1.1.1.0/24\""
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl --chain inbound lr-policy-del lr0 100 "ip4.src == 1.1.1.0/24"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Routing Policies
Chain <Default>:
       101                              ip4.src == 2.1.1.0/24           allow
       101                              ip4.src == 2.1.2.0/24            drop
       101                               ip6.src == 2002::/64            drop
       100                              ip4.src == 1.1.2.0/24           allow               pkt_mark=100,foo=bar

Chain outbound:
       100                              ip4.src == 2.1.1.0/24            jump -> inbound
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-del lr0 101"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-del lr0 101
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Routing Policies
Chain <Default>:
       100                              ip4.src == 1.1.2.0/24           allow               pkt_mark=100,foo=bar

Chain outbound:
       100                              ip4.src == 2.1.1.0/24            jump -> inbound
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


uuid=$(ovn-nbctl --bare --column _uuid find logical_router_policy 'chain{<=}""')
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-del lr0 \$uuid"
at_fn_check_prepare_dynamic "ovn-nbctl lr-policy-del lr0 $uuid" "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-del lr0 $uuid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Routing Policies

Chain outbound:
       100                              ip4.src == 2.1.1.0/24            jump -> inbound
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl --if-exists lr-policy-del lr0 \$uuid"
at_fn_check_prepare_dynamic "ovn-nbctl --if-exists lr-policy-del lr0 $uuid" "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl --if-exists lr-policy-del lr0 $uuid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl --chain outbound lr-policy-del lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl --chain outbound lr-policy-del lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-list lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-list lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 102 \"ip4.src == 3.1.2.0/24\" reroute 3.3.3.3"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 102 "ip4.src == 3.1.2.0/24" reroute 3.3.3.3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 103 \"ip4.src == 3.1.2.0/24\" reroute 3.3.3.x"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 103 "ip4.src == 3.1.2.0/24" reroute 3.3.3.x
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: bad next hop argument: 3.3.3.x
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 104 \"ip6.src == 2001::/64\" reroute 2002::5"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 104 "ip6.src == 2001::/64" reroute 2002::5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2322: ovn-nbctl lr-policy-add lr0 105 \"ip6.src == 2001::/64\" reroute 2002::x"
at_fn_check_prepare_trace "ovn-nbctl.at:2322"
( $at_check_trace; ovn-nbctl lr-policy-add lr0 105 "ip6.src == 2001::/64" reroute 2002::x
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: bad next hop argument: 2002::x
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2322"
$at_failed && at_fn_log_failure
$at_traceon; }



    }


    ovn_nbctl_lsp_types() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-add ls0 lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-add ls0 lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-get-type lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-get-type lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 l2gateway"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 l2gateway
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-get-type lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-get-type lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "l2gateway
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 router"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 router
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-get-type lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-get-type lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "router
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 switch"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 switch
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-get-type lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-get-type lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "switch
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 localnet"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 localnet
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-get-type lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-get-type lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "localnet
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 localport"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 localport
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-get-type lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-get-type lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "localport
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 vtep"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 vtep
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-get-type lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-get-type lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "vtep
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 l3gateway"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 l3gateway
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Logical switch port type 'l3gateway' is unrecognized. Not setting type.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 patch"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 patch
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Logical switch port type 'patch' is unrecognized. Not setting type.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 chassisredirect"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 chassisredirect
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Logical switch port type 'chassisredirect' is unrecognized. Not setting type.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-get-type lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-get-type lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "vtep
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 eggs"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 eggs
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Logical switch port type 'eggs' is unrecognized. Not setting type.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 \"\""
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 ""
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-get-type lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-get-type lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 router peer=qwe"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 router peer=qwe
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: Peer can only be set for a logical switch port with type 'switch'.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-get-type lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-get-type lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-set-type lp0 switch peer=my-peer"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-set-type lp0 switch peer=my-peer
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl lsp-get-type lp0"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl lsp-get-type lp0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "switch
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2449: ovn-nbctl get logical-switch-port lp0 peer"
at_fn_check_prepare_trace "ovn-nbctl.at:2449"
( $at_check_trace; ovn-nbctl get logical-switch-port lp0 peer
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "my-peer
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2449"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_connection() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2536: ovn-nbctl --inactivity-probe=30000 set-connection ptcp:6641:127.0.0.1 punix:\$OVS_RUNDIR/ovnnb_db.sock"
at_fn_check_prepare_dynamic "ovn-nbctl --inactivity-probe=30000 set-connection ptcp:6641:127.0.0.1 punix:$OVS_RUNDIR/ovnnb_db.sock" "ovn-nbctl.at:2536"
( $at_check_trace; ovn-nbctl --inactivity-probe=30000 set-connection ptcp:6641:127.0.0.1 punix:$OVS_RUNDIR/ovnnb_db.sock
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2536"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2536: ovn-nbctl list connection | grep inactivity_probe"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:2536"
( $at_check_trace; ovn-nbctl list connection | grep inactivity_probe
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "inactivity_probe    : 30000
inactivity_probe    : 30000
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2536"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_dry_run_mode() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2545: ovn-nbctl --dry-run ls-add ls0 -- ls-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:2545"
( $at_check_trace; ovn-nbctl --dry-run ls-add ls0 -- ls-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (ls0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2545"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2545: ovn-nbctl ls-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:2545"
( $at_check_trace; ovn-nbctl ls-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2545"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2545: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:2545"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2545"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2545: ovn-nbctl ls-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:2545"
( $at_check_trace; ovn-nbctl ls-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (ls0)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2545"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_oneline_output() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2561: ovn-nbctl ls-add ls0 -- ls-add ls1"
at_fn_check_prepare_trace "ovn-nbctl.at:2561"
( $at_check_trace; ovn-nbctl ls-add ls0 -- ls-add ls1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2561"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2561: ovn-nbctl --oneline ls-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:2561"
( $at_check_trace; ovn-nbctl --oneline ls-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (ls0)\\n<1> (ls1)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2561"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2561: ovn-nbctl --oneline ls-list -- ls-list | uuidfilt"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:2561"
( $at_check_trace; ovn-nbctl --oneline ls-list -- ls-list | uuidfilt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "<0> (ls0)\\n<1> (ls1)
<0> (ls0)\\n<1> (ls1)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2561"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_error_paths() {


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl -- --if-exists --if-exists list Logical_Switch"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl -- --if-exists --if-exists list Logical_Switch
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'option specified multiple times' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'option specified multiple times' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'missing command name' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'missing command name' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl --if-exists"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl --if-exists
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'missing command name' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'missing command name' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl --"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl --
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'missing command name' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'missing command name' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl -- --if-exists"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl -- --if-exists
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'missing command name' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'missing command name' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl foo"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl foo
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'unknown command' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'unknown command' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl -- foo"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl -- foo
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'unknown command' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'unknown command' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl --foo list Logical_Switch"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl --foo list Logical_Switch
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'unrecognized option' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'unrecognized option' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl -- --foo list Logical_Switch"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl -- --foo list Logical_Switch
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'command has no .* option' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'command has no .* option' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl --columns"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl --columns
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'option .* requires an argument' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'option .* requires an argument' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl -- --columns list Logical_Switch"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl -- --columns list Logical_Switch
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'missing argument to .* option' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'missing argument to .* option' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl --if-exists=foo list Logical_Switch"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl --if-exists=foo list Logical_Switch
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep -E 'option .* doesn'\\''t allow an argument|option .* requires an argument' stderr"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-nbctl.at:2577"
( $at_check_trace; grep -E 'option .* doesn'\''t allow an argument|option .* requires an argument' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl -- --if-exists=foo list Logical_Switch"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl -- --if-exists=foo list Logical_Switch
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'option on .* does not accept an argument' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'option on .* does not accept an argument' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl list"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl list
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'command requires at least .* arguments' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'command requires at least .* arguments' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl -- list"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl -- list
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'command requires at least .* arguments' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'command requires at least .* arguments' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl show foo bar"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl show foo bar
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'command takes at most .* arguments' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'command takes at most .* arguments' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl -- show foo bar"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl -- show foo bar
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'command takes at most .* arguments' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'command takes at most .* arguments' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl show foo --bar"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl show foo --bar
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'command takes at most .* arguments' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'command takes at most .* arguments' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: ovn-nbctl -- show foo --bar"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; ovn-nbctl -- show foo --bar
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2577: grep 'command takes at most .* arguments' stderr"
at_fn_check_prepare_trace "ovn-nbctl.at:2577"
( $at_check_trace; grep 'command takes at most .* arguments' stderr
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2577"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_port_groups() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2648: ovn-nbctl create Port_Group name=pg0"
at_fn_check_prepare_trace "ovn-nbctl.at:2648"
( $at_check_trace; ovn-nbctl create Port_Group name=pg0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2648"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2648: ovn-nbctl get Port_Group pg0 name"
at_fn_check_prepare_trace "ovn-nbctl.at:2648"
( $at_check_trace; ovn-nbctl get Port_Group pg0 name
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "pg0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2648"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_extra_newlines() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2655: ovn-nbctl ls-add sw1"
at_fn_check_prepare_trace "ovn-nbctl.at:2655"
( $at_check_trace; ovn-nbctl ls-add sw1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2655"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2655: ovn-nbctl --columns=name list logical_switch sw1"
at_fn_check_prepare_trace "ovn-nbctl.at:2655"
( $at_check_trace; ovn-nbctl --columns=name list logical_switch sw1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "name                : sw1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2655"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2655: ovn-nbctl --columns=name list logical_switch sw1"
at_fn_check_prepare_trace "ovn-nbctl.at:2655"
( $at_check_trace; ovn-nbctl --columns=name list logical_switch sw1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "name                : sw1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2655"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_table_formatting() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2667: ovn-nbctl ls-add sw1"
at_fn_check_prepare_trace "ovn-nbctl.at:2667"
( $at_check_trace; ovn-nbctl ls-add sw1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2667"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2667: ovn-nbctl --bare --columns=name list logical_switch sw1"
at_fn_check_prepare_trace "ovn-nbctl.at:2667"
( $at_check_trace; ovn-nbctl --bare --columns=name list logical_switch sw1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "sw1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2667"
$at_failed && at_fn_log_failure
$at_traceon; }

    }


    ovn_nbctl_port_group_commands() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl pg-add pg1"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl pg-add pg1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl --bare --columns=name list port_group pg1"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl --bare --columns=name list port_group pg1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "pg1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl pg-del pg1"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl pg-del pg1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl list port_group"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl list port_group
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl ls-add sw1"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl ls-add sw1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl lsp-add sw1 sw1-p1"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl lsp-add sw1 sw1-p1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }

SW1P1=$(ovn-nbctl --bare --columns=_uuid list logical_switch_port sw1-p1)
{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl lsp-add sw1 sw1-p2"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl lsp-add sw1 sw1-p2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }

SW1P2=$(ovn-nbctl --bare --columns=_uuid list logical_switch_port sw1-p2)

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl pg-add pg1 sw1-p1"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl pg-add pg1 sw1-p1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl --bare --columns=name list port_group pg1"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl --bare --columns=name list port_group pg1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "pg1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl --bare --columns=ports list port_group pg1"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl --bare --columns=ports list port_group pg1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "$SW1P1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl pg-set-ports pg1 sw1-p2"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl pg-set-ports pg1 sw1-p2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl --bare --columns=ports list port_group pg1"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl --bare --columns=ports list port_group pg1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "$SW1P2
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl pg-del pg1"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl pg-del pg1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2677: ovn-nbctl list port_group"
at_fn_check_prepare_trace "ovn-nbctl.at:2677"
( $at_check_trace; ovn-nbctl list port_group
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2677"
$at_failed && at_fn_log_failure
$at_traceon; }


    }


    ovn_nbctl_fwd_groups() {


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2710: ovn-nbctl fwd-group-add fwd_grp1 ls0 10.1.1.11 00:11:22:33:44:55 lsp1 lsp2"
at_fn_check_prepare_trace "ovn-nbctl.at:2710"
( $at_check_trace; ovn-nbctl fwd-group-add fwd_grp1 ls0 10.1.1.11 00:11:22:33:44:55 lsp1 lsp2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: ls0: switch name not found
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2710"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2710: ovn-nbctl ls-add ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:2710"
( $at_check_trace; ovn-nbctl ls-add ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2710"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2710: ovn-nbctl fwd-group-add fwd_grp1 ls0 10.1.1.11 00:11:22:33:44:55 lsp1 lsp2"
at_fn_check_prepare_trace "ovn-nbctl.at:2710"
( $at_check_trace; ovn-nbctl fwd-group-add fwd_grp1 ls0 10.1.1.11 00:11:22:33:44:55 lsp1 lsp2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lsp1: logical switch port does not exist
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2710"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2710: ovn-nbctl lsp-add ls0 lsp1"
at_fn_check_prepare_trace "ovn-nbctl.at:2710"
( $at_check_trace; ovn-nbctl lsp-add ls0 lsp1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2710"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2710: ovn-nbctl lsp-add ls0 lsp2"
at_fn_check_prepare_trace "ovn-nbctl.at:2710"
( $at_check_trace; ovn-nbctl lsp-add ls0 lsp2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2710"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2710: ovn-nbctl fwd-group-add fwd_grp1 ls0 10.1.1.11 00:11:22:33:44:55 lsp1 lsp2"
at_fn_check_prepare_trace "ovn-nbctl.at:2710"
( $at_check_trace; ovn-nbctl fwd-group-add fwd_grp1 ls0 10.1.1.11 00:11:22:33:44:55 lsp1 lsp2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2710"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2710: ovn-nbctl fwd-group-list ls0"
at_fn_check_prepare_trace "ovn-nbctl.at:2710"
( $at_check_trace; ovn-nbctl fwd-group-list ls0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "FWD_GROUP       LS            VIP             VMAC                  CHILD_PORTS
fwd_grp1        ls0           10.1.1.11      00:11:22:33:44:55      lsp1 lsp2
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2710"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2710: ovn-nbctl --bare --columns=name list forwarding_group"
at_fn_check_prepare_trace "ovn-nbctl.at:2710"
( $at_check_trace; ovn-nbctl --bare --columns=name list forwarding_group
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "fwd_grp1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2710"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2710: ovn-nbctl fwd-group-add fwd_grp1 ls0 10.1.1.11 00:11:22:33:44:55 lsp1 lsp2"
at_fn_check_prepare_trace "ovn-nbctl.at:2710"
( $at_check_trace; ovn-nbctl fwd-group-add fwd_grp1 ls0 10.1.1.11 00:11:22:33:44:55 lsp1 lsp2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: fwd_grp1: a forwarding group by this name already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2710"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2710: ovn-nbctl fwd-group-del fwd_grp1"
at_fn_check_prepare_trace "ovn-nbctl.at:2710"
( $at_check_trace; ovn-nbctl fwd-group-del fwd_grp1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2710"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2710: ovn-nbctl list forwarding_group"
at_fn_check_prepare_trace "ovn-nbctl.at:2710"
( $at_check_trace; ovn-nbctl list forwarding_group
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2710"
$at_failed && at_fn_log_failure
$at_traceon; }



    }


    ovn_nbctl_static_mac_binding() {


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl lr-add lr0"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl lr-add lr0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl lrp-add lr0 lr0-p0 00:00:01:01:02:03 192.168.10.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl lrp-add lr0 lr0-p0 00:00:01:01:02:03 192.168.10.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl lrp-add lr0 lr0-p1 00:00:02:02:03:04 192.168.11.1/24"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl lrp-add lr0 lr0-p1 00:00:02:02:03:04 192.168.11.1/24
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-add lr0-p0 192.168.10.10 00:00:11:22:33:44"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-add lr0-p0 192.168.10.10 00:00:11:22:33:44
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-add lr0-p0 192.168.10.100 00:00:22:33:44:55"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-add lr0-p0 192.168.10.100 00:00:22:33:44:55
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-add lr0-p0 10.0.0.10 00:00:33:44:55:66"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-add lr0-p0 10.0.0.10 00:00:33:44:55:66
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-add lr0-p0 172.16.0.11 00:00:44:55:66:88"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-add lr0-p0 172.16.0.11 00:00:44:55:66:88
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-add lr0-p0 foo 00:00:44:55:66:88"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-add lr0-p0 foo 00:00:44:55:66:88
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: foo: Not a valid IPv4 or IPv6 address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-add lr0-p0 172.16.0.200 foo"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-add lr0-p0 172.16.0.200 foo
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid mac address foo.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-add lr0-p0 172.16.0.11 00:00:44:55:66:77"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-add lr0-p0 172.16.0.11 00:00:44:55:66:77
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: lr0-p0, 172.16.0.11: a Static_MAC_Binding with this logical_port and ip already exists
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl --may-exist static-mac-binding-add lr0-p0 172.16.0.11 00:00:44:55:66:77"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl --may-exist static-mac-binding-add lr0-p0 172.16.0.11 00:00:44:55:66:77
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-add lr0-p1 10.0.0.10 00:00:33:44:55:66"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-add lr0-p1 10.0.0.10 00:00:33:44:55:66
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-add lr0-p1 172.16.0.11 00:00:44:55:66:88"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-add lr0-p1 172.16.0.11 00:00:44:55:66:88
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-list"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-list
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "LOGICAL_PORT             IP                       MAC
lr0-p0                   10.0.0.10                00:00:33:44:55:66
lr0-p0                   172.16.0.11              00:00:44:55:66:77
lr0-p0                   192.168.10.10            00:00:11:22:33:44
lr0-p0                   192.168.10.100           00:00:22:33:44:55
lr0-p1                   10.0.0.10                00:00:33:44:55:66
lr0-p1                   172.16.0.11              00:00:44:55:66:88
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-del lr0-p0 foo"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-del lr0-p0 foo
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: foo: Not a valid IPv4 or IPv6 address.
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-del lr0-p1 10.0.0.100"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-del lr0-p1 10.0.0.100
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: no matching Static_MAC_Binding with port lr0-p1 and ip 10.0.0.100
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl --if-exists static-mac-binding-del lr0-p1 10.0.0.100"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl --if-exists static-mac-binding-del lr0-p1 10.0.0.100
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-del lr0-p0 10.0.0.10"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-del lr0-p0 10.0.0.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-del lr0-p0 192.168.10.100"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-del lr0-p0 192.168.10.100
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-list"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-list
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "LOGICAL_PORT             IP                       MAC
lr0-p0                   172.16.0.11              00:00:44:55:66:77
lr0-p0                   192.168.10.10            00:00:11:22:33:44
lr0-p1                   10.0.0.10                00:00:33:44:55:66
lr0-p1                   172.16.0.11              00:00:44:55:66:88
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-del lr0-p1 10.0.0.10"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-del lr0-p1 10.0.0.10
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2748: ovn-nbctl static-mac-binding-list"
at_fn_check_prepare_trace "ovn-nbctl.at:2748"
( $at_check_trace; ovn-nbctl static-mac-binding-list
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "LOGICAL_PORT             IP                       MAC
lr0-p0                   172.16.0.11              00:00:44:55:66:77
lr0-p0                   192.168.10.10            00:00:11:22:33:44
lr0-p1                   172.16.0.11              00:00:44:55:66:88
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-nbctl.at:2748"
$at_failed && at_fn_log_failure
$at_traceon; }



    }


    ovn_nbctl_negative() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2817: ovn-nbctl --id=@ls create logical_switch name=foo -- \\
          set logical_switch foo1 name=bar"
at_fn_check_prepare_notrace 'an embedded newline' "ovn-nbctl.at:2817"
( $at_check_trace; ovn-nbctl --id=@ls create logical_switch name=foo -- \
          set logical_switch foo1 name=bar
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: no row \"foo1\" in table Logical_Switch
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2817"
$at_failed && at_fn_log_failure
$at_traceon; }


    }


    acl_tiers() {

check ovn-nbctl ls-add ls
check ovn-nbctl --tier=3 acl-add ls from-lport 1000 "ip" drop
check_column 3 nb:ACL tier priority=1000

check ovn-nbctl --tier=3 acl-add ls from-lport 1001 "ip" drop
check_column 3 nb:ACL tier priority=1001

check ovn-nbctl --tier=2 acl-add ls from-lport 1002 "ip" drop
check_column 2 nb:ACL tier priority=1002

# Removing the tier 3 acls from ls should result in 1 ACL
# remaining.
check ovn-nbctl --tier=3 acl-del ls
check_row_count nb:ACL 1
check_column 2 nb:ACL tier priority=1002

# Add two egress ACLs at tier 2.
check ovn-nbctl --tier=2 acl-add ls to-lport 1000 "ip" drop
check ovn-nbctl --tier=2 acl-add ls to-lport 1001 "ip" drop

check_row_count nb:ACL 3 tier=2

# This should remove the egress tier 2 ACLs and leave the
# ingress tier 2 ACL
check ovn-nbctl --tier=2 acl-del ls to-lport
check_row_count nb:ACL 1
check_column 2 nb:ACL tier priority=1002
check_column from-lport nb:ACL direction priority=1002

# Re-add two ingress ACLs at tier 2.
check ovn-nbctl --tier=2 acl-add ls from-lport 1000 "ip" drop
check ovn-nbctl --tier=2 acl-add ls from-lport 1001 "ip" drop

check_row_count nb:ACL 3

# Attempt to remove all tier 3 ACLs. All three ACLs are tier 2
# so this shouldn't have any effect.
check ovn-nbctl --tier=3 acl-del ls
check_row_count nb:ACL 3

# Attempt to remove all ingress tier 3 ACLs. All three ACLs are tier
# 2, so this shouldn't have any effect.
check ovn-nbctl --tier=3 acl-del ls from-lport
check_row_count nb:ACL 3

# Attempt to remove the 1000 priority ACL but specify tier 3. Since
# all ACLs are tier 2, this should have no effect.
check ovn-nbctl --tier=3 acl-del ls from-lport 1000 "ip"
check_row_count nb:ACL 3

# Specifying the proper tier should result in all ACLs being deleted.
check ovn-nbctl --tier=2 acl-del ls
check_row_count nb:ACL 0

# Now let's experiment with identical ACLs at different tiers.
check ovn-nbctl --tier=1 acl-add ls from-lport 1000 "ip" drop
check ovn-nbctl --tier=2 acl-add ls from-lport 1000 "ip" drop
check ovn-nbctl --tier=3 acl-add ls from-lport 1000 "ip" drop
check_row_count nb:ACL 3
check_row_count nb:ACL 1 tier=1
check_row_count nb:ACL 1 tier=2
check_row_count nb:ACL 1 tier=3

# Specifying tier 1 should result in only one ACL being deleted.
check ovn-nbctl --tier=1 acl-del ls from-lport 1000 "ip"
check_row_count nb:ACL 2
check_row_count nb:ACL 1 tier=2
check_row_count nb:ACL 1 tier=3

# Not specifying a tier should result in all ACLs being deleted.
check ovn-nbctl acl-del ls from-lport 1000 "ip"
check_row_count nb:ACL 0

    }


    acl_sampling() {

check ovn-nbctl ls-add ls
check_uuid ovn-nbctl \
  --id=@sample1 create Sample metadata=4301 -- \
  --sample-new=@sample1 acl-add ls from-lport 1 1 allow-related
sample1=$(fetch_column nb:Sample _uuid metadata=4301)
check_column "$sample1" nb:ACL sample_new priority=1

check_uuid ovn-nbctl \
  --id=@sample2 create Sample metadata=4302 -- \
  --sample-est=@sample2 acl-add ls from-lport 2 1 allow-related
sample2=$(fetch_column nb:Sample _uuid metadata=4302)
check_column "$sample2" nb:ACL sample_est priority=2

check_uuid ovn-nbctl \
  --id=@sample3 create Sample metadata=4303 -- \
  --id=@sample4 create Sample metadata=4304 -- \
  --sample-new=@sample3 --sample-est=@sample4 acl-add ls from-lport 3 1 allow-related
sample3=$(fetch_column nb:Sample _uuid metadata=4303)
sample4=$(fetch_column nb:Sample _uuid metadata=4304)
check_column "$sample3" nb:ACL sample_new priority=3
check_column "$sample4" nb:ACL sample_est priority=3

{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2904: ovn-nbctl --sample-new=foo acl-add ls from-lport 4 1 allow-related"
at_fn_check_prepare_trace "ovn-nbctl.at:2904"
( $at_check_trace; ovn-nbctl --sample-new=foo acl-add ls from-lport 4 1 allow-related
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid --sample-new: \"foo\" is not a valid UUID
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2904"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-nbctl.at:2904: ovn-nbctl --sample-est=bar acl-add ls from-lport 4 1 allow-related"
at_fn_check_prepare_trace "ovn-nbctl.at:2904"
( $at_check_trace; ovn-nbctl --sample-est=bar acl-add ls from-lport 4 1 allow-related
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovn-nbctl: invalid --sample-est: \"bar\" is not a valid UUID
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn-nbctl.at:2904"
$at_failed && at_fn_log_failure
$at_traceon; }



    }


# OVN_SBCTL_TEST_START

ovn_sbctl_test_start() {
      for daemon in ovn-nb ovn-sb; do
      { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:13: ovsdb-tool create \$daemon.db \$abs_top_srcdir/\${daemon}.ovsschema"
at_fn_check_prepare_notrace 'a ${...} parameter expansion' "ovn-sbctl.at:13"
( $at_check_trace; ovsdb-tool create $daemon.db $abs_top_srcdir/${daemon}.ovsschema
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:13"
$at_failed && at_fn_log_failure
$at_traceon; }

   done

      { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:17: ovsdb-server --detach --no-chdir --pidfile=ovnnb_db.pid --unixctl=\$OVS_RUNDIR/ovnnb_db.ctl --log-file=ovsdb_nb.log --remote=punix:\$OVS_RUNDIR/ovnnb_db.sock ovn-nb.db "
at_fn_check_prepare_dynamic "ovsdb-server --detach --no-chdir --pidfile=ovnnb_db.pid --unixctl=$OVS_RUNDIR/ovnnb_db.ctl --log-file=ovsdb_nb.log --remote=punix:$OVS_RUNDIR/ovnnb_db.sock ovn-nb.db " "ovn-sbctl.at:17"
( $at_check_trace; ovsdb-server --detach --no-chdir --pidfile=ovnnb_db.pid --unixctl=$OVS_RUNDIR/ovnnb_db.ctl --log-file=ovsdb_nb.log --remote=punix:$OVS_RUNDIR/ovnnb_db.sock ovn-nb.db
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:17"
$at_failed && at_fn_log_failure
$at_traceon; }

   { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:18: ovsdb-server --detach --no-chdir --pidfile=ovnsb_db.pid --unixctl=\$OVS_RUNDIR/ovnsb_db.ctl --log-file=ovsdb_sb.log --remote=punix:\$OVS_RUNDIR/ovnsb_db.sock ovn-sb.db"
at_fn_check_prepare_dynamic "ovsdb-server --detach --no-chdir --pidfile=ovnsb_db.pid --unixctl=$OVS_RUNDIR/ovnsb_db.ctl --log-file=ovsdb_sb.log --remote=punix:$OVS_RUNDIR/ovnsb_db.sock ovn-sb.db" "ovn-sbctl.at:18"
( $at_check_trace; ovsdb-server --detach --no-chdir --pidfile=ovnsb_db.pid --unixctl=$OVS_RUNDIR/ovnsb_db.ctl --log-file=ovsdb_sb.log --remote=punix:$OVS_RUNDIR/ovnsb_db.sock ovn-sb.db
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:18"
$at_failed && at_fn_log_failure
$at_traceon; }

   on_exit "kill `cat ovnnb_db.pid` `cat ovnsb_db.pid`"
   { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:20: sed < stderr '
/vlog|INFO|opened log file/d
/ovsdb_server|INFO|ovsdb-server (Open vSwitch)/d'"
at_fn_check_prepare_notrace 'an embedded newline' "ovn-sbctl.at:20"
( $at_check_trace; sed < stderr '
/vlog|INFO|opened log file/d
/ovsdb_server|INFO|ovsdb-server (Open vSwitch)/d'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:20"
$at_failed && at_fn_log_failure
$at_traceon; }


      { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:25: ovn-northd --detach --no-chdir --pidfile --log-file --ovnnb-db=unix:\$OVS_RUNDIR/ovnnb_db.sock --ovnsb-db=unix:\$OVS_RUNDIR/ovnsb_db.sock"
at_fn_check_prepare_dynamic "ovn-northd --detach --no-chdir --pidfile --log-file --ovnnb-db=unix:$OVS_RUNDIR/ovnnb_db.sock --ovnsb-db=unix:$OVS_RUNDIR/ovnsb_db.sock" "ovn-sbctl.at:25"
( $at_check_trace; ovn-northd --detach --no-chdir --pidfile --log-file --ovnnb-db=unix:$OVS_RUNDIR/ovnnb_db.sock --ovnsb-db=unix:$OVS_RUNDIR/ovnsb_db.sock
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; tee stderr <"$at_stderr"
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:25"
$at_failed && at_fn_log_failure
$at_traceon; }

   on_exit "kill `cat ovn-northd.pid`"
   { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:27: sed < stderr '
/vlog|INFO|opened log file/d'"
at_fn_check_prepare_notrace 'an embedded newline' "ovn-sbctl.at:27"
( $at_check_trace; sed < stderr '
/vlog|INFO|opened log file/d'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:27"
$at_failed && at_fn_log_failure
$at_traceon; }


   case $1 in #(
  daemon) :
    export OVN_SB_DAEMON=$(ovn-sbctl --pidfile --detach --no-chdir --log-file -vsocket_util:off)
        on_exit "kill `cat ovn-sbctl.pid`" ;; #(
  direct) :
     ;; #(
  *) :
    printf "%s\n" "ovn-sbctl.at:30" >"$at_check_line_file"
at_fn_check_skip 99 "$at_srcdir/ovn-sbctl.at:30" ;; #(
  *) :
     ;;
esac
}

# OVN_SBCTL_TEST_STOP

ovn_sbctl_test_stop() {
  { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:41: check_logs \"\$1\""
at_fn_check_prepare_dynamic "check_logs \"$1\"" "ovn-sbctl.at:41"
( $at_check_trace; check_logs "$1"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:41"
$at_failed && at_fn_log_failure
$at_traceon; }

  { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:42: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn-sbctl.at:42"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:42"
$at_failed && at_fn_log_failure
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:42: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn-sbctl.at:42"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:42"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-sbctl.at:42" "while kill -0 \$TMPPID 2>/dev/null"

  { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:43: test -e \$OVS_RUNDIR/ovnnb_db.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovnnb_db.pid" "ovn-sbctl.at:43"
( $at_check_trace; test -e $OVS_RUNDIR/ovnnb_db.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:43"
$at_failed && at_fn_log_failure
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovnnb_db.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:43: ovs-appctl --timeout=10 --target=\$OVS_RUNDIR/ovnnb_db.ctl exit"
at_fn_check_prepare_dynamic "ovs-appctl --timeout=10 --target=$OVS_RUNDIR/ovnnb_db.ctl exit" "ovn-sbctl.at:43"
( $at_check_trace; ovs-appctl --timeout=10 --target=$OVS_RUNDIR/ovnnb_db.ctl exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:43"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-sbctl.at:43" "while kill -0 \$TMPPID 2>/dev/null"

  { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:44: test -e \$OVS_RUNDIR/ovnsb_db.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovnsb_db.pid" "ovn-sbctl.at:44"
( $at_check_trace; test -e $OVS_RUNDIR/ovnsb_db.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:44"
$at_failed && at_fn_log_failure
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovnsb_db.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:44: ovs-appctl --timeout=10 --target=\$OVS_RUNDIR/ovnsb_db.ctl exit"
at_fn_check_prepare_dynamic "ovs-appctl --timeout=10 --target=$OVS_RUNDIR/ovnsb_db.ctl exit" "ovn-sbctl.at:44"
( $at_check_trace; ovs-appctl --timeout=10 --target=$OVS_RUNDIR/ovnsb_db.ctl exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:44"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-sbctl.at:44" "while kill -0 \$TMPPID 2>/dev/null"

}


    ovn_sbctl_chassis_commands() {

ovn_init_db ovn-sb

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:70: ovn-sbctl chassis-add ch0 geneve 1.2.3.4"
at_fn_check_prepare_trace "ovn-sbctl.at:70"
( $at_check_trace; ovn-sbctl chassis-add ch0 geneve 1.2.3.4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:70"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:70: ovn-sbctl -f csv -d bare --no-headings --columns ip,type list encap | sort"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:70"
( $at_check_trace; ovn-sbctl -f csv -d bare --no-headings --columns ip,type list encap | sort
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1.2.3.4,geneve
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:70"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:70: ovn-sbctl chassis-add ch1 geneve,vxlan 1.2.3.5"
at_fn_check_prepare_trace "ovn-sbctl.at:70"
( $at_check_trace; ovn-sbctl chassis-add ch1 geneve,vxlan 1.2.3.5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:70"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:70: ovn-sbctl -f csv -d bare --no-headings --columns ip,type list encap | sort"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:70"
( $at_check_trace; ovn-sbctl -f csv -d bare --no-headings --columns ip,type list encap | sort
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1.2.3.4,geneve
1.2.3.5,geneve
1.2.3.5,vxlan
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:70"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:70: ovn-sbctl chassis-del ch0"
at_fn_check_prepare_trace "ovn-sbctl.at:70"
( $at_check_trace; ovn-sbctl chassis-del ch0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:70"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:70: ovn-sbctl -f csv -d bare --no-headings --columns ip,type list encap | sort"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:70"
( $at_check_trace; ovn-sbctl -f csv -d bare --no-headings --columns ip,type list encap | sort
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1.2.3.5,geneve
1.2.3.5,vxlan
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:70"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:70: ovn-sbctl chassis-add ch2 geneve 2.3.4.5"
at_fn_check_prepare_trace "ovn-sbctl.at:70"
( $at_check_trace; ovn-sbctl chassis-add ch2 geneve 2.3.4.5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:70"
$at_failed && at_fn_log_failure
$at_traceon; }

ch2_uuid=$(ovn-sbctl -d bare --no-headings --columns _uuid find chassis name=ch2)
check_uuid ovn-sbctl create Chassis_Private name=ch2 chassis=$ch2_uuid
check_row_count Chassis_Private 1

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:70: ovn-sbctl -f csv -d bare --no-headings --columns ip,type list encap | sort"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:70"
( $at_check_trace; ovn-sbctl -f csv -d bare --no-headings --columns ip,type list encap | sort
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1.2.3.5,geneve
1.2.3.5,vxlan
2.3.4.5,geneve
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:70"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:70: ovn-sbctl chassis-del ch2"
at_fn_check_prepare_trace "ovn-sbctl.at:70"
( $at_check_trace; ovn-sbctl chassis-del ch2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:70"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:70: ovn-sbctl -f csv -d bare --no-headings --columns ip,type list encap | sort"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:70"
( $at_check_trace; ovn-sbctl -f csv -d bare --no-headings --columns ip,type list encap | sort
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1.2.3.5,geneve
1.2.3.5,vxlan
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:70"
$at_failed && at_fn_log_failure
$at_traceon; }

check_row_count Chassis_Private 0

as ovn-sb
{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:70: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn-sbctl.at:70"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:70"
$at_failed && at_fn_log_failure
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:70: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn-sbctl.at:70"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:70"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-sbctl.at:70" "while kill -0 \$TMPPID 2>/dev/null"

as

    }


    ovn_sbctl_commands() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-nbctl ls-add br-test"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-nbctl ls-add br-test
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-nbctl lsp-add br-test vif0"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-nbctl lsp-add br-test vif0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-nbctl lsp-set-addresses vif0 f0:ab:cd:ef:01:02"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-nbctl lsp-set-addresses vif0 f0:ab:cd:ef:01:02
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-sbctl chassis-add ch0 geneve 1.2.3.5"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-sbctl chassis-add ch0 geneve 1.2.3.5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-nbctl --wait=sb sync"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-nbctl --wait=sb sync
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-sbctl lsp-bind vif0 ch0"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-sbctl lsp-bind vif0 ch0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-sbctl show"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-sbctl show
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Chassis ch0
    Encap geneve
        ip: \"1.2.3.5\"
        options: {csum=\"true\"}
    Port_Binding vif0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }


# adds another 'vif1'
{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-nbctl --wait=sb lsp-add br-test vif1"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-nbctl --wait=sb lsp-add br-test vif1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-nbctl lsp-set-addresses vif1 f0:ab:cd:ef:01:03"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-nbctl lsp-set-addresses vif1 f0:ab:cd:ef:01:03
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-sbctl lsp-bind vif1 ch0"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-sbctl lsp-bind vif1 ch0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-sbctl show | sed 's/vif[0-9]/vif/'"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:121"
( $at_check_trace; ovn-sbctl show | sed 's/vif[0-9]/vif/'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Chassis ch0
    Encap geneve
        ip: \"1.2.3.5\"
        options: {csum=\"true\"}
    Port_Binding vif
    Port_Binding vif
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }


# deletes 'vif1'
{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-nbctl lsp-del vif1"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-nbctl lsp-del vif1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-nbctl --wait=sb sync"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-nbctl --wait=sb sync
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-sbctl show"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-sbctl show
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Chassis ch0
    Encap geneve
        ip: \"1.2.3.5\"
        options: {csum=\"true\"}
    Port_Binding vif0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }


uuid=$(ovn-sbctl --columns=_uuid list Chassis ch0 | cut -d ':' -f2 | tr -d ' ')
{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-sbctl --columns=logical_port,mac,chassis list Port_Binding"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-sbctl --columns=logical_port,mac,chassis list Port_Binding
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "logical_port        : vif0
mac                 : [\"f0:ab:cd:ef:01:02\"]
chassis             : ${uuid}
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }


# test the passing down of logical port type and options.
{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-nbctl --wait=sb lsp-add br-test vtep0"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-nbctl --wait=sb lsp-add br-test vtep0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-nbctl lsp-set-type vtep0 vtep"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-nbctl lsp-set-type vtep0 vtep
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-nbctl lsp-set-options vtep0 vtep_physical_switch=p0 vtep_logical_switch=l0"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-nbctl lsp-set-options vtep0 vtep_physical_switch=p0 vtep_logical_switch=l0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-sbctl wait-until Port_Binding vtep0 options!={}"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-sbctl wait-until Port_Binding vtep0 options!={}
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:121: ovn-sbctl --columns=logical_port,mac,type,options list Port_Binding vtep0"
at_fn_check_prepare_trace "ovn-sbctl.at:121"
( $at_check_trace; ovn-sbctl --columns=logical_port,mac,type,options list Port_Binding vtep0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "logical_port        : vtep0
mac                 : []
type                : vtep
options             : {vtep_logical_switch=l0, vtep_physical_switch=p0}
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }


    }


    ovn_sbctl_connection() {

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:186: ovn-sbctl --inactivity-probe=30000 set-connection ptcp:6641:127.0.0.1 punix:\$OVS_RUNDIR/ovnsb_db.sock"
at_fn_check_prepare_dynamic "ovn-sbctl --inactivity-probe=30000 set-connection ptcp:6641:127.0.0.1 punix:$OVS_RUNDIR/ovnsb_db.sock" "ovn-sbctl.at:186"
( $at_check_trace; ovn-sbctl --inactivity-probe=30000 set-connection ptcp:6641:127.0.0.1 punix:$OVS_RUNDIR/ovnsb_db.sock
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:186"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:186: ovn-sbctl list connection | grep inactivity_probe"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:186"
( $at_check_trace; ovn-sbctl list connection | grep inactivity_probe
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "inactivity_probe    : 30000
inactivity_probe    : 30000
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:186"
$at_failed && at_fn_log_failure
$at_traceon; }


    }


    ovn_sbctl_invalid_0x_flow() {

check ovn-sbctl lflow-list 0x12345678

    }


    ovn_sbctl_count_flows() {


count_entries() {
    ovn-sbctl --column=_uuid list Logical_Flow | sed -r '/^\s*$/d' | wc -l
}

count_pipeline() {
    ovn-sbctl  --column=pipeline list Logical_Flow | grep $1 | sed -r '/^\s*$/d' | wc -l
}

# we start with empty Logical_Flow table
# validate that the table is indeed empty
{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:200: count_entries"
at_fn_check_prepare_trace "ovn-sbctl.at:200"
( $at_check_trace; count_entries
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:200"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:200: ovn-sbctl count-flows"
at_fn_check_prepare_trace "ovn-sbctl.at:200"
( $at_check_trace; ovn-sbctl count-flows
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Total number of logical flows = 0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:200"
$at_failed && at_fn_log_failure
$at_traceon; }


# create some logical flows
check ovn-nbctl ls-add count-test

check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    total_lflows=`count_entries`; test $total_lflows -ne 0
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn-sbctl.at:200" "until total_lflows=\`count_entries\`; test \$total_lflows -ne 0"


total_lflows=`count_entries`
egress_lflows=`count_pipeline egress`
ingress_lflows=`count_pipeline ingress`

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:200: ovn-sbctl count-flows | grep \"flows =\" | awk 'NF>1{print \$NF}'"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:200"
( $at_check_trace; ovn-sbctl count-flows | grep "flows =" | awk 'NF>1{print $NF}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "$total_lflows
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:200"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:200: ovn-sbctl count-flows | grep Total | grep egress | awk 'NF>1{print \$NF}'"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:200"
( $at_check_trace; ovn-sbctl count-flows | grep Total | grep egress | awk 'NF>1{print $NF}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "$egress_lflows
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:200"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:200: ovn-sbctl count-flows | grep Total | grep ingress | awk 'NF>1{print \$NF}'"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:200"
( $at_check_trace; ovn-sbctl count-flows | grep Total | grep ingress | awk 'NF>1{print $NF}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "$ingress_lflows
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:200"
$at_failed && at_fn_log_failure
$at_traceon; }


# add another datapath
check ovn-nbctl --wait=sb ls-add count-test2

wait_column 2 Datapath_Binding tunnel_key external_ids:name=count-test2

# check total logical flows in 2 datapathes
{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:200: ovn-sbctl count-flows | grep \"flows =\" | awk 'NF>1{print \$NF}'"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:200"
( $at_check_trace; ovn-sbctl count-flows | grep "flows =" | awk 'NF>1{print $NF}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "$(($total_lflows * 2))
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:200"
$at_failed && at_fn_log_failure
$at_traceon; }

# check total logical flows in a specific datapath
{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:200: ovn-sbctl count-flows count-test | grep \"flows =\" | awk 'NF>1{print \$NF}'"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:200"
( $at_check_trace; ovn-sbctl count-flows count-test | grep "flows =" | awk 'NF>1{print $NF}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "$total_lflows
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:200"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:200: ovn-sbctl count-flows count-test | grep Total | grep egress | awk 'NF>1{print \$NF}'"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:200"
( $at_check_trace; ovn-sbctl count-flows count-test | grep Total | grep egress | awk 'NF>1{print $NF}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "$egress_lflows
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:200"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:200: ovn-sbctl count-flows count-test | grep Total | grep ingress | awk 'NF>1{print \$NF}'"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn-sbctl.at:200"
( $at_check_trace; ovn-sbctl count-flows count-test | grep Total | grep ingress | awk 'NF>1{print $NF}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "$ingress_lflows
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:200"
$at_failed && at_fn_log_failure
$at_traceon; }


# check nonexistent datapath
{ set +x
printf "%s\n" "$at_srcdir/ovn-sbctl.at:200: ovn-sbctl count-flows wrongDatapath"
at_fn_check_prepare_trace "ovn-sbctl.at:200"
( $at_check_trace; ovn-sbctl count-flows wrongDatapath
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Total number of logical flows = 0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-sbctl.at:200"
$at_failed && at_fn_log_failure
$at_traceon; }


    }


# Checks if the provided engine node recomputed or not
# and if it computed or not.
# 1st argument is the simulated hypervisor name.
# 2nd argument is the engine node.
# 3rd argument is the expected recompute state.
#   Possible values are - "norecompute" and "recompute".
# 4th argument is the expected compute state.
#   Possible values are - "nocompute" and "compute".
#
# Eg. 'check_controller_engine_stats hv1 logical_flow_output recompute nocompute'
# will verify that if the lflow engine node recompute stat is > 0 and
# compute stat is equal to 0.  It fails otherwise.
check_controller_engine_stats() {
  hv=$1
  node=$2
  recompute=$3
  compute=$4

  echo "Checking engine stats for node $node : recompute - \
$recompute : compute - $compute"

  node_stat=$(as $hv ovn-appctl -t ovn-controller inc-engine/show-stats $node)
  # node_stat will be of this format :
  #     - Node: logical_flow_output - recompute: 3 - compute: 0 - cancel: 0
  node_recompute_ct=$(echo $node_stat | cut -d '-' -f2 | cut -d ':' -f2)
  node_compute_ct=$(echo $node_stat | cut -d '-' -f3 | cut -d ':' -f2)

  if [ "$recompute" == "norecompute" ]; then
    # node should not be recomputed
    echo "Expecting $node recompute count - $node_recompute_ct to be 0"
    check test "$node_recompute_ct" -eq "0"
  else
    echo "Expecting $node recompute count - $node_recompute_ct not to be 0"
    check test "$node_recompute_ct" -ne "0"
  fi

  if [ "$compute" == "nocompute" ]; then
    # node should not be computed
    echo "Expecting $node compute count - $node_compute_ct to be 0"
    check test "$node_compute_ct" -eq "0"
  else
    echo "Expecting $node compute count - $node_compute_ct not to be 0"
    check test "$node_compute_ct" -ne "0"
  fi
}

# try_checkpatch PATCH [ERRORS]
#
# Runs checkpatch under Python 2 and Python 3, if installed, on the given
# PATCH, expecting the specified set of ERRORS (and warnings).
try_checkpatch() {
    # Take the patch to test from $1.  Remove an initial four-space indent
    # from it and, if it is just headers with no body, add a null body.
    # If it does not have a 'Subject', add a valid one.
    echo "$1" | sed 's/^    //' > test.patch
    if grep 'Subject\:' test.patch >/dev/null 2>&1; then :
    else
        sed -i'' -e '1i\
Subject: Patch this is.
' test.patch
    fi
    if grep '---' expout >/dev/null 2>&1; then :
    else
        printf '\n---\n' >> test.patch
    fi

    # Take expected output from $2.
    if test -n "$2"; then
        echo "$2" | sed 's/^    //' > expout
    else
        : > expout
    fi

    try_checkpatch__ "$PYTHON3"
}
try_checkpatch__() {
    if test -s expout; then
        { set +x
printf "%s\n" "$at_srcdir/checkpatch.at:35: \$1 \$top_srcdir/utilities/checkpatch.py -q test.patch"
at_fn_check_prepare_dynamic "$1 $top_srcdir/utilities/checkpatch.py -q test.patch" "checkpatch.at:35"
( $at_check_trace; $1 $top_srcdir/utilities/checkpatch.py -q test.patch
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; tee stdout <"$at_stdout"
at_fn_check_status 1 $at_status "$at_srcdir/checkpatch.at:35"
$at_failed && at_fn_log_failure
$at_traceon; }

        { set +x
printf "%s\n" "$at_srcdir/checkpatch.at:37: sed '/^Lines checked:/,\$d' stdout"
at_fn_check_prepare_dynamic "sed '/^Lines checked:/,$d' stdout" "checkpatch.at:37"
( $at_check_trace; sed '/^Lines checked:/,$d' stdout
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/checkpatch.at:37"
$at_failed && at_fn_log_failure
$at_traceon; }

    else
        { set +x
printf "%s\n" "$at_srcdir/checkpatch.at:39: \$1 \$top_srcdir/utilities/checkpatch.py -q test.patch"
at_fn_check_prepare_dynamic "$1 $top_srcdir/utilities/checkpatch.py -q test.patch" "checkpatch.at:39"
( $at_check_trace; $1 $top_srcdir/utilities/checkpatch.py -q test.patch
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/checkpatch.at:39"
$at_failed && at_fn_log_failure
$at_traceon; }

    fi
}

   {
  printf "%s\n" "## ---------------- ##
## Tested programs. ##
## ---------------- ##"
  echo
} >&5

# Report what programs are being tested.
for at_program in : `eval echo $at_tested`
do
  case $at_program in #(
  :) :
    continue ;; #(
  [\\/]* | ?:[\\/]*) :
    at_program_=$at_program ;; #(
  *) :
    as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
for as_dir in $PATH
do
  IFS=$as_save_IFS
  case $as_dir in #(((
    '') as_dir=./ ;;
    */) ;;
    *) as_dir=$as_dir/ ;;
  esac
    test -f "$as_dir$at_program" && break
  done
IFS=$as_save_IFS

    at_program_=$as_dir$at_program ;;
esac

  if test -f "$at_program_"; then
    {
      printf "%s\n" "$at_srcdir/testsuite.at:1: $at_program_ --version"
      "$at_program_" --version </dev/null
      echo
    } >&5 2>&1
  else
    as_fn_error $? "cannot find $at_program" "$LINENO" 5
  fi
done

{
  printf "%s\n" "## ------------------ ##
## Running the tests. ##
## ------------------ ##"
} >&5

at_start_date=`date`
at_start_time=`date +%s 2>/dev/null`
printf "%s\n" "$as_me: starting at: $at_start_date" >&5

# Create the master directory if it doesn't already exist.
as_dir="$at_suite_dir"; as_fn_mkdir_p ||
  as_fn_error $? "cannot create \`$at_suite_dir'" "$LINENO" 5

# Can we diff with `/dev/null'?  DU 5.0 refuses.
if diff /dev/null /dev/null >/dev/null 2>&1; then
  at_devnull=/dev/null
else
  at_devnull=$at_suite_dir/devnull
  >"$at_devnull"
fi

# Use `diff -u' when possible.
if at_diff=`diff -u "$at_devnull" "$at_devnull" 2>&1` && test -z "$at_diff"
then
  at_diff='diff -u'
else
  at_diff=diff
fi

# Get the last needed group.
for at_group in : $at_groups; do :; done

# Extract the start and end lines of each test group at the tail
# of this file
awk '
BEGIN { FS="" }
/^#AT_START_/ {
  start = NR
}
/^#AT_STOP_/ {
  test = substr ($ 0, 10)
  print "at_sed" test "=\"1," start "d;" (NR-1) "q\""
  if (test == "'"$at_group"'") exit
}' "$at_myself" > "$at_suite_dir/at-source-lines" &&
. "$at_suite_dir/at-source-lines" ||
  as_fn_error $? "cannot create test line number cache" "$LINENO" 5
rm -f "$at_suite_dir/at-source-lines"

# Set number of jobs for `-j'; avoid more jobs than test groups.
set X $at_groups; shift; at_max_jobs=$#
if test $at_max_jobs -eq 0; then
  at_jobs=1
fi
if test $at_jobs -ne 1 &&
   { test $at_jobs -eq 0 || test $at_jobs -gt $at_max_jobs; }; then
  at_jobs=$at_max_jobs
fi

# If parallel mode, don't output banners, don't split summary lines.
if test $at_jobs -ne 1; then
  at_print_banners=false
  at_quiet=:
fi

# Set up helper dirs.
rm -rf "$at_helper_dir" &&
mkdir "$at_helper_dir" &&
cd "$at_helper_dir" &&
{ test -z "$at_groups" || mkdir $at_groups; } ||
as_fn_error $? "testsuite directory setup failed" "$LINENO" 5

# Functions for running a test group.  We leave the actual
# test group execution outside of a shell function in order
# to avoid hitting zsh 4.x exit status bugs.

# at_fn_group_prepare
# -------------------
# Prepare for running a test group.
at_fn_group_prepare ()
{
  # The directory for additional per-group helper files.
  at_job_dir=$at_helper_dir/$at_group
  # The file containing the location of the last AT_CHECK.
  at_check_line_file=$at_job_dir/check-line
  # The file containing the exit status of the last command.
  at_status_file=$at_job_dir/status
  # The files containing the output of the tested commands.
  at_stdout=$at_job_dir/stdout
  at_stder1=$at_job_dir/stder1
  at_stderr=$at_job_dir/stderr
  # The file containing the code for a test group.
  at_test_source=$at_job_dir/test-source
  # The file containing dates.
  at_times_file=$at_job_dir/times

  # Be sure to come back to the top test directory.
  cd "$at_suite_dir"

  # Clearly separate the test groups when verbose.
  $at_first || $at_verbose echo

  at_group_normalized=$at_group

  eval 'while :; do
    case $at_group_normalized in #(
    '"$at_format"'*) break;;
    esac
    at_group_normalized=0$at_group_normalized
  done'


  # Create a fresh directory for the next test group, and enter.
  # If one already exists, the user may have invoked ./run from
  # within that directory; we remove the contents, but not the
  # directory itself, so that we aren't pulling the rug out from
  # under the shell's notion of the current directory.
  at_group_dir=$at_suite_dir/$at_group_normalized
  at_group_log=$at_group_dir/$as_me.log
  if test -d "$at_group_dir"
then
  find "$at_group_dir" -type d ! -perm -700 -exec chmod u+rwx {} \;
  rm -fr "$at_group_dir"/* "$at_group_dir"/.[!.] "$at_group_dir"/.??*
fi ||
    { printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: test directory for $at_group_normalized could not be cleaned" >&5
printf "%s\n" "$as_me: WARNING: test directory for $at_group_normalized could not be cleaned" >&2;}
  # Be tolerant if the above `rm' was not able to remove the directory.
  as_dir="$at_group_dir"; as_fn_mkdir_p

  echo 0 > "$at_status_file"

  # In verbose mode, append to the log file *and* show on
  # the standard output; in quiet mode only write to the log.
  if test -z "$at_verbose"; then
    at_tee_pipe='tee -a "$at_group_log"'
  else
    at_tee_pipe='cat >> "$at_group_log"'
  fi
}

# at_fn_group_banner ORDINAL LINE DESC PAD [BANNER]
# -------------------------------------------------
# Declare the test group ORDINAL, located at LINE with group description DESC,
# and residing under BANNER. Use PAD to align the status column.
at_fn_group_banner ()
{
  at_setup_line="$2"
  test -n "$5" && at_fn_banner $5
  at_desc="$3"
  case $1 in
    [0-9])      at_desc_line="  $1: ";;
    [0-9][0-9]) at_desc_line=" $1: " ;;
    *)          at_desc_line="$1: "  ;;
  esac
  as_fn_append at_desc_line "$3$4"
  $at_quiet printf %s "$at_desc_line"
  echo "#                             -*- compilation -*-" >> "$at_group_log"
}

# at_fn_group_postprocess
# -----------------------
# Perform cleanup after running a test group.
at_fn_group_postprocess ()
{
  # Be sure to come back to the suite directory, in particular
  # since below we might `rm' the group directory we are in currently.
  cd "$at_suite_dir"

  if test ! -f "$at_check_line_file"; then
    sed "s/^ */$as_me: WARNING: /" <<_ATEOF
      A failure happened in a test group before any test could be
      run. This means that test suite is improperly designed.  Please
      report this failure to <bugs@openvswitch.org>.
_ATEOF
    printf "%s\n" "$at_setup_line" >"$at_check_line_file"
    at_status=99
  fi
  $at_verbose printf %s "$at_group. $at_setup_line: "
  printf %s "$at_group. $at_setup_line: " >> "$at_group_log"
  case $at_xfail:$at_status in
    yes:0)
	at_msg="UNEXPECTED PASS"
	at_res=xpass
	at_errexit=$at_errexit_p
	at_color=$at_red
	;;
    no:0)
	at_msg="ok"
	at_res=pass
	at_errexit=false
	at_color=$at_grn
	;;
    *:77)
	at_msg='skipped ('`cat "$at_check_line_file"`')'
	at_res=skip
	at_errexit=false
	at_color=$at_blu
	;;
    no:* | *:99)
	at_msg='FAILED ('`cat "$at_check_line_file"`')'
	at_res=fail
	at_errexit=$at_errexit_p
	at_color=$at_red
	;;
    yes:*)
	at_msg='expected failure ('`cat "$at_check_line_file"`')'
	at_res=xfail
	at_errexit=false
	at_color=$at_lgn
	;;
  esac
  echo "$at_res" > "$at_job_dir/$at_res"
  # In parallel mode, output the summary line only afterwards.
  if test $at_jobs -ne 1 && test -n "$at_verbose"; then
    printf "%s\n" "$at_desc_line $at_color$at_msg$at_std"
  else
    # Make sure there is a separator even with long titles.
    printf "%s\n" " $at_color$at_msg$at_std"
  fi
  at_log_msg="$at_group. $at_desc ($at_setup_line): $at_msg"
  case $at_status in
    0|77)
      # $at_times_file is only available if the group succeeded.
      # We're not including the group log, so the success message
      # is written in the global log separately.  But we also
      # write to the group log in case they're using -d.
      if test -f "$at_times_file"; then
	at_log_msg="$at_log_msg     ("`sed 1d "$at_times_file"`')'
	rm -f "$at_times_file"
      fi
      printf "%s\n" "$at_log_msg" >> "$at_group_log"
      printf "%s\n" "$at_log_msg" >&5

      # Cleanup the group directory, unless the user wants the files
      # or the success was unexpected.
      if $at_debug_p || test $at_res = xpass; then
	at_fn_create_debugging_script
	if test $at_res = xpass && $at_errexit; then
	  echo stop > "$at_stop_file"
	fi
      else
	if test -d "$at_group_dir"; then
	  find "$at_group_dir" -type d ! -perm -700 -exec chmod u+rwx \{\} \;
	  rm -fr "$at_group_dir"
	fi
	rm -f "$at_test_source"
      fi
      ;;
    *)
      # Upon failure, include the log into the testsuite's global
      # log.  The failure message is written in the group log.  It
      # is later included in the global log.
      printf "%s\n" "$at_log_msg" >> "$at_group_log"

      # Upon failure, keep the group directory for autopsy, and create
      # the debugging script.  With -e, do not start any further tests.
      at_fn_create_debugging_script
      if $at_errexit; then
	echo stop > "$at_stop_file"
      fi
      ;;
  esac
}


## ------------ ##
## Driver loop. ##
## ------------ ##


if (set -m && set +m && set +b) >/dev/null 2>&1; then
  set +b
  at_job_control_on='set -m' at_job_control_off='set +m' at_job_group=-
else
  at_job_control_on=: at_job_control_off=: at_job_group=
fi

for at_signal in 1 2 15; do
  trap 'set +x; set +e
	$at_job_control_off
	at_signal='"$at_signal"'
	echo stop > "$at_stop_file"
	trap "" $at_signal
	at_pgids=
	for at_pgid in `jobs -p 2>/dev/null`; do
	  at_pgids="$at_pgids $at_job_group$at_pgid"
	done
	test -z "$at_pgids" || kill -$at_signal $at_pgids 2>/dev/null
	wait
	if test "$at_jobs" -eq 1 || test -z "$at_verbose"; then
	  echo >&2
	fi
	at_signame=`kill -l $at_signal 2>&1 || echo $at_signal`
	set x $at_signame
	test 0 -gt 2 && at_signame=$at_signal
	{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: caught signal $at_signame, bailing out" >&5
printf "%s\n" "$as_me: WARNING: caught signal $at_signame, bailing out" >&2;}
	as_fn_arith 128 + $at_signal && exit_status=$as_val
	as_fn_exit $exit_status' $at_signal
done

rm -f "$at_stop_file"
at_first=:

if test $at_jobs -ne 1 &&
     rm -f "$at_job_fifo" &&
     test -n "$at_job_group" &&
     ( mkfifo "$at_job_fifo" && trap 'exit 1' PIPE STOP TSTP ) 2>/dev/null
then
  # FIFO job dispatcher.

  trap 'at_pids=
	for at_pid in `jobs -p`; do
	  at_pids="$at_pids $at_job_group$at_pid"
	done
	if test -n "$at_pids"; then
	  at_sig=TSTP
	  test ${TMOUT+y} && at_sig=STOP
	  kill -$at_sig $at_pids 2>/dev/null
	fi
	kill -STOP $$
	test -z "$at_pids" || kill -CONT $at_pids 2>/dev/null' TSTP

  echo
  # Turn jobs into a list of numbers, starting from 1.
  at_joblist=`printf "%s\n" "$at_groups" | sed -n 1,${at_jobs}p`

  set X $at_joblist
  shift
  for at_group in $at_groups; do
    $at_job_control_on 2>/dev/null
    (
      # Start one test group.
      $at_job_control_off
      if $at_first; then
	exec 7>"$at_job_fifo"
      else
	exec 6<&-
      fi
      trap 'set +x; set +e
	    trap "" PIPE
	    echo stop > "$at_stop_file"
	    echo >&7
	    as_fn_exit 141' PIPE
      at_fn_group_prepare
      if cd "$at_group_dir" &&
	 at_fn_test $at_group &&
	 . "$at_test_source"
      then :; else
	{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: unable to parse test group: $at_group" >&5
printf "%s\n" "$as_me: WARNING: unable to parse test group: $at_group" >&2;}
	at_failed=:
      fi
      at_fn_group_postprocess
      echo >&7
    ) &
    $at_job_control_off
    if $at_first; then
      at_first=false
      exec 6<"$at_job_fifo" 7>"$at_job_fifo"
    fi
    shift # Consume one token.
    if test $# -gt 0; then :; else
      read at_token <&6 || break
      set x $*
    fi
    test -f "$at_stop_file" && break
  done
  exec 7>&-
  # Read back the remaining ($at_jobs - 1) tokens.
  set X $at_joblist
  shift
  if test $# -gt 0; then
    shift
    for at_job
    do
      read at_token
    done <&6
  fi
  exec 6<&-
  wait
else
  # Run serially, avoid forks and other potential surprises.
  for at_group in $at_groups; do
    at_fn_group_prepare
    if cd "$at_group_dir" &&
       at_fn_test $at_group &&
       . "$at_test_source"; then :; else
      { printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: unable to parse test group: $at_group" >&5
printf "%s\n" "$as_me: WARNING: unable to parse test group: $at_group" >&2;}
      at_failed=:
    fi
    at_fn_group_postprocess
    test -f "$at_stop_file" && break
    at_first=false
  done
fi

# Wrap up the test suite with summary statistics.
cd "$at_helper_dir"

# Use ?..???? when the list must remain sorted, the faster * otherwise.
at_pass_list=`for f in */pass; do echo $f; done | sed '/\*/d; s,/pass,,'`
at_skip_list=`for f in */skip; do echo $f; done | sed '/\*/d; s,/skip,,'`
at_xfail_list=`for f in */xfail; do echo $f; done | sed '/\*/d; s,/xfail,,'`
at_xpass_list=`for f in ?/xpass ??/xpass ???/xpass ????/xpass; do
		 echo $f; done | sed '/?/d; s,/xpass,,'`
at_fail_list=`for f in ?/fail ??/fail ???/fail ????/fail; do
		echo $f; done | sed '/?/d; s,/fail,,'`

set X $at_pass_list $at_xpass_list $at_xfail_list $at_fail_list $at_skip_list
shift; at_group_count=$#
set X $at_xpass_list; shift; at_xpass_count=$#; at_xpass_list=$*
set X $at_xfail_list; shift; at_xfail_count=$#
set X $at_fail_list; shift; at_fail_count=$#; at_fail_list=$*
set X $at_skip_list; shift; at_skip_count=$#

as_fn_arith $at_group_count - $at_skip_count && at_run_count=$as_val
as_fn_arith $at_xpass_count + $at_fail_count && at_unexpected_count=$as_val
as_fn_arith $at_xfail_count + $at_fail_count && at_total_fail_count=$as_val

# Back to the top directory.
cd "$at_dir"
rm -rf "$at_helper_dir"

# Compute the duration of the suite.
at_stop_date=`date`
at_stop_time=`date +%s 2>/dev/null`
printf "%s\n" "$as_me: ending at: $at_stop_date" >&5
case $at_start_time,$at_stop_time in
  [0-9]*,[0-9]*)
    as_fn_arith $at_stop_time - $at_start_time && at_duration_s=$as_val
    as_fn_arith $at_duration_s / 60 && at_duration_m=$as_val
    as_fn_arith $at_duration_m / 60 && at_duration_h=$as_val
    as_fn_arith $at_duration_s % 60 && at_duration_s=$as_val
    as_fn_arith $at_duration_m % 60 && at_duration_m=$as_val
    at_duration="${at_duration_h}h ${at_duration_m}m ${at_duration_s}s"
    printf "%s\n" "$as_me: test suite duration: $at_duration" >&5
    ;;
esac

echo
printf "%s\n" "## ------------- ##
## Test results. ##
## ------------- ##"
echo
{
  echo
  printf "%s\n" "## ------------- ##
## Test results. ##
## ------------- ##"
  echo
} >&5

if test $at_run_count = 1; then
  at_result="1 test"
  at_were=was
else
  at_result="$at_run_count tests"
  at_were=were
fi
if $at_errexit_p && test $at_unexpected_count != 0; then
  if test $at_xpass_count = 1; then
    at_result="$at_result $at_were run, one passed"
  else
    at_result="$at_result $at_were run, one failed"
  fi
  at_result="$at_result unexpectedly and inhibited subsequent tests."
  at_color=$at_red
else
  # Don't you just love exponential explosion of the number of cases?
  at_color=$at_red
  case $at_xpass_count:$at_fail_count:$at_xfail_count in
    # So far, so good.
    0:0:0) at_result="$at_result $at_were successful." at_color=$at_grn ;;
    0:0:*) at_result="$at_result behaved as expected." at_color=$at_lgn ;;

    # Some unexpected failures
    0:*:0) at_result="$at_result $at_were run,
$at_fail_count failed unexpectedly." ;;

    # Some failures, both expected and unexpected
    0:*:1) at_result="$at_result $at_were run,
$at_total_fail_count failed ($at_xfail_count expected failure)." ;;
    0:*:*) at_result="$at_result $at_were run,
$at_total_fail_count failed ($at_xfail_count expected failures)." ;;

    # No unexpected failures, but some xpasses
    *:0:*) at_result="$at_result $at_were run,
$at_xpass_count passed unexpectedly." ;;

    # No expected failures, but failures and xpasses
    *:1:0) at_result="$at_result $at_were run,
$at_unexpected_count did not behave as expected ($at_fail_count unexpected failure)." ;;
    *:*:0) at_result="$at_result $at_were run,
$at_unexpected_count did not behave as expected ($at_fail_count unexpected failures)." ;;

    # All of them.
    *:*:1) at_result="$at_result $at_were run,
$at_xpass_count passed unexpectedly,
$at_total_fail_count failed ($at_xfail_count expected failure)." ;;
    *:*:*) at_result="$at_result $at_were run,
$at_xpass_count passed unexpectedly,
$at_total_fail_count failed ($at_xfail_count expected failures)." ;;
  esac

  if test $at_skip_count = 0 && test $at_run_count -gt 1; then
    at_result="All $at_result"
  fi
fi

# Now put skips in the mix.
case $at_skip_count in
  0) ;;
  1) at_result="$at_result
1 test was skipped." ;;
  *) at_result="$at_result
$at_skip_count tests were skipped." ;;
esac

if test $at_unexpected_count = 0; then
  echo "$at_color$at_result$at_std"
  echo "$at_result" >&5
else
  echo "${at_color}ERROR: $at_result$at_std" >&2
  echo "ERROR: $at_result" >&5
  {
    echo
    printf "%s\n" "## ------------------------ ##
## Summary of the failures. ##
## ------------------------ ##"

    # Summary of failed and skipped tests.
    if test $at_fail_count != 0; then
      echo "Failed tests:"
      $SHELL "$at_myself" $at_fail_list --list
      echo
    fi
    if test $at_skip_count != 0; then
      echo "Skipped tests:"
      $SHELL "$at_myself" $at_skip_list --list
      echo
    fi
    if test $at_xpass_count != 0; then
      echo "Unexpected passes:"
      $SHELL "$at_myself" $at_xpass_list --list
      echo
    fi
    if test $at_fail_count != 0; then
      printf "%s\n" "## ---------------------- ##
## Detailed failed tests. ##
## ---------------------- ##"
      echo
      for at_group in $at_fail_list
      do
	at_group_normalized=$at_group

  eval 'while :; do
    case $at_group_normalized in #(
    '"$at_format"'*) break;;
    esac
    at_group_normalized=0$at_group_normalized
  done'

	cat "$at_suite_dir/$at_group_normalized/$as_me.log"
	echo
      done
      echo
    fi
    if test -n "$at_top_srcdir"; then
      sed 'h;s/./-/g;s/^.../## /;s/...$/ ##/;p;x;p;x' <<_ASBOX
## ${at_top_build_prefix}config.log ##
_ASBOX
      sed 's/^/| /' ${at_top_build_prefix}config.log
      echo
    fi
  } >&5

  sed 'h;s/./-/g;s/^.../## /;s/...$/ ##/;p;x;p;x' <<_ASBOX
## $as_me.log was created. ##
_ASBOX

  echo
  if $at_debug_p; then
    at_msg='per-test log files'
  else
    at_msg="\`${at_testdir+${at_testdir}/}$as_me.log'"
  fi
  at_msg1a=${at_xpass_list:+', '}
  at_msg1=$at_fail_list${at_fail_list:+" failed$at_msg1a"}
  at_msg2=$at_xpass_list${at_xpass_list:+" passed unexpectedly"}

  printf "%s\n" "Please send $at_msg and all information you think might help:

   To: <bugs@openvswitch.org>
   Subject: [ovn 25.03.90] $as_me: $at_msg1$at_msg2

You may investigate any problem if you feel able to do so, in which
case the test suite provides a good starting point.  Its output may
be found below \`${at_testdir+${at_testdir}/}$as_me.dir'.
"
  exit 1
fi

exit 0

## ------------- ##
## Actual tests. ##
## ------------- ##
#AT_START_1
at_fn_group_banner 1 'network-functions.at:14' \
  "ip_to_hex" "                                      " 1
at_xfail=no
(
  printf "%s\n" "1. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


{ set +x
printf "%s\n" "$at_srcdir/network-functions.at:16: ip_to_hex 192 168 0 1"
at_fn_check_prepare_trace "network-functions.at:16"
( $at_check_trace; ip_to_hex 192 168 0 1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "c0a80001" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/network-functions.at:16"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/network-functions.at:17: ip_to_hex 192.168.0.1"
at_fn_check_prepare_trace "network-functions.at:17"
( $at_check_trace; ip_to_hex 192.168.0.1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "c0a80001" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/network-functions.at:17"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_1
#AT_START_2
at_fn_group_banner 2 'network-functions.at:43' \
  "ip_csum" "                                        " 1
at_xfail=no
(
  printf "%s\n" "2. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


test_csum() {
    { set +x
printf "%s\n" "$at_srcdir/network-functions.at:46: ip_csum \$1"
at_fn_check_prepare_dynamic "ip_csum $1" "network-functions.at:46"
( $at_check_trace; ip_csum $1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "$2" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/network-functions.at:46"
$at_failed && at_fn_log_failure
$at_traceon; }

}
test_csum 4500003c1c4640004006b1e600000a63ac100a0c ac10
test_csum 4500003c1c4640004006b1e6ac100a63ac100a0c 0000
test_csum 4500007600000000400100000a000003aca80003 c3d9
test_csum 45000076000000004001c3d90a000003aca80003 0000
ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_2
#AT_START_3
at_fn_group_banner 3 'network-functions.at:66' \
  "ip4_csum_inplace" "                               " 1
at_xfail=no
(
  printf "%s\n" "3. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/network-functions.at:67: ip4_csum_inplace 450000730000400040110000c0a80001c0a800c7"
at_fn_check_prepare_trace "network-functions.at:67"
( $at_check_trace; ip4_csum_inplace 450000730000400040110000c0a80001c0a800c7
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "45000073000040004011b861c0a80001c0a800c7
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/network-functions.at:67"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_3
#AT_START_4
at_fn_group_banner 4 'network-functions.at:87' \
  "ip6_pseudoheader" "                               " 1
at_xfail=no
(
  printf "%s\n" "4. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


{ set +x
printf "%s\n" "$at_srcdir/network-functions.at:89: ip6_pseudoheader 6000000000203aff''fe8000000000000088c57541aa0c58ee''ff020000000000000000000000000001 3a 32"
at_fn_check_prepare_trace "network-functions.at:89"
( $at_check_trace; ip6_pseudoheader 6000000000203aff''fe8000000000000088c57541aa0c58ee''ff020000000000000000000000000001 3a 32
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "fe8000000000000088c57541aa0c58eeff020000000000000000000000000001000000200000003a" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/network-functions.at:89"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_4
#AT_START_5
at_fn_group_banner 5 'network-functions.at:112' \
  "icmp6_csum" "                                     " 1
at_xfail=no
(
  printf "%s\n" "5. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


ipv6_src=10000000000000000000000000000003
ipv6_dst=20000000000000000000000000000002
payload=0000000000000000000000000000000000000000  # 20 0-bytes
payload=${payload}${payload}                      # 40 0-bytes
payload=${payload}${payload}                      # 80 0-bytes
ip6=6000000000583afe${ipv6_src}${ipv6_dst}
{ set +x
printf "%s\n" "$at_srcdir/network-functions.at:120: icmp6_csum 8000000062f00001\${payload} \$ip6"
at_fn_check_prepare_notrace 'a ${...} parameter expansion' "network-functions.at:120"
( $at_check_trace; icmp6_csum 8000000062f00001${payload} $ip6
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ec76" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/network-functions.at:120"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/network-functions.at:121: icmp6_csum 8000ec7662f00001\${payload} \$ip6"
at_fn_check_prepare_notrace 'a ${...} parameter expansion' "network-functions.at:121"
( $at_check_trace; icmp6_csum 8000ec7662f00001${payload} $ip6
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0000" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/network-functions.at:121"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/network-functions.at:122: icmp6_csum_inplace 8000000062f00001\${payload} \$ip6"
at_fn_check_prepare_notrace 'a ${...} parameter expansion' "network-functions.at:122"
( $at_check_trace; icmp6_csum_inplace 8000000062f00001${payload} $ip6
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "8000ec7662f00001${payload}
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/network-functions.at:122"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_5
#AT_START_6
at_fn_group_banner 6 'network-functions.at:187' \
  "tcpdump_hex" "                                    " 1
at_xfail=no
(
  printf "%s\n" "6. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


printf "%s\n" "network-functions.at:189" >"$at_check_line_file"
(test $HAVE_TCPDUMP = no) \
  && at_fn_check_skip 77 "$at_srcdir/network-functions.at:189"
{ set +x
printf "%s\n" "$at_srcdir/network-functions.at:190: tcpdump_hex title ffffffffffff0011223344550800"
at_fn_check_prepare_trace "network-functions.at:190"
( $at_check_trace; tcpdump_hex title ffffffffffff0011223344550800
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; tee stdout <"$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/network-functions.at:190"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/network-functions.at:191: grep 'title:' stdout"
at_fn_check_prepare_trace "network-functions.at:191"
( $at_check_trace; grep 'title:' stdout
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/network-functions.at:191"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/network-functions.at:192: grep '00:11:22:33:44:55' stdout"
at_fn_check_prepare_trace "network-functions.at:192"
( $at_check_trace; grep '00:11:22:33:44:55' stdout
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/network-functions.at:192"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_6
#AT_START_7
at_fn_group_banner 7 'ovn-ipam.at:3' \
  "unit test -- init_ipam_ipv4" "                    " 2
at_xfail=no
(
  printf "%s\n" "7. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

ovn_start

# Valid subnet, no exclude IPs
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:7: ovstest test-ipam ipam_init_ipv4 192.168.0.0/29"
at_fn_check_prepare_trace "ovn-ipam.at:7"
( $at_check_trace; ovstest test-ipam ipam_init_ipv4 192.168.0.0/29
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "start_ipv4: 192.168.0.1
total_ipv4s: 7
allocated_ipv4s: 192.168.0.1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:7"
$at_failed && at_fn_log_failure
$at_traceon; }


# Valid subnet, single exclude IP
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:14: ovstest test-ipam ipam_init_ipv4 192.168.0.0/29 192.168.0.3"
at_fn_check_prepare_trace "ovn-ipam.at:14"
( $at_check_trace; ovstest test-ipam ipam_init_ipv4 192.168.0.0/29 192.168.0.3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "start_ipv4: 192.168.0.1
total_ipv4s: 7
allocated_ipv4s: 192.168.0.1 192.168.0.3
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:14"
$at_failed && at_fn_log_failure
$at_traceon; }


# Valid subnet, two exclude IPs
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:21: ovstest test-ipam ipam_init_ipv4 192.168.0.0/29 \"192.168.0.3 192.168.0.5\""
at_fn_check_prepare_trace "ovn-ipam.at:21"
( $at_check_trace; ovstest test-ipam ipam_init_ipv4 192.168.0.0/29 "192.168.0.3 192.168.0.5"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "start_ipv4: 192.168.0.1
total_ipv4s: 7
allocated_ipv4s: 192.168.0.1 192.168.0.3 192.168.0.5
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:21"
$at_failed && at_fn_log_failure
$at_traceon; }


# Valid subnet, range of exclude IPs
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:28: ovstest test-ipam ipam_init_ipv4 192.168.0.0/29 \"192.168.0.3..192.168.0.5\""
at_fn_check_prepare_trace "ovn-ipam.at:28"
( $at_check_trace; ovstest test-ipam ipam_init_ipv4 192.168.0.0/29 "192.168.0.3..192.168.0.5"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "start_ipv4: 192.168.0.1
total_ipv4s: 7
allocated_ipv4s: 192.168.0.1 192.168.0.3 192.168.0.4 192.168.0.5
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:28"
$at_failed && at_fn_log_failure
$at_traceon; }


# Valid subnet, exclude IP outside of subnet
# Excluded IP should be ignored.
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:36: ovstest test-ipam ipam_init_ipv4 192.168.0.0/29 192.168.0.9"
at_fn_check_prepare_trace "ovn-ipam.at:36"
( $at_check_trace; ovstest test-ipam ipam_init_ipv4 192.168.0.0/29 192.168.0.9
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "start_ipv4: 192.168.0.1
total_ipv4s: 7
allocated_ipv4s: 192.168.0.1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:36"
$at_failed && at_fn_log_failure
$at_traceon; }


# Valid subnet, range of exclude IPs starts in subnet but ends outside
# Excluded IPs inside the subnet should be allocated
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:44: ovstest test-ipam ipam_init_ipv4 192.168.0.0/29 \"192.168.0.5..192.168.0.11\""
at_fn_check_prepare_trace "ovn-ipam.at:44"
( $at_check_trace; ovstest test-ipam ipam_init_ipv4 192.168.0.0/29 "192.168.0.5..192.168.0.11"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "start_ipv4: 192.168.0.1
total_ipv4s: 7
allocated_ipv4s: 192.168.0.1 192.168.0.5 192.168.0.6 192.168.0.7
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:44"
$at_failed && at_fn_log_failure
$at_traceon; }


# Valid subnet, range of exclude IPs starts outside subnet but ends inside
# Excluded IPs inside the subnet should be allocated
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:52: ovstest test-ipam ipam_init_ipv4 192.168.0.8/29 \"192.168.0.5..192.168.0.11\""
at_fn_check_prepare_trace "ovn-ipam.at:52"
( $at_check_trace; ovstest test-ipam ipam_init_ipv4 192.168.0.8/29 "192.168.0.5..192.168.0.11"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "start_ipv4: 192.168.0.9
total_ipv4s: 7
allocated_ipv4s: 192.168.0.9 192.168.0.10 192.168.0.11
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:52"
$at_failed && at_fn_log_failure
$at_traceon; }


# Valid subnet, range of exclude IPs starts before and ends after the subnet
# Entire subnet should be allocated
# XXX Should excluding every address in a subnet be an invalid configuration?
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:61: ovstest test-ipam ipam_init_ipv4 192.168.0.8/29 \"192.168.0.5..192.168.0.18\""
at_fn_check_prepare_trace "ovn-ipam.at:61"
( $at_check_trace; ovstest test-ipam ipam_init_ipv4 192.168.0.8/29 "192.168.0.5..192.168.0.18"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "start_ipv4: 192.168.0.9
total_ipv4s: 7
allocated_ipv4s: 192.168.0.9 192.168.0.10 192.168.0.11 192.168.0.12 192.168.0.13 192.168.0.14 192.168.0.15
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:61"
$at_failed && at_fn_log_failure
$at_traceon; }


# Valid subnet, inverted exclude range
# Exclude range should be ignored
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:69: ovstest test-ipam ipam_init_ipv4 192.168.0.0/29 \"192.168.0.5..192.168.0.2\""
at_fn_check_prepare_trace "ovn-ipam.at:69"
( $at_check_trace; ovstest test-ipam ipam_init_ipv4 192.168.0.0/29 "192.168.0.5..192.168.0.2"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "start_ipv4: 192.168.0.1
total_ipv4s: 7
allocated_ipv4s: 192.168.0.1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:69"
$at_failed && at_fn_log_failure
$at_traceon; }


# XXX At this point, I wanted to insert some tests where I put in invalid
# IP addresses like 400.500.600.700 to ensure that the start_ipv4 was set
# to "0.0.0.0". However, ovs_scan_ip_masked() does no validation of the
# IP address. So long as the given IP address follows the format of
# xxx.xxx.xxx.xxx, it's seen as valid. In the specific case of
# "400.500.600.700", it ends up setting the start_ipv4 to
# "144.244.88.185". This result is probably system-dependent.

# Invalid subnet: Bad mask
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:84: ovstest test-ipam ipam_init_ipv4 192.168.0.0/-69"
at_fn_check_prepare_trace "ovn-ipam.at:84"
( $at_check_trace; ovstest test-ipam ipam_init_ipv4 192.168.0.0/-69
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "start_ipv4: 0.0.0.0
total_ipv4s: 0
allocated_ipv4s:
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:84"
$at_failed && at_fn_log_failure
$at_traceon; }


ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_7
#AT_START_8
at_fn_group_banner 8 'ovn-ipam.at:92' \
  "unit test -- init_ipam_ipv6_prefix" "             " 2
at_xfail=no
(
  printf "%s\n" "8. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

ovn_start

# No prefix set
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:96: ovstest test-ipam ipam_init_ipv6_prefix"
at_fn_check_prepare_trace "ovn-ipam.at:96"
( $at_check_trace; ovstest test-ipam ipam_init_ipv6_prefix
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ipv6_prefix_set: false
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:96"
$at_failed && at_fn_log_failure
$at_traceon; }


# Good prefix with no mask
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:101: ovstest test-ipam ipam_init_ipv6_prefix aef0::"
at_fn_check_prepare_trace "ovn-ipam.at:101"
( $at_check_trace; ovstest test-ipam ipam_init_ipv6_prefix aef0::
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ipv6_prefix_set: true
ipv6_prefix: aef0::
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:101"
$at_failed && at_fn_log_failure
$at_traceon; }


# Good prefix with good mask
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:107: ovstest test-ipam ipam_init_ipv6_prefix aef0::/64"
at_fn_check_prepare_trace "ovn-ipam.at:107"
( $at_check_trace; ovstest test-ipam ipam_init_ipv6_prefix aef0::/64
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ipv6_prefix_set: true
ipv6_prefix: aef0::
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:107"
$at_failed && at_fn_log_failure
$at_traceon; }


# Bad prefix with no mask
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:113: ovstest test-ipam ipam_init_ipv6_prefix aef20::"
at_fn_check_prepare_trace "ovn-ipam.at:113"
( $at_check_trace; ovstest test-ipam ipam_init_ipv6_prefix aef20::
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ipv6_prefix_set: false
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:113"
$at_failed && at_fn_log_failure
$at_traceon; }


# Good prefix with nonsense mask.
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:118: ovstest test-ipam ipam_init_ipv6_prefix aef0::/900"
at_fn_check_prepare_trace "ovn-ipam.at:118"
( $at_check_trace; ovstest test-ipam ipam_init_ipv6_prefix aef0::/900
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ipv6_prefix_set: false
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:118"
$at_failed && at_fn_log_failure
$at_traceon; }


# Good prefix with a non-/64 mask.
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:123: ovstest test-ipam ipam_init_ipv6_prefix aef0::/32"
at_fn_check_prepare_trace "ovn-ipam.at:123"
( $at_check_trace; ovstest test-ipam ipam_init_ipv6_prefix aef0::/32
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ipv6_prefix_set: false
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:123"
$at_failed && at_fn_log_failure
$at_traceon; }


# Bad prefix and a non-/64 mask.
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:128: ovstest test-ipam ipam_init_ipv6_prefix aef20::/32"
at_fn_check_prepare_trace "ovn-ipam.at:128"
( $at_check_trace; ovstest test-ipam ipam_init_ipv6_prefix aef20::/32
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ipv6_prefix_set: false
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:128"
$at_failed && at_fn_log_failure
$at_traceon; }


# Overspecify the IPv6 address.
# We should "round down" to the /64 network address.
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:134: ovstest test-ipam ipam_init_ipv6_prefix aef0::2323"
at_fn_check_prepare_trace "ovn-ipam.at:134"
( $at_check_trace; ovstest test-ipam ipam_init_ipv6_prefix aef0::2323
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ipv6_prefix_set: true
ipv6_prefix: aef0::
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:134"
$at_failed && at_fn_log_failure
$at_traceon; }


# Overspecify the IPv6 address, and specify a mask.
# We should "round down" to the /64 network address.
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:141: ovstest test-ipam ipam_init_ipv6_prefix aef0::2323/64"
at_fn_check_prepare_trace "ovn-ipam.at:141"
( $at_check_trace; ovstest test-ipam ipam_init_ipv6_prefix aef0::2323/64
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ipv6_prefix_set: true
ipv6_prefix: aef0::
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:141"
$at_failed && at_fn_log_failure
$at_traceon; }


ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_8
#AT_START_9
at_fn_group_banner 9 'ovn-ipam.at:148' \
  "unit test -- ipam_get_unused_ip" "                " 2
at_xfail=no
(
  printf "%s\n" "9. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

ovn_start

# Ensure first address returned by IPAM is .2, since .1 is reserved for the
# connected router
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:153: ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 1"
at_fn_check_prepare_trace "ovn-ipam.at:153"
( $at_check_trace; ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "192.168.0.2
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:153"
$at_failed && at_fn_log_failure
$at_traceon; }


# Ensure that we only grab IPs within the requested subnet
# Ignore stderr so that the warning about address space being
# exhausted does not cause the test to fail
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:160: ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 6"
at_fn_check_prepare_trace "ovn-ipam.at:160"
( $at_check_trace; ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 6
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "192.168.0.2
192.168.0.3
192.168.0.4
192.168.0.5
192.168.0.6
0.0.0.0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:160"
$at_failed && at_fn_log_failure
$at_traceon; }


# Set up an exclude IP and ensure it does not get selected
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:170: ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 4 192.168.0.3"
at_fn_check_prepare_trace "ovn-ipam.at:170"
( $at_check_trace; ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 4 192.168.0.3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "192.168.0.2
192.168.0.4
192.168.0.5
192.168.0.6
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:170"
$at_failed && at_fn_log_failure
$at_traceon; }


# Set up an exclude IP range and ensure none gets selected
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:178: ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 2 192.168.0.3..192.168.0.5"
at_fn_check_prepare_trace "ovn-ipam.at:178"
( $at_check_trace; ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 2 192.168.0.3..192.168.0.5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "192.168.0.2
192.168.0.6
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:178"
$at_failed && at_fn_log_failure
$at_traceon; }


# Set up an exclude range from outside the subnet. Ensure it is ignored.
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:184: ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 5 192.168.1.3..192.168.1.5"
at_fn_check_prepare_trace "ovn-ipam.at:184"
( $at_check_trace; ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 5 192.168.1.3..192.168.1.5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "192.168.0.2
192.168.0.3
192.168.0.4
192.168.0.5
192.168.0.6
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:184"
$at_failed && at_fn_log_failure
$at_traceon; }


# Set up an exclude range from outside the subnet. Ensure we cannot assign
# addresses outside the subnet
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:194: ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 6 192.168.1.3..192.168.1.5"
at_fn_check_prepare_trace "ovn-ipam.at:194"
( $at_check_trace; ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 6 192.168.1.3..192.168.1.5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "192.168.0.2
192.168.0.3
192.168.0.4
192.168.0.5
192.168.0.6
0.0.0.0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:194"
$at_failed && at_fn_log_failure
$at_traceon; }


# Set up an exclude range that starts before the subnet but ends in the subnet.
# The overlapping part should be excluded
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:205: ovstest test-ipam ipam_get_unused_ip 192.168.0.8/29 2 192.168.0.2..192.168.0.12"
at_fn_check_prepare_trace "ovn-ipam.at:205"
( $at_check_trace; ovstest test-ipam ipam_get_unused_ip 192.168.0.8/29 2 192.168.0.2..192.168.0.12
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "192.168.0.13
192.168.0.14
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:205"
$at_failed && at_fn_log_failure
$at_traceon; }


# Set up an exclude range that starts in the subnet but ends after the subnet.
# The overlapping part should be excluded.
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:212: ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 3 192.168.0.4..192.168.0.9"
at_fn_check_prepare_trace "ovn-ipam.at:212"
( $at_check_trace; ovstest test-ipam ipam_get_unused_ip 192.168.0.0/29 3 192.168.0.4..192.168.0.9
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "192.168.0.2
192.168.0.3
0.0.0.0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:212"
$at_failed && at_fn_log_failure
$at_traceon; }


# Set up an exclude range that starts before the subnet and ends after the subnet.
# The entire range should be excluded.
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:220: ovstest test-ipam ipam_get_unused_ip 192.168.0.8/29 1 192.168.0.2..192.168.0.18"
at_fn_check_prepare_trace "ovn-ipam.at:220"
( $at_check_trace; ovstest test-ipam ipam_get_unused_ip 192.168.0.8/29 1 192.168.0.2..192.168.0.18
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0.0.0.0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:220"
$at_failed && at_fn_log_failure
$at_traceon; }


# Configure the subnet using a starting IP that is not the network address of the
# subnet. Ensure that we "round it down" to the proper subnet starting point.
{ set +x
printf "%s\n" "$at_srcdir/ovn-ipam.at:226: ovstest test-ipam ipam_get_unused_ip 192.168.0.4/29 5"
at_fn_check_prepare_trace "ovn-ipam.at:226"
( $at_check_trace; ovstest test-ipam ipam_get_unused_ip 192.168.0.4/29 5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "192.168.0.2
192.168.0.3
192.168.0.4
192.168.0.5
192.168.0.6
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn-ipam.at:226"
$at_failed && at_fn_log_failure
$at_traceon; }


ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_9
#AT_START_10
at_fn_group_banner 10 'ovn.at:3' \
  "lexer" "                                          " 3
at_xfail=no
(
  printf "%s\n" "10. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

cat >test-cases.txt <<'_ATEOF'
foo bar baz quuxquuxquux _abcd_ a.b.c.d a123_.456
"abc\u0020def" => "abc def"
" => error("Input ends inside quoted string.")
$foo $bar $baz $quuxquuxquux $_abcd_ $a.b.c.d $a123_.456
$1 => error("`$' must be followed by a valid identifier.") 1

a/*b*/c => a c
a//b c => a
a/**/b => a b
a/*/b => a error("`/*' without matching `*/'.")
a/*/**/b => a b
a/b => a error("`/' is only valid as part of `//' or `/*'.") b

0 1 12345 18446744073709551615
18446744073709551616 => error("Decimal constants must be less than 2**64.")
9999999999999999999999 => error("Decimal constants must be less than 2**64.")
01 => error("Decimal constants must not have leading zeros.")

0/0
0/1
1/0 => 0/0
1/1
128/384
1/3
1/ => error("Integer constant expected.")

1/0x123 => error("Value and mask have incompatible formats.")

0x1234
0x01234 => 0x1234
0x0 => 0
0x000 => 0
0xfedcba9876543210
0XFEDCBA9876543210 => 0xfedcba9876543210
0xfedcba9876543210fedcba9876543210
0x0000fedcba9876543210fedcba9876543210 => 0xfedcba9876543210fedcba9876543210
0x => error("Hex digits expected following 0x.")
0X => error("Hex digits expected following 0X.")
0x0/0x0 => 0/0
0x0/0x1 => 0/0x1
0x1/0x0 => 0/0
0xffff/0x1ffff
0x. => error("Invalid syntax in hexadecimal constant.")

192.168.128.1 1.2.3.4 255.255.255.255 0.0.0.0
256.1.2.3 => error("Invalid numeric constant.")
192.168.0.0/16
192.168.0.0/255.255.0.0 => 192.168.0.0/16
192.168.0.0/255.255.255.0 => 192.168.0.0/24
192.168.0.0/255.255.0.255
192.168.0.0/255.0.0.0 => 192.0.0.0/8
192.168.0.0/32
192.168.0.0/255.255.255.255 => 192.168.0.0/32
192.168.0.2/32
192.168.0.2/30 => 192.168.0.0/30
192.168.0.2/24 => 192.168.0.0/24
1.2.3.4:5 => 1.2.3.4 : 5

::
::1
ff00::1234 => ff00::1234
2001:db8:85a3::8a2e:370:7334
2001:db8:85a3:0:0:8a2e:370:7334 => 2001:db8:85a3::8a2e:370:7334
2001:0db8:85a3:0000:0000:8a2e:0370:7334 => 2001:db8:85a3::8a2e:370:7334
::ffff:192.0.2.128
::ffff:c000:0280 => ::ffff:192.0.2.128
::1/::1
::1/ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff => ::1/128
::1/128
ff00::/8
ff00::/ff00:: => ff00::/8

01:23:45:67:ab:cd
01:23:45:67:AB:CD => 01:23:45:67:ab:cd
fe:dc:ba:98:76:54
FE:DC:ba:98:76:54 => fe:dc:ba:98:76:54
01:00:00:00:00:00/01:00:00:00:00:00
ff:ff:ff:ff:ff:ff/ff:ff:ff:ff:ff:ff
fe:ff:ff:ff:ff:ff/ff:ff:ff:ff:ff:ff
ff:ff:ff:ff:ff:ff/fe:ff:ff:ff:ff:ff => fe:ff:ff:ff:ff:ff/fe:ff:ff:ff:ff:ff
fe:x => error("Invalid numeric constant.")
00:01:02:03:04:x => error("Invalid numeric constant.")

# Test that operators are tokenized as expected, even without white space.
(){}[]==!=<<=>>=!&&||..,;=<->--: => ( ) { } [ ] == != < <= > >= ! && || .. , ; = <-> -- :
& => error("`&' is only valid as part of `&&'.")
| => error("`|' is only valid as part of `||'.")

^ => error("`^' must be followed by a valid identifier.")
_ATEOF


sed 's/ =>.*//' test-cases.txt > input.txt
sed 's/.* => //' test-cases.txt > expout
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:101: ovstest test-ovn lex < input.txt"
at_fn_check_prepare_trace "ovn.at:101"
( $at_check_trace; ovstest test-ovn lex < input.txt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:101"
$at_failed && at_fn_log_failure  \
"input.txt"
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_10
#AT_START_11
at_fn_group_banner 11 'ovn.at:109' \
  "registers" "                                      " 3
at_xfail=no
(
  printf "%s\n" "11. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:110: ovstest test-ovn dump-symtab | grep reg | sort"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn.at:110"
( $at_check_trace; ovstest test-ovn dump-symtab | grep reg | sort
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "reg0 = xxreg0[96..127]
reg1 = xxreg0[64..95]
reg2 = xxreg0[32..63]
reg3 = xxreg0[0..31]
reg4 = xxreg1[96..127]
reg5 = xxreg1[64..95]
reg6 = xxreg1[32..63]
reg7 = xxreg1[0..31]
reg8 = xreg4[32..63]
reg9 = xreg4[0..31]
xreg0 = xxreg0[64..127]
xreg1 = xxreg0[0..63]
xreg2 = xxreg1[64..127]
xreg3 = xxreg1[0..63]
xreg4 = OXM_OF_PKT_REG4
xxreg0 = NXM_NX_XXREG0
xxreg1 = NXM_NX_XXREG1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:110"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_11
#AT_START_12
at_fn_group_banner 12 'ovn.at:132' \
  "conntrack fields" "                               " 3
at_xfail=no
(
  printf "%s\n" "12. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:133: ovstest test-ovn dump-symtab | grep ^ct | sort"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn.at:133"
( $at_check_trace; ovstest test-ovn dump-symtab | grep ^ct | sort
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ct.dnat = ct_state[7]
ct.est = ct_state[1]
ct.inv = ct_state[4]
ct.new = ct_state[0]
ct.rel = ct_state[2]
ct.rpl = ct_state[3]
ct.snat = ct_state[6]
ct.trk = ct_state[5]
ct_label = NXM_NX_CT_LABEL
ct_label.acl_id = ct_label[80..95]
ct_label.ecmp_reply_eth = ct_label[32..79]
ct_label.label = ct_label[96..127]
ct_label.obs_point_id = ct_label[96..127]
ct_label.obs_unused = ct_label[0..95]
ct_mark = NXM_NX_CT_MARK
ct_mark.allow_established = ct_mark[6]
ct_mark.blocked = ct_mark[0]
ct_mark.ecmp_reply_port = ct_mark[16..31]
ct_mark.force_snat = ct_mark[3]
ct_mark.natted = ct_mark[1]
ct_mark.obs_collector_id = ct_mark[16..23]
ct_mark.obs_stage = ct_mark[4..5]
ct_mark.skip_snat = ct_mark[2]
ct_state = NXM_NX_CT_STATE
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:133"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_12
#AT_START_13
at_fn_group_banner 13 'ovn.at:161' \
  "composition" "                                    " 3
at_xfail=no
(
  printf "%s\n" "13. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:162: ovstest test-ovn composition 2"
at_fn_check_prepare_trace "ovn.at:162"
( $at_check_trace; ovstest test-ovn composition 2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:162"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_13
#AT_START_14
at_fn_group_banner 14 'ovn.at:165' \
  "expression parser" "                              " 3
at_xfail=no
(
  printf "%s\n" "14. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

cat >test-cases.txt <<'_ATEOF'

eth.type == 0x800
eth.type==0x800 => eth.type == 0x800
eth.type[0..15] == 0x800 => eth.type == 0x800

vlan.present
vlan.present == 1 => vlan.present
!(vlan.present == 0) => vlan.present
!(vlan.present != 1) => vlan.present
!vlan.present
vlan.present == 0 => !vlan.present
vlan.present != 1 => !vlan.present
!(vlan.present == 1) => !vlan.present
!(vlan.present != 0) => !vlan.present

eth.dst[0]
eth.dst[0] == 1 => eth.dst[0]
eth.dst[0] != 0 => eth.dst[0]
!(eth.dst[0] == 0) => eth.dst[0]
!(eth.dst[0] != 1) => eth.dst[0]

!eth.dst[0]
eth.dst[0] == 0 => !eth.dst[0]
eth.dst[0] != 1 => !eth.dst[0]
!(eth.dst[0] == 1) => !eth.dst[0]
!(eth.dst[0] != 0) => !eth.dst[0]

vlan.tci[12..15] == 0x3
vlan.tci == 0x3000/0xf000 => vlan.tci[12..15] == 0x3
vlan.tci[12..15] != 0x3
vlan.tci != 0x3000/0xf000 => vlan.tci[12..15] != 0x3

!vlan.pcp => vlan.pcp == 0
!(vlan.pcp) => vlan.pcp == 0
vlan.pcp == 0x4
vlan.pcp != 0x4
vlan.pcp > 0x4
vlan.pcp >= 0x4
vlan.pcp < 0x4
vlan.pcp <= 0x4
!(vlan.pcp != 0x4) => vlan.pcp == 0x4
!(vlan.pcp == 0x4) => vlan.pcp != 0x4
!(vlan.pcp <= 0x4) => vlan.pcp > 0x4
!(vlan.pcp < 0x4) => vlan.pcp >= 0x4
!(vlan.pcp >= 0x4) => vlan.pcp < 0x4
!(vlan.pcp > 0x4) => vlan.pcp <= 0x4
0x4 == vlan.pcp => vlan.pcp == 0x4
0x4 != vlan.pcp => vlan.pcp != 0x4
0x4 < vlan.pcp => vlan.pcp > 0x4
0x4 <= vlan.pcp => vlan.pcp >= 0x4
0x4 > vlan.pcp => vlan.pcp < 0x4
0x4 >= vlan.pcp => vlan.pcp <= 0x4
!(0x4 != vlan.pcp) => vlan.pcp == 0x4
!(0x4 == vlan.pcp) => vlan.pcp != 0x4
!(0x4 >= vlan.pcp) => vlan.pcp > 0x4
!(0x4 > vlan.pcp) => vlan.pcp >= 0x4
!(0x4 <= vlan.pcp) => vlan.pcp < 0x4
!(0x4 < vlan.pcp) => vlan.pcp <= 0x4

1 < vlan.pcp < 4 => vlan.pcp > 0x1 && vlan.pcp < 0x4
1 <= vlan.pcp <= 4 => vlan.pcp >= 0x1 && vlan.pcp <= 0x4
1 < vlan.pcp <= 4 => vlan.pcp > 0x1 && vlan.pcp <= 0x4
1 <= vlan.pcp < 4 => vlan.pcp >= 0x1 && vlan.pcp < 0x4
1 <= vlan.pcp <= 4 => vlan.pcp >= 0x1 && vlan.pcp <= 0x4
4 > vlan.pcp > 1 => vlan.pcp < 0x4 && vlan.pcp > 0x1
4 >= vlan.pcp > 1 => vlan.pcp <= 0x4 && vlan.pcp > 0x1
4 > vlan.pcp >= 1 => vlan.pcp < 0x4 && vlan.pcp >= 0x1
4 >= vlan.pcp >= 1 => vlan.pcp <= 0x4 && vlan.pcp >= 0x1
!(1 < vlan.pcp < 4) => vlan.pcp <= 0x1 || vlan.pcp >= 0x4
!(1 <= vlan.pcp <= 4) => vlan.pcp < 0x1 || vlan.pcp > 0x4
!(1 < vlan.pcp <= 4) => vlan.pcp <= 0x1 || vlan.pcp > 0x4
!(1 <= vlan.pcp < 4) => vlan.pcp < 0x1 || vlan.pcp >= 0x4
!(1 <= vlan.pcp <= 4) => vlan.pcp < 0x1 || vlan.pcp > 0x4
!(4 > vlan.pcp > 1) => vlan.pcp >= 0x4 || vlan.pcp <= 0x1
!(4 >= vlan.pcp > 1) => vlan.pcp > 0x4 || vlan.pcp <= 0x1
!(4 > vlan.pcp >= 1) => vlan.pcp >= 0x4 || vlan.pcp < 0x1
!(4 >= vlan.pcp >= 1) => vlan.pcp > 0x4 || vlan.pcp < 0x1

vlan.pcp == {1, 2, 3, 4} => vlan.pcp == 0x1 || vlan.pcp == 0x2 || vlan.pcp == 0x3 || vlan.pcp == 0x4
vlan.pcp == 1 || ((vlan.pcp == 2 || vlan.pcp == 3) || vlan.pcp == 4) => vlan.pcp == 0x1 || vlan.pcp == 0x2 || vlan.pcp == 0x3 || vlan.pcp == 0x4

vlan.pcp != {1, 2, 3, 4} => vlan.pcp != 0x1 && vlan.pcp != 0x2 && vlan.pcp != 0x3 && vlan.pcp != 0x4
vlan.pcp == 1 && ((vlan.pcp == 2 && vlan.pcp == 3) && vlan.pcp == 4) => vlan.pcp == 0x1 && vlan.pcp == 0x2 && vlan.pcp == 0x3 && vlan.pcp == 0x4

vlan.pcp == 1 && !((vlan.pcp == 2 && vlan.pcp == 3) && vlan.pcp == 4) => vlan.pcp == 0x1 && (vlan.pcp != 0x2 || vlan.pcp != 0x3 || vlan.pcp != 0x4)
vlan.pcp == 1 && (!(vlan.pcp == 2 && vlan.pcp == 3) && vlan.pcp == 4) => vlan.pcp == 0x1 && (vlan.pcp != 0x2 || vlan.pcp != 0x3) && vlan.pcp == 0x4
vlan.pcp == 1 && !(!(vlan.pcp == 2 && vlan.pcp == 3) && vlan.pcp == 4) => vlan.pcp == 0x1 && ((vlan.pcp == 0x2 && vlan.pcp == 0x3) || vlan.pcp != 0x4)

ip4.src == {10.0.0.0/8, 192.168.0.0/16, 172.16.20.0/24, 8.8.8.8} => ip4.src[24..31] == 0xa || ip4.src[16..31] == 0xc0a8 || ip4.src[8..31] == 0xac1014 || ip4.src == 0x8080808
ip6.src == ::1 => ip6.src == 0x1

ip4.src == 1.2.3.4 => ip4.src == 0x1020304
ip4.src == ::1.2.3.4/::ffff:ffff => ip4.src == 0x1020304
ip6.src == ::1 => ip6.src == 0x1

1
0
!1 => 0
!0 => 1

inport == "eth0"
!(inport != "eth0") => inport == "eth0"

(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((0))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))) => 0

ip4.src == "eth0" => Integer field ip4.src is not compatible with string constant.
inport == 1 => String field inport is not compatible with integer constant.
ip4.src = 1.2.3.4 => Syntax error at `=' expecting relational operator.

ip4.src > {1, 2, 3} => Only == and != operators may be used with value sets.
eth.type > 0x800 => Only == and != operators may be used with nominal field eth.type.
vlan.present > 0 => Only == and != operators may be used with Boolean field vlan.present.

inport != "eth0" => Nominal field inport may only be tested for equality (taking enclosing `!' operators into account).
!(inport == "eth0") => Nominal field inport may only be tested for equality (taking enclosing `!' operators into account).
eth.type != 0x800 => Nominal field eth.type may only be tested for equality (taking enclosing `!' operators into account).
!(eth.type == 0x800) => Nominal field eth.type may only be tested for equality (taking enclosing `!' operators into account).
inport = "eth0" => Syntax error at `=' expecting relational operator.

123 == 123 => Syntax error at `123' expecting field name.

$name => Syntax error at `$name' expecting address set name.
@name => Syntax error at `@name' expecting port group name.

123 == xyzzy => Syntax error at `xyzzy' expecting field name.
xyzzy == 1 => Syntax error at `xyzzy' expecting field name.

inport[1] == 1 => Cannot select subfield of string field inport.

eth.type[] == 1 => Syntax error at `]' expecting small integer.
eth.type[::1] == 1 => Syntax error at `::1' expecting small integer.
eth.type[18446744073709551615] == 1 => Syntax error at `18446744073709551615' expecting small integer.

eth.type[5!] => Syntax error at `!' expecting `]'.

eth.type[5..1] => Invalid bit range 5 to 1.

eth.type[12..16] => Cannot select bits 12 to 16 of 16-bit field eth.type.

eth.type[10] == 1 => Cannot select subfield of nominal field eth.type.

eth.type => Explicit `!= 0' is required for inequality test of multibit field against 0.

!(!(vlan.pcp)) => Explicit `!= 0' is required for inequality test of multibit field against 0.

123 => Syntax error at end of input expecting relational operator.

123 x => Syntax error at `x' expecting relational operator.

{1, "eth0"} => Syntax error at `"eth0"' expecting integer.

eth.type == xyzzy => Syntax error at `xyzzy' expecting constant.

(1 x) => Syntax error at `x' expecting `)'.

!0x800 != eth.type => Missing parentheses around operand of !.

eth.type == 0x800 || eth.type == 0x86dd && ip.proto == 17 => && and || must be parenthesized when used together.

eth.dst == {} => Syntax error at `}' expecting constant.

eth.src > 00:00:00:00:11:11/00:00:00:00:ff:ff => Only == and != operators may be used with masked constants.  Consider using subfields instead (e.g. eth.src[0..15] > 0x1111 in place of eth.src > 00:00:00:00:11:11/00:00:00:00:ff:ff).

ip4.src == ::1 => 128-bit constant is not compatible with 32-bit field ip4.src.

1 == eth.type == 2 => Range expressions must have the form `x < field < y' or `x > field > y', with each `<' optionally replaced by `<=' or `>' by `>=').

eth.dst[40] x => Syntax error at `x' expecting end of input.

ip4.src == {1.2.3.4, $set1, $unknownset} => Syntax error at `$unknownset' expecting address set name.
eth.src == {$set3, badmac, 00:00:00:00:00:01} => Syntax error at `badmac' expecting constant.

((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((())))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))) => Parentheses nested too deeply.

ct_label > $set4 => Only == and != operators may be used to compare a field against an empty value set.
_ATEOF

sed 's/ =>.*//' test-cases.txt > input.txt
sed 's/.* => //' test-cases.txt > expout
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:346: ovstest test-ovn parse-expr < input.txt"
at_fn_check_prepare_trace "ovn.at:346"
( $at_check_trace; ovstest test-ovn parse-expr < input.txt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:346"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_14
#AT_START_15
at_fn_group_banner 15 'ovn.at:349' \
  "expression annotation" "                          " 3
at_xfail=no
(
  printf "%s\n" "15. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

cat >test-cases.txt <<'_ATEOF'

ip4.src == 1.2.3.4 => ip4.src == 0x1020304 && eth.type == 0x800
ip4.src != 1.2.3.4 => ip4.src != 0x1020304 && eth.type == 0x800
ip.proto == 123 => ip.proto == 0x7b && (eth.type == 0x800 || eth.type == 0x86dd)
ip.proto == {123, 234} => (ip.proto == 0x7b || ip.proto == 0xea) && (eth.type == 0x800 || eth.type == 0x86dd)
ip4.src == 1.2.3.4 && ip4.dst == 5.6.7.8 => ip4.src == 0x1020304 && eth.type == 0x800 && ip4.dst == 0x5060708 && eth.type == 0x800

# Nested expressions over a single symbol should be annotated with symbol's
# prerequisites only once, at the top level.
tcp.dst == 1 || (tcp.dst >= 2 && tcp.dst <= 3) => (tcp.dst == 0x1 || (tcp.dst >= 0x2 && tcp.dst <= 0x3)) && ip.proto == 0x6 && (eth.type == 0x800 || eth.type == 0x86dd)

ip => eth.type == 0x800 || eth.type == 0x86dd
ip == 1 => eth.type == 0x800 || eth.type == 0x86dd
ip[0] == 1 => eth.type == 0x800 || eth.type == 0x86dd
ip > 0 => Only == and != operators may be used with nominal field ip.
!ip => Nominal predicate ip may only be tested positively, e.g. `ip' or `ip == 1' but not `!ip' or `ip == 0'.
ip == 0 => Nominal predicate ip may only be tested positively, e.g. `ip' or `ip == 1' but not `!ip' or `ip == 0'.

vlan.present => vlan.tci[12]
!vlan.present => !vlan.tci[12]

!vlan.pcp => vlan.tci[13..15] == 0 && vlan.tci[12]
vlan.pcp == 1 && vlan.vid == 2 => vlan.tci[13..15] == 0x1 && vlan.tci[12] && vlan.tci[0..11] == 0x2 && vlan.tci[12]
!reg0 && !reg1 && !reg2 && !reg3 => xxreg0[96..127] == 0 && xxreg0[64..95] == 0 && xxreg0[32..63] == 0 && xxreg0[0..31] == 0

ip.first_frag => ip.frag[0] && (eth.type == 0x800 || eth.type == 0x86dd) && (!ip.frag[1] || (eth.type != 0x800 && eth.type != 0x86dd))
!ip.first_frag => !ip.frag[0] || (eth.type != 0x800 && eth.type != 0x86dd) || (ip.frag[1] && (eth.type == 0x800 || eth.type == 0x86dd))
ip.later_frag => ip.frag[1] && (eth.type == 0x800 || eth.type == 0x86dd)

bad_prereq != 0 => Error parsing expression `xyzzy' encountered as prerequisite or predicate of initial expression: Syntax error at `xyzzy' expecting field name.
self_recurse != 0 => Error parsing expression `self_recurse != 0' encountered as prerequisite or predicate of initial expression: Recursive expansion of symbol `self_recurse'.
mutual_recurse_1 != 0 => Error parsing expression `mutual_recurse_2 != 0' encountered as prerequisite or predicate of initial expression: Error parsing expression `mutual_recurse_1 != 0' encountered as prerequisite or predicate of initial expression: Recursive expansion of symbol `mutual_recurse_1'.
mutual_recurse_2 != 0 => Error parsing expression `mutual_recurse_1 != 0' encountered as prerequisite or predicate of initial expression: Error parsing expression `mutual_recurse_2 != 0' encountered as prerequisite or predicate of initial expression: Recursive expansion of symbol `mutual_recurse_2'.
_ATEOF

sed 's/ =>.*//' test-cases.txt > input.txt
sed 's/.* => //' test-cases.txt > expout
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:388: ovstest test-ovn annotate-expr < input.txt"
at_fn_check_prepare_trace "ovn.at:388"
( $at_check_trace; ovstest test-ovn annotate-expr < input.txt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:388"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_15
#AT_START_16
at_fn_group_banner 16 'ovn.at:391' \
  "1-term expression conversion" "                   " 3
at_xfail=no
(
  printf "%s\n" "16. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:392: ovstest test-ovn exhaustive --operation=convert 1"
at_fn_check_prepare_trace "ovn.at:392"
( $at_check_trace; ovstest test-ovn exhaustive --operation=convert 1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested converting all 1-terminal expressions with 2 numeric vars (each 3 bits) in terms of operators == != < <= > >= and 2 string vars.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:392"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_16
#AT_START_17
at_fn_group_banner 17 'ovn.at:397' \
  "2-term expression conversion" "                   " 3
at_xfail=no
(
  printf "%s\n" "17. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:398: ovstest test-ovn exhaustive --operation=convert 2"
at_fn_check_prepare_trace "ovn.at:398"
( $at_check_trace; ovstest test-ovn exhaustive --operation=convert 2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested converting 578 expressions of 2 terminals with 2 numeric vars (each 3 bits) in terms of operators == != < <= > >= and 2 string vars.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:398"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_17
#AT_START_18
at_fn_group_banner 18 'ovn.at:403' \
  "3-term expression conversion" "                   " 3
at_xfail=no
(
  printf "%s\n" "18. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:404: ovstest test-ovn exhaustive --operation=convert --bits=2 3"
at_fn_check_prepare_trace "ovn.at:404"
( $at_check_trace; ovstest test-ovn exhaustive --operation=convert --bits=2 3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested converting 67410 expressions of 3 terminals with 2 numeric vars (each 2 bits) in terms of operators == != < <= > >= and 2 string vars.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:404"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_18
#AT_START_19
at_fn_group_banner 19 'ovn.at:409' \
  "3-term numeric expression simplification" "       " 3
at_xfail=no
(
  printf "%s\n" "19. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:411: ovstest test-ovn exhaustive --operation=simplify --nvars=2 --svars=0 3"
at_fn_check_prepare_trace "ovn.at:411"
( $at_check_trace; ovstest test-ovn exhaustive --operation=simplify --nvars=2 --svars=0 3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested simplifying 490770 expressions of 3 terminals with 2 numeric vars (each 3 bits) in terms of operators == != < <= > >=.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:411"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_19
#AT_START_20
at_fn_group_banner 20 'ovn.at:416' \
  "4-term string expression simplification" "        " 3
at_xfail=no
(
  printf "%s\n" "20. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:417: ovstest test-ovn exhaustive --operation=simplify --nvars=0 --svars=4 4"
at_fn_check_prepare_trace "ovn.at:417"
( $at_check_trace; ovstest test-ovn exhaustive --operation=simplify --nvars=0 --svars=4 4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested simplifying 21978 expressions of 4 terminals with 4 string vars.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:417"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_20
#AT_START_21
at_fn_group_banner 21 'ovn.at:422' \
  "3-term mixed expression simplification" "         " 3
at_xfail=no
(
  printf "%s\n" "21. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:423: ovstest test-ovn exhaustive --operation=simplify --nvars=1 --svars=1 3"
at_fn_check_prepare_trace "ovn.at:423"
( $at_check_trace; ovstest test-ovn exhaustive --operation=simplify --nvars=1 --svars=1 3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested simplifying 127890 expressions of 3 terminals with 1 numeric vars (each 3 bits) in terms of operators == != < <= > >= and 1 string vars.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:423"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_21
#AT_START_22
at_fn_group_banner 22 'ovn.at:428' \
  "simplification special cases" "                   " 3
at_xfail=no
(
  printf "%s\n" "22. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

simplify() {
    echo "$1" | ovstest test-ovn simplify-expr
}
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:432: simplify 'eth.dst == 0/0'"
at_fn_check_prepare_trace "ovn.at:432"
( $at_check_trace; simplify 'eth.dst == 0/0'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:432"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:434: simplify 'eth.dst != 0/0'"
at_fn_check_prepare_trace "ovn.at:434"
( $at_check_trace; simplify 'eth.dst != 0/0'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:434"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:436: simplify 'tcp.dst >= 0'"
at_fn_check_prepare_trace "ovn.at:436"
( $at_check_trace; simplify 'tcp.dst >= 0'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip.proto == 0x6 && (eth.type == 0x800 || eth.type == 0x86dd)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:439: simplify 'tcp.dst <= 65535'"
at_fn_check_prepare_trace "ovn.at:439"
( $at_check_trace; simplify 'tcp.dst <= 65535'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip.proto == 0x6 && (eth.type == 0x800 || eth.type == 0x86dd)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:439"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:442: simplify 'tcp.dst > 0'"
at_fn_check_prepare_trace "ovn.at:442"
( $at_check_trace; simplify 'tcp.dst > 0'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "(tcp.dst[0] || tcp.dst[1] || tcp.dst[2] || tcp.dst[3] || tcp.dst[4] || tcp.dst[5] || tcp.dst[6] || tcp.dst[7] || tcp.dst[8] || tcp.dst[9] || tcp.dst[10] || tcp.dst[11] || tcp.dst[12] || tcp.dst[13] || tcp.dst[14] || tcp.dst[15]) && ip.proto == 0x6 && (eth.type == 0x800 || eth.type == 0x86dd)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:442"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:445: simplify 'tcp.dst < 65535'"
at_fn_check_prepare_trace "ovn.at:445"
( $at_check_trace; simplify 'tcp.dst < 65535'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "(!tcp.dst[0] || !tcp.dst[1] || !tcp.dst[2] || !tcp.dst[3] || !tcp.dst[4] || !tcp.dst[5] || !tcp.dst[6] || !tcp.dst[7] || !tcp.dst[8] || !tcp.dst[9] || !tcp.dst[10] || !tcp.dst[11] || !tcp.dst[12] || !tcp.dst[13] || !tcp.dst[14] || !tcp.dst[15]) && ip.proto == 0x6 && (eth.type == 0x800 || eth.type == 0x86dd)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:445"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_22
#AT_START_23
at_fn_group_banner 23 'ovn.at:450' \
  "is_chassis_resident simplification" "             " 3
at_xfail=no
(
  printf "%s\n" "23. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

simplify() {
    echo "$1" | ovstest test-ovn simplify-expr
}
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:454: simplify 'is_chassis_resident(\"eth1\")'"
at_fn_check_prepare_trace "ovn.at:454"
( $at_check_trace; simplify 'is_chassis_resident("eth1")'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:454"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:456: simplify 'is_chassis_resident(\"eth2\")'"
at_fn_check_prepare_trace "ovn.at:456"
( $at_check_trace; simplify 'is_chassis_resident("eth2")'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:456"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:458: simplify '!is_chassis_resident(\"eth1\")'"
at_fn_check_prepare_trace "ovn.at:458"
( $at_check_trace; simplify '!is_chassis_resident("eth1")'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:458"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:460: simplify '!is_chassis_resident(\"eth2\")'"
at_fn_check_prepare_trace "ovn.at:460"
( $at_check_trace; simplify '!is_chassis_resident("eth2")'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:460"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_23
#AT_START_24
at_fn_group_banner 24 'ovn.at:464' \
  "4-term numeric expression normalization" "        " 3
at_xfail=no
(
  printf "%s\n" "24. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:466: ovstest test-ovn exhaustive --operation=normalize --nvars=3 --svars=0 --bits=1 4"
at_fn_check_prepare_trace "ovn.at:466"
( $at_check_trace; ovstest test-ovn exhaustive --operation=normalize --nvars=3 --svars=0 --bits=1 4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested normalizing 1874026 expressions of 4 terminals with 3 numeric vars (each 1 bits) in terms of operators == != < <= > >=.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:466"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_24
#AT_START_25
at_fn_group_banner 25 'ovn.at:471' \
  "4-term string expression normalization" "         " 3
at_xfail=no
(
  printf "%s\n" "25. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:472: ovstest test-ovn exhaustive --operation=normalize --nvars=0 --svars=3 --bits=1 4"
at_fn_check_prepare_trace "ovn.at:472"
( $at_check_trace; ovstest test-ovn exhaustive --operation=normalize --nvars=0 --svars=3 --bits=1 4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested normalizing 11242 expressions of 4 terminals with 3 string vars.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:472"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_25
#AT_START_26
at_fn_group_banner 26 'ovn.at:477' \
  "4-term mixed expression normalization" "          " 3
at_xfail=no
(
  printf "%s\n" "26. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:478: ovstest test-ovn exhaustive --operation=normalize --nvars=1 --bits=1 --svars=2 4"
at_fn_check_prepare_trace "ovn.at:478"
( $at_check_trace; ovstest test-ovn exhaustive --operation=normalize --nvars=1 --bits=1 --svars=2 4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested normalizing 175978 expressions of 4 terminals with 1 numeric vars (each 1 bits) in terms of operators == != < <= > >= and 2 string vars.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:478"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_26
#AT_START_27
at_fn_group_banner 27 'ovn.at:483' \
  "5-term numeric expression normalization" "        " 3
at_xfail=no
(
  printf "%s\n" "27. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:485: ovstest test-ovn exhaustive --operation=normalize --nvars=3 --svars=0 --bits=1 --relops='==' 5"
at_fn_check_prepare_trace "ovn.at:485"
( $at_check_trace; ovstest test-ovn exhaustive --operation=normalize --nvars=3 --svars=0 --bits=1 --relops='==' 5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested normalizing 1317600 expressions of 5 terminals with 3 numeric vars (each 1 bits) in terms of operators ==.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:485"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_27
#AT_START_28
at_fn_group_banner 28 'ovn.at:490' \
  "5-term string expression normalization" "         " 3
at_xfail=no
(
  printf "%s\n" "28. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:491: ovstest test-ovn exhaustive --operation=normalize --nvars=0 --svars=3 --bits=1 --relops='==' 5"
at_fn_check_prepare_trace "ovn.at:491"
( $at_check_trace; ovstest test-ovn exhaustive --operation=normalize --nvars=0 --svars=3 --bits=1 --relops='==' 5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested normalizing 368550 expressions of 5 terminals with 3 string vars.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:491"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_28
#AT_START_29
at_fn_group_banner 29 'ovn.at:496' \
  "5-term mixed expression normalization" "          " 3
at_xfail=no
(
  printf "%s\n" "29. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:497: ovstest test-ovn exhaustive --operation=normalize --nvars=1 --svars=1 --bits=1 --relops='==' 5"
at_fn_check_prepare_trace "ovn.at:497"
( $at_check_trace; ovstest test-ovn exhaustive --operation=normalize --nvars=1 --svars=1 --bits=1 --relops='==' 5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested normalizing 216000 expressions of 5 terminals with 1 numeric vars (each 1 bits) in terms of operators == and 1 string vars.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:497"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_29
#AT_START_30
at_fn_group_banner 30 'ovn.at:502' \
  "4-term numeric expressions to flows" "            " 3
at_xfail=no
(
  printf "%s\n" "30. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:504: ovstest test-ovn exhaustive --operation=flow --nvars=2 --svars=0 --bits=2 --relops='==' 4"
at_fn_check_prepare_trace "ovn.at:504"
( $at_check_trace; ovstest test-ovn exhaustive --operation=flow --nvars=2 --svars=0 --bits=2 --relops='==' 4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested converting to flows 175978 expressions of 4 terminals with 2 numeric vars (each 2 bits) in terms of operators ==.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:504"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_30
#AT_START_31
at_fn_group_banner 31 'ovn.at:509' \
  "4-term string expressions to flows" "             " 3
at_xfail=no
(
  printf "%s\n" "31. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:511: ovstest test-ovn exhaustive --operation=flow --nvars=0 --svars=4 4"
at_fn_check_prepare_trace "ovn.at:511"
( $at_check_trace; ovstest test-ovn exhaustive --operation=flow --nvars=0 --svars=4 4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested converting to flows 21978 expressions of 4 terminals with 4 string vars.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:511"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_31
#AT_START_32
at_fn_group_banner 32 'ovn.at:516' \
  "4-term mixed expressions to flows" "              " 3
at_xfail=no
(
  printf "%s\n" "32. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init



{ set +x
printf "%s\n" "$at_srcdir/ovn.at:519: ovstest test-ovn exhaustive --operation=flow --nvars=1 --bits=2 --svars=1 --relops='==' 4"
at_fn_check_prepare_trace "ovn.at:519"
( $at_check_trace; ovstest test-ovn exhaustive --operation=flow --nvars=1 --bits=2 --svars=1 --relops='==' 4
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested converting to flows 48312 expressions of 4 terminals with 1 numeric vars (each 2 bits) in terms of operators == and 1 string vars.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:519"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_32
#AT_START_33
at_fn_group_banner 33 'ovn.at:524' \
  "3-term numeric expressions to flows" "            " 3
at_xfail=no
(
  printf "%s\n" "33. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:526: ovstest test-ovn exhaustive --operation=flow --nvars=3 --svars=0 --bits=3 --relops='==' 3"
at_fn_check_prepare_trace "ovn.at:526"
( $at_check_trace; ovstest test-ovn exhaustive --operation=flow --nvars=3 --svars=0 --bits=3 --relops='==' 3
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Tested converting to flows 41328 expressions of 3 terminals with 3 numeric vars (each 3 bits) in terms of operators ==.
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:526"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_33
#AT_START_34
at_fn_group_banner 34 'ovn.at:531' \
  "converting expressions to flows -- string fields" "" 3
at_xfail=no
(
  printf "%s\n" "34. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


expr_to_flow () {
    echo "$1" | ovstest test-ovn expr-to-flows | sort
}
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:536: expr_to_flow 'inport == \"eth0\"'"
at_fn_check_prepare_trace "ovn.at:536"
( $at_check_trace; expr_to_flow 'inport == "eth0"'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "reg14=0x5
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:536"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:538: expr_to_flow 'inport == \"eth1\"'"
at_fn_check_prepare_trace "ovn.at:538"
( $at_check_trace; expr_to_flow 'inport == "eth1"'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "reg14=0x6
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:538"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:540: expr_to_flow 'inport == \"eth2\"'"
at_fn_check_prepare_trace "ovn.at:540"
( $at_check_trace; expr_to_flow 'inport == "eth2"'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "(no flows)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:540"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:542: expr_to_flow 'inport == \"eth0\" && ip'"
at_fn_check_prepare_trace "ovn.at:542"
( $at_check_trace; expr_to_flow 'inport == "eth0" && ip'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,reg14=0x5
ipv6,reg14=0x5
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:542"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:546: expr_to_flow 'inport == \"eth1\" && ip'"
at_fn_check_prepare_trace "ovn.at:546"
( $at_check_trace; expr_to_flow 'inport == "eth1" && ip'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,reg14=0x6
ipv6,reg14=0x6
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:546"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:550: expr_to_flow 'inport == \"eth2\" && ip'"
at_fn_check_prepare_trace "ovn.at:550"
( $at_check_trace; expr_to_flow 'inport == "eth2" && ip'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "(no flows)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:550"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:552: expr_to_flow 'inport == {\"eth0\", \"eth1\", \"eth2\", \"LOCAL\"}'"
at_fn_check_prepare_trace "ovn.at:552"
( $at_check_trace; expr_to_flow 'inport == {"eth0", "eth1", "eth2", "LOCAL"}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "reg14=0x5
reg14=0x6
reg14=0xfffe
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:552"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:557: expr_to_flow 'inport == {\"eth0\", \"eth1\", \"eth2\"} && ip'"
at_fn_check_prepare_trace "ovn.at:557"
( $at_check_trace; expr_to_flow 'inport == {"eth0", "eth1", "eth2"} && ip'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,reg14=0x5
ip,reg14=0x6
ipv6,reg14=0x5
ipv6,reg14=0x6
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:557"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:563: expr_to_flow 'inport == \"eth0\" && inport == \"eth1\"'"
at_fn_check_prepare_trace "ovn.at:563"
( $at_check_trace; expr_to_flow 'inport == "eth0" && inport == "eth1"'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "(no flows)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:563"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_34
#AT_START_35
at_fn_group_banner 35 'ovn.at:568' \
  "converting expressions to flows -- address sets" "" 3
at_xfail=no
(
  printf "%s\n" "35. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


expr_to_flow () {
    echo "$1" | ovstest test-ovn expr-to-flows | sort
}
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:573: expr_to_flow 'ip4.src == {10.0.0.1, 10.0.0.2, 10.0.0.3}'"
at_fn_check_prepare_trace "ovn.at:573"
( $at_check_trace; expr_to_flow 'ip4.src == {10.0.0.1, 10.0.0.2, 10.0.0.3}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,nw_src=10.0.0.1
ip,nw_src=10.0.0.2
ip,nw_src=10.0.0.3
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:573"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:578: expr_to_flow 'ip4.src == \$set1'"
at_fn_check_prepare_dynamic "expr_to_flow 'ip4.src == $set1'" "ovn.at:578"
( $at_check_trace; expr_to_flow 'ip4.src == $set1'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,nw_src=10.0.0.1
ip,nw_src=10.0.0.2
ip,nw_src=10.0.0.3
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:578"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:583: expr_to_flow 'ip4.src == {1.2.3.4, \$set1}'"
at_fn_check_prepare_dynamic "expr_to_flow 'ip4.src == {1.2.3.4, $set1}'" "ovn.at:583"
( $at_check_trace; expr_to_flow 'ip4.src == {1.2.3.4, $set1}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,nw_src=1.2.3.4
ip,nw_src=10.0.0.1
ip,nw_src=10.0.0.2
ip,nw_src=10.0.0.3
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:583"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:589: expr_to_flow 'ip4.src == {1.2.0.0/20, 5.5.5.0/24, \$set1}'"
at_fn_check_prepare_dynamic "expr_to_flow 'ip4.src == {1.2.0.0/20, 5.5.5.0/24, $set1}'" "ovn.at:589"
( $at_check_trace; expr_to_flow 'ip4.src == {1.2.0.0/20, 5.5.5.0/24, $set1}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,nw_src=1.2.0.0/20
ip,nw_src=10.0.0.1
ip,nw_src=10.0.0.2
ip,nw_src=10.0.0.3
ip,nw_src=5.5.5.0/24
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:589"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:596: expr_to_flow 'ip6.src == {::1, ::2, ::3}'"
at_fn_check_prepare_trace "ovn.at:596"
( $at_check_trace; expr_to_flow 'ip6.src == {::1, ::2, ::3}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ipv6,ipv6_src=::1
ipv6,ipv6_src=::2
ipv6,ipv6_src=::3
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:596"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:601: expr_to_flow 'ip6.src == {::1, \$set2, ::4}'"
at_fn_check_prepare_dynamic "expr_to_flow 'ip6.src == {::1, $set2, ::4}'" "ovn.at:601"
( $at_check_trace; expr_to_flow 'ip6.src == {::1, $set2, ::4}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ipv6,ipv6_src=::1
ipv6,ipv6_src=::2
ipv6,ipv6_src=::3
ipv6,ipv6_src=::4
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:601"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:607: expr_to_flow 'eth.src == {00:00:00:00:00:01, 00:00:00:00:00:02, 00:00:00:00:00:03}'"
at_fn_check_prepare_trace "ovn.at:607"
( $at_check_trace; expr_to_flow 'eth.src == {00:00:00:00:00:01, 00:00:00:00:00:02, 00:00:00:00:00:03}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "dl_src=00:00:00:00:00:01
dl_src=00:00:00:00:00:02
dl_src=00:00:00:00:00:03
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:607"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:612: expr_to_flow 'eth.src == {\$set3}'"
at_fn_check_prepare_dynamic "expr_to_flow 'eth.src == {$set3}'" "ovn.at:612"
( $at_check_trace; expr_to_flow 'eth.src == {$set3}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "dl_src=00:00:00:00:00:01
dl_src=00:00:00:00:00:02
dl_src=00:00:00:00:00:03
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:612"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:617: expr_to_flow 'eth.src == {00:00:00:00:00:01, \$set3, ba:be:be:ef:de:ad, \$set3}'"
at_fn_check_prepare_dynamic "expr_to_flow 'eth.src == {00:00:00:00:00:01, $set3, ba:be:be:ef:de:ad, $set3}'" "ovn.at:617"
( $at_check_trace; expr_to_flow 'eth.src == {00:00:00:00:00:01, $set3, ba:be:be:ef:de:ad, $set3}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "dl_src=00:00:00:00:00:01
dl_src=00:00:00:00:00:02
dl_src=00:00:00:00:00:03
dl_src=ba:be:be:ef:de:ad
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:617"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:623: expr_to_flow 'ip4.src == {\$set4}'"
at_fn_check_prepare_dynamic "expr_to_flow 'ip4.src == {$set4}'" "ovn.at:623"
( $at_check_trace; expr_to_flow 'ip4.src == {$set4}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "(no flows)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:623"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:626: expr_to_flow 'ip4.src == {1.2.3.4, \$set4}'"
at_fn_check_prepare_dynamic "expr_to_flow 'ip4.src == {1.2.3.4, $set4}'" "ovn.at:626"
( $at_check_trace; expr_to_flow 'ip4.src == {1.2.3.4, $set4}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,nw_src=1.2.3.4
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:626"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:629: expr_to_flow 'ip4.src == 1.2.3.4 || ip4.src == {\$set4}'"
at_fn_check_prepare_dynamic "expr_to_flow 'ip4.src == 1.2.3.4 || ip4.src == {$set4}'" "ovn.at:629"
( $at_check_trace; expr_to_flow 'ip4.src == 1.2.3.4 || ip4.src == {$set4}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,nw_src=1.2.3.4
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:629"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:632: expr_to_flow 'ip4.src != {\$set4}'"
at_fn_check_prepare_dynamic "expr_to_flow 'ip4.src != {$set4}'" "ovn.at:632"
( $at_check_trace; expr_to_flow 'ip4.src != {$set4}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:632"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:635: expr_to_flow 'ip4.src != {1.0.0.0/8, \$set4}'"
at_fn_check_prepare_dynamic "expr_to_flow 'ip4.src != {1.0.0.0/8, $set4}'" "ovn.at:635"
( $at_check_trace; expr_to_flow 'ip4.src != {1.0.0.0/8, $set4}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,nw_src=0.0.0.0/1.0.0.0
ip,nw_src=128.0.0.0/1
ip,nw_src=16.0.0.0/16.0.0.0
ip,nw_src=2.0.0.0/2.0.0.0
ip,nw_src=32.0.0.0/32.0.0.0
ip,nw_src=4.0.0.0/4.0.0.0
ip,nw_src=64.0.0.0/64.0.0.0
ip,nw_src=8.0.0.0/8.0.0.0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:635"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:645: expr_to_flow 'ip4.src != 1.0.0.0/8 && ip4.src != {\$set4}'"
at_fn_check_prepare_dynamic "expr_to_flow 'ip4.src != 1.0.0.0/8 && ip4.src != {$set4}'" "ovn.at:645"
( $at_check_trace; expr_to_flow 'ip4.src != 1.0.0.0/8 && ip4.src != {$set4}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,nw_src=0.0.0.0/1.0.0.0
ip,nw_src=128.0.0.0/1
ip,nw_src=16.0.0.0/16.0.0.0
ip,nw_src=2.0.0.0/2.0.0.0
ip,nw_src=32.0.0.0/32.0.0.0
ip,nw_src=4.0.0.0/4.0.0.0
ip,nw_src=64.0.0.0/64.0.0.0
ip,nw_src=8.0.0.0/8.0.0.0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:645"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:655: expr_to_flow 'ip4.dst == 172.27.0.65 && ip4.src == \$set1 && ip4.dst != 10.128.0.0/14'"
at_fn_check_prepare_dynamic "expr_to_flow 'ip4.dst == 172.27.0.65 && ip4.src == $set1 && ip4.dst != 10.128.0.0/14'" "ovn.at:655"
( $at_check_trace; expr_to_flow 'ip4.dst == 172.27.0.65 && ip4.src == $set1 && ip4.dst != 10.128.0.0/14'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,nw_src=10.0.0.1,nw_dst=172.27.0.65
ip,nw_src=10.0.0.2,nw_dst=172.27.0.65
ip,nw_src=10.0.0.3,nw_dst=172.27.0.65
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:655"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:660: expr_to_flow 'ip4.src == 172.168.13.0/16 && ip4.src != {172.168.13.0/24, 172.168.14.0/24}'"
at_fn_check_prepare_trace "ovn.at:660"
( $at_check_trace; expr_to_flow 'ip4.src == 172.168.13.0/16 && ip4.src != {172.168.13.0/24, 172.168.14.0/24}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ip,nw_src=172.168.0.0/255.255.3.0
ip,nw_src=172.168.0.0/255.255.4.0
ip,nw_src=172.168.0.0/255.255.8.0
ip,nw_src=172.168.128.0/17
ip,nw_src=172.168.16.0/255.255.16.0
ip,nw_src=172.168.3.0/255.255.3.0
ip,nw_src=172.168.32.0/255.255.32.0
ip,nw_src=172.168.64.0/255.255.64.0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:660"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:671: test \$(expr_to_flow 'ip4.src != {172.168.13.0/24, 172.168.14.0/24, 172.168.15.0/24}' | wc -l) -le 30"
at_fn_check_prepare_notrace 'a $(...) command substitution' "ovn.at:671"
( $at_check_trace; test $(expr_to_flow 'ip4.src != {172.168.13.0/24, 172.168.14.0/24, 172.168.15.0/24}' | wc -l) -le 30
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:671"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_35
#AT_START_36
at_fn_group_banner 36 'ovn.at:674' \
  "converting expressions to flows -- port groups" " " 3
at_xfail=no
(
  printf "%s\n" "36. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


expr_to_flow () {
    echo "$1" | ovstest test-ovn expr-to-flows | sort
}
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:679: expr_to_flow 'outport == @pg1'"
at_fn_check_prepare_trace "ovn.at:679"
( $at_check_trace; expr_to_flow 'outport == @pg1'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "reg15=0x11
reg15=0x12
reg15=0x13
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:679"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:684: expr_to_flow 'outport == {@pg_empty}'"
at_fn_check_prepare_trace "ovn.at:684"
( $at_check_trace; expr_to_flow 'outport == {@pg_empty}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "(no flows)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:684"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:687: expr_to_flow 'outport == {\"lsp1\", @pg_empty}'"
at_fn_check_prepare_trace "ovn.at:687"
( $at_check_trace; expr_to_flow 'outport == {"lsp1", @pg_empty}'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "reg15=0x11
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:687"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_36
#AT_START_37
at_fn_group_banner 37 'ovn.at:692' \
  "converting expressions to flows -- conjunction" " " 3
at_xfail=no
(
  printf "%s\n" "37. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


expr_to_flow () {
    echo "$1" | ovstest test-ovn expr-to-flows | sort
}

lflow="ip4.src == {10.0.0.1, 10.0.0.2, 10.0.0.3} && \
ip4.dst == {20.0.0.1, 20.0.0.2, 20.0.0.3}"
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:700: expr_to_flow \"\$lflow\""
at_fn_check_prepare_dynamic "expr_to_flow \"$lflow\"" "ovn.at:700"
( $at_check_trace; expr_to_flow "$lflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "conj_id=1,ip
ip,nw_dst=20.0.0.1: conjunction(1, 0/2)
ip,nw_dst=20.0.0.2: conjunction(1, 0/2)
ip,nw_dst=20.0.0.3: conjunction(1, 0/2)
ip,nw_src=10.0.0.1: conjunction(1, 1/2)
ip,nw_src=10.0.0.2: conjunction(1, 1/2)
ip,nw_src=10.0.0.3: conjunction(1, 1/2)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:700"
$at_failed && at_fn_log_failure
$at_traceon; }


lflow="ip && (!ct.est || (ct.est && ct_mark.blocked == 1))"
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:711: expr_to_flow \"\$lflow\""
at_fn_check_prepare_dynamic "expr_to_flow \"$lflow\"" "ovn.at:711"
( $at_check_trace; expr_to_flow "$lflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "ct_state=+est+trk,ct_mark=0x1/0x1,ip
ct_state=+est+trk,ct_mark=0x1/0x1,ipv6
ct_state=-est+trk,ip
ct_state=-est+trk,ipv6
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:711"
$at_failed && at_fn_log_failure
$at_traceon; }


lflow="ip4.src == {10.0.0.1, 10.0.0.2, 10.0.0.3} && \
ip4.dst == {20.0.0.1, 20.0.0.2}"
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:720: expr_to_flow \"\$lflow\""
at_fn_check_prepare_dynamic "expr_to_flow \"$lflow\"" "ovn.at:720"
( $at_check_trace; expr_to_flow "$lflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "conj_id=1,ip
ip,nw_dst=20.0.0.1: conjunction(1, 0/2)
ip,nw_dst=20.0.0.2: conjunction(1, 0/2)
ip,nw_src=10.0.0.1: conjunction(1, 1/2)
ip,nw_src=10.0.0.2: conjunction(1, 1/2)
ip,nw_src=10.0.0.3: conjunction(1, 1/2)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:720"
$at_failed && at_fn_log_failure
$at_traceon; }


lflow="ip4 && ip4.src == {10.0.0.1, 10.0.0.2, 10.0.0.3} && \
ip4.dst == {20.0.0.1, 20.0.0.2, 20.0.0.3} && \
tcp.dst >= 1000 && tcp.dst <= 1010"

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:733: expr_to_flow \"\$lflow\""
at_fn_check_prepare_dynamic "expr_to_flow \"$lflow\"" "ovn.at:733"
( $at_check_trace; expr_to_flow "$lflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "conj_id=1,tcp
tcp,nw_dst=20.0.0.1: conjunction(1, 0/3)
tcp,nw_dst=20.0.0.2: conjunction(1, 0/3)
tcp,nw_dst=20.0.0.3: conjunction(1, 0/3)
tcp,nw_src=10.0.0.1: conjunction(1, 1/3)
tcp,nw_src=10.0.0.2: conjunction(1, 1/3)
tcp,nw_src=10.0.0.3: conjunction(1, 1/3)
tcp,tp_dst=0x3ea/0xfffe: conjunction(1, 2/3)
tcp,tp_dst=0x3ec/0xfffc: conjunction(1, 2/3)
tcp,tp_dst=0x3f0/0xfffe: conjunction(1, 2/3)
tcp,tp_dst=1000: conjunction(1, 2/3)
tcp,tp_dst=1001: conjunction(1, 2/3)
tcp,tp_dst=1010: conjunction(1, 2/3)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:733"
$at_failed && at_fn_log_failure
$at_traceon; }


lflow="ip4 && ip4.src == {10.0.0.4, 10.0.0.5, 10.0.0.6} && \
((ip4.dst == {20.0.0.4, 20.0.0.7, 20.0.0.8} && tcp.dst >= 1000 && \
tcp.dst <= 2000 && tcp.src >=1000 && tcp.src <= 2000) \
|| ip4.dst == 20.0.0.5 || ip4.dst == 20.0.0.6)"

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:754: expr_to_flow \"\$lflow\""
at_fn_check_prepare_dynamic "expr_to_flow \"$lflow\"" "ovn.at:754"
( $at_check_trace; expr_to_flow "$lflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "conj_id=1,tcp
ip,nw_src=10.0.0.4,nw_dst=20.0.0.5
ip,nw_src=10.0.0.4,nw_dst=20.0.0.6
ip,nw_src=10.0.0.5,nw_dst=20.0.0.5
ip,nw_src=10.0.0.5,nw_dst=20.0.0.6
ip,nw_src=10.0.0.6,nw_dst=20.0.0.5
ip,nw_src=10.0.0.6,nw_dst=20.0.0.6
tcp,nw_dst=20.0.0.4: conjunction(1, 0/4)
tcp,nw_dst=20.0.0.7: conjunction(1, 0/4)
tcp,nw_dst=20.0.0.8: conjunction(1, 0/4)
tcp,nw_src=10.0.0.4: conjunction(1, 1/4)
tcp,nw_src=10.0.0.5: conjunction(1, 1/4)
tcp,nw_src=10.0.0.6: conjunction(1, 1/4)
tcp,tp_dst=0x3ea/0xfffe: conjunction(1, 2/4)
tcp,tp_dst=0x3ec/0xfffc: conjunction(1, 2/4)
tcp,tp_dst=0x3f0/0xfff0: conjunction(1, 2/4)
tcp,tp_dst=0x400/0xfe00: conjunction(1, 2/4)
tcp,tp_dst=0x600/0xff00: conjunction(1, 2/4)
tcp,tp_dst=0x700/0xff80: conjunction(1, 2/4)
tcp,tp_dst=0x780/0xffc0: conjunction(1, 2/4)
tcp,tp_dst=0x7c0/0xfff0: conjunction(1, 2/4)
tcp,tp_dst=1000: conjunction(1, 2/4)
tcp,tp_dst=1001: conjunction(1, 2/4)
tcp,tp_dst=2000: conjunction(1, 2/4)
tcp,tp_src=0x3ea/0xfffe: conjunction(1, 3/4)
tcp,tp_src=0x3ec/0xfffc: conjunction(1, 3/4)
tcp,tp_src=0x3f0/0xfff0: conjunction(1, 3/4)
tcp,tp_src=0x400/0xfe00: conjunction(1, 3/4)
tcp,tp_src=0x600/0xff00: conjunction(1, 3/4)
tcp,tp_src=0x700/0xff80: conjunction(1, 3/4)
tcp,tp_src=0x780/0xffc0: conjunction(1, 3/4)
tcp,tp_src=0x7c0/0xfff0: conjunction(1, 3/4)
tcp,tp_src=1000: conjunction(1, 3/4)
tcp,tp_src=1001: conjunction(1, 3/4)
tcp,tp_src=2000: conjunction(1, 3/4)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:754"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_37
#AT_START_38
at_fn_group_banner 38 'ovn.at:793' \
  "action parsing" "                                 " 3
at_xfail=no
(
  printf "%s\n" "38. $at_setup_line: testing $at_desc ..."
  $at_traceon

ovs_init


# lflow table hard-coded to 10 in test-ovn, so next is 11.







cat >test-cases.txt <<'_ATEOF'

# drop
drop;
    encodes as drop
drop; next;
    Syntax error at `next' expecting end of input.
next; drop;
    Syntax error at `drop' expecting action.

# output
output;
    encodes as resubmit(,64)

# next
next;
    encodes as resubmit(,19)
next(11);
    formats as next;
    encodes as resubmit(,19)
next(0);
    encodes as resubmit(,8)
next(23);
    encodes as resubmit(,31)

next();
    Syntax error at `)' expecting "pipeline" or "table".
next(10;
    Syntax error at `;' expecting `)'.
#next(30);
#    "next" action cannot advance beyond table 29.

next(table=11);
    formats as next;
    encodes as resubmit(,19)
next(pipeline=ingress);
    formats as next;
    encodes as resubmit(,19)
next(table=11, pipeline=ingress);
    formats as next;
    encodes as resubmit(,19)
next(pipeline=ingress, table=11);
    formats as next;
    encodes as resubmit(,19)

next(pipeline=egress);
    formats as next(pipeline=egress, table=11);
    encodes as resubmit(,56)

next(pipeline=egress, table=5);
    encodes as resubmit(,50)

next(table=10);
    formats as next(10);
    encodes as resubmit(,18)

# Loading a constant value.
tcp.dst=80;
    formats as tcp.dst = 80;
    encodes as set_field:80->tcp_dst
    has prereqs ip.proto == 0x6 && (eth.type == 0x800 || eth.type == 0x86dd)
eth.dst[40] = 1;
    encodes as set_field:01:00:00:00:00:00/01:00:00:00:00:00->eth_dst
vlan.pcp = 2;
    encodes as set_field:0x4000/0xe000->vlan_tci
    has prereqs vlan.tci[12]
vlan.tci[13..15] = 2;
    encodes as set_field:0x4000/0xe000->vlan_tci
inport = "";
    encodes as set_field:0->reg14
ip.ttl=4;
    formats as ip.ttl = 4;
    encodes as set_field:4->nw_ttl
    has prereqs eth.type == 0x800 || eth.type == 0x86dd
outport="eth0"; next; outport="LOCAL"; next;
    formats as outport = "eth0"; next; outport = "LOCAL"; next;
    encodes as set_field:0x5->reg15,resubmit(,19),set_field:0xfffe->reg15,resubmit(,19)

inport[1] = 1;
    Cannot select subfield of string field inport.
ip.proto[1] = 1;
    Cannot select subfield of nominal field ip.proto.
eth.dst[40] == 1;
    Syntax error at `==' expecting `=' or `<->'.
ip = 1;
    Predicate symbol ip used where lvalue required.
ip.proto = 6;
    Field ip.proto is not modifiable.
inport = {"a", "b"};
    Syntax error at `{' expecting constant.
inport = {};
    Syntax error at `{' expecting constant.
bad_prereq = 123;
    Error parsing expression `xyzzy' encountered as prerequisite or predicate of initial expression: Syntax error at `xyzzy' expecting field name.
self_recurse = 123;
    Error parsing expression `self_recurse != 0' encountered as prerequisite or predicate of initial expression: Error parsing expression `self_recurse != 0' encountered as prerequisite or predicate of initial expression: Recursive expansion of symbol `self_recurse'.
vlan.present = 0;
    Predicate symbol vlan.present used where lvalue required.

# Moving one field into another.
reg0=reg1;
    formats as reg0 = reg1;
    encodes as move:NXM_NX_XXREG0[64..95]->NXM_NX_XXREG0[96..127]
vlan.pcp = reg0[0..2];
    encodes as move:NXM_NX_XXREG0[96..98]->NXM_OF_VLAN_TCI[13..15]
    has prereqs vlan.tci[12]
reg0[10] = vlan.pcp[1];
    encodes as move:NXM_OF_VLAN_TCI[14]->NXM_NX_XXREG0[106]
    has prereqs vlan.tci[12]
outport = inport;
    encodes as move:NXM_NX_REG14[]->NXM_NX_REG15[]

reg0[0] = vlan.present;
    Predicate symbol vlan.present used where lvalue required.
reg0 = reg1[0..10];
    Can't assign 11-bit value to 32-bit destination.
inport = reg0;
    Can't assign integer field (reg0) to string field (inport).
inport = big_string;
    String fields inport and big_string are incompatible for assignment.
ip.proto = reg0[0..7];
    Field ip.proto is not modifiable.

# Exchanging fields.
reg0 <-> reg1;
    encodes as push:NXM_NX_XXREG0[64..95],push:NXM_NX_XXREG0[96..127],pop:NXM_NX_XXREG0[64..95],pop:NXM_NX_XXREG0[96..127]
vlan.pcp <-> reg0[0..2];
    encodes as push:NXM_NX_XXREG0[96..98],push:NXM_OF_VLAN_TCI[13..15],pop:NXM_NX_XXREG0[96..98],pop:NXM_OF_VLAN_TCI[13..15]
    has prereqs vlan.tci[12]
reg0[10] <-> vlan.pcp[1];
    encodes as push:NXM_OF_VLAN_TCI[14],push:NXM_NX_XXREG0[106],pop:NXM_OF_VLAN_TCI[14],pop:NXM_NX_XXREG0[106]
    has prereqs vlan.tci[12]
outport <-> inport;
    encodes as push:NXM_NX_REG14[],push:NXM_NX_REG15[],pop:NXM_NX_REG14[],pop:NXM_NX_REG15[]

reg0[0] <-> vlan.present;
    Predicate symbol vlan.present used where lvalue required.
reg0 <-> reg1[0..10];
    Can't exchange 32-bit field with 11-bit field.
inport <-> reg0;
    Can't exchange string field (inport) with integer field (reg0).
inport <-> big_string;
    String fields inport and big_string are incompatible for exchange.
ip.proto <-> reg0[0..7];
    Field ip.proto is not modifiable.
reg0[0..7] <-> ip.proto;
    Field ip.proto is not modifiable.

# TTL decrement.
ip.ttl--;
    encodes as dec_ttl
    has prereqs ip
ip.ttl
    Syntax error at end of input expecting `--'.

# Packet mark.
pkt.mark=1;
    formats as pkt.mark = 1;
    encodes as set_field:0x1->pkt_mark

pkt.mark = 1000;
    encodes as set_field:0x3e8->pkt_mark

pkt.mark;
    Syntax error at `pkt.mark' expecting action.

pkt.mark = foo;
    Syntax error at `foo' expecting field name.

pkt.mark = "foo";
    Integer field pkt.mark is not compatible with string constant.

# load balancing.
ct_lb;
    encodes as ct(table=19,zone=NXM_NX_REG13[0..15],nat)
    has prereqs ip
ct_lb();
    formats as ct_lb;
    encodes as ct(table=19,zone=NXM_NX_REG13[0..15],nat)
    has prereqs ip
ct_clear; ct_lb; reg8[7] = 1;
    encodes as ct_clear,ct(table=19,zone=NXM_NX_REG13[0..15],nat),set_field:0x8000000000/0x8000000000->xreg4
    has prereqs ip
ct_lb(192.168.1.2:80, 192.168.1.3:80);
    Syntax error at `192.168.1.2' expecting backends.
ct_lb(backends=192.168.1.2:80,192.168.1.3:80);
    encodes as group:1
    uses group: id(1), name(type=select,selection_method=dp_hash,bucket=bucket_id=0,weight:100,actions=ct(nat(dst=192.168.1.2:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=192.168.1.3:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)))
    has prereqs ip
ct_lb(backends=192.168.1.2:80,192.168.1.3:80; skip_snat);
    encodes as group:2
    uses group: id(2), name(type=select,selection_method=dp_hash,bucket=bucket_id=0,weight:100,actions=ct(nat(dst=192.168.1.2:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label,set_field:4/4->ct_label)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=192.168.1.3:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label,set_field:4/4->ct_label)))
    has prereqs ip
ct_lb(backends=192.168.1.2:80,192.168.1.3:80; force_snat);
    encodes as group:3
    uses group: id(3), name(type=select,selection_method=dp_hash,bucket=bucket_id=0,weight:100,actions=ct(nat(dst=192.168.1.2:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label,set_field:8/8->ct_label)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=192.168.1.3:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label,set_field:8/8->ct_label)))
    has prereqs ip
ct_lb(backends=192.168.1.2, 192.168.1.3, );
    formats as ct_lb(backends=192.168.1.2,192.168.1.3);
    encodes as group:4
    uses group: id(4), name(type=select,selection_method=dp_hash,bucket=bucket_id=0,weight:100,actions=ct(nat(dst=192.168.1.2),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=192.168.1.3),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)))
    has prereqs ip
ct_lb(backends=fd0f::2, fd0f::3, );
    formats as ct_lb(backends=fd0f::2,fd0f::3);
    encodes as group:5
    uses group: id(5), name(type=select,selection_method=dp_hash,bucket=bucket_id=0,weight:100,actions=ct(nat(dst=fd0f::2),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=fd0f::3),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)))
    has prereqs ip

ct_lb(backends=192.168.1.2:);
    Syntax error at `)' expecting port number.
ct_lb(backends=192.168.1.2:123456);
    Syntax error at `123456' expecting port number.
ct_lb(backends=foo);
    Syntax error at `foo' expecting IP address.
ct_lb(backends=[192.168.1.2]);
    Syntax error at `192.168.1.2' expecting IPv6 address.

ct_lb(backends=192.168.1.2:80,192.168.1.3:80; hash_fields=eth_src,eth_dst,ip_src);
    Syntax error at `eth_src' invalid hash_fields.
ct_lb(backends=192.168.1.2:80,192.168.1.3:80; hash_fields="eth_src,eth_dst,ip_src");
    encodes as group:6
    uses group: id(6), name(type=select,selection_method=hash,fields(eth_src,eth_dst,ip_src),bucket=bucket_id=0,weight:100,actions=ct(nat(dst=192.168.1.2:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=192.168.1.3:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)))
    has prereqs ip
ct_lb(backends=fd0f::2,fd0f::3; hash_fields="eth_src,eth_dst,ip_src,ip_dst,tp_src,tp_dst");
    encodes as group:7
    uses group: id(7), name(type=select,selection_method=hash,fields(eth_src,eth_dst,ip_src,ip_dst,tp_src,tp_dst),bucket=bucket_id=0,weight:100,actions=ct(nat(dst=fd0f::2),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=fd0f::3),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)))
    has prereqs ip
ct_lb(backends=fd0f::2,fd0f::3; hash_fields="eth_src,eth_dst,ip_src,ip_dst,tcp_src,tcp_dst");
    encodes as group:8
    uses group: id(8), name(type=select,selection_method=hash,fields(eth_src,eth_dst,ip_src,ip_dst,tcp_src,tcp_dst),bucket=bucket_id=0,weight:100,actions=ct(nat(dst=fd0f::2),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=fd0f::3),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)))
    has prereqs ip
ct_lb(backends=fd0f::2,fd0f::3; hash_fields="eth_src,eth_dst,ip_src,ip_dst,udp_src,udp_dst");
    encodes as group:9
    uses group: id(9), name(type=select,selection_method=hash,fields(eth_src,eth_dst,ip_src,ip_dst,udp_src,udp_dst),bucket=bucket_id=0,weight:100,actions=ct(nat(dst=fd0f::2),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=fd0f::3),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)))
    has prereqs ip
ct_lb(backends=fd0f::2,fd0f::3; hash_fields="eth_src,eth_dst,ip_src,ip_dst,sctp_src,sctp_dst");
    encodes as group:10
    uses group: id(10), name(type=select,selection_method=hash,fields(eth_src,eth_dst,ip_src,ip_dst,sctp_src,sctp_dst),bucket=bucket_id=0,weight:100,actions=ct(nat(dst=fd0f::2),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=fd0f::3),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label)))
    has prereqs ip
ct_lb(backends=fd0f::2,fd0f::3; hash_fields="eth_src,eth_dst,ip_src,ip_dst,sctp_src,sctp_dst"; skip_snat);
    encodes as group:11
    uses group: id(11), name(type=select,selection_method=hash,fields(eth_src,eth_dst,ip_src,ip_dst,sctp_src,sctp_dst),bucket=bucket_id=0,weight:100,actions=ct(nat(dst=fd0f::2),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label,set_field:4/4->ct_label)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=fd0f::3),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label,set_field:4/4->ct_label)))
    has prereqs ip
ct_lb(backends=fd0f::2,fd0f::3; hash_fields="eth_src,eth_dst,ip_src,ip_dst,sctp_src,sctp_dst"; force_snat);
    encodes as group:12
    uses group: id(12), name(type=select,selection_method=hash,fields(eth_src,eth_dst,ip_src,ip_dst,sctp_src,sctp_dst),bucket=bucket_id=0,weight:100,actions=ct(nat(dst=fd0f::2),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label,set_field:8/8->ct_label)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=fd0f::3),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_label,set_field:8/8->ct_label)))
    has prereqs ip

ct_lb_mark(backends=192.168.1.2:80,192.168.1.3:80);
    encodes as group:13
    uses group: id(13), name(type=select,selection_method=dp_hash,bucket=bucket_id=0,weight:100,actions=ct(nat(dst=192.168.1.2:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_mark)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=192.168.1.3:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_mark)))
    has prereqs ip
ct_lb_mark(backends=192.168.1.2:80,192.168.1.3:80; skip_snat);
    encodes as group:14
    uses group: id(14), name(type=select,selection_method=dp_hash,bucket=bucket_id=0,weight:100,actions=ct(nat(dst=192.168.1.2:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_mark,set_field:4/4->ct_mark)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=192.168.1.3:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_mark,set_field:4/4->ct_mark)))
    has prereqs ip
ct_lb_mark(backends=192.168.1.2:80,192.168.1.3:80; force_snat);
    encodes as group:15
    uses group: id(15), name(type=select,selection_method=dp_hash,bucket=bucket_id=0,weight:100,actions=ct(nat(dst=192.168.1.2:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_mark,set_field:8/8->ct_mark)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=192.168.1.3:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_mark,set_field:8/8->ct_mark)))
    has prereqs ip
ct_lb_mark(backends=192.168.1.2:80,192.168.1.3:80; hash_fields="eth_src,eth_dst,ip_src,ip_dst,sctp_src,sctp_dst");
    encodes as group:16
    uses group: id(16), name(type=select,selection_method=hash,fields(eth_src,eth_dst,ip_src,ip_dst,sctp_src,sctp_dst),bucket=bucket_id=0,weight:100,actions=ct(nat(dst=192.168.1.2:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_mark)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=192.168.1.3:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_mark)))
    has prereqs ip
ct_lb_mark(backends=192.168.1.2:80,192.168.1.3:80; hash_fields="eth_src,eth_dst,ip_src,ip_dst,sctp_src,sctp_dst"; skip_snat);
    encodes as group:17
    uses group: id(17), name(type=select,selection_method=hash,fields(eth_src,eth_dst,ip_src,ip_dst,sctp_src,sctp_dst),bucket=bucket_id=0,weight:100,actions=ct(nat(dst=192.168.1.2:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_mark,set_field:4/4->ct_mark)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=192.168.1.3:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_mark,set_field:4/4->ct_mark)))
    has prereqs ip
ct_lb_mark(backends=192.168.1.2:80,192.168.1.3:80; hash_fields="eth_src,eth_dst,ip_src,ip_dst,sctp_src,sctp_dst"; force_snat);
    encodes as group:18
    uses group: id(18), name(type=select,selection_method=hash,fields(eth_src,eth_dst,ip_src,ip_dst,sctp_src,sctp_dst),bucket=bucket_id=0,weight:100,actions=ct(nat(dst=192.168.1.2:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_mark,set_field:8/8->ct_mark)),bucket=bucket_id=1,weight:100,actions=ct(nat(dst=192.168.1.3:80),commit,table=19,zone=NXM_NX_REG13[0..15],exec(set_field:2/2->ct_mark,set_field:8/8->ct_mark)))
    has prereqs ip

# ct_next
ct_next;
    formats as ct_next(dnat);
    encodes as ct(table=19,zone=NXM_NX_REG13[0..15])
    has prereqs ip
ct_next(dnat);
    encodes as ct(table=19,zone=NXM_NX_REG13[0..15])
    has prereqs ip
ct_next(snat);
    encodes as ct(table=19,zone=NXM_NX_REG13[0..15])
    has prereqs ip
ct_clear; ct_next;
    formats as ct_clear; ct_next(dnat);
    encodes as ct_clear,ct(table=19,zone=NXM_NX_REG13[0..15])
    has prereqs ip
ct_next(snat, dnat);
    Syntax error at `,' expecting `)'.
ct_next(dnat, ignore);
    Syntax error at `,' expecting `)'.
ct_next(ignore);
    "ct_next" action accepts only "dnat" or "snat" parameter.
ct_next();
    "ct_next" action accepts only "dnat" or "snat" parameter.

# ct_commit
ct_commit;
    encodes as ct(commit,zone=NXM_NX_REG13[0..15])
    has prereqs ip
ct_commit { };
    formats as ct_commit;
    encodes as ct(commit,zone=NXM_NX_REG13[0..15])
    has prereqs ip
ct_commit { ct_mark=1; };
    formats as ct_commit { ct_mark = 1; };
    encodes as ct(commit,zone=NXM_NX_REG13[0..15],exec(set_field:0x1->ct_mark))
    has prereqs ip
ct_commit { ct_mark=1/1; };
    formats as ct_commit { ct_mark = 1/1; };
    encodes as ct(commit,zone=NXM_NX_REG13[0..15],exec(set_field:0x1/0x1->ct_mark))
    has prereqs ip
ct_commit { ct_label=1; };
    formats as ct_commit { ct_label = 1; };
    encodes as ct(commit,zone=NXM_NX_REG13[0..15],exec(set_field:0x1->ct_label))
    has prereqs ip
ct_commit { ct_label=1/1; };
    formats as ct_commit { ct_label = 1/1; };
    encodes as ct(commit,zone=NXM_NX_REG13[0..15],exec(set_field:0x1/0x1->ct_label))
    has prereqs ip
ct_commit { ct_mark=1; ct_label=2; };
    formats as ct_commit { ct_mark = 1; ct_label = 2; };
    encodes as ct(commit,zone=NXM_NX_REG13[0..15],exec(set_field:0x1->ct_mark,set_field:0x2->ct_label))
    has prereqs ip

ct_commit { ct_label=0x01020304050607080910111213141516; };
    formats as ct_commit { ct_label = 0x1020304050607080910111213141516; };
    encodes as ct(commit,zone=NXM_NX_REG13[0..15],exec(set_field:0x1020304050607080910111213141516->ct_label))
    has prereqs ip
ct_commit { ct_label=0x1000000000000000000000000000000/0x1000000000000000000000000000000; };
    formats as ct_commit { ct_label = 0x1000000000000000000000000000000/0x1000000000000000000000000000000; };
    encodes as ct(commit,zone=NXM_NX_REG13[0..15],exec(set_field:0x1000000000000000000000000000000/0x1000000000000000000000000000000->ct_label))
    has prereqs ip
ct_commit { ct_label=18446744073709551615; };
    formats as ct_commit { ct_label = 18446744073709551615; };
    encodes as ct(commit,zone=NXM_NX_REG13[0..15],exec(set_field:0xffffffffffffffff->ct_label))
    has prereqs ip
ct_commit { ct_label[0..47] = 0x00000f040201; ct_label[48..63] = 0x0002; };
    formats as ct_commit { ct_label[0..47] = 0xf040201; ct_label[48..63] = 0x2; };
    encodes as ct(commit,zone=NXM_NX_REG13[0..15],exec(set_field:0xf040201/0xffffffffffff->ct_label,set_field:0x2000000000000/0xffff000000000000->ct_label))
    has prereqs ip
ct_commit { ct_label=18446744073709551616; };
    Decimal constants must be less than 2**64.
ct_commit { ct_label=0x181716151413121110090807060504030201; };
    141-bit constant is not compatible with 128-bit field ct_label.
ct_commit { ip4.dst = 192.168.0.1; };
    Field ip4.dst is not modifiable.
reg8[17] = 1; ct_commit { ct_mark.blocked = 1; };
    encodes as set_field:0x2000000000000/0x2000000000000->xreg4,ct(commit,zone=NXM_NX_REG13[0..15],exec(set_field:0x1/0x1->ct_mark))
    has prereqs ip
ct_clear; ct_commit { }; next;
    formats as ct_clear; ct_commit; next;
    encodes as ct_clear,ct(commit,zone=NXM_NX_REG13[0..15]),resubmit(,19)
    has prereqs ip

# ct_commit_to_zone
ct_commit_to_zone(dnat);
    encodes as ct(commit,table=19,zone=NXM_NX_REG13[0..15])
    has prereqs ip
ct_commit_to_zone(snat);
    encodes as ct(commit,table=19,zone=NXM_NX_REG13[0..15])
    has prereqs ip
ct_commit_to_zone;
    Syntax error at `;' expecting `('.
ct_commit_to_zone();
    "ct_commit_to_zone" action accepts only "dnat" or "snat" parameter.
ct_commit_to_zone(foo);
    "ct_commit_to_zone" action accepts only "dnat" or "snat" parameter.
ct_commit_to_zone(dnat;
    Syntax error at `;' expecting `)'.

# Legact ct_commit_v1 action.
ct_commit();
    Syntax error at `(' expecting `;'.
ct_commit(ct_mark=1);
    Syntax error at `(' expecting `;'.
ct_commit(ct_mark=1/1);
    Syntax error at `(' expecting `;'.
ct_commit(ct_label=1);
    Syntax error at `(' expecting `;'.
ct_commit(ct_label=1/1);
    Syntax error at `(' expecting `;'.
ct_commit(ct_mark=1, ct_label=2);
    Syntax error at `(' expecting `;'.

ct_commit(ct_label=0x01020304050607080910111213141516);
    Syntax error at `(' expecting `;'.
ct_commit(ct_label=0x181716151413121110090807060504030201);
    Syntax error at `(' expecting `;'.
ct_commit(ct_label=0x1000000000000000000000000000000/0x1000000000000000000000000000000);
    Syntax error at `(' expecting `;'.
ct_commit(ct_label=18446744073709551615);
    Syntax error at `(' expecting `;'.
ct_commit(ct_label=18446744073709551616);
    Syntax error at `(' expecting `;'.

# Observation domain and point id.
ct_commit { ct_label.obs_point_id = reg2; };
    encodes as ct(commit,zone=NXM_NX_REG13[0..15],exec(move:NXM_NX_XXREG0[32..63]->NXM_NX_CT_LABEL[96..127]))
    has prereqs ip

ct_mark = 12345
    Field ct_mark is not modifiable.
ct_mark.blocked = 1/1
    Field ct_mark.blocked is not modifiable.
ct_label = 0xcafe
    Field ct_label is not modifiable.

# ct_dnat
ct_dnat;
    encodes as ct(table=19,zone=NXM_NX_REG11[0..15],nat)
    has prereqs ip
ct_dnat(192.168.1.2);
    encodes as ct(commit,table=19,zone=NXM_NX_REG11[0..15],nat(dst=192.168.1.2))
    has prereqs ip
ct_dnat(fd11::2);
    encodes as ct(commit,table=19,zone=NXM_NX_REG11[0..15],nat(dst=fd11::2))
    has prereqs ip
ct_dnat(192.168.1.2, 1-3000);
    formats as ct_dnat(192.168.1.2,1-3000);
    encodes as ct(commit,table=19,zone=NXM_NX_REG11[0..15],nat(dst=192.168.1.2:1-3000,random))
    has prereqs ip
ct_clear; ct_dnat;
    encodes as ct_clear,ct(table=19,zone=NXM_NX_REG11[0..15],nat)
    has prereqs ip

ct_dnat(192.168.1.2, 192.168.1.3);
    Syntax error at `192.168.1.3' expecting Integer for port range.
ct_dnat(foo);
    Syntax error at `foo' expecting IPv4 or IPv6 address.
ct_dnat(foo, bar);
    Syntax error at `foo' expecting IPv4 or IPv6 address.
ct_dnat();
    Syntax error at `)' expecting IPv4 or IPv6 address.
ct_dnat(192.168.1.2, foo);
    Syntax error at `foo' expecting Integer for port range.
ct_dnat(192.168.1.2, 1000-foo);
    Syntax error at `foo' expecting Integer for port range.
ct_dnat(192.168.1.2, 1000);
    formats as ct_dnat(192.168.1.2,1000);
    encodes as ct(commit,table=19,zone=NXM_NX_REG11[0..15],nat(dst=192.168.1.2:1000))
    has prereqs ip
ct_dnat(192.168.1.2, 1000-100);
    Syntax error at `100' range high should be greater than range low.

# ct_dnat_in_czone
ct_dnat_in_czone;
    encodes as ct(table=19,zone=NXM_NX_REG11[0..15],nat)
    has prereqs ip
ct_dnat_in_czone(192.168.1.2);
    encodes as ct(commit,table=19,zone=NXM_NX_REG11[0..15],nat(dst=192.168.1.2))
    has prereqs ip
ct_dnat_in_czone(fd11::2);
    encodes as ct(commit,table=19,zone=NXM_NX_REG11[0..15],nat(dst=fd11::2))
    has prereqs ip
ct_dnat_in_czone(192.168.1.2, 1-3000);
    formats as ct_dnat_in_czone(192.168.1.2,1-3000);
    encodes as ct(commit,table=19,zone=NXM_NX_REG11[0..15],nat(dst=192.168.1.2:1-3000,random))
    has prereqs ip
ct_clear; ct_dnat_in_czone;
    encodes as ct_clear,ct(table=19,zone=NXM_NX_REG11[0..15],nat)
    has prereqs ip

ct_dnat_in_czone(192.168.1.2, 192.168.1.3);
    Syntax error at `192.168.1.3' expecting Integer for port range.
ct_dnat_in_czone(foo);
    Syntax error at `foo' expecting IPv4 or IPv6 address.
ct_dnat_in_czone(foo, bar);
    Syntax error at `foo' expecting IPv4 or IPv6 address.
ct_dnat_in_czone();
    Syntax error at `)' expecting IPv4 or IPv6 address.
ct_dnat_in_czone(192.168.1.2, foo);
    Syntax error at `foo' expecting Integer for port range.
ct_dnat_in_czone(192.168.1.2, 1000-foo);
    Syntax error at `foo' expecting Integer for port range.
ct_dnat_in_czone(192.168.1.2, 1000);
    formats as ct_dnat_in_czone(192.168.1.2,1000);
    encodes as ct(commit,table=19,zone=NXM_NX_REG11[0..15],nat(dst=192.168.1.2:1000))
    has prereqs ip
ct_dnat_in_czone(192.168.1.2, 1000-100);
    Syntax error at `100' range high should be greater than range low.

# ct_snat
ct_snat;
    encodes as ct(table=19,zone=NXM_NX_REG12[0..15],nat)
    has prereqs ip
ct_snat(192.168.1.2);
    encodes as ct(commit,table=19,zone=NXM_NX_REG12[0..15],nat(src=192.168.1.2))
    has prereqs ip
ct_snat(fd11::2);
    encodes as ct(commit,table=19,zone=NXM_NX_REG12[0..15],nat(src=fd11::2))
    has prereqs ip
ct_snat(192.168.1.2, 1-3000);
    formats as ct_snat(192.168.1.2,1-3000);
    encodes as ct(commit,table=19,zone=NXM_NX_REG12[0..15],nat(src=192.168.1.2:1-3000,random))
    has prereqs ip
ct_clear; ct_snat;
    encodes as ct_clear,ct(table=19,zone=NXM_NX_REG12[0..15],nat)
    has prereqs ip

ct_snat(192.168.1.2, 192.168.1.3);
    Syntax error at `192.168.1.3' expecting Integer for port range.
ct_snat(foo);
    Syntax error at `foo' expecting IPv4 or IPv6 address.
ct_snat(foo, bar);
    Syntax error at `foo' expecting IPv4 or IPv6 address.
ct_snat();
    Syntax error at `)' expecting IPv4 or IPv6 address.
ct_snat(192.168.1.2, foo);
    Syntax error at `foo' expecting Integer for port range.
ct_snat(192.168.1.2, 1000-foo);
    Syntax error at `foo' expecting Integer for port range.
ct_snat(192.168.1.2, 1000);
    formats as ct_snat(192.168.1.2,1000);
    encodes as ct(commit,table=19,zone=NXM_NX_REG12[0..15],nat(src=192.168.1.2:1000))
    has prereqs ip
ct_snat(192.168.1.2, 1000-100);
    Syntax error at `100' range high should be greater than range low.

# ct_snat_in_czone
ct_snat_in_czone;
    encodes as ct(table=19,zone=NXM_NX_REG11[0..15],nat)
    has prereqs ip
ct_snat_in_czone(192.168.1.2);
    encodes as ct(commit,table=19,zone=NXM_NX_REG11[0..15],nat(src=192.168.1.2))
    has prereqs ip
ct_snat_in_czone(fd11::2);
    encodes as ct(commit,table=19,zone=NXM_NX_REG11[0..15],nat(src=fd11::2))
    has prereqs ip
ct_snat_in_czone(192.168.1.2, 1-3000);
    formats as ct_snat_in_czone(192.168.1.2,1-3000);
    encodes as ct(commit,table=19,zone=NXM_NX_REG11[0..15],nat(src=192.168.1.2:1-3000,random))
    has prereqs ip
ct_clear; ct_snat_in_czone;
    encodes as ct_clear,ct(table=19,zone=NXM_NX_REG11[0..15],nat)
    has prereqs ip

ct_snat_in_czone(192.168.1.2, 192.168.1.3);
    Syntax error at `192.168.1.3' expecting Integer for port range.
ct_snat_in_czone(foo);
    Syntax error at `foo' expecting IPv4 or IPv6 address.
ct_snat_in_czone(foo, bar);
    Syntax error at `foo' expecting IPv4 or IPv6 address.
ct_snat_in_czone();
    Syntax error at `)' expecting IPv4 or IPv6 address.
ct_snat_in_czone(192.168.1.2, foo);
    Syntax error at `foo' expecting Integer for port range.
ct_snat_in_czone(192.168.1.2, 1000-foo);
    Syntax error at `foo' expecting Integer for port range.
ct_snat_in_czone(192.168.1.2, 1000);
    formats as ct_snat_in_czone(192.168.1.2,1000);
    encodes as ct(commit,table=19,zone=NXM_NX_REG11[0..15],nat(src=192.168.1.2:1000))
    has prereqs ip
ct_snat_in_czone(192.168.1.2, 1000-100);
    Syntax error at `100' range high should be greater than range low.

# ct_clear
ct_clear;
    encodes as ct_clear

# ct_commit_nat
ct_commit_nat;
    formats as ct_commit_nat(dnat);
    encodes as ct(commit,table=19,zone=NXM_NX_REG13[0..15],nat)
    has prereqs ip

ct_commit_nat(snat);
    encodes as ct(commit,table=19,zone=NXM_NX_REG13[0..15],nat)
    has prereqs ip

ct_commit_nat(dnat);
    encodes as ct(commit,table=19,zone=NXM_NX_REG13[0..15],nat)
    has prereqs ip

ct_commit_nat(snat, dnat);
    Syntax error at `,' expecting `)'.

ct_commit_nat(dnat, ignore);
    Syntax error at `,' expecting `)'.

ct_commit_nat(ignore);
    "ct_commit_nat" action accepts only "dnat" or "snat" parameter.

ct_commit_nat();
    "ct_commit_nat" action accepts only "dnat" or "snat" parameter.

# clone
clone { ip4.dst = 255.255.255.255; output; }; next;
    encodes as clone(set_field:255.255.255.255->ip_dst,resubmit(,64)),resubmit(,19)
    has prereqs eth.type == 0x800

# arp
arp { eth.dst = ff:ff:ff:ff:ff:ff; output; }; output;
    encodes as controller(userdata=00.00.00.00.00.00.00.00.00.19.00.10.80.00.06.06.ff.ff.ff.ff.ff.ff.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00,pause),resubmit(,64)
    has prereqs ip
arp { };
    formats as arp { drop; };
    encodes as controller(userdata=00.00.00.00.00.00.00.00,pause)
    has prereqs ip

# get_arp
get_arp(outport, ip4.dst);
    encodes as push:NXM_NX_REG0[],push:NXM_OF_IP_DST[],pop:NXM_NX_REG0[],set_field:00:00:00:00:00:00->eth_dst,resubmit(,66),pop:NXM_NX_REG0[]
    has prereqs eth.type == 0x800
get_arp(inport, reg0);
    encodes as push:NXM_NX_REG15[],push:NXM_NX_REG0[],push:NXM_NX_XXREG0[96..127],push:NXM_NX_REG14[],pop:NXM_NX_REG15[],pop:NXM_NX_REG0[],set_field:00:00:00:00:00:00->eth_dst,resubmit(,66),pop:NXM_NX_REG0[],pop:NXM_NX_REG15[]

get_arp;
    Syntax error at `;' expecting `('.
get_arp();
    Syntax error at `)' expecting field name.
get_arp(inport);
    Syntax error at `)' expecting `,'.
get_arp(inport ip4.dst);
    Syntax error at `ip4.dst' expecting `,'.
get_arp(inport, ip4.dst;
    Syntax error at `;' expecting `)'.
get_arp(inport, eth.dst);
    Cannot use 48-bit field eth.dst[0..47] where 32-bit field is required.
get_arp(inport, outport);
    Cannot use string field outport where numeric field is required.
get_arp(reg0, ip4.dst);
    Cannot use numeric field reg0 where string field is required.

# put_arp
put_arp(inport, arp.spa, arp.sha);
    encodes as push:NXM_NX_REG0[],push:NXM_OF_ETH_SRC[],push:NXM_NX_ARP_SHA[],push:NXM_OF_ARP_SPA[],pop:NXM_NX_REG0[],pop:NXM_OF_ETH_SRC[],controller(userdata=00.00.00.01.00.00.00.00),pop:NXM_OF_ETH_SRC[],pop:NXM_NX_REG0[]
    has prereqs eth.type == 0x806 && eth.type == 0x806

# lookup_arp
reg0[0] = lookup_arp(inport, ip4.dst, eth.src);
    encodes as push:NXM_NX_REG0[],push:NXM_OF_IP_DST[],pop:NXM_NX_REG0[],set_field:0/0x40->reg10,resubmit(,67),move:NXM_NX_REG10[6]->NXM_NX_XXREG0[96],pop:NXM_NX_REG0[]
    has prereqs eth.type == 0x800
reg1[1] = lookup_arp(inport, arp.spa, arp.sha);
    encodes as push:NXM_NX_REG0[],push:NXM_OF_ETH_SRC[],push:NXM_NX_ARP_SHA[],push:NXM_OF_ARP_SPA[],pop:NXM_NX_REG0[],pop:NXM_OF_ETH_SRC[],set_field:0/0x40->reg10,resubmit(,67),move:NXM_NX_REG10[6]->NXM_NX_XXREG0[65],pop:NXM_OF_ETH_SRC[],pop:NXM_NX_REG0[]
    has prereqs eth.type == 0x806 && eth.type == 0x806

lookup_arp;
    Syntax error at `lookup_arp' expecting action.
reg0[0] = lookup_arp;
    Syntax error at `lookup_arp' expecting field name.
reg0[0] = lookup_arp();
    Syntax error at `)' expecting field name.
reg0[0] = lookup_arp(inport);
    Syntax error at `)' expecting `,'.
reg0[0] = lookup_arp(inport ip4.dst);
    Syntax error at `ip4.dst' expecting `,'.
reg0[0] = lookup_arp(inport, ip4.dst;
    Syntax error at `;' expecting `,'.
reg0[0] = lookup_arp(inport, ip4.dst, eth.src;
    Syntax error at `;' expecting `)'.
reg0[0] = lookup_arp(inport, eth.dst);
    Cannot use 48-bit field eth.dst[0..47] where 32-bit field is required.
reg0[0] = lookup_arp(inport, ip4.src, ip4.dst);
    Cannot use 32-bit field ip4.dst[0..31] where 48-bit field is required.

# lookup_arp_ip
reg0[0] = lookup_arp_ip(inport, ip4.dst);
    encodes as push:NXM_NX_REG15[],push:NXM_NX_REG0[],push:NXM_OF_IP_DST[],push:NXM_NX_REG14[],pop:NXM_NX_REG15[],pop:NXM_NX_REG0[],push:NXM_OF_ETH_DST[],set_field:0/0x40->reg10,resubmit(,66),move:NXM_NX_REG10[6]->NXM_NX_XXREG0[96],pop:NXM_OF_ETH_DST[],pop:NXM_NX_REG0[],pop:NXM_NX_REG15[]
    has prereqs eth.type == 0x800
reg1[1] = lookup_arp_ip(inport, arp.spa);
    encodes as push:NXM_NX_REG15[],push:NXM_NX_REG0[],push:NXM_OF_ARP_SPA[],push:NXM_NX_REG14[],pop:NXM_NX_REG15[],pop:NXM_NX_REG0[],push:NXM_OF_ETH_DST[],set_field:0/0x40->reg10,resubmit(,66),move:NXM_NX_REG10[6]->NXM_NX_XXREG0[65],pop:NXM_OF_ETH_DST[],pop:NXM_NX_REG0[],pop:NXM_NX_REG15[]
    has prereqs eth.type == 0x806

lookup_arp_ip;
    Syntax error at `lookup_arp_ip' expecting action.
reg0[0] = lookup_arp_ip;
    Syntax error at `lookup_arp_ip' expecting field name.
reg0[0] = lookup_arp_ip();
    Syntax error at `)' expecting field name.
reg0[0] = lookup_arp_ip(inport);
    Syntax error at `)' expecting `,'.
reg0[0] = lookup_arp_ip(inport ip4.dst);
    Syntax error at `ip4.dst' expecting `,'.
reg0[0] = lookup_arp_ip(inport, ip4.dst;
    Syntax error at `;' expecting `)'.
reg0[0] = lookup_arp_ip(inport, ip4.dst, eth.src;
    Syntax error at `,' expecting `)'.
reg0[0] = lookup_arp_ip(inport, eth.dst);
    Cannot use 48-bit field eth.dst[0..47] where 32-bit field is required.

# put_dhcp_opts
reg1[0] = put_dhcp_opts(offerip = 1.2.3.4, router = 10.0.0.1);
    encodes as controller(userdata=00.00.00.02.00.00.00.00.00.01.de.10.00.00.00.40.01.02.03.04.03.04.0a.00.00.01,pause)
reg2[5] = put_dhcp_opts(offerip=10.0.0.4,router=10.0.0.1,netmask=255.255.254.0,mtu=1400,domain_name="ovn.org",wpad="https://example.org",bootfile_name="https://127.0.0.1/boot.ipxe",path_prefix="/tftpboot", next_server=10.0.0.9);
    formats as reg2[5] = put_dhcp_opts(offerip = 10.0.0.4, router = 10.0.0.1, netmask = 255.255.254.0, mtu = 1400, domain_name = "ovn.org", wpad = "https://example.org", bootfile_name = "https://127.0.0.1/boot.ipxe", path_prefix = "/tftpboot", next_server = 10.0.0.9);
    encodes as controller(userdata=00.00.00.02.00.00.00.00.00.01.de.10.00.00.00.25.0a.00.00.04.43.1b.68.74.74.70.73.3a.2f.2f.31.32.37.2e.30.2e.30.2e.31.2f.62.6f.6f.74.2e.69.70.78.65.fd.04.0a.00.00.09.03.04.0a.00.00.01.01.04.ff.ff.fe.00.1a.02.05.78.0f.07.6f.76.6e.2e.6f.72.67.fc.13.68.74.74.70.73.3a.2f.2f.65.78.61.6d.70.6c.65.2e.6f.72.67.d2.09.2f.74.66.74.70.62.6f.6f.74,pause)
reg0[15] = put_dhcp_opts(offerip=10.0.0.4,router=10.0.0.1,netmask=255.255.255.0,mtu=1400,ip_forward_enable=1,default_ttl=121,dns_server={8.8.8.8,7.7.7.7},classless_static_route={30.0.0.0/24,10.0.0.4,40.0.0.0/16,10.0.0.6,0.0.0.0/0,10.0.0.1},ethernet_encap=1,router_discovery=0,tftp_server_address={10.0.0.4,10.0.0.5},arp_cache_timeout=10,tcp_keepalive_interval=10);
    formats as reg0[15] = put_dhcp_opts(offerip = 10.0.0.4, router = 10.0.0.1, netmask = 255.255.255.0, mtu = 1400, ip_forward_enable = 1, default_ttl = 121, dns_server = {8.8.8.8, 7.7.7.7}, classless_static_route = {30.0.0.0/24, 10.0.0.4, 40.0.0.0/16, 10.0.0.6, 0.0.0.0/0, 10.0.0.1}, ethernet_encap = 1, router_discovery = 0, tftp_server_address = {10.0.0.4, 10.0.0.5}, arp_cache_timeout = 10, tcp_keepalive_interval = 10);
    encodes as controller(userdata=00.00.00.02.00.00.00.00.00.01.de.10.00.00.00.6f.0a.00.00.04.03.04.0a.00.00.01.01.04.ff.ff.ff.00.1a.02.05.78.13.01.01.17.01.79.06.08.08.08.08.08.07.07.07.07.79.14.18.1e.00.00.0a.00.00.04.10.28.00.0a.00.00.06.00.0a.00.00.01.24.01.01.1f.01.00.96.08.0a.00.00.04.0a.00.00.05.23.04.00.00.00.0a.26.04.00.00.00.0a,pause)
reg0[15] = put_dhcp_opts(offerip=10.0.0.4,router=10.0.0.1,netmask=255.255.255.0,mtu=1400,ip_forward_enable=1,default_ttl=121,dns_server={8.8.8.8,7.7.7.7},classless_static_route={30.0.0.0/24,10.0.0.4,40.0.0.0/16,10.0.0.6,0.0.0.0/0,10.0.0.1},ethernet_encap=1,router_discovery=0,tftp_server=10.0.0.10,broadcast_address=255.255.255.255);
    formats as reg0[15] = put_dhcp_opts(offerip = 10.0.0.4, router = 10.0.0.1, netmask = 255.255.255.0, mtu = 1400, ip_forward_enable = 1, default_ttl = 121, dns_server = {8.8.8.8, 7.7.7.7}, classless_static_route = {30.0.0.0/24, 10.0.0.4, 40.0.0.0/16, 10.0.0.6, 0.0.0.0/0, 10.0.0.1}, ethernet_encap = 1, router_discovery = 0, tftp_server = 10.0.0.10, broadcast_address = 255.255.255.255);
    encodes as controller(userdata=00.00.00.02.00.00.00.00.00.01.de.10.00.00.00.6f.0a.00.00.04.03.04.0a.00.00.01.01.04.ff.ff.ff.00.1a.02.05.78.13.01.01.17.01.79.06.08.08.08.08.08.07.07.07.07.79.14.18.1e.00.00.0a.00.00.04.10.28.00.0a.00.00.06.00.0a.00.00.01.24.01.01.1f.01.00.42.04.0a.00.00.0a.1c.04.ff.ff.ff.ff,pause)
reg0[15] = put_dhcp_opts(offerip=10.0.0.4,router=10.0.0.1,netmask=255.255.255.0,mtu=1400,ip_forward_enable=1,default_ttl=121,dns_server={8.8.8.8,7.7.7.7},classless_static_route={30.0.0.0/24,10.0.0.4,40.0.0.0/16,10.0.0.6,0.0.0.0/0,10.0.0.1},ethernet_encap=1,router_discovery=0,tftp_server="tftp_server_test");
    formats as reg0[15] = put_dhcp_opts(offerip = 10.0.0.4, router = 10.0.0.1, netmask = 255.255.255.0, mtu = 1400, ip_forward_enable = 1, default_ttl = 121, dns_server = {8.8.8.8, 7.7.7.7}, classless_static_route = {30.0.0.0/24, 10.0.0.4, 40.0.0.0/16, 10.0.0.6, 0.0.0.0/0, 10.0.0.1}, ethernet_encap = 1, router_discovery = 0, tftp_server = "tftp_server_test");
    encodes as controller(userdata=00.00.00.02.00.00.00.00.00.01.de.10.00.00.00.6f.0a.00.00.04.03.04.0a.00.00.01.01.04.ff.ff.ff.00.1a.02.05.78.13.01.01.17.01.79.06.08.08.08.08.08.07.07.07.07.79.14.18.1e.00.00.0a.00.00.04.10.28.00.0a.00.00.06.00.0a.00.00.01.24.01.01.1f.01.00.42.10.74.66.74.70.5f.73.65.72.76.65.72.5f.74.65.73.74,pause)
reg2[5] = put_dhcp_opts(offerip=10.0.0.4,router=10.0.0.1,netmask=255.255.254.0,mtu=1400,domain_name="ovn.org",wpad="https://example.org",bootfile_name="https://127.0.0.1/boot.ipxe",path_prefix="/tftpboot",domain_search_list="ovn.org,abc.ovn.org",netbios_name_server={10.0.0.7,10.0.0.8},netbios_node_type=2);
    formats as reg2[5] = put_dhcp_opts(offerip = 10.0.0.4, router = 10.0.0.1, netmask = 255.255.254.0, mtu = 1400, domain_name = "ovn.org", wpad = "https://example.org", bootfile_name = "https://127.0.0.1/boot.ipxe", path_prefix = "/tftpboot", domain_search_list = "ovn.org,abc.ovn.org", netbios_name_server = {10.0.0.7, 10.0.0.8}, netbios_node_type = 2);
    encodes as controller(userdata=00.00.00.02.00.00.00.00.00.01.de.10.00.00.00.25.0a.00.00.04.43.1b.68.74.74.70.73.3a.2f.2f.31.32.37.2e.30.2e.30.2e.31.2f.62.6f.6f.74.2e.69.70.78.65.03.04.0a.00.00.01.01.04.ff.ff.fe.00.1a.02.05.78.0f.07.6f.76.6e.2e.6f.72.67.fc.13.68.74.74.70.73.3a.2f.2f.65.78.61.6d.70.6c.65.2e.6f.72.67.d2.09.2f.74.66.74.70.62.6f.6f.74.77.0f.03.6f.76.6e.03.6f.72.67.00.03.61.62.63.c0.00.2c.08.0a.00.00.07.0a.00.00.08.2e.01.02,pause)
reg2[5] = put_dhcp_opts(offerip=10.0.0.4,router=10.0.0.1,netmask=255.255.254.0,mtu=1400,domain_name="ovn.org",wpad="https://example.org",bootfile_name="https://127.0.0.1/boot.ipxe",path_prefix="/tftpboot",domain_search_list="ovn.org,abc.ovn.org,def.ovn.org,ovn.test,def.ovn.test,test.org,abc.com");
    formats as reg2[5] = put_dhcp_opts(offerip = 10.0.0.4, router = 10.0.0.1, netmask = 255.255.254.0, mtu = 1400, domain_name = "ovn.org", wpad = "https://example.org", bootfile_name = "https://127.0.0.1/boot.ipxe", path_prefix = "/tftpboot", domain_search_list = "ovn.org,abc.ovn.org,def.ovn.org,ovn.test,def.ovn.test,test.org,abc.com");
    encodes as controller(userdata=00.00.00.02.00.00.00.00.00.01.de.10.00.00.00.25.0a.00.00.04.43.1b.68.74.74.70.73.3a.2f.2f.31.32.37.2e.30.2e.30.2e.31.2f.62.6f.6f.74.2e.69.70.78.65.03.04.0a.00.00.01.01.04.ff.ff.fe.00.1a.02.05.78.0f.07.6f.76.6e.2e.6f.72.67.fc.13.68.74.74.70.73.3a.2f.2f.65.78.61.6d.70.6c.65.2e.6f.72.67.d2.09.2f.74.66.74.70.62.6f.6f.74.77.35.03.6f.76.6e.03.6f.72.67.00.03.61.62.63.c0.00.03.64.65.66.c0.00.03.6f.76.6e.04.74.65.73.74.00.03.64.65.66.c0.15.04.74.65.73.74.c0.04.03.61.62.63.03.63.6f.6d.00,pause)
reg2[5] = put_dhcp_opts(offerip=10.0.0.4,router=10.0.0.1,netmask=255.255.254.0,mtu=1400,domain_name="ovn.org",hostname="ip-10-0-0-4");
    formats as reg2[5] = put_dhcp_opts(offerip = 10.0.0.4, router = 10.0.0.1, netmask = 255.255.254.0, mtu = 1400, domain_name = "ovn.org", hostname = "ip-10-0-0-4");
    encodes as controller(userdata=00.00.00.02.00.00.00.00.00.01.de.10.00.00.00.25.0a.00.00.04.03.04.0a.00.00.01.01.04.ff.ff.fe.00.1a.02.05.78.0f.07.6f.76.6e.2e.6f.72.67.0c.0b.69.70.2d.31.30.2d.30.2d.30.2d.34,pause)

reg1[0..1] = put_dhcp_opts(offerip = 1.2.3.4, router = 10.0.0.1);
    Cannot use 2-bit field reg1[0..1] where 1-bit field is required.
reg1[0] = put_dhcp_opts();
    put_dhcp_opts requires offerip to be specified.
reg1[0] = put_dhcp_opts(x = 1.2.3.4, router = 10.0.0.1);
    Syntax error at `x' expecting DHCPv4 option name.
reg1[0] = put_dhcp_opts(router = 10.0.0.1);
    put_dhcp_opts requires offerip to be specified.
reg1[0] = put_dhcp_opts(offerip=1.2.3.4, "hi");
    Syntax error at `"hi"'.
reg1[0] = put_dhcp_opts(offerip=1.2.3.4, xyzzy);
    Syntax error at `xyzzy' expecting DHCPv4 option name.
reg1[0] = put_dhcp_opts(offerip="xyzzy");
    DHCPv4 option offerip requires numeric value.
reg1[0] = put_dhcp_opts(offerip=1.2.3.4, domain_name=1.2.3.4);
    DHCPv4 option domain_name requires string value.
reg1[0] = put_dhcp_opts(offerip=1.2.3.4, domain_search_list=1.2.3.4);
    DHCPv4 option domain_search_list requires string value.

#dhcp_relay_req_chk
reg9[7] = dhcp_relay_req_chk(192.168.1.1, 172.16.1.1);
    encodes as controller(userdata=00.00.00.1c.00.00.00.00.80.01.08.08.00.00.00.07.c0.a8.01.01.ac.10.01.01,pause)

reg9[7] = dhcp_relay_req_chk(192.168.1.1,172.16.1.1);
    formats as reg9[7] = dhcp_relay_req_chk(192.168.1.1, 172.16.1.1);
    encodes as controller(userdata=00.00.00.1c.00.00.00.00.80.01.08.08.00.00.00.07.c0.a8.01.01.ac.10.01.01,pause)

reg9[7..8] = dhcp_relay_req_chk(192.168.1.1, 172.16.1.1);
    Cannot use 2-bit field reg9[7..8] where 1-bit field is required.

reg9[7] = dhcp_relay_req_chk("192.168.1.1", "172.16.1.1");
    Syntax error at `"192.168.1.1"' expecting IPv4 dhcp relay and server ips.

reg9[7] = dhcp_relay_req_chk(192.168.1, 172.16.1.1);
    Invalid numeric constant.

#dhcp_relay_resp_chk
reg9[8] = dhcp_relay_resp_chk(192.168.1.1, 172.16.1.1);
    encodes as controller(userdata=00.00.00.1d.00.00.00.00.80.01.08.08.00.00.00.08.c0.a8.01.01.ac.10.01.01,pause)

reg9[8] = dhcp_relay_resp_chk(192.168.1.1,172.16.1.1);
    formats as reg9[8] = dhcp_relay_resp_chk(192.168.1.1, 172.16.1.1);
    encodes as controller(userdata=00.00.00.1d.00.00.00.00.80.01.08.08.00.00.00.08.c0.a8.01.01.ac.10.01.01,pause)

reg9[7..8] = dhcp_relay_resp_chk(192.168.1.1, 172.16.1.1);
    Cannot use 2-bit field reg9[7..8] where 1-bit field is required.

reg9[8] = dhcp_relay_resp_chk("192.168.1.1", "172.16.1.1");
    Syntax error at `"192.168.1.1"' expecting IPv4 dhcp relay and server ips.

reg9[8] = dhcp_relay_resp_chk(192.168.1, 172.16.1.1);
    Invalid numeric constant.

# nd_ns
nd_ns { nd.target = xxreg0; output; };
    encodes as controller(userdata=00.00.00.09.00.00.00.00.00.1c.00.18.00.80.00.00.00.00.00.00.00.01.de.10.80.00.3e.10.00.00.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00,pause)
    has prereqs ip

nd_ns { };
    formats as nd_ns { drop; };
    encodes as controller(userdata=00.00.00.09.00.00.00.00,pause)
    has prereqs ip

# nd_na
nd_na { eth.src = 12:34:56:78:9a:bc; nd.tll = 12:34:56:78:9a:bc; outport = inport; inport = ""; /* Allow sending out inport. */ output; };
    formats as nd_na { eth.src = 12:34:56:78:9a:bc; nd.tll = 12:34:56:78:9a:bc; outport = inport; inport = ""; output; };
    encodes as controller(userdata=00.00.00.03.00.00.00.00.00.19.00.10.80.00.08.06.12.34.56.78.9a.bc.00.00.00.19.00.10.80.00.42.06.12.34.56.78.9a.bc.00.00.00.1c.00.18.00.20.00.00.00.00.00.00.00.01.1c.04.00.01.1e.04.00.00.00.00.00.19.00.10.00.01.1c.04.00.00.00.00.00.00.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00)
    has prereqs nd_ns
# nd_na_router
nd_na_router { eth.src = 12:34:56:78:9a:bc; nd.tll = 12:34:56:78:9a:bc; outport = inport; inport = ""; /* Allow sending out inport. */ output; };
    formats as nd_na_router { eth.src = 12:34:56:78:9a:bc; nd.tll = 12:34:56:78:9a:bc; outport = inport; inport = ""; output; };
    encodes as controller(userdata=00.00.00.0c.00.00.00.00.00.19.00.10.80.00.08.06.12.34.56.78.9a.bc.00.00.00.19.00.10.80.00.42.06.12.34.56.78.9a.bc.00.00.00.1c.00.18.00.20.00.00.00.00.00.00.00.01.1c.04.00.01.1e.04.00.00.00.00.00.19.00.10.00.01.1c.04.00.00.00.00.00.00.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00)
    has prereqs nd_ns

# get_nd
get_nd(outport, ip6.dst);
    encodes as push:NXM_NX_XXREG1[],push:NXM_NX_IPV6_DST[],pop:NXM_NX_XXREG1[],set_field:00:00:00:00:00:00->eth_dst,resubmit(,66),pop:NXM_NX_XXREG1[]
    has prereqs eth.type == 0x86dd
get_nd(inport, xxreg0);
    encodes as push:NXM_NX_REG15[],push:NXM_NX_XXREG1[],push:NXM_NX_XXREG0[],push:NXM_NX_REG14[],pop:NXM_NX_REG15[],pop:NXM_NX_XXREG1[],set_field:00:00:00:00:00:00->eth_dst,resubmit(,66),pop:NXM_NX_XXREG1[],pop:NXM_NX_REG15[]
get_nd;
    Syntax error at `;' expecting `('.
get_nd();
    Syntax error at `)' expecting field name.
get_nd(inport);
    Syntax error at `)' expecting `,'.
get_nd(inport ip6.dst);
    Syntax error at `ip6.dst' expecting `,'.
get_nd(inport, ip6.dst;
    Syntax error at `;' expecting `)'.
get_nd(inport, eth.dst);
    Cannot use 48-bit field eth.dst[0..47] where 128-bit field is required.
get_nd(inport, outport);
    Cannot use string field outport where numeric field is required.
get_nd(xxreg0, ip6.dst);
    Cannot use numeric field xxreg0 where string field is required.

# put_nd
put_nd(inport, nd.target, nd.sll);
    encodes as push:NXM_NX_XXREG0[],push:NXM_OF_ETH_SRC[],push:NXM_NX_ND_SLL[],push:NXM_NX_ND_TARGET[],pop:NXM_NX_XXREG0[],pop:NXM_OF_ETH_SRC[],controller(userdata=00.00.00.04.00.00.00.00),pop:NXM_OF_ETH_SRC[],pop:NXM_NX_XXREG0[]
    has prereqs (icmp6.type == 0x87 || icmp6.type == 0x88) && eth.type == 0x86dd && ip.proto == 0x3a && (eth.type == 0x800 || eth.type == 0x86dd) && icmp6.code == 0 && eth.type == 0x86dd && ip.proto == 0x3a && (eth.type == 0x800 || eth.type == 0x86dd) && ip.ttl == 0xff && (eth.type == 0x800 || eth.type == 0x86dd) && icmp6.type == 0x87 && eth.type == 0x86dd && ip.proto == 0x3a && (eth.type == 0x800 || eth.type == 0x86dd) && icmp6.code == 0 && eth.type == 0x86dd && ip.proto == 0x3a && (eth.type == 0x800 || eth.type == 0x86dd) && ip.ttl == 0xff && (eth.type == 0x800 || eth.type == 0x86dd)

# put_dhcpv6_opts
reg1[0] = put_dhcpv6_opts(ia_addr = ae70::4, server_id = 00:00:00:00:10:02);
    encodes as controller(userdata=00.00.00.05.00.00.00.00.00.01.de.10.00.00.00.40.00.05.00.10.ae.70.00.00.00.00.00.00.00.00.00.00.00.00.00.04.00.02.00.06.00.00.00.00.10.02,pause)
reg1[0] = put_dhcpv6_opts();
    encodes as controller(userdata=00.00.00.05.00.00.00.00.00.01.de.10.00.00.00.40,pause)
reg1[0] = put_dhcpv6_opts(dns_server={ae70::1,ae70::2});
    formats as reg1[0] = put_dhcpv6_opts(dns_server = {ae70::1, ae70::2});
    encodes as controller(userdata=00.00.00.05.00.00.00.00.00.01.de.10.00.00.00.40.00.17.00.20.ae.70.00.00.00.00.00.00.00.00.00.00.00.00.00.01.ae.70.00.00.00.00.00.00.00.00.00.00.00.00.00.02,pause)
reg1[0] = put_dhcpv6_opts(server_id=12:34:56:78:9a:bc, dns_server={ae70::1,ae89::2});
    formats as reg1[0] = put_dhcpv6_opts(server_id = 12:34:56:78:9a:bc, dns_server = {ae70::1, ae89::2});
    encodes as controller(userdata=00.00.00.05.00.00.00.00.00.01.de.10.00.00.00.40.00.02.00.06.12.34.56.78.9a.bc.00.17.00.20.ae.70.00.00.00.00.00.00.00.00.00.00.00.00.00.01.ae.89.00.00.00.00.00.00.00.00.00.00.00.00.00.02,pause)
reg1[0] = put_dhcpv6_opts(domain_search = "ovn.org");
    encodes as controller(userdata=00.00.00.05.00.00.00.00.00.01.de.10.00.00.00.40.00.18.00.07.6f.76.6e.2e.6f.72.67,pause)
reg1[0] = put_dhcpv6_opts(x = 1.2.3.4);
    Syntax error at `x' expecting DHCPv6 option name.
reg1[0] = put_dhcpv6_opts(ia_addr=ae70::4, "hi");
    Syntax error at `"hi"'.
reg1[0] = put_dhcpv6_opts(ia_addr=ae70::4, xyzzy);
    Syntax error at `xyzzy' expecting DHCPv6 option name.
reg1[0] = put_dhcpv6_opts(ia_addr="ae70::4");
    DHCPv6 option ia_addr requires numeric value.
reg1[0] = put_dhcpv6_opts(ia_addr=ae70::4, domain_search=ae70::1);
    DHCPv6 option domain_search requires string value.
reg1[0] = put_dhcpv6_opts(bootfile_name="https://127.0.0.1/boot.ipxe");
    formats as reg1[0] = put_dhcpv6_opts(bootfile_name = "https://127.0.0.1/boot.ipxe");
    encodes as controller(userdata=00.00.00.05.00.00.00.00.00.01.de.10.00.00.00.40.00.3b.00.1b.68.74.74.70.73.3a.2f.2f.31.32.37.2e.30.2e.30.2e.31.2f.62.6f.6f.74.2e.69.70.78.65,pause)
reg1[0] = put_dhcpv6_opts(bootfile_name_alt="https://127.0.0.1/boot.ipxe");
    formats as reg1[0] = put_dhcpv6_opts(bootfile_name_alt = "https://127.0.0.1/boot.ipxe");
    encodes as controller(userdata=00.00.00.05.00.00.00.00.00.01.de.10.00.00.00.40.00.fe.00.1b.68.74.74.70.73.3a.2f.2f.31.32.37.2e.30.2e.30.2e.31.2f.62.6f.6f.74.2e.69.70.78.65,pause)
reg1[0] = put_dhcpv6_opts(fqdn="ovn.org");
    formats as reg1[0] = put_dhcpv6_opts(fqdn = "ovn.org");
    encodes as controller(userdata=00.00.00.05.00.00.00.00.00.01.de.10.00.00.00.40.00.27.00.09.03.6f.76.6e.03.6f.72.67.00,pause)

# lookup_nd
reg2[0] = lookup_nd(inport, ip6.dst, eth.src);
    encodes as push:NXM_NX_XXREG0[],push:NXM_NX_IPV6_DST[],pop:NXM_NX_XXREG0[],set_field:0/0x40->reg10,resubmit(,67),move:NXM_NX_REG10[6]->NXM_NX_XXREG0[32],pop:NXM_NX_XXREG0[]
    has prereqs eth.type == 0x86dd
reg3[0] = lookup_nd(inport, nd.target, nd.tll);
    encodes as push:NXM_NX_XXREG0[],push:NXM_OF_ETH_SRC[],push:NXM_NX_ND_TLL[],push:NXM_NX_ND_TARGET[],pop:NXM_NX_XXREG0[],pop:NXM_OF_ETH_SRC[],set_field:0/0x40->reg10,resubmit(,67),move:NXM_NX_REG10[6]->NXM_NX_XXREG0[0],pop:NXM_OF_ETH_SRC[],pop:NXM_NX_XXREG0[]
    has prereqs (icmp6.type == 0x87 || icmp6.type == 0x88) && eth.type == 0x86dd && ip.proto == 0x3a && (eth.type == 0x800 || eth.type == 0x86dd) && icmp6.code == 0 && eth.type == 0x86dd && ip.proto == 0x3a && (eth.type == 0x800 || eth.type == 0x86dd) && ip.ttl == 0xff && (eth.type == 0x800 || eth.type == 0x86dd) && icmp6.type == 0x88 && eth.type == 0x86dd && ip.proto == 0x3a && (eth.type == 0x800 || eth.type == 0x86dd) && icmp6.code == 0 && eth.type == 0x86dd && ip.proto == 0x3a && (eth.type == 0x800 || eth.type == 0x86dd) && ip.ttl == 0xff && (eth.type == 0x800 || eth.type == 0x86dd)

lookup_nd;
    Syntax error at `lookup_nd' expecting action.
reg0[0] = lookup_nd;
    Syntax error at `lookup_nd' expecting field name.
reg0[0] = lookup_nd();
    Syntax error at `)' expecting field name.
reg0[0] = lookup_nd(inport);
    Syntax error at `)' expecting `,'.
reg0[0] = lookup_nd(inport ip6.dst);
    Syntax error at `ip6.dst' expecting `,'.
reg0[0] = lookup_nd(inport, ip6.dst;
    Syntax error at `;' expecting `,'.
reg0[0] = lookup_nd(inport, ip6.dst, eth.src;
    Syntax error at `;' expecting `)'.
reg0[0] = lookup_nd(inport, eth.dst);
    Cannot use 48-bit field eth.dst[0..47] where 128-bit field is required.
reg0[0] = lookup_nd(inport, ip4.src, ip4.dst);
    Cannot use 32-bit field ip4.src[0..31] where 128-bit field is required.
reg0[0] = lookup_nd(inport, ip6.src, ip6.dst);
    Cannot use 128-bit field ip6.dst[0..127] where 48-bit field is required.

# lookup_nd_ip
reg2[0] = lookup_nd_ip(inport, ip6.dst);
    encodes as push:NXM_NX_REG15[],push:NXM_NX_XXREG1[],push:NXM_NX_IPV6_DST[],push:NXM_NX_REG14[],pop:NXM_NX_REG15[],pop:NXM_NX_XXREG1[],push:NXM_OF_ETH_DST[],set_field:0/0x40->reg10,resubmit(,66),move:NXM_NX_REG10[6]->NXM_NX_XXREG0[32],pop:NXM_OF_ETH_DST[],pop:NXM_NX_XXREG1[],pop:NXM_NX_REG15[]
    has prereqs eth.type == 0x86dd
reg3[0] = lookup_nd_ip(inport, nd.target);
    encodes as push:NXM_NX_REG15[],push:NXM_NX_XXREG1[],push:NXM_NX_ND_TARGET[],push:NXM_NX_REG14[],pop:NXM_NX_REG15[],pop:NXM_NX_XXREG1[],push:NXM_OF_ETH_DST[],set_field:0/0x40->reg10,resubmit(,66),move:NXM_NX_REG10[6]->NXM_NX_XXREG0[0],pop:NXM_OF_ETH_DST[],pop:NXM_NX_XXREG1[],pop:NXM_NX_REG15[]
    has prereqs (icmp6.type == 0x87 || icmp6.type == 0x88) && eth.type == 0x86dd && ip.proto == 0x3a && (eth.type == 0x800 || eth.type == 0x86dd) && icmp6.code == 0 && eth.type == 0x86dd && ip.proto == 0x3a && (eth.type == 0x800 || eth.type == 0x86dd) && ip.ttl == 0xff && (eth.type == 0x800 || eth.type == 0x86dd)

lookup_nd_ip;
    Syntax error at `lookup_nd_ip' expecting action.
reg0[0] = lookup_nd_ip;
    Syntax error at `lookup_nd_ip' expecting field name.
reg0[0] = lookup_nd_ip();
    Syntax error at `)' expecting field name.
reg0[0] = lookup_nd_ip(inport);
    Syntax error at `)' expecting `,'.
reg0[0] = lookup_nd_ip(inport ip6.dst);
    Syntax error at `ip6.dst' expecting `,'.
reg0[0] = lookup_nd_ip(inport, ip6.dst;
    Syntax error at `;' expecting `)'.
reg0[0] = lookup_nd_ip(inport, eth.dst);
    Cannot use 48-bit field eth.dst[0..47] where 128-bit field is required.
reg0[0] = lookup_nd_ip(inport, ip4.src);
    Cannot use 32-bit field ip4.src[0..31] where 128-bit field is required.

# set_queue
set_queue(0);
    encodes as set_queue:0
set_queue(61440);
    encodes as set_queue:61440
set_queue(65535);
    Queue ID 65535 for set_queue is not in valid range 0 to 61440.

# dns_lookup
reg1[0] = dns_lookup();
    encodes as controller(userdata=00.00.00.06.00.00.00.00.00.01.de.10.00.00.00.40,pause)
    has prereqs udp
reg1[0] = dns_lookup("foo");
    dns_lookup doesn't take any parameters

# set_meter
set_meter(0);
    Rate 0 for set_meter is not in valid.
set_meter(1);
    encodes as meter:1
set_meter(100, 1000);
    encodes as meter:2
set_meter(100, 1000, );
    Syntax error at `,' expecting `)'.
set_meter(4294967295, 4294967295);
    encodes as meter:3

# log
log(verdict=allow, severity=warning);
    encodes as controller(userdata=00.00.00.07.00.00.00.00.00.04)
log(name="test1", verdict=drop, severity=info);
    encodes as controller(userdata=00.00.00.07.00.00.00.00.01.06.74.65.73.74.31)
log(verdict=drop, severity=info, meter="meter1");
    encodes as controller(userdata=00.00.00.07.00.00.00.00.01.06)
log(name="test1", verdict=drop, severity=info, meter="meter1");
    encodes as controller(userdata=00.00.00.07.00.00.00.00.01.06.74.65.73.74.31)
log(verdict=drop);
    formats as log(verdict=drop, severity=info);
    encodes as controller(userdata=00.00.00.07.00.00.00.00.01.06)
log(verdict=pass);
    formats as log(verdict=pass, severity=info);
    encodes as controller(userdata=00.00.00.07.00.00.00.00.03.06)
log(verdict=bad_verdict, severity=info);
    Syntax error at `bad_verdict' unknown verdict.
log(verdict=drop, severity=bad_severity);
    Syntax error at `bad_severity' unknown severity.
log(severity=notice);
    Syntax error at `;' expecting verdict.

# put_nd_ra_opts
reg1[0] = put_nd_ra_opts(addr_mode = "slaac", mtu = 1500, router_preference = "HIGH", prefix = aef0::/64, slla = ae:01:02:03:04:05);
    encodes as controller(userdata=00.00.00.08.00.00.00.00.00.01.de.10.00.00.00.40.86.00.00.00.ff.08.ff.ff.00.00.00.00.00.00.00.00.05.01.00.00.00.00.05.dc.03.04.40.c0.ff.ff.ff.ff.ff.ff.ff.ff.00.00.00.00.ae.f0.00.00.00.00.00.00.00.00.00.00.00.00.00.00.01.01.ae.01.02.03.04.05,pause)
    has prereqs ip6
reg1[0] = put_nd_ra_opts(addr_mode = "dhcpv6_stateful", router_preference = "MEDIUM", slla = ae:01:02:03:04:10, mtu = 1450);
    encodes as controller(userdata=00.00.00.08.00.00.00.00.00.01.de.10.00.00.00.40.86.00.00.00.ff.80.ff.ff.00.00.00.00.00.00.00.00.01.01.ae.01.02.03.04.10.05.01.00.00.00.00.05.aa,pause)
    has prereqs ip6
reg1[0] = put_nd_ra_opts(addr_mode = "dhcpv6_stateless", router_preference = "LOW", slla = ae:01:02:03:04:06, prefix = aef0::/64);
    encodes as controller(userdata=00.00.00.08.00.00.00.00.00.01.de.10.00.00.00.40.86.00.00.00.ff.58.ff.ff.00.00.00.00.00.00.00.00.01.01.ae.01.02.03.04.06.03.04.40.c0.ff.ff.ff.ff.ff.ff.ff.ff.00.00.00.00.ae.f0.00.00.00.00.00.00.00.00.00.00.00.00.00.00,pause)
    has prereqs ip6
reg1[0] = put_nd_ra_opts(addr_mode = "slaac", mtu = 1500, prefix = aef0::/64);
    slla option not present
reg1[0] = put_nd_ra_opts(addr_mode = "dhcpv6_stateful", mtu = 1450, prefix = aef0::/64, prefix = bef0::/64, slla = ae:01:02:03:04:10);
    encodes as controller(userdata=00.00.00.08.00.00.00.00.00.01.de.10.00.00.00.40.86.00.00.00.ff.80.ff.ff.00.00.00.00.00.00.00.00.05.01.00.00.00.00.05.aa.03.04.40.80.ff.ff.ff.ff.ff.ff.ff.ff.00.00.00.00.ae.f0.00.00.00.00.00.00.00.00.00.00.00.00.00.00.03.04.40.80.ff.ff.ff.ff.ff.ff.ff.ff.00.00.00.00.be.f0.00.00.00.00.00.00.00.00.00.00.00.00.00.00.01.01.ae.01.02.03.04.10,pause)
    has prereqs ip6
reg1[0] = put_nd_ra_opts(addr_mode = "dhcpv6_stateful", mtu = 1450, prefix = aef0::/64, prefix = bef0::/64, slla = ae:01:02:03:04:10);
    encodes as controller(userdata=00.00.00.08.00.00.00.00.00.01.de.10.00.00.00.40.86.00.00.00.ff.80.ff.ff.00.00.00.00.00.00.00.00.05.01.00.00.00.00.05.aa.03.04.40.80.ff.ff.ff.ff.ff.ff.ff.ff.00.00.00.00.ae.f0.00.00.00.00.00.00.00.00.00.00.00.00.00.00.03.04.40.80.ff.ff.ff.ff.ff.ff.ff.ff.00.00.00.00.be.f0.00.00.00.00.00.00.00.00.00.00.00.00.00.00.01.01.ae.01.02.03.04.10,pause)
    has prereqs ip6
reg1[0] = put_nd_ra_opts(addr_mode = "slaac", slla = ae:01:02:03:04:10);
    prefix option needs to be set when address mode is slaac/dhcpv6_stateless.
reg1[0] = put_nd_ra_opts(addr_mode = "dhcpv6_stateless", slla = ae:01:02:03:04:10);
    prefix option needs to be set when address mode is slaac/dhcpv6_stateless.
reg1[0] = put_nd_ra_opts(addr_mode = dhcpv6_stateless, prefix = aef0::/64, slla = ae:01:02:03:04:10);
    Syntax error at `dhcpv6_stateless' expecting constant.
reg1[0] = put_nd_ra_opts(addr_mode = "slaac", mtu = 1500, prefix = aef0::, slla = ae:01:02:03:04:10);
    Invalid value for "prefix" option
reg1[0] = put_nd_ra_opts(addr_mode = "foo", mtu = 1500, slla = ae:01:02:03:04:10);
    Invalid value for "addr_mode" option
reg1[0] = put_nd_ra_opts(addr_mode = "slaac", mtu = "1500", slla = ae:01:02:03:04:10);
    IPv6 ND RA option mtu requires numeric value.
reg1[0] = put_nd_ra_opts(addr_mode = "slaac", mtu = 10.0.0.4, slla = ae:01:02:03:04:10);
    Invalid value for "mtu" option

# icmp4
icmp4 { eth.dst = ff:ff:ff:ff:ff:ff; output; }; output;
    encodes as controller(userdata=00.00.00.0a.00.00.00.00.00.19.00.10.80.00.06.06.ff.ff.ff.ff.ff.ff.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00),resubmit(,64)
    has prereqs ip4

icmp4 { };
    formats as icmp4 { drop; };
    encodes as controller(userdata=00.00.00.0a.00.00.00.00)
    has prereqs ip4

# icmp4 with icmp4.frag_mtu
icmp4 { eth.dst = ff:ff:ff:ff:ff:ff; icmp4.frag_mtu = 1500; output; }; output;
    encodes as controller(userdata=00.00.00.0a.00.00.00.00.00.19.00.10.80.00.06.06.ff.ff.ff.ff.ff.ff.00.00.ff.ff.00.18.00.00.23.20.00.08.6f.76.6e.00.00.00.00.00.05.dc.00.00.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00),resubmit(,64)
    has prereqs ip4

# icmp4_error
icmp4_error { eth.dst = ff:ff:ff:ff:ff:ff; output; }; output;
    encodes as controller(userdata=00.00.00.0e.00.00.00.00.00.19.00.10.80.00.06.06.ff.ff.ff.ff.ff.ff.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00),resubmit(,64)
    has prereqs ip4

icmp4_error { };
    formats as icmp4_error { drop; };
    encodes as controller(userdata=00.00.00.0e.00.00.00.00)
    has prereqs ip4

# icmp4_error with icmp4.frag_mtu
icmp4_error { eth.dst = ff:ff:ff:ff:ff:ff; icmp4.frag_mtu = 1500; output; }; output;
    encodes as controller(userdata=00.00.00.0e.00.00.00.00.00.19.00.10.80.00.06.06.ff.ff.ff.ff.ff.ff.00.00.ff.ff.00.18.00.00.23.20.00.08.6f.76.6e.00.00.00.00.00.05.dc.00.00.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00),resubmit(,64)
    has prereqs ip4

icmp4.frag_mtu = 1500;
    encodes as note:6f.76.6e.00.00.00.00.00.05.dc

# icmp6
icmp6 { eth.dst = ff:ff:ff:ff:ff:ff; output; }; output;
    encodes as controller(userdata=00.00.00.0a.00.00.00.00.00.19.00.10.80.00.06.06.ff.ff.ff.ff.ff.ff.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00),resubmit(,64)
    has prereqs ip6

icmp6 { };
    formats as icmp6 { drop; };
    encodes as controller(userdata=00.00.00.0a.00.00.00.00)
    has prereqs ip6

# icmp6_error
icmp6_error { eth.dst = ff:ff:ff:ff:ff:ff; output; }; output;
    encodes as controller(userdata=00.00.00.14.00.00.00.00.00.19.00.10.80.00.06.06.ff.ff.ff.ff.ff.ff.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00),resubmit(,64)
    has prereqs ip6

icmp6_error { };
    formats as icmp6_error { drop; };
    encodes as controller(userdata=00.00.00.14.00.00.00.00)
    has prereqs ip6

# icmp6_error with icmp6.frag_mtu
icmp6_error { eth.dst = ff:ff:ff:ff:ff:ff; icmp6.frag_mtu = 1500; output; }; output;
    encodes as controller(userdata=00.00.00.14.00.00.00.00.00.19.00.10.80.00.06.06.ff.ff.ff.ff.ff.ff.00.00.ff.ff.00.18.00.00.23.20.00.08.6f.76.6e.00.00.01.00.00.00.00.05.dc.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00),resubmit(,64)
    has prereqs ip6

icmp6.frag_mtu = 1500;
    encodes as note:6f.76.6e.00.00.01.00.00.00.00.05.dc

# tcp_reset
tcp_reset { eth.dst = ff:ff:ff:ff:ff:ff; output; }; output;
    encodes as controller(userdata=00.00.00.0b.00.00.00.00.00.19.00.10.80.00.06.06.ff.ff.ff.ff.ff.ff.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00),resubmit(,64)
    has prereqs tcp

tcp_reset { };
    formats as tcp_reset { drop; };
    encodes as controller(userdata=00.00.00.0b.00.00.00.00)
    has prereqs tcp

# sctp_abort
sctp_abort {eth.dst = ff:ff:ff:ff:ff:ff; output; }; output;
    formats as sctp_abort { eth.dst = ff:ff:ff:ff:ff:ff; output; }; output;
    encodes as controller(userdata=00.00.00.18.00.00.00.00.00.19.00.10.80.00.06.06.ff.ff.ff.ff.ff.ff.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00),resubmit(,64)
    has prereqs sctp

sctp_abort { };
    formats as sctp_abort { drop; };
    encodes as controller(userdata=00.00.00.18.00.00.00.00)
    has prereqs sctp

# reject
reject { eth.dst = ff:ff:ff:ff:ff:ff; output; }; output;
    encodes as controller(userdata=00.00.00.16.00.00.00.00.00.19.00.10.80.00.06.06.ff.ff.ff.ff.ff.ff.00.00.ff.ff.00.10.00.00.23.20.00.0e.ff.f8.40.00.00.00),resubmit(,64)

reject { };
    formats as reject { drop; };
    encodes as controller(userdata=00.00.00.16.00.00.00.00)

# trigger_event
trigger_event(event = "empty_lb_backends", vip = "10.0.0.1:80", protocol = "tcp", load_balancer = "12345678-abcd-9876-fedc-11119f8e7d6c");
    encodes as controller(userdata=00.00.00.0f.00.00.00.00.00.00.00.00.00.01.00.0b.31.30.2e.30.2e.30.2e.31.3a.38.30.00.02.00.03.74.63.70.00.03.00.24.31.32.33.34.35.36.37.38.2d.61.62.63.64.2d.39.38.37.36.2d.66.65.64.63.2d.31.31.31.31.39.66.38.65.37.64.36.63)

# Testing invalid vip results in extra error messages from socket-util.c
trigger_event(event = "empty_lb_backends", vip = "10.0.0.1:80", protocol = "aarp", load_balancer = "12345678-abcd-9876-fedc-11119f8e7d6c");
    Load balancer protocol 'aarp' is not 'tcp', 'udp', or 'sctp'
trigger_event(event = "empty_lb_backends", vip = "10.0.0.1:80", protocol = "tcp", load_balancer = "bacon");
    Load balancer 'bacon' is not a UUID

# IGMP
igmp;
    encodes as controller(userdata=00.00.00.10.00.00.00.00)

# Contradictionary prerequisites (allowed but not useful):
ip4.src = ip6.src[0..31];
    encodes as move:NXM_NX_IPV6_SRC[0..31]->NXM_OF_IP_SRC[]
    has prereqs eth.type == 0x800 && eth.type == 0x86dd
ip4.src <-> ip6.src[0..31];
    encodes as push:NXM_NX_IPV6_SRC[0..31],push:NXM_OF_IP_SRC[],pop:NXM_NX_IPV6_SRC[0..31],pop:NXM_OF_IP_SRC[]
    has prereqs eth.type == 0x800 && eth.type == 0x86dd

# check_pkt_larger
reg0[0] = check_pkt_larger(1500);
    encodes as check_pkt_larger(1500)->NXM_NX_XXREG0[96]

reg0 = check_pkt_larger(1500);
    Cannot use 32-bit field reg0[0..31] where 1-bit field is required.

reg0 = check_pkt_larger(foo);
    Cannot use 32-bit field reg0[0..31] where 1-bit field is required.

reg0[0] = check_pkt_larger(foo);
    Syntax error at `foo' expecting `;'.

# bind_vport
# lsp1's port key is 0x11.
bind_vport("lsp1", inport);
    encodes as controller(userdata=00.00.00.11.00.00.00.00.00.00.00.11)
# lsp2 doesn't exist. So it should be encoded as drop.
bind_vport("lsp2", inport);
    encodes as drop
bind_vport;
    Syntax error at `;' expecting `('.
bind_vport(;
    Syntax error at `;' expecting port name string.
bind_vport("xyzzy";
    Syntax error at `;' expecting `,'.
bind_vport("xyzzy",;
    Syntax error at `;' expecting field name.
bind_vport("xyzzy", inport;
    Syntax error at `;' expecting `)'.

# handle_svc_check
handle_svc_check(inport);
    encodes as controller(userdata=00.00.00.12.00.00.00.00)

handle_svc_check(outport);
    encodes as push:NXM_NX_REG14[],push:NXM_NX_REG15[],pop:NXM_NX_REG14[],controller(userdata=00.00.00.12.00.00.00.00),pop:NXM_NX_REG14[]

handle_svc_check();
    Syntax error at `)' expecting field name.

handle_svc_check(reg0);
    Cannot use numeric field reg0 where string field is required.

# select
reg9[16..31] = select(1=50, 2=100, 3, );
    formats as reg9[16..31] = select(1=50, 2=100, 3=100);
    encodes as group:19
    uses group: id(19), name(type=select,selection_method=dp_hash,bucket=bucket_id=0,weight:50,actions=load:1->xreg4[16..31],resubmit(,19),bucket=bucket_id=1,weight:100,actions=load:2->xreg4[16..31],resubmit(,19),bucket=bucket_id=2,weight:100,actions=load:3->xreg4[16..31],resubmit(,19))

reg0 = select(1, 2);
    formats as reg0 = select(1=100, 2=100);
    encodes as group:20
    uses group: id(20), name(type=select,selection_method=dp_hash,bucket=bucket_id=0,weight:100,actions=load:1->xxreg0[96..127],resubmit(,19),bucket=bucket_id=1,weight:100,actions=load:2->xxreg0[96..127],resubmit(,19))

reg9[16..31] = select(values=(1=50, 2=100, 3); hash_fields="ip_src,ip_dst");
    formats as reg9[16..31] = select(values=(1=50, 2=100, 3=100); hash_fields="ip_src,ip_dst");
    encodes as group:21
    uses group: id(21), name(type=select,selection_method=hash,fields(ip_src,ip_dst),bucket=bucket_id=0,weight:50,actions=load:1->xreg4[16..31],resubmit(,19),bucket=bucket_id=1,weight:100,actions=load:2->xreg4[16..31],resubmit(,19),bucket=bucket_id=2,weight:100,actions=load:3->xreg4[16..31],resubmit(,19))

reg0 = select(values=(1, 2); hash_fields="ip_dst,ip_src");
    formats as reg0 = select(values=(1=100, 2=100); hash_fields="ip_dst,ip_src");
    encodes as group:22
    uses group: id(22), name(type=select,selection_method=hash,fields(ip_dst,ip_src),bucket=bucket_id=0,weight:100,actions=load:1->xxreg0[96..127],resubmit(,19),bucket=bucket_id=1,weight:100,actions=load:2->xxreg0[96..127],resubmit(,19))

reg0 = select(1=, 2);
    Syntax error at `,' expecting weight.
reg0 = select(1=0, 2);
    Syntax error at `,' weight can't be 0.
reg0 = select(1=123456, 2);
    Syntax error at `123456' expecting weight.
reg0 = select(123);
    Syntax error at `;' expecting at least 2 group members.
reg0 = select(values=1, 2);
    Syntax error at `1' expecting `('.
reg0 = select(values=(1, 2); test_fields="hello,world");
    Syntax error at `test_fields' expecting hash_fields.
reg0 = select(values=(1, 2); hash_fields);
    Syntax error at `)' invalid hash_fields.
reg0 = select(values=(1, 2); hash_fields=);
    Syntax error at `)' invalid hash_fields.
ip.proto = select(1, 2, 3);
    Field ip.proto is not modifiable.
reg0[0..14] = select(1, 2, 3);
    cannot use 15-bit field reg0[0..14] for "select", which requires at least 16 bits.

fwd_group(liveness=true, childports="eth0", "lsp1");
    formats as fwd_group(liveness="true", childports="eth0", "lsp1");
    encodes as group:23
    uses group: id(23), name(type=select,selection_method=dp_hash,bucket=watch_port:5,load=0x5->NXM_NX_REG15[0..15],resubmit(,64),bucket=watch_port:17,load=0x17->NXM_NX_REG15[0..15],resubmit(,64))

fwd_group(childports="eth0", "lsp1");
    encodes as group:24
    uses group: id(24), name(type=select,selection_method=dp_hash,bucket=load=0x5->NXM_NX_REG15[0..15],resubmit(,64),bucket=load=0x17->NXM_NX_REG15[0..15],resubmit(,64))

fwd_group(childports=eth0);
    Syntax error at `eth0' expecting logical switch port.

fwd_group();
    Syntax error at `)' expecting `;'.

fwd_group(childports="eth0", "lsp1");
    encodes as group:24
    uses group: id(24), name(type=select,selection_method=dp_hash,bucket=load=0x5->NXM_NX_REG15[0..15],resubmit(,64),bucket=load=0x17->NXM_NX_REG15[0..15],resubmit(,64))

fwd_group(liveness=xyzzy, childports="eth0", "lsp1");
    Syntax error at `xyzzy' expecting true or false.

fwd_group(liveness=false childports="eth0", "lsp1");
    Syntax error at `childports' expecting `,'.

# prefix delegation
handle_dhcpv6_reply;
    encodes as controller(userdata=00.00.00.13.00.00.00.00)

# chk_lb_hairpin
reg0[0] = chk_lb_hairpin();
    encodes as set_field:0/0x80->reg10,resubmit(,68),move:NXM_NX_REG10[7]->NXM_NX_XXREG0[96]

reg2[2] = chk_lb_hairpin();
    encodes as set_field:0/0x80->reg10,resubmit(,68),move:NXM_NX_REG10[7]->NXM_NX_XXREG0[34]

reg0 = chk_lb_hairpin();
    Cannot use 32-bit field reg0[0..31] where 1-bit field is required.

reg0[0] = chk_lb_hairpin(foo);
    chk_lb_hairpin doesn't take any parameters

chk_lb_hairpin;
    Syntax error at `chk_lb_hairpin' expecting action.

# chk_lb_hairpin_reply
reg0[0] = chk_lb_hairpin_reply();
    encodes as set_field:0/0x80->reg10,resubmit(,69),move:NXM_NX_REG10[7]->NXM_NX_XXREG0[96]

reg2[2..3] = chk_lb_hairpin_reply();
    Cannot use 2-bit field reg2[2..3] where 1-bit field is required.

reg0 = chk_lb_hairpin_reply();
    Cannot use 32-bit field reg0[0..31] where 1-bit field is required.

reg0[0] = chk_lb_hairpin_reply(foo);
    chk_lb_hairpin_reply doesn't take any parameters

chk_lb_hairpin_reply;
    Syntax error at `chk_lb_hairpin_reply' expecting action.

# ct_snat_to_vip
ct_snat_to_vip;
    encodes as resubmit(,70)

ct_snat_to_vip(foo);
    Syntax error at `(' expecting `;'.

# bfd packets
handle_bfd_msg();
    encodes as controller(userdata=00.00.00.17.00.00.00.00)

# put_fdb
put_fdb(inport, arp.sha);
    encodes as push:NXM_OF_ETH_SRC[],push:NXM_NX_ARP_SHA[],pop:NXM_OF_ETH_SRC[],controller(userdata=00.00.00.19.00.00.00.00),pop:NXM_OF_ETH_SRC[]
    has prereqs eth.type == 0x806

put_fdb(inport, eth.src);
    encodes as controller(userdata=00.00.00.19.00.00.00.00)

put_fdb(inport, ip4.src);
    Cannot use 32-bit field ip4.src[0..31] where 48-bit field is required.

# get_fdb
outport = get_fdb(eth.dst);
    encodes as set_field:0->reg15,resubmit(,71)

outport = get_fdb(eth.src);
    encodes as push:NXM_OF_ETH_DST[],push:NXM_OF_ETH_SRC[],pop:NXM_OF_ETH_DST[],set_field:0->reg15,resubmit(,71),pop:NXM_OF_ETH_DST[]

inport = get_fdb(arp.sha);
    encodes as push:NXM_OF_ETH_DST[],push:NXM_NX_ARP_SHA[],pop:NXM_OF_ETH_DST[],set_field:0->reg15,resubmit(,71),pop:NXM_OF_ETH_DST[],move:NXM_NX_REG15[]->NXM_NX_REG14[]
    has prereqs eth.type == 0x806

reg0 = get_fdb(arp.tha);
    encodes as push:NXM_OF_ETH_DST[],push:NXM_NX_ARP_THA[],pop:NXM_OF_ETH_DST[],set_field:0->reg15,resubmit(,71),pop:NXM_OF_ETH_DST[],move:NXM_NX_REG15[]->NXM_NX_XXREG0[96..127]
    has prereqs eth.type == 0x806

reg0[1..3] = get_fdb(eth.src);
    Cannot use 3-bit field reg0[1..3] where 32-bit field is required.

reg15 = get_fdb(eth.dst);
    Syntax error at `reg15' expecting field name.

outport = get_fdb(ip4.dst);
    Cannot use 32-bit field ip4.dst[0..31] where 48-bit field is required.

# lookup_fdb
reg0[0] = lookup_fdb(inport, eth.src);
    encodes as set_field:0/0x100->reg10,resubmit(,72),move:NXM_NX_REG10[8]->NXM_NX_XXREG0[96]

reg1[4] = lookup_fdb(outport, eth.dst);
    encodes as push:NXM_NX_REG14[],push:NXM_OF_ETH_SRC[],push:NXM_OF_ETH_DST[],push:NXM_NX_REG15[],pop:NXM_NX_REG14[],pop:NXM_OF_ETH_SRC[],set_field:0/0x100->reg10,resubmit(,72),pop:NXM_OF_ETH_SRC[],pop:NXM_NX_REG14[],move:NXM_NX_REG10[8]->NXM_NX_XXREG0[68]

reg0[0] = lookup_fdb(outport, arp.sha);
    encodes as push:NXM_NX_REG14[],push:NXM_OF_ETH_SRC[],push:NXM_NX_ARP_SHA[],push:NXM_NX_REG15[],pop:NXM_NX_REG14[],pop:NXM_OF_ETH_SRC[],set_field:0/0x100->reg10,resubmit(,72),pop:NXM_OF_ETH_SRC[],pop:NXM_NX_REG14[],move:NXM_NX_REG10[8]->NXM_NX_XXREG0[96]
    has prereqs eth.type == 0x806

reg0 = lookup_fdb(outport, arp.sha);
    Cannot use 32-bit field reg0[0..31] where 1-bit field is required.

outport = lookup_fdb(outport, arp.sha);
    Cannot use string field outport where numeric field is required.

reg1[1] = lookup_fdb(outport, ip4.src);
    Cannot use 32-bit field ip4.src[0..31] where 48-bit field is required.

reg1[1] = lookup_fdb(ip4.src, eth.src);
    Cannot use numeric field ip4.src where string field is required.

# check_in_port_sec
reg0[0] = check_in_port_sec();
    encodes as set_field:0/0x1000->reg10,resubmit(,73),move:NXM_NX_REG10[12]->NXM_NX_XXREG0[96]

reg2[2] = check_in_port_sec();
    encodes as set_field:0/0x1000->reg10,resubmit(,73),move:NXM_NX_REG10[12]->NXM_NX_XXREG0[34]

reg0 = check_in_port_sec();
    Cannot use 32-bit field reg0[0..31] where 1-bit field is required.

reg0[0] = check_in_port_sec(foo);
    check_in_port_sec doesn't take any parameters

check_in_port_sec;
    Syntax error at `check_in_port_sec' expecting action.

# check_out_port_sec
reg0[0] = check_out_port_sec();
    encodes as set_field:0/0x1000->reg10,resubmit(,75),move:NXM_NX_REG10[12]->NXM_NX_XXREG0[96]

reg2[2..3] = check_out_port_sec();
    Cannot use 2-bit field reg2[2..3] where 1-bit field is required.

reg0 = check_out_port_sec();
    Cannot use 32-bit field reg0[0..31] where 1-bit field is required.

reg0[0] = check_out_port_sec(foo);
    check_out_port_sec doesn't take any parameters

check_out_port_sec;
    Syntax error at `check_out_port_sec' expecting action.

# commit_ecmp_nh
commit_ecmp_nh(ipv6 = "false", proto = tcp);
    formats as commit_ecmp_nh(ipv6 = false, proto = tcp);
    encodes as learn(table=76,idle_timeout=20,hard_timeout=30,delete_learned,OXM_OF_METADATA[],NXM_OF_ETH_SRC[],eth_type=0x800,NXM_OF_IP_SRC[],NXM_OF_IP_DST[],nw_proto=6,NXM_OF_TCP_SRC[],NXM_OF_TCP_DST[],load:0x1->NXM_NX_REG10[13]),learn(table=77,idle_timeout=20,hard_timeout=30,delete_learned,OXM_OF_METADATA[],eth_type=0x800,NXM_OF_IP_SRC[]=NXM_OF_IP_DST[0..-1],NXM_OF_IP_DST[]=NXM_OF_IP_SRC[0..-1],nw_proto=6,NXM_OF_TCP_SRC[]=NXM_OF_TCP_DST[0..-1],NXM_OF_TCP_DST[]=NXM_OF_TCP_SRC[0..-1],load:0x1->NXM_NX_REG10[13])

commit_ecmp_nh(ipv6 = "true", proto = udp);
    formats as commit_ecmp_nh(ipv6 = true, proto = udp);
    encodes as learn(table=76,idle_timeout=20,hard_timeout=30,delete_learned,OXM_OF_METADATA[],NXM_OF_ETH_SRC[],eth_type=0x86dd,NXM_NX_IPV6_SRC[],NXM_NX_IPV6_DST[],nw_proto=17,NXM_OF_UDP_SRC[],NXM_OF_UDP_DST[],load:0x1->NXM_NX_REG10[13]),learn(table=77,idle_timeout=20,hard_timeout=30,delete_learned,OXM_OF_METADATA[],eth_type=0x86dd,NXM_NX_IPV6_SRC[]=NXM_NX_IPV6_DST[0..-1],NXM_NX_IPV6_DST[]=NXM_NX_IPV6_SRC[0..-1],nw_proto=17,NXM_OF_UDP_SRC[]=NXM_OF_UDP_DST[0..-1],NXM_OF_UDP_DST[]=NXM_OF_UDP_SRC[0..-1],load:0x1->NXM_NX_REG10[13])

commit_ecmp_nh(proto = sctp);
    Syntax error at `proto' invalid parameter.

# chk_ecmp_nh_mac
reg9[5] = chk_ecmp_nh_mac();
    encodes as set_field:0/0x2000->reg10,resubmit(,76),move:NXM_NX_REG10[13]->OXM_OF_PKT_REG4[5]

# chk_ecmp_nh
reg9[5] = chk_ecmp_nh();
    encodes as set_field:0/0x2000->reg10,resubmit(,77),move:NXM_NX_REG10[13]->OXM_OF_PKT_REG4[5]

# commit_lb_aff
commit_lb_aff(vip = "172.16.0.123:8080", backend = "10.0.0.3:8080", proto = tcp, timeout = 30);
    encodes as learn(table=78,idle_timeout=30,delete_learned,cookie=0xaaaaaaaa,OXM_OF_METADATA[],eth_type=0x800,NXM_OF_IP_SRC[],ip_dst=172.16.0.123,nw_proto=6,tcp_dst=8080,load:0x1->NXM_NX_REG10[14],load:0xa000003->NXM_NX_REG4[],load:0x1f90->NXM_NX_REG2[0..15])

commit_lb_aff(vip = "172.16.0.123", backend = "10.0.0.3", timeout = 30);
    encodes as learn(table=78,idle_timeout=30,delete_learned,cookie=0xaaaaaaaa,OXM_OF_METADATA[],eth_type=0x800,NXM_OF_IP_SRC[],ip_dst=172.16.0.123,load:0x1->NXM_NX_REG10[14],load:0xa000003->NXM_NX_REG4[])

commit_lb_aff(vip = "[::1]:8080", backend = "[::2]:8080", proto = tcp, timeout = 30);
    encodes as learn(table=78,idle_timeout=30,delete_learned,cookie=0xaaaaaaaa,OXM_OF_METADATA[],eth_type=0x86dd,NXM_NX_IPV6_SRC[],ipv6_dst=::1,nw_proto=6,tcp_dst=8080,load:0x1->NXM_NX_REG10[14],load:0x2->NXM_NX_XXREG1[],load:0x1f90->NXM_NX_REG2[0..15])

# chk_lb_aff()
reg9[6] = chk_lb_aff();
    encodes as set_field:0/0x4000->reg10,resubmit(,78),move:NXM_NX_REG10[14]->OXM_OF_PKT_REG4[6]

# push/pop
push(xxreg0);push(xxreg1[10..20]);push(eth.src);pop(xxreg0[0..47]);pop(xxreg0[48..57]);pop(xxreg1);
    formats as push(xxreg0); push(xxreg1[10..20]); push(eth.src); pop(xxreg0[0..47]); pop(xxreg0[48..57]); pop(xxreg1);
    encodes as push:NXM_NX_XXREG0[],push:NXM_NX_XXREG1[10..20],push:NXM_OF_ETH_SRC[],pop:NXM_NX_XXREG0[0..47],pop:NXM_NX_XXREG0[48..57],pop:NXM_NX_XXREG1[]

pop(eth.type);
    Field eth.type is not modifiable.

push(abc);
    Syntax error at `abc' expecting field name.

# sample
sample(probability=100,collector_set=200,obs_domain=0,obs_point=1000);
    encodes as sample(probability=100,collector_set_id=200,obs_domain_id=11259375,obs_point_id=1000)

# sample with obs_domain = 10. Final obs_domain is 0xA << 24 | 0xABCDEF.
sample(probability=100,collector_set=200,obs_domain=10,obs_point=$cookie);
    encodes as sample(probability=100,collector_set_id=200,obs_domain_id=179031535,obs_point_id=2863311530)

sample(probability=10);
    formats as sample(probability=10,collector_set=0,obs_domain=0,obs_point=0);
    encodes as sample(probability=10,collector_set_id=0,obs_domain_id=11259375,obs_point_id=0)

sample(probability=10);
    formats as sample(probability=10,collector_set=0,obs_domain=0,obs_point=0);
    encodes as sample(probability=10,collector_set_id=0,obs_domain_id=11259375,obs_point_id=0)

# sample with a collector_set_id that is not configured in the chassis.
sample(probability=100,collector_set=999,obs_domain=0,obs_point=1000);
    encodes as drop

sample(probability=10, obs_point=reg3);
    formats as sample(probability=10,collector_set=0,obs_domain=0,obs_point=reg3);
    encodes as sample(probability=10,collector_set_id=0,obs_domain_id=11259375,obs_point_id=NXM_NX_XXREG0[0..31])

sample(probability=10, obs_point=ct_label.obs_point_id);
    formats as sample(probability=10,collector_set=0,obs_domain=0,obs_point=ct_label.obs_point_id);
    encodes as sample(probability=10,collector_set_id=0,obs_domain_id=11259375,obs_point_id=NXM_NX_CT_LABEL[96..127])

sample(probability=0,collector_set=200,obs_domain=0,obs_point=1000);
    probability must be greater than zero

sample(probability=0,collector_set=200,obs_domain=0,obs_point=foo);
    Syntax error at `foo' expecting field name.

sample(probability=0,collector_set=200,obs_domain=300,obs_point=foo);
    Syntax error at `300' obs_domain must be 8-bit long.

sample(probability=10,foo=bar,obs_domain=0,obs_point=1000);
    Syntax error at `foo' unknown argument.

sample(probability=10, obs_point=ct_label);
    Cannot use 128-bit field ct_label[0..127] where 32-bit field is required.

# mac_cache_use
mac_cache_use;
    encodes as resubmit(,79)

# ct_nw_dst()
reg1 = ct_nw_dst();
    encodes as set_field:0->reg1,resubmit(,81),move:NXM_NX_REG1[]->NXM_NX_XXREG0[64..95]

xreg1[3..34] = ct_nw_dst();
    encodes as set_field:0->reg1,resubmit(,81),move:NXM_NX_REG1[]->NXM_NX_XXREG0[3..34]

reg1[3..34] = ct_nw_dst();
    Cannot select bits 3 to 34 of 32-bit field reg1.

reg1[3..35] = ct_nw_dst();
    Cannot select bits 3 to 35 of 32-bit field reg1.

reg1[1] = ct_nw_dst();
    Cannot use 1-bit field reg1[1..1] where 32-bit field is required.

ct_nw_dst;
    Syntax error at `ct_nw_dst' expecting action.

ct_nw_dst();
    Syntax error at `ct_nw_dst' expecting action.

# ct_ip6_dst()
xxreg1 = ct_ip6_dst();
    encodes as set_field:0/0xffffffffffffffff->xxreg1,set_field:0/0xffffffffffffffff0000000000000000->xxreg1,resubmit(,82),move:NXM_NX_XXREG1[]->NXM_NX_XXREG1[]

reg1 = ct_ip6_dst();
    Cannot use 32-bit field reg1[0..31] where 128-bit field is required.

ct_ip6_dst;
    Syntax error at `ct_ip6_dst' expecting action.

ct_ip6_dst();
    Syntax error at `ct_ip6_dst' expecting action.

# ct_tp_dst()
reg1[0..15] = ct_tp_dst();
    encodes as set_field:0/0xffff->reg2,resubmit(,83),move:NXM_NX_REG2[0..15]->NXM_NX_XXREG0[64..79]

reg1 = ct_tp_dst();
    Cannot use 32-bit field reg1[0..31] where 16-bit field is required.

ct_tp_dst;
    Syntax error at `ct_tp_dst' expecting action.

ct_tp_dst();
    Syntax error at `ct_tp_dst' expecting action.

flood_remote;
    encodes as set_field:0x8000->reg6,resubmit(,84)

flood_remote();
    Syntax error at `(' expecting `;'.

# Miscellaneous negative tests.
;
    Syntax error at `;'.
xyzzy;
    Syntax error at `xyzzy' expecting action.
next; 123;
    Syntax error at `123'.
next; xyzzy;
    Syntax error at `xyzzy' expecting action.
next
    Syntax error at end of input expecting `;'.
_ATEOF

sed '/^[ 	]/d' test-cases.txt > input.txt
cp test-cases.txt expout
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:2304: ovstest test-ovn parse-actions < input.txt"
at_fn_check_prepare_trace "ovn.at:2304"
( $at_check_trace; ovstest test-ovn parse-actions < input.txt
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2304"
$at_failed && at_fn_log_failure
$at_traceon; }

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_38
#AT_START_39
at_fn_group_banner 39 'ovn.at:2309' \
  "ovn -- enables vlan-limit=0 -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "39. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

net_add n
check ovs-vsctl add-br br-phys
ovn_attach n br-phys 192.168.0.1

check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovs-vsctl get Open_vSwitch . other_config:vlan-limit | tr -d '""'` = x0
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2309" "until test x\`ovs-vsctl get Open_vSwitch . other_config:vlan-limit | tr -d '\"\"'\` = x0"


check ovs-vsctl set Open_vSwitch . other_config:vlan-limit=100
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovs-vsctl get Open_vSwitch . other_config:vlan-limit | tr -d '""'` = x0
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2309" "until test x\`ovs-vsctl get Open_vSwitch . other_config:vlan-limit | tr -d '\"\"'\` = x0"


check ovs-vsctl set Open_vSwitch . other_config:vlan-limit=foo
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovs-vsctl get Open_vSwitch . other_config:vlan-limit | tr -d '""'` = x0
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2309" "until test x\`ovs-vsctl get Open_vSwitch . other_config:vlan-limit | tr -d '\"\"'\` = x0"


ovs_cleanup
printf "%s\n" "$at_setup_line" >"$at_check_line_file"
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_39
#AT_START_40
at_fn_group_banner 40 'ovn.at:2309' \
  "ovn -- enables vlan-limit=0 -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "40. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

net_add n
check ovs-vsctl add-br br-phys
ovn_attach n br-phys 192.168.0.1

check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovs-vsctl get Open_vSwitch . other_config:vlan-limit | tr -d '""'` = x0
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2309" "until test x\`ovs-vsctl get Open_vSwitch . other_config:vlan-limit | tr -d '\"\"'\` = x0"


check ovs-vsctl set Open_vSwitch . other_config:vlan-limit=100
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovs-vsctl get Open_vSwitch . other_config:vlan-limit | tr -d '""'` = x0
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2309" "until test x\`ovs-vsctl get Open_vSwitch . other_config:vlan-limit | tr -d '\"\"'\` = x0"


check ovs-vsctl set Open_vSwitch . other_config:vlan-limit=foo
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovs-vsctl get Open_vSwitch . other_config:vlan-limit | tr -d '""'` = x0
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2309" "until test x\`ovs-vsctl get Open_vSwitch . other_config:vlan-limit | tr -d '\"\"'\` = x0"


ovs_cleanup
printf "%s\n" "$at_setup_line" >"$at_check_line_file"
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_40
#AT_START_41
at_fn_group_banner 41 'ovn.at:2328' \
  "ovn -- allows ACLs to match against vlan-transparent double tagged traffic L3 fields -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "41. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

printf "%s\n" "ovn.at:2328" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:2328"
ovn_start

for i in 1 2; do
    check ovn-nbctl ls-add lsw$i
    check ovn-nbctl --wait=sb add Logical-Switch lsw$i other_config vlan-passthru=true

    ln_port_name=ln-$i
    check ovn-nbctl lsp-add lsw$i $ln_port_name
    check ovn-nbctl lsp-set-addresses $ln_port_name unknown
    check ovn-nbctl lsp-set-type $ln_port_name localnet
    check ovn-nbctl lsp-set-options $ln_port_name network_name=phys
    net_add n
done

# two hypervisors, each connected to the same network
for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys:br-phys
    ovn_attach n br-phys 192.168.0.$i
done

check ovs-vsctl add-port br-phys tap
for i in 1 2; do
    as hv-$i
    check ovs-vsctl add-port br-int vif$i -- set Interface vif$i \
        external-ids:iface-id=lp$i options:tx_pcap=vif$i-tx.pcap options:rxq_pcap=vif$i-rx.pcap
    check ovn-nbctl lsp-add lsw$i lp$i
    check ovn-nbctl lsp-set-addresses lp$i "f0:00:00:00:00:0$i 10.0.0.$i"
done
for i in 1 2; do
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lp$i` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "until test x\`ovn-nbctl lsp-get-up lp\$i\` = xup"

    > $i.expected
done

test_tcp_packet() {
    local inport=$1 eth_dst=$2 eth_src=$3 ip_dst=$4 ip_src=$5 eout=$6 lout=$7 fail=$8
    local packet=$(fmt_pkt "Ether(dst='${eth_dst}', src='${eth_src}')/ \
                            Dot1Q()/ \
                            Dot1Q()/ \
                            IP(dst='${ip_dst}', src='${ip_src}')/ \
                            TCP()")
    as hv-$inport ovs-appctl netdev-dummy/receive vif$inport $packet
    if [ $fail -eq 0 ]; then
        echo $packet >> ${eout#lp}.expected
    fi
}

# first check that acl drop rule works for tagged traffic
for i in 1 2; do
    check ovn-nbctl acl-add lsw$i to-lport 1000 'tcp' drop
done
check ovn-nbctl --wait=hv sync

test_tcp_packet 1 f0:00:00:00:00:02 f0:00:00:00:00:01 10.0.0.2 10.0.0.1 lp2 lp2 1
test_tcp_packet 2 f0:00:00:00:00:01 f0:00:00:00:00:02 10.0.0.1 10.0.0.2 lp1 lp1 1

for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:2328"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:2328"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done

# now check that with no rule traffic passes through
for i in 1 2; do
    check ovn-nbctl acl-del lsw$i to-lport 1000 'tcp'
    check ovn-nbctl acl-add lsw$i to-lport 1000 'tcp' allow-stateless
done
check ovn-nbctl --wait=hv sync

test_tcp_packet 2 f0:00:00:00:00:01 f0:00:00:00:00:02 10.0.0.1 10.0.0.2 lp1 lp1 0
test_tcp_packet 1 f0:00:00:00:00:02 f0:00:00:00:00:01 10.0.0.2 10.0.0.1 lp2 lp2 0

for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:2328"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:2328"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')
        ignored_dp=$(echo "hv-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2328"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')
        ignored_dp=$(echo "hv-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2328"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2328"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2328"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2328"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2328"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_41
#AT_START_42
at_fn_group_banner 42 'ovn.at:2328' \
  "ovn -- allows ACLs to match against vlan-transparent double tagged traffic L3 fields -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "42. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

printf "%s\n" "ovn.at:2328" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:2328"
ovn_start

for i in 1 2; do
    check ovn-nbctl ls-add lsw$i
    check ovn-nbctl --wait=sb add Logical-Switch lsw$i other_config vlan-passthru=true

    ln_port_name=ln-$i
    check ovn-nbctl lsp-add lsw$i $ln_port_name
    check ovn-nbctl lsp-set-addresses $ln_port_name unknown
    check ovn-nbctl lsp-set-type $ln_port_name localnet
    check ovn-nbctl lsp-set-options $ln_port_name network_name=phys
    net_add n
done

# two hypervisors, each connected to the same network
for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys:br-phys
    ovn_attach n br-phys 192.168.0.$i
done

check ovs-vsctl add-port br-phys tap
for i in 1 2; do
    as hv-$i
    check ovs-vsctl add-port br-int vif$i -- set Interface vif$i \
        external-ids:iface-id=lp$i options:tx_pcap=vif$i-tx.pcap options:rxq_pcap=vif$i-rx.pcap
    check ovn-nbctl lsp-add lsw$i lp$i
    check ovn-nbctl lsp-set-addresses lp$i "f0:00:00:00:00:0$i 10.0.0.$i"
done
for i in 1 2; do
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lp$i` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "until test x\`ovn-nbctl lsp-get-up lp\$i\` = xup"

    > $i.expected
done

test_tcp_packet() {
    local inport=$1 eth_dst=$2 eth_src=$3 ip_dst=$4 ip_src=$5 eout=$6 lout=$7 fail=$8
    local packet=$(fmt_pkt "Ether(dst='${eth_dst}', src='${eth_src}')/ \
                            Dot1Q()/ \
                            Dot1Q()/ \
                            IP(dst='${ip_dst}', src='${ip_src}')/ \
                            TCP()")
    as hv-$inport ovs-appctl netdev-dummy/receive vif$inport $packet
    if [ $fail -eq 0 ]; then
        echo $packet >> ${eout#lp}.expected
    fi
}

# first check that acl drop rule works for tagged traffic
for i in 1 2; do
    check ovn-nbctl acl-add lsw$i to-lport 1000 'tcp' drop
done
check ovn-nbctl --wait=hv sync

test_tcp_packet 1 f0:00:00:00:00:02 f0:00:00:00:00:01 10.0.0.2 10.0.0.1 lp2 lp2 1
test_tcp_packet 2 f0:00:00:00:00:01 f0:00:00:00:00:02 10.0.0.1 10.0.0.2 lp1 lp1 1

for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:2328"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:2328"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done

# now check that with no rule traffic passes through
for i in 1 2; do
    check ovn-nbctl acl-del lsw$i to-lport 1000 'tcp'
    check ovn-nbctl acl-add lsw$i to-lport 1000 'tcp' allow-stateless
done
check ovn-nbctl --wait=hv sync

test_tcp_packet 2 f0:00:00:00:00:01 f0:00:00:00:00:02 10.0.0.1 10.0.0.2 lp1 lp1 0
test_tcp_packet 1 f0:00:00:00:00:02 f0:00:00:00:00:01 10.0.0.2 10.0.0.1 lp2 lp2 0

for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:2328"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:2328"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')
        ignored_dp=$(echo "hv-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2328"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')
        ignored_dp=$(echo "hv-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2328"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2328"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2328"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2328"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2328"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2328"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2328: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2328"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2328"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2328" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_42
#AT_START_43
at_fn_group_banner 43 'ovn.at:2412' \
  "3 HVs, 1 LS, 3 lports/HV -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "43. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init



printf "%s\n" "ovn.at:2412" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:2412"
ovn_start

# Create hypervisors hv[123].
# Add vif1[123] to hv1, vif2[123] to hv2, vif3[123] to hv3.
# Add all of the vifs to a single logical switch lsw0.
# Turn on port security on all the vifs except vif[123]1.
# Make vif13, vif2[23], vif3[123] destinations for unknown MACs.
# Add some ACLs for Ethertypes 1234, 1235, 1236.
check ovn-nbctl ls-add lsw0
net_add n1
for i in 1 2 3; do
    sim_add hv$i
    as hv$i
    check ovs-vsctl add-br br-phys
    ovn_attach n1 br-phys 192.168.0.$i

    for j in 1 2 3; do
        check ovs-vsctl add-port br-int vif$i$j -- set Interface vif$i$j external-ids:iface-id=lp$i$j options:tx_pcap=hv$i/vif$i$j-tx.pcap options:rxq_pcap=hv$i/vif$i$j-rx.pcap ofport-request=$i$j
        check ovn-nbctl lsp-add lsw0 lp$i$j
        if test $j = 1; then
            check ovn-nbctl lsp-set-addresses lp$i$j "f0:00:00:00:00:$i$j 192.168.0.$i$j" unknown
        else
            if test $j = 3; then
                ip_addrs="192.168.0.$i$j fe80::ea2a:eaff:fe28:$i$j/64 192.169.0.$i$j"
            else
                ip_addrs="192.168.0.$i$j"
            fi
            check ovn-nbctl lsp-set-addresses lp$i$j "f0:00:00:00:00:$i$j $ip_addrs"
            check ovn-nbctl lsp-set-port-security lp$i$j f0:00:00:00:00:$i$j
        fi
    done
done
check ovn-nbctl acl-add lsw0 from-lport 1000 'eth.type == 0x1234' drop
check ovn-nbctl acl-add lsw0 from-lport 1000 'eth.type == 0x1235 && inport == "lp11"' drop
check ovn-nbctl acl-add lsw0 to-lport 1000 'eth.type == 0x1236 && outport == "lp33"' drop
check_uuid ovn-nbctl create Address_Set name=set1 addresses=\"f0:00:00:00:00:11\",\"f0:00:00:00:00:21\",\"f0:00:00:00:00:31\"
check ovn-nbctl acl-add lsw0 to-lport 1000 'eth.type == 0x1237 && eth.src == $set1 && outport == "lp33"' drop

check ovn-nbctl pg-add pg1 lp22 lp33
check ovn-nbctl acl-add lsw0 to-lport 1000 'eth.type == 0x1238 && outport == @pg1' drop
check ovn-nbctl --wait=hv sync
wait_for_ports_up

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure
$at_traceon; }


# Make sure there is no attempt to adding duplicated flows by ovn-controller
printf "%s\n" "ovn.at:2412" >"$at_check_line_file"
(test -n "`grep duplicate hv1/ovn-controller.log`") \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:2412"
printf "%s\n" "ovn.at:2412" >"$at_check_line_file"
(test -n "`grep duplicate hv2/ovn-controller.log`") \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:2412"
printf "%s\n" "ovn.at:2412" >"$at_check_line_file"
(test -n "`grep duplicate hv3/ovn-controller.log`") \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:2412"

# Given the name of a logical port, prints the name of the hypervisor
# on which it is located.
vif_to_hv() {
    echo hv${1%?}
}

# test_packet INPORT DST SRC ETHTYPE OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as logical switch port numbers, e.g. 11 for vif11.
for i in 1 2 3; do
    for j in 1 2 3; do
        : > $i$j.expected
    done
done
test_packet() {
    local inport=$1 packet=$2$3$4; shift; shift; shift; shift
    hv=`vif_to_hv $inport`
    vif=vif$inport
    as $hv ovs-appctl netdev-dummy/receive $vif $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# test_arp INPORT SHA SPA TPA [REPLY_HA]
#
# Causes a packet to be received on INPORT.  The packet is an ARP
# request with SHA, SPA, and TPA as specified.  If REPLY_HA is provided, then
# it should be the hardware address of the target to expect to receive in an
# ARP reply; otherwise no reply is expected.
#
# INPORT is an logical switch port number, e.g. 11 for vif11.
# SHA and REPLY_HA are each 12 hex digits.
# SPA and TPA are each 8 hex digits.
test_arp() {
    local inport=$1 sha=$2 spa=$3 tpa=$4 reply_ha=$5
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                             ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
    hv=`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $request

    if test X$reply_ha = X; then
        # Expect to receive the broadcast ARP on the other logical switch ports
        # if no reply is expected.
        local i j
        for i in 1 2 3; do
            for j in 1 2 3; do
                if test $i$j != $inport; then
                    echo $request >> $i$j.expected
                fi
            done
        done
    else
        # Expect to receive the reply, if any.
        local reply=$(fmt_pkt "Ether(dst='${sha}', src='${reply_ha}') /
                               ARP(op=2, hwsrc='${reply_ha}', hwdst='${sha}', psrc='${tpa}', pdst='${spa}')")
        echo $reply >> $inport.expected
    fi
}

# Send packets between all pairs of source and destination ports:
#
# 1. Unicast packets are delivered to exactly one logical switch port
#    (except that packets destined to their input ports are dropped).
#
# 2. Broadcast and multicast are delivered to all logical switch ports
#    except the input port.
#
# 3. When port security is turned on, the switch drops packets from the wrong
#    MAC address.
#
# 4. The switch drops all packets with a VLAN tag.
#
# 5. The switch drops all packets with a multicast source address.  (This only
#    affects behavior when port security is turned off, since otherwise port
#    security would drop the packet anyway.)
#
# 6. The switch delivers packets with an unknown destination to logical
#    switch ports with "unknown" among their MAC addresses (and port
#    security disabled).
#
# 7. The switch drops unicast packets that violate an ACL.
#
# 8. The switch drops multicast and broadcast packets that violate an ACL.
#
# 9. OVN generates responses to ARP requests for known IPs, except for
#    requests from a port for the port's own IP.
#
# 10. No response to ARP requests for unknown IPs.

for is in 1 2 3; do
    for js in 1 2 3; do
        s=$is$js
        bcast=
        unknown=
        bacl2=
        bacl3=
        for id in 1 2 3; do
            for jd in 1 2 3; do
                d=$id$jd

                if test $d != $s; then unicast=$d; else unicast=; fi
                test_packet $s f000000000$d f000000000$s $s$d $unicast     #1

                if test $d != $s && test $js = 1; then
                    impersonate=$d
                else
                    impersonate=
                fi
                test_packet $s f000000000$d f00000000055 55$d $impersonate #3

                if test $d != $s && test $s != 11; then acl2=$d; else acl2=; fi
                if test $d != $s && test $d != 33; then acl3=$d; else acl3=; fi
                if test $d = $s || (test $js = 1 && test $d = 33); then
                    # Source of 11, 21, or 31 and dest of 33 should be dropped
                    # due to the 4th ACL that uses address_set(set1).
                    acl4=
                else
                    acl4=$d
                fi
                if test $d = $s || test $d = 22 || test $d = 33; then
                    # dest of 22 and 33 should be dropped
                    # due to the 5th ACL that uses port_group(pg1).
                    acl5=
                else
                    acl5=$d
                fi
                test_packet $s f000000000$d f000000000$s 1234        #7, acl1
                test_packet $s f000000000$d f000000000$s 1235 $acl2  #7, acl2
                test_packet $s f000000000$d f000000000$s 1236 $acl3  #7, acl3
                test_packet $s f000000000$d f000000000$s 1237 $acl4  #7, acl4
                test_packet $s f000000000$d f000000000$s 1238 $acl5  #7, acl5

                test_packet $s f000000000$d f00000000055 810000091234      #4
                test_packet $s f000000000$d 0100000000$s $s$d              #5

                if test $d != $s && test $jd = 1; then
                    unknown="$unknown $d"
                fi
                bcast="$bcast $unicast"
                bacl2="$bacl2 $acl2"
                bacl3="$bacl3 $acl3"

                sip="192.168.0.$is$js"
                tip="192.168.0.$id$jd"
                tip_unknown="11.11.11.11"
                reply_ha=;
                if test $d != $s; then
                    if test $jd != 1; then
                        reply_ha="f0:00:00:00:00:$d"
                    fi
                fi

                test_arp $s f0:00:00:00:00:$s $sip $tip $reply_ha               #9
                test_arp $s f0:00:00:00:00:$s $sip $tip_unknown                 #10

                if test $jd = 3; then
                    # lsp[123]3 has an additional ip 192.169.0.[123]3.
                    tip="192.169.0.$id$jd"
                    test_arp $s f0:00:00:00:00:$s $sip $tip $reply_ha           #9
                fi
            done
        done

        # Broadcast and multicast.
        test_packet $s ffffffffffff f000000000$s ${s}ff $bcast             #2
        test_packet $s 010000000000 f000000000$s ${s}ff $bcast             #2
        if test $js = 1; then
            bcast_impersonate=$bcast
        else
            bcast_impersonate=
        fi
        test_packet $s 010000000000 f00000000044 44ff $bcast_impersonate   #3

        test_packet $s f0000000ffff f000000000$s ${s}66 $unknown           #6

        test_packet $s ffffffffffff f000000000$s 1234                #8, acl1
        test_packet $s ffffffffffff f000000000$s 1235 $bacl2         #8, acl2
        test_packet $s ffffffffffff f000000000$s 1236 $bacl3         #8, acl3
        test_packet $s 010000000000 f000000000$s 1234                #8, acl1
        test_packet $s 010000000000 f000000000$s 1235 $bacl2         #8, acl2
        test_packet $s 010000000000 f000000000$s 1236 $bacl3         #8, acl3
    done
done

# set address for lp13 with invalid characters.
# lp13 should be configured with only 192.168.0.13.
check ovn-nbctl --wait=hv lsp-set-addresses lp13 "f0:00:00:00:00:13 192.168.0.13 invalid 192.169.0.13"

sip="192.168.0.11"
tip="192.168.0.13"
test_arp 11 f0:00:00:00:00:11  $sip $tip f0:00:00:00:00:13

tip="192.169.0.13"
#arp request for 192.169.0.13 should be flooded
test_arp 11 f0:00:00:00:00:11  $sip $tip

# dump information and flows with counters
ovn-sbctl dump-flows -- list multicast_group > sbflows


# Now check the packets actually received against the ones expected.
for i in 1 2 3; do
    for j in 1 2 3; do
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv\$i/vif\$i\$j-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv$i/vif$i$j-tx.pcap " "ovn.at:2412"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv$i/vif$i$j-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected" "tests/ovn.at:2412"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:2412"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
if $at_failed
then :
  dump_diff__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

    done
done



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2412"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2412"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv3" |sed -n '1p')
        error=$(echo "hv3"  | grep '/')
        ignored_dp=$(echo "hv3"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv3"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv3" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2412"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2412"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2412"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2412"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2412"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv3" |sed -n '1p')
        error=$(echo "hv3"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2412"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2412"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_43
#AT_START_44
at_fn_group_banner 44 'ovn.at:2412' \
  "3 HVs, 1 LS, 3 lports/HV -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "44. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init



printf "%s\n" "ovn.at:2412" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:2412"
ovn_start

# Create hypervisors hv[123].
# Add vif1[123] to hv1, vif2[123] to hv2, vif3[123] to hv3.
# Add all of the vifs to a single logical switch lsw0.
# Turn on port security on all the vifs except vif[123]1.
# Make vif13, vif2[23], vif3[123] destinations for unknown MACs.
# Add some ACLs for Ethertypes 1234, 1235, 1236.
check ovn-nbctl ls-add lsw0
net_add n1
for i in 1 2 3; do
    sim_add hv$i
    as hv$i
    check ovs-vsctl add-br br-phys
    ovn_attach n1 br-phys 192.168.0.$i

    for j in 1 2 3; do
        check ovs-vsctl add-port br-int vif$i$j -- set Interface vif$i$j external-ids:iface-id=lp$i$j options:tx_pcap=hv$i/vif$i$j-tx.pcap options:rxq_pcap=hv$i/vif$i$j-rx.pcap ofport-request=$i$j
        check ovn-nbctl lsp-add lsw0 lp$i$j
        if test $j = 1; then
            check ovn-nbctl lsp-set-addresses lp$i$j "f0:00:00:00:00:$i$j 192.168.0.$i$j" unknown
        else
            if test $j = 3; then
                ip_addrs="192.168.0.$i$j fe80::ea2a:eaff:fe28:$i$j/64 192.169.0.$i$j"
            else
                ip_addrs="192.168.0.$i$j"
            fi
            check ovn-nbctl lsp-set-addresses lp$i$j "f0:00:00:00:00:$i$j $ip_addrs"
            check ovn-nbctl lsp-set-port-security lp$i$j f0:00:00:00:00:$i$j
        fi
    done
done
check ovn-nbctl acl-add lsw0 from-lport 1000 'eth.type == 0x1234' drop
check ovn-nbctl acl-add lsw0 from-lport 1000 'eth.type == 0x1235 && inport == "lp11"' drop
check ovn-nbctl acl-add lsw0 to-lport 1000 'eth.type == 0x1236 && outport == "lp33"' drop
check_uuid ovn-nbctl create Address_Set name=set1 addresses=\"f0:00:00:00:00:11\",\"f0:00:00:00:00:21\",\"f0:00:00:00:00:31\"
check ovn-nbctl acl-add lsw0 to-lport 1000 'eth.type == 0x1237 && eth.src == $set1 && outport == "lp33"' drop

check ovn-nbctl pg-add pg1 lp22 lp33
check ovn-nbctl acl-add lsw0 to-lport 1000 'eth.type == 0x1238 && outport == @pg1' drop
check ovn-nbctl --wait=hv sync
wait_for_ports_up

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure
$at_traceon; }


# Make sure there is no attempt to adding duplicated flows by ovn-controller
printf "%s\n" "ovn.at:2412" >"$at_check_line_file"
(test -n "`grep duplicate hv1/ovn-controller.log`") \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:2412"
printf "%s\n" "ovn.at:2412" >"$at_check_line_file"
(test -n "`grep duplicate hv2/ovn-controller.log`") \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:2412"
printf "%s\n" "ovn.at:2412" >"$at_check_line_file"
(test -n "`grep duplicate hv3/ovn-controller.log`") \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:2412"

# Given the name of a logical port, prints the name of the hypervisor
# on which it is located.
vif_to_hv() {
    echo hv${1%?}
}

# test_packet INPORT DST SRC ETHTYPE OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as logical switch port numbers, e.g. 11 for vif11.
for i in 1 2 3; do
    for j in 1 2 3; do
        : > $i$j.expected
    done
done
test_packet() {
    local inport=$1 packet=$2$3$4; shift; shift; shift; shift
    hv=`vif_to_hv $inport`
    vif=vif$inport
    as $hv ovs-appctl netdev-dummy/receive $vif $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# test_arp INPORT SHA SPA TPA [REPLY_HA]
#
# Causes a packet to be received on INPORT.  The packet is an ARP
# request with SHA, SPA, and TPA as specified.  If REPLY_HA is provided, then
# it should be the hardware address of the target to expect to receive in an
# ARP reply; otherwise no reply is expected.
#
# INPORT is an logical switch port number, e.g. 11 for vif11.
# SHA and REPLY_HA are each 12 hex digits.
# SPA and TPA are each 8 hex digits.
test_arp() {
    local inport=$1 sha=$2 spa=$3 tpa=$4 reply_ha=$5
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                             ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
    hv=`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $request

    if test X$reply_ha = X; then
        # Expect to receive the broadcast ARP on the other logical switch ports
        # if no reply is expected.
        local i j
        for i in 1 2 3; do
            for j in 1 2 3; do
                if test $i$j != $inport; then
                    echo $request >> $i$j.expected
                fi
            done
        done
    else
        # Expect to receive the reply, if any.
        local reply=$(fmt_pkt "Ether(dst='${sha}', src='${reply_ha}') /
                               ARP(op=2, hwsrc='${reply_ha}', hwdst='${sha}', psrc='${tpa}', pdst='${spa}')")
        echo $reply >> $inport.expected
    fi
}

# Send packets between all pairs of source and destination ports:
#
# 1. Unicast packets are delivered to exactly one logical switch port
#    (except that packets destined to their input ports are dropped).
#
# 2. Broadcast and multicast are delivered to all logical switch ports
#    except the input port.
#
# 3. When port security is turned on, the switch drops packets from the wrong
#    MAC address.
#
# 4. The switch drops all packets with a VLAN tag.
#
# 5. The switch drops all packets with a multicast source address.  (This only
#    affects behavior when port security is turned off, since otherwise port
#    security would drop the packet anyway.)
#
# 6. The switch delivers packets with an unknown destination to logical
#    switch ports with "unknown" among their MAC addresses (and port
#    security disabled).
#
# 7. The switch drops unicast packets that violate an ACL.
#
# 8. The switch drops multicast and broadcast packets that violate an ACL.
#
# 9. OVN generates responses to ARP requests for known IPs, except for
#    requests from a port for the port's own IP.
#
# 10. No response to ARP requests for unknown IPs.

for is in 1 2 3; do
    for js in 1 2 3; do
        s=$is$js
        bcast=
        unknown=
        bacl2=
        bacl3=
        for id in 1 2 3; do
            for jd in 1 2 3; do
                d=$id$jd

                if test $d != $s; then unicast=$d; else unicast=; fi
                test_packet $s f000000000$d f000000000$s $s$d $unicast     #1

                if test $d != $s && test $js = 1; then
                    impersonate=$d
                else
                    impersonate=
                fi
                test_packet $s f000000000$d f00000000055 55$d $impersonate #3

                if test $d != $s && test $s != 11; then acl2=$d; else acl2=; fi
                if test $d != $s && test $d != 33; then acl3=$d; else acl3=; fi
                if test $d = $s || (test $js = 1 && test $d = 33); then
                    # Source of 11, 21, or 31 and dest of 33 should be dropped
                    # due to the 4th ACL that uses address_set(set1).
                    acl4=
                else
                    acl4=$d
                fi
                if test $d = $s || test $d = 22 || test $d = 33; then
                    # dest of 22 and 33 should be dropped
                    # due to the 5th ACL that uses port_group(pg1).
                    acl5=
                else
                    acl5=$d
                fi
                test_packet $s f000000000$d f000000000$s 1234        #7, acl1
                test_packet $s f000000000$d f000000000$s 1235 $acl2  #7, acl2
                test_packet $s f000000000$d f000000000$s 1236 $acl3  #7, acl3
                test_packet $s f000000000$d f000000000$s 1237 $acl4  #7, acl4
                test_packet $s f000000000$d f000000000$s 1238 $acl5  #7, acl5

                test_packet $s f000000000$d f00000000055 810000091234      #4
                test_packet $s f000000000$d 0100000000$s $s$d              #5

                if test $d != $s && test $jd = 1; then
                    unknown="$unknown $d"
                fi
                bcast="$bcast $unicast"
                bacl2="$bacl2 $acl2"
                bacl3="$bacl3 $acl3"

                sip="192.168.0.$is$js"
                tip="192.168.0.$id$jd"
                tip_unknown="11.11.11.11"
                reply_ha=;
                if test $d != $s; then
                    if test $jd != 1; then
                        reply_ha="f0:00:00:00:00:$d"
                    fi
                fi

                test_arp $s f0:00:00:00:00:$s $sip $tip $reply_ha               #9
                test_arp $s f0:00:00:00:00:$s $sip $tip_unknown                 #10

                if test $jd = 3; then
                    # lsp[123]3 has an additional ip 192.169.0.[123]3.
                    tip="192.169.0.$id$jd"
                    test_arp $s f0:00:00:00:00:$s $sip $tip $reply_ha           #9
                fi
            done
        done

        # Broadcast and multicast.
        test_packet $s ffffffffffff f000000000$s ${s}ff $bcast             #2
        test_packet $s 010000000000 f000000000$s ${s}ff $bcast             #2
        if test $js = 1; then
            bcast_impersonate=$bcast
        else
            bcast_impersonate=
        fi
        test_packet $s 010000000000 f00000000044 44ff $bcast_impersonate   #3

        test_packet $s f0000000ffff f000000000$s ${s}66 $unknown           #6

        test_packet $s ffffffffffff f000000000$s 1234                #8, acl1
        test_packet $s ffffffffffff f000000000$s 1235 $bacl2         #8, acl2
        test_packet $s ffffffffffff f000000000$s 1236 $bacl3         #8, acl3
        test_packet $s 010000000000 f000000000$s 1234                #8, acl1
        test_packet $s 010000000000 f000000000$s 1235 $bacl2         #8, acl2
        test_packet $s 010000000000 f000000000$s 1236 $bacl3         #8, acl3
    done
done

# set address for lp13 with invalid characters.
# lp13 should be configured with only 192.168.0.13.
check ovn-nbctl --wait=hv lsp-set-addresses lp13 "f0:00:00:00:00:13 192.168.0.13 invalid 192.169.0.13"

sip="192.168.0.11"
tip="192.168.0.13"
test_arp 11 f0:00:00:00:00:11  $sip $tip f0:00:00:00:00:13

tip="192.169.0.13"
#arp request for 192.169.0.13 should be flooded
test_arp 11 f0:00:00:00:00:11  $sip $tip

# dump information and flows with counters
ovn-sbctl dump-flows -- list multicast_group > sbflows


# Now check the packets actually received against the ones expected.
for i in 1 2 3; do
    for j in 1 2 3; do
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv\$i/vif\$i\$j-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv$i/vif$i$j-tx.pcap " "ovn.at:2412"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv$i/vif$i$j-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected" "tests/ovn.at:2412"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:2412"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
if $at_failed
then :
  dump_diff__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

    done
done



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2412"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2412"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv3" |sed -n '1p')
        error=$(echo "hv3"  | grep '/')
        ignored_dp=$(echo "hv3"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv3"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv3" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2412"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2412"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2412"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2412"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2412"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv3" |sed -n '1p')
        error=$(echo "hv3"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2412"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2412"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2412"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2412: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2412"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2412"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2412" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_44
#AT_START_45
at_fn_group_banner 45 'ovn.at:2689' \
  "2 HVs, 1 LS, 2 lports/HV -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "45. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init


ovn_start

# Create hypervisors hv[12].
# Add vif1[12] to hv1, vif2[12] to hv2
check ovn-nbctl ls-add lsw0
net_add n1
for i in 1 2; do
    sim_add hv$i
    as hv$i
    ovs-vsctl add-br br-phys
    ovn_attach n1 br-phys 192.168.0.$i

    for j in 1 2; do
        ovs-vsctl add-port br-int vif$i$j -- set Interface vif$i$j external-ids:iface-id=lp$i$j options:tx_pcap=hv$i/vif$i$j-tx.pcap options:rxq_pcap=hv$i/vif$i$j-rx.pcap ofport-request=$i$j
        check ovn-nbctl lsp-add lsw0 lp$i$j
        ip_addrs="192.168.0.$i$j"
        check ovn-nbctl lsp-set-addresses lp$i$j "f0:00:00:00:00:$i$j $ip_addrs"
        check ovn-nbctl --wait=hv lsp-set-port-security lp$i$j f0:00:00:00:00:$i$j
    done
done

get_lsp_uuid () {
    ovn-nbctl lsp-list lsw0 | grep $1 | awk '{ print $1 }'
}

# XXX-Check how to pass lp$i1 in AT_CHECK_UNQUOTED, for now just do it
# explictly

# For Chassis hv1
check_row_count Port_Binding 1 logical_port=lp11 'encap=[]'
check_row_count Port_Binding 1 logical_port=lp12 'encap=[]'

# For Chassis hv2
check_row_count Port_Binding 1 logical_port=lp21 'encap=[]'
check_row_count Port_Binding 1 logical_port=lp22 'encap=[]'

# Bind the ports to the encap-ip
for i in 1 2; do
    for j in 1 2; do
        as hv$i
        ovs-vsctl set Interface vif$i$j external-ids:encap-ip=192.168.0.$i
    done
done

# Wait for bindings to take effect.
wait_row_count Port_Binding 1 logical_port=lp11 'encap!=[]'
wait_row_count Port_Binding 1 logical_port=lp12 'encap!=[]'
wait_row_count Port_Binding 1 logical_port=lp21 'encap!=[]'
wait_row_count Port_Binding 1 logical_port=lp22 'encap!=[]'

# dump port bindings; since we have vxlan and geneve tunnels, we expect the
# ports to be bound to geneve tunnels.

# For Chassis 1
encap_rec=$(fetch_column Encap _uuid chassis_name=hv1 type=geneve ip=192.168.0.1)
check_row_count Port_Binding 1 logical_port=lp11 encap=$encap_rec
check_row_count Port_Binding 1 logical_port=lp12 encap=$encap_rec

# For Chassis 2
encap_rec=$(fetch_column Encap _uuid chassis_name=hv2 type=geneve ip=192.168.0.2)
check_row_count Port_Binding 1 logical_port=lp21 encap=$encap_rec
check_row_count Port_Binding 1 logical_port=lp22 encap=$encap_rec

# Remove the encap-ip setting in vif, which should trigger encap removal from
# Port_Binding.
as hv1 ovs-vsctl remove Interface vif11 external-ids encap-ip
wait_row_count Port_Binding 1 logical_port=lp11 'encap=[]'

# Change it back and continue the test
as hv1 ovs-vsctl set Interface vif11 external-ids:encap-ip=192.168.0.1
wait_row_count Port_Binding 1 logical_port=lp11 'encap!=[]'

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure
$at_traceon; }


wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Make sure there is no attempt to adding duplicated flows by ovn-controller
printf "%s\n" "ovn.at:2689" >"$at_check_line_file"
(test -n "`grep duplicate hv1/ovn-controller.log`") \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:2689"
printf "%s\n" "ovn.at:2689" >"$at_check_line_file"
(test -n "`grep duplicate hv2/ovn-controller.log`") \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:2689"
printf "%s\n" "ovn.at:2689" >"$at_check_line_file"
(test -n "`grep duplicate hv3/ovn-controller.log`") \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:2689"

# Given the name of a logical port, prints the name of the hypervisor
# on which it is located.
vif_to_hv() {
    echo hv${1%?}
}

# test_packet INPORT DST SRC ETHTYPE OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as logical switch port numbers, e.g. 11 for vif11.
for i in 1 2; do
    for j in 1 2; do
        : > $i$j.expected
    done
done
test_packet() {
    local inport=$1 packet=$2$3$4; shift; shift; shift; shift
    hv=`vif_to_hv $inport`
    vif=vif$inport
    as $hv ovs-appctl netdev-dummy/receive $vif $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# Send packets between all pairs of source and destination ports:
#
# 1. Unicast packets are delivered to exactly one logical switch port
#    (except that packets destined to their input ports are dropped).

for is in 1 2; do
    for js in 1 2; do
        s=$is$js
        bcast=
        unknown=
        bacl2=
        bacl3=
        for id in 1 2 3; do
            for jd in 1 2 3; do
                d=$id$jd

                if test $d != $s; then unicast=$d; else unicast=; fi
                test_packet $s f000000000$d f000000000$s $s$d $unicast     #1
            done
        done

    done
done

# dump information and flows with counters
ovn-sbctl dump-flows -- list multicast_group

echo "------ hv1 dump ------"
as hv1 ovs-vsctl show
as hv1 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv2 dump ------"
as hv2 ovs-vsctl show
as hv2 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv3 dump ------"
as hv3 ovs-vsctl show
as hv3 ovs-ofctl -O OpenFlow13 dump-flows br-int

# Now check the packets actually received against the ones expected.
for i in 1 2; do
    for j in 1 2; do
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv\$i/vif\$i\$j-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv$i/vif$i$j-tx.pcap " "ovn.at:2689"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv$i/vif$i$j-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected" "tests/ovn.at:2689"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:2689"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
if $at_failed
then :
  dump_diff__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

    done
done



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2689"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2689"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2689"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2689"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2689"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2689"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_45
#AT_START_46
at_fn_group_banner 46 'ovn.at:2689' \
  "2 HVs, 1 LS, 2 lports/HV -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "46. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init


ovn_start

# Create hypervisors hv[12].
# Add vif1[12] to hv1, vif2[12] to hv2
check ovn-nbctl ls-add lsw0
net_add n1
for i in 1 2; do
    sim_add hv$i
    as hv$i
    ovs-vsctl add-br br-phys
    ovn_attach n1 br-phys 192.168.0.$i

    for j in 1 2; do
        ovs-vsctl add-port br-int vif$i$j -- set Interface vif$i$j external-ids:iface-id=lp$i$j options:tx_pcap=hv$i/vif$i$j-tx.pcap options:rxq_pcap=hv$i/vif$i$j-rx.pcap ofport-request=$i$j
        check ovn-nbctl lsp-add lsw0 lp$i$j
        ip_addrs="192.168.0.$i$j"
        check ovn-nbctl lsp-set-addresses lp$i$j "f0:00:00:00:00:$i$j $ip_addrs"
        check ovn-nbctl --wait=hv lsp-set-port-security lp$i$j f0:00:00:00:00:$i$j
    done
done

get_lsp_uuid () {
    ovn-nbctl lsp-list lsw0 | grep $1 | awk '{ print $1 }'
}

# XXX-Check how to pass lp$i1 in AT_CHECK_UNQUOTED, for now just do it
# explictly

# For Chassis hv1
check_row_count Port_Binding 1 logical_port=lp11 'encap=[]'
check_row_count Port_Binding 1 logical_port=lp12 'encap=[]'

# For Chassis hv2
check_row_count Port_Binding 1 logical_port=lp21 'encap=[]'
check_row_count Port_Binding 1 logical_port=lp22 'encap=[]'

# Bind the ports to the encap-ip
for i in 1 2; do
    for j in 1 2; do
        as hv$i
        ovs-vsctl set Interface vif$i$j external-ids:encap-ip=192.168.0.$i
    done
done

# Wait for bindings to take effect.
wait_row_count Port_Binding 1 logical_port=lp11 'encap!=[]'
wait_row_count Port_Binding 1 logical_port=lp12 'encap!=[]'
wait_row_count Port_Binding 1 logical_port=lp21 'encap!=[]'
wait_row_count Port_Binding 1 logical_port=lp22 'encap!=[]'

# dump port bindings; since we have vxlan and geneve tunnels, we expect the
# ports to be bound to geneve tunnels.

# For Chassis 1
encap_rec=$(fetch_column Encap _uuid chassis_name=hv1 type=geneve ip=192.168.0.1)
check_row_count Port_Binding 1 logical_port=lp11 encap=$encap_rec
check_row_count Port_Binding 1 logical_port=lp12 encap=$encap_rec

# For Chassis 2
encap_rec=$(fetch_column Encap _uuid chassis_name=hv2 type=geneve ip=192.168.0.2)
check_row_count Port_Binding 1 logical_port=lp21 encap=$encap_rec
check_row_count Port_Binding 1 logical_port=lp22 encap=$encap_rec

# Remove the encap-ip setting in vif, which should trigger encap removal from
# Port_Binding.
as hv1 ovs-vsctl remove Interface vif11 external-ids encap-ip
wait_row_count Port_Binding 1 logical_port=lp11 'encap=[]'

# Change it back and continue the test
as hv1 ovs-vsctl set Interface vif11 external-ids:encap-ip=192.168.0.1
wait_row_count Port_Binding 1 logical_port=lp11 'encap!=[]'

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure
$at_traceon; }


wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Make sure there is no attempt to adding duplicated flows by ovn-controller
printf "%s\n" "ovn.at:2689" >"$at_check_line_file"
(test -n "`grep duplicate hv1/ovn-controller.log`") \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:2689"
printf "%s\n" "ovn.at:2689" >"$at_check_line_file"
(test -n "`grep duplicate hv2/ovn-controller.log`") \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:2689"
printf "%s\n" "ovn.at:2689" >"$at_check_line_file"
(test -n "`grep duplicate hv3/ovn-controller.log`") \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:2689"

# Given the name of a logical port, prints the name of the hypervisor
# on which it is located.
vif_to_hv() {
    echo hv${1%?}
}

# test_packet INPORT DST SRC ETHTYPE OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as logical switch port numbers, e.g. 11 for vif11.
for i in 1 2; do
    for j in 1 2; do
        : > $i$j.expected
    done
done
test_packet() {
    local inport=$1 packet=$2$3$4; shift; shift; shift; shift
    hv=`vif_to_hv $inport`
    vif=vif$inport
    as $hv ovs-appctl netdev-dummy/receive $vif $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# Send packets between all pairs of source and destination ports:
#
# 1. Unicast packets are delivered to exactly one logical switch port
#    (except that packets destined to their input ports are dropped).

for is in 1 2; do
    for js in 1 2; do
        s=$is$js
        bcast=
        unknown=
        bacl2=
        bacl3=
        for id in 1 2 3; do
            for jd in 1 2 3; do
                d=$id$jd

                if test $d != $s; then unicast=$d; else unicast=; fi
                test_packet $s f000000000$d f000000000$s $s$d $unicast     #1
            done
        done

    done
done

# dump information and flows with counters
ovn-sbctl dump-flows -- list multicast_group

echo "------ hv1 dump ------"
as hv1 ovs-vsctl show
as hv1 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv2 dump ------"
as hv2 ovs-vsctl show
as hv2 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv3 dump ------"
as hv3 ovs-vsctl show
as hv3 ovs-ofctl -O OpenFlow13 dump-flows br-int

# Now check the packets actually received against the ones expected.
for i in 1 2; do
    for j in 1 2; do
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv\$i/vif\$i\$j-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv$i/vif$i$j-tx.pcap " "ovn.at:2689"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv$i/vif$i$j-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected" "tests/ovn.at:2689"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:2689"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
if $at_failed
then :
  dump_diff__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

    done
done



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2689"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2689"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2689"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2689"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:2689"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:2689"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:2689"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:2689: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:2689"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2689"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:2689" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_46
#AT_START_47
at_fn_group_banner 47 'ovn.at:2856' \
  "trace 1 LS, 3 LSPs -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "47. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

# Create a logical switch and some logical ports.
# Turn on port security on all lports except ls1.
# Make ls1 a destination for unknown MACs.
# Add some ACLs for Ethertypes 1234, 1235, 1236.
check ovn-nbctl ls-add lsw0
check ovn-sbctl chassis-add hv0 geneve 127.0.0.1
for i in 1 2 3; do
    check ovn-nbctl lsp-add lsw0 lp$i
done
check ovn-nbctl --wait=sb sync
for i in 1 2 3; do
    check ovn-sbctl lsp-bind lp$i hv0
    if test $i = 1; then
        check ovn-nbctl lsp-set-addresses lp$i "f0:00:00:00:00:0$i 192.168.0.$i" unknown
    else
        if test $i = 3; then
           ip_addrs="192.168.0.$i fe80::ea2a:eaff:fe28:$i/64 192.169.0.$i"
        else
           ip_addrs="192.168.0.$i"
        fi
        check ovn-nbctl lsp-set-addresses lp$i "f0:00:00:00:00:0$i $ip_addrs"
        check ovn-nbctl lsp-set-port-security lp$i f0:00:00:00:00:0$i
    fi
done
check ovn-nbctl acl-add lsw0 from-lport 1000 'eth.type == 0x1234' drop
check ovn-nbctl acl-add lsw0 from-lport 1000 'eth.type == 0x1235 && inport == "lp1"' drop
check ovn-nbctl acl-add lsw0 to-lport 1000 'eth.type == 0x1236 && outport == "lp3"' drop
check_uuid ovn-nbctl create Address_Set name=set1 addresses=\"f0:00:00:00:00:01\",\"f0:00:00:00:00:02\"
check ovn-nbctl acl-add lsw0 to-lport 1000 'eth.type == 0x1237 && eth.src == $set1 && outport == "lp3"' drop

check ovn-nbctl --wait=sb sync
ovn-sbctl dump-flows > sbflows

on_exit 'kill `cat ovn-trace.pid`'
ovn-trace --detach --pidfile --no-chdir

# test_packet INPORT DST SRC [-vlan] [-eth TYPE] OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as logical switch port numbers, e.g. 11 for vif11.
test_packet() {
    local inport=$1 eth_dst=$2 eth_src=$3; shift; shift; shift
    uflow="inport==\"lp$inport\" && eth.dst==$eth_dst && eth.src==$eth_src"
    while :; do
        case $1 in # (
            -vlan) uflow="$uflow && vlan.vid == 1234"; shift ;; # (
            -eth) uflow="$uflow && eth.type == 0x$2"; shift; shift ;; # (
            *) break ;;
        esac
    done
    for outport; do
        echo "output(\"lp$outport\");"
    done > expout

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2856: ovn_trace_client ovn-trace --minimal lsw0 \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace_client ovn-trace --minimal lsw0 \"$uflow\"" "ovn.at:2856"
( $at_check_trace; ovn_trace_client ovn-trace --minimal lsw0 "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2856"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

}

# test_arp INPORT SHA SPA TPA [REPLY_HA]
#
# Causes a packet to be received on INPORT.  The packet is an ARP
# request with SHA, SPA, and TPA as specified.  If REPLY_HA is provided, then
# it should be the hardware address of the target to expect to receive in an
# ARP reply; otherwise no reply is expected.
#
# INPORT is an logical switch port number, e.g. 11 for vif11.
# SHA and REPLY_HA are each 12 hex digits.
# SPA and TPA are each 8 hex digits.
test_arp() {
    local inport=$1 sha=$2 spa=$3 tpa=$4 reply_ha=$5

    local request="inport == \"lp$inport\"
                   && eth.dst == ff:ff:ff:ff:ff:ff && eth.src == $sha
                   && arp.op == 1 && arp.sha == $sha && arp.spa == $spa
                   && arp.tha == ff:ff:ff:ff:ff:ff && arp.tpa == $tpa"

    if test -z "$reply_ha"; then
        reply=
        local i
        for i in 1 2 3; do
            if test $i != $inport; then
                reply="${reply}output(\"lp$i\");
"
            fi
        done
    else
        reply="\
eth.dst = $sha;
eth.src = $reply_ha;
arp.op = 2;
arp.tha = $sha;
arp.sha = $reply_ha;
arp.tpa = $spa;
arp.spa = $tpa;
output(\"lp$inport\");
"
    fi

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2856: ovn_trace_client ovn-trace --minimal lsw0 \"\$request\""
at_fn_check_prepare_dynamic "ovn_trace_client ovn-trace --minimal lsw0 \"$request\"" "ovn.at:2856"
( $at_check_trace; ovn_trace_client ovn-trace --minimal lsw0 "$request"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "$reply" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2856"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

}

# Send packets between all pairs of source and destination ports:
#
# 1. Unicast packets are delivered to exactly one logical switch port
#    (except that packets destined to their input ports are dropped).
#
# 2. Broadcast and multicast are delivered to all logical switch ports
#    except the input port.
#
# 3. When port security is turned on, the switch drops packets from the wrong
#    MAC address.
#
# 4. The switch drops all packets with a VLAN tag.
#
# 5. The switch drops all packets with a multicast source address.  (This only
#    affects behavior when port security is turned off, since otherwise port
#    security would drop the packet anyway.)
#
# 6. The switch delivers packets with an unknown destination to logical
#    switch ports with "unknown" among their MAC addresses (and port
#    security disabled).
#
# 7. The switch drops unicast packets that violate an ACL.
#
# 8. The switch drops multicast and broadcast packets that violate an ACL.
#
# 9. OVN generates responses to ARP requests for known IPs, except for
#    requests from a port for the port's own IP.
#
# 10. No response to ARP requests for unknown IPs.

for s in 1 2 3; do
    bcast=
    unknown=
    bacl2=
    bacl3=
    for d in 1 2 3; do
        echo
        echo "lp$s -> lp$d"
        if test $d != $s; then unicast=$d; else unicast=; fi
        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:0$s $unicast      #1

        if test $d != $s && test $s = 1; then
            impersonate=$d
        else
            impersonate=
        fi
        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:55 $impersonate   #3

        if test $d != $s && test $s != 1; then acl2=$d; else acl2=; fi
        if test $d != $s && test $d != 3; then acl3=$d; else acl3=; fi
        if test $d = $s || ( (test $s = 1 || test $s = 2) && test $d = 3); then
            # Source of 1 or 2 and dest of 3 should be dropped
            # due to the 4th ACL that uses address_set(set1).
            acl4=
        else
            acl4=$d
        fi

        #7, acl1 to acl4:
        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:0$s -eth 1234
        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:0$s -eth 1235 $acl2
        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:0$s -eth 1236 $acl3
        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:0$s -eth 1237 $acl4

        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:55 -vlan          #4
        test_packet $s f0:00:00:00:00:0$d 01:00:00:00:00:0$s               #5

        if test $d != $s && test $d = 1; then
            unknown="$unknown $d"
        fi
        bcast="$bcast $unicast"
        bacl2="$bacl2 $acl2"
        bacl3="$bacl3 $acl3"

        sip=192.168.0.$s
        tip=192.168.0.$d
        tip_unknown=11.11.11.11
        reply_ha=;
        if test $d != $s; then
            if test $d != 1; then
                reply_ha=f0:00:00:00:00:0$d;
            fi
        fi

        test_arp $s f0:00:00:00:00:0$s $sip $tip $reply_ha                 #9
        test_arp $s f0:00:00:00:00:0$s $sip $tip_unknown                   #10

        if test $d = 3; then
            # lp3 has an additional ip 192.169.0.[123]3.
            tip=192.169.0.$d
            test_arp $s f0:00:00:00:00:0$s $sip $tip $reply_ha             #9
        fi
    done

    # Broadcast and multicast.
    test_packet $s ff:ff:ff:ff:ff:ff f0:00:00:00:00:0$s $bcast             #2
    test_packet $s 01:00:00:00:00:00 f0:00:00:00:00:0$s $bcast             #2
    if test $s = 1; then
       bcast_impersonate=$bcast
    else
       bcast_impersonate=
    fi
    test_packet $s 01:00:00:00:00:00 f0:00:00:00:00:44 $bcast_impersonate  #3

    test_packet $s f0:00:00:00:ff:ff f0:00:00:00:00:0$s $unknown           #6

    #8, acl1 to acl3:
    test_packet $s ff:ff:ff:ff:ff:ff f0:00:00:00:00:0$s -eth 1234
    test_packet $s ff:ff:ff:ff:ff:ff f0:00:00:00:00:0$s -eth 1235 $bacl2
    test_packet $s ff:ff:ff:ff:ff:ff f0:00:00:00:00:0$s -eth 1236 $bacl3

    #8, acl1 to acl3:
    test_packet $s 01:00:00:00:00:00 f0:00:00:00:00:0$s -eth 1234
    test_packet $s 01:00:00:00:00:00 f0:00:00:00:00:0$s -eth 1235 $bacl2
    test_packet $s 01:00:00:00:00:00 f0:00:00:00:00:0$s -eth 1236 $bacl3
done

# send packets for unknown datapath

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:2856: ovn-appctl -t ovn-trace trace --all lsw100 \"inport == p100 && ip4.dst == 10.96.57.175\""
at_fn_check_prepare_trace "ovn.at:2856"
( $at_check_trace; ovn-appctl -t ovn-trace trace --all lsw100 "inport == p100 && ip4.dst == 10.96.57.175"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "unknown datapath \"lsw100\"
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2856"
$at_failed && at_fn_log_failure  \
"sbflows" \
"trace"
$at_traceon; }


ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_47
#AT_START_48
at_fn_group_banner 48 'ovn.at:2856' \
  "trace 1 LS, 3 LSPs -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "48. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

# Create a logical switch and some logical ports.
# Turn on port security on all lports except ls1.
# Make ls1 a destination for unknown MACs.
# Add some ACLs for Ethertypes 1234, 1235, 1236.
check ovn-nbctl ls-add lsw0
check ovn-sbctl chassis-add hv0 geneve 127.0.0.1
for i in 1 2 3; do
    check ovn-nbctl lsp-add lsw0 lp$i
done
check ovn-nbctl --wait=sb sync
for i in 1 2 3; do
    check ovn-sbctl lsp-bind lp$i hv0
    if test $i = 1; then
        check ovn-nbctl lsp-set-addresses lp$i "f0:00:00:00:00:0$i 192.168.0.$i" unknown
    else
        if test $i = 3; then
           ip_addrs="192.168.0.$i fe80::ea2a:eaff:fe28:$i/64 192.169.0.$i"
        else
           ip_addrs="192.168.0.$i"
        fi
        check ovn-nbctl lsp-set-addresses lp$i "f0:00:00:00:00:0$i $ip_addrs"
        check ovn-nbctl lsp-set-port-security lp$i f0:00:00:00:00:0$i
    fi
done
check ovn-nbctl acl-add lsw0 from-lport 1000 'eth.type == 0x1234' drop
check ovn-nbctl acl-add lsw0 from-lport 1000 'eth.type == 0x1235 && inport == "lp1"' drop
check ovn-nbctl acl-add lsw0 to-lport 1000 'eth.type == 0x1236 && outport == "lp3"' drop
check_uuid ovn-nbctl create Address_Set name=set1 addresses=\"f0:00:00:00:00:01\",\"f0:00:00:00:00:02\"
check ovn-nbctl acl-add lsw0 to-lport 1000 'eth.type == 0x1237 && eth.src == $set1 && outport == "lp3"' drop

check ovn-nbctl --wait=sb sync
ovn-sbctl dump-flows > sbflows

on_exit 'kill `cat ovn-trace.pid`'
ovn-trace --detach --pidfile --no-chdir

# test_packet INPORT DST SRC [-vlan] [-eth TYPE] OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as logical switch port numbers, e.g. 11 for vif11.
test_packet() {
    local inport=$1 eth_dst=$2 eth_src=$3; shift; shift; shift
    uflow="inport==\"lp$inport\" && eth.dst==$eth_dst && eth.src==$eth_src"
    while :; do
        case $1 in # (
            -vlan) uflow="$uflow && vlan.vid == 1234"; shift ;; # (
            -eth) uflow="$uflow && eth.type == 0x$2"; shift; shift ;; # (
            *) break ;;
        esac
    done
    for outport; do
        echo "output(\"lp$outport\");"
    done > expout

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2856: ovn_trace_client ovn-trace --minimal lsw0 \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace_client ovn-trace --minimal lsw0 \"$uflow\"" "ovn.at:2856"
( $at_check_trace; ovn_trace_client ovn-trace --minimal lsw0 "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2856"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

}

# test_arp INPORT SHA SPA TPA [REPLY_HA]
#
# Causes a packet to be received on INPORT.  The packet is an ARP
# request with SHA, SPA, and TPA as specified.  If REPLY_HA is provided, then
# it should be the hardware address of the target to expect to receive in an
# ARP reply; otherwise no reply is expected.
#
# INPORT is an logical switch port number, e.g. 11 for vif11.
# SHA and REPLY_HA are each 12 hex digits.
# SPA and TPA are each 8 hex digits.
test_arp() {
    local inport=$1 sha=$2 spa=$3 tpa=$4 reply_ha=$5

    local request="inport == \"lp$inport\"
                   && eth.dst == ff:ff:ff:ff:ff:ff && eth.src == $sha
                   && arp.op == 1 && arp.sha == $sha && arp.spa == $spa
                   && arp.tha == ff:ff:ff:ff:ff:ff && arp.tpa == $tpa"

    if test -z "$reply_ha"; then
        reply=
        local i
        for i in 1 2 3; do
            if test $i != $inport; then
                reply="${reply}output(\"lp$i\");
"
            fi
        done
    else
        reply="\
eth.dst = $sha;
eth.src = $reply_ha;
arp.op = 2;
arp.tha = $sha;
arp.sha = $reply_ha;
arp.tpa = $spa;
arp.spa = $tpa;
output(\"lp$inport\");
"
    fi

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:2856: ovn_trace_client ovn-trace --minimal lsw0 \"\$request\""
at_fn_check_prepare_dynamic "ovn_trace_client ovn-trace --minimal lsw0 \"$request\"" "ovn.at:2856"
( $at_check_trace; ovn_trace_client ovn-trace --minimal lsw0 "$request"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "$reply" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2856"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

}

# Send packets between all pairs of source and destination ports:
#
# 1. Unicast packets are delivered to exactly one logical switch port
#    (except that packets destined to their input ports are dropped).
#
# 2. Broadcast and multicast are delivered to all logical switch ports
#    except the input port.
#
# 3. When port security is turned on, the switch drops packets from the wrong
#    MAC address.
#
# 4. The switch drops all packets with a VLAN tag.
#
# 5. The switch drops all packets with a multicast source address.  (This only
#    affects behavior when port security is turned off, since otherwise port
#    security would drop the packet anyway.)
#
# 6. The switch delivers packets with an unknown destination to logical
#    switch ports with "unknown" among their MAC addresses (and port
#    security disabled).
#
# 7. The switch drops unicast packets that violate an ACL.
#
# 8. The switch drops multicast and broadcast packets that violate an ACL.
#
# 9. OVN generates responses to ARP requests for known IPs, except for
#    requests from a port for the port's own IP.
#
# 10. No response to ARP requests for unknown IPs.

for s in 1 2 3; do
    bcast=
    unknown=
    bacl2=
    bacl3=
    for d in 1 2 3; do
        echo
        echo "lp$s -> lp$d"
        if test $d != $s; then unicast=$d; else unicast=; fi
        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:0$s $unicast      #1

        if test $d != $s && test $s = 1; then
            impersonate=$d
        else
            impersonate=
        fi
        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:55 $impersonate   #3

        if test $d != $s && test $s != 1; then acl2=$d; else acl2=; fi
        if test $d != $s && test $d != 3; then acl3=$d; else acl3=; fi
        if test $d = $s || ( (test $s = 1 || test $s = 2) && test $d = 3); then
            # Source of 1 or 2 and dest of 3 should be dropped
            # due to the 4th ACL that uses address_set(set1).
            acl4=
        else
            acl4=$d
        fi

        #7, acl1 to acl4:
        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:0$s -eth 1234
        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:0$s -eth 1235 $acl2
        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:0$s -eth 1236 $acl3
        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:0$s -eth 1237 $acl4

        test_packet $s f0:00:00:00:00:0$d f0:00:00:00:00:55 -vlan          #4
        test_packet $s f0:00:00:00:00:0$d 01:00:00:00:00:0$s               #5

        if test $d != $s && test $d = 1; then
            unknown="$unknown $d"
        fi
        bcast="$bcast $unicast"
        bacl2="$bacl2 $acl2"
        bacl3="$bacl3 $acl3"

        sip=192.168.0.$s
        tip=192.168.0.$d
        tip_unknown=11.11.11.11
        reply_ha=;
        if test $d != $s; then
            if test $d != 1; then
                reply_ha=f0:00:00:00:00:0$d;
            fi
        fi

        test_arp $s f0:00:00:00:00:0$s $sip $tip $reply_ha                 #9
        test_arp $s f0:00:00:00:00:0$s $sip $tip_unknown                   #10

        if test $d = 3; then
            # lp3 has an additional ip 192.169.0.[123]3.
            tip=192.169.0.$d
            test_arp $s f0:00:00:00:00:0$s $sip $tip $reply_ha             #9
        fi
    done

    # Broadcast and multicast.
    test_packet $s ff:ff:ff:ff:ff:ff f0:00:00:00:00:0$s $bcast             #2
    test_packet $s 01:00:00:00:00:00 f0:00:00:00:00:0$s $bcast             #2
    if test $s = 1; then
       bcast_impersonate=$bcast
    else
       bcast_impersonate=
    fi
    test_packet $s 01:00:00:00:00:00 f0:00:00:00:00:44 $bcast_impersonate  #3

    test_packet $s f0:00:00:00:ff:ff f0:00:00:00:00:0$s $unknown           #6

    #8, acl1 to acl3:
    test_packet $s ff:ff:ff:ff:ff:ff f0:00:00:00:00:0$s -eth 1234
    test_packet $s ff:ff:ff:ff:ff:ff f0:00:00:00:00:0$s -eth 1235 $bacl2
    test_packet $s ff:ff:ff:ff:ff:ff f0:00:00:00:00:0$s -eth 1236 $bacl3

    #8, acl1 to acl3:
    test_packet $s 01:00:00:00:00:00 f0:00:00:00:00:0$s -eth 1234
    test_packet $s 01:00:00:00:00:00 f0:00:00:00:00:0$s -eth 1235 $bacl2
    test_packet $s 01:00:00:00:00:00 f0:00:00:00:00:0$s -eth 1236 $bacl3
done

# send packets for unknown datapath

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:2856: ovn-appctl -t ovn-trace trace --all lsw100 \"inport == p100 && ip4.dst == 10.96.57.175\""
at_fn_check_prepare_trace "ovn.at:2856"
( $at_check_trace; ovn-appctl -t ovn-trace trace --all lsw100 "inport == p100 && ip4.dst == 10.96.57.175"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "unknown datapath \"lsw100\"
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:2856"
$at_failed && at_fn_log_failure  \
"sbflows" \
"trace"
$at_traceon; }


ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_48
#AT_START_49
at_fn_group_banner 49 'ovn.at:3092' \
  "2 HVs, 4 lports/HV, localnet ports -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "49. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

# In this test cases we create 3 switches, all connected to same
# physical network (through br-phys on each HV). Each switch has
# VIF ports across 2 HVs. Each HV has 5 VIF ports. The first digit
# of VIF port name indicates the hypervisor it is bound to, e.g.
# lp23 means VIF 3 on hv2.
#
# Each switch's VLAN tag and their logical switch ports are:
#   - ls1:
#       - untagged
#       - ports: lp11, lp12, lp21, lp22
#
#   - ls2:
#       - tagged with VLAN 101
#       - ports: lp13, lp14, lp23, lp24
#   - ls3:
#       - untagged
#       - ports: lp15, lp25
#
# Note: a localnet port is created for each switch to connect to
# physical network.

for i in 1 2 3; do
    ls_name=ls$i
    check ovn-nbctl ls-add $ls_name
    ln_port_name=ln$i
    if test $i -eq 2; then
        check ovn-nbctl lsp-add $ls_name $ln_port_name "" 101
    else
        check ovn-nbctl lsp-add $ls_name $ln_port_name
    fi
    check ovn-nbctl lsp-set-addresses $ln_port_name unknown
    check ovn-nbctl lsp-set-type $ln_port_name localnet
    check ovn-nbctl lsp-set-options $ln_port_name network_name=phys
done

# lsp_to_ls LSP
#
# Prints the name of the logical switch that contains LSP.
lsp_to_ls () {
    case $1 in         lp?[12]) echo ls1 ;;         lp?[34]) echo ls2 ;;         lp?5) echo ls3 ;;         *) printf "%s\n" "ovn.at:3092" >"$at_check_line_file"
at_fn_check_skip 99 "$at_srcdir/ovn.at:3092" ;;
    esac
}

net_add n1
for i in 1 2; do
    sim_add hv$i
    as hv$i
    ovs-vsctl add-br br-phys
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys:br-phys
    ovn_attach n1 br-phys 192.168.0.$i

    for j in 1 2 3 4 5; do
        ovs-vsctl add-port br-int vif$i$j -- \
            set Interface vif$i$j external-ids:iface-id=lp$i$j \
                                  options:tx_pcap=hv$i/vif$i$j-tx.pcap \
                                  options:rxq_pcap=hv$i/vif$i$j-rx.pcap \
                                  ofport-request=$i$j

        lsp_name=lp$i$j
        ls_name=$(lsp_to_ls $lsp_name)

        check ovn-nbctl lsp-add $ls_name $lsp_name
        check ovn-nbctl lsp-set-addresses $lsp_name f0:00:00:00:00:$i$j
        check ovn-nbctl lsp-set-port-security $lsp_name f0:00:00:00:00:$i$j

        check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up $lsp_name` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "until test x\`ovn-nbctl lsp-get-up \$lsp_name\` = xup"

    done
done
wait_for_ports_up
ovn_wait_patch_port_flows ""ln1" "ln2" "ln3"" ""hv1" "hv2"" "tests/ovn.at:3092"

check ovn-nbctl --wait=sb sync
ovn-sbctl dump-flows > sbflows


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


# XXX This is now the 3rd copy of these functions in this file ...

# Given the name of a logical port, prints the name of the hypervisor
# on which it is located.
vif_to_hv() {
    echo hv${1%?}
}
#
# test_packet INPORT DST SRC ETHTYPE EOUT LOUT
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  INPORT is specified as
# logical switch port numbers, e.g. 11 for vif11.
#
# EOUT is the end-to-end output port, that is, where the packet will end up
# after possibly bouncing through one or more localnet ports.  LOUT is the
# logical output port, which might be a localnet port, as seen by ovn-trace
# (which doesn't know what localnet ports are connected to and therefore can't
# figure out the end-to-end answer).
for i in 1 2; do
    for j in 1 2 3 4 5; do
        : > $i$j.expected
    done
done
test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 eout=$5 lout=$6
    echo "$@"

    # First try tracing the packet.
    uflow="inport==\"lp$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth"
    if test $lout != drop; then
        echo "output(\"$lout\");"
    fi > expout
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovn_trace --minimal \$(lsp_to_ls lp\$inport) \"\$uflow\""
at_fn_check_prepare_notrace 'a $(...) command substitution' "ovn.at:3092"
( $at_check_trace; ovn_trace --minimal $(lsp_to_ls lp$inport) "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}
    hv=`vif_to_hv $inport`
    vif=vif$inport
    as $hv ovs-appctl netdev-dummy/receive $vif $packet
    if test $eout != drop; then
        echo $packet >> ${eout#lp}.expected
    fi
}

# lp11 and lp21 are on the same network (phys, untagged)
# and on different hypervisors
test_packet 11 f0:00:00:00:00:21 f0:00:00:00:00:11 1121 lp21 lp21
test_packet 21 f0:00:00:00:00:11 f0:00:00:00:00:21 2111 lp11 lp11

# lp11 and lp12 are on the same network (phys, untagged)
# and on the same hypervisor
test_packet 11 f0:00:00:00:00:12 f0:00:00:00:00:11 1112 lp12 lp12
test_packet 12 f0:00:00:00:00:11 f0:00:00:00:00:12 1211 lp11 lp11

# lp13 and lp23 are on the same network (phys, VLAN 101)
# and on different hypervisors
test_packet 13 f0:00:00:00:00:23 f0:00:00:00:00:13 1323 lp23 lp23
test_packet 23 f0:00:00:00:00:13 f0:00:00:00:00:23 2313 lp13 lp13

# lp13 and lp14 are on the same network (phys, VLAN 101)
# and on the same hypervisor
test_packet 13 f0:00:00:00:00:14 f0:00:00:00:00:13 1314 lp14 lp14
test_packet 14 f0:00:00:00:00:13 f0:00:00:00:00:14 1413 lp13 lp13

# lp11 and lp15 are on the same network (phys, untagged),
# same hypervisor, and on different switches
test_packet 11 f0:00:00:00:00:15 f0:00:00:00:00:11 1115 lp15 ln1
test_packet 15 f0:00:00:00:00:11 f0:00:00:00:00:15 1511 lp11 ln3

# lp11 and lp25 are on the same network (phys, untagged),
# different hypervisors, and on different switches
test_packet 11 f0:00:00:00:00:25 f0:00:00:00:00:11 1125 lp25 ln1
test_packet 25 f0:00:00:00:00:11 f0:00:00:00:00:25 2511 lp11 ln3

# Ports that should not be able to communicate
test_packet 11 f0:00:00:00:00:13 f0:00:00:00:00:11 1113 drop ln1
test_packet 11 f0:00:00:00:00:23 f0:00:00:00:00:11 1123 drop ln1
test_packet 21 f0:00:00:00:00:13 f0:00:00:00:00:21 2113 drop ln1
test_packet 21 f0:00:00:00:00:23 f0:00:00:00:00:21 2123 drop ln1
test_packet 13 f0:00:00:00:00:11 f0:00:00:00:00:13 1311 drop ln2
test_packet 13 f0:00:00:00:00:21 f0:00:00:00:00:13 1321 drop ln2
test_packet 23 f0:00:00:00:00:11 f0:00:00:00:00:23 2311 drop ln2
test_packet 23 f0:00:00:00:00:21 f0:00:00:00:00:23 2321 drop ln2

# Dump a bunch of info helpful for debugging if there's a failure.

echo "------ OVN dump ------"
ovn-nbctl show
ovn-sbctl show

echo "------ hv1 dump ------"
as hv1 ovs-vsctl show
as hv1 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv2 dump ------"
as hv2 ovs-vsctl show
as hv2 ovs-ofctl -O OpenFlow13 dump-flows br-int

# Now check the packets actually received against the ones expected.
for i in 1 2; do
    for j in 1 2 3 4 5; do
        ovn_check_packets_remove_broadcast__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected" "tests/ovn.at:3092"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3092"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
if $at_failed
then :
  dump_diff__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

    done
done



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3092"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3092"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3092"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3092"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3092"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3092"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_49
#AT_START_50
at_fn_group_banner 50 'ovn.at:3092' \
  "2 HVs, 4 lports/HV, localnet ports -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "50. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

# In this test cases we create 3 switches, all connected to same
# physical network (through br-phys on each HV). Each switch has
# VIF ports across 2 HVs. Each HV has 5 VIF ports. The first digit
# of VIF port name indicates the hypervisor it is bound to, e.g.
# lp23 means VIF 3 on hv2.
#
# Each switch's VLAN tag and their logical switch ports are:
#   - ls1:
#       - untagged
#       - ports: lp11, lp12, lp21, lp22
#
#   - ls2:
#       - tagged with VLAN 101
#       - ports: lp13, lp14, lp23, lp24
#   - ls3:
#       - untagged
#       - ports: lp15, lp25
#
# Note: a localnet port is created for each switch to connect to
# physical network.

for i in 1 2 3; do
    ls_name=ls$i
    check ovn-nbctl ls-add $ls_name
    ln_port_name=ln$i
    if test $i -eq 2; then
        check ovn-nbctl lsp-add $ls_name $ln_port_name "" 101
    else
        check ovn-nbctl lsp-add $ls_name $ln_port_name
    fi
    check ovn-nbctl lsp-set-addresses $ln_port_name unknown
    check ovn-nbctl lsp-set-type $ln_port_name localnet
    check ovn-nbctl lsp-set-options $ln_port_name network_name=phys
done

# lsp_to_ls LSP
#
# Prints the name of the logical switch that contains LSP.
lsp_to_ls () {
    case $1 in         lp?[12]) echo ls1 ;;         lp?[34]) echo ls2 ;;         lp?5) echo ls3 ;;         *) printf "%s\n" "ovn.at:3092" >"$at_check_line_file"
at_fn_check_skip 99 "$at_srcdir/ovn.at:3092" ;;
    esac
}

net_add n1
for i in 1 2; do
    sim_add hv$i
    as hv$i
    ovs-vsctl add-br br-phys
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys:br-phys
    ovn_attach n1 br-phys 192.168.0.$i

    for j in 1 2 3 4 5; do
        ovs-vsctl add-port br-int vif$i$j -- \
            set Interface vif$i$j external-ids:iface-id=lp$i$j \
                                  options:tx_pcap=hv$i/vif$i$j-tx.pcap \
                                  options:rxq_pcap=hv$i/vif$i$j-rx.pcap \
                                  ofport-request=$i$j

        lsp_name=lp$i$j
        ls_name=$(lsp_to_ls $lsp_name)

        check ovn-nbctl lsp-add $ls_name $lsp_name
        check ovn-nbctl lsp-set-addresses $lsp_name f0:00:00:00:00:$i$j
        check ovn-nbctl lsp-set-port-security $lsp_name f0:00:00:00:00:$i$j

        check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up $lsp_name` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "until test x\`ovn-nbctl lsp-get-up \$lsp_name\` = xup"

    done
done
wait_for_ports_up
ovn_wait_patch_port_flows ""ln1" "ln2" "ln3"" ""hv1" "hv2"" "tests/ovn.at:3092"

check ovn-nbctl --wait=sb sync
ovn-sbctl dump-flows > sbflows


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


# XXX This is now the 3rd copy of these functions in this file ...

# Given the name of a logical port, prints the name of the hypervisor
# on which it is located.
vif_to_hv() {
    echo hv${1%?}
}
#
# test_packet INPORT DST SRC ETHTYPE EOUT LOUT
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  INPORT is specified as
# logical switch port numbers, e.g. 11 for vif11.
#
# EOUT is the end-to-end output port, that is, where the packet will end up
# after possibly bouncing through one or more localnet ports.  LOUT is the
# logical output port, which might be a localnet port, as seen by ovn-trace
# (which doesn't know what localnet ports are connected to and therefore can't
# figure out the end-to-end answer).
for i in 1 2; do
    for j in 1 2 3 4 5; do
        : > $i$j.expected
    done
done
test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 eout=$5 lout=$6
    echo "$@"

    # First try tracing the packet.
    uflow="inport==\"lp$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth"
    if test $lout != drop; then
        echo "output(\"$lout\");"
    fi > expout
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovn_trace --minimal \$(lsp_to_ls lp\$inport) \"\$uflow\""
at_fn_check_prepare_notrace 'a $(...) command substitution' "ovn.at:3092"
( $at_check_trace; ovn_trace --minimal $(lsp_to_ls lp$inport) "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}
    hv=`vif_to_hv $inport`
    vif=vif$inport
    as $hv ovs-appctl netdev-dummy/receive $vif $packet
    if test $eout != drop; then
        echo $packet >> ${eout#lp}.expected
    fi
}

# lp11 and lp21 are on the same network (phys, untagged)
# and on different hypervisors
test_packet 11 f0:00:00:00:00:21 f0:00:00:00:00:11 1121 lp21 lp21
test_packet 21 f0:00:00:00:00:11 f0:00:00:00:00:21 2111 lp11 lp11

# lp11 and lp12 are on the same network (phys, untagged)
# and on the same hypervisor
test_packet 11 f0:00:00:00:00:12 f0:00:00:00:00:11 1112 lp12 lp12
test_packet 12 f0:00:00:00:00:11 f0:00:00:00:00:12 1211 lp11 lp11

# lp13 and lp23 are on the same network (phys, VLAN 101)
# and on different hypervisors
test_packet 13 f0:00:00:00:00:23 f0:00:00:00:00:13 1323 lp23 lp23
test_packet 23 f0:00:00:00:00:13 f0:00:00:00:00:23 2313 lp13 lp13

# lp13 and lp14 are on the same network (phys, VLAN 101)
# and on the same hypervisor
test_packet 13 f0:00:00:00:00:14 f0:00:00:00:00:13 1314 lp14 lp14
test_packet 14 f0:00:00:00:00:13 f0:00:00:00:00:14 1413 lp13 lp13

# lp11 and lp15 are on the same network (phys, untagged),
# same hypervisor, and on different switches
test_packet 11 f0:00:00:00:00:15 f0:00:00:00:00:11 1115 lp15 ln1
test_packet 15 f0:00:00:00:00:11 f0:00:00:00:00:15 1511 lp11 ln3

# lp11 and lp25 are on the same network (phys, untagged),
# different hypervisors, and on different switches
test_packet 11 f0:00:00:00:00:25 f0:00:00:00:00:11 1125 lp25 ln1
test_packet 25 f0:00:00:00:00:11 f0:00:00:00:00:25 2511 lp11 ln3

# Ports that should not be able to communicate
test_packet 11 f0:00:00:00:00:13 f0:00:00:00:00:11 1113 drop ln1
test_packet 11 f0:00:00:00:00:23 f0:00:00:00:00:11 1123 drop ln1
test_packet 21 f0:00:00:00:00:13 f0:00:00:00:00:21 2113 drop ln1
test_packet 21 f0:00:00:00:00:23 f0:00:00:00:00:21 2123 drop ln1
test_packet 13 f0:00:00:00:00:11 f0:00:00:00:00:13 1311 drop ln2
test_packet 13 f0:00:00:00:00:21 f0:00:00:00:00:13 1321 drop ln2
test_packet 23 f0:00:00:00:00:11 f0:00:00:00:00:23 2311 drop ln2
test_packet 23 f0:00:00:00:00:21 f0:00:00:00:00:23 2321 drop ln2

# Dump a bunch of info helpful for debugging if there's a failure.

echo "------ OVN dump ------"
ovn-nbctl show
ovn-sbctl show

echo "------ hv1 dump ------"
as hv1 ovs-vsctl show
as hv1 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv2 dump ------"
as hv2 ovs-vsctl show
as hv2 ovs-ofctl -O OpenFlow13 dump-flows br-int

# Now check the packets actually received against the ones expected.
for i in 1 2; do
    for j in 1 2 3 4 5; do
        ovn_check_packets_remove_broadcast__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected" "tests/ovn.at:3092"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3092"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
if $at_failed
then :
  dump_diff__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

    done
done



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3092"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3092"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3092"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3092"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3092"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3092"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3092"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3092: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3092"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3092"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3092" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_50
#AT_START_51
at_fn_group_banner 51 'ovn.at:3289' \
  "2 HVs, 2 LS, routing works for multiple collocated segments attached to different switches -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "51. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

for tag in `seq 10 30`; do
    net_add n-$tag
done

for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys11
    ovs-vsctl add-br br-phys21
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys-11:br-phys11,phys-21:br-phys21
    ovn_attach n-11 br-phys11 192.168.0.${i}1
    ovn_attach n-21 br-phys21 192.168.0.${i}2
done

for i in 1 2; do
    lsname=ls-${i}0
    check ovn-nbctl ls-add $lsname
    for tag in `seq ${i}1 ${i}9`; do
        ln_port_name=ln-$tag
        check ovn-nbctl lsp-add $lsname $ln_port_name "" $tag
        check ovn-nbctl lsp-set-addresses $ln_port_name unknown
        check ovn-nbctl lsp-set-type $ln_port_name localnet
        check ovn-nbctl lsp-set-options $ln_port_name network_name=phys-$tag
    done
done

for hv in 1 2; do
    as hv-$hv
    for ls in 1 2; do
        lsp_name=lp-$hv-$ls
        ovs-vsctl add-port br-int vif-$hv-$ls -- \
            set Interface vif-$hv-$ls external-ids:iface-id=$lsp_name \
                                  options:tx_pcap=hv-$hv/vif-$hv-$ls-tx.pcap \
                                  options:rxq_pcap=hv-$hv/vif-$hv-$ls-rx.pcap \
                                  ofport-request=$hv$ls

        check ovn-nbctl lsp-add ls-${ls}0 $lsp_name
        check ovn-nbctl lsp-set-addresses $lsp_name f0:00:00:00:00:${hv}${ls}
        check ovn-nbctl lsp-set-port-security $lsp_name f0:00:00:00:00:${hv}${ls}

        check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up $lsp_name` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "until test x\`ovn-nbctl lsp-get-up \$lsp_name\` = xup"

    done
done


wait_for_ports_up
check ovn-nbctl --wait=sb sync
ovn_wait_patch_port_flows ""ln-11" "ln-21"" ""hv-1" "hv-2"" "tests/ovn.at:3289"

ovn-sbctl dump-flows > sbflows


ovn-nbctl show > nbctl-show

ovn-sbctl show > sbctl-show


for i in 1 2; do
    hv=hv-$i
    echo "------ $hv dump ------"
    as $hv ovs-vsctl show
    as $hv ovs-ofctl -O OpenFlow13 dump-flows br-int
done

# vif ports
for i in 1-1 1-2 2-1 2-2; do
    : > vif-$i.expected
done

# localnet ports
for hv in 1 2; do
    : > out-$hv.expected
done

test_packet() {
    local hv=$1 inport=$2 outport=$3 dst=$4 src=$5 eth=$6 lout=$7

    : > expout
    if test $lout = unknown; then
        # Expect the packet cloned to all localnet ports
        for tag in `seq ${hv}1 ${hv}9`; do
            echo "output(\"ln-$tag\");" >> expout
        done
    else
        echo "output(\"$lout\");" >> expout
    fi

    # First try tracing the packet.
    uflow="inport==\"lp-$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth"
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovn_trace --minimal ls-\${hv}0 \"\$uflow\""
at_fn_check_prepare_notrace 'a ${...} parameter expansion' "ovn.at:3289"
( $at_check_trace; ovn_trace --minimal ls-${hv}0 "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show"
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}
    as hv-$hv ovs-appctl netdev-dummy/receive vif-$inport $packet

    if test $lout != unknown; then
        # Expect the packet received by the peer VIF port
        echo $packet >> vif-$outport.expected
    fi

    # regardless, the packet is sent through the bridge
    local packet=$(echo $dst$src | sed 's/://g')810000$(printf "%.2x\n" ${hv}1)${eth}
    echo $packet >> out-$hv.expected
}

test_packet 1 1-1 2-1 f0:00:00:00:00:21 f0:00:00:00:00:11 1001 lp-2-1
test_packet 2 2-2 1-2 f0:00:00:00:00:12 f0:00:00:00:00:22 1001 lp-1-2

# unknown mac goes through localnet port
test_packet 1 1-1 2-1 f0:00:00:00:00:e0 f0:00:00:00:00:11 1001 unknown
test_packet 2 2-2 1-2 f0:00:00:00:00:e0 f0:00:00:00:00:22 1001 unknown

# Now check the packets actually received against the ones expected.
for hv in 1 2; do
    for ls in 1 2; do
        port=$hv-$ls
        # check that packets targeted to actual vifs arrived on the other end
        ovn_check_packets_remove_broadcast__ "hv-$hv/vif-$port-tx.pcap" "vif-$port.expected" "tests/ovn.at:3289"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3289"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
if $at_failed
then :
  dump_diff__ "hv-$hv/vif-$port-tx.pcap" "vif-$port.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show"
$at_traceon; }

    done
    # check that all packets, whether to known or unknown mac addresses, were sent to fabric
    ovn_check_packets_remove_broadcast__ "hv-$hv/br-phys${hv}1_n-${hv}1-tx.pcap" "out-$hv.expected" "tests/ovn.at:3289"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3289"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
if $at_failed
then :
  dump_diff__ "hv-$hv/br-phys${hv}1_n-${hv}1-tx.pcap" "out-$hv.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show"
$at_traceon; }

done

# ovn-controller started twice (through ovn_attach) for each hv => expect "already running" error.


        sbox=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep '/')
        ignored_dp=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3289"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep '/')
        ignored_dp=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3289"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3289"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3289"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3289"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3289"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_51
#AT_START_52
at_fn_group_banner 52 'ovn.at:3289' \
  "2 HVs, 2 LS, routing works for multiple collocated segments attached to different switches -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "52. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

for tag in `seq 10 30`; do
    net_add n-$tag
done

for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys11
    ovs-vsctl add-br br-phys21
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys-11:br-phys11,phys-21:br-phys21
    ovn_attach n-11 br-phys11 192.168.0.${i}1
    ovn_attach n-21 br-phys21 192.168.0.${i}2
done

for i in 1 2; do
    lsname=ls-${i}0
    check ovn-nbctl ls-add $lsname
    for tag in `seq ${i}1 ${i}9`; do
        ln_port_name=ln-$tag
        check ovn-nbctl lsp-add $lsname $ln_port_name "" $tag
        check ovn-nbctl lsp-set-addresses $ln_port_name unknown
        check ovn-nbctl lsp-set-type $ln_port_name localnet
        check ovn-nbctl lsp-set-options $ln_port_name network_name=phys-$tag
    done
done

for hv in 1 2; do
    as hv-$hv
    for ls in 1 2; do
        lsp_name=lp-$hv-$ls
        ovs-vsctl add-port br-int vif-$hv-$ls -- \
            set Interface vif-$hv-$ls external-ids:iface-id=$lsp_name \
                                  options:tx_pcap=hv-$hv/vif-$hv-$ls-tx.pcap \
                                  options:rxq_pcap=hv-$hv/vif-$hv-$ls-rx.pcap \
                                  ofport-request=$hv$ls

        check ovn-nbctl lsp-add ls-${ls}0 $lsp_name
        check ovn-nbctl lsp-set-addresses $lsp_name f0:00:00:00:00:${hv}${ls}
        check ovn-nbctl lsp-set-port-security $lsp_name f0:00:00:00:00:${hv}${ls}

        check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up $lsp_name` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "until test x\`ovn-nbctl lsp-get-up \$lsp_name\` = xup"

    done
done


wait_for_ports_up
check ovn-nbctl --wait=sb sync
ovn_wait_patch_port_flows ""ln-11" "ln-21"" ""hv-1" "hv-2"" "tests/ovn.at:3289"

ovn-sbctl dump-flows > sbflows


ovn-nbctl show > nbctl-show

ovn-sbctl show > sbctl-show


for i in 1 2; do
    hv=hv-$i
    echo "------ $hv dump ------"
    as $hv ovs-vsctl show
    as $hv ovs-ofctl -O OpenFlow13 dump-flows br-int
done

# vif ports
for i in 1-1 1-2 2-1 2-2; do
    : > vif-$i.expected
done

# localnet ports
for hv in 1 2; do
    : > out-$hv.expected
done

test_packet() {
    local hv=$1 inport=$2 outport=$3 dst=$4 src=$5 eth=$6 lout=$7

    : > expout
    if test $lout = unknown; then
        # Expect the packet cloned to all localnet ports
        for tag in `seq ${hv}1 ${hv}9`; do
            echo "output(\"ln-$tag\");" >> expout
        done
    else
        echo "output(\"$lout\");" >> expout
    fi

    # First try tracing the packet.
    uflow="inport==\"lp-$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth"
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovn_trace --minimal ls-\${hv}0 \"\$uflow\""
at_fn_check_prepare_notrace 'a ${...} parameter expansion' "ovn.at:3289"
( $at_check_trace; ovn_trace --minimal ls-${hv}0 "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show"
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}
    as hv-$hv ovs-appctl netdev-dummy/receive vif-$inport $packet

    if test $lout != unknown; then
        # Expect the packet received by the peer VIF port
        echo $packet >> vif-$outport.expected
    fi

    # regardless, the packet is sent through the bridge
    local packet=$(echo $dst$src | sed 's/://g')810000$(printf "%.2x\n" ${hv}1)${eth}
    echo $packet >> out-$hv.expected
}

test_packet 1 1-1 2-1 f0:00:00:00:00:21 f0:00:00:00:00:11 1001 lp-2-1
test_packet 2 2-2 1-2 f0:00:00:00:00:12 f0:00:00:00:00:22 1001 lp-1-2

# unknown mac goes through localnet port
test_packet 1 1-1 2-1 f0:00:00:00:00:e0 f0:00:00:00:00:11 1001 unknown
test_packet 2 2-2 1-2 f0:00:00:00:00:e0 f0:00:00:00:00:22 1001 unknown

# Now check the packets actually received against the ones expected.
for hv in 1 2; do
    for ls in 1 2; do
        port=$hv-$ls
        # check that packets targeted to actual vifs arrived on the other end
        ovn_check_packets_remove_broadcast__ "hv-$hv/vif-$port-tx.pcap" "vif-$port.expected" "tests/ovn.at:3289"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3289"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
if $at_failed
then :
  dump_diff__ "hv-$hv/vif-$port-tx.pcap" "vif-$port.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show"
$at_traceon; }

    done
    # check that all packets, whether to known or unknown mac addresses, were sent to fabric
    ovn_check_packets_remove_broadcast__ "hv-$hv/br-phys${hv}1_n-${hv}1-tx.pcap" "out-$hv.expected" "tests/ovn.at:3289"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3289"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
if $at_failed
then :
  dump_diff__ "hv-$hv/br-phys${hv}1_n-${hv}1-tx.pcap" "out-$hv.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show"
$at_traceon; }

done

# ovn-controller started twice (through ovn_attach) for each hv => expect "already running" error.


        sbox=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep '/')
        ignored_dp=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3289"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep '/')
        ignored_dp=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3289"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3289"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3289"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3289"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3289"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3289"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3289: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3289"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3289"
$at_failed && at_fn_log_failure  \
"sbflows" \
"nbctl-show" \
"sbctl-show" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3289" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_52
#AT_START_53
at_fn_group_banner 53 'ovn.at:3432' \
  "2 HVs, 2 LS, broadcast traffic with multiple localnet ports per switch -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "53. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

for tag in `seq 10 30`; do
    net_add n-$tag
done

for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys11
    ovs-vsctl add-br br-phys21
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys-11:br-phys11,phys-21:br-phys21
    ovn_attach n-11 br-phys11 192.168.0.${i}1
    ovn_attach n-21 br-phys21 192.168.0.${i}2
done

for i in 1 2; do
    lsname=ls-${i}0
    check ovn-nbctl ls-add $lsname
    for tag in `seq ${i}1 ${i}9`; do
        ln_port_name=ln-$tag
        check ovn-nbctl lsp-add $lsname $ln_port_name "" $tag
        check ovn-nbctl lsp-set-addresses $ln_port_name unknown
        check ovn-nbctl lsp-set-type $ln_port_name localnet
        check ovn-nbctl lsp-set-options $ln_port_name network_name=phys-$tag
    done
done

for hv in 1 2; do
    as hv-$hv
    for ls in 1 2; do
        for peer in 8 9; do
            lsp_name=lp-$hv-$ls-$peer
            ovs-vsctl add-port br-int vif-$hv-$ls-$peer -- \
                set Interface vif-$hv-$ls-$peer external-ids:iface-id=$lsp_name \
                                      options:tx_pcap=hv-$hv/vif-$hv-$ls-$peer-tx.pcap \
                                      options:rxq_pcap=hv-$hv/vif-$hv-$ls-$peer-rx.pcap \
                                      ofport-request=$hv$ls$peer

            check ovn-nbctl lsp-add ls-${ls}0 $lsp_name
            check ovn-nbctl lsp-set-addresses $lsp_name f0:00:00:00:0${peer}:${hv}${ls}
            check ovn-nbctl lsp-set-port-security $lsp_name f0:00:00:00:0${peer}:${hv}${ls}

            check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up $lsp_name` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "until test x\`ovn-nbctl lsp-get-up \$lsp_name\` = xup"


            : > vif-$hv-$ls-$peer.expected
        done
    done
done


wait_for_ports_up
check ovn-nbctl --wait=sb sync
ovn-nbctl show
ovn-sbctl dump-flows > sbflows


echo "------ OVN dump ------"
ovn-nbctl show
ovn-sbctl show

for i in 1 2; do
    hv=hv-$i
    echo "------ $hv dump ------"
    as $hv ovs-vsctl show
    as $hv ovs-ofctl -O OpenFlow13 dump-flows br-int
done

# localnet ports
for hv in 1 2; do
    : > out-$hv.expected
done

test_packet() {
    local hv=$1 inport=$2 dst=$3 src=$4 eth=$5
    shift; shift; shift; shift; shift

    : > expout
    for lout in "$@"; do
        if test $lout = unknown; then
            # Expect the packet cloned to all localnet ports
            for tag in `seq ${hv}1 ${hv}9`; do
                echo "output(\"ln-$tag\");" >> expout
            done
        else
            echo "output(\"$lout\");" >> expout
        fi
    done

    # First try tracing the packet.
    uflow="inport==\"lp-$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth"
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovn_trace --minimal ls-\${hv}0 \"\$uflow\" | sort"
at_fn_check_prepare_notrace 'a ${...} parameter expansion' "ovn.at:3432"
( $at_check_trace; ovn_trace --minimal ls-${hv}0 "$uflow" | sort
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}
    as hv-$hv ovs-appctl netdev-dummy/receive vif-$inport $packet

    for lout in "$@"; do
        if test $lout != unknown; then
            # Expect the packet received by the peer VIF port
            echo $packet >> vif-${lout#lp-}.expected
        fi
    done

    # regardless, the packet is sent through the bridge
    local packet=$(echo $dst$src | sed 's/://g')810000$(printf "%.2x\n" ${hv}1)${eth}
    echo $packet >> out-$hv.expected
}

test_packet 1 1-1-8 f0:00:00:00:08:21 f0:00:00:00:08:11 1001 lp-2-1-8
test_packet 2 2-2-8 f0:00:00:00:08:12 f0:00:00:00:08:22 1001 lp-1-2-8

# unknown mac goes through localnet port
test_packet 1 1-1-8 f0:00:00:00:08:e0 f0:00:00:00:08:11 1001 unknown
test_packet 2 2-2-8 f0:00:00:00:08:e0 f0:00:00:00:08:22 1001 unknown

# broadcast traffic goes to all peers, foreign and local
test_packet 1 1-1-8 ff:ff:ff:ff:ff:ff f0:00:00:00:08:11 1001 $(for n in `seq 11 19`; do echo ln-$n; done) lp-1-1-9 lp-2-1-8 lp-2-1-9

# Now check the packets actually received against the ones expected.
for hv in 1 2; do
    for ls in 1 2; do
        for peer in 8 9; do
            port=$hv-$ls-$peer
            # check that packets targeted to actual vifs arrived on the other end
            ovn_wait_packets__ "hv-$hv/vif-$port-tx.pcap" "vif-$port.expected" "tests/ovn.at:3432"
        done
    done
    # check that all packets, whether to known or unknown mac addresses, were sent to fabric
    ovn_wait_packets__ "hv-$hv/br-phys${hv}1_n-${hv}1-tx.pcap" "out-$hv.expected" "tests/ovn.at:3432"
done

# ovn-controller started twice (through ovn_attach) for each hv => expect "already running" error.


        sbox=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep '/')
        ignored_dp=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3432"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep '/')
        ignored_dp=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3432"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3432"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3432"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3432"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3432"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"





ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_53
#AT_START_54
at_fn_group_banner 54 'ovn.at:3432' \
  "2 HVs, 2 LS, broadcast traffic with multiple localnet ports per switch -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "54. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

for tag in `seq 10 30`; do
    net_add n-$tag
done

for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys11
    ovs-vsctl add-br br-phys21
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys-11:br-phys11,phys-21:br-phys21
    ovn_attach n-11 br-phys11 192.168.0.${i}1
    ovn_attach n-21 br-phys21 192.168.0.${i}2
done

for i in 1 2; do
    lsname=ls-${i}0
    check ovn-nbctl ls-add $lsname
    for tag in `seq ${i}1 ${i}9`; do
        ln_port_name=ln-$tag
        check ovn-nbctl lsp-add $lsname $ln_port_name "" $tag
        check ovn-nbctl lsp-set-addresses $ln_port_name unknown
        check ovn-nbctl lsp-set-type $ln_port_name localnet
        check ovn-nbctl lsp-set-options $ln_port_name network_name=phys-$tag
    done
done

for hv in 1 2; do
    as hv-$hv
    for ls in 1 2; do
        for peer in 8 9; do
            lsp_name=lp-$hv-$ls-$peer
            ovs-vsctl add-port br-int vif-$hv-$ls-$peer -- \
                set Interface vif-$hv-$ls-$peer external-ids:iface-id=$lsp_name \
                                      options:tx_pcap=hv-$hv/vif-$hv-$ls-$peer-tx.pcap \
                                      options:rxq_pcap=hv-$hv/vif-$hv-$ls-$peer-rx.pcap \
                                      ofport-request=$hv$ls$peer

            check ovn-nbctl lsp-add ls-${ls}0 $lsp_name
            check ovn-nbctl lsp-set-addresses $lsp_name f0:00:00:00:0${peer}:${hv}${ls}
            check ovn-nbctl lsp-set-port-security $lsp_name f0:00:00:00:0${peer}:${hv}${ls}

            check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up $lsp_name` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "until test x\`ovn-nbctl lsp-get-up \$lsp_name\` = xup"


            : > vif-$hv-$ls-$peer.expected
        done
    done
done


wait_for_ports_up
check ovn-nbctl --wait=sb sync
ovn-nbctl show
ovn-sbctl dump-flows > sbflows


echo "------ OVN dump ------"
ovn-nbctl show
ovn-sbctl show

for i in 1 2; do
    hv=hv-$i
    echo "------ $hv dump ------"
    as $hv ovs-vsctl show
    as $hv ovs-ofctl -O OpenFlow13 dump-flows br-int
done

# localnet ports
for hv in 1 2; do
    : > out-$hv.expected
done

test_packet() {
    local hv=$1 inport=$2 dst=$3 src=$4 eth=$5
    shift; shift; shift; shift; shift

    : > expout
    for lout in "$@"; do
        if test $lout = unknown; then
            # Expect the packet cloned to all localnet ports
            for tag in `seq ${hv}1 ${hv}9`; do
                echo "output(\"ln-$tag\");" >> expout
            done
        else
            echo "output(\"$lout\");" >> expout
        fi
    done

    # First try tracing the packet.
    uflow="inport==\"lp-$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth"
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovn_trace --minimal ls-\${hv}0 \"\$uflow\" | sort"
at_fn_check_prepare_notrace 'a ${...} parameter expansion' "ovn.at:3432"
( $at_check_trace; ovn_trace --minimal ls-${hv}0 "$uflow" | sort
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}
    as hv-$hv ovs-appctl netdev-dummy/receive vif-$inport $packet

    for lout in "$@"; do
        if test $lout != unknown; then
            # Expect the packet received by the peer VIF port
            echo $packet >> vif-${lout#lp-}.expected
        fi
    done

    # regardless, the packet is sent through the bridge
    local packet=$(echo $dst$src | sed 's/://g')810000$(printf "%.2x\n" ${hv}1)${eth}
    echo $packet >> out-$hv.expected
}

test_packet 1 1-1-8 f0:00:00:00:08:21 f0:00:00:00:08:11 1001 lp-2-1-8
test_packet 2 2-2-8 f0:00:00:00:08:12 f0:00:00:00:08:22 1001 lp-1-2-8

# unknown mac goes through localnet port
test_packet 1 1-1-8 f0:00:00:00:08:e0 f0:00:00:00:08:11 1001 unknown
test_packet 2 2-2-8 f0:00:00:00:08:e0 f0:00:00:00:08:22 1001 unknown

# broadcast traffic goes to all peers, foreign and local
test_packet 1 1-1-8 ff:ff:ff:ff:ff:ff f0:00:00:00:08:11 1001 $(for n in `seq 11 19`; do echo ln-$n; done) lp-1-1-9 lp-2-1-8 lp-2-1-9

# Now check the packets actually received against the ones expected.
for hv in 1 2; do
    for ls in 1 2; do
        for peer in 8 9; do
            port=$hv-$ls-$peer
            # check that packets targeted to actual vifs arrived on the other end
            ovn_wait_packets__ "hv-$hv/vif-$port-tx.pcap" "vif-$port.expected" "tests/ovn.at:3432"
        done
    done
    # check that all packets, whether to known or unknown mac addresses, were sent to fabric
    ovn_wait_packets__ "hv-$hv/br-phys${hv}1_n-${hv}1-tx.pcap" "out-$hv.expected" "tests/ovn.at:3432"
done

# ovn-controller started twice (through ovn_attach) for each hv => expect "already running" error.


        sbox=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep '/')
        ignored_dp=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3432"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep '/')
        ignored_dp=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3432"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-1
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-2-0'/d
/br-int: could not add port ovn-hv-2-1 (File exists)/d
/could not add network device ovn-hv-2-1 to ofproto/d
"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3432"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3432"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
" |sed -n '1p')
        error=$(echo "hv-2
/ovn-controller.pid: already running as pid/d
/attempting to add tunnel port with same config as port 'ovn-hv-1-0'/d
/br-int: could not add port ovn-hv-1-1 (File exists)/d
/could not add network device ovn-hv-1-1 to ofproto/d
"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3432"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3432"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3432"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3432: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3432"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3432"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3432" "while kill -0 \$TMPPID 2>/dev/null"





ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_54
#AT_START_55
at_fn_group_banner 55 'ovn.at:3583' \
  "2 HVs, 2 LS, switching between multiple localnet ports with same tags -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "55. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

# In this test case we create two switches with multiple localnet ports. Only a
# single localnet of the same tag is connected to fabric for each switch. Two
# hypervisors have VIFs that belong to these switches. The test validates that
# routing between these switches and hypervisors still works regardless of the
# number of (unplugged) localnet ports.

# two switches, each connected to lots of networks
for i in 1 2; do
    check ovn-nbctl ls-add ls-$i
    for tag in `seq 10 20`; do
        ln_port_name=ln-$i-$tag
        check ovn-nbctl lsp-add ls-$i $ln_port_name "" $tag
        check ovn-nbctl lsp-set-addresses $ln_port_name unknown
        check ovn-nbctl lsp-set-type $ln_port_name localnet
        check ovn-nbctl lsp-set-options $ln_port_name network_name=phys-$tag
    done
done

# multiple networks
for tag in `seq 10 20`; do
    net_add n-$tag
done

# two hypervisors, each connected to the same network
for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys-20:br-phys
    ovn_attach n-10 br-phys 192.168.0.$i
done

# two vif ports, one per switch
for i in 1 2; do
    as hv-$i
    ovs-vsctl add-port br-int vif-$i -- \
        set Interface vif-$i external-ids:iface-id=lp-$i \
                              options:tx_pcap=hv-$i/vif-$i-tx.pcap \
                              options:rxq_pcap=hv-$i/vif-$i-rx.pcap \
                              ofport-request=$i

    lsp_name=lp-$i
    check ovn-nbctl lsp-add ls-$i $lsp_name
    check ovn-nbctl lsp-set-addresses $lsp_name f0:00:00:00:00:0$i
    check ovn-nbctl lsp-set-port-security $lsp_name f0:00:00:00:00:0$i

    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up $lsp_name` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "until test x\`ovn-nbctl lsp-get-up \$lsp_name\` = xup"

    ovn_wait_patch_port_flows ""ln-$i-20"" ""hv-$i"" "tests/ovn.at:3583"
done

wait_for_ports_up
check ovn-nbctl --wait=sb sync
ovn-nbctl show
ovn-sbctl dump-flows > sbflows


# vif ports
for i in 1 2; do
    : > vif-$i.expected
done

# localnet ports
for i in 1 2; do
    for tag in `seq 10 20`; do
        : > $i-$tag.expected
    done
done

test_packet() {
    local inport=$1 outport=$2 dst=$3 src=$4 eth=$5 eout=$6 lout=$7

    # Expect the packet cloned to all localnet ports
    : > expout
    for tag in `seq 10 20`; do
        echo "output(\"ln-$inport-$tag\");" >> expout
    done

    # First try tracing the packet.
    uflow="inport==\"lp-$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth"
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovn_trace --minimal ls-\$inport \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace --minimal ls-$inport \"$uflow\"" "ovn.at:3583"
( $at_check_trace; ovn_trace --minimal ls-$inport "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}
    as hv-$1 ovs-appctl netdev-dummy/receive vif-$inport $packet

    # Expect the packet received by the peer VIF port
    echo $packet >> vif-$outport.expected

    # Expect the packet to transfer through the common fabric network
    local packet=$(echo $dst$src | sed 's/://g')810000$(printf "%.2x" 20)${eth}
    echo $packet >> $1-10.expected
}

test_packet 1 2 f0:00:00:00:00:02 f0:00:00:00:00:01 1001 ln-1-10 ln-1-10
test_packet 1 2 f0:00:00:00:00:02 f0:00:00:00:00:01 1002 ln-1-10 ln-1-10

test_packet 2 1 f0:00:00:00:00:01 f0:00:00:00:00:02 1003 ln-2-10 ln-2-10
test_packet 2 1 f0:00:00:00:00:01 f0:00:00:00:00:02 1004 ln-2-10 ln-2-10

# Dump a bunch of info helpful for debugging if there's a failure.

echo "------ OVN dump ------"
ovn-nbctl show
ovn-sbctl show

for i in 1 2; do
    hv=hv-$i
    echo "------ $hv dump ------"
    as $hv ovs-vsctl show
    as $hv ovs-ofctl -O OpenFlow13 dump-flows br-int
done

# Now check the packets actually received against the ones expected.
for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "hv-$i/vif-$i-tx.pcap" "vif-$i.expected" "tests/ovn.at:3583"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3583"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
if $at_failed
then :
  dump_diff__ "hv-$i/vif-$i-tx.pcap" "vif-$i.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

    ovn_check_packets_remove_broadcast__ "hv-$i/br-phys_n-10-tx.pcap" "$i-10.expected" "tests/ovn.at:3583"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3583"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
if $at_failed
then :
  dump_diff__ "hv-$i/br-phys_n-10-tx.pcap" "$i-10.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

done



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')
        ignored_dp=$(echo "hv-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3583"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')
        ignored_dp=$(echo "hv-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3583"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3583"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3583"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3583"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3583"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_55
#AT_START_56
at_fn_group_banner 56 'ovn.at:3583' \
  "2 HVs, 2 LS, switching between multiple localnet ports with same tags -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "56. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

# In this test case we create two switches with multiple localnet ports. Only a
# single localnet of the same tag is connected to fabric for each switch. Two
# hypervisors have VIFs that belong to these switches. The test validates that
# routing between these switches and hypervisors still works regardless of the
# number of (unplugged) localnet ports.

# two switches, each connected to lots of networks
for i in 1 2; do
    check ovn-nbctl ls-add ls-$i
    for tag in `seq 10 20`; do
        ln_port_name=ln-$i-$tag
        check ovn-nbctl lsp-add ls-$i $ln_port_name "" $tag
        check ovn-nbctl lsp-set-addresses $ln_port_name unknown
        check ovn-nbctl lsp-set-type $ln_port_name localnet
        check ovn-nbctl lsp-set-options $ln_port_name network_name=phys-$tag
    done
done

# multiple networks
for tag in `seq 10 20`; do
    net_add n-$tag
done

# two hypervisors, each connected to the same network
for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys-20:br-phys
    ovn_attach n-10 br-phys 192.168.0.$i
done

# two vif ports, one per switch
for i in 1 2; do
    as hv-$i
    ovs-vsctl add-port br-int vif-$i -- \
        set Interface vif-$i external-ids:iface-id=lp-$i \
                              options:tx_pcap=hv-$i/vif-$i-tx.pcap \
                              options:rxq_pcap=hv-$i/vif-$i-rx.pcap \
                              ofport-request=$i

    lsp_name=lp-$i
    check ovn-nbctl lsp-add ls-$i $lsp_name
    check ovn-nbctl lsp-set-addresses $lsp_name f0:00:00:00:00:0$i
    check ovn-nbctl lsp-set-port-security $lsp_name f0:00:00:00:00:0$i

    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up $lsp_name` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "until test x\`ovn-nbctl lsp-get-up \$lsp_name\` = xup"

    ovn_wait_patch_port_flows ""ln-$i-20"" ""hv-$i"" "tests/ovn.at:3583"
done

wait_for_ports_up
check ovn-nbctl --wait=sb sync
ovn-nbctl show
ovn-sbctl dump-flows > sbflows


# vif ports
for i in 1 2; do
    : > vif-$i.expected
done

# localnet ports
for i in 1 2; do
    for tag in `seq 10 20`; do
        : > $i-$tag.expected
    done
done

test_packet() {
    local inport=$1 outport=$2 dst=$3 src=$4 eth=$5 eout=$6 lout=$7

    # Expect the packet cloned to all localnet ports
    : > expout
    for tag in `seq 10 20`; do
        echo "output(\"ln-$inport-$tag\");" >> expout
    done

    # First try tracing the packet.
    uflow="inport==\"lp-$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth"
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovn_trace --minimal ls-\$inport \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace --minimal ls-$inport \"$uflow\"" "ovn.at:3583"
( $at_check_trace; ovn_trace --minimal ls-$inport "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}
    as hv-$1 ovs-appctl netdev-dummy/receive vif-$inport $packet

    # Expect the packet received by the peer VIF port
    echo $packet >> vif-$outport.expected

    # Expect the packet to transfer through the common fabric network
    local packet=$(echo $dst$src | sed 's/://g')810000$(printf "%.2x" 20)${eth}
    echo $packet >> $1-10.expected
}

test_packet 1 2 f0:00:00:00:00:02 f0:00:00:00:00:01 1001 ln-1-10 ln-1-10
test_packet 1 2 f0:00:00:00:00:02 f0:00:00:00:00:01 1002 ln-1-10 ln-1-10

test_packet 2 1 f0:00:00:00:00:01 f0:00:00:00:00:02 1003 ln-2-10 ln-2-10
test_packet 2 1 f0:00:00:00:00:01 f0:00:00:00:00:02 1004 ln-2-10 ln-2-10

# Dump a bunch of info helpful for debugging if there's a failure.

echo "------ OVN dump ------"
ovn-nbctl show
ovn-sbctl show

for i in 1 2; do
    hv=hv-$i
    echo "------ $hv dump ------"
    as $hv ovs-vsctl show
    as $hv ovs-ofctl -O OpenFlow13 dump-flows br-int
done

# Now check the packets actually received against the ones expected.
for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "hv-$i/vif-$i-tx.pcap" "vif-$i.expected" "tests/ovn.at:3583"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3583"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
if $at_failed
then :
  dump_diff__ "hv-$i/vif-$i-tx.pcap" "vif-$i.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

    ovn_check_packets_remove_broadcast__ "hv-$i/br-phys_n-10-tx.pcap" "$i-10.expected" "tests/ovn.at:3583"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3583"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
if $at_failed
then :
  dump_diff__ "hv-$i/br-phys_n-10-tx.pcap" "$i-10.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

done



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')
        ignored_dp=$(echo "hv-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3583"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')
        ignored_dp=$(echo "hv-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3583"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3583"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3583"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3583"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3583"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3583"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3583: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3583"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3583"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3583" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_56
#AT_START_57
at_fn_group_banner 57 'ovn.at:3710' \
  "VLAN transparency, passthru=true, ARP responder disabled -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "57. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

printf "%s\n" "ovn.at:3710" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:3710"
ovn_start

net_add net
for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    check ovs-vsctl add-br br-phys
    check ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys:br-phys
    ovn_attach net br-phys 192.168.0.$i 24 vxlan
done

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=true

for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i "f0:00:00:00:00:0$i 10.0.0.$i"
done

for i in 1 2; do
    as hv-$i
    check ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
done

wait_for_ports_up

# Remote output flows are setup when pb of remote is received
# Hence they can be setup after both ports have been reported up.
ovn_wait_remote_output_flows ""hv-1"" ""hv-2"" "tests/ovn.at:3710"
ovn_wait_remote_output_flows ""hv-2"" ""hv-1"" "tests/ovn.at:3710"


ovn-sbctl dump-flows ls > lsflows


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: grep -w \"ls_in_arp_rsp\" lsflows | ovn_strip_lflows"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn.at:3710"
( $at_check_trace; grep -w "ls_in_arp_rsp" lsflows | ovn_strip_lflows
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "  table=??(ls_in_arp_rsp      ), priority=0    , match=(1), action=(next;)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }


for i in 1 2; do
    : > $i.expected
done

test_arp() {
    local inport=$1 outport=$2 sha=$3 spa=$4 tpa=$5 reply_ha=$6
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                             Dot1Q(vlan=0xefe)/ \
                             ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
    as hv-$inport ovs-appctl netdev-dummy/receive vif$inport $request
    echo $request >> $outport.expected

    local reply=$(fmt_pkt "Ether(dst='${sha}', src='${reply_ha}')/ \
                           Dot1Q(vlan=0xefe)/ \
                           ARP(op=2, hwsrc='${reply_ha}', hwdst='${sha}', psrc='${tpa}', pdst='${spa}')")
    as hv-$outport ovs-appctl netdev-dummy/receive vif$outport $reply
    echo $reply >> $inport.expected
}

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }


test_arp 1 2 f0:00:00:00:00:01 10.0.0.1 10.0.0.2 f0:00:00:00:00:02
test_arp 2 1 f0:00:00:00:00:02 10.0.0.2 10.0.0.1 f0:00:00:00:00:01

for i in 1 2; do
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" vif\$i-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" vif$i-tx.pcap " "ovn.at:3710"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" vif$i-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }

   ovn_check_packets__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:3710"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3710"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }

done



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')
        ignored_dp=$(echo "hv-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3710"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')
        ignored_dp=$(echo "hv-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3710"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3710"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3710"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3710"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3710"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_57
#AT_START_58
at_fn_group_banner 58 'ovn.at:3710' \
  "VLAN transparency, passthru=true, ARP responder disabled -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "58. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

printf "%s\n" "ovn.at:3710" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:3710"
ovn_start

net_add net
for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    check ovs-vsctl add-br br-phys
    check ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys:br-phys
    ovn_attach net br-phys 192.168.0.$i 24 vxlan
done

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=true

for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i "f0:00:00:00:00:0$i 10.0.0.$i"
done

for i in 1 2; do
    as hv-$i
    check ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
done

wait_for_ports_up

# Remote output flows are setup when pb of remote is received
# Hence they can be setup after both ports have been reported up.
ovn_wait_remote_output_flows ""hv-1"" ""hv-2"" "tests/ovn.at:3710"
ovn_wait_remote_output_flows ""hv-2"" ""hv-1"" "tests/ovn.at:3710"


ovn-sbctl dump-flows ls > lsflows


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: grep -w \"ls_in_arp_rsp\" lsflows | ovn_strip_lflows"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn.at:3710"
( $at_check_trace; grep -w "ls_in_arp_rsp" lsflows | ovn_strip_lflows
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "  table=??(ls_in_arp_rsp      ), priority=0    , match=(1), action=(next;)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }


for i in 1 2; do
    : > $i.expected
done

test_arp() {
    local inport=$1 outport=$2 sha=$3 spa=$4 tpa=$5 reply_ha=$6
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                             Dot1Q(vlan=0xefe)/ \
                             ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
    as hv-$inport ovs-appctl netdev-dummy/receive vif$inport $request
    echo $request >> $outport.expected

    local reply=$(fmt_pkt "Ether(dst='${sha}', src='${reply_ha}')/ \
                           Dot1Q(vlan=0xefe)/ \
                           ARP(op=2, hwsrc='${reply_ha}', hwdst='${sha}', psrc='${tpa}', pdst='${spa}')")
    as hv-$outport ovs-appctl netdev-dummy/receive vif$outport $reply
    echo $reply >> $inport.expected
}

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }


test_arp 1 2 f0:00:00:00:00:01 10.0.0.1 10.0.0.2 f0:00:00:00:00:02
test_arp 2 1 f0:00:00:00:00:02 10.0.0.2 10.0.0.1 f0:00:00:00:00:01

for i in 1 2; do
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" vif\$i-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" vif$i-tx.pcap " "ovn.at:3710"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" vif$i-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }

   ovn_check_packets__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:3710"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3710"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }

done



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')
        ignored_dp=$(echo "hv-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3710"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')
        ignored_dp=$(echo "hv-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3710"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3710"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3710"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3710"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3710"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3710"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3710: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3710"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3710"
$at_failed && at_fn_log_failure  \
"lsflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3710" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_58
#AT_START_59
at_fn_group_banner 59 'ovn.at:3790' \
  "VLAN transparency, passthru=true, ND/NA responder disabled -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "59. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

printf "%s\n" "ovn.at:3790" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:3790"
ovn_start

net_add net
check ovs-vsctl add-br br-phys
ovn_attach net br-phys 192.168.0.1

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=true

for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i "f0:00:00:00:00:0$i fe00::$i"
done

for i in 1 2; do
    check ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
done

wait_for_ports_up

ovn-sbctl dump-flows ls > lsflows


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:3790: grep -w \"ls_in_arp_rsp\" lsflows | ovn_strip_lflows"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn.at:3790"
( $at_check_trace; grep -w "ls_in_arp_rsp" lsflows | ovn_strip_lflows
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "  table=??(ls_in_arp_rsp      ), priority=0    , match=(1), action=(next;)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3790"
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }


test_nd_na() {
    local inport=$1 outport=$2 sha=$3 spa=$4 tpa=$5 reply_ha=$6
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                             Dot1Q(vlan=0xefe)/ \
                             IPv6(src='${spa}', dst=inet_ntop(AF_INET6, in6_getnsma(inet_pton(AF_INET6, '${tpa}'))))/ \
                             ICMPv6ND_NS(tgt='${tpa}')")
    ovs-appctl netdev-dummy/receive vif$inport $request
    echo $request >> $outport.expected
    echo $request

    local reply=$(fmt_pkt "Ether(dst='${sha}', src='${reply_ha}')/ \
                           Dot1Q(vlan=0xefe)/ \
                           IPv6(src='${tpa}', dst='${spa}')/ \
                           ICMPv6ND_NA(tgt='${tpa}')")
    ovs-appctl netdev-dummy/receive vif$outport $reply
    echo $reply >> $inport.expected
    echo $reply
}

test_nd_na 1 2 f0:00:00:00:00:01 fe00::1 fe00::2 f0:00:00:00:00:02
test_nd_na 2 1 f0:00:00:00:00:02 fe00::2 fe00::1 f0:00:00:00:00:01

for i in 1 2; do
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3790: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" vif\$i-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" vif$i-tx.pcap " "ovn.at:3790"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" vif$i-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3790"
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }

   ovn_check_packets__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:3790"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3790: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3790"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3790"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }

done

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_59
#AT_START_60
at_fn_group_banner 60 'ovn.at:3790' \
  "VLAN transparency, passthru=true, ND/NA responder disabled -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "60. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

printf "%s\n" "ovn.at:3790" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:3790"
ovn_start

net_add net
check ovs-vsctl add-br br-phys
ovn_attach net br-phys 192.168.0.1

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=true

for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i "f0:00:00:00:00:0$i fe00::$i"
done

for i in 1 2; do
    check ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
done

wait_for_ports_up

ovn-sbctl dump-flows ls > lsflows


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:3790: grep -w \"ls_in_arp_rsp\" lsflows | ovn_strip_lflows"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn.at:3790"
( $at_check_trace; grep -w "ls_in_arp_rsp" lsflows | ovn_strip_lflows
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "  table=??(ls_in_arp_rsp      ), priority=0    , match=(1), action=(next;)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3790"
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }


test_nd_na() {
    local inport=$1 outport=$2 sha=$3 spa=$4 tpa=$5 reply_ha=$6
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                             Dot1Q(vlan=0xefe)/ \
                             IPv6(src='${spa}', dst=inet_ntop(AF_INET6, in6_getnsma(inet_pton(AF_INET6, '${tpa}'))))/ \
                             ICMPv6ND_NS(tgt='${tpa}')")
    ovs-appctl netdev-dummy/receive vif$inport $request
    echo $request >> $outport.expected
    echo $request

    local reply=$(fmt_pkt "Ether(dst='${sha}', src='${reply_ha}')/ \
                           Dot1Q(vlan=0xefe)/ \
                           IPv6(src='${tpa}', dst='${spa}')/ \
                           ICMPv6ND_NA(tgt='${tpa}')")
    ovs-appctl netdev-dummy/receive vif$outport $reply
    echo $reply >> $inport.expected
    echo $reply
}

test_nd_na 1 2 f0:00:00:00:00:01 fe00::1 fe00::2 f0:00:00:00:00:02
test_nd_na 2 1 f0:00:00:00:00:02 fe00::2 fe00::1 f0:00:00:00:00:01

for i in 1 2; do
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3790: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" vif\$i-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" vif$i-tx.pcap " "ovn.at:3790"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" vif$i-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3790"
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }

   ovn_check_packets__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:3790"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3790: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3790"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3790"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure  \
"lsflows"
$at_traceon; }

done

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_60
#AT_START_61
at_fn_group_banner 61 'ovn.at:3852' \
  "VLAN transparency, passthru=true, multiple hosts -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "61. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=true

ln_port_name=ln-100
check ovn-nbctl lsp-add ls $ln_port_name "" 100
check ovn-nbctl lsp-set-addresses $ln_port_name unknown
check ovn-nbctl lsp-set-type $ln_port_name localnet
check ovn-nbctl lsp-set-options $ln_port_name network_name=phys-100
net_add n-100

# two hypervisors, each connected to the same network
for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys-100:br-phys
    ovn_attach n-100 br-phys 192.168.0.$i
done

for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i f0:00:00:00:00:0$i
done

for i in 1 2; do
    as hv-$i
    ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lsp$i` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "until test x\`ovn-nbctl lsp-get-up lsp\$i\` = xup"


    # Patch port might be created after ports are reported up
    # Wait for a flow outputing to patch port
    ovn_wait_patch_port_flows ""ln-100"" ""hv-$i"" "tests/ovn.at:3852"
done

test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 eout=$5 lout=$6

    # First try tracing the packet.
    uflow="inport==\"lsp$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth && vlan.present==1"
    echo "output(\"$lout\");" > expout
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovn_trace --minimal ls \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace --minimal ls \"$uflow\"" "ovn.at:3852"
( $at_check_trace; ovn_trace --minimal ls "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}fefefefe
    vif=vif$inport
    as hv-$1
    ovs-appctl netdev-dummy/receive $vif $packet
    echo $packet >> ${eout#lsp}.expected
}

test_packet 1 f0:00:00:00:00:02 f0:00:00:00:00:01 8100 lsp2 lsp2
test_packet 2 f0:00:00:00:00:01 f0:00:00:00:00:02 8100 lsp1 lsp1
for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:3852"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3852"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')
        ignored_dp=$(echo "hv-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3852"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')
        ignored_dp=$(echo "hv-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3852"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3852"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3852"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3852"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3852"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_61
#AT_START_62
at_fn_group_banner 62 'ovn.at:3852' \
  "VLAN transparency, passthru=true, multiple hosts -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "62. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=true

ln_port_name=ln-100
check ovn-nbctl lsp-add ls $ln_port_name "" 100
check ovn-nbctl lsp-set-addresses $ln_port_name unknown
check ovn-nbctl lsp-set-type $ln_port_name localnet
check ovn-nbctl lsp-set-options $ln_port_name network_name=phys-100
net_add n-100

# two hypervisors, each connected to the same network
for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys-100:br-phys
    ovn_attach n-100 br-phys 192.168.0.$i
done

for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i f0:00:00:00:00:0$i
done

for i in 1 2; do
    as hv-$i
    ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lsp$i` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "until test x\`ovn-nbctl lsp-get-up lsp\$i\` = xup"


    # Patch port might be created after ports are reported up
    # Wait for a flow outputing to patch port
    ovn_wait_patch_port_flows ""ln-100"" ""hv-$i"" "tests/ovn.at:3852"
done

test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 eout=$5 lout=$6

    # First try tracing the packet.
    uflow="inport==\"lsp$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth && vlan.present==1"
    echo "output(\"$lout\");" > expout
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovn_trace --minimal ls \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace --minimal ls \"$uflow\"" "ovn.at:3852"
( $at_check_trace; ovn_trace --minimal ls "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}fefefefe
    vif=vif$inport
    as hv-$1
    ovs-appctl netdev-dummy/receive $vif $packet
    echo $packet >> ${eout#lsp}.expected
}

test_packet 1 f0:00:00:00:00:02 f0:00:00:00:00:01 8100 lsp2 lsp2
test_packet 2 f0:00:00:00:00:01 f0:00:00:00:00:02 8100 lsp1 lsp1
for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:3852"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3852"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')
        ignored_dp=$(echo "hv-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3852"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')
        ignored_dp=$(echo "hv-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3852"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3852"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3852"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3852"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3852"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3852"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3852: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3852"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3852"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3852" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_62
#AT_START_63
at_fn_group_banner 63 'ovn.at:3919' \
  "VLAN transparency, passthru=true, multiple hosts, custom ethtype -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "63. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

ethtype=802.1ad

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=true

ln_port_name=ln-100
check ovn-nbctl lsp-add ls $ln_port_name "" 100
check ovn-nbctl lsp-set-addresses $ln_port_name unknown
check ovn-nbctl lsp-set-type $ln_port_name localnet
check ovn-nbctl lsp-set-options $ln_port_name network_name=phys-100 ethtype=$ethtype
net_add n-100

# two hypervisors, each connected to the same network
for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys-100:br-phys
    ovn_attach n-100 br-phys 192.168.0.$i
done

for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i f0:00:00:00:00:0$i
done

for i in 1 2; do
    as hv-$i
    check ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
    wait_for_ports_up lsp$i

    # Patch port might be created after ports are reported up
    # Wait for a flow outputing to patch port
    ovn_wait_patch_port_flows ""ln-100"" ""hv-$i"" "tests/ovn.at:3919"
done
# create taps on fabric to check vlan encapsulation there
for i in 1 2; do
    as hv-$i
    ovs-vsctl add-port br-phys tap$i -- set Interface tap$i \
                                  options:tx_pcap=tap$i-tx.pcap \
                                  options:rxq_pcap=tap$i-rx.pcap
done

for i in 1 2; do
    : > $i.expected
done
: > tap.expected

test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 lout=$5 ethtype=$6

    # First try tracing the packet.
    uflow="inport==\"lsp$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth && vlan.present==1"
    echo "output(\"$lout\");" > expout
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovn_trace --minimal ls \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace --minimal ls \"$uflow\"" "ovn.at:3919"
( $at_check_trace; ovn_trace --minimal ls "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    payload=fefefefe
    local packet=$(echo $dst$src | sed 's/://g')${eth}${payload}
    vif=vif$inport
    as hv-$1
    ovs-appctl netdev-dummy/receive $vif $packet
    echo $packet >> ${inport}.expected

    phys_packet=$(echo $dst$src | sed 's/://g')${ethtype}0064${eth}${payload}
    echo $phys_packet >> tap.expected
}

test_packet 1 f0:00:00:00:00:03 f0:00:00:00:00:01 8100 ln-100 88a8
test_packet 2 f0:00:00:00:00:03 f0:00:00:00:00:02 8100 ln-100 88a8
for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-rx.pcap" "$i.expected" "tests/ovn.at:3919"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3919"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
if $at_failed
then :
  dump_diff__ "vif$i-rx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done
for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "tap$i-tx.pcap" "tap.expected" "tests/ovn.at:3919"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3919"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
if $at_failed
then :
  dump_diff__ "tap$i-tx.pcap" "tap.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')
        ignored_dp=$(echo "hv-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3919"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')
        ignored_dp=$(echo "hv-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3919"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3919"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3919"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3919"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3919"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_63
#AT_START_64
at_fn_group_banner 64 'ovn.at:3919' \
  "VLAN transparency, passthru=true, multiple hosts, custom ethtype -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "64. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

ethtype=802.1ad

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=true

ln_port_name=ln-100
check ovn-nbctl lsp-add ls $ln_port_name "" 100
check ovn-nbctl lsp-set-addresses $ln_port_name unknown
check ovn-nbctl lsp-set-type $ln_port_name localnet
check ovn-nbctl lsp-set-options $ln_port_name network_name=phys-100 ethtype=$ethtype
net_add n-100

# two hypervisors, each connected to the same network
for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys-100:br-phys
    ovn_attach n-100 br-phys 192.168.0.$i
done

for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i f0:00:00:00:00:0$i
done

for i in 1 2; do
    as hv-$i
    check ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
    wait_for_ports_up lsp$i

    # Patch port might be created after ports are reported up
    # Wait for a flow outputing to patch port
    ovn_wait_patch_port_flows ""ln-100"" ""hv-$i"" "tests/ovn.at:3919"
done
# create taps on fabric to check vlan encapsulation there
for i in 1 2; do
    as hv-$i
    ovs-vsctl add-port br-phys tap$i -- set Interface tap$i \
                                  options:tx_pcap=tap$i-tx.pcap \
                                  options:rxq_pcap=tap$i-rx.pcap
done

for i in 1 2; do
    : > $i.expected
done
: > tap.expected

test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 lout=$5 ethtype=$6

    # First try tracing the packet.
    uflow="inport==\"lsp$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth && vlan.present==1"
    echo "output(\"$lout\");" > expout
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovn_trace --minimal ls \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace --minimal ls \"$uflow\"" "ovn.at:3919"
( $at_check_trace; ovn_trace --minimal ls "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    payload=fefefefe
    local packet=$(echo $dst$src | sed 's/://g')${eth}${payload}
    vif=vif$inport
    as hv-$1
    ovs-appctl netdev-dummy/receive $vif $packet
    echo $packet >> ${inport}.expected

    phys_packet=$(echo $dst$src | sed 's/://g')${ethtype}0064${eth}${payload}
    echo $phys_packet >> tap.expected
}

test_packet 1 f0:00:00:00:00:03 f0:00:00:00:00:01 8100 ln-100 88a8
test_packet 2 f0:00:00:00:00:03 f0:00:00:00:00:02 8100 ln-100 88a8
for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-rx.pcap" "$i.expected" "tests/ovn.at:3919"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3919"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
if $at_failed
then :
  dump_diff__ "vif$i-rx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done
for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "tap$i-tx.pcap" "tap.expected" "tests/ovn.at:3919"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:3919"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
if $at_failed
then :
  dump_diff__ "tap$i-tx.pcap" "tap.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')
        ignored_dp=$(echo "hv-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3919"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')
        ignored_dp=$(echo "hv-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3919"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3919"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3919"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:3919"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:3919"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:3919"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:3919: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:3919"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:3919"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:3919" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_64
#AT_START_65
at_fn_group_banner 65 'ovn.at:4007' \
  "VLAN transparency, passthru=true, multiple hosts, flat/untagged -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "65. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=true

ln_port_name=ln
check ovn-nbctl lsp-add ls $ln_port_name
check ovn-nbctl lsp-set-addresses $ln_port_name unknown
check ovn-nbctl lsp-set-type $ln_port_name localnet
check ovn-nbctl lsp-set-options $ln_port_name network_name=phys
net_add n

# two hypervisors, each connected to the same network
for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys:br-phys
    ovn_attach n br-phys 192.168.0.$i
done

for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i f0:00:00:00:00:0$i
done

for i in 1 2; do
    as hv-$i
    ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lsp$i` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "until test x\`ovn-nbctl lsp-get-up lsp\$i\` = xup"


    # Patch port might be created after ports are reported up
    # Wait for a flow outputing to patch port
    ovn_wait_patch_port_flows ""ln"" ""hv-$i"" "tests/ovn.at:4007"
done

for i in 1 2; do
    : > $i.expected
done

test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 eout=$5 lout=$6

    # First try tracing the packet.
    uflow="inport==\"lsp$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth && vlan.present==1"
    echo "output(\"$lout\");" > expout
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovn_trace --minimal ls \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace --minimal ls \"$uflow\"" "ovn.at:4007"
( $at_check_trace; ovn_trace --minimal ls "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}fefefefe
    vif=vif$inport
    as hv-$1
    ovs-appctl netdev-dummy/receive $vif $packet
    echo $packet >> ${eout#lsp}.expected
}

test_packet 1 f0:00:00:00:00:02 f0:00:00:00:00:01 8100 lsp2 lsp2
test_packet 2 f0:00:00:00:00:01 f0:00:00:00:00:02 8100 lsp1 lsp1

for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:4007"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:4007"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')
        ignored_dp=$(echo "hv-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4007"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')
        ignored_dp=$(echo "hv-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4007"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4007"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4007"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4007"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4007"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_65
#AT_START_66
at_fn_group_banner 66 'ovn.at:4007' \
  "VLAN transparency, passthru=true, multiple hosts, flat/untagged -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "66. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=true

ln_port_name=ln
check ovn-nbctl lsp-add ls $ln_port_name
check ovn-nbctl lsp-set-addresses $ln_port_name unknown
check ovn-nbctl lsp-set-type $ln_port_name localnet
check ovn-nbctl lsp-set-options $ln_port_name network_name=phys
net_add n

# two hypervisors, each connected to the same network
for i in 1 2; do
    sim_add hv-$i
    as hv-$i
    ovs-vsctl add-br br-phys
    ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys:br-phys
    ovn_attach n br-phys 192.168.0.$i
done

for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i f0:00:00:00:00:0$i
done

for i in 1 2; do
    as hv-$i
    ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lsp$i` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "until test x\`ovn-nbctl lsp-get-up lsp\$i\` = xup"


    # Patch port might be created after ports are reported up
    # Wait for a flow outputing to patch port
    ovn_wait_patch_port_flows ""ln"" ""hv-$i"" "tests/ovn.at:4007"
done

for i in 1 2; do
    : > $i.expected
done

test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 eout=$5 lout=$6

    # First try tracing the packet.
    uflow="inport==\"lsp$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth && vlan.present==1"
    echo "output(\"$lout\");" > expout
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovn_trace --minimal ls \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace --minimal ls \"$uflow\"" "ovn.at:4007"
( $at_check_trace; ovn_trace --minimal ls "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}fefefefe
    vif=vif$inport
    as hv-$1
    ovs-appctl netdev-dummy/receive $vif $packet
    echo $packet >> ${eout#lsp}.expected
}

test_packet 1 f0:00:00:00:00:02 f0:00:00:00:00:01 8100 lsp2 lsp2
test_packet 2 f0:00:00:00:00:01 f0:00:00:00:00:02 8100 lsp1 lsp1

for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:4007"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:4007"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')
        ignored_dp=$(echo "hv-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4007"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')
        ignored_dp=$(echo "hv-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4007"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-1" |sed -n '1p')
        error=$(echo "hv-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4007"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4007"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-2" |sed -n '1p')
        error=$(echo "hv-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4007"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4007"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4007"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4007: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4007"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4007"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4007" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_66
#AT_START_67
at_fn_group_banner 67 'ovn.at:4079' \
  "VLAN transparency, passthru=true -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "67. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=true
for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i f0:00:00:00:00:0$i
done

net_add physnet
ovs-vsctl add-br br-phys
ovs-vsctl set open . external-ids:ovn-bridge-mappings=physnet:br-phys
ovn_attach physnet br-phys 192.168.0.1

for i in 1 2; do
    ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lsp$i` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4079" "until test x\`ovn-nbctl lsp-get-up lsp\$i\` = xup"

done

test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 eout=$5 lout=$6

    # First try tracing the packet.
    uflow="inport==\"lsp$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth && vlan.present==1"
    echo "output(\"$lout\");" > expout
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4079: ovn_trace --minimal ls \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace --minimal ls \"$uflow\"" "ovn.at:4079"
( $at_check_trace; ovn_trace --minimal ls "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4079"
$at_failed && at_fn_log_failure
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}fefefefe
    vif=vif$inport
    ovs-appctl netdev-dummy/receive $vif $packet
    echo $packet >> ${eout#lsp}.expected
}

test_packet 1 f0:00:00:00:00:02 f0:00:00:00:00:01 8100 lsp2 lsp2
test_packet 2 f0:00:00:00:00:01 f0:00:00:00:00:02 8100 lsp1 lsp1
for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:4079"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4079: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:4079"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4079"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_67
#AT_START_68
at_fn_group_banner 68 'ovn.at:4079' \
  "VLAN transparency, passthru=true -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "68. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=true
for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i f0:00:00:00:00:0$i
done

net_add physnet
ovs-vsctl add-br br-phys
ovs-vsctl set open . external-ids:ovn-bridge-mappings=physnet:br-phys
ovn_attach physnet br-phys 192.168.0.1

for i in 1 2; do
    ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lsp$i` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4079" "until test x\`ovn-nbctl lsp-get-up lsp\$i\` = xup"

done

test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 eout=$5 lout=$6

    # First try tracing the packet.
    uflow="inport==\"lsp$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth && vlan.present==1"
    echo "output(\"$lout\");" > expout
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4079: ovn_trace --minimal ls \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace --minimal ls \"$uflow\"" "ovn.at:4079"
( $at_check_trace; ovn_trace --minimal ls "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4079"
$at_failed && at_fn_log_failure
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}fefefefe
    vif=vif$inport
    ovs-appctl netdev-dummy/receive $vif $packet
    echo $packet >> ${eout#lsp}.expected
}

test_packet 1 f0:00:00:00:00:02 f0:00:00:00:00:01 8100 lsp2 lsp2
test_packet 2 f0:00:00:00:00:01 f0:00:00:00:00:02 8100 lsp1 lsp1
for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:4079"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4079: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:4079"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4079"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_68
#AT_START_69
at_fn_group_banner 69 'ovn.at:4127' \
  "VLAN transparency, passthru=false -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "69. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=false
for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i f0:00:00:00:00:0$i
done

net_add physnet
ovs-vsctl add-br br-phys
ovs-vsctl set open . external-ids:ovn-bridge-mappings=physnet:br-phys
ovn_attach physnet br-phys 192.168.0.1

for i in 1 2; do
    ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lsp$i` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4127" "until test x\`ovn-nbctl lsp-get-up lsp\$i\` = xup"


    : > $i.expected
done

test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 eout=$5 lout=$6

    # First try tracing the packet.
    uflow="inport==\"lsp$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth && vlan.present==1"
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4127: ovn_trace ls \"\$uflow\" | grep -q drop"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn.at:4127"
( $at_check_trace; ovn_trace ls "$uflow" | grep -q drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4127"
$at_failed && at_fn_log_failure
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}fefefefe
    ovs-appctl netdev-dummy/receive vif$inport $packet
}

test_packet 1 f0:00:00:00:00:02 f0:00:00:00:00:01 8100 lsp2 lsp2
test_packet 2 f0:00:00:00:00:01 f0:00:00:00:00:02 8100 lsp1 lsp1
for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:4127"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4127: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:4127"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4127"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_69
#AT_START_70
at_fn_group_banner 70 'ovn.at:4127' \
  "VLAN transparency, passthru=false -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "70. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

check ovn-nbctl ls-add ls
check ovn-nbctl --wait=sb add Logical-Switch ls other_config vlan-passthru=false
for i in 1 2; do
    check ovn-nbctl lsp-add ls lsp$i
    check ovn-nbctl lsp-set-addresses lsp$i f0:00:00:00:00:0$i
done

net_add physnet
ovs-vsctl add-br br-phys
ovs-vsctl set open . external-ids:ovn-bridge-mappings=physnet:br-phys
ovn_attach physnet br-phys 192.168.0.1

for i in 1 2; do
    ovs-vsctl add-port br-int vif$i -- set Interface vif$i external-ids:iface-id=lsp$i \
                                  options:tx_pcap=vif$i-tx.pcap \
                                  options:rxq_pcap=vif$i-rx.pcap \
                                  ofport-request=$i
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lsp$i` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4127" "until test x\`ovn-nbctl lsp-get-up lsp\$i\` = xup"


    : > $i.expected
done

test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 eout=$5 lout=$6

    # First try tracing the packet.
    uflow="inport==\"lsp$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth && vlan.present==1"
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4127: ovn_trace ls \"\$uflow\" | grep -q drop"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn.at:4127"
( $at_check_trace; ovn_trace ls "$uflow" | grep -q drop
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4127"
$at_failed && at_fn_log_failure
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}fefefefe
    ovs-appctl netdev-dummy/receive vif$inport $packet
}

test_packet 1 f0:00:00:00:00:02 f0:00:00:00:00:01 8100 lsp2 lsp2
test_packet 2 f0:00:00:00:00:01 f0:00:00:00:00:02 8100 lsp1 lsp1
for i in 1 2; do
    ovn_check_packets_remove_broadcast__ "vif$i-tx.pcap" "$i.expected" "tests/ovn.at:4127"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4127: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:4127"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4127"
if $at_failed
then :
  dump_diff__ "vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_70
#AT_START_71
at_fn_group_banner 71 'ovn.at:4174' \
  "VXLAN check port/datapath key space limits -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "71. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init


ovn_start
net_add net
check ovs-vsctl add-br br-phys
check ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys:br-phys
ovn_attach net br-phys 192.168.0.1 24 vxlan
check ovn-nbctl --wait=sb sync
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    ovn-sbctl get chassis main _uuid
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4174" "until ovn-sbctl get chassis main _uuid"


check ovn-nbctl ls-add ls-bad -- \
    set Logical_Switch ls-bad other_config:requested-tnl-key=5000
check ovn-nbctl lsp-add ls-bad lsp-bad -- \
    set logical_switch_port lsp-bad options:requested-tnl-key=5000
check ovn-nbctl --wait=sb sync

check ovs-vsctl add-port br-int vif-bad -- \
    set Interface vif-bad external-ids:iface-id=lsp-bad
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lsp-bad` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4174" "until test x\`ovn-nbctl lsp-get-up lsp-bad\` = xup"


# 5000 is higher than 1 << 12, so OVN should ignore the key requests
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4174: ovn-sbctl get Datapath_Binding ls-bad tunnel_key"
at_fn_check_prepare_trace "ovn.at:4174"
( $at_check_trace; ovn-sbctl get Datapath_Binding ls-bad tunnel_key
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4174"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4174: ovn-sbctl get Port_Binding lsp-bad tunnel_key"
at_fn_check_prepare_trace "ovn.at:4174"
( $at_check_trace; ovn-sbctl get Port_Binding lsp-bad tunnel_key
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4174"
$at_failed && at_fn_log_failure
$at_traceon; }


check ovn-nbctl ls-add ls-good -- \
    set Logical_Switch ls-good other_config:requested-tnl-key=1000
check ovn-nbctl lsp-add ls-good lsp-good -- \
    set logical_switch_port lsp-good options:requested-tnl-key=1000
check ovn-nbctl --wait=sb sync

check ovs-vsctl add-port br-int vif-good -- \
    set Interface vif-good external-ids:iface-id=lsp-good
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lsp-good` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4174" "until test x\`ovn-nbctl lsp-get-up lsp-good\` = xup"


# 1000 is lower than 1 << 12, so OVN should honor the key requests
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4174: ovn-sbctl get Datapath_Binding ls-good tunnel_key"
at_fn_check_prepare_trace "ovn.at:4174"
( $at_check_trace; ovn-sbctl get Datapath_Binding ls-good tunnel_key
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1000
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4174"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4174: ovn-sbctl get Port_Binding lsp-good tunnel_key"
at_fn_check_prepare_trace "ovn.at:4174"
( $at_check_trace; ovn-sbctl get Port_Binding lsp-good tunnel_key
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1000
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4174"
$at_failed && at_fn_log_failure
$at_traceon; }


ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_71
#AT_START_72
at_fn_group_banner 72 'ovn.at:4174' \
  "VXLAN check port/datapath key space limits -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "72. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init


ovn_start
net_add net
check ovs-vsctl add-br br-phys
check ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys:br-phys
ovn_attach net br-phys 192.168.0.1 24 vxlan
check ovn-nbctl --wait=sb sync
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    ovn-sbctl get chassis main _uuid
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4174" "until ovn-sbctl get chassis main _uuid"


check ovn-nbctl ls-add ls-bad -- \
    set Logical_Switch ls-bad other_config:requested-tnl-key=5000
check ovn-nbctl lsp-add ls-bad lsp-bad -- \
    set logical_switch_port lsp-bad options:requested-tnl-key=5000
check ovn-nbctl --wait=sb sync

check ovs-vsctl add-port br-int vif-bad -- \
    set Interface vif-bad external-ids:iface-id=lsp-bad
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lsp-bad` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4174" "until test x\`ovn-nbctl lsp-get-up lsp-bad\` = xup"


# 5000 is higher than 1 << 12, so OVN should ignore the key requests
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4174: ovn-sbctl get Datapath_Binding ls-bad tunnel_key"
at_fn_check_prepare_trace "ovn.at:4174"
( $at_check_trace; ovn-sbctl get Datapath_Binding ls-bad tunnel_key
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4174"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4174: ovn-sbctl get Port_Binding lsp-bad tunnel_key"
at_fn_check_prepare_trace "ovn.at:4174"
( $at_check_trace; ovn-sbctl get Port_Binding lsp-bad tunnel_key
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4174"
$at_failed && at_fn_log_failure
$at_traceon; }


check ovn-nbctl ls-add ls-good -- \
    set Logical_Switch ls-good other_config:requested-tnl-key=1000
check ovn-nbctl lsp-add ls-good lsp-good -- \
    set logical_switch_port lsp-good options:requested-tnl-key=1000
check ovn-nbctl --wait=sb sync

check ovs-vsctl add-port br-int vif-good -- \
    set Interface vif-good external-ids:iface-id=lsp-good
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lsp-good` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4174" "until test x\`ovn-nbctl lsp-get-up lsp-good\` = xup"


# 1000 is lower than 1 << 12, so OVN should honor the key requests
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4174: ovn-sbctl get Datapath_Binding ls-good tunnel_key"
at_fn_check_prepare_trace "ovn.at:4174"
( $at_check_trace; ovn-sbctl get Datapath_Binding ls-good tunnel_key
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1000
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4174"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4174: ovn-sbctl get Port_Binding lsp-good tunnel_key"
at_fn_check_prepare_trace "ovn.at:4174"
( $at_check_trace; ovn-sbctl get Port_Binding lsp-good tunnel_key
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1000
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4174"
$at_failed && at_fn_log_failure
$at_traceon; }


ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_72
#AT_START_73
at_fn_group_banner 73 'ovn.at:4224' \
  "2 HVs, 1 LS, no switching between multiple localnet ports with different tags -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "73. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

# In this test case we create a single switch connected to two physical
# networks via two localnet ports. Then we create two hypervisors, with 2
# ports on each. The test validates no interconnectivity between VIF ports
# located on chassis plugged to different physical networks.

# create the single switch with two locanet ports
check ovn-nbctl ls-add ls1
for tag in 10 20; do
    ln_port_name=ln-$tag
    check ovn-nbctl lsp-add ls1 $ln_port_name "" $tag
    check ovn-nbctl lsp-set-addresses $ln_port_name unknown
    check ovn-nbctl lsp-set-type $ln_port_name localnet
    check ovn-nbctl lsp-set-options $ln_port_name network_name=phys-$tag
done

# create fabric networks
for tag in 10 20; do
    net_add n-$tag
done

# create four chassis, each connected to one network, each with a single VIF port
for tag in 10 20; do
    for i in 1 2; do
        sim_add hv-$tag-$i
        as hv-$tag-$i
        ovs-vsctl add-br br-phys
        ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys-$tag:br-phys
        ovn_attach n-$tag br-phys 192.168.$i.$tag

        ovs-vsctl add-port br-int vif-$tag-$i -- \
            set Interface vif-$tag-$i external-ids:iface-id=lp-$tag-$i \
                                  options:tx_pcap=hv-$tag-$i/vif-$tag-$i-tx.pcap \
                                  options:rxq_pcap=hv-$tag-$i/vif-$tag-$i-rx.pcap \
                                  ofport-request=$tag$i

        lsp_name=lp-$tag-$i
        check ovn-nbctl lsp-add ls1 $lsp_name
        check ovn-nbctl lsp-set-addresses $lsp_name f0:00:00:00:0$i:$tag
        check ovn-nbctl lsp-set-port-security $lsp_name f0:00:00:00:0$i:$tag

        check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up $lsp_name` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "until test x\`ovn-nbctl lsp-get-up \$lsp_name\` = xup"

        ovn_wait_patch_port_flows ""ln-$tag"" ""hv-$tag-$i"" "tests/ovn.at:4224"
    done
done
wait_for_ports_up
check ovn-nbctl --wait=sb sync
ovn-sbctl dump-flows

for tag in 10 20; do
    for i in 1 2; do
        : > $tag-$i.expected
    done
done

vif_to_hv() {
    echo hv-$1
}

test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 eout=$5 lout=$6

    # First try tracing the packet.
    uflow="inport==\"lp-$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth"
    echo "output(\"$lout\");" > expout
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovn_trace --minimal ls1 \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace --minimal ls1 \"$uflow\"" "ovn.at:4224"
( $at_check_trace; ovn_trace --minimal ls1 "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}
    hv=`vif_to_hv $inport`
    vif=vif-$inport
    as $hv ovs-appctl netdev-dummy/receive $vif $packet
    if test $eth = 1002 -o $eth = 2002; then
        echo $packet >> ${eout#lp-}.expected
    fi
}

# different fabric networks -> should fail
test_packet 10-1 f0:00:00:00:01:20 f0:00:00:00:01:10 1001 lp-20-1 lp-20-1
test_packet 20-1 f0:00:00:00:01:10 f0:00:00:00:01:20 2001 lp-10-1 lp-10-1

# same fabric networks -> should pass
test_packet 10-1 f0:00:00:00:02:10 f0:00:00:00:01:10 1002 lp-10-2 lp-10-2
test_packet 20-1 f0:00:00:00:02:20 f0:00:00:00:01:20 2002 lp-20-2 lp-20-2
test_packet 10-2 f0:00:00:00:01:10 f0:00:00:00:02:10 1002 lp-10-1 lp-10-1
test_packet 20-2 f0:00:00:00:01:20 f0:00:00:00:02:20 2002 lp-20-1 lp-20-1

# Dump a bunch of info helpful for debugging if there's a failure.
echo "------ OVN dump ------"
ovn-nbctl show
ovn-sbctl show

for tag in 10 20; do
    for i in 1 2; do
        hv=hv-$tag-$i
        echo "------ $hv dump ------"
        as $hv ovs-vsctl show
        as $hv ovs-ofctl -O OpenFlow13 dump-flows br-int
    done
done

# Now check the packets actually received against the ones expected.
for tag in 10 20; do
    for i in 1 2; do
        echo "hv = $tag-$i"
        ovn_check_packets_remove_broadcast__ "hv-$tag-$i/vif-$tag-$i-tx.pcap" "$tag-$i.expected" "tests/ovn.at:4224"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:4224"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
if $at_failed
then :
  dump_diff__ "hv-$tag-$i/vif-$tag-$i-tx.pcap" "$tag-$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

    done
done



        sbox=$(echo "hv-10-1" |sed -n '1p')
        error=$(echo "hv-10-1"  | grep '/')
        ignored_dp=$(echo "hv-10-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-10-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-10-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-10-2" |sed -n '1p')
        error=$(echo "hv-10-2"  | grep '/')
        ignored_dp=$(echo "hv-10-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-10-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-10-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-20-1" |sed -n '1p')
        error=$(echo "hv-20-1"  | grep '/')
        ignored_dp=$(echo "hv-20-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-20-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-20-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-20-2" |sed -n '1p')
        error=$(echo "hv-20-2"  | grep '/')
        ignored_dp=$(echo "hv-20-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-20-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-20-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-10-1" |sed -n '1p')
        error=$(echo "hv-10-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4224"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-10-2" |sed -n '1p')
        error=$(echo "hv-10-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4224"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-20-1" |sed -n '1p')
        error=$(echo "hv-20-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4224"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-20-2" |sed -n '1p')
        error=$(echo "hv-20-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4224"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_73
#AT_START_74
at_fn_group_banner 74 'ovn.at:4224' \
  "2 HVs, 1 LS, no switching between multiple localnet ports with different tags -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "74. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

# In this test case we create a single switch connected to two physical
# networks via two localnet ports. Then we create two hypervisors, with 2
# ports on each. The test validates no interconnectivity between VIF ports
# located on chassis plugged to different physical networks.

# create the single switch with two locanet ports
check ovn-nbctl ls-add ls1
for tag in 10 20; do
    ln_port_name=ln-$tag
    check ovn-nbctl lsp-add ls1 $ln_port_name "" $tag
    check ovn-nbctl lsp-set-addresses $ln_port_name unknown
    check ovn-nbctl lsp-set-type $ln_port_name localnet
    check ovn-nbctl lsp-set-options $ln_port_name network_name=phys-$tag
done

# create fabric networks
for tag in 10 20; do
    net_add n-$tag
done

# create four chassis, each connected to one network, each with a single VIF port
for tag in 10 20; do
    for i in 1 2; do
        sim_add hv-$tag-$i
        as hv-$tag-$i
        ovs-vsctl add-br br-phys
        ovs-vsctl set open . external-ids:ovn-bridge-mappings=phys-$tag:br-phys
        ovn_attach n-$tag br-phys 192.168.$i.$tag

        ovs-vsctl add-port br-int vif-$tag-$i -- \
            set Interface vif-$tag-$i external-ids:iface-id=lp-$tag-$i \
                                  options:tx_pcap=hv-$tag-$i/vif-$tag-$i-tx.pcap \
                                  options:rxq_pcap=hv-$tag-$i/vif-$tag-$i-rx.pcap \
                                  ofport-request=$tag$i

        lsp_name=lp-$tag-$i
        check ovn-nbctl lsp-add ls1 $lsp_name
        check ovn-nbctl lsp-set-addresses $lsp_name f0:00:00:00:0$i:$tag
        check ovn-nbctl lsp-set-port-security $lsp_name f0:00:00:00:0$i:$tag

        check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up $lsp_name` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "until test x\`ovn-nbctl lsp-get-up \$lsp_name\` = xup"

        ovn_wait_patch_port_flows ""ln-$tag"" ""hv-$tag-$i"" "tests/ovn.at:4224"
    done
done
wait_for_ports_up
check ovn-nbctl --wait=sb sync
ovn-sbctl dump-flows

for tag in 10 20; do
    for i in 1 2; do
        : > $tag-$i.expected
    done
done

vif_to_hv() {
    echo hv-$1
}

test_packet() {
    local inport=$1 dst=$2 src=$3 eth=$4 eout=$5 lout=$6

    # First try tracing the packet.
    uflow="inport==\"lp-$inport\" && eth.dst==$dst && eth.src==$src && eth.type==0x$eth"
    echo "output(\"$lout\");" > expout
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovn_trace --minimal ls1 \"\$uflow\""
at_fn_check_prepare_dynamic "ovn_trace --minimal ls1 \"$uflow\"" "ovn.at:4224"
( $at_check_trace; ovn_trace --minimal ls1 "$uflow"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure
$at_traceon; }


    # Then actually send a packet, for an end-to-end test.
    local packet=$(echo $dst$src | sed 's/://g')${eth}
    hv=`vif_to_hv $inport`
    vif=vif-$inport
    as $hv ovs-appctl netdev-dummy/receive $vif $packet
    if test $eth = 1002 -o $eth = 2002; then
        echo $packet >> ${eout#lp-}.expected
    fi
}

# different fabric networks -> should fail
test_packet 10-1 f0:00:00:00:01:20 f0:00:00:00:01:10 1001 lp-20-1 lp-20-1
test_packet 20-1 f0:00:00:00:01:10 f0:00:00:00:01:20 2001 lp-10-1 lp-10-1

# same fabric networks -> should pass
test_packet 10-1 f0:00:00:00:02:10 f0:00:00:00:01:10 1002 lp-10-2 lp-10-2
test_packet 20-1 f0:00:00:00:02:20 f0:00:00:00:01:20 2002 lp-20-2 lp-20-2
test_packet 10-2 f0:00:00:00:01:10 f0:00:00:00:02:10 1002 lp-10-1 lp-10-1
test_packet 20-2 f0:00:00:00:01:20 f0:00:00:00:02:20 2002 lp-20-1 lp-20-1

# Dump a bunch of info helpful for debugging if there's a failure.
echo "------ OVN dump ------"
ovn-nbctl show
ovn-sbctl show

for tag in 10 20; do
    for i in 1 2; do
        hv=hv-$tag-$i
        echo "------ $hv dump ------"
        as $hv ovs-vsctl show
        as $hv ovs-ofctl -O OpenFlow13 dump-flows br-int
    done
done

# Now check the packets actually received against the ones expected.
for tag in 10 20; do
    for i in 1 2; do
        echo "hv = $tag-$i"
        ovn_check_packets_remove_broadcast__ "hv-$tag-$i/vif-$tag-$i-tx.pcap" "$tag-$i.expected" "tests/ovn.at:4224"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:4224"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
if $at_failed
then :
  dump_diff__ "hv-$tag-$i/vif-$tag-$i-tx.pcap" "$tag-$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

    done
done



        sbox=$(echo "hv-10-1" |sed -n '1p')
        error=$(echo "hv-10-1"  | grep '/')
        ignored_dp=$(echo "hv-10-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-10-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-10-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-10-2" |sed -n '1p')
        error=$(echo "hv-10-2"  | grep '/')
        ignored_dp=$(echo "hv-10-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-10-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-10-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-20-1" |sed -n '1p')
        error=$(echo "hv-20-1"  | grep '/')
        ignored_dp=$(echo "hv-20-1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-20-1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-20-1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv-20-2" |sed -n '1p')
        error=$(echo "hv-20-2"  | grep '/')
        ignored_dp=$(echo "hv-20-2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv-20-2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv-20-2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv-10-1" |sed -n '1p')
        error=$(echo "hv-10-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4224"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-10-2" |sed -n '1p')
        error=$(echo "hv-10-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4224"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-20-1" |sed -n '1p')
        error=$(echo "hv-20-1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4224"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv-20-2" |sed -n '1p')
        error=$(echo "hv-20-2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4224"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4224"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4224"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4224: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4224"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4224"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4224" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_74
#AT_START_75
at_fn_group_banner 75 'ovn.at:4341' \
  "vtep: 3 HVs, 1 VIFs/HV, 1 GW, 1 LS -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "75. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init


printf "%s\n" "ovn.at:4341" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:4341"
ovn_start

# Configure the Northbound database
check ovn-nbctl ls-add lsw0

check ovn-nbctl lsp-add lsw0 lp1
check ovn-nbctl lsp-set-addresses lp1 'f0:00:00:00:00:01 192.168.1.24'

check ovn-nbctl lsp-add lsw0 lp2
check ovn-nbctl lsp-set-addresses lp2 f0:00:00:00:00:02

check ovn-nbctl lsp-add lsw0 lp-vtep
check ovn-nbctl lsp-set-type lp-vtep vtep
check ovn-nbctl lsp-set-options lp-vtep vtep-physical-switch=br-vtep vtep-logical-switch=lsw0
check ovn-nbctl lsp-set-addresses lp-vtep unknown

# lpr, lr and lrp1 are used for the ARP request handling test only.
check ovn-nbctl lsp-add lsw0 lpr
check ovn-nbctl lr-add lr
check ovn-nbctl lrp-add lr lrp1 f0:00:00:00:00:f1 192.168.1.1/24
check ovn-nbctl set Logical_Switch_Port lpr \
    type=router \
    options:router-port=lrp1 \
    addresses=router
check ovn-nbctl lrp-set-gateway-chassis lrp1 hv1

check ovn-nbctl lsp-add lsw0 lpr2
check ovn-nbctl lrp-add lr lrp2 f0:00:00:00:00:f2 192.168.1.254/24
check ovn-nbctl set Logical_Switch_Port lpr2 \
    type=router \
    options:router-port=lrp2 \
    addresses=router
check ovn-nbctl lrp-set-gateway-chassis lrp2 hv1

net_add n1               # Network to connect hv1, hv2, and vtep
net_add n2               # Network to connect vtep and hv3

# Create hypervisor hv1 connected to n1
sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl add-port br-int vif1 -- set Interface vif1 external-ids:iface-id=lp1 options:tx_pcap=hv1/vif1-tx.pcap options:rxq_pcap=hv1/vif1-rx.pcap ofport-request=1

# Create hypervisor hv2 connected to n1
sim_add hv2
as hv2
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.2
ovs-vsctl add-port br-int vif2 -- set Interface vif2 external-ids:iface-id=lp2 options:tx_pcap=hv2/vif2-tx.pcap options:rxq_pcap=hv2/vif2-rx.pcap ofport-request=1


# Start the vtep emulator with a leg in both networks
sim_add vtep
as vtep

ovsdb-tool create "$ovs_base"/vtep/vtep.db "$ovs_srcdir"/vtep/vtep.ovsschema
ovs-appctl -t ovsdb-server ovsdb-server/add-db "$ovs_base"/vtep/vtep.db

ovs-vsctl add-br br-phys
net_attach n1 br-phys

mac=`ovs-vsctl get Interface br-phys mac_in_use | sed s/\"//g`
arp_table="$arp_table $sandbox,br-phys,192.168.0.3,$mac"
ovs-appctl netdev-dummy/ip4addr br-phys 192.168.0.3/24 >/dev/null
ovs-appctl ovs/route/add 192.168.0.3/24 br-phys >/dev/null

ovs-vsctl add-br br-vtep
net_attach n2 br-vtep

vtep-ctl add-ps br-vtep
vtep-ctl set Physical_Switch br-vtep tunnel_ips=192.168.0.3
vtep-ctl add-ls lsw0

start_daemon ovs-vtep br-vtep
start_daemon ovn-controller-vtep --vtep-db=unix:"$ovs_base"/vtep/db.sock --ovnsb-db=unix:"$ovs_base"/ovn-sb/ovn-sb.sock
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    vtep-ctl bind-ls br-vtep br-vtep_n2 0 lsw0
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "until vtep-ctl bind-ls br-vtep br-vtep_n2 0 lsw0"


check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test -n "`as vtep vtep-ctl get-replication-mode lsw0 |
               grep -- source`"
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "until test -n \"\`as vtep vtep-ctl get-replication-mode lsw0 |
               grep -- source\`\""


# Add hv3 on the other side of the vtep
sim_add hv3
as hv3
ovs-vsctl add-br br-phys
net_attach n2 br-phys
ovs-vsctl add-port br-phys vif3 -- set Interface vif3 options:tx_pcap=hv3/vif3-tx.pcap options:rxq_pcap=hv3/vif3-rx.pcap ofport-request=1

# vtep is quite slow setting up all flows
# We need to wait for flow flooding to br-vtep_n2, vx1 and vx2
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test `as vtep ovs-ofctl dump-flows br-vtep_vtep_ls1 | grep "priority=0" | grep -o "output" | wc -l` -eq 3
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "until test \`as vtep ovs-ofctl dump-flows br-vtep_vtep_ls1 | grep \"priority=0\" | grep -o \"output\" | wc -l\` -eq 3"


# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure
$at_traceon; }


wait_for_ports_up
check ovn-nbctl --wait=hv sync

# test_packet INPORT DST SRC ETHTYPE OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as logical switch port numbers, e.g. 1 for vif1.
for i in 1 2 3; do
    : > $i.expected
done
test_packet() {
    local inport=$1 packet=$2$3$4; shift; shift; shift; shift
    #hv=hv`echo $inport | sed 's/^\(.\).*/\1/'`
    hv=hv$inport
    vif=vif$inport
    as $hv ovs-appctl netdev-dummy/receive $vif $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# Send packets between all pairs of source and destination ports:
#
# 1. Unicast packets are delivered to exactly one logical switch port
#    (except that packets destined to their input ports are dropped).
#
# 2. Broadcast and multicast are delivered to all logical switch ports
#    except the input port.
#
# 3. The switch delivers packets with an unknown destination to logical
#    switch ports with "unknown" among their MAC addresses (and port
#    security disabled).
for s in 1 2 3; do
    bcast=
    unknown=
    for d in 1 2 3; do
        if test $d != $s; then unicast=$d; else unicast=; fi
        test_packet $s f0000000000$d f0000000000$s 00$s$d $unicast       #1

        # The vtep (vif3) is the only one configured for "unknown"
        if test $d != $s && test $d = 3; then
            unknown="$unknown $d"
        fi
        bcast="$bcast $unicast"
    done

    # Broadcast and multicast.
    test_packet $s ffffffffffff f0000000000$s 0${s}ff $bcast             #2
    test_packet $s 010000000000 f0000000000$s 0${s}ff $bcast             #2

    test_packet $s f0000000ffff f0000000000$s 0${s}66 $unknown           #3
done

# ARP request from VTEP to LRP should be responded by ARP responder.
sha=f0:00:00:00:00:03
spa=192.168.1.2
tpa=192.168.1.1
request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                   ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $request
echo $request >> 1.expected
echo $request >> 2.expected

lrpmac=f0:00:00:00:00:f1
response=$(fmt_pkt "Ether(dst='${sha}', src='${lrpmac}')/ \
                    ARP(op=2, hwsrc='${lrpmac}', hwdst='${sha}', psrc='${tpa}', pdst='${spa}')")
# since lrp1 has gateway chassis set on hv1, hv1 will suppress arp request and
# answer with arp reply by OVS directly to vtep lport. all other lports,
# except lport from which this request was initiated, will receive arp request.
# we expect arp reply packet on hv3
echo $response >> 3.expected

# Ensure there is no MAC_Binding, send GARP from vtep side,
# check that GARP was received by vif1, vif2 and MAC_Binding was created.
wait_row_count MAC_Binding 0 ip="192.168.1.200" mac='"f0:00:00:00:00:12"'

sha=02:00:00:00:00:ff
tha=ff:ff:ff:ff:ff:ff
spa=192.168.1.200
tpa=$spa
garp=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                ARP(op=2, hwsrc='${sha}', hwdst='${tha}', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $garp
echo $garp >> 1.expected
echo $garp >> 2.expected

wait_row_count MAC_Binding 2 ip="192.168.1.200" mac='"02:00:00:00:00:ff"'

# Send same GARP with changed SHA and ensure MAC_Binding was updated.
sha=02:00:00:00:00:ee
garp=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                ARP(op=2, hwsrc='${sha}', hwdst='${tha}', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $garp
echo $garp >> 1.expected
echo $garp >> 2.expected

wait_row_count MAC_Binding 2 ip="192.168.1.200" mac='"02:00:00:00:00:ee"'

# Remove local ports on hv1 and check that ARP logic is stil working. -->
check as hv1 ovs-vsctl remove interface vif1 external_ids iface-id
hv_uuid=$(fetch_column Chassis _uuid name=hv1)
wait_row_count Port_Binding 0 chassis="$hv_uuid" type="''"

# Cleanup MAC_Bindings after previous checks.
check ovn-sbctl --all destroy MAC_Binding

# ARP request from VTEP to LRP should be responded by ARP responder.
sha=f0:00:00:00:00:03
spa=192.168.1.2
tpa=192.168.1.1
request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                   ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $request
echo $request >> 2.expected

lrpmac=f0:00:00:00:00:f1
response=$(fmt_pkt "Ether(dst='${sha}', src='${lrpmac}')/ \
                    ARP(op=2, hwsrc='${lrpmac}', hwdst='${sha}', psrc='${tpa}', pdst='${spa}')")
# since lrp1 has gateway chassis set on hv1, hv1 will suppress arp request and
# answer with arp reply by OVS directly to vtep lport. all other lports,
# except lport from which this request was initiated, will receive arp request.
# we expect arp reply packet on hv3
echo $response >> 3.expected

# Ensure there is no MAC_Binding, send GARP from vtep side,
# check that GARP was received by vif1, vif2 and MAC_Binding was created.
wait_row_count MAC_Binding 0 ip="192.168.1.200" mac='"f0:00:00:00:00:12"'

sha=02:00:00:00:00:ff
tha=ff:ff:ff:ff:ff:ff
spa=192.168.1.200
tpa=$spa
garp=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                ARP(op=2, hwsrc='${sha}', hwdst='${tha}', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $garp
echo $garp >> 2.expected

wait_row_count MAC_Binding 2 ip="192.168.1.200" mac='"02:00:00:00:00:ff"'

# Send same GARP with changed SHA and ensure MAC_Binding was updated.
sha=02:00:00:00:00:ee
garp=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                ARP(op=2, hwsrc='${sha}', hwdst='${tha}', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $garp
echo $garp >> 2.expected

wait_row_count MAC_Binding 2 ip="192.168.1.200" mac='"02:00:00:00:00:ee"'

# Restore.
check as hv1 ovs-vsctl set interface vif1 external_ids:iface-id=lp1
wait_row_count Port_Binding 1 chassis="$hv_uuid" type='""'
# Make sure flows added by port claim are installed
check ovn-nbctl --wait=hv sync
# <--

# Check ARP response to request for IP on VIF port sent from vtep.
# ARP request from VTEP to LSP's IP must be answered only by LSP vif1 (lp1).
sha=f0:00:00:00:00:03
spa=192.168.1.2
tpa=192.168.1.24
request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                   ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $request
echo $request >> 1.expected
echo $request >> 2.expected

# Simulate response from vif.
sha=f0:00:00:00:00:01
tha=f0:00:00:00:00:03
spa=192.168.1.200
tpa=192.168.1.2
response=$(fmt_pkt "Ether(dst='${tha}', src='${sha}')/ \
                    ARP(op=2, hwsrc='${sha}', hwdst='${tha}', psrc='${spa}', pdst='${tpa}')")
as hv1 ovs-appctl netdev-dummy/receive vif1 $response
echo $response >> 3.expected

# First ensure basic flow contents are as we expect.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovn-sbctl lflow-list lsw0 | grep 'reg0\\[14\\]' | ovn_strip_lflows"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn.at:4341"
( $at_check_trace; ovn-sbctl lflow-list lsw0 | grep 'reg0\[14\]' | ovn_strip_lflows
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "  table=??(ls_in_arp_rsp      ), priority=65535, match=(reg0[14] == 1 && (arp || nd_ns)), action=(flags.loopback = 1; next;)
  table=??(ls_in_check_port_sec), priority=70   , match=(inport == \"lp-vtep\"), action=(reg0[14] = 1; next(pipeline=ingress, table=??);)
  table=??(ls_in_hairpin      ), priority=1000 , match=(reg0[14] == 1), action=(next(pipeline=ingress, table=??);)
  table=??(ls_in_hairpin      ), priority=2000 , match=(reg0[14] == 1 && is_chassis_resident(\"cr-lrp1\")), action=(next;)
  table=??(ls_in_hairpin      ), priority=2000 , match=(reg0[14] == 1 && is_chassis_resident(\"cr-lrp2\")), action=(next;)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure
$at_traceon; }


# dump information with counters
echo "------ OVN dump ------"
ovn-nbctl show
ovn-sbctl show

echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list port_binding
echo "---------------------"
ovn-sbctl dump-flows

echo "------ hv1 dump ------"
as hv1 ovs-vsctl show
as hv1 ovs-ofctl -O OpenFlow13 show br-int
as hv1 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv2 dump ------"
as hv2 ovs-vsctl show
as hv2 ovs-ofctl -O OpenFlow13 show br-int
as hv2 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv3 dump ------"
as hv3 ovs-vsctl show
# note: hv3 has no logical port bind, thus it should not have br-int
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: as hv3 ovs-ofctl -O OpenFlow13 show br-int"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; as hv3 ovs-ofctl -O OpenFlow13 show br-int
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovs-ofctl: br-int is not a bridge or a socket
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure
$at_traceon; }


# Now check the packets actually received against the ones expected.
for i in 1 2 3; do
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv\$i/vif\$i-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv$i/vif$i-tx.pcap " "ovn.at:4341"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv$i/vif$i-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv$i/vif$i-tx.pcap" "$i.expected" "tests/ovn.at:4341"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:4341"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
if $at_failed
then :
  dump_diff__ "hv$i/vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done

# Gracefully terminate daemons


    sbox=hv1
    error=
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check=
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4341"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4341"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



    sbox=hv2
    error=
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check=
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4341"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4341"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test `as vtep ovs-vsctl list-ports vtep_bfd | wc -l` -eq 0
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "until test \`as vtep ovs-vsctl list-ports vtep_bfd | wc -l\` -eq 0"



        sbox=$(echo "vtep" |sed -n '1p')
        error=$(echo "vtep"  | grep '/')
        ignored_dp=$(echo "vtep"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "vtep"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "vtep" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4341"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "vtep" |sed -n '1p')
        error=$(echo "vtep"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4341"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4341"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"





    echo
    echo "hv3: clean up vswitch"
    as hv3
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_75
#AT_START_76
at_fn_group_banner 76 'ovn.at:4341' \
  "vtep: 3 HVs, 1 VIFs/HV, 1 GW, 1 LS -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "76. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init


printf "%s\n" "ovn.at:4341" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:4341"
ovn_start

# Configure the Northbound database
check ovn-nbctl ls-add lsw0

check ovn-nbctl lsp-add lsw0 lp1
check ovn-nbctl lsp-set-addresses lp1 'f0:00:00:00:00:01 192.168.1.24'

check ovn-nbctl lsp-add lsw0 lp2
check ovn-nbctl lsp-set-addresses lp2 f0:00:00:00:00:02

check ovn-nbctl lsp-add lsw0 lp-vtep
check ovn-nbctl lsp-set-type lp-vtep vtep
check ovn-nbctl lsp-set-options lp-vtep vtep-physical-switch=br-vtep vtep-logical-switch=lsw0
check ovn-nbctl lsp-set-addresses lp-vtep unknown

# lpr, lr and lrp1 are used for the ARP request handling test only.
check ovn-nbctl lsp-add lsw0 lpr
check ovn-nbctl lr-add lr
check ovn-nbctl lrp-add lr lrp1 f0:00:00:00:00:f1 192.168.1.1/24
check ovn-nbctl set Logical_Switch_Port lpr \
    type=router \
    options:router-port=lrp1 \
    addresses=router
check ovn-nbctl lrp-set-gateway-chassis lrp1 hv1

check ovn-nbctl lsp-add lsw0 lpr2
check ovn-nbctl lrp-add lr lrp2 f0:00:00:00:00:f2 192.168.1.254/24
check ovn-nbctl set Logical_Switch_Port lpr2 \
    type=router \
    options:router-port=lrp2 \
    addresses=router
check ovn-nbctl lrp-set-gateway-chassis lrp2 hv1

net_add n1               # Network to connect hv1, hv2, and vtep
net_add n2               # Network to connect vtep and hv3

# Create hypervisor hv1 connected to n1
sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl add-port br-int vif1 -- set Interface vif1 external-ids:iface-id=lp1 options:tx_pcap=hv1/vif1-tx.pcap options:rxq_pcap=hv1/vif1-rx.pcap ofport-request=1

# Create hypervisor hv2 connected to n1
sim_add hv2
as hv2
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.2
ovs-vsctl add-port br-int vif2 -- set Interface vif2 external-ids:iface-id=lp2 options:tx_pcap=hv2/vif2-tx.pcap options:rxq_pcap=hv2/vif2-rx.pcap ofport-request=1


# Start the vtep emulator with a leg in both networks
sim_add vtep
as vtep

ovsdb-tool create "$ovs_base"/vtep/vtep.db "$ovs_srcdir"/vtep/vtep.ovsschema
ovs-appctl -t ovsdb-server ovsdb-server/add-db "$ovs_base"/vtep/vtep.db

ovs-vsctl add-br br-phys
net_attach n1 br-phys

mac=`ovs-vsctl get Interface br-phys mac_in_use | sed s/\"//g`
arp_table="$arp_table $sandbox,br-phys,192.168.0.3,$mac"
ovs-appctl netdev-dummy/ip4addr br-phys 192.168.0.3/24 >/dev/null
ovs-appctl ovs/route/add 192.168.0.3/24 br-phys >/dev/null

ovs-vsctl add-br br-vtep
net_attach n2 br-vtep

vtep-ctl add-ps br-vtep
vtep-ctl set Physical_Switch br-vtep tunnel_ips=192.168.0.3
vtep-ctl add-ls lsw0

start_daemon ovs-vtep br-vtep
start_daemon ovn-controller-vtep --vtep-db=unix:"$ovs_base"/vtep/db.sock --ovnsb-db=unix:"$ovs_base"/ovn-sb/ovn-sb.sock
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    vtep-ctl bind-ls br-vtep br-vtep_n2 0 lsw0
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "until vtep-ctl bind-ls br-vtep br-vtep_n2 0 lsw0"


check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test -n "`as vtep vtep-ctl get-replication-mode lsw0 |
               grep -- source`"
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "until test -n \"\`as vtep vtep-ctl get-replication-mode lsw0 |
               grep -- source\`\""


# Add hv3 on the other side of the vtep
sim_add hv3
as hv3
ovs-vsctl add-br br-phys
net_attach n2 br-phys
ovs-vsctl add-port br-phys vif3 -- set Interface vif3 options:tx_pcap=hv3/vif3-tx.pcap options:rxq_pcap=hv3/vif3-rx.pcap ofport-request=1

# vtep is quite slow setting up all flows
# We need to wait for flow flooding to br-vtep_n2, vx1 and vx2
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test `as vtep ovs-ofctl dump-flows br-vtep_vtep_ls1 | grep "priority=0" | grep -o "output" | wc -l` -eq 3
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "until test \`as vtep ovs-ofctl dump-flows br-vtep_vtep_ls1 | grep \"priority=0\" | grep -o \"output\" | wc -l\` -eq 3"


# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure
$at_traceon; }


wait_for_ports_up
check ovn-nbctl --wait=hv sync

# test_packet INPORT DST SRC ETHTYPE OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as logical switch port numbers, e.g. 1 for vif1.
for i in 1 2 3; do
    : > $i.expected
done
test_packet() {
    local inport=$1 packet=$2$3$4; shift; shift; shift; shift
    #hv=hv`echo $inport | sed 's/^\(.\).*/\1/'`
    hv=hv$inport
    vif=vif$inport
    as $hv ovs-appctl netdev-dummy/receive $vif $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# Send packets between all pairs of source and destination ports:
#
# 1. Unicast packets are delivered to exactly one logical switch port
#    (except that packets destined to their input ports are dropped).
#
# 2. Broadcast and multicast are delivered to all logical switch ports
#    except the input port.
#
# 3. The switch delivers packets with an unknown destination to logical
#    switch ports with "unknown" among their MAC addresses (and port
#    security disabled).
for s in 1 2 3; do
    bcast=
    unknown=
    for d in 1 2 3; do
        if test $d != $s; then unicast=$d; else unicast=; fi
        test_packet $s f0000000000$d f0000000000$s 00$s$d $unicast       #1

        # The vtep (vif3) is the only one configured for "unknown"
        if test $d != $s && test $d = 3; then
            unknown="$unknown $d"
        fi
        bcast="$bcast $unicast"
    done

    # Broadcast and multicast.
    test_packet $s ffffffffffff f0000000000$s 0${s}ff $bcast             #2
    test_packet $s 010000000000 f0000000000$s 0${s}ff $bcast             #2

    test_packet $s f0000000ffff f0000000000$s 0${s}66 $unknown           #3
done

# ARP request from VTEP to LRP should be responded by ARP responder.
sha=f0:00:00:00:00:03
spa=192.168.1.2
tpa=192.168.1.1
request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                   ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $request
echo $request >> 1.expected
echo $request >> 2.expected

lrpmac=f0:00:00:00:00:f1
response=$(fmt_pkt "Ether(dst='${sha}', src='${lrpmac}')/ \
                    ARP(op=2, hwsrc='${lrpmac}', hwdst='${sha}', psrc='${tpa}', pdst='${spa}')")
# since lrp1 has gateway chassis set on hv1, hv1 will suppress arp request and
# answer with arp reply by OVS directly to vtep lport. all other lports,
# except lport from which this request was initiated, will receive arp request.
# we expect arp reply packet on hv3
echo $response >> 3.expected

# Ensure there is no MAC_Binding, send GARP from vtep side,
# check that GARP was received by vif1, vif2 and MAC_Binding was created.
wait_row_count MAC_Binding 0 ip="192.168.1.200" mac='"f0:00:00:00:00:12"'

sha=02:00:00:00:00:ff
tha=ff:ff:ff:ff:ff:ff
spa=192.168.1.200
tpa=$spa
garp=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                ARP(op=2, hwsrc='${sha}', hwdst='${tha}', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $garp
echo $garp >> 1.expected
echo $garp >> 2.expected

wait_row_count MAC_Binding 2 ip="192.168.1.200" mac='"02:00:00:00:00:ff"'

# Send same GARP with changed SHA and ensure MAC_Binding was updated.
sha=02:00:00:00:00:ee
garp=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                ARP(op=2, hwsrc='${sha}', hwdst='${tha}', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $garp
echo $garp >> 1.expected
echo $garp >> 2.expected

wait_row_count MAC_Binding 2 ip="192.168.1.200" mac='"02:00:00:00:00:ee"'

# Remove local ports on hv1 and check that ARP logic is stil working. -->
check as hv1 ovs-vsctl remove interface vif1 external_ids iface-id
hv_uuid=$(fetch_column Chassis _uuid name=hv1)
wait_row_count Port_Binding 0 chassis="$hv_uuid" type="''"

# Cleanup MAC_Bindings after previous checks.
check ovn-sbctl --all destroy MAC_Binding

# ARP request from VTEP to LRP should be responded by ARP responder.
sha=f0:00:00:00:00:03
spa=192.168.1.2
tpa=192.168.1.1
request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                   ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $request
echo $request >> 2.expected

lrpmac=f0:00:00:00:00:f1
response=$(fmt_pkt "Ether(dst='${sha}', src='${lrpmac}')/ \
                    ARP(op=2, hwsrc='${lrpmac}', hwdst='${sha}', psrc='${tpa}', pdst='${spa}')")
# since lrp1 has gateway chassis set on hv1, hv1 will suppress arp request and
# answer with arp reply by OVS directly to vtep lport. all other lports,
# except lport from which this request was initiated, will receive arp request.
# we expect arp reply packet on hv3
echo $response >> 3.expected

# Ensure there is no MAC_Binding, send GARP from vtep side,
# check that GARP was received by vif1, vif2 and MAC_Binding was created.
wait_row_count MAC_Binding 0 ip="192.168.1.200" mac='"f0:00:00:00:00:12"'

sha=02:00:00:00:00:ff
tha=ff:ff:ff:ff:ff:ff
spa=192.168.1.200
tpa=$spa
garp=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                ARP(op=2, hwsrc='${sha}', hwdst='${tha}', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $garp
echo $garp >> 2.expected

wait_row_count MAC_Binding 2 ip="192.168.1.200" mac='"02:00:00:00:00:ff"'

# Send same GARP with changed SHA and ensure MAC_Binding was updated.
sha=02:00:00:00:00:ee
garp=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                ARP(op=2, hwsrc='${sha}', hwdst='${tha}', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $garp
echo $garp >> 2.expected

wait_row_count MAC_Binding 2 ip="192.168.1.200" mac='"02:00:00:00:00:ee"'

# Restore.
check as hv1 ovs-vsctl set interface vif1 external_ids:iface-id=lp1
wait_row_count Port_Binding 1 chassis="$hv_uuid" type='""'
# Make sure flows added by port claim are installed
check ovn-nbctl --wait=hv sync
# <--

# Check ARP response to request for IP on VIF port sent from vtep.
# ARP request from VTEP to LSP's IP must be answered only by LSP vif1 (lp1).
sha=f0:00:00:00:00:03
spa=192.168.1.2
tpa=192.168.1.24
request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                   ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
as hv3 ovs-appctl netdev-dummy/receive vif3 $request
echo $request >> 1.expected
echo $request >> 2.expected

# Simulate response from vif.
sha=f0:00:00:00:00:01
tha=f0:00:00:00:00:03
spa=192.168.1.200
tpa=192.168.1.2
response=$(fmt_pkt "Ether(dst='${tha}', src='${sha}')/ \
                    ARP(op=2, hwsrc='${sha}', hwdst='${tha}', psrc='${spa}', pdst='${tpa}')")
as hv1 ovs-appctl netdev-dummy/receive vif1 $response
echo $response >> 3.expected

# First ensure basic flow contents are as we expect.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovn-sbctl lflow-list lsw0 | grep 'reg0\\[14\\]' | ovn_strip_lflows"
at_fn_check_prepare_notrace 'a shell pipeline' "ovn.at:4341"
( $at_check_trace; ovn-sbctl lflow-list lsw0 | grep 'reg0\[14\]' | ovn_strip_lflows
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "  table=??(ls_in_arp_rsp      ), priority=65535, match=(reg0[14] == 1 && (arp || nd_ns)), action=(flags.loopback = 1; next;)
  table=??(ls_in_check_port_sec), priority=70   , match=(inport == \"lp-vtep\"), action=(reg0[14] = 1; next(pipeline=ingress, table=??);)
  table=??(ls_in_hairpin      ), priority=1000 , match=(reg0[14] == 1), action=(next(pipeline=ingress, table=??);)
  table=??(ls_in_hairpin      ), priority=2000 , match=(reg0[14] == 1 && is_chassis_resident(\"cr-lrp1\")), action=(next;)
  table=??(ls_in_hairpin      ), priority=2000 , match=(reg0[14] == 1 && is_chassis_resident(\"cr-lrp2\")), action=(next;)
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure
$at_traceon; }


# dump information with counters
echo "------ OVN dump ------"
ovn-nbctl show
ovn-sbctl show

echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list port_binding
echo "---------------------"
ovn-sbctl dump-flows

echo "------ hv1 dump ------"
as hv1 ovs-vsctl show
as hv1 ovs-ofctl -O OpenFlow13 show br-int
as hv1 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv2 dump ------"
as hv2 ovs-vsctl show
as hv2 ovs-ofctl -O OpenFlow13 show br-int
as hv2 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv3 dump ------"
as hv3 ovs-vsctl show
# note: hv3 has no logical port bind, thus it should not have br-int
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: as hv3 ovs-ofctl -O OpenFlow13 show br-int"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; as hv3 ovs-ofctl -O OpenFlow13 show br-int
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo >>"$at_stderr"; printf "%s\n" "ovs-ofctl: br-int is not a bridge or a socket
" | \
  $at_diff - "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 1 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure
$at_traceon; }


# Now check the packets actually received against the ones expected.
for i in 1 2 3; do
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv\$i/vif\$i-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv$i/vif$i-tx.pcap " "ovn.at:4341"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv$i/vif$i-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv$i/vif$i-tx.pcap" "$i.expected" "tests/ovn.at:4341"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:4341"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
if $at_failed
then :
  dump_diff__ "hv$i/vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done

# Gracefully terminate daemons


    sbox=hv1
    error=
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check=
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4341"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4341"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



    sbox=hv2
    error=
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check=
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4341"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4341"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test `as vtep ovs-vsctl list-ports vtep_bfd | wc -l` -eq 0
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "until test \`as vtep ovs-vsctl list-ports vtep_bfd | wc -l\` -eq 0"



        sbox=$(echo "vtep" |sed -n '1p')
        error=$(echo "vtep"  | grep '/')
        ignored_dp=$(echo "vtep"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "vtep"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "vtep" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4341"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "vtep" |sed -n '1p')
        error=$(echo "vtep"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4341"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4341"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"





    echo
    echo "hv3: clean up vswitch"
    as hv3
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4341"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4341: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4341"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4341"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4341" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_76
#AT_START_77
at_fn_group_banner 77 'ovn.at:4677' \
  "3 HVs, 1 VIFs/HV, 1 software GW, 1 LS -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "77. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

# Configure the Northbound database
check ovn-nbctl ls-add lsw0

check ovn-nbctl lsp-add lsw0 lp1
check ovn-nbctl lsp-set-addresses lp1 f0:00:00:00:00:01

check ovn-nbctl lsp-add lsw0 lp2
check ovn-nbctl lsp-set-addresses lp2 f0:00:00:00:00:02

check ovn-nbctl lsp-add lsw0 lp-gw
check ovn-nbctl lsp-set-type lp-gw l2gateway
check ovn-nbctl lsp-set-options lp-gw network_name=physnet1 l2gateway-chassis=hv_gw
check ovn-nbctl lsp-set-addresses lp-gw unknown

net_add n1               # Network to connect hv1, hv2, and gw
net_add n2               # Network to connect gw and hv3

# Create hypervisor hv1 connected to n1
sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl add-port br-int vif1 -- set Interface vif1 external-ids:iface-id=lp1 options:tx_pcap=hv1/vif1-tx.pcap options:rxq_pcap=hv1/vif1-rx.pcap ofport-request=1

# Create hypervisor hv2 connected to n1
sim_add hv2
as hv2
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.2
ovs-vsctl add-port br-int vif2 -- set Interface vif2 external-ids:iface-id=lp2 options:tx_pcap=hv2/vif2-tx.pcap options:rxq_pcap=hv2/vif2-rx.pcap ofport-request=1

# Create hypervisor hv_gw connected to n1 and n2
# connect br-phys bridge to n1; connect hv-gw bridge to n2
sim_add hv_gw
as hv_gw
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.3
ovs-vsctl add-br br-phys2
net_attach n2 br-phys2
ovs-vsctl set open . external_ids:ovn-bridge-mappings="physnet1:br-phys2"

# Add hv3 on the other side of the GW
sim_add hv3
as hv3
ovs-vsctl add-br br-phys
net_attach n2 br-phys
ovs-vsctl add-port br-phys vif3 -- set Interface vif3 options:tx_pcap=hv3/vif3-tx.pcap options:rxq_pcap=hv3/vif3-rx.pcap ofport-request=1


# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure
$at_traceon; }


wait_for_ports_up
check ovn-nbctl --wait=hv sync
ovn_wait_remote_output_flows ""hv1"" ""hv2"" "tests/ovn.at:4677"
ovn_wait_remote_output_flows ""hv2"" ""hv1"" "tests/ovn.at:4677"
ovn_wait_remote_output_flows ""hv1"" ""hv_gw"" "tests/ovn.at:4677"
ovn_wait_remote_output_flows ""hv_gw"" ""hv1"" "tests/ovn.at:4677"
ovn_wait_remote_output_flows ""hv2"" ""hv_gw"" "tests/ovn.at:4677"
ovn_wait_remote_output_flows ""hv_gw"" ""hv2"" "tests/ovn.at:4677"

# test_packet INPORT DST SRC ETHTYPE OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as lport numbers, e.g. 1 for vif1.
for i in 1 2 3; do
    : > $i.expected
done
test_packet() {
    local inport=$1 packet=$2$3$4; shift; shift; shift; shift
    #hv=hv`echo $inport | sed 's/^\(.\).*/\1/'`
    hv=hv$inport
    vif=vif$inport
    as $hv ovs-appctl netdev-dummy/receive $vif $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# Send packets between all pairs of source and destination ports:
#
# 1. Unicast packets are delivered to exactly one lport (except that packets
#    destined to their input ports are dropped).
#
# 2. Broadcast and multicast are delivered to all lports except the input port.
#
# 3. The lswitch delivers packets with an unknown destination to lports with
#    "unknown" among their MAC addresses (and port security disabled).
for s in 1 2 3 ; do
    bcast=
    unknown=
    for d in 1 2 3 ; do
        if test $d != $s; then unicast=$d; else unicast=; fi
        test_packet $s f0000000000$d f0000000000$s 00$s$d $unicast       #1

        # The vtep (vif3) is the only one configured for "unknown"
        if test $d != $s && test $d = 3; then
            unknown="$unknown $d"
        fi
        bcast="$bcast $unicast"
    done

    test_packet $s ffffffffffff f0000000000$s 0${s}ff $bcast             #2
    test_packet $s 010000000000 f0000000000$s 0${s}ff $bcast             #3
    test_packet $s f0000000ffff f0000000000$s 0${s}66 $unknown           #4
done

echo "------ ovn-nbctl show ------"
ovn-nbctl show
echo "------ ovn-sbctl show ------"
ovn-sbctl show

echo "------ hv1 ------"
as hv1 ovs-vsctl show
echo "------ hv1 br-int ------"
as hv1 ovs-ofctl -O OpenFlow13 dump-flows br-int
echo "------ hv1 br-phys ------"
as hv1 ovs-ofctl -O OpenFlow13 dump-flows br-phys

echo "------ hv2 ------"
as hv2 ovs-vsctl show
echo "------ hv2 br-int ------"
as hv2 ovs-ofctl -O OpenFlow13 dump-flows br-int
echo "------ hv2 br-phys ------"
as hv2 ovs-ofctl -O OpenFlow13 dump-flows br-phys

echo "------ hv_gw ------"
as hv_gw ovs-vsctl show
echo "------ hv_gw br-phys ------"
as hv_gw ovs-ofctl -O OpenFlow13 dump-flows br-phys
echo "------ hv_gw br-phys2 ------"
as hv_gw ovs-ofctl -O OpenFlow13 dump-flows br-phys2

echo "------ hv3 ------"
as hv3 ovs-vsctl show
echo "------ hv3 br-phys ------"
as hv3 ovs-ofctl -O OpenFlow13 dump-flows br-phys

# Now check the packets actually received against the ones expected.
for i in 1 2 3; do
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv\$i/vif\$i-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv$i/vif$i-tx.pcap " "ovn.at:4677"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv$i/vif$i-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv$i/vif$i-tx.pcap" "$i.expected" "tests/ovn.at:4677"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:4677"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
if $at_failed
then :
  dump_diff__ "hv$i/vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done
as hv3
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4677"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4677"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv_gw
/bridge not found for l2gateway port/d" |sed -n '1p')
        error=$(echo "hv_gw
/bridge not found for l2gateway port/d"  | grep '/')
        ignored_dp=$(echo "hv_gw
/bridge not found for l2gateway port/d"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv_gw
/bridge not found for l2gateway port/d"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv_gw
/bridge not found for l2gateway port/d" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4677"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4677"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4677"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4677"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4677"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv_gw
/bridge not found for l2gateway port/d" |sed -n '1p')
        error=$(echo "hv_gw
/bridge not found for l2gateway port/d"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4677"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4677"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_77
#AT_START_78
at_fn_group_banner 78 'ovn.at:4677' \
  "3 HVs, 1 VIFs/HV, 1 software GW, 1 LS -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "78. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

# Configure the Northbound database
check ovn-nbctl ls-add lsw0

check ovn-nbctl lsp-add lsw0 lp1
check ovn-nbctl lsp-set-addresses lp1 f0:00:00:00:00:01

check ovn-nbctl lsp-add lsw0 lp2
check ovn-nbctl lsp-set-addresses lp2 f0:00:00:00:00:02

check ovn-nbctl lsp-add lsw0 lp-gw
check ovn-nbctl lsp-set-type lp-gw l2gateway
check ovn-nbctl lsp-set-options lp-gw network_name=physnet1 l2gateway-chassis=hv_gw
check ovn-nbctl lsp-set-addresses lp-gw unknown

net_add n1               # Network to connect hv1, hv2, and gw
net_add n2               # Network to connect gw and hv3

# Create hypervisor hv1 connected to n1
sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl add-port br-int vif1 -- set Interface vif1 external-ids:iface-id=lp1 options:tx_pcap=hv1/vif1-tx.pcap options:rxq_pcap=hv1/vif1-rx.pcap ofport-request=1

# Create hypervisor hv2 connected to n1
sim_add hv2
as hv2
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.2
ovs-vsctl add-port br-int vif2 -- set Interface vif2 external-ids:iface-id=lp2 options:tx_pcap=hv2/vif2-tx.pcap options:rxq_pcap=hv2/vif2-rx.pcap ofport-request=1

# Create hypervisor hv_gw connected to n1 and n2
# connect br-phys bridge to n1; connect hv-gw bridge to n2
sim_add hv_gw
as hv_gw
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.3
ovs-vsctl add-br br-phys2
net_attach n2 br-phys2
ovs-vsctl set open . external_ids:ovn-bridge-mappings="physnet1:br-phys2"

# Add hv3 on the other side of the GW
sim_add hv3
as hv3
ovs-vsctl add-br br-phys
net_attach n2 br-phys
ovs-vsctl add-port br-phys vif3 -- set Interface vif3 options:tx_pcap=hv3/vif3-tx.pcap options:rxq_pcap=hv3/vif3-rx.pcap ofport-request=1


# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure
$at_traceon; }


wait_for_ports_up
check ovn-nbctl --wait=hv sync
ovn_wait_remote_output_flows ""hv1"" ""hv2"" "tests/ovn.at:4677"
ovn_wait_remote_output_flows ""hv2"" ""hv1"" "tests/ovn.at:4677"
ovn_wait_remote_output_flows ""hv1"" ""hv_gw"" "tests/ovn.at:4677"
ovn_wait_remote_output_flows ""hv_gw"" ""hv1"" "tests/ovn.at:4677"
ovn_wait_remote_output_flows ""hv2"" ""hv_gw"" "tests/ovn.at:4677"
ovn_wait_remote_output_flows ""hv_gw"" ""hv2"" "tests/ovn.at:4677"

# test_packet INPORT DST SRC ETHTYPE OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as lport numbers, e.g. 1 for vif1.
for i in 1 2 3; do
    : > $i.expected
done
test_packet() {
    local inport=$1 packet=$2$3$4; shift; shift; shift; shift
    #hv=hv`echo $inport | sed 's/^\(.\).*/\1/'`
    hv=hv$inport
    vif=vif$inport
    as $hv ovs-appctl netdev-dummy/receive $vif $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# Send packets between all pairs of source and destination ports:
#
# 1. Unicast packets are delivered to exactly one lport (except that packets
#    destined to their input ports are dropped).
#
# 2. Broadcast and multicast are delivered to all lports except the input port.
#
# 3. The lswitch delivers packets with an unknown destination to lports with
#    "unknown" among their MAC addresses (and port security disabled).
for s in 1 2 3 ; do
    bcast=
    unknown=
    for d in 1 2 3 ; do
        if test $d != $s; then unicast=$d; else unicast=; fi
        test_packet $s f0000000000$d f0000000000$s 00$s$d $unicast       #1

        # The vtep (vif3) is the only one configured for "unknown"
        if test $d != $s && test $d = 3; then
            unknown="$unknown $d"
        fi
        bcast="$bcast $unicast"
    done

    test_packet $s ffffffffffff f0000000000$s 0${s}ff $bcast             #2
    test_packet $s 010000000000 f0000000000$s 0${s}ff $bcast             #3
    test_packet $s f0000000ffff f0000000000$s 0${s}66 $unknown           #4
done

echo "------ ovn-nbctl show ------"
ovn-nbctl show
echo "------ ovn-sbctl show ------"
ovn-sbctl show

echo "------ hv1 ------"
as hv1 ovs-vsctl show
echo "------ hv1 br-int ------"
as hv1 ovs-ofctl -O OpenFlow13 dump-flows br-int
echo "------ hv1 br-phys ------"
as hv1 ovs-ofctl -O OpenFlow13 dump-flows br-phys

echo "------ hv2 ------"
as hv2 ovs-vsctl show
echo "------ hv2 br-int ------"
as hv2 ovs-ofctl -O OpenFlow13 dump-flows br-int
echo "------ hv2 br-phys ------"
as hv2 ovs-ofctl -O OpenFlow13 dump-flows br-phys

echo "------ hv_gw ------"
as hv_gw ovs-vsctl show
echo "------ hv_gw br-phys ------"
as hv_gw ovs-ofctl -O OpenFlow13 dump-flows br-phys
echo "------ hv_gw br-phys2 ------"
as hv_gw ovs-ofctl -O OpenFlow13 dump-flows br-phys2

echo "------ hv3 ------"
as hv3 ovs-vsctl show
echo "------ hv3 br-phys ------"
as hv3 ovs-ofctl -O OpenFlow13 dump-flows br-phys

# Now check the packets actually received against the ones expected.
for i in 1 2 3; do
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv\$i/vif\$i-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv$i/vif$i-tx.pcap " "ovn.at:4677"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv$i/vif$i-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv$i/vif$i-tx.pcap" "$i.expected" "tests/ovn.at:4677"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:4677"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
if $at_failed
then :
  dump_diff__ "hv$i/vif$i-tx.pcap" "$i.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

done
as hv3
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4677"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4677"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv_gw
/bridge not found for l2gateway port/d" |sed -n '1p')
        error=$(echo "hv_gw
/bridge not found for l2gateway port/d"  | grep '/')
        ignored_dp=$(echo "hv_gw
/bridge not found for l2gateway port/d"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv_gw
/bridge not found for l2gateway port/d"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv_gw
/bridge not found for l2gateway port/d" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4677"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4677"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4677"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4677"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4677"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv_gw
/bridge not found for l2gateway port/d" |sed -n '1p')
        error=$(echo "hv_gw
/bridge not found for l2gateway port/d"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4677"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4677"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4677"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4677: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4677"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4677"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4677" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_78
#AT_START_79
at_fn_group_banner 79 'ovn.at:4836' \
  "3 HVs, 3 LS, 3 lports/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "79. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init


printf "%s\n" "ovn.at:4836" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:4836"
ovn_start

# Logical network:
#
# Three logical switches ls1, ls2, ls3.
# One logical router lr0 connected to ls[123],
# with nine subnets, three per logical switch:
#
#    lrp11 on ls1 for subnet 192.168.11.0/24
#    lrp12 on ls1 for subnet 192.168.12.0/24
#    lrp13 on ls1 for subnet 192.168.13.0/24
#    ...
#    lrp33 on ls3 for subnet 192.168.33.0/24
#
# 27 VIFs, 9 per LS, 3 per subnet: lp[123][123][123], where the first two
# digits are the subnet and the last digit distinguishes the VIF.
for i in 1 2 3; do
    check ovn-nbctl ls-add ls$i
    for j in 1 2 3; do
        for k in 1 2 3; do
            # Add "unknown" to MAC addresses for lp?11, so packets for
            # MAC-IP bindings discovered via ARP later have somewhere to go.
            if test $j$k = 11; then unknown=unknown; else unknown=; fi

            check ovn-nbctl \
                -- lsp-add ls$i lp$i$j$k \
                -- lsp-set-addresses lp$i$j$k \
                   "f0:00:00:00:0$i:$j$k 192.168.$i$j.$k" $unknown
        done
    done
done

check ovn-nbctl lr-add lr0
for i in 1 2 3; do
    for j in 1 2 3; do
        check ovn-nbctl lrp-add lr0 lrp$i$j 00:00:00:00:ff:$i$j 192.168.$i$j.254/24
        check ovn-nbctl \
            -- lsp-add ls$i lrp$i$j-attachment \
            -- set Logical_Switch_Port lrp$i$j-attachment type=router \
                             options:router-port=lrp$i$j \
                             addresses='"00:00:00:00:ff:'$i$j'"'
    done
done

check ovn-nbctl set Logical_Switch_Port lrp33-attachment \
    addresses='"00:00:00:00:ff:33 192.168.33.254"'

# Physical network:
#
# Three hypervisors hv[123].
# lp?1[123] spread across hv[123]: lp?11 on hv1, lp?12 on hv2, lp?13 on hv3.
# lp?2[123] spread across hv[23]: lp?21 and lp?22 on hv2, lp?23 on hv3.
# lp?3[123] all on hv3.


# Given the name of a logical port, prints the name of the hypervisor
# on which it is located.
vif_to_hv() {
    case $1 in         ?11) echo 1 ;;         ?12 | ?21 | ?22) echo 2 ;;         ?13 | ?23 | ?3?) echo 3 ;;
    esac
}

# Given the name of a logical port, prints the name of its logical router
# port, e.g. "vif_to_lrp 123" yields 12.
vif_to_lrp() {
    echo ${1%?}
}

# Given the name of a logical port, prints the name of its logical
# switch, e.g. "vif_to_ls 123" yields 1.
vif_to_ls() {
    echo ${1%??}
}

net_add n1
for i in 1 2 3; do
    sim_add hv$i
    as hv$i
    ovs-vsctl add-br br-phys
    ovn_attach n1 br-phys 192.168.0.$i
done
for i in 1 2 3; do
    for j in 1 2 3; do
        for k in 1 2 3; do
            hv=`vif_to_hv $i$j$k`
                as hv$hv ovs-vsctl \
                -- add-port br-int vif$i$j$k \
                -- set Interface vif$i$j$k \
                    external-ids:iface-id=lp$i$j$k \
                    options:tx_pcap=hv$hv/vif$i$j$k-tx.pcap \
                    options:rxq_pcap=hv$hv/vif$i$j$k-rx.pcap \
                    ofport-request=$i$j$k
        done
    done
done

wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure
$at_traceon; }


ovn_wait_remote_output_flows ""hv1"" ""hv2"" "tests/ovn.at:4836"
ovn_wait_remote_output_flows ""hv2"" ""hv1"" "tests/ovn.at:4836"
ovn_wait_remote_output_flows ""hv2"" ""hv3"" "tests/ovn.at:4836"
ovn_wait_remote_output_flows ""hv3"" ""hv2"" "tests/ovn.at:4836"
ovn_wait_remote_output_flows ""hv1"" ""hv3"" "tests/ovn.at:4836"
ovn_wait_remote_output_flows ""hv3"" ""hv1"" "tests/ovn.at:4836"

# test_ip INPORT SRC_MAC DST_MAC SRC_IP DST_IP OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as logical switch port numbers, e.g. 123 for vif123.
for i in 1 2 3; do
    for j in 1 2 3; do
        for k in 1 2 3; do
            : > $i$j$k.expected
        done
    done
done
test_ip() {
    # This packet has bad checksums but logical L3 routing doesn't check.
    local inport=$1 src_mac=$2 dst_mac=$3 src_ip=$4 dst_ip=$5
    local packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                            IP(src='${src_ip}', dst='${dst_ip}', ttl=0x40)/ \
                            UDP(sport=53, dport=4369)")
    shift; shift; shift; shift; shift
    hv=hv`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $packet
    in_ls=`vif_to_ls $inport`
    in_lrp=`vif_to_lrp $inport`
    for outport; do
        out_ls=`vif_to_ls $outport`
        if test $in_ls = $out_ls; then
            # Ports on the same logical switch receive exactly the same packet.
            echo $packet
        else
            # Routing decrements TTL and updates source and dest MAC
            # (and checksum).
            out_lrp=`vif_to_lrp $outport`
            echo $(fmt_pkt "Ether(dst='f0:00:00:00:0$out_ls:${outport#?}', src='00:00:00:00:ff:${out_lrp}')/ \
                            IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3f)/ \
                            UDP(sport=53, dport=4369)")
        fi >> $outport.expected
    done
}

# test_arp INPORT SHA SPA TPA [REPLY_HA]
#
# Causes a packet to be received on INPORT.  The packet is an ARP
# request with SHA, SPA, and TPA as specified.  If REPLY_HA is provided, then
# it should be the hardware address of the target to expect to receive in an
# ARP reply; otherwise no reply is expected.
#
# INPORT is an logical switch port number, e.g. 11 for vif11.
# SHA and REPLY_HA are each 12 hex digits.
# SPA and TPA are each 8 hex digits.
test_arp() {
    echo "$@"
    local inport=$1 sha=$2 spa=$3 tpa=$4 reply_ha=$5
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                             ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
    hv=hv`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $request

    # Expect to receive the broadcast ARP on the other logical switch ports if
    # IP address is not configured to the switch patch port.
    local i=`vif_to_ls $inport`
    local j k
    for j in 1 2 3; do
        for k in 1 2 3; do
            # 192.168.33.254 is configured to the switch patch port for lrp33,
            # so no ARP flooding expected for it.
            if test $i$j$k != $inport && test $tpa != 192.168.33.254; then
                echo $request >> $i$j$k.expected
            fi
        done
    done

    # Expect to receive the reply, if any.
    if test X$reply_ha != X; then
        lrp=`vif_to_lrp $inport`
        local reply=$(fmt_pkt "Ether(dst='${sha}', src='00:00:00:00:ff:${lrp}')/ \
                               ARP(op=2, hwsrc='${reply_ha}', hwdst='${sha}', psrc='${tpa}', pdst='${spa}')")
        echo $reply >> $inport.expected
    fi
}

as hv1 ovs-vsctl --columns=name,ofport list interface > interfaces
(as hv1 ovn-sbctl list port_binding
 as hv1 ovn-sbctl list datapath_binding) > bindings
as hv1 ovn-sbctl dump-flows > sbflows
as hv1 ovs-ofctl dump-flows br-int > offlows





# Send IP packets between all pairs of source and destination ports:
#
# 1. Unicast IP packets are delivered to exactly one logical switch port
#    (except that packets destined to their input ports are dropped).
#
# 2. Broadcast IP packets are delivered to all logical switch ports
#    except the input port.
for is in 1 2 3; do
  for js in 1 2 3; do
    for ks in 1 2 3; do
      bcast=
      s=$is$js$ks
      smac=f0:00:00:00:0$is:$js$ks
      sip=192.168.$is$js.$ks
      for id in 1 2 3; do
          for jd in 1 2 3; do
              for kd in 1 2 3; do
                d=$id$jd$kd
                dip=192.168.$id$jd.$kd
                if test $is = $id; then dmac=f0:00:00:00:0$id:$jd$kd; else dmac=00:00:00:00:ff:$is$js; fi
                if test $d != $s; then unicast=$d; else unicast=; fi

                test_ip $s $smac $dmac $sip $dip $unicast #1

                if test $id = $is && test $d != $s; then bcast="$bcast $d"; fi
              done
          done
        done
      test_ip $s $smac ff:ff:ff:ff:ff:ff $sip 255.255.255.255 $bcast #2
      done
  done
  wait
done

: > mac_bindings.expected

# 3. Send an IP packet from every logical port to every other subnet,
#    to an IP address that does not have a static IP-MAC binding.
#    This should generate a broadcast ARP request for the destination
#    IP address in the destination subnet.
#    Moreover generate an ARP reply for each of the IP addresses ARPed
for is in 1 2 3; do
  for js in 1 2 3; do
    for ks in 1 2 3; do
      s=$is$js$ks
      smac=f0:00:00:00:0$is:$js$ks
      sip=192.168.$is$js.$ks
      for id in 1 2 3; do
        for jd in 1 2 3; do
          if test $is$js = $id$jd; then
            continue
          fi

          # Send the packet.
          dmac=00:00:00:00:ff:$is$js
          # Calculate a 4th octet for the destination that is
          # unique per $s, avoids the .1 .2 .3 and .254 IP addresses
          # that have static MAC bindings, and fits in the range
          # 0-255.
          o4=`expr $is '*' 9 + $js '*' 3 + $ks + 10`
          dip=192.168.$id$jd.$o4
          test_ip $s $smac $dmac $sip $dip

          # Every LP on the destination subnet's lswitch should
          # receive the ARP request.
          lrmac=00:00:00:00:ff:$id$jd
          lrip=192.168.$id$jd.254
          arp=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${lrmac}')/ \
                         ARP(hwsrc='${lrmac}', hwdst='00:00:00:00:00:00', psrc='${lrip}', pdst='${dip}')")
          for jd2 in 1 2 3; do
            for kd in 1 2 3; do
              echo $arp >> $id$jd2$kd.expected
            done
          done

          hmac=80:00:00:00:00:$o4
          rmac=00:00:00:00:ff:$id$jd
          echo $(fmt_pkt "Ether(dst='${hmac}', src='${rmac}')/ \
                          IP(src='${sip}', dst='${dip}', ttl=0x3f)/ \
                          UDP(sport=53, dport=4369)") >> ${id}11.expected

          host_mac=80:00:00:00:00:$o4
          lrmac=00:00:00:00:ff:$id$jd

          arp_reply=$(fmt_pkt "Ether(dst='${lrmac}', src='${host_mac}')/ \
                               ARP(op=2, hwsrc='${host_mac}', hwdst='${lrmac}', psrc='${dip}', pdst='${lrip}')")

          hv=hv`vif_to_hv ${id}${jd}1`
          as $hv ovs-appctl netdev-dummy/receive vif${id}${jd}1 $arp_reply

          echo lrp$id$jd,$dip,$hmac >> mac_bindings.expected
        done
      done
    done
  done
done

# Test router replies to ARP requests from all source ports:
#
# 4. Router replies to query for its MAC address from port's own IP address.
#
# 5. Router replies to query for its MAC address from any random IP address
#    in its subnet.
#
# 6. No reply to query for IP address other than router IP.
#
# 7. No reply to query from another subnet.
for i in 1 2 3; do
  for j in 1 2 3; do
    for k in 1 2 3; do
      smac=f0:00:00:00:0$i:$j$k               # Source MAC
      sip=192.168.$i$j.$k    # Source IP
      rip=192.168.$i$j.254   # Router IP
      rmac=00:00:00:00:ff:$i$j                # Router MAC
      otherip=192.168.$i$j.55 # Some other IP in subnet
      externalip=1.2.3.4      # Some other IP not in subnet

      test_arp $i$j$k $smac $sip        $rip        $rmac      #4
      test_arp $i$j$k $smac $otherip    $rip        $rmac      #5
      test_arp $i$j$k $smac $sip        $otherip               #6

      # When rip is 192.168.33.254, ARP request from externalip won't be
      # filtered, because 192.168.33.254 is configured to switch peer port
      # for lrp33.
      lrp33_rsp=
      if test $i = 3 && test $j = 3; then
        lrp33_rsp=$rmac
      fi
      test_arp $i$j$k $smac $externalip $rip        $lrp33_rsp #7

      # MAC binding should be learned from ARP request.
      echo lrp$i$j,$sip,$smac >> mac_bindings.expected

      # mac_binding is learned and overwritten so only the last one remains.
      if test $k = 3; then
          # lrp33 will not learn from ARP request, because 192.168.33.254 is
          # configured to switch peer port for lrp33.
          if test $i != 3 || test $j != 3; then
              echo lrp$i$j,$otherip,$smac >> mac_bindings.expected
          fi
      fi

    done
  done
done


# Allow some time for packet forwarding.
# XXX This can be improved.
sleep 1

# 8. Send an IP packet from every logical port to every other subnet.  These
#    are the same packets already sent as #3, but now the destinations' IP-MAC
#    bindings have been discovered via ARP, so instead of provoking an ARP
#    request, these packets now get routed to their destinations (which don't
#    have static MAC bindings, so they go to the port we've designated as
#    accepting "unknown" MACs.)
for is in 1 2 3; do
  for js in 1 2 3; do
    for ks in 1 2 3; do
      s=$is$js$ks
      smac=f0:00:00:00:0$is:$js$ks
      sip=192.168.$is$js.$ks
      for id in 1 2 3; do
        for jd in 1 2 3; do
          if test $is$js = $id$jd; then
            continue
          fi

          # Send the packet.
          dmac=00:00:00:00:ff:$is$js
          # Calculate a 4th octet for the destination that is
          # unique per $s, avoids the .1 .2 .3 and .254 IP addresses
          # that have static MAC bindings, and fits in the range
          # 0-255.
          o4=`expr $is '*' 9 + $js '*' 3 + $ks + 10`
          dip=192.168.$id$jd.$o4
          test_ip $s $smac $dmac $sip $dip

          # Expect the packet egress.
          host_mac=80:00:00:00:00:$o4
          outport=${id}11
          out_lrp=$id$jd
          echo $(fmt_pkt "Ether(dst='${host_mac}', src='00:00:00:00:ff:$id$jd')/ \
                          IP(src='${sip}', dst='${dip}', ttl=0x3f)/ \
                          UDP(sport=53, dport=4369)") >> $outport.expected
        done
      done
    done
  done
done

ovn-sbctl dump-flows > sbflows2




check_packets() {
    > expected
    > received
    for i in 1 2 3; do
        for j in 1 2 3; do
            for k in 1 2 3; do
                pcap=hv`vif_to_hv $i$j$k`/vif$i$j$k-tx.pcap
                echo "--- $pcap" | tee -a expected >> received
                sort $i$j$k.expected >> expected
                $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" $pcap | sort >> received
                echo | tee -a expected >> received
            done
        done
    done

    echo '--- MAC bindings' | tee -a expected >> received
    ovn-sbctl -f csv -d bare --no-heading \
        -- --columns=logical_port,ip,mac list mac_binding | sort >> received
    sort < mac_bindings.expected >> expected

    $at_diff expected received >/dev/null
}
check_ovs_wait_until_args "2" "$at_diff -F'^---' expected received"
   ovs_wait_cond () {
    check_packets
}
ovs_wait_failed () {
    :
    $at_diff -F'^---' expected received
}
ovs_wait "ovn.at:4836" "until check_packets"


# Gracefully terminate daemons


        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4836"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4836"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv3" |sed -n '1p')
        error=$(echo "hv3"  | grep '/')
        ignored_dp=$(echo "hv3"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv3"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv3" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4836"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4836"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4836"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4836"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4836"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv3" |sed -n '1p')
        error=$(echo "hv3"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4836"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4836"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_79
#AT_START_80
at_fn_group_banner 80 'ovn.at:4836' \
  "3 HVs, 3 LS, 3 lports/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "80. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init


printf "%s\n" "ovn.at:4836" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:4836"
ovn_start

# Logical network:
#
# Three logical switches ls1, ls2, ls3.
# One logical router lr0 connected to ls[123],
# with nine subnets, three per logical switch:
#
#    lrp11 on ls1 for subnet 192.168.11.0/24
#    lrp12 on ls1 for subnet 192.168.12.0/24
#    lrp13 on ls1 for subnet 192.168.13.0/24
#    ...
#    lrp33 on ls3 for subnet 192.168.33.0/24
#
# 27 VIFs, 9 per LS, 3 per subnet: lp[123][123][123], where the first two
# digits are the subnet and the last digit distinguishes the VIF.
for i in 1 2 3; do
    check ovn-nbctl ls-add ls$i
    for j in 1 2 3; do
        for k in 1 2 3; do
            # Add "unknown" to MAC addresses for lp?11, so packets for
            # MAC-IP bindings discovered via ARP later have somewhere to go.
            if test $j$k = 11; then unknown=unknown; else unknown=; fi

            check ovn-nbctl \
                -- lsp-add ls$i lp$i$j$k \
                -- lsp-set-addresses lp$i$j$k \
                   "f0:00:00:00:0$i:$j$k 192.168.$i$j.$k" $unknown
        done
    done
done

check ovn-nbctl lr-add lr0
for i in 1 2 3; do
    for j in 1 2 3; do
        check ovn-nbctl lrp-add lr0 lrp$i$j 00:00:00:00:ff:$i$j 192.168.$i$j.254/24
        check ovn-nbctl \
            -- lsp-add ls$i lrp$i$j-attachment \
            -- set Logical_Switch_Port lrp$i$j-attachment type=router \
                             options:router-port=lrp$i$j \
                             addresses='"00:00:00:00:ff:'$i$j'"'
    done
done

check ovn-nbctl set Logical_Switch_Port lrp33-attachment \
    addresses='"00:00:00:00:ff:33 192.168.33.254"'

# Physical network:
#
# Three hypervisors hv[123].
# lp?1[123] spread across hv[123]: lp?11 on hv1, lp?12 on hv2, lp?13 on hv3.
# lp?2[123] spread across hv[23]: lp?21 and lp?22 on hv2, lp?23 on hv3.
# lp?3[123] all on hv3.


# Given the name of a logical port, prints the name of the hypervisor
# on which it is located.
vif_to_hv() {
    case $1 in         ?11) echo 1 ;;         ?12 | ?21 | ?22) echo 2 ;;         ?13 | ?23 | ?3?) echo 3 ;;
    esac
}

# Given the name of a logical port, prints the name of its logical router
# port, e.g. "vif_to_lrp 123" yields 12.
vif_to_lrp() {
    echo ${1%?}
}

# Given the name of a logical port, prints the name of its logical
# switch, e.g. "vif_to_ls 123" yields 1.
vif_to_ls() {
    echo ${1%??}
}

net_add n1
for i in 1 2 3; do
    sim_add hv$i
    as hv$i
    ovs-vsctl add-br br-phys
    ovn_attach n1 br-phys 192.168.0.$i
done
for i in 1 2 3; do
    for j in 1 2 3; do
        for k in 1 2 3; do
            hv=`vif_to_hv $i$j$k`
                as hv$hv ovs-vsctl \
                -- add-port br-int vif$i$j$k \
                -- set Interface vif$i$j$k \
                    external-ids:iface-id=lp$i$j$k \
                    options:tx_pcap=hv$hv/vif$i$j$k-tx.pcap \
                    options:rxq_pcap=hv$hv/vif$i$j$k-rx.pcap \
                    ofport-request=$i$j$k
        done
    done
done

wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure
$at_traceon; }


ovn_wait_remote_output_flows ""hv1"" ""hv2"" "tests/ovn.at:4836"
ovn_wait_remote_output_flows ""hv2"" ""hv1"" "tests/ovn.at:4836"
ovn_wait_remote_output_flows ""hv2"" ""hv3"" "tests/ovn.at:4836"
ovn_wait_remote_output_flows ""hv3"" ""hv2"" "tests/ovn.at:4836"
ovn_wait_remote_output_flows ""hv1"" ""hv3"" "tests/ovn.at:4836"
ovn_wait_remote_output_flows ""hv3"" ""hv1"" "tests/ovn.at:4836"

# test_ip INPORT SRC_MAC DST_MAC SRC_IP DST_IP OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as logical switch port numbers, e.g. 123 for vif123.
for i in 1 2 3; do
    for j in 1 2 3; do
        for k in 1 2 3; do
            : > $i$j$k.expected
        done
    done
done
test_ip() {
    # This packet has bad checksums but logical L3 routing doesn't check.
    local inport=$1 src_mac=$2 dst_mac=$3 src_ip=$4 dst_ip=$5
    local packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                            IP(src='${src_ip}', dst='${dst_ip}', ttl=0x40)/ \
                            UDP(sport=53, dport=4369)")
    shift; shift; shift; shift; shift
    hv=hv`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $packet
    in_ls=`vif_to_ls $inport`
    in_lrp=`vif_to_lrp $inport`
    for outport; do
        out_ls=`vif_to_ls $outport`
        if test $in_ls = $out_ls; then
            # Ports on the same logical switch receive exactly the same packet.
            echo $packet
        else
            # Routing decrements TTL and updates source and dest MAC
            # (and checksum).
            out_lrp=`vif_to_lrp $outport`
            echo $(fmt_pkt "Ether(dst='f0:00:00:00:0$out_ls:${outport#?}', src='00:00:00:00:ff:${out_lrp}')/ \
                            IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3f)/ \
                            UDP(sport=53, dport=4369)")
        fi >> $outport.expected
    done
}

# test_arp INPORT SHA SPA TPA [REPLY_HA]
#
# Causes a packet to be received on INPORT.  The packet is an ARP
# request with SHA, SPA, and TPA as specified.  If REPLY_HA is provided, then
# it should be the hardware address of the target to expect to receive in an
# ARP reply; otherwise no reply is expected.
#
# INPORT is an logical switch port number, e.g. 11 for vif11.
# SHA and REPLY_HA are each 12 hex digits.
# SPA and TPA are each 8 hex digits.
test_arp() {
    echo "$@"
    local inport=$1 sha=$2 spa=$3 tpa=$4 reply_ha=$5
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                             ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
    hv=hv`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $request

    # Expect to receive the broadcast ARP on the other logical switch ports if
    # IP address is not configured to the switch patch port.
    local i=`vif_to_ls $inport`
    local j k
    for j in 1 2 3; do
        for k in 1 2 3; do
            # 192.168.33.254 is configured to the switch patch port for lrp33,
            # so no ARP flooding expected for it.
            if test $i$j$k != $inport && test $tpa != 192.168.33.254; then
                echo $request >> $i$j$k.expected
            fi
        done
    done

    # Expect to receive the reply, if any.
    if test X$reply_ha != X; then
        lrp=`vif_to_lrp $inport`
        local reply=$(fmt_pkt "Ether(dst='${sha}', src='00:00:00:00:ff:${lrp}')/ \
                               ARP(op=2, hwsrc='${reply_ha}', hwdst='${sha}', psrc='${tpa}', pdst='${spa}')")
        echo $reply >> $inport.expected
    fi
}

as hv1 ovs-vsctl --columns=name,ofport list interface > interfaces
(as hv1 ovn-sbctl list port_binding
 as hv1 ovn-sbctl list datapath_binding) > bindings
as hv1 ovn-sbctl dump-flows > sbflows
as hv1 ovs-ofctl dump-flows br-int > offlows





# Send IP packets between all pairs of source and destination ports:
#
# 1. Unicast IP packets are delivered to exactly one logical switch port
#    (except that packets destined to their input ports are dropped).
#
# 2. Broadcast IP packets are delivered to all logical switch ports
#    except the input port.
for is in 1 2 3; do
  for js in 1 2 3; do
    for ks in 1 2 3; do
      bcast=
      s=$is$js$ks
      smac=f0:00:00:00:0$is:$js$ks
      sip=192.168.$is$js.$ks
      for id in 1 2 3; do
          for jd in 1 2 3; do
              for kd in 1 2 3; do
                d=$id$jd$kd
                dip=192.168.$id$jd.$kd
                if test $is = $id; then dmac=f0:00:00:00:0$id:$jd$kd; else dmac=00:00:00:00:ff:$is$js; fi
                if test $d != $s; then unicast=$d; else unicast=; fi

                test_ip $s $smac $dmac $sip $dip $unicast #1

                if test $id = $is && test $d != $s; then bcast="$bcast $d"; fi
              done
          done
        done
      test_ip $s $smac ff:ff:ff:ff:ff:ff $sip 255.255.255.255 $bcast #2
      done
  done
  wait
done

: > mac_bindings.expected

# 3. Send an IP packet from every logical port to every other subnet,
#    to an IP address that does not have a static IP-MAC binding.
#    This should generate a broadcast ARP request for the destination
#    IP address in the destination subnet.
#    Moreover generate an ARP reply for each of the IP addresses ARPed
for is in 1 2 3; do
  for js in 1 2 3; do
    for ks in 1 2 3; do
      s=$is$js$ks
      smac=f0:00:00:00:0$is:$js$ks
      sip=192.168.$is$js.$ks
      for id in 1 2 3; do
        for jd in 1 2 3; do
          if test $is$js = $id$jd; then
            continue
          fi

          # Send the packet.
          dmac=00:00:00:00:ff:$is$js
          # Calculate a 4th octet for the destination that is
          # unique per $s, avoids the .1 .2 .3 and .254 IP addresses
          # that have static MAC bindings, and fits in the range
          # 0-255.
          o4=`expr $is '*' 9 + $js '*' 3 + $ks + 10`
          dip=192.168.$id$jd.$o4
          test_ip $s $smac $dmac $sip $dip

          # Every LP on the destination subnet's lswitch should
          # receive the ARP request.
          lrmac=00:00:00:00:ff:$id$jd
          lrip=192.168.$id$jd.254
          arp=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${lrmac}')/ \
                         ARP(hwsrc='${lrmac}', hwdst='00:00:00:00:00:00', psrc='${lrip}', pdst='${dip}')")
          for jd2 in 1 2 3; do
            for kd in 1 2 3; do
              echo $arp >> $id$jd2$kd.expected
            done
          done

          hmac=80:00:00:00:00:$o4
          rmac=00:00:00:00:ff:$id$jd
          echo $(fmt_pkt "Ether(dst='${hmac}', src='${rmac}')/ \
                          IP(src='${sip}', dst='${dip}', ttl=0x3f)/ \
                          UDP(sport=53, dport=4369)") >> ${id}11.expected

          host_mac=80:00:00:00:00:$o4
          lrmac=00:00:00:00:ff:$id$jd

          arp_reply=$(fmt_pkt "Ether(dst='${lrmac}', src='${host_mac}')/ \
                               ARP(op=2, hwsrc='${host_mac}', hwdst='${lrmac}', psrc='${dip}', pdst='${lrip}')")

          hv=hv`vif_to_hv ${id}${jd}1`
          as $hv ovs-appctl netdev-dummy/receive vif${id}${jd}1 $arp_reply

          echo lrp$id$jd,$dip,$hmac >> mac_bindings.expected
        done
      done
    done
  done
done

# Test router replies to ARP requests from all source ports:
#
# 4. Router replies to query for its MAC address from port's own IP address.
#
# 5. Router replies to query for its MAC address from any random IP address
#    in its subnet.
#
# 6. No reply to query for IP address other than router IP.
#
# 7. No reply to query from another subnet.
for i in 1 2 3; do
  for j in 1 2 3; do
    for k in 1 2 3; do
      smac=f0:00:00:00:0$i:$j$k               # Source MAC
      sip=192.168.$i$j.$k    # Source IP
      rip=192.168.$i$j.254   # Router IP
      rmac=00:00:00:00:ff:$i$j                # Router MAC
      otherip=192.168.$i$j.55 # Some other IP in subnet
      externalip=1.2.3.4      # Some other IP not in subnet

      test_arp $i$j$k $smac $sip        $rip        $rmac      #4
      test_arp $i$j$k $smac $otherip    $rip        $rmac      #5
      test_arp $i$j$k $smac $sip        $otherip               #6

      # When rip is 192.168.33.254, ARP request from externalip won't be
      # filtered, because 192.168.33.254 is configured to switch peer port
      # for lrp33.
      lrp33_rsp=
      if test $i = 3 && test $j = 3; then
        lrp33_rsp=$rmac
      fi
      test_arp $i$j$k $smac $externalip $rip        $lrp33_rsp #7

      # MAC binding should be learned from ARP request.
      echo lrp$i$j,$sip,$smac >> mac_bindings.expected

      # mac_binding is learned and overwritten so only the last one remains.
      if test $k = 3; then
          # lrp33 will not learn from ARP request, because 192.168.33.254 is
          # configured to switch peer port for lrp33.
          if test $i != 3 || test $j != 3; then
              echo lrp$i$j,$otherip,$smac >> mac_bindings.expected
          fi
      fi

    done
  done
done


# Allow some time for packet forwarding.
# XXX This can be improved.
sleep 1

# 8. Send an IP packet from every logical port to every other subnet.  These
#    are the same packets already sent as #3, but now the destinations' IP-MAC
#    bindings have been discovered via ARP, so instead of provoking an ARP
#    request, these packets now get routed to their destinations (which don't
#    have static MAC bindings, so they go to the port we've designated as
#    accepting "unknown" MACs.)
for is in 1 2 3; do
  for js in 1 2 3; do
    for ks in 1 2 3; do
      s=$is$js$ks
      smac=f0:00:00:00:0$is:$js$ks
      sip=192.168.$is$js.$ks
      for id in 1 2 3; do
        for jd in 1 2 3; do
          if test $is$js = $id$jd; then
            continue
          fi

          # Send the packet.
          dmac=00:00:00:00:ff:$is$js
          # Calculate a 4th octet for the destination that is
          # unique per $s, avoids the .1 .2 .3 and .254 IP addresses
          # that have static MAC bindings, and fits in the range
          # 0-255.
          o4=`expr $is '*' 9 + $js '*' 3 + $ks + 10`
          dip=192.168.$id$jd.$o4
          test_ip $s $smac $dmac $sip $dip

          # Expect the packet egress.
          host_mac=80:00:00:00:00:$o4
          outport=${id}11
          out_lrp=$id$jd
          echo $(fmt_pkt "Ether(dst='${host_mac}', src='00:00:00:00:ff:$id$jd')/ \
                          IP(src='${sip}', dst='${dip}', ttl=0x3f)/ \
                          UDP(sport=53, dport=4369)") >> $outport.expected
        done
      done
    done
  done
done

ovn-sbctl dump-flows > sbflows2




check_packets() {
    > expected
    > received
    for i in 1 2 3; do
        for j in 1 2 3; do
            for k in 1 2 3; do
                pcap=hv`vif_to_hv $i$j$k`/vif$i$j$k-tx.pcap
                echo "--- $pcap" | tee -a expected >> received
                sort $i$j$k.expected >> expected
                $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" $pcap | sort >> received
                echo | tee -a expected >> received
            done
        done
    done

    echo '--- MAC bindings' | tee -a expected >> received
    ovn-sbctl -f csv -d bare --no-heading \
        -- --columns=logical_port,ip,mac list mac_binding | sort >> received
    sort < mac_bindings.expected >> expected

    $at_diff expected received >/dev/null
}
check_ovs_wait_until_args "2" "$at_diff -F'^---' expected received"
   ovs_wait_cond () {
    check_packets
}
ovs_wait_failed () {
    :
    $at_diff -F'^---' expected received
}
ovs_wait "ovn.at:4836" "until check_packets"


# Gracefully terminate daemons


        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4836"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4836"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv3" |sed -n '1p')
        error=$(echo "hv3"  | grep '/')
        ignored_dp=$(echo "hv3"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv3"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv3" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4836"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4836"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4836"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4836"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4836"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv3" |sed -n '1p')
        error=$(echo "hv3"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:4836"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:4836"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:4836"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:4836: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:4836"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:4836"
$at_failed && at_fn_log_failure  \
"interfaces" \
"bindings" \
"sbflows" \
"offlows" \
"sbflows2" \
"expected" \
"received" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:4836" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_80
#AT_START_81
at_fn_group_banner 81 'ovn.at:5273' \
  "IP relocation using GARP request -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "81. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

printf "%s\n" "ovn.at:5273" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:5273"
ovn_start

# Logical network:
#
# Two logical switches ls1, ls2.
# One logical router lr0 connected to ls[12],
# with 2 subnets, 1 per logical switch:
#
#    lrp1 on ls1 for subnet 192.168.1.1/24
#    lrp2 on ls2 for subnet 192.168.2.1/24
#
# 4 VIFs, 2 per LS lp[12][12], first digit being LS.
# VIFs' fixed IP addresses are 192.168.[12].1[12].
#
# There is a secondary IP 192.168.1.100 that is unknown in NB and learned
# through ARP only, and it can move between lp11 and lp12.
#
check ovn-nbctl lr-add lr0
for i in 1 2 ; do
    check ovn-nbctl ls-add ls$i
    check ovn-nbctl lrp-add lr0 lrp$i 00:00:00:00:ff:0$i 192.168.$i.1/24
    check ovn-nbctl \
        -- lsp-add ls$i lrp$i-attachment \
        -- set Logical_Switch_Port lrp$i-attachment type=router \
                         options:router-port=lrp$i \
                         addresses=router
    for j in 1 2; do
        check ovn-nbctl \
            -- lsp-add ls$i lp$i$j \
            -- lsp-set-addresses lp$i$j \
               "f0:00:00:00:00:$i$j 192.168.$i.1$j"
    done
done

# Physical network:
# 2 hypervisors hv[12], lp?1 on hv1, lp?2 on hv2.

# Given the name of a logical port, prints the name of the hypervisor
# on which it is located, e.g. "vif_to_hv 12" yields 2.
vif_to_hv() {
    echo ${1#?}
}

# Given the name of a logical port, prints the name of its logical router
# port, e.g. "vif_to_lrp 12" yields 1.
vif_to_lrp() {
    echo ${1%?}
}

# Given the name of a logical port, prints the name of its logical
# switch, e.g. "vif_to_ls 12" yields 1.
vif_to_ls() {
    echo ${1%?}
}

net_add n1
for i in 1 2; do
    sim_add hv$i
    as hv$i
    ovs-vsctl add-br br-phys
    ovn_attach n1 br-phys 192.168.0.$i
done
for i in 1 2; do
    for j in 1 2; do
        hv=`vif_to_hv $i$j`
            as hv$hv ovs-vsctl \
                -- add-port br-int vif$i$j \
                -- set Interface vif$i$j \
                    external-ids:iface-id=lp$i$j \
                    options:tx_pcap=hv$hv/vif$i$j-tx.pcap \
                    options:rxq_pcap=hv$hv/vif$i$j-rx.pcap \
                    ofport-request=$i$j
    done
done

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure
$at_traceon; }


# Allow some time for ovn-northd and ovn-controller to catch up.
wait_for_ports_up
check ovn-nbctl --wait=hv sync

# test_ip INPORT SRC_MAC DST_MAC SRC_IP DST_IP OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as logical switch port numbers, e.g. 12 for vif12.
for i in 1 2; do
    for j in 1 2; do
        : > $i$j.expected
    done
done
test_ip() {
    # This packet has bad checksums but logical L3 routing doesn't check.
    local inport=$1 src_mac=$2 dst_mac=$3 src_ip=$4 dst_ip=$5
    local packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                            IP(dst='${dst_ip}', src='${src_ip}')/ \
                            UDP(sport=53, dport=4369)")
    shift; shift; shift; shift; shift
    hv=hv`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $packet
    in_ls=`vif_to_ls $inport`
    in_lrp=`vif_to_lrp $inport`
    for outport; do
        out_ls=`vif_to_ls $outport`
        if test $in_ls = $out_ls; then
            # Ports on the same logical switch receive exactly the same packet.
            echo $packet
        else
            # Routing decrements TTL and updates source and dest MAC
            # (and checksum).
            out_lrp=`vif_to_lrp $outport`
            echo $(fmt_pkt "Ether(dst='f0:00:00:00:00:${outport}', src='00:00:00:00:ff:${out_lrp}')/ \
                            IP(src='${src_ip}', dst='${dst_ip}', ttl=63)/ \
                            UDP(sport=53, dport=4369)")
        fi >> $outport.expected
    done
}

# test_arp INPORT SHA SPA TPA [REPLY_HA]
#
# Causes a packet to be received on INPORT.  The packet is an ARP
# request with SHA, SPA, and TPA as specified.  If REPLY_HA is provided, then
# it should be the hardware address of the target to expect to receive in an
# ARP reply; otherwise no reply is expected.
#
# INPORT is an logical switch port number, e.g. 11 for vif11.
# SHA and REPLY_HA are each 12 hex digits.
# SPA and TPA are each 8 hex digits.
test_arp() {
    local inport=$1 sha=$2 spa=$3 tpa=$3
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                             ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")

    hv=hv`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $request

    # Expect to receive the broadcast ARP on the other logical switch ports if
    # IP address is not configured to the switch patch port.
    local i=`vif_to_ls $inport`
    local j
    for j in 1 2; do
        if test $i$j != $inport; then
            echo $request >> $i$j$k.expected
        fi
    done
}

test_na() {
    local inport=$1 sha=$2 spa=$3 src=${4-$3}
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                             IPv6(dst='ff01::1', src='${src}')/ \
                             ICMPv6ND_NA(tgt='${spa}')/ \
                             ICMPv6NDOptDstLLAddr(lladdr='${sha}')")

    hv=hv`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $request

    # Expect to receive the broadcast ARP on the other logical switch ports if
    # IP address is not configured to the switch patch port.
    local i=`vif_to_ls $inport`
    local j
    for j in 1 2; do
        if test $i$j != $inport; then
            echo $request >> $i$j$k.expected
        fi
    done
}

# lp11 send GARP request to announce ownership of 192.168.1.100 and fe80::abcd:1.

sha="f0:00:00:00:00:11"
spa="192.168.1.100"
spa6="fe80::abcd:1"

# When always_learn_from_arp_request=false, the new mac-binding will not be learned
# through GARP request.
check ovn-nbctl --wait=hv set logical_router lr0 options:always_learn_from_arp_request=false

test_arp 11 $sha $spa
test_na 11 $sha $spa6
sleep 1
check_row_count MAC_Binding 0 ip="$spa"
check_row_count MAC_Binding 0 ip=\"$spa6\"

# When always_learn_from_arp_request=true, the new mac-binding will be learned.
check ovn-nbctl --wait=hv set logical_router lr0 options:always_learn_from_arp_request=true

test_arp 11 $sha $spa
test_na 11 $sha $spa6
wait_row_count MAC_Binding 1 ip="$spa" mac=\"$sha\"
wait_row_count MAC_Binding 1 ip=\"$spa6\" mac=\"$sha\"
check ovn-nbctl --wait=hv sync

# Send an IP packet from lp21 to 192.168.1.100, which should go to lp11.

smac="f0:00:00:00:00:21"
dmac="00:00:00:00:ff:02"
sip="192.168.2.11"
dip="192.168.1.100"
test_ip 21 $smac $dmac $sip $dip 11

# lp12 send GARP request to announce ownership of 192.168.1.100 and fe80::abcd:1.

# Even when always_learn_from_arp_request=false, the existing mac-binding should be
# updated through GARP request.
check ovn-nbctl --wait=hv set logical_router lr0 options:always_learn_from_arp_request=false

sha="f0:00:00:00:00:12"
test_arp 12 $sha $spa
test_na 11 $sha $spa6
wait_row_count MAC_Binding 1 ip="$spa" mac=\"$sha\"
wait_row_count MAC_Binding 1 ip=\"$spa6\" mac=\"$sha\"
check ovn-nbctl --wait=hv sync
# give to the hv the time to send queued ip packets
sleep 1

# Send an IP packet from lp21 to 192.168.1.100, which should go to lp12.

test_ip 21 $smac $dmac $sip $dip 12

# Now check the packets actually received against the ones expected.
for i in 1 2; do
    for j in 1 2; do
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv\`vif_to_hv \$i\$j\`/vif\$i\$j-tx.pcap "
at_fn_check_prepare_notrace 'a `...` command substitution' "ovn.at:5273"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv`vif_to_hv $i$j`/vif$i$j-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv`vif_to_hv $i$j`/vif$i$j-tx.pcap" "$i$j.expected" "tests/ovn.at:5273"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:5273"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
if $at_failed
then :
  dump_diff__ "hv`vif_to_hv $i$j`/vif$i$j-tx.pcap" "$i$j.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

    done
done

# Make sure that we can update existing entry with
# "always_learn_from_arp_request=false" even when the source of NA src is LLA.
check ovn-sbctl --all destroy mac_binding
check ovn-nbctl --wait=hv set logical_router lr0 options:always_learn_from_arp_request=false

sha="f0:00:00:00:00:11"
spa6="fd00::abcd:1"

test_na 11 $sha $spa6
wait_row_count MAC_Binding 1 ip=\"$spa6\" mac=\"$sha\"

sha="f0:00:00:00:00:12"
lla6="fe80::abcd:1"

test_na 11 $sha $spa6 $lla6
wait_row_count MAC_Binding 1 ip=\"$spa6\" mac=\"$sha\"
check_row_count MAC_Binding 0 ip=\"$lla6\"

# Gracefully terminate daemons


        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5273"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5273"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5273"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5273"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5273"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5273"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_81
#AT_START_82
at_fn_group_banner 82 'ovn.at:5273' \
  "IP relocation using GARP request -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "82. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

printf "%s\n" "ovn.at:5273" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:5273"
ovn_start

# Logical network:
#
# Two logical switches ls1, ls2.
# One logical router lr0 connected to ls[12],
# with 2 subnets, 1 per logical switch:
#
#    lrp1 on ls1 for subnet 192.168.1.1/24
#    lrp2 on ls2 for subnet 192.168.2.1/24
#
# 4 VIFs, 2 per LS lp[12][12], first digit being LS.
# VIFs' fixed IP addresses are 192.168.[12].1[12].
#
# There is a secondary IP 192.168.1.100 that is unknown in NB and learned
# through ARP only, and it can move between lp11 and lp12.
#
check ovn-nbctl lr-add lr0
for i in 1 2 ; do
    check ovn-nbctl ls-add ls$i
    check ovn-nbctl lrp-add lr0 lrp$i 00:00:00:00:ff:0$i 192.168.$i.1/24
    check ovn-nbctl \
        -- lsp-add ls$i lrp$i-attachment \
        -- set Logical_Switch_Port lrp$i-attachment type=router \
                         options:router-port=lrp$i \
                         addresses=router
    for j in 1 2; do
        check ovn-nbctl \
            -- lsp-add ls$i lp$i$j \
            -- lsp-set-addresses lp$i$j \
               "f0:00:00:00:00:$i$j 192.168.$i.1$j"
    done
done

# Physical network:
# 2 hypervisors hv[12], lp?1 on hv1, lp?2 on hv2.

# Given the name of a logical port, prints the name of the hypervisor
# on which it is located, e.g. "vif_to_hv 12" yields 2.
vif_to_hv() {
    echo ${1#?}
}

# Given the name of a logical port, prints the name of its logical router
# port, e.g. "vif_to_lrp 12" yields 1.
vif_to_lrp() {
    echo ${1%?}
}

# Given the name of a logical port, prints the name of its logical
# switch, e.g. "vif_to_ls 12" yields 1.
vif_to_ls() {
    echo ${1%?}
}

net_add n1
for i in 1 2; do
    sim_add hv$i
    as hv$i
    ovs-vsctl add-br br-phys
    ovn_attach n1 br-phys 192.168.0.$i
done
for i in 1 2; do
    for j in 1 2; do
        hv=`vif_to_hv $i$j`
            as hv$hv ovs-vsctl \
                -- add-port br-int vif$i$j \
                -- set Interface vif$i$j \
                    external-ids:iface-id=lp$i$j \
                    options:tx_pcap=hv$hv/vif$i$j-tx.pcap \
                    options:rxq_pcap=hv$hv/vif$i$j-rx.pcap \
                    ofport-request=$i$j
    done
done

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure
$at_traceon; }


# Allow some time for ovn-northd and ovn-controller to catch up.
wait_for_ports_up
check ovn-nbctl --wait=hv sync

# test_ip INPORT SRC_MAC DST_MAC SRC_IP DST_IP OUTPORT...
#
# This shell function causes a packet to be received on INPORT.  The packet's
# content has Ethernet destination DST and source SRC (each exactly 12 hex
# digits) and Ethernet type ETHTYPE (4 hex digits).  The OUTPORTs (zero or
# more) list the VIFs on which the packet should be received.  INPORT and the
# OUTPORTs are specified as logical switch port numbers, e.g. 12 for vif12.
for i in 1 2; do
    for j in 1 2; do
        : > $i$j.expected
    done
done
test_ip() {
    # This packet has bad checksums but logical L3 routing doesn't check.
    local inport=$1 src_mac=$2 dst_mac=$3 src_ip=$4 dst_ip=$5
    local packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                            IP(dst='${dst_ip}', src='${src_ip}')/ \
                            UDP(sport=53, dport=4369)")
    shift; shift; shift; shift; shift
    hv=hv`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $packet
    in_ls=`vif_to_ls $inport`
    in_lrp=`vif_to_lrp $inport`
    for outport; do
        out_ls=`vif_to_ls $outport`
        if test $in_ls = $out_ls; then
            # Ports on the same logical switch receive exactly the same packet.
            echo $packet
        else
            # Routing decrements TTL and updates source and dest MAC
            # (and checksum).
            out_lrp=`vif_to_lrp $outport`
            echo $(fmt_pkt "Ether(dst='f0:00:00:00:00:${outport}', src='00:00:00:00:ff:${out_lrp}')/ \
                            IP(src='${src_ip}', dst='${dst_ip}', ttl=63)/ \
                            UDP(sport=53, dport=4369)")
        fi >> $outport.expected
    done
}

# test_arp INPORT SHA SPA TPA [REPLY_HA]
#
# Causes a packet to be received on INPORT.  The packet is an ARP
# request with SHA, SPA, and TPA as specified.  If REPLY_HA is provided, then
# it should be the hardware address of the target to expect to receive in an
# ARP reply; otherwise no reply is expected.
#
# INPORT is an logical switch port number, e.g. 11 for vif11.
# SHA and REPLY_HA are each 12 hex digits.
# SPA and TPA are each 8 hex digits.
test_arp() {
    local inport=$1 sha=$2 spa=$3 tpa=$3
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                             ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")

    hv=hv`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $request

    # Expect to receive the broadcast ARP on the other logical switch ports if
    # IP address is not configured to the switch patch port.
    local i=`vif_to_ls $inport`
    local j
    for j in 1 2; do
        if test $i$j != $inport; then
            echo $request >> $i$j$k.expected
        fi
    done
}

test_na() {
    local inport=$1 sha=$2 spa=$3 src=${4-$3}
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${sha}')/ \
                             IPv6(dst='ff01::1', src='${src}')/ \
                             ICMPv6ND_NA(tgt='${spa}')/ \
                             ICMPv6NDOptDstLLAddr(lladdr='${sha}')")

    hv=hv`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $request

    # Expect to receive the broadcast ARP on the other logical switch ports if
    # IP address is not configured to the switch patch port.
    local i=`vif_to_ls $inport`
    local j
    for j in 1 2; do
        if test $i$j != $inport; then
            echo $request >> $i$j$k.expected
        fi
    done
}

# lp11 send GARP request to announce ownership of 192.168.1.100 and fe80::abcd:1.

sha="f0:00:00:00:00:11"
spa="192.168.1.100"
spa6="fe80::abcd:1"

# When always_learn_from_arp_request=false, the new mac-binding will not be learned
# through GARP request.
check ovn-nbctl --wait=hv set logical_router lr0 options:always_learn_from_arp_request=false

test_arp 11 $sha $spa
test_na 11 $sha $spa6
sleep 1
check_row_count MAC_Binding 0 ip="$spa"
check_row_count MAC_Binding 0 ip=\"$spa6\"

# When always_learn_from_arp_request=true, the new mac-binding will be learned.
check ovn-nbctl --wait=hv set logical_router lr0 options:always_learn_from_arp_request=true

test_arp 11 $sha $spa
test_na 11 $sha $spa6
wait_row_count MAC_Binding 1 ip="$spa" mac=\"$sha\"
wait_row_count MAC_Binding 1 ip=\"$spa6\" mac=\"$sha\"
check ovn-nbctl --wait=hv sync

# Send an IP packet from lp21 to 192.168.1.100, which should go to lp11.

smac="f0:00:00:00:00:21"
dmac="00:00:00:00:ff:02"
sip="192.168.2.11"
dip="192.168.1.100"
test_ip 21 $smac $dmac $sip $dip 11

# lp12 send GARP request to announce ownership of 192.168.1.100 and fe80::abcd:1.

# Even when always_learn_from_arp_request=false, the existing mac-binding should be
# updated through GARP request.
check ovn-nbctl --wait=hv set logical_router lr0 options:always_learn_from_arp_request=false

sha="f0:00:00:00:00:12"
test_arp 12 $sha $spa
test_na 11 $sha $spa6
wait_row_count MAC_Binding 1 ip="$spa" mac=\"$sha\"
wait_row_count MAC_Binding 1 ip=\"$spa6\" mac=\"$sha\"
check ovn-nbctl --wait=hv sync
# give to the hv the time to send queued ip packets
sleep 1

# Send an IP packet from lp21 to 192.168.1.100, which should go to lp12.

test_ip 21 $smac $dmac $sip $dip 12

# Now check the packets actually received against the ones expected.
for i in 1 2; do
    for j in 1 2; do
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv\`vif_to_hv \$i\$j\`/vif\$i\$j-tx.pcap "
at_fn_check_prepare_notrace 'a `...` command substitution' "ovn.at:5273"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv`vif_to_hv $i$j`/vif$i$j-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv`vif_to_hv $i$j`/vif$i$j-tx.pcap" "$i$j.expected" "tests/ovn.at:5273"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:5273"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
if $at_failed
then :
  dump_diff__ "hv`vif_to_hv $i$j`/vif$i$j-tx.pcap" "$i$j.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

    done
done

# Make sure that we can update existing entry with
# "always_learn_from_arp_request=false" even when the source of NA src is LLA.
check ovn-sbctl --all destroy mac_binding
check ovn-nbctl --wait=hv set logical_router lr0 options:always_learn_from_arp_request=false

sha="f0:00:00:00:00:11"
spa6="fd00::abcd:1"

test_na 11 $sha $spa6
wait_row_count MAC_Binding 1 ip=\"$spa6\" mac=\"$sha\"

sha="f0:00:00:00:00:12"
lla6="fe80::abcd:1"

test_na 11 $sha $spa6 $lla6
wait_row_count MAC_Binding 1 ip=\"$spa6\" mac=\"$sha\"
check_row_count MAC_Binding 0 ip=\"$lla6\"

# Gracefully terminate daemons


        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5273"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5273"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5273"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5273"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5273"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5273"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5273"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5273: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5273"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5273"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5273" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_82
#AT_START_83
at_fn_group_banner 83 'ovn.at:5534' \
  "portsecurity : 3 HVs, 1 LS, 3 lports/HV -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "83. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

printf "%s\n" "ovn.at:5534" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:5534"
ovn_start

# Create hypervisors hv[123].
# Add vif1[123] to hv1, vif2[123] to hv2, vif3[123] to hv3.
# Add all of the vifs to a single logical switch lsw0.
# Turn off port security on vifs vif[123]1
# Turn on l2 port security on vifs vif[123]2
# Turn of l2 and l3 port security on vifs vif[123]3
# Make vif13, vif2[23], vif3[123] destinations for unknown MACs.
check ovn-nbctl ls-add lsw0
net_add n1
for i in 1 2 3; do
    sim_add hv$i
    as hv$i
    ovs-vsctl add-br br-phys
    ovn_attach n1 br-phys 192.168.0.$i
    for j in 1 2 3; do
        ovs-vsctl add-port br-int vif$i$j -- set Interface vif$i$j external-ids:iface-id=lp$i$j options:tx_pcap=hv$i/vif$i$j-tx.pcap options:rxq_pcap=hv$i/vif$i$j-rx.pcap ofport-request=$i$j
        check ovn-nbctl lsp-add lsw0 lp$i$j
        if test $j = 1; then
            check ovn-nbctl lsp-set-addresses lp$i$j "f0:00:00:00:00:$i$j 192.168.0.$i$j" unknown
        elif test $j = 2; then
            check ovn-nbctl lsp-set-addresses lp$i$j "f0:00:00:00:00:$i$j 192.168.0.$i$j 4343::00$i$j"
            check ovn-nbctl lsp-set-port-security lp$i$j f0:00:00:00:00:$i$j
        else
            extra_addr="f0:00:00:00:0$i:$i$j fe80::ea2a:eaff:fe28:$i$j 4242::00$i$j"
            check ovn-nbctl lsp-set-addresses lp$i$j "f0:00:00:00:00:$i$j 192.168.0.$i$j" "$extra_addr"
            check ovn-nbctl lsp-set-port-security lp$i$j "f0:00:00:00:00:$i$j 192.168.0.$i$j" "$extra_addr"
        fi
        check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lp$i$j` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "until test x\`ovn-nbctl lsp-get-up lp\$i\$j\` = xup"

    done
done

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure
$at_traceon; }


# Allow some time for ovn-northd and ovn-controller to catch up.
wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Given the name of a logical port, prints the name of the hypervisor
# on which it is located.
vif_to_hv() {
    echo hv${1%?}
}

for i in 1 2 3; do
    for j in 1 2 3; do
        : > $i$j.expected
    done
done

# test_ip INPORT SRC_MAC DST_MAC SRC_IP DST_IP OUTPORT...
#
# This shell function causes an ip packet to be received on INPORT.
# The packet's content has Ethernet destination DST and source SRC
# (each exactly 12 hex digits) and Ethernet type ETHTYPE (4 hex digits).
# The OUTPORTs (zero or more) list the VIFs on which the packet should
# be received.  INPORT and the OUTPORTs are specified as logical switch
# port numbers, e.g. 11 for vif11.
test_ip() {
    local inport=$1 src_mac=$2 dst_mac=$3 src_ip=$4 dst_ip=$5
    local packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                            IP(src='${src_ip}', dst='${dst_ip}')/ \
                            UDP(sport=53, dport=4369)")
    shift; shift; shift; shift; shift
    hv=`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# test_arp INPORT SHA SPA TPA DROP [REPLY_HA]
#
# Causes a packet to be received on INPORT.  The packet is an ARP
# request with SHA, SPA, and TPA as specified.  If REPLY_HA is provided, then
# it should be the hardware address of the target to expect to receive in an
# ARP reply; otherwise no reply is expected.
#
# INPORT is an logical switch port number, e.g. 11 for vif11.
# SHA and REPLY_HA are each 12 hex digits.
# SPA and TPA are each 8 hex digits.
test_arp() {
    local inport=$1 smac=$2 sha=$3 spa=$4 tpa=$5 drop=$6 reply_ha=$7
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${smac}')/ \
                             ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
    hv=`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $request
    if test $drop != 1; then
        if test X$reply_ha = X; then
            # Expect to receive the broadcast ARP on the other logical switch ports
            # if no reply is expected.
            local i j
            for i in 1 2 3; do
                for j in 1 2 3; do
                    if test $i$j != $inport; then
                        echo $request >> $i$j.expected
                    fi
                done
            done
        else
            # Expect to receive the reply, if any.
            local reply=$(fmt_pkt "Ether(dst='${smac}', src='${reply_ha}')/ \
                                   ARP(op=2, hwsrc='${reply_ha}', hwdst='${sha}', psrc='${tpa}', pdst='${spa}')")
            echo $reply >> $inport.expected
        fi
    fi
}

# test_ipv6 INPORT SRC_MAC DST_MAC SRC_IP DST_IP OUTPORT...
# This function is similar to test_ip() except that it sends
# ipv6 packet
test_ipv6() {
    local inport=$1 src_mac=$2 dst_mac=$3 src_ip=$4 dst_ip=$5
    local packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                            IPv6(src='${src_ip}', dst='${dst_ip}')")
    shift; shift; shift; shift; shift
    hv=`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# test_icmpv6 INPORT  SRC_MAC DST_MAC SRC_IP DST_IP ICMPV6 OUTPORT...
# This function is similar to test_ipv6() except it specifies the ICMPv6 sub-packet
# of the test packet
test_icmpv6() {
    local inport=$1 src_mac=$2 dst_mac=$3 src_ip=$4 dst_ip=$5 icmpv6=$6
    local packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                            IPv6(src='${src_ip}', dst='${dst_ip}')/ \
                            ${icmpv6}")
    shift; shift; shift; shift; shift; shift
    hv=`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# no port security
sip=192.168.0.12
tip=192.168.0.13
# the arp packet should be allowed even if lp[123]1 is
# not configured with mac f0:00:00:00:00:23 and ip 192.168.0.12
for i in 1 2 3; do
    test_arp ${i}1 f0:00:00:00:00:23 f0:00:00:00:00:23 $sip $tip 0 f0:00:00:00:00:13
    for j in 1 2 3; do
        if test $i != $j; then
            test_ip ${i}1 f0:00:00:00:00:${i}1 f0:00:00:00:00:${j}1 $sip $tip ${j}1
        fi
    done
done

# l2 port security
sip=192.168.0.12
tip=192.168.0.13

# arp packet should be allowed since lp22 is configured with
# mac f0:00:00:00:00:22
test_arp 22 f0:00:00:00:00:22 f0:00:00:00:00:22 $sip $tip 0 f0:00:00:00:00:13

# arp packet should not be allowed since lp32 is not configured with
# mac f0:00:00:00:00:21
test_arp 32 f0:00:00:00:00:21 f0:00:00:00:00:21 $sip $tip 1

# arp packet with sha set to f0:00:00:00:00:21 should not be allowed
# for lp12
test_arp 12 f0:00:00:00:00:12 f0:00:00:00:00:21 $sip $tip 1

# ip packets should be allowed and received since lp[123]2 do not
# have l3 port security
sip=192.168.0.55
tip=192.168.0.66
for i in 1 2 3; do
    for j in 1 2 3; do
        if test $i != $j; then
            test_ip ${i}2 f0:00:00:00:00:${i}2 f0:00:00:00:00:${j}2 $sip $tip ${j}2
        fi
    done
done

# ipv6 packets should be received by lp[123]2
# lp[123]1 can send ipv6 traffic as there is no port security
sip=fe80::
tip=ff02::

for i in 1 2 3; do
    test_ipv6 ${i}1 f0:00:00:00:00:${i}1 f0:00:00:00:00:${i}2 $sip $tip ${i}2
done


# l2 and l3 port security
sip=192.168.0.13
tip=192.168.0.22
# arp packet should be allowed since lp13 is configured with
# f0:00:00:00:00:13 and 192.168.0.13
test_arp 13 f0:00:00:00:00:13 f0:00:00:00:00:13 $sip $tip 0 f0:00:00:00:00:22

# the arp packet should be dropped because lp23 is not configured
# with mac f0:00:00:00:00:22
sip=192.168.0.13
tip=192.168.0.22
test_arp 23 f0:00:00:00:00:22 f0:00:00:00:00:22 $sip $tip 1

# the arp packet should be dropped because lp33 is not configured
# with ip 192.168.0.55
spa=192.168.0.55
tpa=192.168.0.22
test_arp 33 f0:00:00:00:00:31 f0:00:00:00:00:31 $spa $tpa 1

# ip packets should not be received by lp[123]3 since
# l3 port security is enabled
sip=192.168.0.55
tip=192.168.0.66
for i in 1 2 3; do
    for j in 1 2 3; do
        test_ip ${i}2 f0:00:00:00:00:${i}2 f0:00:00:00:00:${j}3 $sip $tip
    done
done

# ipv6 packets should be dropped for lp[123]3 since
# it is configured with only ipv4 address
sip=fe80::
tip=ff02::

for i in 1 2 3; do
    test_ipv6 ${i}3 f0:00:00:00:00:${i}3 f0:00:00:00:00:22 $sip $tip
done

# ipv6 packets should not be received by lp[123]3 with mac f0:00:00:00:00:$[123]3
# lp[123]1 can send ipv6 traffic as there is no port security
for i in 1 2 3; do
    test_ipv6 ${i}1 f0:00:00:00:00:${i}1 f0:00:00:00:00:${i}3 $sip $tip
done

# lp13 has extra port security with mac f0000000113 and ipv6 addr
# fe80::ea2a:eaff:fe28:0012 and 4242::0013

# ipv4 packet should be dropped for lp13 with mac f0000000113
sip=192.168.0.13
tip=192.168.0.23
test_ip 13 f0:00:00:00:01:13 f0:00:00:00:00:23 $sip $tip

# ipv6 packet should be received by lp[123]3 with mac f0:00:00:00:0${i}:${i}3
# and ip6.dst as fe80::ea2a:eaff:fe28:0${i}${i}3.
# lp11 can send ipv6 traffic as there is no port security
sip=ee80::
for i in 1 2 3; do
    tip=fe80::ea2a:eaff:fe28:00${i}3
    test_ipv6 11 f0:00:00:00:00:11 f0:00:00:00:0${i}:${i}3 $sip $tip ${i}3
    tip=4242::${i}3
    test_ipv6 11 f0:00:00:00:00:11 f0:00:00:00:0${i}:${i}3 $sip $tip ${i}3
done


# ipv6 packet should not be received by lp33 with mac f0:00:00:00:03:33
# and ip6.dst as fe80::ea2a:eaff:fe28:0023 or 4242::0023 as it is
# configured with fe80::ea2a:eaff:fe28:0033 and 4242::0033
# lp11 can send ipv6 traffic as there is no port security

sip=ee80::
tip=fe80::ea2a:eaff:fe28:0023
test_ipv6 11 f0:00:00:00:00:11 f0:00:00:00:03:33 $sip $tip
tip=4242::23
test_ipv6 11 f0:00:00:00:00:11 f0:00:00:00:03:33 $sip $tip

# ipv6 packet should be allowed for lp[123]3 with mac f0:00:00:00:0${i}:${i}3
# and ip6.src fe80::ea2a:eaff:fe28:0${i}${i}3, 4242::00${i}3 and ip6.src ::.
# and should be dropped for any other ip6.src
# lp21 can receive ipv6 traffic as there is no port security

tip=ee80::
for i in 1 2 3; do
    sip=fe80::ea2a:eaff:fe28:00${i}3
    test_ipv6 ${i}3 f0:00:00:00:0${i}:${i}3 f0:00:00:00:00:21 $sip $tip 21
    sip=4242::${i}3
    test_ipv6 ${i}3 f0:00:00:00:0${i}:${i}3 f0:00:00:00:00:21 $sip $tip 21

    # Test ICMPv6 MLD reports (v1 and v2) and NS for DAD
    sip=::
    # Multicast traffic is delivered to all ports, except for the source.
    out_ports=
    for j in 1 2 3; do
        for k in 1 2 3; do
            if test "${j}${k}" -eq "${i}3"; then
                continue
            else
                out_ports="$out_ports ${j}${k}"
            fi
        done
    done
    test_icmpv6 ${i}3 f0:00:00:00:0${i}:${i}3 33:33:00:16:00:00 $sip ff02::16:0 "ICMPv6MLReport()" ${out_ports}
    test_icmpv6 ${i}3 f0:00:00:00:0${i}:${i}3 33:33:00:16:00:00 $sip ff02::16:0 "ICMPv6MLReport2()" ${out_ports}
    test_icmpv6 ${i}3 f0:00:00:00:0${i}:${i}3 33:33:ff:fe:28:00 $sip ff02::ea:2aea:fffe:2800 "ICMPv6ND_NS()" ${out_ports}
    # Traffic to non-multicast traffic should be dropped
    test_icmpv6 ${i}3 f0:00:00:00:0${i}:${i}3 f0:00:00:00:00:21 $sip $tip "ICMPv6MLReport()"
    # Traffic of other ICMPv6 types should be dropped
    test_icmpv6 ${i}3 f0:00:00:00:0${i}:${i}3 33:33:00:16:00:00 $sip ff02::16:0 "ICMPv6EchoRequest()"

    # should be dropped
    sip=ae80::ea2a:eaff:fe28:00aa
    test_ipv6 ${i}3 f0:00:00:00:0${i}:${i}3 f0:00:00:00:00:21 $sip $tip
done

# configure lsp13 to send and received IPv4 packets with an address range
check ovn-nbctl --wait=hv lsp-set-port-security lp13 "f0:00:00:00:00:13 192.168.0.13 20.0.0.4/24 10.0.0.0/24 4242::/64"

sip=10.0.0.13
tip=192.168.0.22
# arp packet with inner ip 10.0.0.13 should be allowed for lsp13
test_arp 13 f0:00:00:00:00:13 f0:00:00:00:00:13 $sip $tip 0 f0:00:00:00:00:22

sip=10.0.0.14
tip=192.168.0.23
# IPv4 packet from lsp13 with src ip 10.0.0.14 destined to lsp23
# with dst ip 192.168.0.23 should be allowed
test_ip 13 f0:00:00:00:00:13 f0:00:00:00:00:23 $sip $tip 23

sip=4242::14
tip=4242::23
# IPv6 packet from lsp13 with src ip 4242::14 destined to lsp23
# with dst ip 4242::23 should be received by lsp23
test_ipv6 13 f0:00:00:00:00:13 f0:00:00:00:02:23 $sip $tip 23

sip=192.168.0.33
tip=10.0.0.15
# IPv4 packet from lsp33 with src ip 192.168.0.33 destined to lsp13
# with dst ip 10.0.0.15 should be received by lsp13
test_ip 33 f0:00:00:00:00:33 f0:00:00:00:00:13 $sip $tip 13

sip=4242::33
tip=4242::13
# IPv6 packet from lsp33 with src ip 4242::33 destined to lsp13
# with dst ip 4242::13 should be received by lsp13
test_ipv6 33 f0:00:00:00:03:33 f0:00:00:00:00:13 $sip $tip 13

sip=192.168.0.33
tip=20.0.0.4
# IPv4 packet from lsp33 with src ip 192.168.0.33 destined to lsp13
# with dst ip 20.0.0.4 should be received by lsp13
test_ip 33 f0:00:00:00:00:33 f0:00:00:00:00:13 $sip $tip 13

sip=192.168.0.33
tip=20.0.0.5
# IPv4 packet from lsp33 with src ip 192.168.0.33 destined to lsp13
# with dst ip 20.0.0.5 should not be received by lsp13
test_ip 33 f0:00:00:00:00:33 f0:00:00:00:00:13 $sip $tip

sip=4242::33
tip=4242::5
# IPv6 packet from lsp33 with src ip 4242::33 destined to lsp13
# with dst ip 4242::5 should not be received by lsp13
test_ipv6 33 f0:00:00:00:03:33 f0:00:00:00:00:13 $sip $tip 13

sip=192.168.0.33
tip=20.0.0.255
# IPv4 packet from lsp33 with src ip 192.168.0.33 destined to lsp13
# with dst ip 20.0.0.255 should be received by lsp13
test_ip 33 f0:00:00:00:00:33 f0:00:00:00:00:13 $sip $tip 13

sip=192.168.0.33
tip=192.168.0.255
# IPv4 packet from lsp33 with src ip 192.168.0.33 destined to lsp13
# with dst ip 192.168.0.255 should not be received by lsp13
test_ip 33 f0:00:00:00:00:33 f0:00:00:00:00:13 $sip $tip

sip=192.168.0.33
tip=224.0.0.4
# IPv4 packet from lsp33 with src ip 192.168.0.33 destined to lsp13
# with dst ip 224.0.0.4  should be received by lsp13
test_ip 33 f0:00:00:00:00:33 f0:00:00:00:00:13 $sip $tip 13

#dump information including flow counters
ovn-nbctl show
ovn-sbctl dump-flows -- list multicast_group > sbflows


echo "------ hv1 dump ------"
as hv1 ovs-vsctl show
as hv1 ovs-ofctl -O OpenFlow13 show br-int
as hv1 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv2 dump ------"
as hv2 ovs-vsctl show
as hv2 ovs-ofctl -O OpenFlow13 show br-int
as hv2 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv3 dump ------"
as hv3 ovs-vsctl show
as hv3 ovs-ofctl -O OpenFlow13 show br-int
as hv3 ovs-ofctl -O OpenFlow13 dump-flows br-int

# Now check the packets actually received against the ones expected.
for i in 1 2 3; do
    for j in 1 2 3; do
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv\$i/vif\$i\$j-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv$i/vif$i$j-tx.pcap " "ovn.at:5534"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv$i/vif$i$j-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected" "tests/ovn.at:5534"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:5534"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
if $at_failed
then :
  dump_diff__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

    done
done



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5534"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5534"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv3" |sed -n '1p')
        error=$(echo "hv3"  | grep '/')
        ignored_dp=$(echo "hv3"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv3"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv3" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5534"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5534"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5534"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5534"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5534"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv3" |sed -n '1p')
        error=$(echo "hv3"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5534"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5534"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_83
#AT_START_84
at_fn_group_banner 84 'ovn.at:5534' \
  "portsecurity : 3 HVs, 1 LS, 3 lports/HV -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "84. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

printf "%s\n" "ovn.at:5534" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:5534"
ovn_start

# Create hypervisors hv[123].
# Add vif1[123] to hv1, vif2[123] to hv2, vif3[123] to hv3.
# Add all of the vifs to a single logical switch lsw0.
# Turn off port security on vifs vif[123]1
# Turn on l2 port security on vifs vif[123]2
# Turn of l2 and l3 port security on vifs vif[123]3
# Make vif13, vif2[23], vif3[123] destinations for unknown MACs.
check ovn-nbctl ls-add lsw0
net_add n1
for i in 1 2 3; do
    sim_add hv$i
    as hv$i
    ovs-vsctl add-br br-phys
    ovn_attach n1 br-phys 192.168.0.$i
    for j in 1 2 3; do
        ovs-vsctl add-port br-int vif$i$j -- set Interface vif$i$j external-ids:iface-id=lp$i$j options:tx_pcap=hv$i/vif$i$j-tx.pcap options:rxq_pcap=hv$i/vif$i$j-rx.pcap ofport-request=$i$j
        check ovn-nbctl lsp-add lsw0 lp$i$j
        if test $j = 1; then
            check ovn-nbctl lsp-set-addresses lp$i$j "f0:00:00:00:00:$i$j 192.168.0.$i$j" unknown
        elif test $j = 2; then
            check ovn-nbctl lsp-set-addresses lp$i$j "f0:00:00:00:00:$i$j 192.168.0.$i$j 4343::00$i$j"
            check ovn-nbctl lsp-set-port-security lp$i$j f0:00:00:00:00:$i$j
        else
            extra_addr="f0:00:00:00:0$i:$i$j fe80::ea2a:eaff:fe28:$i$j 4242::00$i$j"
            check ovn-nbctl lsp-set-addresses lp$i$j "f0:00:00:00:00:$i$j 192.168.0.$i$j" "$extra_addr"
            check ovn-nbctl lsp-set-port-security lp$i$j "f0:00:00:00:00:$i$j 192.168.0.$i$j" "$extra_addr"
        fi
        check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test x`ovn-nbctl lsp-get-up lp$i$j` = xup
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "until test x\`ovn-nbctl lsp-get-up lp\$i\$j\` = xup"

    done
done

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure
$at_traceon; }


# Allow some time for ovn-northd and ovn-controller to catch up.
wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Given the name of a logical port, prints the name of the hypervisor
# on which it is located.
vif_to_hv() {
    echo hv${1%?}
}

for i in 1 2 3; do
    for j in 1 2 3; do
        : > $i$j.expected
    done
done

# test_ip INPORT SRC_MAC DST_MAC SRC_IP DST_IP OUTPORT...
#
# This shell function causes an ip packet to be received on INPORT.
# The packet's content has Ethernet destination DST and source SRC
# (each exactly 12 hex digits) and Ethernet type ETHTYPE (4 hex digits).
# The OUTPORTs (zero or more) list the VIFs on which the packet should
# be received.  INPORT and the OUTPORTs are specified as logical switch
# port numbers, e.g. 11 for vif11.
test_ip() {
    local inport=$1 src_mac=$2 dst_mac=$3 src_ip=$4 dst_ip=$5
    local packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                            IP(src='${src_ip}', dst='${dst_ip}')/ \
                            UDP(sport=53, dport=4369)")
    shift; shift; shift; shift; shift
    hv=`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# test_arp INPORT SHA SPA TPA DROP [REPLY_HA]
#
# Causes a packet to be received on INPORT.  The packet is an ARP
# request with SHA, SPA, and TPA as specified.  If REPLY_HA is provided, then
# it should be the hardware address of the target to expect to receive in an
# ARP reply; otherwise no reply is expected.
#
# INPORT is an logical switch port number, e.g. 11 for vif11.
# SHA and REPLY_HA are each 12 hex digits.
# SPA and TPA are each 8 hex digits.
test_arp() {
    local inport=$1 smac=$2 sha=$3 spa=$4 tpa=$5 drop=$6 reply_ha=$7
    local request=$(fmt_pkt "Ether(dst='ff:ff:ff:ff:ff:ff', src='${smac}')/ \
                             ARP(hwsrc='${sha}', hwdst='ff:ff:ff:ff:ff:ff', psrc='${spa}', pdst='${tpa}')")
    hv=`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $request
    if test $drop != 1; then
        if test X$reply_ha = X; then
            # Expect to receive the broadcast ARP on the other logical switch ports
            # if no reply is expected.
            local i j
            for i in 1 2 3; do
                for j in 1 2 3; do
                    if test $i$j != $inport; then
                        echo $request >> $i$j.expected
                    fi
                done
            done
        else
            # Expect to receive the reply, if any.
            local reply=$(fmt_pkt "Ether(dst='${smac}', src='${reply_ha}')/ \
                                   ARP(op=2, hwsrc='${reply_ha}', hwdst='${sha}', psrc='${tpa}', pdst='${spa}')")
            echo $reply >> $inport.expected
        fi
    fi
}

# test_ipv6 INPORT SRC_MAC DST_MAC SRC_IP DST_IP OUTPORT...
# This function is similar to test_ip() except that it sends
# ipv6 packet
test_ipv6() {
    local inport=$1 src_mac=$2 dst_mac=$3 src_ip=$4 dst_ip=$5
    local packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                            IPv6(src='${src_ip}', dst='${dst_ip}')")
    shift; shift; shift; shift; shift
    hv=`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# test_icmpv6 INPORT  SRC_MAC DST_MAC SRC_IP DST_IP ICMPV6 OUTPORT...
# This function is similar to test_ipv6() except it specifies the ICMPv6 sub-packet
# of the test packet
test_icmpv6() {
    local inport=$1 src_mac=$2 dst_mac=$3 src_ip=$4 dst_ip=$5 icmpv6=$6
    local packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                            IPv6(src='${src_ip}', dst='${dst_ip}')/ \
                            ${icmpv6}")
    shift; shift; shift; shift; shift; shift
    hv=`vif_to_hv $inport`
    as $hv ovs-appctl netdev-dummy/receive vif$inport $packet
    for outport; do
        echo $packet >> $outport.expected
    done
}

# no port security
sip=192.168.0.12
tip=192.168.0.13
# the arp packet should be allowed even if lp[123]1 is
# not configured with mac f0:00:00:00:00:23 and ip 192.168.0.12
for i in 1 2 3; do
    test_arp ${i}1 f0:00:00:00:00:23 f0:00:00:00:00:23 $sip $tip 0 f0:00:00:00:00:13
    for j in 1 2 3; do
        if test $i != $j; then
            test_ip ${i}1 f0:00:00:00:00:${i}1 f0:00:00:00:00:${j}1 $sip $tip ${j}1
        fi
    done
done

# l2 port security
sip=192.168.0.12
tip=192.168.0.13

# arp packet should be allowed since lp22 is configured with
# mac f0:00:00:00:00:22
test_arp 22 f0:00:00:00:00:22 f0:00:00:00:00:22 $sip $tip 0 f0:00:00:00:00:13

# arp packet should not be allowed since lp32 is not configured with
# mac f0:00:00:00:00:21
test_arp 32 f0:00:00:00:00:21 f0:00:00:00:00:21 $sip $tip 1

# arp packet with sha set to f0:00:00:00:00:21 should not be allowed
# for lp12
test_arp 12 f0:00:00:00:00:12 f0:00:00:00:00:21 $sip $tip 1

# ip packets should be allowed and received since lp[123]2 do not
# have l3 port security
sip=192.168.0.55
tip=192.168.0.66
for i in 1 2 3; do
    for j in 1 2 3; do
        if test $i != $j; then
            test_ip ${i}2 f0:00:00:00:00:${i}2 f0:00:00:00:00:${j}2 $sip $tip ${j}2
        fi
    done
done

# ipv6 packets should be received by lp[123]2
# lp[123]1 can send ipv6 traffic as there is no port security
sip=fe80::
tip=ff02::

for i in 1 2 3; do
    test_ipv6 ${i}1 f0:00:00:00:00:${i}1 f0:00:00:00:00:${i}2 $sip $tip ${i}2
done


# l2 and l3 port security
sip=192.168.0.13
tip=192.168.0.22
# arp packet should be allowed since lp13 is configured with
# f0:00:00:00:00:13 and 192.168.0.13
test_arp 13 f0:00:00:00:00:13 f0:00:00:00:00:13 $sip $tip 0 f0:00:00:00:00:22

# the arp packet should be dropped because lp23 is not configured
# with mac f0:00:00:00:00:22
sip=192.168.0.13
tip=192.168.0.22
test_arp 23 f0:00:00:00:00:22 f0:00:00:00:00:22 $sip $tip 1

# the arp packet should be dropped because lp33 is not configured
# with ip 192.168.0.55
spa=192.168.0.55
tpa=192.168.0.22
test_arp 33 f0:00:00:00:00:31 f0:00:00:00:00:31 $spa $tpa 1

# ip packets should not be received by lp[123]3 since
# l3 port security is enabled
sip=192.168.0.55
tip=192.168.0.66
for i in 1 2 3; do
    for j in 1 2 3; do
        test_ip ${i}2 f0:00:00:00:00:${i}2 f0:00:00:00:00:${j}3 $sip $tip
    done
done

# ipv6 packets should be dropped for lp[123]3 since
# it is configured with only ipv4 address
sip=fe80::
tip=ff02::

for i in 1 2 3; do
    test_ipv6 ${i}3 f0:00:00:00:00:${i}3 f0:00:00:00:00:22 $sip $tip
done

# ipv6 packets should not be received by lp[123]3 with mac f0:00:00:00:00:$[123]3
# lp[123]1 can send ipv6 traffic as there is no port security
for i in 1 2 3; do
    test_ipv6 ${i}1 f0:00:00:00:00:${i}1 f0:00:00:00:00:${i}3 $sip $tip
done

# lp13 has extra port security with mac f0000000113 and ipv6 addr
# fe80::ea2a:eaff:fe28:0012 and 4242::0013

# ipv4 packet should be dropped for lp13 with mac f0000000113
sip=192.168.0.13
tip=192.168.0.23
test_ip 13 f0:00:00:00:01:13 f0:00:00:00:00:23 $sip $tip

# ipv6 packet should be received by lp[123]3 with mac f0:00:00:00:0${i}:${i}3
# and ip6.dst as fe80::ea2a:eaff:fe28:0${i}${i}3.
# lp11 can send ipv6 traffic as there is no port security
sip=ee80::
for i in 1 2 3; do
    tip=fe80::ea2a:eaff:fe28:00${i}3
    test_ipv6 11 f0:00:00:00:00:11 f0:00:00:00:0${i}:${i}3 $sip $tip ${i}3
    tip=4242::${i}3
    test_ipv6 11 f0:00:00:00:00:11 f0:00:00:00:0${i}:${i}3 $sip $tip ${i}3
done


# ipv6 packet should not be received by lp33 with mac f0:00:00:00:03:33
# and ip6.dst as fe80::ea2a:eaff:fe28:0023 or 4242::0023 as it is
# configured with fe80::ea2a:eaff:fe28:0033 and 4242::0033
# lp11 can send ipv6 traffic as there is no port security

sip=ee80::
tip=fe80::ea2a:eaff:fe28:0023
test_ipv6 11 f0:00:00:00:00:11 f0:00:00:00:03:33 $sip $tip
tip=4242::23
test_ipv6 11 f0:00:00:00:00:11 f0:00:00:00:03:33 $sip $tip

# ipv6 packet should be allowed for lp[123]3 with mac f0:00:00:00:0${i}:${i}3
# and ip6.src fe80::ea2a:eaff:fe28:0${i}${i}3, 4242::00${i}3 and ip6.src ::.
# and should be dropped for any other ip6.src
# lp21 can receive ipv6 traffic as there is no port security

tip=ee80::
for i in 1 2 3; do
    sip=fe80::ea2a:eaff:fe28:00${i}3
    test_ipv6 ${i}3 f0:00:00:00:0${i}:${i}3 f0:00:00:00:00:21 $sip $tip 21
    sip=4242::${i}3
    test_ipv6 ${i}3 f0:00:00:00:0${i}:${i}3 f0:00:00:00:00:21 $sip $tip 21

    # Test ICMPv6 MLD reports (v1 and v2) and NS for DAD
    sip=::
    # Multicast traffic is delivered to all ports, except for the source.
    out_ports=
    for j in 1 2 3; do
        for k in 1 2 3; do
            if test "${j}${k}" -eq "${i}3"; then
                continue
            else
                out_ports="$out_ports ${j}${k}"
            fi
        done
    done
    test_icmpv6 ${i}3 f0:00:00:00:0${i}:${i}3 33:33:00:16:00:00 $sip ff02::16:0 "ICMPv6MLReport()" ${out_ports}
    test_icmpv6 ${i}3 f0:00:00:00:0${i}:${i}3 33:33:00:16:00:00 $sip ff02::16:0 "ICMPv6MLReport2()" ${out_ports}
    test_icmpv6 ${i}3 f0:00:00:00:0${i}:${i}3 33:33:ff:fe:28:00 $sip ff02::ea:2aea:fffe:2800 "ICMPv6ND_NS()" ${out_ports}
    # Traffic to non-multicast traffic should be dropped
    test_icmpv6 ${i}3 f0:00:00:00:0${i}:${i}3 f0:00:00:00:00:21 $sip $tip "ICMPv6MLReport()"
    # Traffic of other ICMPv6 types should be dropped
    test_icmpv6 ${i}3 f0:00:00:00:0${i}:${i}3 33:33:00:16:00:00 $sip ff02::16:0 "ICMPv6EchoRequest()"

    # should be dropped
    sip=ae80::ea2a:eaff:fe28:00aa
    test_ipv6 ${i}3 f0:00:00:00:0${i}:${i}3 f0:00:00:00:00:21 $sip $tip
done

# configure lsp13 to send and received IPv4 packets with an address range
check ovn-nbctl --wait=hv lsp-set-port-security lp13 "f0:00:00:00:00:13 192.168.0.13 20.0.0.4/24 10.0.0.0/24 4242::/64"

sip=10.0.0.13
tip=192.168.0.22
# arp packet with inner ip 10.0.0.13 should be allowed for lsp13
test_arp 13 f0:00:00:00:00:13 f0:00:00:00:00:13 $sip $tip 0 f0:00:00:00:00:22

sip=10.0.0.14
tip=192.168.0.23
# IPv4 packet from lsp13 with src ip 10.0.0.14 destined to lsp23
# with dst ip 192.168.0.23 should be allowed
test_ip 13 f0:00:00:00:00:13 f0:00:00:00:00:23 $sip $tip 23

sip=4242::14
tip=4242::23
# IPv6 packet from lsp13 with src ip 4242::14 destined to lsp23
# with dst ip 4242::23 should be received by lsp23
test_ipv6 13 f0:00:00:00:00:13 f0:00:00:00:02:23 $sip $tip 23

sip=192.168.0.33
tip=10.0.0.15
# IPv4 packet from lsp33 with src ip 192.168.0.33 destined to lsp13
# with dst ip 10.0.0.15 should be received by lsp13
test_ip 33 f0:00:00:00:00:33 f0:00:00:00:00:13 $sip $tip 13

sip=4242::33
tip=4242::13
# IPv6 packet from lsp33 with src ip 4242::33 destined to lsp13
# with dst ip 4242::13 should be received by lsp13
test_ipv6 33 f0:00:00:00:03:33 f0:00:00:00:00:13 $sip $tip 13

sip=192.168.0.33
tip=20.0.0.4
# IPv4 packet from lsp33 with src ip 192.168.0.33 destined to lsp13
# with dst ip 20.0.0.4 should be received by lsp13
test_ip 33 f0:00:00:00:00:33 f0:00:00:00:00:13 $sip $tip 13

sip=192.168.0.33
tip=20.0.0.5
# IPv4 packet from lsp33 with src ip 192.168.0.33 destined to lsp13
# with dst ip 20.0.0.5 should not be received by lsp13
test_ip 33 f0:00:00:00:00:33 f0:00:00:00:00:13 $sip $tip

sip=4242::33
tip=4242::5
# IPv6 packet from lsp33 with src ip 4242::33 destined to lsp13
# with dst ip 4242::5 should not be received by lsp13
test_ipv6 33 f0:00:00:00:03:33 f0:00:00:00:00:13 $sip $tip 13

sip=192.168.0.33
tip=20.0.0.255
# IPv4 packet from lsp33 with src ip 192.168.0.33 destined to lsp13
# with dst ip 20.0.0.255 should be received by lsp13
test_ip 33 f0:00:00:00:00:33 f0:00:00:00:00:13 $sip $tip 13

sip=192.168.0.33
tip=192.168.0.255
# IPv4 packet from lsp33 with src ip 192.168.0.33 destined to lsp13
# with dst ip 192.168.0.255 should not be received by lsp13
test_ip 33 f0:00:00:00:00:33 f0:00:00:00:00:13 $sip $tip

sip=192.168.0.33
tip=224.0.0.4
# IPv4 packet from lsp33 with src ip 192.168.0.33 destined to lsp13
# with dst ip 224.0.0.4  should be received by lsp13
test_ip 33 f0:00:00:00:00:33 f0:00:00:00:00:13 $sip $tip 13

#dump information including flow counters
ovn-nbctl show
ovn-sbctl dump-flows -- list multicast_group > sbflows


echo "------ hv1 dump ------"
as hv1 ovs-vsctl show
as hv1 ovs-ofctl -O OpenFlow13 show br-int
as hv1 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv2 dump ------"
as hv2 ovs-vsctl show
as hv2 ovs-ofctl -O OpenFlow13 show br-int
as hv2 ovs-ofctl -O OpenFlow13 dump-flows br-int

echo "------ hv3 dump ------"
as hv3 ovs-vsctl show
as hv3 ovs-ofctl -O OpenFlow13 show br-int
as hv3 ovs-ofctl -O OpenFlow13 dump-flows br-int

# Now check the packets actually received against the ones expected.
for i in 1 2 3; do
    for j in 1 2 3; do
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv\$i/vif\$i\$j-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv$i/vif$i$j-tx.pcap " "ovn.at:5534"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv$i/vif$i$j-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected" "tests/ovn.at:5534"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:5534"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
if $at_failed
then :
  dump_diff__ "hv$i/vif$i$j-tx.pcap" "$i$j.expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

    done
done



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5534"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5534"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv3" |sed -n '1p')
        error=$(echo "hv3"  | grep '/')
        ignored_dp=$(echo "hv3"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv3"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv3" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5534"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5534"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5534"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5534"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5534"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv3" |sed -n '1p')
        error=$(echo "hv3"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5534"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5534"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5534"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5534: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5534"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5534"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5534" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_84
#AT_START_85
at_fn_group_banner 85 'ovn.at:5945' \
  "2 HVs, 2 LS, 1 lport/LS, 2 peer LRs -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "85. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start

# Logical network:
# Two LRs - R1 and R2 that are connected to each other as peers in 20.0.0.0/24
# network. R1 has a switchs ls1 (191.168.1.0/24) connected to it.
# R2 has ls2 (172.16.1.0/24) connected to it.

ls1_lp1_mac="f0:00:00:01:02:03"
rp_ls1_mac="00:00:00:01:02:03"
rp_ls2_mac="00:00:00:01:02:04"
ls2_lp1_mac="f0:00:00:01:02:04"

ls1_lp1_ip="192.168.1.2"
ls2_lp1_ip="172.16.1.2"

check ovn-nbctl lr-add R1
check ovn-nbctl lr-add R2

check ovn-nbctl ls-add ls1
check ovn-nbctl ls-add ls2

# Connect ls1 to R1
check ovn-nbctl lrp-add R1 ls1 $rp_ls1_mac 192.168.1.1/24

check ovn-nbctl lsp-add ls1 rp-ls1 -- set Logical_Switch_Port rp-ls1 type=router \
  options:router-port=ls1 addresses=\"$rp_ls1_mac\"

# Connect ls2 to R2
check ovn-nbctl lrp-add R2 ls2 $rp_ls2_mac 172.16.1.1/24

check ovn-nbctl lsp-add ls2 rp-ls2 -- set Logical_Switch_Port rp-ls2 type=router \
  options:router-port=ls2 addresses=\"$rp_ls2_mac\"

# Connect R1 to R2
check ovn-nbctl lrp-add R1 R1_R2 00:00:00:02:03:04 20.0.0.1/24 peer=R2_R1
check ovn-nbctl lrp-add R2 R2_R1 00:00:00:02:03:05 20.0.0.2/24 peer=R1_R2

check ovn-nbctl lr-route-add R1 "0.0.0.0/0" 20.0.0.2
check ovn-nbctl lr-route-add R2 "0.0.0.0/0" 20.0.0.1

# Create logical port ls1-lp1 in ls1
check ovn-nbctl lsp-add ls1 ls1-lp1 \
-- lsp-set-addresses ls1-lp1 "$ls1_lp1_mac $ls1_lp1_ip"

# Create logical port ls2-lp1 in ls2
check ovn-nbctl lsp-add ls2 ls2-lp1 \
-- lsp-set-addresses ls2-lp1 "$ls2_lp1_mac $ls2_lp1_ip"

# Create two hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int hv1-vif1 -- \
    set interface hv1-vif1 external-ids:iface-id=ls1-lp1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

sim_add hv2
as hv2
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.2
ovs-vsctl -- add-port br-int hv2-vif1 -- \
    set interface hv2-vif1 external-ids:iface-id=ls2-lp1 \
    options:tx_pcap=hv2/vif1-tx.pcap \
    options:rxq_pcap=hv2/vif1-rx.pcap \
    ofport-request=1


# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure
$at_traceon; }


# Allow some time for ovn-northd and ovn-controller to catch up.
wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Packet to send.
packet="inport==\"ls1-lp1\" && eth.src==$ls1_lp1_mac && eth.dst==$rp_ls1_mac &&
        ip4 && ip.ttl==64 && ip4.src==$ls1_lp1_ip && ip4.dst==$ls2_lp1_ip &&
        udp && udp.src==53 && udp.dst==4369"
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    as hv1 ovn-appctl -t ovn-controller inject-pkt "$packet"
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "until as hv1 ovn-appctl -t ovn-controller inject-pkt \"\$packet\""



echo "---------NB dump-----"
ovn-nbctl show
echo "---------------------"
ovn-nbctl list logical_router
echo "---------------------"
ovn-nbctl list logical_router_port
echo "---------------------"

echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list port_binding
echo "---------------------"

echo "------ hv1 dump ----------"
as hv1 ovs-ofctl show br-int
as hv1 ovs-ofctl dump-flows br-int
echo "------ hv2 dump ----------"
as hv2 ovs-ofctl show br-int
as hv2 ovs-ofctl dump-flows br-int

# Packet to Expect
# The TTL should be decremented by 2.
packet="eth.src==$rp_ls2_mac && eth.dst==$ls2_lp1_mac &&
        ip4 && ip.ttl==62 && ip4.src==$ls1_lp1_ip && ip4.dst==$ls2_lp1_ip &&
        udp && udp.src==53 && udp.dst==4369"
echo $packet | ovstest test-ovn expr-to-packets > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap " "ovn.at:5945"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv2/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv2/vif1-tx.pcap" "expected" "tests/ovn.at:5945"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:5945"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
if $at_failed
then :
  dump_diff__ "hv2/vif1-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovn-sbctl dump-flows | grep lr_in_arp_resolve | \\
grep \"reg0 == 172.16.1.2\" | wc -l"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5945"
( $at_check_trace; ovn-sbctl dump-flows | grep lr_in_arp_resolve | \
grep "reg0 == 172.16.1.2" | wc -l
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure
$at_traceon; }


# Disable the ls2-lp1 port.
check ovn-nbctl --wait=hv set logical_switch_port ls2-lp1 enabled=false

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovn-sbctl dump-flows | grep lr_in_arp_resolve | \\
grep \"reg0 == 172.16.1.2\" | wc -l"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5945"
( $at_check_trace; ovn-sbctl dump-flows | grep lr_in_arp_resolve | \
grep "reg0 == 172.16.1.2" | wc -l
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure
$at_traceon; }


# Generate the packet destined for ls2-lp1 and it should not be delivered.
# Packet to send.
packet="inport==\"ls1-lp1\" && eth.src==$ls1_lp1_mac && eth.dst==$rp_ls1_mac &&
        ip4 && ip.ttl==64 && ip4.src==$ls1_lp1_ip && ip4.dst==$ls2_lp1_ip &&
        udp && udp.src==53 && udp.dst==4369"

check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    as hv1 ovn-appctl -t ovn-controller inject-pkt "$packet"
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "until as hv1 ovn-appctl -t ovn-controller inject-pkt \"\$packet\""

# The 2nd packet sent shound not be received.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap " "ovn.at:5945"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv2/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv2/vif1-tx.pcap" "expected" "tests/ovn.at:5945"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:5945"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
if $at_failed
then :
  dump_diff__ "hv2/vif1-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5945"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5945"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5945"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5945"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5945"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5945"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_85
#AT_START_86
at_fn_group_banner 86 'ovn.at:5945' \
  "2 HVs, 2 LS, 1 lport/LS, 2 peer LRs -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "86. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start

# Logical network:
# Two LRs - R1 and R2 that are connected to each other as peers in 20.0.0.0/24
# network. R1 has a switchs ls1 (191.168.1.0/24) connected to it.
# R2 has ls2 (172.16.1.0/24) connected to it.

ls1_lp1_mac="f0:00:00:01:02:03"
rp_ls1_mac="00:00:00:01:02:03"
rp_ls2_mac="00:00:00:01:02:04"
ls2_lp1_mac="f0:00:00:01:02:04"

ls1_lp1_ip="192.168.1.2"
ls2_lp1_ip="172.16.1.2"

check ovn-nbctl lr-add R1
check ovn-nbctl lr-add R2

check ovn-nbctl ls-add ls1
check ovn-nbctl ls-add ls2

# Connect ls1 to R1
check ovn-nbctl lrp-add R1 ls1 $rp_ls1_mac 192.168.1.1/24

check ovn-nbctl lsp-add ls1 rp-ls1 -- set Logical_Switch_Port rp-ls1 type=router \
  options:router-port=ls1 addresses=\"$rp_ls1_mac\"

# Connect ls2 to R2
check ovn-nbctl lrp-add R2 ls2 $rp_ls2_mac 172.16.1.1/24

check ovn-nbctl lsp-add ls2 rp-ls2 -- set Logical_Switch_Port rp-ls2 type=router \
  options:router-port=ls2 addresses=\"$rp_ls2_mac\"

# Connect R1 to R2
check ovn-nbctl lrp-add R1 R1_R2 00:00:00:02:03:04 20.0.0.1/24 peer=R2_R1
check ovn-nbctl lrp-add R2 R2_R1 00:00:00:02:03:05 20.0.0.2/24 peer=R1_R2

check ovn-nbctl lr-route-add R1 "0.0.0.0/0" 20.0.0.2
check ovn-nbctl lr-route-add R2 "0.0.0.0/0" 20.0.0.1

# Create logical port ls1-lp1 in ls1
check ovn-nbctl lsp-add ls1 ls1-lp1 \
-- lsp-set-addresses ls1-lp1 "$ls1_lp1_mac $ls1_lp1_ip"

# Create logical port ls2-lp1 in ls2
check ovn-nbctl lsp-add ls2 ls2-lp1 \
-- lsp-set-addresses ls2-lp1 "$ls2_lp1_mac $ls2_lp1_ip"

# Create two hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int hv1-vif1 -- \
    set interface hv1-vif1 external-ids:iface-id=ls1-lp1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

sim_add hv2
as hv2
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.2
ovs-vsctl -- add-port br-int hv2-vif1 -- \
    set interface hv2-vif1 external-ids:iface-id=ls2-lp1 \
    options:tx_pcap=hv2/vif1-tx.pcap \
    options:rxq_pcap=hv2/vif1-rx.pcap \
    ofport-request=1


# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure
$at_traceon; }


# Allow some time for ovn-northd and ovn-controller to catch up.
wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Packet to send.
packet="inport==\"ls1-lp1\" && eth.src==$ls1_lp1_mac && eth.dst==$rp_ls1_mac &&
        ip4 && ip.ttl==64 && ip4.src==$ls1_lp1_ip && ip4.dst==$ls2_lp1_ip &&
        udp && udp.src==53 && udp.dst==4369"
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    as hv1 ovn-appctl -t ovn-controller inject-pkt "$packet"
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "until as hv1 ovn-appctl -t ovn-controller inject-pkt \"\$packet\""



echo "---------NB dump-----"
ovn-nbctl show
echo "---------------------"
ovn-nbctl list logical_router
echo "---------------------"
ovn-nbctl list logical_router_port
echo "---------------------"

echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list port_binding
echo "---------------------"

echo "------ hv1 dump ----------"
as hv1 ovs-ofctl show br-int
as hv1 ovs-ofctl dump-flows br-int
echo "------ hv2 dump ----------"
as hv2 ovs-ofctl show br-int
as hv2 ovs-ofctl dump-flows br-int

# Packet to Expect
# The TTL should be decremented by 2.
packet="eth.src==$rp_ls2_mac && eth.dst==$ls2_lp1_mac &&
        ip4 && ip.ttl==62 && ip4.src==$ls1_lp1_ip && ip4.dst==$ls2_lp1_ip &&
        udp && udp.src==53 && udp.dst==4369"
echo $packet | ovstest test-ovn expr-to-packets > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap " "ovn.at:5945"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv2/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv2/vif1-tx.pcap" "expected" "tests/ovn.at:5945"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:5945"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
if $at_failed
then :
  dump_diff__ "hv2/vif1-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovn-sbctl dump-flows | grep lr_in_arp_resolve | \\
grep \"reg0 == 172.16.1.2\" | wc -l"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5945"
( $at_check_trace; ovn-sbctl dump-flows | grep lr_in_arp_resolve | \
grep "reg0 == 172.16.1.2" | wc -l
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure
$at_traceon; }


# Disable the ls2-lp1 port.
check ovn-nbctl --wait=hv set logical_switch_port ls2-lp1 enabled=false

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovn-sbctl dump-flows | grep lr_in_arp_resolve | \\
grep \"reg0 == 172.16.1.2\" | wc -l"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5945"
( $at_check_trace; ovn-sbctl dump-flows | grep lr_in_arp_resolve | \
grep "reg0 == 172.16.1.2" | wc -l
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure
$at_traceon; }


# Generate the packet destined for ls2-lp1 and it should not be delivered.
# Packet to send.
packet="inport==\"ls1-lp1\" && eth.src==$ls1_lp1_mac && eth.dst==$rp_ls1_mac &&
        ip4 && ip.ttl==64 && ip4.src==$ls1_lp1_ip && ip4.dst==$ls2_lp1_ip &&
        udp && udp.src==53 && udp.dst==4369"

check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    as hv1 ovn-appctl -t ovn-controller inject-pkt "$packet"
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "until as hv1 ovn-appctl -t ovn-controller inject-pkt \"\$packet\""

# The 2nd packet sent shound not be received.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap " "ovn.at:5945"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv2/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv2/vif1-tx.pcap" "expected" "tests/ovn.at:5945"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:5945"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
if $at_failed
then :
  dump_diff__ "hv2/vif1-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5945"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5945"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5945"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5945"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:5945"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:5945"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:5945"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:5945: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:5945"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:5945"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:5945" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_86
#AT_START_87
at_fn_group_banner 87 'ovn.at:6091' \
  "1 HV, 1 LS, 2 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "87. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init


printf "%s\n" "ovn.at:6091" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:6091"
ovn_start

# Logical network:
# One LR - R1 has switch ls1 with two subnets attached to it (191.168.1.0/24
# and 172.16.1.0/24) connected to it.

check ovn-nbctl lr-add R1

check ovn-nbctl ls-add ls1

# Connect ls1 to R1
check ovn-nbctl lrp-add R1 ls1 00:00:00:01:02:03 192.168.1.1/24 172.16.1.1/24
check ovn-nbctl lsp-add ls1 rp-ls1 -- set Logical_Switch_Port rp-ls1 type=router \
          options:router-port=ls1 addresses=\"00:00:00:01:02:03\"

# Create logical port ls1-lp1 in ls1
check ovn-nbctl lsp-add ls1 ls1-lp1 \
          -- lsp-set-addresses ls1-lp1 "f0:00:00:01:02:03 192.168.1.2"

# Create logical port ls1-lp2 in ls1
check ovn-nbctl lsp-add ls1 ls1-lp2 \
          -- lsp-set-addresses ls1-lp2 "f0:00:00:01:02:04 172.16.1.2"

# Create one hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int vif1 -- \
    set interface vif1 external-ids:iface-id=ls1-lp1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

ovs-vsctl -- add-port br-int vif2 -- \
    set interface vif2 external-ids:iface-id=ls1-lp2 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=1


wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Send ip packets between the two ports.

# Packet to send.
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:00:01:02:03"
src_ip=192.168.1.2
dst_ip=172.16.1.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")
as hv1 ovs-appctl netdev-dummy/receive vif1 $packet


echo "---------NB dump-----"
ovn-nbctl show
echo "---------------------"
ovn-nbctl list logical_router
echo "---------------------"
ovn-nbctl list logical_router_port
echo "---------------------"

echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list logical_flow
echo "---------------------"

echo "------ hv1 dump ----------"
as hv1 ovs-ofctl dump-flows br-int


#Disable router R1
check ovn-nbctl --wait=hv set Logical_Router R1 enabled=false

echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list logical_flow
echo "---------------------"

echo "------ hv1 dump ----------"
as hv1 ovs-ofctl dump-flows br-int

as hv1 ovs-appctl netdev-dummy/receive vif1 $packet

# Packet to Expect
expect_src_mac="00:00:00:01:02:03"
expect_dst_mac="f0:00:00:01:02:04"
echo $(fmt_pkt "Ether(dst='${expect_dst_mac}', src='${expect_src_mac}')/ \
                IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3f)/ \
                UDP(sport=53, dport=4369)") > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:6091"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "expected" "tests/ovn.at:6091"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6091"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6091"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6091"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6091"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_87
#AT_START_88
at_fn_group_banner 88 'ovn.at:6091' \
  "1 HV, 1 LS, 2 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "88. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init


printf "%s\n" "ovn.at:6091" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:6091"
ovn_start

# Logical network:
# One LR - R1 has switch ls1 with two subnets attached to it (191.168.1.0/24
# and 172.16.1.0/24) connected to it.

check ovn-nbctl lr-add R1

check ovn-nbctl ls-add ls1

# Connect ls1 to R1
check ovn-nbctl lrp-add R1 ls1 00:00:00:01:02:03 192.168.1.1/24 172.16.1.1/24
check ovn-nbctl lsp-add ls1 rp-ls1 -- set Logical_Switch_Port rp-ls1 type=router \
          options:router-port=ls1 addresses=\"00:00:00:01:02:03\"

# Create logical port ls1-lp1 in ls1
check ovn-nbctl lsp-add ls1 ls1-lp1 \
          -- lsp-set-addresses ls1-lp1 "f0:00:00:01:02:03 192.168.1.2"

# Create logical port ls1-lp2 in ls1
check ovn-nbctl lsp-add ls1 ls1-lp2 \
          -- lsp-set-addresses ls1-lp2 "f0:00:00:01:02:04 172.16.1.2"

# Create one hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int vif1 -- \
    set interface vif1 external-ids:iface-id=ls1-lp1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

ovs-vsctl -- add-port br-int vif2 -- \
    set interface vif2 external-ids:iface-id=ls1-lp2 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=1


wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Send ip packets between the two ports.

# Packet to send.
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:00:01:02:03"
src_ip=192.168.1.2
dst_ip=172.16.1.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")
as hv1 ovs-appctl netdev-dummy/receive vif1 $packet


echo "---------NB dump-----"
ovn-nbctl show
echo "---------------------"
ovn-nbctl list logical_router
echo "---------------------"
ovn-nbctl list logical_router_port
echo "---------------------"

echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list logical_flow
echo "---------------------"

echo "------ hv1 dump ----------"
as hv1 ovs-ofctl dump-flows br-int


#Disable router R1
check ovn-nbctl --wait=hv set Logical_Router R1 enabled=false

echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list logical_flow
echo "---------------------"

echo "------ hv1 dump ----------"
as hv1 ovs-ofctl dump-flows br-int

as hv1 ovs-appctl netdev-dummy/receive vif1 $packet

# Packet to Expect
expect_src_mac="00:00:00:01:02:03"
expect_dst_mac="f0:00:00:01:02:04"
echo $(fmt_pkt "Ether(dst='${expect_dst_mac}', src='${expect_src_mac}')/ \
                IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3f)/ \
                UDP(sport=53, dport=4369)") > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:6091"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "expected" "tests/ovn.at:6091"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6091"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6091"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6091"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6091"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6091"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6091: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6091"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6091"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6091" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_88
#AT_START_89
at_fn_group_banner 89 'ovn.at:6200' \
  "1 HV, 2 LSs, 1 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "89. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init




    printf "%s\n" "ovn.at:6200" >"$at_check_line_file"
(test X"$SKIP_UNSTABLE" = Xyes) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:6200"

printf "%s\n" "ovn.at:6200" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:6200"
ovn_start

# Logical network:
# One LR - R1 has switch ls1 (191.168.1.0/24) connected to it,
# and has switch ls2 (172.16.1.0/24) connected to it.

check ovn-nbctl lr-add R1

check ovn-nbctl ls-add ls1
check ovn-nbctl ls-add ls2

# Connect ls1 to R1
check ovn-nbctl lrp-add R1 ls1 00:00:00:01:02:03 192.168.1.1/24
check ovn-nbctl lsp-add ls1 rp-ls1 -- set Logical_Switch_Port rp-ls1 type=router \
          options:router-port=ls1 addresses=\"00:00:00:01:02:03\"

# Connect ls2 to R1
check ovn-nbctl lrp-add R1 ls2 00:00:00:01:02:04 172.16.1.1/24
check ovn-nbctl lsp-add ls2 rp-ls2 -- set Logical_Switch_Port rp-ls2 type=router \
          options:router-port=ls2 addresses=\"00:00:00:01:02:04\"

# Create logical port ls1-lp1 in ls1
check ovn-nbctl lsp-add ls1 ls1-lp1 \
-- lsp-set-addresses ls1-lp1 "f0:00:00:01:02:03 192.168.1.2"

# Create logical port ls2-lp1 in ls2
check ovn-nbctl lsp-add ls2 ls2-lp1 \
-- lsp-set-addresses ls2-lp1 "f0:00:00:01:02:04 172.16.1.2"

# Create one hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int vif1 -- \
    set interface vif1 external-ids:iface-id=ls1-lp1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

ovs-vsctl -- add-port br-int vif2 -- \
    set interface vif2 external-ids:iface-id=ls2-lp1 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=1

wait_for_ports_up
check ovn-nbctl --wait=hv sync

ovn-sbctl dump-flows > sbflows


# Send ip packets between the two ports.

# Packet to send.
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:00:01:02:03"
src_ip=192.168.1.2
dst_ip=172.16.1.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")
as hv1 ovs-appctl netdev-dummy/receive vif1 $packet

#Disable router R1
check ovn-nbctl --wait=hv set Logical_Router R1 enabled=false

ovn-sbctl dump-flows > sbflows2


as hv1 ovs-appctl netdev-dummy/receive vif1 $packet

# Packet to Expect
expect_src_mac="00:00:00:01:02:04"
expect_dst_mac="f0:00:00:01:02:04"
echo $(fmt_pkt "Ether(dst='${expect_dst_mac}', src='${expect_src_mac}')/ \
                IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3f)/ \
                UDP(sport=53, dport=4369)") > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:6200"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2"
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "expected" "tests/ovn.at:6200"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6200"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2"
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6200"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6200"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6200"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_89
#AT_START_90
at_fn_group_banner 90 'ovn.at:6200' \
  "1 HV, 2 LSs, 1 lport/LS, 1 LR -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "90. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init




    printf "%s\n" "ovn.at:6200" >"$at_check_line_file"
(test X"$SKIP_UNSTABLE" = Xyes) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:6200"

printf "%s\n" "ovn.at:6200" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:6200"
ovn_start

# Logical network:
# One LR - R1 has switch ls1 (191.168.1.0/24) connected to it,
# and has switch ls2 (172.16.1.0/24) connected to it.

check ovn-nbctl lr-add R1

check ovn-nbctl ls-add ls1
check ovn-nbctl ls-add ls2

# Connect ls1 to R1
check ovn-nbctl lrp-add R1 ls1 00:00:00:01:02:03 192.168.1.1/24
check ovn-nbctl lsp-add ls1 rp-ls1 -- set Logical_Switch_Port rp-ls1 type=router \
          options:router-port=ls1 addresses=\"00:00:00:01:02:03\"

# Connect ls2 to R1
check ovn-nbctl lrp-add R1 ls2 00:00:00:01:02:04 172.16.1.1/24
check ovn-nbctl lsp-add ls2 rp-ls2 -- set Logical_Switch_Port rp-ls2 type=router \
          options:router-port=ls2 addresses=\"00:00:00:01:02:04\"

# Create logical port ls1-lp1 in ls1
check ovn-nbctl lsp-add ls1 ls1-lp1 \
-- lsp-set-addresses ls1-lp1 "f0:00:00:01:02:03 192.168.1.2"

# Create logical port ls2-lp1 in ls2
check ovn-nbctl lsp-add ls2 ls2-lp1 \
-- lsp-set-addresses ls2-lp1 "f0:00:00:01:02:04 172.16.1.2"

# Create one hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int vif1 -- \
    set interface vif1 external-ids:iface-id=ls1-lp1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

ovs-vsctl -- add-port br-int vif2 -- \
    set interface vif2 external-ids:iface-id=ls2-lp1 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=1

wait_for_ports_up
check ovn-nbctl --wait=hv sync

ovn-sbctl dump-flows > sbflows


# Send ip packets between the two ports.

# Packet to send.
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:00:01:02:03"
src_ip=192.168.1.2
dst_ip=172.16.1.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")
as hv1 ovs-appctl netdev-dummy/receive vif1 $packet

#Disable router R1
check ovn-nbctl --wait=hv set Logical_Router R1 enabled=false

ovn-sbctl dump-flows > sbflows2


as hv1 ovs-appctl netdev-dummy/receive vif1 $packet

# Packet to Expect
expect_src_mac="00:00:00:01:02:04"
expect_dst_mac="f0:00:00:01:02:04"
echo $(fmt_pkt "Ether(dst='${expect_dst_mac}', src='${expect_src_mac}')/ \
                IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3f)/ \
                UDP(sport=53, dport=4369)") > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:6200"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2"
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "expected" "tests/ovn.at:6200"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6200"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2"
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6200"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6200"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6200"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6200"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6200: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6200"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6200"
$at_failed && at_fn_log_failure  \
"sbflows" \
"sbflows2" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6200" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_90
#AT_START_91
at_fn_group_banner 91 'ovn.at:6293' \
  "2 HVs, 3 LS, 1 lport/LS, 2 peer LRs, static routes -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "91. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

printf "%s\n" "ovn.at:6293" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:6293"
ovn_start

# Logical network:
# Two LRs - R1 and R2 that are connected to each other as peers in 20.0.0.0/24
# network. R1 has switchess foo (192.168.1.0/24)
# connected to it.
# R2 has alice (172.16.1.0/24) and bob (172.16.2.0/24) connected to it.

check ovn-nbctl lr-add R1
check ovn-nbctl lr-add R2

check ovn-nbctl ls-add foo
check ovn-nbctl ls-add alice
check ovn-nbctl ls-add bob

# Connect foo to R1
check ovn-nbctl lrp-add R1 foo 00:00:00:01:02:03 192.168.1.1/24
check ovn-nbctl lsp-add foo rp-foo -- set Logical_Switch_Port rp-foo type=router \
          options:router-port=foo addresses=\"00:00:00:01:02:03\"

# Connect alice to R2
check ovn-nbctl lrp-add R2 alice 00:00:00:01:02:04 172.16.1.1/24
check ovn-nbctl lsp-add alice rp-alice -- set Logical_Switch_Port rp-alice \
          type=router options:router-port=alice addresses=\"00:00:00:01:02:04\"

# Connect bob to R2
check ovn-nbctl lrp-add R2 bob 00:00:00:01:02:05 172.16.2.1/24
check ovn-nbctl lsp-add bob rp-bob -- set Logical_Switch_Port rp-bob type=router \
          options:router-port=bob addresses=\"00:00:00:01:02:05\"

# Connect R1 to R2
check ovn-nbctl lrp-add R1 R1_R2 00:00:00:02:03:04 20.0.0.1/24 peer=R2_R1
check ovn-nbctl lrp-add R2 R2_R1 00:00:00:02:03:05 20.0.0.2/24 peer=R1_R2

#install static routes
check ovn-nbctl lr-route-add R1 172.16.1.0/24 20.0.0.2
check ovn-nbctl lr-route-add R2 172.16.2.0/24 20.0.0.2 R1_R2
check ovn-nbctl lr-route-add R2 192.168.1.0/24 20.0.0.1

# Create logical port foo1 in foo
check ovn-nbctl lsp-add foo foo1 \
-- lsp-set-addresses foo1 "f0:00:00:01:02:03 192.168.1.2"

# Create logical port alice1 in alice
check ovn-nbctl lsp-add alice alice1 \
-- lsp-set-addresses alice1 "f0:00:00:01:02:04 172.16.1.2"

# Create logical port bob1 in bob
check ovn-nbctl lsp-add bob bob1 \
-- lsp-set-addresses bob1 "f0:00:00:01:02:05 172.16.2.2"

# Create two hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int hv1-vif1 -- \
    set interface hv1-vif1 external-ids:iface-id=foo1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

ovs-vsctl -- add-port br-int hv1-vif2 -- \
    set interface hv1-vif2 external-ids:iface-id=alice1 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=2

sim_add hv2
as hv2
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.2
ovs-vsctl -- add-port br-int hv2-vif1 -- \
    set interface hv2-vif1 external-ids:iface-id=bob1 \
    options:tx_pcap=hv2/vif1-tx.pcap \
    options:rxq_pcap=hv2/vif1-rx.pcap \
    ofport-request=1


# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure
$at_traceon; }


# Allow some time for ovn-northd and ovn-controller to catch up.
wait_for_ports_up
check ovn-nbctl --wait=hv sync

ovn-sbctl dump-flows > sbflows


# Send ip packets between foo1 and alice1
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:00:01:02:03"
src_ip=192.168.1.2
dst_ip=172.16.1.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")
as hv1 ovs-appctl netdev-dummy/receive hv1-vif1 $packet

# Send ip packets between foo1 and bob1
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:00:01:02:03"
src_ip=192.168.1.2
dst_ip=172.16.2.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")
as hv1 ovs-appctl netdev-dummy/receive hv1-vif1 $packet

# Packet to Expect at bob1
src_mac="00:00:00:01:02:05"
dst_mac="f0:00:00:01:02:05"
src_ip=192.168.1.2
dst_ip=172.16.2.2
echo $(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3e)/ \
                  UDP(sport=53, dport=4369)") > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap " "ovn.at:6293"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv2/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv2/vif1-tx.pcap" "expected" "tests/ovn.at:6293"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6293"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
if $at_failed
then :
  dump_diff__ "hv2/vif1-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


# Packet to Expect at alice1
src_mac="00:00:00:01:02:04"
dst_mac="f0:00:00:01:02:04"
src_ip=192.168.1.2
dst_ip=172.16.1.2
echo $(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3e)/ \
                  UDP(sport=53, dport=4369)") > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:6293"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "expected" "tests/ovn.at:6293"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6293"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6293"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6293"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6293"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6293"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6293"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6293"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_91
#AT_START_92
at_fn_group_banner 92 'ovn.at:6293' \
  "2 HVs, 3 LS, 1 lport/LS, 2 peer LRs, static routes -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "92. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

printf "%s\n" "ovn.at:6293" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:6293"
ovn_start

# Logical network:
# Two LRs - R1 and R2 that are connected to each other as peers in 20.0.0.0/24
# network. R1 has switchess foo (192.168.1.0/24)
# connected to it.
# R2 has alice (172.16.1.0/24) and bob (172.16.2.0/24) connected to it.

check ovn-nbctl lr-add R1
check ovn-nbctl lr-add R2

check ovn-nbctl ls-add foo
check ovn-nbctl ls-add alice
check ovn-nbctl ls-add bob

# Connect foo to R1
check ovn-nbctl lrp-add R1 foo 00:00:00:01:02:03 192.168.1.1/24
check ovn-nbctl lsp-add foo rp-foo -- set Logical_Switch_Port rp-foo type=router \
          options:router-port=foo addresses=\"00:00:00:01:02:03\"

# Connect alice to R2
check ovn-nbctl lrp-add R2 alice 00:00:00:01:02:04 172.16.1.1/24
check ovn-nbctl lsp-add alice rp-alice -- set Logical_Switch_Port rp-alice \
          type=router options:router-port=alice addresses=\"00:00:00:01:02:04\"

# Connect bob to R2
check ovn-nbctl lrp-add R2 bob 00:00:00:01:02:05 172.16.2.1/24
check ovn-nbctl lsp-add bob rp-bob -- set Logical_Switch_Port rp-bob type=router \
          options:router-port=bob addresses=\"00:00:00:01:02:05\"

# Connect R1 to R2
check ovn-nbctl lrp-add R1 R1_R2 00:00:00:02:03:04 20.0.0.1/24 peer=R2_R1
check ovn-nbctl lrp-add R2 R2_R1 00:00:00:02:03:05 20.0.0.2/24 peer=R1_R2

#install static routes
check ovn-nbctl lr-route-add R1 172.16.1.0/24 20.0.0.2
check ovn-nbctl lr-route-add R2 172.16.2.0/24 20.0.0.2 R1_R2
check ovn-nbctl lr-route-add R2 192.168.1.0/24 20.0.0.1

# Create logical port foo1 in foo
check ovn-nbctl lsp-add foo foo1 \
-- lsp-set-addresses foo1 "f0:00:00:01:02:03 192.168.1.2"

# Create logical port alice1 in alice
check ovn-nbctl lsp-add alice alice1 \
-- lsp-set-addresses alice1 "f0:00:00:01:02:04 172.16.1.2"

# Create logical port bob1 in bob
check ovn-nbctl lsp-add bob bob1 \
-- lsp-set-addresses bob1 "f0:00:00:01:02:05 172.16.2.2"

# Create two hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int hv1-vif1 -- \
    set interface hv1-vif1 external-ids:iface-id=foo1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

ovs-vsctl -- add-port br-int hv1-vif2 -- \
    set interface hv1-vif2 external-ids:iface-id=alice1 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=2

sim_add hv2
as hv2
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.2
ovs-vsctl -- add-port br-int hv2-vif1 -- \
    set interface hv2-vif1 external-ids:iface-id=bob1 \
    options:tx_pcap=hv2/vif1-tx.pcap \
    options:rxq_pcap=hv2/vif1-rx.pcap \
    ofport-request=1


# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure
$at_traceon; }


# Allow some time for ovn-northd and ovn-controller to catch up.
wait_for_ports_up
check ovn-nbctl --wait=hv sync

ovn-sbctl dump-flows > sbflows


# Send ip packets between foo1 and alice1
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:00:01:02:03"
src_ip=192.168.1.2
dst_ip=172.16.1.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")
as hv1 ovs-appctl netdev-dummy/receive hv1-vif1 $packet

# Send ip packets between foo1 and bob1
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:00:01:02:03"
src_ip=192.168.1.2
dst_ip=172.16.2.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")
as hv1 ovs-appctl netdev-dummy/receive hv1-vif1 $packet

# Packet to Expect at bob1
src_mac="00:00:00:01:02:05"
dst_mac="f0:00:00:01:02:05"
src_ip=192.168.1.2
dst_ip=172.16.2.2
echo $(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3e)/ \
                  UDP(sport=53, dport=4369)") > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap " "ovn.at:6293"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv2/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv2/vif1-tx.pcap" "expected" "tests/ovn.at:6293"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6293"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
if $at_failed
then :
  dump_diff__ "hv2/vif1-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


# Packet to Expect at alice1
src_mac="00:00:00:01:02:04"
dst_mac="f0:00:00:01:02:04"
src_ip=192.168.1.2
dst_ip=172.16.1.2
echo $(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3e)/ \
                  UDP(sport=53, dport=4369)") > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:6293"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "expected" "tests/ovn.at:6293"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6293"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6293"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6293"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6293"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6293"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6293"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6293"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6293"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6293: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6293"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6293"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6293" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_92
#AT_START_93
at_fn_group_banner 93 'ovn.at:6436' \
  "send gratuitous arp on localnet -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "93. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

ovn_start
check ovn-nbctl ls-add lsw0
net_add n1
sim_add hv
as hv
ovs-vsctl \
    -- add-br br-phys \
    -- add-br br-eth0

ovn_attach n1 br-phys 192.168.0.1

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-vsctl set Open_vSwitch . external-ids:ovn-bridge-mappings=physnet1:br-eth0"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-vsctl set Open_vSwitch . external-ids:ovn-bridge-mappings=physnet1:br-eth0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-vsctl add-port br-eth0 snoopvif -- set Interface snoopvif options:tx_pcap=hv/snoopvif-tx.pcap options:rxq_pcap=hv/snoopvif-rx.pcap"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-vsctl add-port br-eth0 snoopvif -- set Interface snoopvif options:tx_pcap=hv/snoopvif-tx.pcap options:rxq_pcap=hv/snoopvif-rx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }


# Create a vif.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-add lsw0 localvif1"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-add lsw0 localvif1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-set-addresses localvif1 \"f0:00:00:00:00:01 192.168.1.2\""
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-set-addresses localvif1 "f0:00:00:00:00:01 192.168.1.2"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-set-port-security localvif1 \"f0:00:00:00:00:01\""
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-set-port-security localvif1 "f0:00:00:00:00:01"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }


# Create a localnet port.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-add lsw0 ln_port"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-add lsw0 ln_port
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-set-addresses ln_port unknown"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-set-addresses ln_port unknown
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-set-type ln_port localnet"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-set-type ln_port localnet
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-set-options ln_port network_name=physnet1"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-set-options ln_port network_name=physnet1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-vsctl add-port br-int localvif1 -- set Interface localvif1 external_ids:iface-id=localvif1"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-vsctl add-port br-int localvif1 -- set Interface localvif1 external_ids:iface-id=localvif1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }


# Wait for packet to be received.
echo "fffffffffffff0000000000108060001080006040001f00000000001c0a80102000000000000c0a80102" > expected
ovn_wait_packets_uniq__ "hv/snoopvif-tx.pcap" "expected" "tests/ovn.at:6436"

# Check GARP packet when restart openflow connection.
as hv
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"


check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    grep -c "waiting 4 seconds before reconnect" hv/ovn-controller.log
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "until grep -c \"waiting 4 seconds before reconnect\" hv/ovn-controller.log"


as hv
start_daemon ovs-vswitchd --enable-dummy=system -vvconn -vofproto_dpif -vunixctl

# Wait for packet to be received.
echo "fffffffffffff0000000000108060001080006040001f00000000001c0a80102000000000000c0a80102" > expected
ovn_wait_packets_uniq__ "hv/snoopvif-tx.pcap" "expected" "tests/ovn.at:6436"

# Delete the localnet ports.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-vsctl del-port localvif1"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-vsctl del-port localvif1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-del ln_port"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-del ln_port
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }


# Errors "Trying to release unknown interface localvif1" are unexpected and should be investigated
# Probably due to the fact all ifaces deleted from ifstatus module when ofctrl_is_connected detects disconnect,
# as a recompute does not recreate ifaces in ifstatus when port is already claimed and up


        sbox=$(echo "hv
/Trying to release unknown interface localvif1/d
" |sed -n '1p')
        error=$(echo "hv
/Trying to release unknown interface localvif1/d
"  | grep '/')
        ignored_dp=$(echo "hv
/Trying to release unknown interface localvif1/d
"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv
/Trying to release unknown interface localvif1/d
"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv
/Trying to release unknown interface localvif1/d
" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6436"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv
/Trying to release unknown interface localvif1/d
" |sed -n '1p')
        error=$(echo "hv
/Trying to release unknown interface localvif1/d
"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6436"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6436"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_93
#AT_START_94
at_fn_group_banner 94 'ovn.at:6436' \
  "send gratuitous arp on localnet -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "94. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

ovn_start
check ovn-nbctl ls-add lsw0
net_add n1
sim_add hv
as hv
ovs-vsctl \
    -- add-br br-phys \
    -- add-br br-eth0

ovn_attach n1 br-phys 192.168.0.1

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-vsctl set Open_vSwitch . external-ids:ovn-bridge-mappings=physnet1:br-eth0"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-vsctl set Open_vSwitch . external-ids:ovn-bridge-mappings=physnet1:br-eth0
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-vsctl add-port br-eth0 snoopvif -- set Interface snoopvif options:tx_pcap=hv/snoopvif-tx.pcap options:rxq_pcap=hv/snoopvif-rx.pcap"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-vsctl add-port br-eth0 snoopvif -- set Interface snoopvif options:tx_pcap=hv/snoopvif-tx.pcap options:rxq_pcap=hv/snoopvif-rx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }


# Create a vif.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-add lsw0 localvif1"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-add lsw0 localvif1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-set-addresses localvif1 \"f0:00:00:00:00:01 192.168.1.2\""
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-set-addresses localvif1 "f0:00:00:00:00:01 192.168.1.2"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-set-port-security localvif1 \"f0:00:00:00:00:01\""
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-set-port-security localvif1 "f0:00:00:00:00:01"
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }


# Create a localnet port.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-add lsw0 ln_port"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-add lsw0 ln_port
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-set-addresses ln_port unknown"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-set-addresses ln_port unknown
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-set-type ln_port localnet"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-set-type ln_port localnet
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-set-options ln_port network_name=physnet1"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-set-options ln_port network_name=physnet1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-vsctl add-port br-int localvif1 -- set Interface localvif1 external_ids:iface-id=localvif1"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-vsctl add-port br-int localvif1 -- set Interface localvif1 external_ids:iface-id=localvif1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }


# Wait for packet to be received.
echo "fffffffffffff0000000000108060001080006040001f00000000001c0a80102000000000000c0a80102" > expected
ovn_wait_packets_uniq__ "hv/snoopvif-tx.pcap" "expected" "tests/ovn.at:6436"

# Check GARP packet when restart openflow connection.
as hv
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"


check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    grep -c "waiting 4 seconds before reconnect" hv/ovn-controller.log
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "until grep -c \"waiting 4 seconds before reconnect\" hv/ovn-controller.log"


as hv
start_daemon ovs-vswitchd --enable-dummy=system -vvconn -vofproto_dpif -vunixctl

# Wait for packet to be received.
echo "fffffffffffff0000000000108060001080006040001f00000000001c0a80102000000000000c0a80102" > expected
ovn_wait_packets_uniq__ "hv/snoopvif-tx.pcap" "expected" "tests/ovn.at:6436"

# Delete the localnet ports.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-vsctl del-port localvif1"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-vsctl del-port localvif1
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovn-nbctl lsp-del ln_port"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovn-nbctl lsp-del ln_port
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure
$at_traceon; }


# Errors "Trying to release unknown interface localvif1" are unexpected and should be investigated
# Probably due to the fact all ifaces deleted from ifstatus module when ofctrl_is_connected detects disconnect,
# as a recompute does not recreate ifaces in ifstatus when port is already claimed and up


        sbox=$(echo "hv
/Trying to release unknown interface localvif1/d
" |sed -n '1p')
        error=$(echo "hv
/Trying to release unknown interface localvif1/d
"  | grep '/')
        ignored_dp=$(echo "hv
/Trying to release unknown interface localvif1/d
"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv
/Trying to release unknown interface localvif1/d
"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv
/Trying to release unknown interface localvif1/d
" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6436"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv
/Trying to release unknown interface localvif1/d
" |sed -n '1p')
        error=$(echo "hv
/Trying to release unknown interface localvif1/d
"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6436"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6436"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6436"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6436: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6436"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6436"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6436" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_94
#AT_START_95
at_fn_group_banner 95 'ovn.at:6496' \
  "2 HVs, 3 LRs connected via LS, static routes -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "95. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

printf "%s\n" "ovn.at:6496" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:6496"
ovn_start

# Logical network:
# Three LRs - R1, R2 and R3 that are connected to each other via LS "join"
# in 20.0.0.0/24 network. R1 has switchess foo (192.168.1.0/24)
# connected to it. R2 has alice (172.16.1.0/24) and R3 has bob (10.32.1.0/24)
# connected to it.

check ovn-nbctl lr-add R1
check ovn-nbctl lr-add R2
check ovn-nbctl lr-add R3

check ovn-nbctl ls-add foo
check ovn-nbctl ls-add alice
check ovn-nbctl ls-add bob
check ovn-nbctl ls-add join

# Connect foo to R1
check ovn-nbctl lrp-add R1 foo 00:00:01:01:02:03 192.168.1.1/24
check ovn-nbctl lsp-add foo rp-foo -- set Logical_Switch_Port rp-foo type=router \
    options:router-port=foo addresses=\"00:00:01:01:02:03\"

# Connect alice to R2
check ovn-nbctl lrp-add R2 alice 00:00:02:01:02:03 172.16.1.1/24
check ovn-nbctl lsp-add alice rp-alice -- set Logical_Switch_Port rp-alice \
    type=router options:router-port=alice addresses=\"00:00:02:01:02:03\"

# Connect bob to R3
check ovn-nbctl lrp-add R3 bob 00:00:03:01:02:03 10.32.1.1/24
check ovn-nbctl lsp-add bob rp-bob -- set Logical_Switch_Port rp-bob \
    type=router options:router-port=bob addresses=\"00:00:03:01:02:03\"

# Connect R1 to join
check ovn-nbctl lrp-add R1 R1_join 00:00:04:01:02:03 20.0.0.1/24
check ovn-nbctl lsp-add join r1-join -- set Logical_Switch_Port r1-join \
    type=router options:router-port=R1_join addresses='"00:00:04:01:02:03"'

# Connect R2 to join
check ovn-nbctl lrp-add R2 R2_join 00:00:04:01:02:04 20.0.0.2/24
check ovn-nbctl lsp-add join r2-join -- set Logical_Switch_Port r2-join \
    type=router options:router-port=R2_join addresses='"00:00:04:01:02:04"'

# Connect R3 to join
check ovn-nbctl lrp-add R3 R3_join 00:00:04:01:02:05 20.0.0.3/24
check ovn-nbctl lsp-add join r3-join -- set Logical_Switch_Port r3-join \
    type=router options:router-port=R3_join addresses='"00:00:04:01:02:05"'

#install static routes
check ovn-nbctl lr-route-add R1 172.16.1.0/24 20.0.0.2
check ovn-nbctl lr-route-add R1 10.32.1.0/24 20.0.0.3

check ovn-nbctl lr-route-add R2 192.168.1.0/24 20.0.0.1
check ovn-nbctl lr-route-add R2 10.32.1.0/24 20.0.0.3

check ovn-nbctl lr-route-add R3 192.168.1.0/24 20.0.0.1
check ovn-nbctl lr-route-add R3 172.16.1.0/24 20.0.0.2

# Create logical port foo1 in foo
check ovn-nbctl lsp-add foo foo1 \
-- lsp-set-addresses foo1 "f0:00:00:01:02:03 192.168.1.2"

# Create logical port alice1 in alice
check ovn-nbctl lsp-add alice alice1 \
-- lsp-set-addresses alice1 "f0:00:00:01:02:04 172.16.1.2"

# Create logical port bob1 in bob
check ovn-nbctl lsp-add bob bob1 \
-- lsp-set-addresses bob1 "f0:00:00:01:02:05 10.32.1.2"

# Create two hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int hv1-vif1 -- \
    set interface hv1-vif1 external-ids:iface-id=foo1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

ovs-vsctl -- add-port br-int hv1-vif2 -- \
    set interface hv1-vif2 external-ids:iface-id=alice1 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=2

sim_add hv2
as hv2
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.2
ovs-vsctl -- add-port br-int hv2-vif1 -- \
    set interface hv2-vif1 external-ids:iface-id=bob1 \
    options:tx_pcap=hv2/vif1-tx.pcap \
    options:rxq_pcap=hv2/vif1-rx.pcap \
    ofport-request=1


# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure
$at_traceon; }


# Allow some time for ovn-northd and ovn-controller to catch up.
wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Send ip packets between foo1 and alice1
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:01:01:02:03"
src_ip=192.168.1.2
dst_ip=172.16.1.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")
as hv1 ovs-appctl netdev-dummy/receive hv1-vif1 $packet
as hv1 ovs-appctl ofproto/trace br-int in_port=1 $packet

# Send ip packets between foo1 and bob1
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:01:01:02:03"
src_ip=192.168.1.2
dst_ip=10.32.1.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")
as hv1 ovs-appctl netdev-dummy/receive hv1-vif1 $packet

echo "---------NB dump-----"
ovn-nbctl show
echo "---------------------"
ovn-nbctl list logical_router
echo "---------------------"
ovn-nbctl list logical_router_port
echo "---------------------"

echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list port_binding
echo "---------------------"
ovn-sbctl dump-flows
echo "---------------------"

echo "------ hv1 dump ----------"
as hv1 ovs-ofctl show br-int
as hv1 ovs-ofctl dump-flows br-int
echo "------ hv2 dump ----------"
as hv2 ovs-ofctl show br-int
as hv2 ovs-ofctl dump-flows br-int
echo "----------------------------"

# Packet to Expect at bob1
src_mac="00:00:03:01:02:03"
dst_mac="f0:00:00:01:02:05"
src_ip=192.168.1.2
dst_ip=10.32.1.2
echo $(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3e)/ \
                  UDP(sport=53, dport=4369)") > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap " "ovn.at:6496"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv2/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv2/vif1-tx.pcap" "expected" "tests/ovn.at:6496"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6496"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
if $at_failed
then :
  dump_diff__ "hv2/vif1-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }


# Packet to Expect at alice1
src_mac="00:00:02:01:02:03"
dst_mac="f0:00:00:01:02:04"
src_ip=192.168.1.2
dst_ip=172.16.1.2
echo $(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3e)/ \
                  UDP(sport=53, dport=4369)") > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:6496"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "expected" "tests/ovn.at:6496"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6496"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6496"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6496"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6496"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6496"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6496"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6496"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_95
#AT_START_96
at_fn_group_banner 96 'ovn.at:6496' \
  "2 HVs, 3 LRs connected via LS, static routes -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "96. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

printf "%s\n" "ovn.at:6496" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:6496"
ovn_start

# Logical network:
# Three LRs - R1, R2 and R3 that are connected to each other via LS "join"
# in 20.0.0.0/24 network. R1 has switchess foo (192.168.1.0/24)
# connected to it. R2 has alice (172.16.1.0/24) and R3 has bob (10.32.1.0/24)
# connected to it.

check ovn-nbctl lr-add R1
check ovn-nbctl lr-add R2
check ovn-nbctl lr-add R3

check ovn-nbctl ls-add foo
check ovn-nbctl ls-add alice
check ovn-nbctl ls-add bob
check ovn-nbctl ls-add join

# Connect foo to R1
check ovn-nbctl lrp-add R1 foo 00:00:01:01:02:03 192.168.1.1/24
check ovn-nbctl lsp-add foo rp-foo -- set Logical_Switch_Port rp-foo type=router \
    options:router-port=foo addresses=\"00:00:01:01:02:03\"

# Connect alice to R2
check ovn-nbctl lrp-add R2 alice 00:00:02:01:02:03 172.16.1.1/24
check ovn-nbctl lsp-add alice rp-alice -- set Logical_Switch_Port rp-alice \
    type=router options:router-port=alice addresses=\"00:00:02:01:02:03\"

# Connect bob to R3
check ovn-nbctl lrp-add R3 bob 00:00:03:01:02:03 10.32.1.1/24
check ovn-nbctl lsp-add bob rp-bob -- set Logical_Switch_Port rp-bob \
    type=router options:router-port=bob addresses=\"00:00:03:01:02:03\"

# Connect R1 to join
check ovn-nbctl lrp-add R1 R1_join 00:00:04:01:02:03 20.0.0.1/24
check ovn-nbctl lsp-add join r1-join -- set Logical_Switch_Port r1-join \
    type=router options:router-port=R1_join addresses='"00:00:04:01:02:03"'

# Connect R2 to join
check ovn-nbctl lrp-add R2 R2_join 00:00:04:01:02:04 20.0.0.2/24
check ovn-nbctl lsp-add join r2-join -- set Logical_Switch_Port r2-join \
    type=router options:router-port=R2_join addresses='"00:00:04:01:02:04"'

# Connect R3 to join
check ovn-nbctl lrp-add R3 R3_join 00:00:04:01:02:05 20.0.0.3/24
check ovn-nbctl lsp-add join r3-join -- set Logical_Switch_Port r3-join \
    type=router options:router-port=R3_join addresses='"00:00:04:01:02:05"'

#install static routes
check ovn-nbctl lr-route-add R1 172.16.1.0/24 20.0.0.2
check ovn-nbctl lr-route-add R1 10.32.1.0/24 20.0.0.3

check ovn-nbctl lr-route-add R2 192.168.1.0/24 20.0.0.1
check ovn-nbctl lr-route-add R2 10.32.1.0/24 20.0.0.3

check ovn-nbctl lr-route-add R3 192.168.1.0/24 20.0.0.1
check ovn-nbctl lr-route-add R3 172.16.1.0/24 20.0.0.2

# Create logical port foo1 in foo
check ovn-nbctl lsp-add foo foo1 \
-- lsp-set-addresses foo1 "f0:00:00:01:02:03 192.168.1.2"

# Create logical port alice1 in alice
check ovn-nbctl lsp-add alice alice1 \
-- lsp-set-addresses alice1 "f0:00:00:01:02:04 172.16.1.2"

# Create logical port bob1 in bob
check ovn-nbctl lsp-add bob bob1 \
-- lsp-set-addresses bob1 "f0:00:00:01:02:05 10.32.1.2"

# Create two hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int hv1-vif1 -- \
    set interface hv1-vif1 external-ids:iface-id=foo1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

ovs-vsctl -- add-port br-int hv1-vif2 -- \
    set interface hv1-vif2 external-ids:iface-id=alice1 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=2

sim_add hv2
as hv2
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.2
ovs-vsctl -- add-port br-int hv2-vif1 -- \
    set interface hv2-vif1 external-ids:iface-id=bob1 \
    options:tx_pcap=hv2/vif1-tx.pcap \
    options:rxq_pcap=hv2/vif1-rx.pcap \
    ofport-request=1


# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure
$at_traceon; }


# Allow some time for ovn-northd and ovn-controller to catch up.
wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Send ip packets between foo1 and alice1
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:01:01:02:03"
src_ip=192.168.1.2
dst_ip=172.16.1.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")
as hv1 ovs-appctl netdev-dummy/receive hv1-vif1 $packet
as hv1 ovs-appctl ofproto/trace br-int in_port=1 $packet

# Send ip packets between foo1 and bob1
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:01:01:02:03"
src_ip=192.168.1.2
dst_ip=10.32.1.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")
as hv1 ovs-appctl netdev-dummy/receive hv1-vif1 $packet

echo "---------NB dump-----"
ovn-nbctl show
echo "---------------------"
ovn-nbctl list logical_router
echo "---------------------"
ovn-nbctl list logical_router_port
echo "---------------------"

echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list port_binding
echo "---------------------"
ovn-sbctl dump-flows
echo "---------------------"

echo "------ hv1 dump ----------"
as hv1 ovs-ofctl show br-int
as hv1 ovs-ofctl dump-flows br-int
echo "------ hv2 dump ----------"
as hv2 ovs-ofctl show br-int
as hv2 ovs-ofctl dump-flows br-int
echo "----------------------------"

# Packet to Expect at bob1
src_mac="00:00:03:01:02:03"
dst_mac="f0:00:00:01:02:05"
src_ip=192.168.1.2
dst_ip=10.32.1.2
echo $(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3e)/ \
                  UDP(sport=53, dport=4369)") > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap " "ovn.at:6496"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv2/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv2/vif1-tx.pcap" "expected" "tests/ovn.at:6496"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6496"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
if $at_failed
then :
  dump_diff__ "hv2/vif1-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }


# Packet to Expect at alice1
src_mac="00:00:02:01:02:03"
dst_mac="f0:00:00:01:02:04"
src_ip=192.168.1.2
dst_ip=172.16.1.2
echo $(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3e)/ \
                  UDP(sport=53, dport=4369)") > expected

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:6496"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "expected" "tests/ovn.at:6496"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6496"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6496"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6496"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6496"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6496"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:6496"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:6496"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6496"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6496: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6496"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6496"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6496" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_96
#AT_START_97
at_fn_group_banner 97 'ovn.at:6679' \
  "dhcpv4 : 1 HV, 2 LS, 2 LSPs/LS -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "97. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init


ovn_start

check ovn-nbctl ls-add ls1

check ovn-nbctl lsp-add ls1 ls1-lp1 \
-- lsp-set-addresses ls1-lp1 "f0:00:00:00:00:01 10.0.0.4"

check ovn-nbctl lsp-set-port-security ls1-lp1 "f0:00:00:00:00:01 10.0.0.4"

check ovn-nbctl lsp-add ls1 ls1-lp2 \
-- lsp-set-addresses ls1-lp2 "f0:00:00:00:00:02 10.0.0.6 20.0.0.4"

check ovn-nbctl lsp-set-port-security ls1-lp2 "f0:00:00:00:00:02 10.0.0.6 20.0.0.4"

check ovn-nbctl ls-add ls2
check ovn-nbctl lsp-add ls2 ls2-lp1 \
-- lsp-set-addresses ls2-lp1 "f0:00:00:00:00:03 30.0.0.6 40.0.0.4"
check ovn-nbctl lsp-set-port-security ls2-lp1 "f0:00:00:00:00:03 30.0.0.6 40.0.0.4"
check ovn-nbctl lsp-add ls2 ls2-lp2 \
-- lsp-set-addresses ls2-lp2 "f0:00:00:00:00:04 30.0.0.7"
check ovn-nbctl lsp-set-port-security ls2-lp2 "f0:00:00:00:00:04 30.0.0.7"

d1="$(ovn-nbctl create DHCP_Options cidr=10.0.0.0/24 \
options="\"server_id\"=\"10.0.0.1\" \"server_mac\"=\"ff:10:00:00:00:01\" \
\"lease_time\"=\"3600\" \"router\"=\"10.0.0.1\"")"

check ovn-nbctl lsp-set-dhcpv4-options ls1-lp1 ${d1}
check ovn-nbctl lsp-set-dhcpv4-options ls1-lp2 ${d1}

d2="$(ovn-nbctl create DHCP_Options cidr=30.0.0.0/24 \
options="\"server_id\"=\"30.0.0.1\" \"server_mac\"=\"ff:10:00:00:00:02\" \
\"lease_time\"=\"3600\"")"

check ovn-nbctl lsp-set-dhcpv4-options ls2-lp2 ${d2}

net_add n1
sim_add hv1

as hv1
check ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
check ovs-vsctl -- add-port br-int hv1-vif1 -- \
    set interface hv1-vif1 external-ids:iface-id=ls1-lp1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

check ovs-vsctl -- add-port br-int hv1-vif2 -- \
    set interface hv1-vif2 external-ids:iface-id=ls1-lp2 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=2

check ovs-vsctl -- add-port br-int hv1-vif3 -- \
    set interface hv1-vif3 external-ids:iface-id=ls2-lp1 \
    options:tx_pcap=hv1/vif3-tx.pcap \
    options:rxq_pcap=hv1/vif3-rx.pcap \
    ofport-request=3

check ovs-vsctl -- add-port br-int hv1-vif4 -- \
    set interface hv1-vif4 external-ids:iface-id=ls2-lp2 \
    options:tx_pcap=hv1/vif4-tx.pcap \
    options:rxq_pcap=hv1/vif4-rx.pcap \
    ofport-request=4

as hv1 ovs-appctl vlog/set dbg

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure
$at_traceon; }


wait_for_ports_up
check ovn-nbctl --wait=hv sync

as hv1 ovs-vsctl show

# This shell function sends a DHCP request packet
#
# The first argument is just the number of calls to this function so
# far (1, 2, ...).  This is redundant, but it makes it easier to find
# the failures by searching for the number.
#
# test_dhcp PACKET_NUM INPORT SRC_MAC DHCP_TYPE BROADCAST CIADDR OFFER_IP REQUEST_IP ETH_BOOT USE_IP ...
packet_num=0
test_dhcp() {
    local expect_resume=:
    local trace=false
    while :; do
        case $1 in
            (--no-resume) expect_resume=false; shift ;;
            # --trace isn't used but it can be useful for debugging:
            (--trace) trace=:; shift ;;
            (*) break ;;
        esac
    done

    packet_num=$(expr $packet_num + 1)
    printf "%s\n" "ovn.at:6679" >"$at_check_line_file"
(test $packet_num != $1) \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:6679"
    shift

    local inport=$1 src_mac=$2 dhcp_type=$3 broadcast=$4 ciaddr=$5 offer_ip=$6 request_ip=$7 eth_boot=$8 use_ip=$9
    shift; shift; shift; shift; shift; shift; shift; shift; shift;

    if test $use_ip != 0; then
        src_ip=$1
        dst_ip=$2
        shift; shift;
    else
        src_ip=`ip_to_hex 0 0 0 0`
        dst_ip=`ip_to_hex 255 255 255 255`
    fi

    sed 'h;s/./-/g;s/^.../## /;s/...$/ ##/;p;x;p;x' <<_ASBOX
## dhcp test packet $packet_num ##
_ASBOX

    as hv1
    if test -f hv1/ovs-ofctl.pid; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: test -e \$OVS_RUNDIR/ovs-ofctl.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-ofctl.pid" "ovn.at:6679"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-ofctl.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-ofctl.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovs-appctl --timeout=10 -t ovs-ofctl exit"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-ofctl exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "while kill -0 \$TMPPID 2>/dev/null"

        printf "%s\n" "ovn.at:6679" >"$at_check_line_file"
(test -f ovs-ofctl.pid) \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:6679"
    fi

    ovs-ofctl monitor br-int resume --detach --no-chdir \
        --pidfile=ovs-ofctl.pid 2> ofctl_monitor$packet_num.log

    echo "inport=$inport src_mac=$src_mac dhcp_type=$dhcp_type broadcast=$broadcast ciaddr=$ciaddr offer_ip=$offer_ip request_ip=$request_ip use_ip=$use_ip src_ip=$src_ip dst_ip=$dst_ip"

    if test $request_ip != 0; then
        if test $eth_boot != 0; then
            ip_len=0124
            udp_len=010f
        else
            ip_len=0120
            udp_len=010b
        fi
    else
        if test $eth_boot != 0; then
            ip_len=011e
            udp_len=010a
        else
            ip_len=011a
            udp_len=0106
        fi
    fi

    if test $broadcast != 0; then
        flags=8000
        reply_dst_ip=`ip_to_hex 255 255 255 255`
    else
        flags=0000
        reply_dst_ip=${offer_ip}
    fi

    if test "$dhcp_type" = "04"; then
        ciaddr=$offer_ip
    fi

    local request=ffffffffffff${src_mac}08004510${ip_len}0000000080110000${src_ip}${dst_ip}
    # udp header and dhcp header
    request=${request}00440043${udp_len}0000
    request=${request}010106006359aa760000${flags}${ciaddr}000000000000000000000000${src_mac}
    # client hardware padding
    request=${request}00000000000000000000
    # server hostname
    request=${request}0000000000000000000000000000000000000000000000000000000000000000
    request=${request}0000000000000000000000000000000000000000000000000000000000000000
    # boot file name
    request=${request}0000000000000000000000000000000000000000000000000000000000000000
    request=${request}0000000000000000000000000000000000000000000000000000000000000000
    request=${request}0000000000000000000000000000000000000000000000000000000000000000
    request=${request}0000000000000000000000000000000000000000000000000000000000000000
    # dhcp magic cookie
    request=${request}63825363
    # dhcp message type
    request=${request}3501${dhcp_type}
    # dhcp unknown option
    request=${request}d70701020304050607
    # dhcp pad option
    request=${request}00
    if test $request_ip != 0; then
        # dhcp requested ip
        request=${request}3204${request_ip}
    fi
    if test $eth_boot != 0; then
        request=${request}af020000
    fi
    # dhcp end option
    request=${request}ff
    tcpdump_hex "-- sending DHCP request on hv1-vif$inport" $request

    for port in $inport "$@"; do
        : >> $port.expected
    done
    if test $offer_ip != 0; then
        local srv_mac=$1 srv_ip=$2 dhcp_reply_type=$3 expected_dhcp_opts=$4
        local offered_ip=$offer_ip
        if [ "$dhcp_type" == "08" ]; then
            # DHCP ACK for DHCP INFORM should not have any offer ip.
            offered_ip=00000000
        fi

        # total IP length will be the IP length of the request packet
        # (which is 272 in our case) + 8 (padding bytes) + (expected_dhcp_opts / 2)
        ip_len=`expr 280 + ${#expected_dhcp_opts} / 2`
        udp_len=`expr $ip_len - 20`
        ip_len=$(printf "%x" $ip_len)
        udp_len=$(printf "%x" $udp_len)
        # $ip_len var will be in 3 digits i.e 134. So adding a '0' before $ip_len
        local reply=${src_mac}${srv_mac}0800
        local ip_header=45100${ip_len}0000000080110000${srv_ip}${reply_dst_ip}
        reply=${reply}$(ip4_csum_inplace $ip_header)
        # udp header and dhcp header.
        # $udp_len var will be in 3 digits. So adding a '0' before $udp_len
        reply=${reply}004300440${udp_len}0000020106006359aa760000${flags}${ciaddr}
        # your ip address; 0 for NAK
        if test $dhcp_reply_type = 06; then
            reply=${reply}00000000
        else
            reply=${reply}${offered_ip}
        fi
        # next server ip address, relay agent ip address, client mac address
        reply=${reply}0000000000000000${src_mac}
        # client hardware padding
        reply=${reply}00000000000000000000
        # server hostname
        reply=${reply}0000000000000000000000000000000000000000000000000000000000000000
        reply=${reply}0000000000000000000000000000000000000000000000000000000000000000
        # boot file name
        reply=${reply}0000000000000000000000000000000000000000000000000000000000000000
        reply=${reply}0000000000000000000000000000000000000000000000000000000000000000
        reply=${reply}0000000000000000000000000000000000000000000000000000000000000000
        reply=${reply}0000000000000000000000000000000000000000000000000000000000000000
        # dhcp magic cookie
        reply=${reply}63825363
        reply=${reply}3501${dhcp_reply_type}${expected_dhcp_opts}00000000ff00000000
        echo $reply >> $inport.expected
        tcpdump_hex "-- expecting DHCP reply on $inport" $request
    else
        for outport; do
            echo $request >> $outport.expected
        done
    fi
    if $trace; then
        as hv1 ovs-appctl ofproto/trace br-int in_port=hv1-vif$inport $request > trace$packet_num

    else
        check as hv1 ovs-appctl netdev-dummy/receive hv1-vif$inport $request
    fi

    # NXT_RESUMEs should be 1.
    if $expect_resume; then
        check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test 1 = `cat ofctl_monitor$packet_num.log | grep -c NXT_RESUME`
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "until test 1 = \`cat ofctl_monitor\$packet_num.log | grep -c NXT_RESUME\`"

    fi
}

compare_dhcp_packets() {
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif\$1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif$1-tx.pcap " "ovn.at:6679"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif$1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num"
$at_traceon; }

   ovn_check_packets__ "hv1/vif$1-tx.pcap" "$1.expected" "tests/ovn.at:6679"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6679"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
if $at_failed
then :
  dump_diff__ "hv1/vif$1-tx.pcap" "$1.expected"
fi
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num"
$at_traceon; }

}


ovn-sbctl dump-flows > sbflows

# ----------------------------------------------------------------------

# Send DHCPDISCOVER.
offer_ip=`ip_to_hex 10 0 0 4`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a000001
test_dhcp 1 1 f00000000001 01 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 02 $expected_dhcp_opts
compare_dhcp_packets 1

# ----------------------------------------------------------------------

# ovs-ofctl also resumes the packets and this causes other ports to receive
# the DHCP request packet. So reset the pcap files so that its easier to test.
reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST in the SELECTING/INIT-REBOOT state with the offered IP
# address in the Requested IP Address option.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=$offer_ip
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a000001
test_dhcp 2 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST in the SELECTING/INIT-REBOOT state with a mismatched IP in
# the Requested IP Address option, expect a DHCPNAK.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=`ip_to_hex 10 0 0 7`
expected_dhcp_opts=""
test_dhcp 3 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 06 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------
reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send Invalid DHCPv4 packet on ls1-lp2. It should be received by ovn-controller
# but should be resumed without the reply.
# ls1-lp1 (vif1-tx.pcap) should receive the DHCPv4 request packet twice,
# one from ovn-controller and the other from "ovs-ofctl resume."
ciaddr=`ip_to_hex 0 0 0 0`
offer_ip=0
request_ip=0
test_dhcp 4 2 f00000000002 09 0 $ciaddr $offer_ip $request_ip 0 0 1 1

# NXT_RESUMEs should be 4.
# vif1-tx.pcap should have received the DHCPv4 (invalid) request packet
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap " "ovn.at:6679"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif1-tx.pcap" "1.expected" "tests/ovn.at:6679"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6679"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
if $at_failed
then :
  dump_diff__ "hv1/vif1-tx.pcap" "1.expected"
fi
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows"
$at_traceon; }


# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# NXT_RESUMEs should be 4.
# Send DHCPREQUEST in the RENEWING/REBINDING state with ip4.src set to 10.0.0.6
# and ip4.dst set to 10.0.0.1.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=$offer_ip
request_ip=0
src_ip=$offer_ip
dst_ip=$server_ip
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a000001
test_dhcp 5 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST in the RENEWING/REBINDING state with ip4.src set to 10.0.0.6
# and ip4.dst set to 255.255.255.255.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=$offer_ip
request_ip=0
src_ip=$offer_ip
dst_ip=`ip_to_hex 255 255 255 255`
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a000001
test_dhcp 6 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST in the RENEWING/REBINDING state with a mismatched IP in the
# ciaddr, expect a DHCPNAK.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 10 0 0 7`
request_ip=0
src_ip=$offer_ip
dst_ip=`ip_to_hex 255 255 255 255`
expected_dhcp_opts=""
test_dhcp 7 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 06 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST in the RENEWING/REBINDING state without a specifyied ciaddr,
# expect a DHCPNAK.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
src_ip=$offer_ip
dst_ip=`ip_to_hex 255 255 255 255`
expected_dhcp_opts=""
test_dhcp 8 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 06 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST with ip4.src set to 10.0.0.6 and ip4.dst set to 10.0.0.4.
# The packet should not be received by ovn-controller.
ciaddr=`ip_to_hex 0 0 0 0`
src_ip=`ip_to_hex 10 0 0 6`
dst_ip=`ip_to_hex 10 0 0 4`
test_dhcp --no-resume 9 2 f00000000002 03 0 $ciaddr 0 0 0 1 $src_ip $dst_ip 1

# vif1-tx.pcap should have received the DHCPv4 request packet
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap " "ovn.at:6679"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif1-tx.pcap" "1.expected" "tests/ovn.at:6679"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6679"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
if $at_failed
then :
  dump_diff__ "hv1/vif1-tx.pcap" "1.expected"
fi
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows"
$at_traceon; }


# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPDISCOVER with BROADCAST flag on.
offer_ip=`ip_to_hex 10 0 0 4`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a000001
test_dhcp 10 1 f00000000001 01 1 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 02 $expected_dhcp_opts
compare_dhcp_packets 1

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPRELEASE.
offer_ip=0
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 10 0 0 6`
request_ip=0
expected_dhcp_opts=0
test_dhcp 11 2 f00000000002 07 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001

# There is no reply for this. Check for the INFO log in ovn-controller.log
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test 1 = $(cat hv1/ovn-controller.log | grep "DHCPRELEASE f0:00:00:00:00:02 10.0.0.6" -c)

}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "until test 1 = \$(cat hv1/ovn-controller.log | grep \"DHCPRELEASE f0:00:00:00:00:02 10.0.0.6\" -c)
"


$PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap > 2.packets
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: cat 2.packets"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; cat 2.packets
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows"
$at_traceon; }


# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPINFORM
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=$offer_ip
request_ip=0
src_ip=$offer_ip
dst_ip=$server_ip
# In the expected_dhcp_opts we should not see 330400000e10 which is
# dhcp lease time option and 0104ffffff00 which is subnet mask option.
expected_dhcp_opts=03040a00000136040a000001
test_dhcp 12 2 f00000000002 08 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# Now add the dhcp option T1 to the dhcp options.
check ovn-nbctl --wait=hv set dhcp_options ${d1} options:T1=4000

ovn-sbctl dump-flows > sbflows2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST to make sure that T1 is in the reply dhcp options.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=$offer_ip
request_ip=0
src_ip=$offer_ip
dst_ip=$server_ip
# In the expected_dhcp_opts we should not see 330400000e10 which is
# dhcp lease time option.
expected_dhcp_opts=3a0400000fa0330400000e100104ffffff0003040a00000136040a000001
test_dhcp 13 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Now send DHCPINFORM again.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=00000000
request_ip=0
src_ip=$offer_ip
dst_ip=$server_ip
# In the expected_dhcp_opts we should not see 330400000e10 which is
# dhcp lease time option and 0104ffffff00 which is subnet mask option.
expected_dhcp_opts=03040a00000136040a000001
test_dhcp 14 2 f00000000002 08 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Set tftp server option (IPv4 address) for ls1
echo "------ Set tftp server (IPv4 address) --------"
check ovn-nbctl --wait=hv dhcp-options-set-options $d1 server_id=10.0.0.1 \
server_mac=ff:10:00:00:00:01 lease_time=3600 router=10.0.0.1 \
tftp_server=10.10.10.10

ovn-sbctl dump-flows > sbflows3
echo "----------------------------------------------"

# Send DHCPREQUEST in the SELECTING/INIT-REBOOT state with the offered IP
# address in the Requested IP Address option.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=$offer_ip
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a00000142040a0a0a0a
test_dhcp 15 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Set tftp server option (Hostname) for ls1
echo "------ Set tftp server (hostname) --------"
check ovn-nbctl --wait=hv dhcp-options-set-options $d1 server_id=10.0.0.1 \
server_mac=ff:10:00:00:00:01 lease_time=3600 router=10.0.0.1 \
tftp_server=\"test_tftp_server\"

ovn-sbctl dump-flows > sbflows4
echo "------------------------------------------"

# Send DHCPREQUEST in the SELECTING/INIT-REBOOT state with the offered IP
# address in the Requested IP Address option.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=$offer_ip
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a0000014210746573745f746674705f736572766572
test_dhcp 16 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Set domain search list option for ls1
echo "------ Set domain search list --------"
check ovn-nbctl --wait=hv dhcp-options-set-options $d1 server_id=10.0.0.1 \
server_mac=ff:10:00:00:00:01 lease_time=3600 router=10.0.0.1 \
domain_search_list=\"test1.com,test2.com\"

ovn-sbctl dump-flows > sbflows5
echo "------------------------------------------"

# Send DHCPREQUEST in the SELECTING/INIT-REBOOT state with the offered IP
# address in the Requested IP Address option.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=$offer_ip
expected_dhcp_opts=771305746573743103636f6d00057465737432c006330400000e100104ffffff0003040a00000136040a000001
test_dhcp 17 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

# test DHCPDECLINE
offer_ip=`ip_to_hex 10 0 0 4`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
expected_dhcp_opts=""
test_dhcp 18 1 f00000000001 04 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 02 $expected_dhcp_opts
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test 1 -le $(grep -F -i -c 'DHCPDECLINE from f0:00:00:00:00:01, 10.0.0.4 duplicated' hv1/ovn-controller.log)

}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "until test 1 -le \$(grep -F -i -c 'DHCPDECLINE from f0:00:00:00:00:01, 10.0.0.4 duplicated' hv1/ovn-controller.log)
"


# Send Etherboot.

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

check ovn-nbctl --all destroy dhcp-option

check ovn-nbctl dhcp-options-create 10.0.0.0/24
d3=$(ovn-nbctl --bare --columns=_uuid find dhcp_options cidr="10.0.0.0/24")
check ovn-nbctl dhcp-options-set-options $d3 \
   server_id=10.0.0.1 server_mac=ff:10:00:00:00:01 \
   lease_time=3600 router=10.0.0.1 bootfile_name_alt=\"bootfile_name_alt\" \
   bootfile_name=\"bootfile\"

check ovn-nbctl --wait=hv lsp-set-dhcpv4-options ls1-lp1 $d3

offer_ip=`ip_to_hex 10 0 0 4`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
boofile=4308626f6f7466696c65
expected_dhcp_opts=${boofile}330400000e100104ffffff0003040a00000136040a000001
test_dhcp 19 1 f00000000001 01 0 $ciaddr $offer_ip $request_ip 1 0 ff1000000001 $server_ip 02 $expected_dhcp_opts
compare_dhcp_packets 1

# Test that ovn-controller pinctrl thread handles dhcp requests when it
# connects to a wrong version of ovn-northd at startup.

# Stop ovn-northd so that we can modify the northd_version.
as northd
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6679"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "while kill -0 \$TMPPID 2>/dev/null"


northd_version=$(ovn-sbctl get SB_Global . options:northd_internal_version | sed s/\"//g)
echo "northd version = $northd_version"

check ovn-sbctl set SB_Global . options:northd_internal_version=foo

echo
echo "tests/ovn.at:6679: Stop ovn-controller."
as hv1
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6679"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "while kill -0 \$TMPPID 2>/dev/null"


echo
echo "tests/ovn.at:6679: Pin ovn-controller to ovn-northd version."

as hv1
check ovs-vsctl set open . external_ids:ovn-match-northd-version=true

# Start ovn-controller
as hv1
start_daemon ovn-controller

check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test 1 = $(grep -c "controller version - $northd_version mismatch with northd version - foo" hv1/ovn-controller.log)

}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "until test 1 = \$(grep -c \"controller version - \$northd_version mismatch with northd version - foo\" hv1/ovn-controller.log)
"


reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# ----------------------------------------------------------------------

offer_ip=`ip_to_hex 10 0 0 4`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
boofile=4308626f6f7466696c65
expected_dhcp_opts=${boofile}330400000e100104ffffff0003040a00000136040a000001
test_dhcp 20 1 f00000000001 01 0 $ciaddr $offer_ip $request_ip 1 0 ff1000000001 $server_ip 02 $expected_dhcp_opts
compare_dhcp_packets 1

# ----------------------------------------------------------------------

# Send unicast DHCPDISCOVER.
reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

offer_ip=`ip_to_hex 10 0 0 4`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
expected_dhcp_opts=4311626f6f7466696c655f6e616d655f616c74330400000e100104ffffff0003040a00000136040a000001
test_dhcp 21 1 f00000000001 01 0 $ciaddr $offer_ip $request_ip 0 1 $offer_ip $server_ip ff1000000001 $server_ip 02 $expected_dhcp_opts
compare_dhcp_packets 1

as hv1
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6679"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "while kill -0 \$TMPPID 2>/dev/null"


as ovn-sb
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6679"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "while kill -0 \$TMPPID 2>/dev/null"


as ovn-nb
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6679"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "while kill -0 \$TMPPID 2>/dev/null"

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_97
#AT_START_98
at_fn_group_banner 98 'ovn.at:6679' \
  "dhcpv4 : 1 HV, 2 LS, 2 LSPs/LS -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "98. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init


ovn_start

check ovn-nbctl ls-add ls1

check ovn-nbctl lsp-add ls1 ls1-lp1 \
-- lsp-set-addresses ls1-lp1 "f0:00:00:00:00:01 10.0.0.4"

check ovn-nbctl lsp-set-port-security ls1-lp1 "f0:00:00:00:00:01 10.0.0.4"

check ovn-nbctl lsp-add ls1 ls1-lp2 \
-- lsp-set-addresses ls1-lp2 "f0:00:00:00:00:02 10.0.0.6 20.0.0.4"

check ovn-nbctl lsp-set-port-security ls1-lp2 "f0:00:00:00:00:02 10.0.0.6 20.0.0.4"

check ovn-nbctl ls-add ls2
check ovn-nbctl lsp-add ls2 ls2-lp1 \
-- lsp-set-addresses ls2-lp1 "f0:00:00:00:00:03 30.0.0.6 40.0.0.4"
check ovn-nbctl lsp-set-port-security ls2-lp1 "f0:00:00:00:00:03 30.0.0.6 40.0.0.4"
check ovn-nbctl lsp-add ls2 ls2-lp2 \
-- lsp-set-addresses ls2-lp2 "f0:00:00:00:00:04 30.0.0.7"
check ovn-nbctl lsp-set-port-security ls2-lp2 "f0:00:00:00:00:04 30.0.0.7"

d1="$(ovn-nbctl create DHCP_Options cidr=10.0.0.0/24 \
options="\"server_id\"=\"10.0.0.1\" \"server_mac\"=\"ff:10:00:00:00:01\" \
\"lease_time\"=\"3600\" \"router\"=\"10.0.0.1\"")"

check ovn-nbctl lsp-set-dhcpv4-options ls1-lp1 ${d1}
check ovn-nbctl lsp-set-dhcpv4-options ls1-lp2 ${d1}

d2="$(ovn-nbctl create DHCP_Options cidr=30.0.0.0/24 \
options="\"server_id\"=\"30.0.0.1\" \"server_mac\"=\"ff:10:00:00:00:02\" \
\"lease_time\"=\"3600\"")"

check ovn-nbctl lsp-set-dhcpv4-options ls2-lp2 ${d2}

net_add n1
sim_add hv1

as hv1
check ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
check ovs-vsctl -- add-port br-int hv1-vif1 -- \
    set interface hv1-vif1 external-ids:iface-id=ls1-lp1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

check ovs-vsctl -- add-port br-int hv1-vif2 -- \
    set interface hv1-vif2 external-ids:iface-id=ls1-lp2 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=2

check ovs-vsctl -- add-port br-int hv1-vif3 -- \
    set interface hv1-vif3 external-ids:iface-id=ls2-lp1 \
    options:tx_pcap=hv1/vif3-tx.pcap \
    options:rxq_pcap=hv1/vif3-rx.pcap \
    ofport-request=3

check ovs-vsctl -- add-port br-int hv1-vif4 -- \
    set interface hv1-vif4 external-ids:iface-id=ls2-lp2 \
    options:tx_pcap=hv1/vif4-tx.pcap \
    options:rxq_pcap=hv1/vif4-rx.pcap \
    ofport-request=4

as hv1 ovs-appctl vlog/set dbg

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure
$at_traceon; }


wait_for_ports_up
check ovn-nbctl --wait=hv sync

as hv1 ovs-vsctl show

# This shell function sends a DHCP request packet
#
# The first argument is just the number of calls to this function so
# far (1, 2, ...).  This is redundant, but it makes it easier to find
# the failures by searching for the number.
#
# test_dhcp PACKET_NUM INPORT SRC_MAC DHCP_TYPE BROADCAST CIADDR OFFER_IP REQUEST_IP ETH_BOOT USE_IP ...
packet_num=0
test_dhcp() {
    local expect_resume=:
    local trace=false
    while :; do
        case $1 in
            (--no-resume) expect_resume=false; shift ;;
            # --trace isn't used but it can be useful for debugging:
            (--trace) trace=:; shift ;;
            (*) break ;;
        esac
    done

    packet_num=$(expr $packet_num + 1)
    printf "%s\n" "ovn.at:6679" >"$at_check_line_file"
(test $packet_num != $1) \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:6679"
    shift

    local inport=$1 src_mac=$2 dhcp_type=$3 broadcast=$4 ciaddr=$5 offer_ip=$6 request_ip=$7 eth_boot=$8 use_ip=$9
    shift; shift; shift; shift; shift; shift; shift; shift; shift;

    if test $use_ip != 0; then
        src_ip=$1
        dst_ip=$2
        shift; shift;
    else
        src_ip=`ip_to_hex 0 0 0 0`
        dst_ip=`ip_to_hex 255 255 255 255`
    fi

    sed 'h;s/./-/g;s/^.../## /;s/...$/ ##/;p;x;p;x' <<_ASBOX
## dhcp test packet $packet_num ##
_ASBOX

    as hv1
    if test -f hv1/ovs-ofctl.pid; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: test -e \$OVS_RUNDIR/ovs-ofctl.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-ofctl.pid" "ovn.at:6679"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-ofctl.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-ofctl.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovs-appctl --timeout=10 -t ovs-ofctl exit"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-ofctl exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "while kill -0 \$TMPPID 2>/dev/null"

        printf "%s\n" "ovn.at:6679" >"$at_check_line_file"
(test -f ovs-ofctl.pid) \
  && at_fn_check_skip 99 "$at_srcdir/ovn.at:6679"
    fi

    ovs-ofctl monitor br-int resume --detach --no-chdir \
        --pidfile=ovs-ofctl.pid 2> ofctl_monitor$packet_num.log

    echo "inport=$inport src_mac=$src_mac dhcp_type=$dhcp_type broadcast=$broadcast ciaddr=$ciaddr offer_ip=$offer_ip request_ip=$request_ip use_ip=$use_ip src_ip=$src_ip dst_ip=$dst_ip"

    if test $request_ip != 0; then
        if test $eth_boot != 0; then
            ip_len=0124
            udp_len=010f
        else
            ip_len=0120
            udp_len=010b
        fi
    else
        if test $eth_boot != 0; then
            ip_len=011e
            udp_len=010a
        else
            ip_len=011a
            udp_len=0106
        fi
    fi

    if test $broadcast != 0; then
        flags=8000
        reply_dst_ip=`ip_to_hex 255 255 255 255`
    else
        flags=0000
        reply_dst_ip=${offer_ip}
    fi

    if test "$dhcp_type" = "04"; then
        ciaddr=$offer_ip
    fi

    local request=ffffffffffff${src_mac}08004510${ip_len}0000000080110000${src_ip}${dst_ip}
    # udp header and dhcp header
    request=${request}00440043${udp_len}0000
    request=${request}010106006359aa760000${flags}${ciaddr}000000000000000000000000${src_mac}
    # client hardware padding
    request=${request}00000000000000000000
    # server hostname
    request=${request}0000000000000000000000000000000000000000000000000000000000000000
    request=${request}0000000000000000000000000000000000000000000000000000000000000000
    # boot file name
    request=${request}0000000000000000000000000000000000000000000000000000000000000000
    request=${request}0000000000000000000000000000000000000000000000000000000000000000
    request=${request}0000000000000000000000000000000000000000000000000000000000000000
    request=${request}0000000000000000000000000000000000000000000000000000000000000000
    # dhcp magic cookie
    request=${request}63825363
    # dhcp message type
    request=${request}3501${dhcp_type}
    # dhcp unknown option
    request=${request}d70701020304050607
    # dhcp pad option
    request=${request}00
    if test $request_ip != 0; then
        # dhcp requested ip
        request=${request}3204${request_ip}
    fi
    if test $eth_boot != 0; then
        request=${request}af020000
    fi
    # dhcp end option
    request=${request}ff
    tcpdump_hex "-- sending DHCP request on hv1-vif$inport" $request

    for port in $inport "$@"; do
        : >> $port.expected
    done
    if test $offer_ip != 0; then
        local srv_mac=$1 srv_ip=$2 dhcp_reply_type=$3 expected_dhcp_opts=$4
        local offered_ip=$offer_ip
        if [ "$dhcp_type" == "08" ]; then
            # DHCP ACK for DHCP INFORM should not have any offer ip.
            offered_ip=00000000
        fi

        # total IP length will be the IP length of the request packet
        # (which is 272 in our case) + 8 (padding bytes) + (expected_dhcp_opts / 2)
        ip_len=`expr 280 + ${#expected_dhcp_opts} / 2`
        udp_len=`expr $ip_len - 20`
        ip_len=$(printf "%x" $ip_len)
        udp_len=$(printf "%x" $udp_len)
        # $ip_len var will be in 3 digits i.e 134. So adding a '0' before $ip_len
        local reply=${src_mac}${srv_mac}0800
        local ip_header=45100${ip_len}0000000080110000${srv_ip}${reply_dst_ip}
        reply=${reply}$(ip4_csum_inplace $ip_header)
        # udp header and dhcp header.
        # $udp_len var will be in 3 digits. So adding a '0' before $udp_len
        reply=${reply}004300440${udp_len}0000020106006359aa760000${flags}${ciaddr}
        # your ip address; 0 for NAK
        if test $dhcp_reply_type = 06; then
            reply=${reply}00000000
        else
            reply=${reply}${offered_ip}
        fi
        # next server ip address, relay agent ip address, client mac address
        reply=${reply}0000000000000000${src_mac}
        # client hardware padding
        reply=${reply}00000000000000000000
        # server hostname
        reply=${reply}0000000000000000000000000000000000000000000000000000000000000000
        reply=${reply}0000000000000000000000000000000000000000000000000000000000000000
        # boot file name
        reply=${reply}0000000000000000000000000000000000000000000000000000000000000000
        reply=${reply}0000000000000000000000000000000000000000000000000000000000000000
        reply=${reply}0000000000000000000000000000000000000000000000000000000000000000
        reply=${reply}0000000000000000000000000000000000000000000000000000000000000000
        # dhcp magic cookie
        reply=${reply}63825363
        reply=${reply}3501${dhcp_reply_type}${expected_dhcp_opts}00000000ff00000000
        echo $reply >> $inport.expected
        tcpdump_hex "-- expecting DHCP reply on $inport" $request
    else
        for outport; do
            echo $request >> $outport.expected
        done
    fi
    if $trace; then
        as hv1 ovs-appctl ofproto/trace br-int in_port=hv1-vif$inport $request > trace$packet_num

    else
        check as hv1 ovs-appctl netdev-dummy/receive hv1-vif$inport $request
    fi

    # NXT_RESUMEs should be 1.
    if $expect_resume; then
        check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test 1 = `cat ofctl_monitor$packet_num.log | grep -c NXT_RESUME`
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "until test 1 = \`cat ofctl_monitor\$packet_num.log | grep -c NXT_RESUME\`"

    fi
}

compare_dhcp_packets() {
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif\$1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif$1-tx.pcap " "ovn.at:6679"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif$1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num"
$at_traceon; }

   ovn_check_packets__ "hv1/vif$1-tx.pcap" "$1.expected" "tests/ovn.at:6679"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6679"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
if $at_failed
then :
  dump_diff__ "hv1/vif$1-tx.pcap" "$1.expected"
fi
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num"
$at_traceon; }

}


ovn-sbctl dump-flows > sbflows

# ----------------------------------------------------------------------

# Send DHCPDISCOVER.
offer_ip=`ip_to_hex 10 0 0 4`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a000001
test_dhcp 1 1 f00000000001 01 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 02 $expected_dhcp_opts
compare_dhcp_packets 1

# ----------------------------------------------------------------------

# ovs-ofctl also resumes the packets and this causes other ports to receive
# the DHCP request packet. So reset the pcap files so that its easier to test.
reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST in the SELECTING/INIT-REBOOT state with the offered IP
# address in the Requested IP Address option.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=$offer_ip
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a000001
test_dhcp 2 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST in the SELECTING/INIT-REBOOT state with a mismatched IP in
# the Requested IP Address option, expect a DHCPNAK.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=`ip_to_hex 10 0 0 7`
expected_dhcp_opts=""
test_dhcp 3 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 06 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------
reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send Invalid DHCPv4 packet on ls1-lp2. It should be received by ovn-controller
# but should be resumed without the reply.
# ls1-lp1 (vif1-tx.pcap) should receive the DHCPv4 request packet twice,
# one from ovn-controller and the other from "ovs-ofctl resume."
ciaddr=`ip_to_hex 0 0 0 0`
offer_ip=0
request_ip=0
test_dhcp 4 2 f00000000002 09 0 $ciaddr $offer_ip $request_ip 0 0 1 1

# NXT_RESUMEs should be 4.
# vif1-tx.pcap should have received the DHCPv4 (invalid) request packet
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap " "ovn.at:6679"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif1-tx.pcap" "1.expected" "tests/ovn.at:6679"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6679"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
if $at_failed
then :
  dump_diff__ "hv1/vif1-tx.pcap" "1.expected"
fi
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows"
$at_traceon; }


# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# NXT_RESUMEs should be 4.
# Send DHCPREQUEST in the RENEWING/REBINDING state with ip4.src set to 10.0.0.6
# and ip4.dst set to 10.0.0.1.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=$offer_ip
request_ip=0
src_ip=$offer_ip
dst_ip=$server_ip
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a000001
test_dhcp 5 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST in the RENEWING/REBINDING state with ip4.src set to 10.0.0.6
# and ip4.dst set to 255.255.255.255.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=$offer_ip
request_ip=0
src_ip=$offer_ip
dst_ip=`ip_to_hex 255 255 255 255`
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a000001
test_dhcp 6 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST in the RENEWING/REBINDING state with a mismatched IP in the
# ciaddr, expect a DHCPNAK.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 10 0 0 7`
request_ip=0
src_ip=$offer_ip
dst_ip=`ip_to_hex 255 255 255 255`
expected_dhcp_opts=""
test_dhcp 7 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 06 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST in the RENEWING/REBINDING state without a specifyied ciaddr,
# expect a DHCPNAK.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
src_ip=$offer_ip
dst_ip=`ip_to_hex 255 255 255 255`
expected_dhcp_opts=""
test_dhcp 8 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 06 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST with ip4.src set to 10.0.0.6 and ip4.dst set to 10.0.0.4.
# The packet should not be received by ovn-controller.
ciaddr=`ip_to_hex 0 0 0 0`
src_ip=`ip_to_hex 10 0 0 6`
dst_ip=`ip_to_hex 10 0 0 4`
test_dhcp --no-resume 9 2 f00000000002 03 0 $ciaddr 0 0 0 1 $src_ip $dst_ip 1

# vif1-tx.pcap should have received the DHCPv4 request packet
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap " "ovn.at:6679"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif1-tx.pcap" "1.expected" "tests/ovn.at:6679"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:6679"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
if $at_failed
then :
  dump_diff__ "hv1/vif1-tx.pcap" "1.expected"
fi
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows"
$at_traceon; }


# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPDISCOVER with BROADCAST flag on.
offer_ip=`ip_to_hex 10 0 0 4`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a000001
test_dhcp 10 1 f00000000001 01 1 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 02 $expected_dhcp_opts
compare_dhcp_packets 1

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPRELEASE.
offer_ip=0
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 10 0 0 6`
request_ip=0
expected_dhcp_opts=0
test_dhcp 11 2 f00000000002 07 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001

# There is no reply for this. Check for the INFO log in ovn-controller.log
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test 1 = $(cat hv1/ovn-controller.log | grep "DHCPRELEASE f0:00:00:00:00:02 10.0.0.6" -c)

}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "until test 1 = \$(cat hv1/ovn-controller.log | grep \"DHCPRELEASE f0:00:00:00:00:02 10.0.0.6\" -c)
"


$PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap > 2.packets
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: cat 2.packets"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; cat 2.packets
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows"
$at_traceon; }


# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPINFORM
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=$offer_ip
request_ip=0
src_ip=$offer_ip
dst_ip=$server_ip
# In the expected_dhcp_opts we should not see 330400000e10 which is
# dhcp lease time option and 0104ffffff00 which is subnet mask option.
expected_dhcp_opts=03040a00000136040a000001
test_dhcp 12 2 f00000000002 08 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# Now add the dhcp option T1 to the dhcp options.
check ovn-nbctl --wait=hv set dhcp_options ${d1} options:T1=4000

ovn-sbctl dump-flows > sbflows2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Send DHCPREQUEST to make sure that T1 is in the reply dhcp options.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=$offer_ip
request_ip=0
src_ip=$offer_ip
dst_ip=$server_ip
# In the expected_dhcp_opts we should not see 330400000e10 which is
# dhcp lease time option.
expected_dhcp_opts=3a0400000fa0330400000e100104ffffff0003040a00000136040a000001
test_dhcp 13 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Now send DHCPINFORM again.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=00000000
request_ip=0
src_ip=$offer_ip
dst_ip=$server_ip
# In the expected_dhcp_opts we should not see 330400000e10 which is
# dhcp lease time option and 0104ffffff00 which is subnet mask option.
expected_dhcp_opts=03040a00000136040a000001
test_dhcp 14 2 f00000000002 08 0 $ciaddr $offer_ip $request_ip 0 1 $src_ip $dst_ip ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Set tftp server option (IPv4 address) for ls1
echo "------ Set tftp server (IPv4 address) --------"
check ovn-nbctl --wait=hv dhcp-options-set-options $d1 server_id=10.0.0.1 \
server_mac=ff:10:00:00:00:01 lease_time=3600 router=10.0.0.1 \
tftp_server=10.10.10.10

ovn-sbctl dump-flows > sbflows3
echo "----------------------------------------------"

# Send DHCPREQUEST in the SELECTING/INIT-REBOOT state with the offered IP
# address in the Requested IP Address option.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=$offer_ip
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a00000142040a0a0a0a
test_dhcp 15 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Set tftp server option (Hostname) for ls1
echo "------ Set tftp server (hostname) --------"
check ovn-nbctl --wait=hv dhcp-options-set-options $d1 server_id=10.0.0.1 \
server_mac=ff:10:00:00:00:01 lease_time=3600 router=10.0.0.1 \
tftp_server=\"test_tftp_server\"

ovn-sbctl dump-flows > sbflows4
echo "------------------------------------------"

# Send DHCPREQUEST in the SELECTING/INIT-REBOOT state with the offered IP
# address in the Requested IP Address option.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=$offer_ip
expected_dhcp_opts=330400000e100104ffffff0003040a00000136040a0000014210746573745f746674705f736572766572
test_dhcp 16 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# Set domain search list option for ls1
echo "------ Set domain search list --------"
check ovn-nbctl --wait=hv dhcp-options-set-options $d1 server_id=10.0.0.1 \
server_mac=ff:10:00:00:00:01 lease_time=3600 router=10.0.0.1 \
domain_search_list=\"test1.com,test2.com\"

ovn-sbctl dump-flows > sbflows5
echo "------------------------------------------"

# Send DHCPREQUEST in the SELECTING/INIT-REBOOT state with the offered IP
# address in the Requested IP Address option.
offer_ip=`ip_to_hex 10 0 0 6`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=$offer_ip
expected_dhcp_opts=771305746573743103636f6d00057465737432c006330400000e100104ffffff0003040a00000136040a000001
test_dhcp 17 2 f00000000002 03 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 05 $expected_dhcp_opts
compare_dhcp_packets 2

# ----------------------------------------------------------------------

# test DHCPDECLINE
offer_ip=`ip_to_hex 10 0 0 4`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
expected_dhcp_opts=""
test_dhcp 18 1 f00000000001 04 0 $ciaddr $offer_ip $request_ip 0 0 ff1000000001 $server_ip 02 $expected_dhcp_opts
check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test 1 -le $(grep -F -i -c 'DHCPDECLINE from f0:00:00:00:00:01, 10.0.0.4 duplicated' hv1/ovn-controller.log)

}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "until test 1 -le \$(grep -F -i -c 'DHCPDECLINE from f0:00:00:00:00:01, 10.0.0.4 duplicated' hv1/ovn-controller.log)
"


# Send Etherboot.

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

check ovn-nbctl --all destroy dhcp-option

check ovn-nbctl dhcp-options-create 10.0.0.0/24
d3=$(ovn-nbctl --bare --columns=_uuid find dhcp_options cidr="10.0.0.0/24")
check ovn-nbctl dhcp-options-set-options $d3 \
   server_id=10.0.0.1 server_mac=ff:10:00:00:00:01 \
   lease_time=3600 router=10.0.0.1 bootfile_name_alt=\"bootfile_name_alt\" \
   bootfile_name=\"bootfile\"

check ovn-nbctl --wait=hv lsp-set-dhcpv4-options ls1-lp1 $d3

offer_ip=`ip_to_hex 10 0 0 4`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
boofile=4308626f6f7466696c65
expected_dhcp_opts=${boofile}330400000e100104ffffff0003040a00000136040a000001
test_dhcp 19 1 f00000000001 01 0 $ciaddr $offer_ip $request_ip 1 0 ff1000000001 $server_ip 02 $expected_dhcp_opts
compare_dhcp_packets 1

# Test that ovn-controller pinctrl thread handles dhcp requests when it
# connects to a wrong version of ovn-northd at startup.

# Stop ovn-northd so that we can modify the northd_version.
as northd
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:6679"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "while kill -0 \$TMPPID 2>/dev/null"


northd_version=$(ovn-sbctl get SB_Global . options:northd_internal_version | sed s/\"//g)
echo "northd version = $northd_version"

check ovn-sbctl set SB_Global . options:northd_internal_version=foo

echo
echo "tests/ovn.at:6679: Stop ovn-controller."
as hv1
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6679"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "while kill -0 \$TMPPID 2>/dev/null"


echo
echo "tests/ovn.at:6679: Pin ovn-controller to ovn-northd version."

as hv1
check ovs-vsctl set open . external_ids:ovn-match-northd-version=true

# Start ovn-controller
as hv1
start_daemon ovn-controller

check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test 1 = $(grep -c "controller version - $northd_version mismatch with northd version - foo" hv1/ovn-controller.log)

}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "until test 1 = \$(grep -c \"controller version - \$northd_version mismatch with northd version - foo\" hv1/ovn-controller.log)
"


reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

# ----------------------------------------------------------------------

offer_ip=`ip_to_hex 10 0 0 4`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
boofile=4308626f6f7466696c65
expected_dhcp_opts=${boofile}330400000e100104ffffff0003040a00000136040a000001
test_dhcp 20 1 f00000000001 01 0 $ciaddr $offer_ip $request_ip 1 0 ff1000000001 $server_ip 02 $expected_dhcp_opts
compare_dhcp_packets 1

# ----------------------------------------------------------------------

# Send unicast DHCPDISCOVER.
reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2
rm -f 1.expected
rm -f 2.expected

offer_ip=`ip_to_hex 10 0 0 4`
server_ip=`ip_to_hex 10 0 0 1`
ciaddr=`ip_to_hex 0 0 0 0`
request_ip=0
expected_dhcp_opts=4311626f6f7466696c655f6e616d655f616c74330400000e100104ffffff0003040a00000136040a000001
test_dhcp 21 1 f00000000001 01 0 $ciaddr $offer_ip $request_ip 0 1 $offer_ip $server_ip ff1000000001 $server_ip 02 $expected_dhcp_opts
compare_dhcp_packets 1

as hv1
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:6679"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "while kill -0 \$TMPPID 2>/dev/null"


as ovn-sb
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6679"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "while kill -0 \$TMPPID 2>/dev/null"


as ovn-nb
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:6679"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:6679: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:6679"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:6679"
$at_failed && at_fn_log_failure  \
"ofctl_monitor$packet_num.log" \
"trace$packet_num" \
"sbflows" \
"sbflows2" \
"sbflows3" \
"sbflows4" \
"sbflows5"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:6679" "while kill -0 \$TMPPID 2>/dev/null"

ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_98
#AT_START_99
at_fn_group_banner 99 'ovn.at:7396' \
  "dhcpv6 : 1 HV, 2 LS, 5 LSPs -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "99. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

printf "%s\n" "ovn.at:7396" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:7396"
ovn_start

check ovn-nbctl ls-add ls1
check ovn-nbctl lsp-add ls1 ls1-lp1 \
-- lsp-set-addresses ls1-lp1 "f0:00:00:00:00:01 10.0.0.4 ae70::4"

check ovn-nbctl lsp-set-port-security ls1-lp1 "f0:00:00:00:00:01 10.0.0.4 ae70::4"

check ovn-nbctl lsp-add ls1 ls1-lp2 \
-- lsp-set-addresses ls1-lp2 "f0:00:00:00:00:02 ae70::5"

check ovn-nbctl lsp-set-port-security ls1-lp2 "f0:00:00:00:00:02 ae70::5"

check ovn-nbctl lsp-add ls1 ls1-lp3 \
-- lsp-set-addresses ls1-lp3 "f0:00:00:00:00:22 ae70::22"

check ovn-nbctl lsp-set-port-security ls1-lp3 "f0:00:00:00:00:22 ae70::22"

d1="$(ovn-nbctl create DHCP_Options cidr="ae70\:\:/64" \
options="\"server_id\"=\"00:00:00:10:00:01\"")"

check ovn-nbctl lsp-set-dhcpv6-options ls1-lp1 ${d1}
check ovn-nbctl lsp-set-dhcpv6-options ls1-lp2 ${d1}

d2="$(ovn-nbctl create DHCP_Options cidr="ae70\:\:/64" \
options="\"dhcpv6_stateless\"=\"true\" \"server_id\"=\"00:00:00:10:00:01\"")"

check ovn-nbctl lsp-set-dhcpv6-options ls1-lp3 ${d2}

check ovn-nbctl ls-add ls2
check ovn-nbctl lsp-add ls2 ls2-lp1 \
-- lsp-set-addresses ls2-lp1 "f0:00:00:00:00:03 be70::3"
check ovn-nbctl lsp-set-port-security ls2-lp1 "f0:00:00:00:00:03 be70::3"
check ovn-nbctl lsp-add ls2 ls2-lp2 \
-- lsp-set-addresses ls2-lp2 "f0:00:00:00:00:04 be70::4"
check ovn-nbctl lsp-set-port-security ls2-lp2 "f0:00:00:00:00:04 be70::4"

net_add n1
sim_add hv1

as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int hv1-vif1 -- \
    set interface hv1-vif1 external-ids:iface-id=ls1-lp1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

ovs-vsctl -- add-port br-int hv1-vif2 -- \
    set interface hv1-vif2 external-ids:iface-id=ls1-lp2 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=2

ovs-vsctl -- add-port br-int hv1-vif3 -- \
    set interface hv1-vif3 external-ids:iface-id=ls2-lp1 \
    options:tx_pcap=hv1/vif3-tx.pcap \
    options:rxq_pcap=hv1/vif3-rx.pcap \
    ofport-request=3

ovs-vsctl -- add-port br-int hv1-vif4 -- \
    set interface hv1-vif4 external-ids:iface-id=ls2-lp2 \
    options:tx_pcap=hv1/vif4-tx.pcap \
    options:rxq_pcap=hv1/vif4-rx.pcap \
    ofport-request=4

ovs-vsctl -- add-port br-int hv1-vif5 -- \
    set interface hv1-vif5 external-ids:iface-id=ls1-lp3 \
    options:tx_pcap=hv1/vif5-tx.pcap \
    options:rxq_pcap=hv1/vif5-rx.pcap \
    ofport-request=5

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure
$at_traceon; }


wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Start with 0 because the first request will not have NXT_RESUME
n_resume=0

# This shell function sends a DHCPv6 request packet
# test_dhcpv6 INPORT SRC_MAC SRC_LLA DHCPv6_MSG_TYPE OFFER_IP OUTPORT...
# The OUTPORTs (zero or more) list the VIFs on which the original DHCPv6
# packet should be received twice (one from ovn-controller and the other
# from the "ovs-ofctl monitor br-int resume"
test_dhcpv6() {
    local inport=$1 src_mac=$2 src_lla=$3 msg_code=$4 offer_ip=$5 boot_file=$6
    local fqdn=$7

    local req_scapy="Ether(dst='33:33:00:01:00:02', src='${src_mac}')/ \
                     IPv6(dst='ff02::1:2', src='${src_lla}')/ \
                     UDP(sport=546, dport=547)/ \
                     DHCP6(msgtype=${msg_code}, trid=0x010203)/ \
                     DHCP6OptClientId(duid=DUID_LL(lladdr='${src_mac}'))"

    # Add IA-NA (Identity Association for Non Temporary Address) if msg_code
    # is not 11 (information request packet)
    if test $msg_code != 11; then
        req_scapy="${req_scapy}/DHCP6OptIA_NA(iaid=0x01020304, T1=3600, T2=5400)"
    fi
    if test "$boot_file" = "bootfile_name"; then
        local uc_data="USER_CLASS_DATA(data=b'iPXE')"
        req_scapy="${req_scapy}/DHCP6OptUserClass(userclassdata=[${uc_data}])"
    fi
    if test -n "$fqdn"; then
        req_scapy="${req_scapy}/DHCP6OptClientFQDN(flags=0x01, fqdn=b'test')"
    fi
    request=$(fmt_pkt "${req_scapy}")
    shift; shift; shift; shift; shift; shift; shift;
    if test $offer_ip != 0; then
        local reply_code=7
        if test $msg_code = 1; then
            reply_code=2
        fi

        local rep_scapy="Ether(dst='${src_mac}', src='00:00:00:10:00:01')/ \
                         IPv6(dst='${src_lla}', src='fe80::0200:00ff:fe10:0001')/ \
                         UDP(sport=547, dport=546)/ \
                         DHCP6(msgtype=${reply_code}, trid=0x010203)/ \
                         DHCP6OptClientId(duid=DUID_LL(lladdr='${src_mac}'))"

        if test $offer_ip != 1; then
            local ip_scapy="DHCP6OptIAAddress(addr='${offer_ip}', \
                            preflft=0xffffffff, validlft=0xffffffff)"
            rep_scapy="${rep_scapy}/ \
                       DHCP6OptIA_NA(iaid=0x01020304, T1=0xffffffff, \
                       T2=0xffffffff, ianaopts=[${ip_scapy}])"
        fi
        if test -n "$boot_file"; then
            rep_scapy="${rep_scapy}/DHCP6OptBootFileUrl(optdata=b'${boot_file}')"
        fi
        if test -n "$fqdn"; then
            rep_scapy="${rep_scapy}/DHCP6OptClientFQDN(flags=0x06, fqdn=b'${fqdn}')"
        fi
        rep_scapy="${rep_scapy}/DHCP6OptServerId(duid=DUID_LL(lladdr='00:00:00:10:00:01'))"
        reply=$(fmt_pkt "${rep_scapy}")
        echo $reply | trim_zeros >> $inport.expected
    else
        for outport; do
            echo $request | trim_zeros >> $outport.expected
        done
    fi

    as hv1 ovs-appctl netdev-dummy/receive hv1-vif$inport $request
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test $n_resume = `cat ofctl_monitor*.log | grep -c NXT_RESUME`
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "until test \$n_resume = \`cat ofctl_monitor*.log | grep -c NXT_RESUME\`"

    n_resume=$((n_resume + 1))
}

test_dhcpv6_release() {
    local inport=$1 src_mac=$2 src_lla=$3 offer_ip=$4

    local ip_scapy="DHCP6OptIAAddress(addr='${offer_ip}', preflft=0xffffffff, validlft=0xffffffff)"
    local req_scapy="Ether(dst='33:33:00:01:00:02', src='${src_mac}')/ \
                     IPv6(dst='ff02::1:2', src='${src_lla}')/ \
                     UDP(sport=546, dport=547)/ \
                     DHCP6(msgtype=8, trid=0x010203)/ \
                     DHCP6OptClientId(duid=DUID_LL(lladdr='${src_mac}'))/ \
                     DHCP6OptServerId(duid=DUID_LL(lladdr='00:00:00:10:00:01'))/ \
                     DHCP6OptIA_NA(iaid=0x01020304, T1=0xffffffff, T2=0xffffffff, ianaopts=[${ip_scapy}])"

    request=$(fmt_pkt "${req_scapy}")

    local rep_scapy="Ether(dst='${src_mac}', src='00:00:00:10:00:01')/ \
                     IPv6(dst='${src_lla}', src='fe80::0200:00ff:fe10:0001')/ \
                     UDP(sport=547, dport=546)/ \
                     DHCP6(msgtype=7, trid=0x010203)/ \
                     DHCP6OptClientId(duid=DUID_LL(lladdr='${src_mac}'))/ \
                     DHCP6OptServerId(duid=DUID_LL(lladdr='00:00:00:10:00:01'))/ \
                     DHCP6OptStatusCode(statuscode=0)"

    reply=$(fmt_pkt "${rep_scapy}")
    echo $reply | trim_zeros >> $inport.expected

    as hv1 ovs-appctl netdev-dummy/receive hv1-vif$inport $request
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test $n_resume = `cat ofctl_monitor*.log | grep -c NXT_RESUME`
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "until test \$n_resume = \`cat ofctl_monitor*.log | grep -c NXT_RESUME\`"

    n_resume=$((n_resume + 1))
}

check_packets() {
    local port=$1

    # Skipping UDP checksum
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif\$port-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif$port-tx.pcap " "ovn.at:7396"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif$port-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv1/vif$port-tx.pcap" "$port.expected" "tests/ovn.at:7396" "trim_zeros | cut -c 1-120,125-"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7396"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
if $at_failed
then :
  dump_diff__ "hv1/vif$port-tx.pcap" "$port.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

    rm $port.expected
}

check_empty_packets() {
    local port=$1

    $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif$port-tx.pcap | trim_zeros > $port.packets
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: cat \$port.packets"
at_fn_check_prepare_dynamic "cat $port.packets" "ovn.at:7396"
( $at_check_trace; cat $port.packets
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure
$at_traceon; }


    rm $port.packets
}


as hv1 ovs-ofctl monitor br-int resume --timeout=120 --detach --no-chdir \
--pidfile=ovs-ofctl0.pid 2> ofctl_monitor0.log

echo "---------NB dump-----"
ovn-nbctl show
echo "---------------------"
echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list logical_flow
echo "---------------------"

#ovn-sbctl dump-flows > sbflows


echo "------ hv1 dump ----------"
as hv1 ovs-ofctl dump-flows br-int

# Send DHCPv6 packet on ls2-lp1. native DHCPv6 is disabled on this port.
# There should be no DHCPv6 reply from ovn-controller and the request packet
# should be received by ls2-lp2.

src_mac="f0:00:00:00:00:03"
src_lla="fe80::f200:00ff:fe00:0003"
test_dhcpv6 3 $src_mac $src_lla 1 0 "" "" 4

# vif3-tx.pcap should not have received the DHCPv6 reply packet
check_empty 3

# vif4-tx.pcap should have received the DHCPv6 request packet
check_packets 4

src_mac="f0:00:00:00:00:01"
src_lla="fe80::f200:00ff:fe00:0001"
offer_ip="ae70::4"

test_dhcpv6 1 $src_mac $src_lla 1 $offer_ip "" ""
check_packets 1

reset_pcap_file hv1-vif1 hv1/vif1

test_dhcpv6_release 1 $src_mac $src_lla $offer_ip
check_packets 1

# Send invalid packet on ls1-lp2. ovn-controller should resume the packet
# without any modifications and the packet should be received by ls1-lp1.
# ls1-lp1 will receive the packet twice, one from the ovn-controller after the
# resume and the other from ovs-ofctl monitor resume.

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2

src_mac="f0:00:00:00:00:02"
src_lla="fe80::f200:00ff:fe00:0002"
offer_ip="ae70::5"
# Set invalid msg_type

test_dhcpv6 2 $src_mac $src_lla 16 0 "" "" 1 1

# vif2-tx.pcap should not have received the DHCPv6 reply packet
check_empty 2

# vif1-tx.pcap should have received the DHCPv6 (invalid) request packet
check_packets 1

# Send DHCPv6 packet on ls1-lp3. native DHCPv6 works as stateless mode for this port.
# The DHCPv6 reply shouldn't contain offer_ip.
src_mac="f0:00:00:00:00:22"
src_lla="fe80::f200:00ff:fe00:0022"
reset_pcap_file hv1-vif5 hv1/vif5

test_dhcpv6 5 $src_mac $src_lla 1 1 "" "" 5
check_packets 5

# Send DHCPv6 information request (code 11) on ls1-lp3. The DHCPv6 reply
# shouldn't contain offer_ip
src_mac="f0:00:00:00:00:22"
src_lla="fe80::f200:00ff:fe00:0022"
reset_pcap_file hv1-vif5 hv1/vif5

test_dhcpv6 5 $src_mac $src_lla 11 1 "" "" 5
check_packets 5

check ovn-nbctl --all destroy dhcp-option
d1="$(ovn-nbctl create DHCP_Options cidr="ae70\:\:/64")"
check ovn-nbctl dhcp-options-set-options $d1 \
    server_id=00:00:00:10:00:01 \
    bootfile_name_alt=\"bootfile_name_alt\" \
    bootfile_name=\"bootfile_name\"
check ovn-nbctl --wait=hv lsp-set-dhcpv6-options ls1-lp2 ${d1}

reset_pcap_file hv1-vif2 hv1/vif2

src_mac="f0:00:00:00:00:02"
src_lla="fe80::f200:00ff:fe00:0002"
offer_ip="ae70::5"

test_dhcpv6 2 $src_mac $src_lla 1 $offer_ip "bootfile_name_alt" ""
check_packets 2

reset_pcap_file hv1-vif2 hv1/vif2

test_dhcpv6_release 2 $src_mac $src_lla $offer_ip
check_packets 2

reset_pcap_file hv1-vif2 hv1/vif2

test_dhcpv6 2 $src_mac $src_lla 1 $offer_ip "bootfile_name" ""
check_packets 2

reset_pcap_file hv1-vif2 hv1/vif2

test_dhcpv6_release 2 $src_mac $src_lla $offer_ip
check_packets 2

check ovn-nbctl --all destroy dhcp-option
d1="$(ovn-nbctl create DHCP_Options cidr="ae70\:\:/64")"
check ovn-nbctl dhcp-options-set-options $d1 \
    server_id=00:00:00:10:00:01 \
    fqdn=\"ovn.org\"
check ovn-nbctl --wait=hv lsp-set-dhcpv6-options ls1-lp2 ${d1}

reset_pcap_file hv1-vif2 hv1/vif2

test_dhcpv6 2 $src_mac $src_lla 1 $offer_ip "" "ovn.org"
check_packets 2

reset_pcap_file hv1-vif2 hv1/vif2

test_dhcpv6_release 2 $src_mac $src_lla $offer_ip
check_packets 2



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7396"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7396"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7396"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_99
#AT_START_100
at_fn_group_banner 100 'ovn.at:7396' \
  "dhcpv6 : 1 HV, 2 LS, 5 LSPs -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "100. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

printf "%s\n" "ovn.at:7396" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:7396"
ovn_start

check ovn-nbctl ls-add ls1
check ovn-nbctl lsp-add ls1 ls1-lp1 \
-- lsp-set-addresses ls1-lp1 "f0:00:00:00:00:01 10.0.0.4 ae70::4"

check ovn-nbctl lsp-set-port-security ls1-lp1 "f0:00:00:00:00:01 10.0.0.4 ae70::4"

check ovn-nbctl lsp-add ls1 ls1-lp2 \
-- lsp-set-addresses ls1-lp2 "f0:00:00:00:00:02 ae70::5"

check ovn-nbctl lsp-set-port-security ls1-lp2 "f0:00:00:00:00:02 ae70::5"

check ovn-nbctl lsp-add ls1 ls1-lp3 \
-- lsp-set-addresses ls1-lp3 "f0:00:00:00:00:22 ae70::22"

check ovn-nbctl lsp-set-port-security ls1-lp3 "f0:00:00:00:00:22 ae70::22"

d1="$(ovn-nbctl create DHCP_Options cidr="ae70\:\:/64" \
options="\"server_id\"=\"00:00:00:10:00:01\"")"

check ovn-nbctl lsp-set-dhcpv6-options ls1-lp1 ${d1}
check ovn-nbctl lsp-set-dhcpv6-options ls1-lp2 ${d1}

d2="$(ovn-nbctl create DHCP_Options cidr="ae70\:\:/64" \
options="\"dhcpv6_stateless\"=\"true\" \"server_id\"=\"00:00:00:10:00:01\"")"

check ovn-nbctl lsp-set-dhcpv6-options ls1-lp3 ${d2}

check ovn-nbctl ls-add ls2
check ovn-nbctl lsp-add ls2 ls2-lp1 \
-- lsp-set-addresses ls2-lp1 "f0:00:00:00:00:03 be70::3"
check ovn-nbctl lsp-set-port-security ls2-lp1 "f0:00:00:00:00:03 be70::3"
check ovn-nbctl lsp-add ls2 ls2-lp2 \
-- lsp-set-addresses ls2-lp2 "f0:00:00:00:00:04 be70::4"
check ovn-nbctl lsp-set-port-security ls2-lp2 "f0:00:00:00:00:04 be70::4"

net_add n1
sim_add hv1

as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int hv1-vif1 -- \
    set interface hv1-vif1 external-ids:iface-id=ls1-lp1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1

ovs-vsctl -- add-port br-int hv1-vif2 -- \
    set interface hv1-vif2 external-ids:iface-id=ls1-lp2 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=2

ovs-vsctl -- add-port br-int hv1-vif3 -- \
    set interface hv1-vif3 external-ids:iface-id=ls2-lp1 \
    options:tx_pcap=hv1/vif3-tx.pcap \
    options:rxq_pcap=hv1/vif3-rx.pcap \
    ofport-request=3

ovs-vsctl -- add-port br-int hv1-vif4 -- \
    set interface hv1-vif4 external-ids:iface-id=ls2-lp2 \
    options:tx_pcap=hv1/vif4-tx.pcap \
    options:rxq_pcap=hv1/vif4-rx.pcap \
    ofport-request=4

ovs-vsctl -- add-port br-int hv1-vif5 -- \
    set interface hv1-vif5 external-ids:iface-id=ls1-lp3 \
    options:tx_pcap=hv1/vif5-tx.pcap \
    options:rxq_pcap=hv1/vif5-rx.pcap \
    ofport-request=5

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure
$at_traceon; }


wait_for_ports_up
check ovn-nbctl --wait=hv sync

# Start with 0 because the first request will not have NXT_RESUME
n_resume=0

# This shell function sends a DHCPv6 request packet
# test_dhcpv6 INPORT SRC_MAC SRC_LLA DHCPv6_MSG_TYPE OFFER_IP OUTPORT...
# The OUTPORTs (zero or more) list the VIFs on which the original DHCPv6
# packet should be received twice (one from ovn-controller and the other
# from the "ovs-ofctl monitor br-int resume"
test_dhcpv6() {
    local inport=$1 src_mac=$2 src_lla=$3 msg_code=$4 offer_ip=$5 boot_file=$6
    local fqdn=$7

    local req_scapy="Ether(dst='33:33:00:01:00:02', src='${src_mac}')/ \
                     IPv6(dst='ff02::1:2', src='${src_lla}')/ \
                     UDP(sport=546, dport=547)/ \
                     DHCP6(msgtype=${msg_code}, trid=0x010203)/ \
                     DHCP6OptClientId(duid=DUID_LL(lladdr='${src_mac}'))"

    # Add IA-NA (Identity Association for Non Temporary Address) if msg_code
    # is not 11 (information request packet)
    if test $msg_code != 11; then
        req_scapy="${req_scapy}/DHCP6OptIA_NA(iaid=0x01020304, T1=3600, T2=5400)"
    fi
    if test "$boot_file" = "bootfile_name"; then
        local uc_data="USER_CLASS_DATA(data=b'iPXE')"
        req_scapy="${req_scapy}/DHCP6OptUserClass(userclassdata=[${uc_data}])"
    fi
    if test -n "$fqdn"; then
        req_scapy="${req_scapy}/DHCP6OptClientFQDN(flags=0x01, fqdn=b'test')"
    fi
    request=$(fmt_pkt "${req_scapy}")
    shift; shift; shift; shift; shift; shift; shift;
    if test $offer_ip != 0; then
        local reply_code=7
        if test $msg_code = 1; then
            reply_code=2
        fi

        local rep_scapy="Ether(dst='${src_mac}', src='00:00:00:10:00:01')/ \
                         IPv6(dst='${src_lla}', src='fe80::0200:00ff:fe10:0001')/ \
                         UDP(sport=547, dport=546)/ \
                         DHCP6(msgtype=${reply_code}, trid=0x010203)/ \
                         DHCP6OptClientId(duid=DUID_LL(lladdr='${src_mac}'))"

        if test $offer_ip != 1; then
            local ip_scapy="DHCP6OptIAAddress(addr='${offer_ip}', \
                            preflft=0xffffffff, validlft=0xffffffff)"
            rep_scapy="${rep_scapy}/ \
                       DHCP6OptIA_NA(iaid=0x01020304, T1=0xffffffff, \
                       T2=0xffffffff, ianaopts=[${ip_scapy}])"
        fi
        if test -n "$boot_file"; then
            rep_scapy="${rep_scapy}/DHCP6OptBootFileUrl(optdata=b'${boot_file}')"
        fi
        if test -n "$fqdn"; then
            rep_scapy="${rep_scapy}/DHCP6OptClientFQDN(flags=0x06, fqdn=b'${fqdn}')"
        fi
        rep_scapy="${rep_scapy}/DHCP6OptServerId(duid=DUID_LL(lladdr='00:00:00:10:00:01'))"
        reply=$(fmt_pkt "${rep_scapy}")
        echo $reply | trim_zeros >> $inport.expected
    else
        for outport; do
            echo $request | trim_zeros >> $outport.expected
        done
    fi

    as hv1 ovs-appctl netdev-dummy/receive hv1-vif$inport $request
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test $n_resume = `cat ofctl_monitor*.log | grep -c NXT_RESUME`
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "until test \$n_resume = \`cat ofctl_monitor*.log | grep -c NXT_RESUME\`"

    n_resume=$((n_resume + 1))
}

test_dhcpv6_release() {
    local inport=$1 src_mac=$2 src_lla=$3 offer_ip=$4

    local ip_scapy="DHCP6OptIAAddress(addr='${offer_ip}', preflft=0xffffffff, validlft=0xffffffff)"
    local req_scapy="Ether(dst='33:33:00:01:00:02', src='${src_mac}')/ \
                     IPv6(dst='ff02::1:2', src='${src_lla}')/ \
                     UDP(sport=546, dport=547)/ \
                     DHCP6(msgtype=8, trid=0x010203)/ \
                     DHCP6OptClientId(duid=DUID_LL(lladdr='${src_mac}'))/ \
                     DHCP6OptServerId(duid=DUID_LL(lladdr='00:00:00:10:00:01'))/ \
                     DHCP6OptIA_NA(iaid=0x01020304, T1=0xffffffff, T2=0xffffffff, ianaopts=[${ip_scapy}])"

    request=$(fmt_pkt "${req_scapy}")

    local rep_scapy="Ether(dst='${src_mac}', src='00:00:00:10:00:01')/ \
                     IPv6(dst='${src_lla}', src='fe80::0200:00ff:fe10:0001')/ \
                     UDP(sport=547, dport=546)/ \
                     DHCP6(msgtype=7, trid=0x010203)/ \
                     DHCP6OptClientId(duid=DUID_LL(lladdr='${src_mac}'))/ \
                     DHCP6OptServerId(duid=DUID_LL(lladdr='00:00:00:10:00:01'))/ \
                     DHCP6OptStatusCode(statuscode=0)"

    reply=$(fmt_pkt "${rep_scapy}")
    echo $reply | trim_zeros >> $inport.expected

    as hv1 ovs-appctl netdev-dummy/receive hv1-vif$inport $request
    check_ovs_wait_until_args "1" ""
   ovs_wait_cond () {
    test $n_resume = `cat ofctl_monitor*.log | grep -c NXT_RESUME`
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "until test \$n_resume = \`cat ofctl_monitor*.log | grep -c NXT_RESUME\`"

    n_resume=$((n_resume + 1))
}

check_packets() {
    local port=$1

    # Skipping UDP checksum
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif\$port-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif$port-tx.pcap " "ovn.at:7396"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif$port-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv1/vif$port-tx.pcap" "$port.expected" "tests/ovn.at:7396" "trim_zeros | cut -c 1-120,125-"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7396"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
if $at_failed
then :
  dump_diff__ "hv1/vif$port-tx.pcap" "$port.expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }

    rm $port.expected
}

check_empty_packets() {
    local port=$1

    $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif$port-tx.pcap | trim_zeros > $port.packets
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: cat \$port.packets"
at_fn_check_prepare_dynamic "cat $port.packets" "ovn.at:7396"
( $at_check_trace; cat $port.packets
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure
$at_traceon; }


    rm $port.packets
}


as hv1 ovs-ofctl monitor br-int resume --timeout=120 --detach --no-chdir \
--pidfile=ovs-ofctl0.pid 2> ofctl_monitor0.log

echo "---------NB dump-----"
ovn-nbctl show
echo "---------------------"
echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list logical_flow
echo "---------------------"

#ovn-sbctl dump-flows > sbflows


echo "------ hv1 dump ----------"
as hv1 ovs-ofctl dump-flows br-int

# Send DHCPv6 packet on ls2-lp1. native DHCPv6 is disabled on this port.
# There should be no DHCPv6 reply from ovn-controller and the request packet
# should be received by ls2-lp2.

src_mac="f0:00:00:00:00:03"
src_lla="fe80::f200:00ff:fe00:0003"
test_dhcpv6 3 $src_mac $src_lla 1 0 "" "" 4

# vif3-tx.pcap should not have received the DHCPv6 reply packet
check_empty 3

# vif4-tx.pcap should have received the DHCPv6 request packet
check_packets 4

src_mac="f0:00:00:00:00:01"
src_lla="fe80::f200:00ff:fe00:0001"
offer_ip="ae70::4"

test_dhcpv6 1 $src_mac $src_lla 1 $offer_ip "" ""
check_packets 1

reset_pcap_file hv1-vif1 hv1/vif1

test_dhcpv6_release 1 $src_mac $src_lla $offer_ip
check_packets 1

# Send invalid packet on ls1-lp2. ovn-controller should resume the packet
# without any modifications and the packet should be received by ls1-lp1.
# ls1-lp1 will receive the packet twice, one from the ovn-controller after the
# resume and the other from ovs-ofctl monitor resume.

reset_pcap_file hv1-vif1 hv1/vif1
reset_pcap_file hv1-vif2 hv1/vif2

src_mac="f0:00:00:00:00:02"
src_lla="fe80::f200:00ff:fe00:0002"
offer_ip="ae70::5"
# Set invalid msg_type

test_dhcpv6 2 $src_mac $src_lla 16 0 "" "" 1 1

# vif2-tx.pcap should not have received the DHCPv6 reply packet
check_empty 2

# vif1-tx.pcap should have received the DHCPv6 (invalid) request packet
check_packets 1

# Send DHCPv6 packet on ls1-lp3. native DHCPv6 works as stateless mode for this port.
# The DHCPv6 reply shouldn't contain offer_ip.
src_mac="f0:00:00:00:00:22"
src_lla="fe80::f200:00ff:fe00:0022"
reset_pcap_file hv1-vif5 hv1/vif5

test_dhcpv6 5 $src_mac $src_lla 1 1 "" "" 5
check_packets 5

# Send DHCPv6 information request (code 11) on ls1-lp3. The DHCPv6 reply
# shouldn't contain offer_ip
src_mac="f0:00:00:00:00:22"
src_lla="fe80::f200:00ff:fe00:0022"
reset_pcap_file hv1-vif5 hv1/vif5

test_dhcpv6 5 $src_mac $src_lla 11 1 "" "" 5
check_packets 5

check ovn-nbctl --all destroy dhcp-option
d1="$(ovn-nbctl create DHCP_Options cidr="ae70\:\:/64")"
check ovn-nbctl dhcp-options-set-options $d1 \
    server_id=00:00:00:10:00:01 \
    bootfile_name_alt=\"bootfile_name_alt\" \
    bootfile_name=\"bootfile_name\"
check ovn-nbctl --wait=hv lsp-set-dhcpv6-options ls1-lp2 ${d1}

reset_pcap_file hv1-vif2 hv1/vif2

src_mac="f0:00:00:00:00:02"
src_lla="fe80::f200:00ff:fe00:0002"
offer_ip="ae70::5"

test_dhcpv6 2 $src_mac $src_lla 1 $offer_ip "bootfile_name_alt" ""
check_packets 2

reset_pcap_file hv1-vif2 hv1/vif2

test_dhcpv6_release 2 $src_mac $src_lla $offer_ip
check_packets 2

reset_pcap_file hv1-vif2 hv1/vif2

test_dhcpv6 2 $src_mac $src_lla 1 $offer_ip "bootfile_name" ""
check_packets 2

reset_pcap_file hv1-vif2 hv1/vif2

test_dhcpv6_release 2 $src_mac $src_lla $offer_ip
check_packets 2

check ovn-nbctl --all destroy dhcp-option
d1="$(ovn-nbctl create DHCP_Options cidr="ae70\:\:/64")"
check ovn-nbctl dhcp-options-set-options $d1 \
    server_id=00:00:00:10:00:01 \
    fqdn=\"ovn.org\"
check ovn-nbctl --wait=hv lsp-set-dhcpv6-options ls1-lp2 ${d1}

reset_pcap_file hv1-vif2 hv1/vif2

test_dhcpv6 2 $src_mac $src_lla 1 $offer_ip "" "ovn.org"
check_packets 2

reset_pcap_file hv1-vif2 hv1/vif2

test_dhcpv6_release 2 $src_mac $src_lla $offer_ip
check_packets 2



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7396"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7396"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7396"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7396"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7396: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7396"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7396"
$at_failed && at_fn_log_failure  \
"ofctl_monitor0.log" \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7396" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_100
#AT_START_101
at_fn_group_banner 101 'ovn.at:7733' \
  "2 HVs, 2 LRs connected via LS, gateway router -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "101. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init

printf "%s\n" "ovn.at:7733" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:7733"
ovn_start

# Logical network:
# Two LRs - R1 and R2 that are connected to each other via LS "join"
# in 20.0.0.0/24 network. R1 has switchess foo (192.168.1.0/24)
# connected to it. R2 has alice (172.16.1.0/24) connected to it.
# R2 is a gateway router.



# Create two hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int hv1-vif1 -- \
    set interface hv1-vif1 external-ids:iface-id=foo1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1


sim_add hv2
as hv2
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.2
ovs-vsctl -- add-port br-int hv2-vif1 -- \
    set interface hv2-vif1 external-ids:iface-id=alice1 \
    options:tx_pcap=hv2/vif1-tx.pcap \
    options:rxq_pcap=hv2/vif1-rx.pcap \
    ofport-request=1

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure
$at_traceon; }


check_uuid ovn-nbctl create Logical_Router name=R1
check_uuid ovn-nbctl create Logical_Router name=R2 options:chassis="hv2"

check ovn-nbctl ls-add foo
check ovn-nbctl ls-add alice
check ovn-nbctl ls-add join

# Connect foo to R1
check ovn-nbctl lrp-add R1 foo 00:00:01:01:02:03 192.168.1.1/24
check ovn-nbctl lsp-add foo rp-foo -- set Logical_Switch_Port rp-foo \
    type=router options:router-port=foo addresses=\"00:00:01:01:02:03\"

# Connect alice to R2
check ovn-nbctl lrp-add R2 R2-alice 00:00:02:01:02:03 172.16.1.1/24
check ovn-nbctl lsp-add alice alice-R2 -- set Logical_Switch_Port alice-R2 \
    type=router options:router-port=R2-alice addresses=\"00:00:02:01:02:03\"

# Connect R1 to join
check ovn-nbctl lrp-add R1 R1_join 00:00:04:01:02:03 20.0.0.1/24
check ovn-nbctl lsp-add join r1-join -- set Logical_Switch_Port r1-join \
    type=router options:router-port=R1_join addresses='"00:00:04:01:02:03"'

# Connect R2 to join
check ovn-nbctl lrp-add R2 R2_join 00:00:04:01:02:04 20.0.0.2/24
check ovn-nbctl lsp-add join r2-join -- set Logical_Switch_Port r2-join \
    type=router options:router-port=R2_join addresses='"00:00:04:01:02:04"'


#install static routes
check_uuid ovn-nbctl -- --id=@lrt create Logical_Router_Static_Route \
ip_prefix=172.16.1.0/24 nexthop=20.0.0.2 -- add Logical_Router \
R1 static_routes @lrt

check_uuid ovn-nbctl -- --id=@lrt create Logical_Router_Static_Route \
ip_prefix=192.168.1.0/24 nexthop=20.0.0.1 -- add Logical_Router \
R2 static_routes @lrt

# Create logical port foo1 in foo
check ovn-nbctl lsp-add foo foo1 \
-- lsp-set-addresses foo1 "f0:00:00:01:02:03 192.168.1.2"

# Create logical port alice1 in alice
check ovn-nbctl lsp-add alice alice1 \
-- lsp-set-addresses alice1 "f0:00:00:01:02:04 172.16.1.2"

wait_for_ports_up
check ovn-nbctl --wait=hv sync

ovn_wait_remote_output_flows ""hv1"" ""hv2"" "tests/ovn.at:7733"
ovn_wait_remote_output_flows ""hv2"" ""hv1"" "tests/ovn.at:7733"

# Send ip packets between foo1 and alice1
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:01:01:02:03"
src_ip=192.168.1.2
dst_ip=172.16.1.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")

echo "---------NB dump-----"
ovn-nbctl show
echo "---------------------"
ovn-nbctl list logical_router
echo "---------------------"
ovn-nbctl list logical_router_port
echo "---------------------"

echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list port_binding
echo "---------------------"
ovn-sbctl dump-flows
echo "---------------------"
ovn-sbctl list chassis
ovn-sbctl list encap
echo "---------------------"

# Packet to Expect at alice1
src_mac="00:00:02:01:02:03"
dst_mac="f0:00:00:01:02:04"
src_ip=192.168.1.2
dst_ip=172.16.1.2
expected=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3e)/ \
                  UDP(sport=53, dport=4369)")


as hv1 ovs-appctl netdev-dummy/receive hv1-vif1 $packet
as hv1 ovs-appctl ofproto/trace br-int in_port=1 $packet

echo "------ hv1 dump after packet 1 ----------"
as hv1 ovs-ofctl show br-int
as hv1 ovs-ofctl dump-flows br-int
echo "------ hv2 dump after packet 1 ----------"
as hv2 ovs-ofctl show br-int
as hv2 ovs-ofctl dump-flows br-int
echo "----------------------------"

echo $expected > expected
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap " "ovn.at:7733"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv2/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv2/vif1-tx.pcap" "expected" "tests/ovn.at:7733"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7733"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
if $at_failed
then :
  dump_diff__ "hv2/vif1-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }



    hv=hv1
    sbox=hv1
    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then
      # Get flows before and after recompute

    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      check ovn-appctl -t ovn-controller recompute
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      diff flows-$hv-before flows-$hv-after > flow-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < flow-diff"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; wc -l < flow-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure
$at_traceon; }

    fi


# Delete the router and re-create it. Things should work as before.
check ovn-nbctl  lr-del R2
check_uuid ovn-nbctl create Logical_Router name=R2 options:chassis="hv2"
# Connect alice to R2
check ovn-nbctl lrp-add R2 R2-alice 00:00:02:01:02:03 172.16.1.1/24
# Connect R2 to join
check ovn-nbctl lrp-add R2 R2_join 00:00:04:01:02:04 20.0.0.2/24

check_uuid ovn-nbctl -- --id=@lrt create Logical_Router_Static_Route \
ip_prefix=192.168.1.0/24 nexthop=20.0.0.1 -- add Logical_Router \
R2 static_routes @lrt

# Wait for ovn-controller to catch up.
wait_for_ports_up
check ovn-nbctl --wait=hv sync


    hv=hv1
    sbox=hv1
    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then
      # Get flows before and after recompute

    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      check ovn-appctl -t ovn-controller recompute
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      diff flows-$hv-before flows-$hv-after > flow-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < flow-diff"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; wc -l < flow-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure
$at_traceon; }

    fi


# Send the packet again.
as hv1 ovs-appctl netdev-dummy/receive hv1-vif1 $packet

echo "------ hv1 dump after packet 2 ----------"
as hv1 ovs-ofctl show br-int
as hv1 ovs-ofctl dump-flows br-int
echo "------ hv2 dump after packet 2 ----------"
as hv2 ovs-ofctl show br-int
as hv2 ovs-ofctl dump-flows br-int
echo "----------------------------"

echo $expected >> expected
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap " "ovn.at:7733"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv2/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv2/vif1-tx.pcap" "expected" "tests/ovn.at:7733"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7733"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
if $at_failed
then :
  dump_diff__ "hv2/vif1-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7733"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7733"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7733"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7733"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7733"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7733"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_101
#AT_START_102
at_fn_group_banner 102 'ovn.at:7733' \
  "2 HVs, 2 LRs connected via LS, gateway router -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "102. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init

printf "%s\n" "ovn.at:7733" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:7733"
ovn_start

# Logical network:
# Two LRs - R1 and R2 that are connected to each other via LS "join"
# in 20.0.0.0/24 network. R1 has switchess foo (192.168.1.0/24)
# connected to it. R2 has alice (172.16.1.0/24) connected to it.
# R2 is a gateway router.



# Create two hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int hv1-vif1 -- \
    set interface hv1-vif1 external-ids:iface-id=foo1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1


sim_add hv2
as hv2
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.2
ovs-vsctl -- add-port br-int hv2-vif1 -- \
    set interface hv2-vif1 external-ids:iface-id=alice1 \
    options:tx_pcap=hv2/vif1-tx.pcap \
    options:rxq_pcap=hv2/vif1-rx.pcap \
    ofport-request=1

# Pre-populate the hypervisors' ARP tables so that we don't lose any
# packets for ARP resolution (native tunneling doesn't queue packets
# for ARP resolution).
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovn_populate_arp__"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovn_populate_arp__
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure
$at_traceon; }


check_uuid ovn-nbctl create Logical_Router name=R1
check_uuid ovn-nbctl create Logical_Router name=R2 options:chassis="hv2"

check ovn-nbctl ls-add foo
check ovn-nbctl ls-add alice
check ovn-nbctl ls-add join

# Connect foo to R1
check ovn-nbctl lrp-add R1 foo 00:00:01:01:02:03 192.168.1.1/24
check ovn-nbctl lsp-add foo rp-foo -- set Logical_Switch_Port rp-foo \
    type=router options:router-port=foo addresses=\"00:00:01:01:02:03\"

# Connect alice to R2
check ovn-nbctl lrp-add R2 R2-alice 00:00:02:01:02:03 172.16.1.1/24
check ovn-nbctl lsp-add alice alice-R2 -- set Logical_Switch_Port alice-R2 \
    type=router options:router-port=R2-alice addresses=\"00:00:02:01:02:03\"

# Connect R1 to join
check ovn-nbctl lrp-add R1 R1_join 00:00:04:01:02:03 20.0.0.1/24
check ovn-nbctl lsp-add join r1-join -- set Logical_Switch_Port r1-join \
    type=router options:router-port=R1_join addresses='"00:00:04:01:02:03"'

# Connect R2 to join
check ovn-nbctl lrp-add R2 R2_join 00:00:04:01:02:04 20.0.0.2/24
check ovn-nbctl lsp-add join r2-join -- set Logical_Switch_Port r2-join \
    type=router options:router-port=R2_join addresses='"00:00:04:01:02:04"'


#install static routes
check_uuid ovn-nbctl -- --id=@lrt create Logical_Router_Static_Route \
ip_prefix=172.16.1.0/24 nexthop=20.0.0.2 -- add Logical_Router \
R1 static_routes @lrt

check_uuid ovn-nbctl -- --id=@lrt create Logical_Router_Static_Route \
ip_prefix=192.168.1.0/24 nexthop=20.0.0.1 -- add Logical_Router \
R2 static_routes @lrt

# Create logical port foo1 in foo
check ovn-nbctl lsp-add foo foo1 \
-- lsp-set-addresses foo1 "f0:00:00:01:02:03 192.168.1.2"

# Create logical port alice1 in alice
check ovn-nbctl lsp-add alice alice1 \
-- lsp-set-addresses alice1 "f0:00:00:01:02:04 172.16.1.2"

wait_for_ports_up
check ovn-nbctl --wait=hv sync

ovn_wait_remote_output_flows ""hv1"" ""hv2"" "tests/ovn.at:7733"
ovn_wait_remote_output_flows ""hv2"" ""hv1"" "tests/ovn.at:7733"

# Send ip packets between foo1 and alice1
src_mac="f0:00:00:01:02:03"
dst_mac="00:00:01:01:02:03"
src_ip=192.168.1.2
dst_ip=172.16.1.2
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=53, dport=4369)")

echo "---------NB dump-----"
ovn-nbctl show
echo "---------------------"
ovn-nbctl list logical_router
echo "---------------------"
ovn-nbctl list logical_router_port
echo "---------------------"

echo "---------SB dump-----"
ovn-sbctl list datapath_binding
echo "---------------------"
ovn-sbctl list port_binding
echo "---------------------"
ovn-sbctl dump-flows
echo "---------------------"
ovn-sbctl list chassis
ovn-sbctl list encap
echo "---------------------"

# Packet to Expect at alice1
src_mac="00:00:02:01:02:03"
dst_mac="f0:00:00:01:02:04"
src_ip=192.168.1.2
dst_ip=172.16.1.2
expected=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}', ttl=0x3e)/ \
                  UDP(sport=53, dport=4369)")


as hv1 ovs-appctl netdev-dummy/receive hv1-vif1 $packet
as hv1 ovs-appctl ofproto/trace br-int in_port=1 $packet

echo "------ hv1 dump after packet 1 ----------"
as hv1 ovs-ofctl show br-int
as hv1 ovs-ofctl dump-flows br-int
echo "------ hv2 dump after packet 1 ----------"
as hv2 ovs-ofctl show br-int
as hv2 ovs-ofctl dump-flows br-int
echo "----------------------------"

echo $expected > expected
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap " "ovn.at:7733"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv2/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv2/vif1-tx.pcap" "expected" "tests/ovn.at:7733"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7733"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
if $at_failed
then :
  dump_diff__ "hv2/vif1-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }



    hv=hv1
    sbox=hv1
    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then
      # Get flows before and after recompute

    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      check ovn-appctl -t ovn-controller recompute
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      diff flows-$hv-before flows-$hv-after > flow-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < flow-diff"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; wc -l < flow-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure
$at_traceon; }

    fi


# Delete the router and re-create it. Things should work as before.
check ovn-nbctl  lr-del R2
check_uuid ovn-nbctl create Logical_Router name=R2 options:chassis="hv2"
# Connect alice to R2
check ovn-nbctl lrp-add R2 R2-alice 00:00:02:01:02:03 172.16.1.1/24
# Connect R2 to join
check ovn-nbctl lrp-add R2 R2_join 00:00:04:01:02:04 20.0.0.2/24

check_uuid ovn-nbctl -- --id=@lrt create Logical_Router_Static_Route \
ip_prefix=192.168.1.0/24 nexthop=20.0.0.1 -- add Logical_Router \
R2 static_routes @lrt

# Wait for ovn-controller to catch up.
wait_for_ports_up
check ovn-nbctl --wait=hv sync


    hv=hv1
    sbox=hv1
    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then
      # Get flows before and after recompute

    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      check ovn-appctl -t ovn-controller recompute
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      diff flows-$hv-before flows-$hv-after > flow-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < flow-diff"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; wc -l < flow-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure
$at_traceon; }

    fi


# Send the packet again.
as hv1 ovs-appctl netdev-dummy/receive hv1-vif1 $packet

echo "------ hv1 dump after packet 2 ----------"
as hv1 ovs-ofctl show br-int
as hv1 ovs-ofctl dump-flows br-int
echo "------ hv2 dump after packet 2 ----------"
as hv2 ovs-ofctl show br-int
as hv2 ovs-ofctl dump-flows br-int
echo "----------------------------"

echo $expected >> expected
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv2/vif1-tx.pcap " "ovn.at:7733"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv2/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure
$at_traceon; }

   ovn_check_packets__ "hv2/vif1-tx.pcap" "expected" "tests/ovn.at:7733"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7733"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
if $at_failed
then :
  dump_diff__ "hv2/vif1-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7733"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi


        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')
        ignored_dp=$(echo "hv2"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv2"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv2" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7733"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7733"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7733"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }



        sbox=$(echo "hv2" |sed -n '1p')
        error=$(echo "hv2"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7733"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7733"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7733"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7733: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7733"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7733"
$at_failed && at_fn_log_failure  \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7733" "while kill -0 \$TMPPID 2>/dev/null"




ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_102
#AT_START_103
at_fn_group_banner 103 'ovn.at:7917' \
  "spine-leaf: 1 HV, 3 LSs, connected via spine switch -- parallelization=yes -- ovn_monitor_all=yes" "" 4
at_xfail=no
(
  printf "%s\n" "103. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=yes
ovs_init


printf "%s\n" "ovn.at:7917" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:7917"
ovn_start

# Logical network:
# Single network 191.168.1.0/24.  Three switches with VIF ports, connected
# to a spine logical switch via 'switch' ports.  Third switch has a port
# with unknown address, but we're only sending packets between ports on other
# two switches.

check ovn-nbctl ls-add spine

check ovn-nbctl ls-add ls1
check ovn-nbctl ls-add ls2
check ovn-nbctl ls-add ls3

# Connect ls1 to spine.
check ovn-nbctl lsp-add spine spine-to-ls1
check ovn-nbctl lsp-add ls1 ls1-to-spine
check ovn-nbctl lsp-set-type spine-to-ls1 switch peer=ls1-to-spine
check ovn-nbctl lsp-set-type ls1-to-spine switch peer=spine-to-ls1

# Connect ls2 to spine.
check ovn-nbctl lsp-add spine spine-to-ls2
check ovn-nbctl lsp-add ls2 ls2-to-spine
check ovn-nbctl lsp-set-type spine-to-ls2 switch peer=ls2-to-spine
check ovn-nbctl lsp-set-type ls2-to-spine switch peer=spine-to-ls2

# Connect ls3 to spine.
check ovn-nbctl lsp-add spine spine-to-ls3
check ovn-nbctl lsp-add ls3 ls3-to-spine
check ovn-nbctl lsp-set-type spine-to-ls3 switch peer=ls3-to-spine
check ovn-nbctl lsp-set-type ls3-to-spine switch peer=spine-to-ls3

# Create logical port ls1-lp1 in ls1
check ovn-nbctl lsp-add ls1 ls1-lp1 \
-- lsp-set-addresses ls1-lp1 "f0:00:00:01:02:01 172.16.1.1"
# Create logical port ls1-lp2 in ls1
check ovn-nbctl lsp-add ls1 ls1-lp2 \
-- lsp-set-addresses ls1-lp2 "f0:00:00:01:02:02 172.16.1.2"

# Create logical port ls2-lp1 in ls2
check ovn-nbctl lsp-add ls2 ls2-lp1 \
-- lsp-set-addresses ls2-lp1 "f0:00:00:01:02:03 172.16.1.3"
# Create logical port ls2-lp2 in ls2
check ovn-nbctl lsp-add ls2 ls2-lp2 \
-- lsp-set-addresses ls2-lp2 "f0:00:00:01:02:04 172.16.1.4"

# Create logical port ls3-lp1 in ls3 with unknown address.
check ovn-nbctl lsp-add ls3 ls3-lp1 -- lsp-set-addresses ls3-lp1 unknown

# Create one hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int vif1 -- \
    set interface vif1 external-ids:iface-id=ls1-lp1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1
ovs-vsctl -- add-port br-int vif2 -- \
    set interface vif2 external-ids:iface-id=ls1-lp2 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=2

ovs-vsctl -- add-port br-int vif3 -- \
    set interface vif3 external-ids:iface-id=ls2-lp1 \
    options:tx_pcap=hv1/vif3-tx.pcap \
    options:rxq_pcap=hv1/vif3-rx.pcap \
    ofport-request=3
ovs-vsctl -- add-port br-int vif4 -- \
    set interface vif4 external-ids:iface-id=ls2-lp2 \
    options:tx_pcap=hv1/vif4-tx.pcap \
    options:rxq_pcap=hv1/vif4-rx.pcap \
    ofport-request=4

ovs-vsctl -- add-port br-int vif5 -- \
    set interface vif5 external-ids:iface-id=ls3-lp1 \
    options:tx_pcap=hv1/vif5-tx.pcap \
    options:rxq_pcap=hv1/vif5-rx.pcap \
    ofport-request=5

wait_for_ports_up
check ovn-nbctl --wait=hv sync

ovn-sbctl dump-flows > sbflows


# Send ip packets between the two ports.
src_mac="f0:00:00:01:02:01"
dst_mac="f0:00:00:01:02:03"
src_ip=172.16.1.1
dst_ip=172.16.1.3
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=1538, dport=4369)")

# Check that datapath is not doing any extra work.  Since FDB is not updated
# yet, we expect the packet to be sent to userspace three times: one while
# entering the spine switch, then it gets broadcasted to two other leaf
# switches and sent to userspace from there.  We also expect a clone of the
# packet to end up in vif5 due to aforementioned broadcast.  Need to sort the
# output, since the order of ports may change.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: as hv1 ovs-appctl ofproto/trace --names br-int in_port=vif1 \$packet \\
            | tail -2 | grep -oE 'Megaflow.*|userspace|vif[0-9]' | sort"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7917"
( $at_check_trace; as hv1 ovs-appctl ofproto/trace --names br-int in_port=vif1 $packet \
            | tail -2 | grep -oE 'Megaflow.*|userspace|vif[0-9]' | sort
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Megaflow: recirc_id=0,eth,ip,in_port=vif1,dl_src=f0:00:00:01:02:01,dl_dst=f0:00:00:01:02:03,nw_frag=no
userspace
userspace
userspace
vif3
vif5
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


# Actually send the packet.
check as hv1 ovs-appctl netdev-dummy/receive vif1 $packet

# Wait for the FDB entries to be created and propagated to OpenFlow.
wait_row_count FDB 3
check ovn-nbctl --wait=hv sync

# No modifications expected.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: echo \$packet > expected"
at_fn_check_prepare_dynamic "echo $packet > expected" "ovn.at:7917"
( $at_check_trace; echo $packet > expected
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: touch empty"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; touch empty
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


# Check that it is delivered where needed and not delivered where not.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif1-tx.pcap" "empty" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif1-tx.pcap" "empty"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "empty" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "empty"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif3-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif3-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif3-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif3-tx.pcap" "expected" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif3-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif4-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif4-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif4-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif4-tx.pcap" "empty" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif4-tx.pcap" "empty"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif5-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif5-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif5-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif5-tx.pcap" "expected" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif5-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


# Trace a reply packet.
reply=$(fmt_pkt "Ether(dst='${src_mac}', src='${dst_mac}')/ \
                 IP(src='${dst_ip}', dst='${src_ip}')/ \
                 UDP(sport=4369, dport=1538)")
# For the reply packet we expect only two userspace actions for FDB update,
# because we already learned that MAC of vif1 is behind spine-ls1 and no
# longer need to broadcast to ls3/vif5.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: as hv1 ovs-appctl ofproto/trace --names \\
            br-int in_port=vif3 \$reply | tail -2 \\
            | grep -oE 'Megaflow.*|userspace|vif[0-9]'"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7917"
( $at_check_trace; as hv1 ovs-appctl ofproto/trace --names \
            br-int in_port=vif3 $reply | tail -2 \
            | grep -oE 'Megaflow.*|userspace|vif[0-9]'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Megaflow: recirc_id=0,eth,ip,in_port=vif3,dl_src=f0:00:00:01:02:03,dl_dst=f0:00:00:01:02:01,nw_frag=no
userspace
userspace
vif1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

# Now actually send it.
check as hv1 ovs-appctl netdev-dummy/receive vif3 $reply

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: echo \$reply > reply"
at_fn_check_prepare_dynamic "echo $reply > reply" "ovn.at:7917"
( $at_check_trace; echo $reply > reply
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

# Check that it is delivered where needed and not delivered where not.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif1-tx.pcap" "reply" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif1-tx.pcap" "reply"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "empty" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "empty"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif3-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif3-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif3-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif3-tx.pcap" "expected" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif3-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif4-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif4-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif4-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif4-tx.pcap" "empty" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif4-tx.pcap" "empty"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif5-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif5-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif5-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif5-tx.pcap" "expected" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif5-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


# Wait for the FDB entries to be created and propagated to OpenFlow.
wait_row_count FDB 5
check ovn-nbctl --wait=hv sync

# Packets should flow directly to the destination now in both directions.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: as hv1 ovs-appctl ofproto/trace --names \\
            br-int in_port=vif1 \$packet | tail -2"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7917"
( $at_check_trace; as hv1 ovs-appctl ofproto/trace --names \
            br-int in_port=vif1 $packet | tail -2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Megaflow: recirc_id=0,eth,ip,in_port=vif1,dl_src=f0:00:00:01:02:01,dl_dst=f0:00:00:01:02:03,nw_frag=no
Datapath actions: vif3
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: as hv1 ovs-appctl ofproto/trace --names \\
            br-int in_port=vif3 \$reply | tail -2"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7917"
( $at_check_trace; as hv1 ovs-appctl ofproto/trace --names \
            br-int in_port=vif3 $reply | tail -2
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Megaflow: recirc_id=0,eth,ip,in_port=vif3,dl_src=f0:00:00:01:02:03,dl_dst=f0:00:00:01:02:01,nw_frag=no
Datapath actions: vif1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


# Send and check one more time.
check as hv1 ovs-appctl netdev-dummy/receive vif1 $packet
check as hv1 ovs-appctl netdev-dummy/receive vif3 $reply

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: cp expected expected-vif5"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; cp expected expected-vif5
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: echo \$packet >> expected"
at_fn_check_prepare_dynamic "echo $packet >> expected" "ovn.at:7917"
( $at_check_trace; echo $packet >> expected
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: echo \$reply >> reply"
at_fn_check_prepare_dynamic "echo $reply >> reply" "ovn.at:7917"
( $at_check_trace; echo $reply >> reply
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif1-tx.pcap" "reply" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif1-tx.pcap" "reply"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "empty" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "empty"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif3-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif3-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif3-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif3-tx.pcap" "expected" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif3-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif4-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif4-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif4-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif4-tx.pcap" "empty" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif4-tx.pcap" "empty"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif5-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif5-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif5-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif5-tx.pcap" "expected-vif5" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif5-tx.pcap" "expected-vif5"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }




        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')
        ignored_dp=$(echo "hv1"  | grep 'ignored_dp' |  cut -d'=' -f 2)
        ignored_tables=$(echo "hv1"  | grep 'ignored_tables' |  cut -d'=' -f 2)
        related_ports=$(echo "hv1" | sed -n '2,$p' | grep -v '/' | grep -v 'ignored_dp' | grep -v 'ignored_tables')

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7917"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi



        sbox=$(echo "hv1" |sed -n '1p')
        error=$(echo "hv1"  | grep '/')

    sbox=$sbox
    error=$error
    related_ports=
    ignored_dp=
    ignored_tables=
    no_recompute_check="True"
    echo "$sbox: clean up sandbox"
    as $sbox

    hv=$sbox
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables
    no_recompute_check=$no_recompute_check
    if test "$no_recompute_check" != "True"; then

    hv=$hv
    sbox=$sbox
    related_ports=$related_ports
    ignored_dp=$ignored_dp
    ignored_tables=$ignored_tables

    # Make sure I+P has finalized his job before getting flows and comparing them after recompte.
    # Some tests have northd and ovn-nb ovsdb stopped, so avoid ovn-nbctl for those.
    if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
        # Do wait twice to handle some potential race conditions
        check ovn-nbctl --wait=hv sync
        check ovn-nbctl --wait=hv sync
    fi

    as $sbox
    if test "$hv" != "vtep"; then

    sbox=$sbox
    output_file=related-ports-$hv-before
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-before
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file

      check ovn-appctl -t ovn-controller recompute
      echo "Checking after recompute for $sbox"
      # The recompute might cause some sb changes. Let controller catch up.
      if [ -e ${AZ_DIR}ovn-nb/ovn-nb.sock ] && [ -e ${AZ_DIR}northd/ovn-northd.pid ]; then
          check ovn-nbctl --wait=hv sync
      fi

    sbox=$sbox
    output_file=related-ports-$hv-after
    as $sbox
    ovn-appctl debug/dump-related-ports | sort > $output_file


    sbox=$sbox
    output_file=flows-$hv-after
    as $sbox
    ovs-ofctl dump-flows br-int  | grep -v "NXST_FLOW reply" |
          sed 's/cookie=0x[^,]*/cookie=xx/g' |
          sed 's/duration=[^,]*/duration=xx/g' |
          sed 's/idle_age=[^,]*/idle_age=xx/g' |
          sed 's/, hard_age=[^,]*//g' |
          sed 's/n_bytes=[^,]*/n_bytes=xx/g' |
          sed 's/n_packets=[^,]*/n_packets=xx/g' |
          sed 's/conjunction([^,]*/conjunction(xx/g' |
          sort > $output_file


      # Compare and store related_ports differences before and after recompute
      comm -3 related-ports-$hv-before related-ports-$hv-after > related-ports-diff-$hv
      # Ignore some differences.
      if [ -n "$related_ports" ]; then
        echo "Ignoring related ports $related_ports"
      fi
      echo "$related_ports" | comm -2 -3 related-ports-diff-$hv - > related-ports-diff
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: wc -l < related-ports-diff"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; wc -l < related-ports-diff
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }


      # Compare and store flow differences before and after recompute
      diff -u flows-$hv-before flows-$hv-after | grep "^+ \|^- " > flow-diff-$hv
      if [ -n "$related_ports" ]; then
        tag=$(ovn-sbctl --bare --columns tag list port_binding $related_ports)
        if [ -n "$tag" ]; then
          echo "Ignoring tag $tag"
          cat flow-diff-$hv | grep -v "dl_vlan=$tag" > tmp; mv tmp flow-diff-$hv
        fi
      fi

      dps=$(echo "$ignored_dp" | tr ',' ' ')
      for dp in $dps
      do
        if [ -n "${dp}" ]; then
          key=$(printf '0x%x' $(ovn-sbctl --bare --columns tunnel_key list datapath $dp))
          if [ -n "${key}" ]; then
            echo "Ignoring $dp i.e. tunnel_key $key"
            cat flow-diff-$hv | grep -v "metadata=$key" | grep -v "load:${key}->OXM_OF_METADATA" > tmp; mv tmp flow-diff-$hv
          fi
        fi
      done

      tables=$(echo "$ignored_tables" | tr ',' ' ')
      for table in $tables
      do
        echo "Ignoring table $table"
        cat flow-diff-$hv | grep -v "table=$table" > tmp; mv tmp flow-diff-$hv
      done

      cat flow-diff-$hv | grep -v "table=66" | grep -v "table=67" | grep -v "table=79" > tmp; mv tmp flow-diff-$hv
      { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: wc -l < flow-diff-\$hv"
at_fn_check_prepare_dynamic "wc -l < flow-diff-$hv" "ovn.at:7917"
( $at_check_trace; wc -l < flow-diff-$hv
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "0
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

    fi

    fi

    if test "$hv" = "vtep"; then
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: test -e \$OVS_RUNDIR/ovn-controller-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller-vtep.pid" "ovn.at:7917"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: ovs-appctl --timeout=10 -t ovn-controller-vtep exit"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7917" "while kill -0 \$TMPPID 2>/dev/null"

        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: test -e \$OVS_RUNDIR/ovs-vtep.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vtep.pid" "ovn.at:7917"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vtep.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vtep.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: ovs-appctl --timeout=10 -t ovs-vtep exit"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vtep exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7917" "while kill -0 \$TMPPID 2>/dev/null"

    else
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: test -e \$OVS_RUNDIR/ovn-controller.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-controller.pid" "ovn.at:7917"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-controller.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-controller.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: ovs-appctl --timeout=10 -t ovn-controller exit"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-controller exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7917" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "$sbox: clean up vswitch"
    as $sbox
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:7917"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7917" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7917"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7917" "while kill -0 \$TMPPID 2>/dev/null"



    # Check for errors in logs. Ignore following errors:
    # "connection failed (No such file or directory)" as happens everytime we restart ovs-vswitchd.
    # "has no network name*" as localnet network_name is often set "after" creating localnet.
    # "receive tunnel port not found*" happening when closing other hv.
    # "Failed to locate tunnel to reach main chassis" happening when controller started e.g. before ovn-bridge-mappings is set
    # "Transaction causes multiple rows in \"MAC_Binding\" table to have identical values"
    #  happening as ovn-controller has a race condition over MAC binding table with other controllers (GARP).
    # "Transaction causes multiple rows in \"FDB\" table to have identical values"
    #  happens when there is a race between multiple ovn-controllers that try to create the same FDB.
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: check_logs \"
        \$error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    \" \$sbox"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7917"
( $at_check_trace; check_logs "
        $error
        /connection failed (No such file or directory)/d
        /has no network name*/d
        /receive tunnel port not found*/d
        /Failed to locate tunnel to reach main chassis/d
        /Transaction causes multiple rows.*MAC_Binding/d
        /Transaction causes multiple rows.*FDB/d
    " $sbox
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }




    echo
    echo "clean up OVN"
    as ovn-sb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7917"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7917" "while kill -0 \$TMPPID 2>/dev/null"


    as ovn-nb
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7917"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7917" "while kill -0 \$TMPPID 2>/dev/null"


    as northd
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:7917"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7917" "while kill -0 \$TMPPID 2>/dev/null"


    if test -d northd-backup; then
        as northd-backup
        { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: test -e \$OVS_RUNDIR/ovn-northd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovn-northd.pid" "ovn.at:7917"
( $at_check_trace; test -e $OVS_RUNDIR/ovn-northd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovn-northd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: ovs-appctl --timeout=10 -t ovn-northd exit"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; ovs-appctl --timeout=10 -t ovn-northd exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7917" "while kill -0 \$TMPPID 2>/dev/null"

    fi


    echo
    echo "main: clean up vswitch"
    as main
    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: test -e \$OVS_RUNDIR/ovs-vswitchd.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovs-vswitchd.pid" "ovn.at:7917"
( $at_check_trace; test -e $OVS_RUNDIR/ovs-vswitchd.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovs-vswitchd.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; ovs-appctl --timeout=10 -t ovs-vswitchd exit --cleanup
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7917" "while kill -0 \$TMPPID 2>/dev/null"

    { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: test -e \$OVS_RUNDIR/ovsdb-server.pid"
at_fn_check_prepare_dynamic "test -e $OVS_RUNDIR/ovsdb-server.pid" "ovn.at:7917"
( $at_check_trace; test -e $OVS_RUNDIR/ovsdb-server.pid
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   TMPPID=$(cat $OVS_RUNDIR/ovsdb-server.pid)
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: ovs-appctl --timeout=10 -t ovsdb-server exit"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; ovs-appctl --timeout=10 -t ovsdb-server exit
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows" \
"related-ports-diff"
$at_traceon; }

   ovs_wait_cond () {
    if kill -0 $TMPPID 2>/dev/null; then return 1; else return 0; fi
}
ovs_wait_failed () {
    :

}
ovs_wait "ovn.at:7917" "while kill -0 \$TMPPID 2>/dev/null"



ovs_cleanup
  set +x
  $at_times_p && times >"$at_times_file"
) 5>&1 2>&1 7>&- | eval $at_tee_pipe
read at_status <"$at_status_file"
#AT_STOP_103
#AT_START_104
at_fn_group_banner 104 'ovn.at:7917' \
  "spine-leaf: 1 HV, 3 LSs, connected via spine switch -- parallelization=yes -- ovn_monitor_all=no" "" 4
at_xfail=no
(
  printf "%s\n" "104. $at_setup_line: testing $at_desc ..."
  $at_traceon

NORTHD_USE_PARALLELIZATION=yes
OVN_MONITOR_ALL=no
ovs_init


printf "%s\n" "ovn.at:7917" >"$at_check_line_file"
(test $HAVE_SCAPY = no) \
  && at_fn_check_skip 77 "$at_srcdir/ovn.at:7917"
ovn_start

# Logical network:
# Single network 191.168.1.0/24.  Three switches with VIF ports, connected
# to a spine logical switch via 'switch' ports.  Third switch has a port
# with unknown address, but we're only sending packets between ports on other
# two switches.

check ovn-nbctl ls-add spine

check ovn-nbctl ls-add ls1
check ovn-nbctl ls-add ls2
check ovn-nbctl ls-add ls3

# Connect ls1 to spine.
check ovn-nbctl lsp-add spine spine-to-ls1
check ovn-nbctl lsp-add ls1 ls1-to-spine
check ovn-nbctl lsp-set-type spine-to-ls1 switch peer=ls1-to-spine
check ovn-nbctl lsp-set-type ls1-to-spine switch peer=spine-to-ls1

# Connect ls2 to spine.
check ovn-nbctl lsp-add spine spine-to-ls2
check ovn-nbctl lsp-add ls2 ls2-to-spine
check ovn-nbctl lsp-set-type spine-to-ls2 switch peer=ls2-to-spine
check ovn-nbctl lsp-set-type ls2-to-spine switch peer=spine-to-ls2

# Connect ls3 to spine.
check ovn-nbctl lsp-add spine spine-to-ls3
check ovn-nbctl lsp-add ls3 ls3-to-spine
check ovn-nbctl lsp-set-type spine-to-ls3 switch peer=ls3-to-spine
check ovn-nbctl lsp-set-type ls3-to-spine switch peer=spine-to-ls3

# Create logical port ls1-lp1 in ls1
check ovn-nbctl lsp-add ls1 ls1-lp1 \
-- lsp-set-addresses ls1-lp1 "f0:00:00:01:02:01 172.16.1.1"
# Create logical port ls1-lp2 in ls1
check ovn-nbctl lsp-add ls1 ls1-lp2 \
-- lsp-set-addresses ls1-lp2 "f0:00:00:01:02:02 172.16.1.2"

# Create logical port ls2-lp1 in ls2
check ovn-nbctl lsp-add ls2 ls2-lp1 \
-- lsp-set-addresses ls2-lp1 "f0:00:00:01:02:03 172.16.1.3"
# Create logical port ls2-lp2 in ls2
check ovn-nbctl lsp-add ls2 ls2-lp2 \
-- lsp-set-addresses ls2-lp2 "f0:00:00:01:02:04 172.16.1.4"

# Create logical port ls3-lp1 in ls3 with unknown address.
check ovn-nbctl lsp-add ls3 ls3-lp1 -- lsp-set-addresses ls3-lp1 unknown

# Create one hypervisor and create OVS ports corresponding to logical ports.
net_add n1

sim_add hv1
as hv1
ovs-vsctl add-br br-phys
ovn_attach n1 br-phys 192.168.0.1
ovs-vsctl -- add-port br-int vif1 -- \
    set interface vif1 external-ids:iface-id=ls1-lp1 \
    options:tx_pcap=hv1/vif1-tx.pcap \
    options:rxq_pcap=hv1/vif1-rx.pcap \
    ofport-request=1
ovs-vsctl -- add-port br-int vif2 -- \
    set interface vif2 external-ids:iface-id=ls1-lp2 \
    options:tx_pcap=hv1/vif2-tx.pcap \
    options:rxq_pcap=hv1/vif2-rx.pcap \
    ofport-request=2

ovs-vsctl -- add-port br-int vif3 -- \
    set interface vif3 external-ids:iface-id=ls2-lp1 \
    options:tx_pcap=hv1/vif3-tx.pcap \
    options:rxq_pcap=hv1/vif3-rx.pcap \
    ofport-request=3
ovs-vsctl -- add-port br-int vif4 -- \
    set interface vif4 external-ids:iface-id=ls2-lp2 \
    options:tx_pcap=hv1/vif4-tx.pcap \
    options:rxq_pcap=hv1/vif4-rx.pcap \
    ofport-request=4

ovs-vsctl -- add-port br-int vif5 -- \
    set interface vif5 external-ids:iface-id=ls3-lp1 \
    options:tx_pcap=hv1/vif5-tx.pcap \
    options:rxq_pcap=hv1/vif5-rx.pcap \
    ofport-request=5

wait_for_ports_up
check ovn-nbctl --wait=hv sync

ovn-sbctl dump-flows > sbflows


# Send ip packets between the two ports.
src_mac="f0:00:00:01:02:01"
dst_mac="f0:00:00:01:02:03"
src_ip=172.16.1.1
dst_ip=172.16.1.3
packet=$(fmt_pkt "Ether(dst='${dst_mac}', src='${src_mac}')/ \
                  IP(src='${src_ip}', dst='${dst_ip}')/ \
                  UDP(sport=1538, dport=4369)")

# Check that datapath is not doing any extra work.  Since FDB is not updated
# yet, we expect the packet to be sent to userspace three times: one while
# entering the spine switch, then it gets broadcasted to two other leaf
# switches and sent to userspace from there.  We also expect a clone of the
# packet to end up in vif5 due to aforementioned broadcast.  Need to sort the
# output, since the order of ports may change.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: as hv1 ovs-appctl ofproto/trace --names br-int in_port=vif1 \$packet \\
            | tail -2 | grep -oE 'Megaflow.*|userspace|vif[0-9]' | sort"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7917"
( $at_check_trace; as hv1 ovs-appctl ofproto/trace --names br-int in_port=vif1 $packet \
            | tail -2 | grep -oE 'Megaflow.*|userspace|vif[0-9]' | sort
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Megaflow: recirc_id=0,eth,ip,in_port=vif1,dl_src=f0:00:00:01:02:01,dl_dst=f0:00:00:01:02:03,nw_frag=no
userspace
userspace
userspace
vif3
vif5
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


# Actually send the packet.
check as hv1 ovs-appctl netdev-dummy/receive vif1 $packet

# Wait for the FDB entries to be created and propagated to OpenFlow.
wait_row_count FDB 3
check ovn-nbctl --wait=hv sync

# No modifications expected.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: echo \$packet > expected"
at_fn_check_prepare_dynamic "echo $packet > expected" "ovn.at:7917"
( $at_check_trace; echo $packet > expected
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: touch empty"
at_fn_check_prepare_trace "ovn.at:7917"
( $at_check_trace; touch empty
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


# Check that it is delivered where needed and not delivered where not.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif1-tx.pcap" "empty" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif1-tx.pcap" "empty"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "empty" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "empty"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif3-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif3-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif3-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif3-tx.pcap" "expected" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif3-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif4-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif4-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif4-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif4-tx.pcap" "empty" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif4-tx.pcap" "empty"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif5-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif5-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif5-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif5-tx.pcap" "expected" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif5-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }


# Trace a reply packet.
reply=$(fmt_pkt "Ether(dst='${src_mac}', src='${dst_mac}')/ \
                 IP(src='${dst_ip}', dst='${src_ip}')/ \
                 UDP(sport=4369, dport=1538)")
# For the reply packet we expect only two userspace actions for FDB update,
# because we already learned that MAC of vif1 is behind spine-ls1 and no
# longer need to broadcast to ls3/vif5.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: as hv1 ovs-appctl ofproto/trace --names \\
            br-int in_port=vif3 \$reply | tail -2 \\
            | grep -oE 'Megaflow.*|userspace|vif[0-9]'"
at_fn_check_prepare_notrace 'an embedded newline' "ovn.at:7917"
( $at_check_trace; as hv1 ovs-appctl ofproto/trace --names \
            br-int in_port=vif3 $reply | tail -2 \
            | grep -oE 'Megaflow.*|userspace|vif[0-9]'
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo >>"$at_stdout"; printf "%s\n" "Megaflow: recirc_id=0,eth,ip,in_port=vif3,dl_src=f0:00:00:01:02:03,dl_dst=f0:00:00:01:02:01,nw_frag=no
userspace
userspace
vif1
" | \
  $at_diff - "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

# Now actually send it.
check as hv1 ovs-appctl netdev-dummy/receive vif3 $reply

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: echo \$reply > reply"
at_fn_check_prepare_dynamic "echo $reply > reply" "ovn.at:7917"
( $at_check_trace; echo $reply > reply
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
at_fn_diff_devnull "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

# Check that it is delivered where needed and not delivered where not.
{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif1-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif1-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif1-tx.pcap" "reply" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif1-tx.pcap" "reply"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif2-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif2-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif2-tx.pcap" "empty" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif2-tx.pcap" "empty"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif3-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif3-tx.pcap " "ovn.at:7917"
( $at_check_trace; $PYTHON "$ovs_srcdir/utilities/ovs-pcap.in" hv1/vif3-tx.pcap
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
at_fn_diff_devnull "$at_stderr" || at_failed=:
echo stdout:; cat "$at_stdout"
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

   ovn_check_packets__ "hv1/vif3-tx.pcap" "expected" "tests/ovn.at:7917"
   { set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: sort \$rcv_text"
at_fn_check_prepare_dynamic "sort $rcv_text" "ovn.at:7917"
( $at_check_trace; sort $rcv_text
) >>"$at_stdout" 2>>"$at_stderr" 5>&-
at_status=$? at_failed=false
$at_check_filter
echo stderr:; cat "$at_stderr"
$at_diff expout "$at_stdout" || at_failed=:
at_fn_check_status 0 $at_status "$at_srcdir/ovn.at:7917"
if $at_failed
then :
  dump_diff__ "hv1/vif3-tx.pcap" "expected"
fi
$at_failed && at_fn_log_failure  \
"sbflows"
$at_traceon; }

{ set +x
printf "%s\n" "$at_srcdir/ovn.at:7917: \$PYTHON \"\$ovs_srcdir/utilities/ovs-pcap.in\" hv1/vif4-tx.pcap "
at_fn_check_prepare_dynamic "$PYTHON \"$ovs_srcdir/utilities/